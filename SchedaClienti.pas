unit SchedaClienti;

interface

uses
  Windows, Messages, SysUtils, Classes, Graphics, Controls, Forms, Dialogs,
  ComCtrls, StdCtrls, Mask,
  DBCtrls, DB, Menus, Buttons, IniFiles, IBODataset,
  cxGraphics, cxStyles, cxCustomData, cxFilter,
  cxEdit, cxDBData, cxImageComboBox, cxTextEdit, cxCalendar, cxMemo,
  cxCurrencyEdit, cxCheckBox, cxCheckComboBox, cxScheduler,
  cxSchedulerStorage, cxSchedulerCustomControls,
  cxSchedulerCustomResourceView, cxSchedulerDayView,
  cxSchedulerDateNavigator, cxSchedulerUtils,
  cxClasses, dxPSGlbl, dxPSUtl,
  dxBkgnd, dxWrap, dxPrnDev,
  dxPSFillPatterns, dxPSEdgePatterns, IB_Components, cxSchedulerDBStorage,
  dxPScxPivotGridLnk, dxPSCore, dxPScxCommon,
  cxGroupBox, cxRadioGroup, cxGridChartView,
  cxCustomPivotGrid, cxDBPivotGrid, cxSplitter, cxDropDownEdit,
  IB_Controls, cxDBEdit, CheckLst, ExtCtrls, cxGridLevel,
  cxGridCustomTableView, cxGridTableView, cxGridDBTableView, cxControls,
  cxGridCustomView, cxGrid, cxContainer, cxMaskEdit, MAURI_SB, cxPC,
  bmpPanel, cxGridCardView, cxGridDBCardView, cxGridCustomPopupMenu,
  cxTimeEdit, dxPSContainerLnk, cxImage, Variants, StrUtils, cxGridStrs, cxSchedulerDialogs,
  cxMRUEdit, cxHyperLinkEdit, cxGridDBChartView, cxLookAndFeelPainters, cxGridBandedTableView,
  cxGridDBBandedTableView, DataModule1, cxLabel, FormAllegati, FormGMap,
  FormAgendaSlide, cxData, cxDataStorage, cxSchedulerTimeGridView,
  cxSchedulerWeekView, cxSchedulerYearView, dxPSEngn, dxPrnPg,
  dxPSCompsProvider, cxPCdxBarPopupMenu, cxLookAndFeels,
  cxNavigator, dxCore, cxDateUtils, cxSchedulerHolidays, cxSchedulerGanttView,
  cxSchedulerTreeListBrowser, dxPSPDFExportCore,
  dxPSPDFExport, cxDrawTextUtils, dxPSPrVwStd, dxPSPrVwAdv, dxPSPrVwRibbon,
  dxPScxPageControlProducer, dxPScxGridLnk, dxPScxGridLayoutViewLnk,
  dxPScxSchedulerLnk, dxPScxEditorProducers, dxPScxExtEditorProducers,
  JvgSpeedButton, FrameChart,
  cxDBNavigator, cxCheckListBox, DDT.Interfaces, FatturaPA_DM, dxBarBuiltInMenu,
  dxDateRanges, dxScrollbarAnnotations, cxSchedulerAgendaView,
  cxSchedulerRecurrence, cxSchedulerRibbonStyleEventEditor, cxCustomListBox;

const
  // Constanti contentnei l'ID della colonna della griglia del giornale di magazzino
  // NB: RICORDARSI QUANDO SI MODIFICANO O AGGIUNGONO I VALORI DI QUESTE COSTANTI DI FARLO ANCHE NELLA
  // FUNZIONE CHE RITORNA IL VALORE DEI CAMPI DEL CORPO DOC.
  // GIORNALE DI MAGAZZINO
  IDX_GMCodiceMagazzino = 1;
  IDX_GMMovMag = 2;
  IDX_GMCodiceArticolo = 3;
  IDX_GMDescrizione = 4;
  IDX_GMPrezzoUnitario = 5;
  IDX_GMUM = 6;
  IDX_GMQta = 7;
  IDX_GMS1 = 8;
  IDX_GMS2 = 9;
  IDX_GMS3 = 10;
  IDX_GMImportoRigo = 11;
  IDX_GMNoteRigo = 12;
  IDX_GMDocumento = 13;
  // CONDIZIONI DI VENDITA
  IDX_CVTipoCondizione = 0;
  IDX_CVRiferimento = 1;
  IDX_CVQta1 = 2;
  IDX_CVSconto1 = 3;
  IDX_CVPrezzo1 = 4;
  IDX_CVQta2 = 5;
  IDX_CVSconto2 = 6;
  IDX_CVPrezzo2 = 7;
  IDX_CVQta3 = 8;
  IDX_CVSconto3 = 9;
  IDX_CVPrezzo3 = 10;
  IDX_CVSoggetto = 11;
  IDX_CVCodiceSoggetto = 12;
  IDX_CVCodiceArticolo = 13;
  IDX_CVCodiceGruppo1 = 14;
  IDX_CVCodiceGruppo2 = 15;
  IDX_CVCodiceGruppo3 = 16;
  // SOGGETTI
  IDX_CLITipo = 0;
  IDX_CLICodice = 1;
  IDX_CLIRagioneSociale = 2;
  IDX_CLIIndirizzo = 3;
  IDX_CLICitta = 4;
  IDX_CLIProvincia = 5;
  IDX_CLICAP = 6;
  IDX_CLIDataNascita = 7;
  IDX_CLILuogoNascita = 8;
  IDX_CLITelefono = 9;
  IDX_CLIFax = 10;
  // DOCUMENTI
  IDX_DOCSelezionato = 0;
  IDX_DOCTipo = 1;
  IDX_DOCNum = 2;
  IDX_DOCRegistro = 3;
  IDX_DOCData = 4;
  IDX_DOCOra = 5;
  IDX_DOCOggetto = 6;
  IDX_DOCImporto = 7;
  IDX_DOCStatoDescrizione = 8;
  IDX_DOCSoggetto = 9;
  IDX_DOCImponibile = 10;
  IDX_DOCImportoIVA = 11;
  IDX_DOCStatoForeground = 12;
  IDX_DOCStatoBackground = 13;

type
  TClientiForm = class(TForm)
    MenuStampe: TPopupMenu;
    Elencoclienti1: TMenuItem;
    Elencodocumenti1: TMenuItem;
    MenuElencoClienti: TPopupMenu;
    Salvaimpostazionicolonne1: TMenuItem;
    N3: TMenuItem;
    N4: TMenuItem;
    GiornaleDiMagazzino1: TMenuItem;
    ClientTopPanel: TbmpPanel;
    N6: TMenuItem;
    ElencoArticoli1: TMenuItem;
    InventarioUltimoCosto1: TMenuItem;
    SBEsportaDocFisc: TSpeedButton;
    QryGM: TIBOQuery;
    SourcGM: TDataSource;
    QrySoggetti: TIBOQuery;
    SourceSoggetti: TDataSource;
    QrySoggettiCODICE: TIntegerField;
    QrySoggettiRAGIONESOCIALE: TStringField;
    QrySoggettiINDIRIZZO: TStringField;
    QrySoggettiCITTA: TStringField;
    QrySoggettiCAP: TStringField;
    QrySoggettiPROVINCIA: TStringField;
    QrySoggettiDATANASCITA: TDateTimeField;
    QrySoggettiLUOGONASCITA: TStringField;
    QrySoggettiTELEFONO: TStringField;
    QrySoggettiFAX: TStringField;
    QrySoggettiCLIENTEFORNITORE: TStringField;
    QryDoc: TIBOQuery;
    SourceDoc: TDataSource;
    QryGMCODICEMAGAZZINO: TSmallintField;
    QryGMCODICEARTICOLO: TStringField;
    QryGMDESCRIZIONE: TStringField;
    QryGMPREZZOUNITARIO: TIBOFloatField;
    QryGMUNITADIMISURA: TStringField;
    QryGMQTA: TIBOFloatField;
    QryGMSCONTORIGO: TIBOFloatField;
    QryGMSCONTORIGO2: TIBOFloatField;
    QryGMSCONTORIGO3: TIBOFloatField;
    QryGMIMPORTORIGO: TIBOFloatField;
    QryGMDOCUMENTO: TStringField;
    QryGMSOGGETTO: TStringField;
    QryGMGRUPPO1: TStringField;
    QryGMGRUPPO2: TStringField;
    QryGMGRUPPO3: TStringField;
    QryGMTIPODOCUMENTO: TStringField;
    QryGMNUMORDPREV: TIntegerField;
    QryGMREGISTRO: TStringField;
    QryGMDATADOCUMENTO: TDateTimeField;
    QryGMPROGRIGO: TIntegerField;
    QryCV: TIBOQuery;
    SourceCV: TDataSource;
    QryCVTIPO: TStringField;
    QryCVRIFERIMENTO: TStringField;
    QryCVDAQTA1: TIBOFloatField;
    QryCVSCONTO1: TIBOFloatField;
    QryCVIMPORTO1: TIBOFloatField;
    QryCVDAQTA2: TIBOFloatField;
    QryCVSCONTO2: TIBOFloatField;
    QryCVIMPORTO2: TIBOFloatField;
    QryCVDAQTA3: TIBOFloatField;
    QryCVSCONTO3: TIBOFloatField;
    QryCVIMPORTO3: TIBOFloatField;
    QryCVRAGIONESOCIALE: TStringField;
    QryCVCODICESOGGETTO: TIntegerField;
    QryCVCODICEARTICOLO: TStringField;
    QryCVCODICEGRUPPO1: TIntegerField;
    QryCVCODICEGRUPPO2: TIntegerField;
    QryCVCODICEGRUPPO3: TIntegerField;
    QryPratiche: TIBOQuery;
    SourcePratiche: TDataSource;
    QryPraticheCODICE: TIntegerField;
    QryPraticheDESCRIZIONE: TStringField;
    QryPraticheDATAAPERTURA: TDateTimeField;
    QryPraticheDATACHIUSURA: TDateTimeField;
    QryPraticheSTATODESCRIZIONE: TStringField;
    QryPraticheRAGIONESOCIALE: TStringField;
    QryPraticheSTATOFOREGROUND: TStringField;
    QryPraticheSTATOBACKGROUND: TStringField;
    QryScad: TIBOQuery;
    SourceScad: TDataSource;
    QryScadCODICE: TIntegerField;
    QryScadDATASCADENZA: TDateTimeField;
    QryScadRICEVUTABANCARIA: TStringField;
    QryScadPRESENTATA: TStringField;
    QryScadDARE: TIBOFloatField;
    QryScadAVERE: TIBOFloatField;
    QryScadDOCUMENTO: TStringField;
    QryScadSOGGETTO: TStringField;
    QryScadTIPO: TStringField;
    QryArticoli: TIBOQuery;
    SourceArticoli: TDataSource;
    QryArticoliCODICEARTICOLO: TStringField;
    QryArticoliDESCRIZIONE: TStringField;
    QryArticoliUNITADIMISURA: TStringField;
    QryArticoliGIACENZA: TIBOFloatField;
    QryArticoliIMPEGNATO: TIBOFloatField;
    QryArticoliDISPONIBILE: TIBOFloatField;
    QryArticoliORDINATO: TIBOFloatField;
    QryArticoliPREZZODIVENDITA: TIBOFloatField;
    QryArticoliPREZZODIVENDITA2: TIBOFloatField;
    QryArticoliPREZZODIVENDITA3: TIBOFloatField;
    QryArticoliPREZZODIVENDITA4: TIBOFloatField;
    QryArticoliPRZVENDIVACOMP1: TIBOFloatField;
    QryArticoliPRZVENDIVACOMP2: TIBOFloatField;
    QryArticoliPRZVENDIVACOMP3: TIBOFloatField;
    QryArticoliPRZVENDIVACOMP4: TIBOFloatField;
    QryArticoliPUNTORIORDINO: TIBOFloatField;
    QryArticoliSCORTAMINIMA: TIBOFloatField;
    QryArticoliABILITAMOVMAG: TStringField;
    QryArticoliUBICAZIONE: TStringField;
    QryArticoliGRUPPO1: TStringField;
    QryArticoliGRUPPO2: TStringField;
    QryArticoliGRUPPO3: TStringField;
    QryGMPRATICA: TStringField;
    dxPrinter: TdxComponentPrinter;
    GridGMLink: TdxGridReportLink;
    QryTotGM: TIBOQuery;
    SourceTotGM: TDataSource;
    QryTotGMPREZZOMEDIO: TIBOFloatField;
    QryTotGMTOTQTA: TIBOFloatField;
    QryTotGMTOTIMPORTORIGO: TIBOFloatField;
    GridSoggLink: TdxGridReportLink;
    N7: TMenuItem;
    Stampaelencoscadenze1: TMenuItem;
    StampadistintadipresentazioneRIBAperlabanca1: TMenuItem;
    GridScadLink: TdxGridReportLink;
    QryScadBANCA: TStringField;
    QryScadABI: TStringField;
    QryScadCAB: TStringField;
    QryScadRAGIONESOCIALE: TStringField;
    QryScadINDIRIZZO: TStringField;
    QryScadCAP: TStringField;
    QryScadCITTA: TStringField;
    QryScadPROVINCIA: TStringField;
    GridArtLink: TdxGridReportLink;
    QryArticoliULTIMOPRZACQUISTO: TIBOFloatField;
    QryArticoliIMPORTOULTIMOCOSTOREALE: TCurrencyField;
    GridArtInventarioUltimoCostoLink: TdxGridReportLink;
    GridPrimanotaLink: TdxGridReportLink;
    MenuArticoli: TPopupMenu;
    MIArticolo: TMenuItem;
    MIArticoloComposto: TMenuItem;
    MenuSoggetti: TPopupMenu;
    MISoggetto: TMenuItem;
    MenuPratiche: TPopupMenu;
    MIPratica: TMenuItem;
    MenuDocumenti: TPopupMenu;
    MIPreventivo: TMenuItem;
    MIOrdine: TMenuItem;
    MISAL: TMenuItem;
    MIBuonoConsegna: TMenuItem;
    MIDDT: TMenuItem;
    MIFattura: TMenuItem;
    MIRicevutaFiscale: TMenuItem;
    MIFatturaRicevutaFiscale: TMenuItem;
    MINotaCredito: TMenuItem;
    MIOrdineFornitore: TMenuItem;
    MIBollaEntrata: TMenuItem;
    MIFatturaAcquisto: TMenuItem;
    MILettera: TMenuItem;
    MIContattoDaFare: TMenuItem;
    MIContattoFatto: TMenuItem;
    MIFileEsterno: TMenuItem;
    MIConformita: TMenuItem;
    MITracciato: TMenuItem;
    N1: TMenuItem;
    N2: TMenuItem;
    MenuScadenzario: TPopupMenu;
    MIScadenzaAttiva: TMenuItem;
    MIScadenzaPassiva: TMenuItem;
    MenuCondVend: TPopupMenu;
    MICondVendGruppo: TMenuItem;
    MICondVendArticolo: TMenuItem;
    MICondAcqGruppo: TMenuItem;
    MICondAcqArticolo: TMenuItem;
    N5: TMenuItem;
    Stampaetichetteclienti1: TMenuItem;
    Stampaetichettearticoli1: TMenuItem;
    QryGMPREZZOUNITARIOIVACOMPRESA: TIBOFloatField;
    QryGMIMPORTORIGOIVACOMPRESA: TIBOFloatField;
    QryTotGMTOTIMPORTORIGOIVACOMPRESA: TIBOFloatField;
    Notadicreditofornitore1: TMenuItem;
    QryArticoliARTICOLOCOMPOSTO: TStringField;
    Sostituzionesottoarticolonegliarticoliselezionati1: TMenuItem;
    Sostituzionesottoarticolointuttigliarticoli1: TMenuItem;
    QryScadPARTITAIVA: TStringField;
    QryAss: TIBOQuery;
    SourceAss: TDataSource;
    MenuAssistenze: TPopupMenu;
    QryPraticheTIPO: TStringField;
    QryImp: TIBOQuery;
    SourceImp: TDataSource;
    QryImpTIPOIMPEGNO: TStringField;
    QryImpEVENTMESSAGE: TStringField;
    QryImpSTART: TDateTimeField;
    QryImpLOCATION: TStringField;
    QryImpRAGIONESOCIALE: TStringField;
    QryImpID: TIntegerField;
    QryImpPARENTID: TIntegerField;
    MenuImpegni: TPopupMenu;
    QryImpTIPOINTERVENTO: TStringField;
    N9: TMenuItem;
    Stampaelencoimpianti1: TMenuItem;
    N10: TMenuItem;
    Stampaelencochiamateappuntamentiinterventi1: TMenuItem;
    GridImpegniLink: TdxGridReportLink;
    QryAssTIPO: TStringField;
    QryAssCODICE: TIntegerField;
    QryAssDATAAPERTURA: TDateTimeField;
    QryAssRAGIONESOCIALE: TStringField;
    QryAssTELEFONO: TStringField;
    QryAssCELLULARE: TStringField;
    QryAssCOMUNEIMM: TStringField;
    QryAssDATAORAPROSSIMOAPPUNTAMENTO: TDateTimeField;
    QryAssCAPIMM: TStringField;
    QryAssTIPOIMPIANTO: TStringField;
    QryAssPERIODICITA: TIntegerField;
    N11: TMenuItem;
    Stampaelencocantieri1: TMenuItem;
    GridCantieriLink: TdxGridReportLink;
    Selezionavista1: TMenuItem;
    Ripristinacolonneeliminate1: TMenuItem;
    AgendaDBStorage: TcxSchedulerDBStorage;
    SourceAgenda: TDataSource;
    SourceTecnici: TDataSource;
    MenuAgenda: TPopupMenu;
    Impegno1: TMenuItem;
    QryImpTECNICO: TStringField;
    QryArticoliGRUPPO4: TStringField;
    QryArticoliGRUPPO5: TStringField;
    QryArticoliGRUPPO6: TStringField;
    QryGMGRUPPO4: TStringField;
    QryGMGRUPPO5: TStringField;
    QryGMGRUPPO6: TStringField;
    Stampalistinocatalogofigurato1: TMenuItem;
    Stampa2: TMenuItem;
    EsportainformatoPDF2: TMenuItem;
    QryScadRESIDUO: TIBOFloatField;
    QryScadIMPORTO: TIBOFloatField;
    PagamentoRiscossionecumulativoRIBAselezionate1: TMenuItem;
    QryScadCLIENTE: TIntegerField;
    QryScadPRATICA: TIntegerField;
    QryScadDATAPRATICA1: TDateTimeField;
    QryScadTIPODOC: TStringField;
    QryScadNUMDOC: TIntegerField;
    QryScadREGISTRO: TStringField;
    QryScadDATADOC: TDateTimeField;
    Appuntamentonormale1: TMenuItem;
    Stampagiornaledicantiere1: TMenuItem;
    QryGMSTATODESCRIZIONE: TStringField;
    Cambiastatodocumentiselezionati1: TMenuItem;
    Cambiaregistroaidocumentiselezionati1: TMenuItem;
    EventPopupMenuAgenda: TPopupMenu;
    Eliminaappuntamentoecreadocumento1: TMenuItem;
    QrySoggettiCELLULARE: TStringField;
    QryAssRAGSOCUT: TStringField;
    QryImpDATAORACHIAMATA: TDateTimeField;
    Eliminaappuntamentoecreadocumento2: TMenuItem;
    Appuntamentonormale2: TMenuItem;
    ChiamataAppuntamentodiassistenza1: TMenuItem;
    MarcacomeConsegnatiidocumentiselezionati1: TMenuItem;
    QryArticoliCODICIAGGIUNTIVI: TStringField;
    QryScadNOTE: TStringField;
    Stampacumulativadeidocumentiselezionati1: TMenuItem;
    QryScadINSOLUTO: TStringField;
    QrySoggettiSTATODESCRIZIONE: TStringField;
    QrySoggettiSTATOFOREGROUND: TStringField;
    QrySoggettiSTATOBACKGROUND: TStringField;
    QrySoggettiPARTITAIVA: TStringField;
    QrySoggettiCODICEFISCALE: TStringField;
    QryArtListForn: TIBOQuery;
    SourceArtListForn: TDataSource;
    QryArtListFornCODICEARTICOLO: TStringField;
    QryArtListFornCODICEFORNITORE: TIntegerField;
    QryArtListFornPREZZODIACQUISTO: TIBOFloatField;
    QryArtListFornCODICEARTICOLOFORNITORE: TStringField;
    QryArtListFornRAGIONESOCIALE: TStringField;
    QryArtListFornDESCRIZIONEFORNITORE: TStringField;
    QryArtListFornFORNITOREPREFERITO: TStringField;
    QryArticoliQUANTITAAUTOMATICA: TIBOFloatField;
    QrySoggettiEMAIL: TStringField;
    N12: TMenuItem;
    Stampaagenda1: TMenuItem;
    AgendaLink: TcxSchedulerReportLink;
    N13: TMenuItem;
    Stampapartitario1: TMenuItem;
    QryArticoliMARCA: TStringField;
    QryTotDoc: TIBOQuery;
    QryTotDocTOTNUMDOC: TIntegerField;
    QryTotDocTOTIMPORTO: TIBOFloatField;
    QryTotDocTOTIMPONIBILE: TIBOFloatField;
    QryTotDocTOTIMPORTOIVA: TIBOFloatField;
    SourceTotDoc: TDataSource;
    QryTotDocTOTRITENUTAACCONTO: TIBOFloatField;
    CreafilepresentazioneRIBAallincasso1: TMenuItem;
    Rapportogiornaliero1: TMenuItem;
    QryPraticheCLIENTE: TIntegerField;
    QryPraticheRAGSOC: TStringField;
    QryGOSOre: TIBOQuery;
    SourceGOS: TDataSource;
    QryGOSOreNUMDOC: TIntegerField;
    QryGOSOreDATADOC: TDateTimeField;
    QryGOSOreREGISTRO: TStringField;
    QryGOSOreQTA: TIBOFloatField;
    QryGOSOreCOSTOORARIO: TIBOFloatField;
    QryGOSOreIMPORTOCOSTOORARIO: TIBOFloatField;
    QryGOSOreNOTE: TMemoField;
    QryGOSOreTIPOORE1: TStringField;
    QryGOSOreTIPOORE2: TStringField;
    QryGOSOreTIPOORE3: TStringField;
    QryGOSOreDOCUMENTO: TStringField;
    QryGOSOreDIPENDENTE: TStringField;
    QryGOSOreCANTIERE: TStringField;
    QryGOSOreSOGGETTO: TStringField;
    QryGOSSpese: TIBOQuery;
    SourceGOSSpese: TDataSource;
    QryGOSSpeseNUMDOC: TIntegerField;
    QryGOSSpeseDATADOC: TDateTimeField;
    QryGOSSpeseREGISTRO: TStringField;
    QryGOSSpeseIMPORTO: TIBOFloatField;
    QryGOSSpeseNOTE: TMemoField;
    QryGOSSpeseTIPOCOSTO1: TStringField;
    QryGOSSpeseTIPOCOSTO2: TStringField;
    QryGOSSpeseTIPOCOSTO3: TStringField;
    QryGOSSpeseKM: TIntegerField;
    QryGOSSpeseDOCUMENTO: TStringField;
    QryGOSSpeseDIPENDENTE: TStringField;
    QryGOSSpeseCANTIERE: TStringField;
    QryGOSSpeseSOGGETTO: TStringField;
    QryGOSSpeseAUTOMEZZO: TStringField;
    QryGOSOreNUMRIGO: TIntegerField;
    QryGOSSpeseNUMRIGO: TIntegerField;
    QryGOSOrePRZVEND: TIBOFloatField;
    QryGOSOreIMPORTOVEND: TIBOFloatField;
    QryGOSOreCOSTOSTRAORDINARIO: TIBOFloatField;
    QryGOSOreQTASTRAORDINARIO: TIBOFloatField;
    QryGOSOreIMPORTOSTRAORDINARIO: TIBOFloatField;
    QryGOSOreCOSTOPERMESSI: TIBOFloatField;
    QryGOSOreQTAPERMESSI: TIBOFloatField;
    QryGOSOreIMPORTOPERMESSI: TIBOFloatField;
    QryGOSOreCOSTOFERIE: TIBOFloatField;
    QryGOSOreQTAFERIE: TIBOFloatField;
    QryGOSOreIMPORTOFERIE: TIBOFloatField;
    QryGOSOreCOSTOTRASFERTE: TIBOFloatField;
    QryGOSOreQTATRASFERTE: TIBOFloatField;
    QryGOSOreIMPORTOTRASFERTE: TIBOFloatField;
    QryGOSOreOREBASE: TIBOFloatField;
    GosOreLink: TdxGridReportLink;
    N14: TMenuItem;
    Stamparapportooredipendenti1: TMenuItem;
    GosOrePivotLink: TcxPivotGridReportLink;
    StampaADAdipendenti1: TMenuItem;
    GosSpeseLink: TdxGridReportLink;
    GosSpesePivotLink: TcxPivotGridReportLink;
    Stamparapportospesevarie1: TMenuItem;
    StampaADAspesevarie1: TMenuItem;
    GosOreGraficoLink: TdxGridReportLink;
    Stampagraficooredipendenti1: TMenuItem;
    Stampagraficospesevarie1: TMenuItem;
    GosSpeseGraficoLink: TdxGridReportLink;
    QrySoggettiPAGAM: TStringField;
    Stamperiepilogativecantieri1: TMenuItem;
    QrySoggettiNOTE: TMemoField;
    QryDocAltri: TIBOQuery;
    SourceDocAltri: TDataSource;
    QryDocTIPODOC: TStringField;
    QryDocREGISTRO: TStringField;
    QryDocCODICEDOC: TIntegerField;
    QryDocDATADOC: TDateTimeField;
    QryDocOGGETTOJOLLY1: TStringField;
    QryDocOGGETTOJOLLY2: TStringField;
    QryDocOGGETTOJOLLY3: TStringField;
    QryDocIMPORTO: TIBOFloatField;
    QryDocNOTEJOLLY1: TStringField;
    QryDocNOTEJOLLY2: TStringField;
    QryDocCLIENTEFORNITORE: TStringField;
    QryDocOGGETTO: TStringField;
    QryDocNOTE: TStringField;
    QryDocSTATODESCRIZIONE: TStringField;
    QryDocSTATOFOREGROUND: TStringField;
    QryDocSTATOBACKGROUND: TStringField;
    QryDocSELEZIONATO: TStringField;
    QryDocPROVENIENZA: TStringField;
    QryDocIMPONIBILE: TIBOFloatField;
    QryDocIMPORTOIVA: TIBOFloatField;
    QryDocCODICESOGGETTO: TIntegerField;
    QryDocORADOC: TStringField;
    QryDocDAFATTURARE: TStringField;
    QryDocRIFPRATICA: TStringField;
    QryDocVALIDITADATA: TDateTimeField;
    QryDocCONSEGNADATA: TDateTimeField;
    QryDocCONSEGNATO: TStringField;
    QryDocCAUSALE: TStringField;
    QryDocCAUSALECANTIERE: TStringField;
    QryDocRITENUTAACCONTO: TIBOFloatField;
    QryDocTIPOSOGGETTO: TStringField;
    QryDocAltriSTATION_ID: TIntegerField;
    QryDocAltriTIPODOC: TStringField;
    QryDocAltriREGISTRO: TStringField;
    QryDocAltriCODICEDOC: TIntegerField;
    QryDocAltriDATADOC: TDateTimeField;
    QryDocAltriOGGETTOJOLLY1: TStringField;
    QryDocAltriOGGETTOJOLLY2: TStringField;
    QryDocAltriOGGETTOJOLLY3: TStringField;
    QryDocAltriIMPORTO: TIBOFloatField;
    QryDocAltriNOTEJOLLY1: TStringField;
    QryDocAltriNOTEJOLLY2: TStringField;
    QryDocAltriCLIENTEFORNITORE: TStringField;
    QryDocAltriOGGETTO: TStringField;
    QryDocAltriNOTE: TStringField;
    QryDocAltriSTATODESCRIZIONE: TStringField;
    QryDocAltriSTATOFOREGROUND: TStringField;
    QryDocAltriSTATOBACKGROUND: TStringField;
    QryDocAltriSELEZIONATO: TStringField;
    QryDocAltriPROVENIENZA: TStringField;
    QryDocAltriARGOMENTO: TStringField;
    QryDocAltriIMPONIBILE: TIBOFloatField;
    QryDocAltriIMPORTOIVA: TIBOFloatField;
    QryDocAltriCODICESOGGETTO: TIntegerField;
    QryDocAltriORADOC: TStringField;
    QryDocAltriDAFATTURARE: TStringField;
    QryDocAltriRIFPRATICA: TStringField;
    QryDocAltriVALIDITADATA: TDateTimeField;
    QryDocAltriCONSEGNADATA: TDateTimeField;
    QryDocAltriCONSEGNATO: TStringField;
    QryDocAltriCAUSALE: TStringField;
    QryDocAltriCAUSALECANTIERE: TStringField;
    QryDocAltriRITENUTAACCONTO: TIBOFloatField;
    QryDocAltriTIPOSOGGETTO: TStringField;
    QryDocIMPORTONETTORITACC: TCurrencyField;
    QryDocAltriIMPORTONETTORITACC: TCurrencyField;
    QryGMPREZZOUNITARIONETTO: TCurrencyField;
    QryGMRAGSOCCLI: TStringField;
    Impostaeventoricorsivo1: TMenuItem;
    Copiaidocumentiselezionatisullabacheca1: TMenuItem;
    QryAssSTATO: TStringField;
    QryArticoliULTIMOCOSTOREALE: TIBOFloatField;
    QryGMSEGNOOPERAZIONE: TStringField;
    QueryPrimanota: TIBOQuery;
    QueryPrimanotaDATA: TDateTimeField;
    QueryPrimanotaDESCRIZIONE: TStringField;
    QueryPrimanotaCASSAENTRATE: TIBOFloatField;
    QueryPrimanotaCASSAUSCITE: TIBOFloatField;
    QueryPrimanotaDESCFUORI: TStringField;
    QueryPrimanotaFUORIENTRATE: TIBOFloatField;
    QueryPrimanotaFUORIUSCITE: TIBOFloatField;
    QueryPrimanotaABBUONIATTIVI: TIBOFloatField;
    QueryPrimanotaABBUONIPASSIVI: TIBOFloatField;
    QueryPrimanotaNOTE: TStringField;
    QueryPrimanotaRAGSOCCLI: TStringField;
    QueryPrimanotaCLIENTE: TIntegerField;
    QueryPrimanotaCODICE: TIntegerField;
    SourcePrimanota: TDataSource;
    QueryTotali: TIBOQuery;
    QueryTotaliTotCassaEntrate: TCurrencyField;
    QueryTotaliTotCassaUscite: TCurrencyField;
    QueryTotaliSaldoCassa: TCurrencyField;
    QueryTotaliTotFuoriEntrate: TCurrencyField;
    QueryTotaliTotFuoriUscite: TCurrencyField;
    QueryTotaliSaldoFuori: TCurrencyField;
    SourceTotali: TDataSource;
    QueryRiporti: TIBOQuery;
    QueryRiportiTotCassaEntrate: TCurrencyField;
    QueryRiportiTotCassaUscite: TCurrencyField;
    QueryRiportiSaldoCassa: TCurrencyField;
    QueryRiportiTotFuoriEntrate: TCurrencyField;
    QueryRiportiTotFuoriUscite: TCurrencyField;
    QueryRiportiSaldoFuori: TCurrencyField;
    SourceRiporti: TDataSource;
    QryTotPeriodo: TIBOQuery;
    QryTotPeriodoTOTCASSAENTRATE: TIBOFloatField;
    QryTotPeriodoTOTCASSAUSCITE: TIBOFloatField;
    QryTotPeriodoSALDOCASSA: TIBOFloatField;
    QryTotPeriodoTOTFUORIENTRATE: TIBOFloatField;
    QryTotPeriodoTOTFUORIUSCITE: TIBOFloatField;
    QryTotPeriodoSALDOFUORI: TIBOFloatField;
    SourceTotPeriodo: TDataSource;
    N15: TMenuItem;
    Stampamovimentiprimanota1: TMenuItem;
    MenuPrimanota: TPopupMenu;
    Movimentoprimanota1: TMenuItem;
    Commessa1: TMenuItem;
    Caricocantiere1: TMenuItem;
    Scaricocantiere1: TMenuItem;
    Estrattoconto1: TMenuItem;
    Intervento1: TMenuItem;
    QryImpDATAORAINTERVENTO: TDateTimeField;
    QryImpREGISTRO: TStringField;
    N17: TMenuItem;
    QryImpRIFPRATICA: TStringField;
    StampacumulativadelFoglidiLavorodegliappuntamentiselezionati1: TMenuItem;
    StampacumulativadelKITperiltecnicodegliappuntamentiselezionati1: TMenuItem;
    StampacumulativadelKITperiltecnicodegliappuntamentiselezionati2: TMenuItem;
    StampacumulativadelFogliodiLavorodegliappuntamentiselezionati1: TMenuItem;
    Stampainventarioultimocostosustampanteadaghi1: TMenuItem;
    QueryPrimanotaSTATODESCRIZIONE: TStringField;
    QueryPrimanotaSTATOFOREGROUND: TStringField;
    QueryPrimanotaSTATOBACKGROUND: TStringField;
    QryDocOPERATORE: TStringField;
    QryDocAltriOPERATORE: TStringField;
    Button5: TButton;
    Button6: TButton;
    QryGMTIPO1: TStringField;
    QryGMTIPO2: TStringField;
    QryGMTIPO3: TStringField;
    QryGMTIPO4: TStringField;
    QryGMTIPO5: TStringField;
    QryGMTIPO6: TStringField;
    QryImpAGENTE: TStringField;
    QryImpCODICEARTICOLO: TStringField;
    QryImpDESCRIZIONEARTICOLO: TStringField;
    Stampacumulativaappuntamentiselezionati1: TMenuItem;
    QryDocAGENTE: TStringField;
    QryGMAGENTE: TStringField;
    QryDocAZIONECANTIERE: TStringField;
    QryDocAZIONEMAGAZZINO: TStringField;
    QryGMSEGNOOPERAZIONECANTIERE: TStringField;
    QryGOSOreOPERAINDEX: TIntegerField;
    Stampaindicepercategorie1: TMenuItem;
    Stampaindicealfabetico1: TMenuItem;
    Stampaindiceperfornitore1: TMenuItem;
    Stampacatalogofiguratosenzacodiciabarre1: TMenuItem;
    Button3: TButton;
    Button7: TButton;
    QryGOSOreSOTTOCANTIERE1: TStringField;
    QryGOSOreSOTTOCANTIERE2: TStringField;
    QryGOSOreSOTTOCANTIERE3: TStringField;
    QryGOSSpeseSOTTOCANTIERE1: TStringField;
    QryGOSSpeseSOTTOCANTIERE2: TStringField;
    QryGOSSpeseSOTTOCANTIERE3: TStringField;
    Button8: TButton;
    TransDoc: TIB_Transaction;
    TransSoggetti: TIB_Transaction;
    TransDocAltri: TIB_Transaction;
    TransTotDoc: TIB_Transaction;
    TransArticoli: TIB_Transaction;
    TransArtListForn: TIB_Transaction;
    TransGM: TIB_Transaction;
    TransTotGM: TIB_Transaction;
    TransCV: TIB_Transaction;
    TransPratiche: TIB_Transaction;
    TransScad: TIB_Transaction;
    TransAss: TIB_Transaction;
    TransImp: TIB_Transaction;
    TransAgenda: TIB_Transaction;
    TransTecnici: TIB_Transaction;
    TransPrimanota: TIB_Transaction;
    TransTotali: TIB_Transaction;
    TransRiporti: TIB_Transaction;
    TransTotPeriodo: TIB_Transaction;
    TransGOSOre: TIB_Transaction;
    TransGOSSpese: TIB_Transaction;
    QryGMSOTTOCANTIERE1: TStringField;
    QryGMSOTTOCANTIERE2: TStringField;
    QryGMSOTTOCANTIERE3: TStringField;
    QryGOSOreTIPODOC: TStringField;
    QryGOSOreNUMRIGO2: TIntegerField;
    QryArticoliPREZZODILISTINO: TIBOFloatField;
    QryArticoliSCONTODIACQUISTO: TIBOFloatField;
    QryArticoliSCONTODIACQUISTO2: TIBOFloatField;
    QryArticoliSCONTODIACQUISTO3: TIBOFloatField;
    QryArticoliCODICEFORNITORE: TStringField;
    EsportainformatoExcel1: TMenuItem;
    EsportinventarioultimocostoinformatoEXCEL1: TMenuItem;
    Esportainformatotxt1: TMenuItem;
    Variazionecostoorariomanodoperadeirighiselezionati1: TMenuItem;
    Stamparesiduoordini1: TMenuItem;
    QryDocEXPORTED: TStringField;
    N8: TMenuItem;
    MarcaidocumentiselezionaticomeNONesportati1: TMenuItem;
    QryScadRIFPRATICA: TStringField;
    QryScadAGENTE: TStringField;
    QrySoggettiAGENTE: TStringField;
    QueryPrimanotaAGENTE: TStringField;
    QueryPrimanotaRIFPRATICA: TStringField;
    QryGMTIPOSOGGETTO: TStringField;
    QryGMDESCPAGAM: TStringField;
    QryScadDATAPAGAMENTO: TDateTimeField;
    QryScadSTATODESCRIZIONE: TStringField;
    QryScadRITACC: TIBOFloatField;
    Cambiastatoallescadenzeselezionate1: TMenuItem;
    Cambiastatoalleregistrazionidiprimanotaselezionate1: TMenuItem;
    QryScadTOTALEIMPONIBILE: TIBOFloatField;
    QryScadRITACCPERC: TIBOFloatField;
    QryDocPROTOCOLLO: TIntegerField;
    QryGOSSpeseTIPODOC: TStringField;
    QryGOSOreSTATODESCRIZIONE: TStringField;
    QryGOSOreSTATOFOREGROUND: TStringField;
    QryGOSOreSTATOBACKGROUND: TStringField;
    QryGOSSpeseSTATODESCRIZIONE: TStringField;
    QryGOSSpeseSTATOFOREGROUND: TStringField;
    QryGOSSpeseSTATOBACKGROUND: TStringField;
    QryPraticheCATEGCANT1: TStringField;
    QryPraticheCATEGCANT2: TStringField;
    QryPraticheCATEGCANT3: TStringField;
    QryPraticheCATEGCANT4: TStringField;
    QryPraticheCATEGCANT5: TStringField;
    QryPraticheCATEGCANT6: TStringField;
    QryScadIMPORTOPAGATO: TIBOFloatField;
    Forzagiacenzaarticoliselezionati1: TMenuItem;
    Esportadocumentoinformatotesto1: TMenuItem;
    EsportadocumentoinformatoExcel1: TMenuItem;
    TransArtMag: TIB_Transaction;
    QryArtMag: TIBOQuery;
    SourceArtMag: TDataSource;
    QryArtMagCODMAG: TIntegerField;
    QryArtMagDESCMAG: TStringField;
    QryArtMagGIACENZA: TIBOFloatField;
    QryArtMagIMPEGNATO: TIBOFloatField;
    QryArtMagORDINATO: TIBOFloatField;
    QryArtMagDISPONIBILE: TFloatField;
    TransSoggCant: TIB_Transaction;
    QrySoggCant: TIBOQuery;
    SourceSoggCant: TDataSource;
    QrySoggCantCODICE: TIntegerField;
    QrySoggCantDATAAPERTURA: TDateTimeField;
    QrySoggCantTIPOPRATICA: TStringField;
    QrySoggCantDESCRIZIONE: TStringField;
    QrySoggCantSTATODESCRIZIONE: TStringField;
    QrySoggCantCLIENTE: TIntegerField;
    QrySoggCantTIPO: TStringField;
    QryArticoliDATAULTMOD_CREAZIONE: TDateTimeField;
    QryArticoliDATAULTMOD_GENERALE: TDateTimeField;
    QryArticoliDATAULTMOD_COSTO: TDateTimeField;
    QryArticoliDATAULTMOD_VENDITA: TDateTimeField;
    QryArticoliDATAULTMOD_LISTINO: TDateTimeField;
    QryAssINDIRIZZOIMM: TStringField;
    Stampaetichettedeiclientiselezionati1: TMenuItem;
    Altreesportazioniarticolilistini1: TMenuItem;
    QryArtMagCODICEARTICOLO: TStringField;
    QryGMCODICEARTICOLOSTM: TStringField;
    QryArtListFornSCONTODIACQUISTO1: TIBOFloatField;
    QryArtListFornSCONTODIACQUISTO2: TIBOFloatField;
    QryArtListFornSCONTODIACQUISTO3: TIBOFloatField;
    QryArtListFornPREZZODILISTINO: TIBOFloatField;
    QrySoggettiAGENTE2: TStringField;
    QrySoggettiAGENTE3: TStringField;
    QrySoggettiAGENTE4: TStringField;
    QryDocAGENTE2: TStringField;
    QryDocAGENTE3: TStringField;
    QryDocAGENTE4: TStringField;
    QryGMAGENTE2: TStringField;
    QryGMAGENTE3: TStringField;
    QryGMAGENTE4: TStringField;
    QryPraticheAGENTE: TStringField;
    QryPraticheAGENTE2: TStringField;
    QryPraticheAGENTE3: TStringField;
    QryPraticheAGENTE4: TStringField;
    QryScadAGENTE2: TStringField;
    QryScadAGENTE3: TStringField;
    QryScadAGENTE4: TStringField;
    QueryPrimanotaAGENTE2: TStringField;
    QueryPrimanotaAGENTE3: TStringField;
    QueryPrimanotaAGENTE4: TStringField;
    QryImpAGENTE2: TStringField;
    QryImpAGENTE3: TStringField;
    QryImpAGENTE4: TStringField;
    FormMainPanel: TPanel;
    PanelAllegati: TPanel;
    SplitterAllegati: TcxSplitter;
    Creanuovocantiereconglistessisottocantieri1: TMenuItem;
    Centraletermica1: TMenuItem;
    Riscaldamento1: TMenuItem;
    Climatizzazione1: TMenuItem;
    Refrigerazione1: TMenuItem;
    Generico1: TMenuItem;
    N16: TMenuItem;
    N18: TMenuItem;
    QryAssCLIENTE: TIntegerField;
    QryAssPROXVISITAENTRO: TDateTimeField;
    QryAssDATAULTIMOINTERVENTO: TDateTimeField;
    QryAssDESCRIZIONE: TStringField;
    Stampaetichettedegliarticoliselezionati1: TMenuItem;
    QryAssPROVINCIAIMM: TStringField;
    QryPraticheIMMOBLOCALITA: TStringField;
    QryPraticheIMMOBPROVINCIA: TStringField;
    QryPraticheIMMOBCAP: TStringField;
    QryPraticheIMMOBINDIRIZZO: TStringField;
    QryAssABBONATO: TStringField;
    QryAssTIPOCONTRATTO: TStringField;
    QryAssIMPORTOCONTRATTO: TIBOFloatField;
    QryDocCATEGCANT1: TStringField;
    QryDocCATEGCANT2: TStringField;
    QryDocCATEGCANT3: TStringField;
    QryDocCATEGCANT4: TStringField;
    QryDocCATEGCANT5: TStringField;
    QryDocCATEGCANT6: TStringField;
    QryGMCATEGCANT1: TStringField;
    QryGMCATEGCANT2: TStringField;
    QryGMCATEGCANT3: TStringField;
    QryGMCATEGCANT4: TStringField;
    QryGMCATEGCANT5: TStringField;
    QryGMCATEGCANT6: TStringField;
    QryGMCODICEMAGAZZINO2: TSmallintField;
    QryGMDATAPRATICA1: TDateTimeField;
    QryGMRIFMAGA1: TStringField;
    QryGMRIFMAGA2: TStringField;
    QryGMCAUSALE: TStringField;
    QryImpEXISTS_PRESCRIZIONI: TStringField;
    QryImpEXISTS_CHIAMATE: TStringField;
    QryImpEXISTS_URGENTI: TStringField;
    QryImpPRATICA: TIntegerField;
    QryImpDATAPRATICA1: TDateTimeField;
    QryImpRELAZIONEINTERVENTO: TMemoField;
    QryImpRESOURCEID: TIntegerField;
    QrySoggettiEXISTS_PRESCRIZIONI: TStringField;
    QrySoggettiEXISTS_URGENTI: TStringField;
    QrySoggettiEXISTS_CHIAMATE: TStringField;
    QryPraticheID: TIntegerField;
    QryPraticheEXIST_PRESCRIZIONI: TStringField;
    QryPraticheEXIST_URGENTI: TStringField;
    QryPraticheEXIST_CHIAMATE: TStringField;
    QrySoggCantEXIST_CHIAMATE: TStringField;
    QrySoggCantEXIST_URGENTI: TStringField;
    QrySoggCantEXIST_PRESCRIZIONI: TStringField;
    N19: TMenuItem;
    Stampaelencocomunicazioni1: TMenuItem;
    QrySoggettiEXISTS_CORRISPNOPAG: TStringField;
    QrySoggCantEXIST_CORRISPNOPAG: TStringField;
    QryPraticheEXIST_CORRISPNOPAG: TStringField;
    QryImpEXISTS_CORRISPNOPAG: TStringField;
    QryDocEXISTS_CORRISPNOPAG: TStringField;
    QrySoggCantID: TIntegerField;
    PanelAgendaRight: TPanel;
    SplitterAgendaRight: TcxSplitter;
    ClientArea: TPanel;
    PageControl2: TPageControl;
    TabClienti: TTabSheet;
    PageControlClienti: TcxPageControl;
    TabClientiElenco: TcxTabSheet;
    PanelRubrica: TPanel;
    PanelGridSogg: TPanel;
    SpeedButtonRollOver9: TSpeedButtonRollOver;
    PanelFiltriSogg: TPanel;
    SubPanelFiltriSogg: TPanel;
    SBRubricaFilterOpenClose: TSpeedButtonRollOver;
    StaticText26: TStaticText;
    EditClientiCodice: TEdit;
    StaticText30: TStaticText;
    EditClientiRagSoc: TEdit;
    StaticText31: TStaticText;
    EditClientiCitta: TEdit;
    StaticText33: TStaticText;
    EditClientiProvincia: TEdit;
    StaticText35: TStaticText;
    TabLettera: TEdit;
    StaticText9: TStaticText;
    EditClientiPIVA: TEdit;
    StaticText54: TStaticText;
    EditClientiTelefono: TEdit;
    StaticText56: TStaticText;
    SoggStato: TcxComboBox;
    StaticText51: TStaticText;
    FilterRubricaTrova: TEdit;
    LabelFilterClientiAgente: TStaticText;
    EditClientiAgente: TcxComboBox;
    LabelFilterClientiAgente2: TStaticText;
    EditClientiAgente2: TcxComboBox;
    LabelFilterClientiAgente3: TStaticText;
    EditClientiAgente3: TcxComboBox;
    LabelFilterClientiAgente4: TStaticText;
    EditClientiAgente4: TcxComboBox;
    Panel5: TPanel;
    SpeedButton3: TSpeedButton;
    SpeedButton4: TSpeedButton;
    GridSogg: TcxGrid;
    tvRubrica: TcxGridDBTableView;
    tvRubricaEXISTS_PRESCRIZIONI: TcxGridDBColumn;
    tvRubricaEXISTS_CHIAMATE: TcxGridDBColumn;
    tvRubricaEXISTS_URGENTI: TcxGridDBColumn;
    tvRubricaEXISTS_CORRISPNOPAG: TcxGridDBColumn;
    tvRubricaCLIENTEFORNITORE: TcxGridDBColumn;
    tvRubricaCODICE: TcxGridDBColumn;
    tvRubricaRAGIONESOCIALE: TcxGridDBColumn;
    tvRubricaTELEFONO: TcxGridDBColumn;
    tvRubricaFAX: TcxGridDBColumn;
    tvRubricaCELLULARE: TcxGridDBColumn;
    tvRubricaCITTA: TcxGridDBColumn;
    tvRubricaINDIRIZZO: TcxGridDBColumn;
    tvRubricaCAP: TcxGridDBColumn;
    tvRubricaPROVINCIA: TcxGridDBColumn;
    tvRubricaEMAIL: TcxGridDBColumn;
    tvRubricaDATANASCITA: TcxGridDBColumn;
    tvRubricaLUOGONASCITA: TcxGridDBColumn;
    tvRubricaSTATODESCRIZIONE: TcxGridDBColumn;
    tvRubricaSTATOFOREGROUND: TcxGridDBColumn;
    tvRubricaSTATOBACKGROUND: TcxGridDBColumn;
    tvRubricaPARTITAIVA: TcxGridDBColumn;
    tvRubricaCODICEFISCALE: TcxGridDBColumn;
    tvRubricaPAGAM: TcxGridDBColumn;
    tvRubricaNOTE: TcxGridDBColumn;
    tvRubricaAGENTE: TcxGridDBColumn;
    tvRubricaAGENTE2: TcxGridDBColumn;
    tvRubricaAGENTE3: TcxGridDBColumn;
    tvRubricaAGENTE4: TcxGridDBColumn;
    tvSoggCant: TcxGridDBTableView;
    tvSoggCantEXIST_PRESCRIZIONI: TcxGridDBColumn;
    tvSoggCantEXIST_CHIAMATE: TcxGridDBColumn;
    tvSoggCantEXIST_URGENTI: TcxGridDBColumn;
    tvSoggCantEXIST_CORRISPNOPAG: TcxGridDBColumn;
    tvSoggCantTIPOPRATICA: TcxGridDBColumn;
    tvSoggCantCODICE: TcxGridDBColumn;
    tvSoggCantDESCRIZIONE: TcxGridDBColumn;
    tvSoggCantDATAAPERTURA: TcxGridDBColumn;
    tvSoggCantSTATODESCRIZIONE: TcxGridDBColumn;
    tvSoggCantCLIENTE: TcxGridDBColumn;
    lvRubrica: TcxGridLevel;
    lvSoggCant: TcxGridLevel;
    Panel8: TPanel;
    SBCollapseSoggetti: TSpeedButton;
    SBExpandSoggetti: TSpeedButton;
    SBFilterRowSoggetti: TSpeedButton;
    PanelTabsRubrica: TPanel;
    Sh1: TShape;
    Sh2: TShape;
    Sh3: TShape;
    Sh4: TShape;
    Sh5: TShape;
    Sh6: TShape;
    Sh7: TShape;
    Sh8: TShape;
    Sh9: TShape;
    Sh10: TShape;
    Sh11: TShape;
    Sh12: TShape;
    Sh13: TShape;
    Sh14: TShape;
    Sh15: TShape;
    Sh16: TShape;
    Sh17: TShape;
    Sh18: TShape;
    Sh19: TShape;
    Sh20: TShape;
    Sh21: TShape;
    Sh22: TShape;
    Sh23: TShape;
    Sh24: TShape;
    Sh25: TShape;
    Sh26: TShape;
    SB1: TSpeedButton;
    SB2: TSpeedButton;
    SB3: TSpeedButton;
    SB4: TSpeedButton;
    SB5: TSpeedButton;
    SB6: TSpeedButton;
    SB7: TSpeedButton;
    SB8: TSpeedButton;
    SB9: TSpeedButton;
    SB10: TSpeedButton;
    SB11: TSpeedButton;
    SB12: TSpeedButton;
    SB13: TSpeedButton;
    SB14: TSpeedButton;
    SB15: TSpeedButton;
    SB16: TSpeedButton;
    SB17: TSpeedButton;
    SB18: TSpeedButton;
    SB19: TSpeedButton;
    SB20: TSpeedButton;
    SB21: TSpeedButton;
    SB22: TSpeedButton;
    SB23: TSpeedButton;
    SB24: TSpeedButton;
    SB25: TSpeedButton;
    SB26: TSpeedButton;
    ShapeBordoSogg: TShape;
    TabClientiMappa: TcxTabSheet;
    TabDocumenti: TTabSheet;
    PanelDoc: TPanel;
    PanelDocFiltri: TPanel;
    SubPanelDocFiltri: TPanel;
    Label18: TLabel;
    Label17: TLabel;
    Shape2: TShape;
    Shape1: TShape;
    SBDocTutti: TSpeedButton;
    SBDocNessuno: TSpeedButton;
    LabelTipiDocVendite: TLabel;
    Label15: TLabel;
    Label16: TLabel;
    SBSet: TSpeedButton;
    SBOtt: TSpeedButton;
    SBNov: TSpeedButton;
    SBDic: TSpeedButton;
    SBAgo: TSpeedButton;
    SBLug: TSpeedButton;
    SBGiu: TSpeedButton;
    SBMag: TSpeedButton;
    SBGen: TSpeedButton;
    SBFeb: TSpeedButton;
    SBMar: TSpeedButton;
    SBApr: TSpeedButton;
    SBMesiTutti: TSpeedButton;
    SBMesiNessuno: TSpeedButton;
    SBDocFilterOpenClose: TSpeedButtonRollOver;
    SpeedButton1: TSpeedButton;
    LabelFilterDescrizione: TLabel;
    LabelFilterCodiceArticolo: TLabel;
    StaticText16: TStaticText;
    SoloRegistro: TcxComboBox;
    StaticText17: TStaticText;
    TranneRegistro: TcxComboBox;
    StaticText37: TStaticText;
    FilterNumDoc: TEdit;
    StaticText47: TStaticText;
    SoloStato: TcxComboBox;
    StaticText52: TStaticText;
    FilterDocTipoData: TcxComboBox;
    StaticText34: TStaticText;
    Causale: TcxComboBox;
    StaticText59: TStaticText;
    SoloTipoSoggetto: TcxComboBox;
    StaticText71: TStaticText;
    FilterTesto: TEdit;
    StaticText81: TStaticText;
    DocConCantiere: TCheckListBox;
    StaticText82: TStaticText;
    StaticText84: TStaticText;
    DocOperatore: TcxComboBox;
    StaticText63: TStaticText;
    FilterProtocollo: TEdit;
    FilterDescrizione: TEdit;
    FilterCodiceArticolo: TEdit;
    LabelFilterDocAgente: TStaticText;
    DocAgente: TcxComboBox;
    LabelFilterDocAgente2: TStaticText;
    DocAgente2: TcxComboBox;
    LabelFilterDocAgente3: TStaticText;
    DocAgente3: TcxComboBox;
    LabelFilterDocAgente4: TStaticText;
    DocAgente4: TcxComboBox;
    PanelFilterDocCategorieCantieri: TPanel;
    DocLabelCategCant1: TStaticText;
    DocCategCant1: TcxComboBox;
    DocLabelCategCant2: TStaticText;
    DocCategCant2: TcxComboBox;
    DocLabelCategCant3: TStaticText;
    DocCategCant3: TcxComboBox;
    DocLabelCategCant4: TStaticText;
    DocCategCant4: TcxComboBox;
    DocLabelCategCant5: TStaticText;
    DocCategCant5: TcxComboBox;
    DocLabelCategCant6: TStaticText;
    DocCategCant6: TcxComboBox;
    TabMagazzino: TTabSheet;
    PanelGM: TPanel;
    PanelGMFiltri: TPanel;
    SubPanelGMFiltri: TPanel;
    Label21: TLabel;
    Label24: TLabel;
    Label23: TLabel;
    Label22: TLabel;
    Label20: TLabel;
    Label14: TLabel;
    Sett: TSpeedButton;
    Ott: TSpeedButton;
    Nov: TSpeedButton;
    Dic: TSpeedButton;
    Ago: TSpeedButton;
    Lug: TSpeedButton;
    Giu: TSpeedButton;
    Mag: TSpeedButton;
    Gen: TSpeedButton;
    Feb: TSpeedButton;
    Mar: TSpeedButton;
    Apr: TSpeedButton;
    GMMesiTutti: TSpeedButton;
    GMMesiNessuno: TSpeedButton;
    BitBtnGruppo1: TSpeedButtonRollOver;
    Label26: TLabel;
    BitBtnCodiceMagazzino: TSpeedButtonRollOver;
    BitBtnGruppo2: TSpeedButtonRollOver;
    BitBtnGruppo3: TSpeedButtonRollOver;
    SpeedButtonRollOver3: TSpeedButtonRollOver;
    Label30: TLabel;
    Label59: TLabel;
    Label60: TLabel;
    Label61: TLabel;
    BitBtnGruppo4: TSpeedButtonRollOver;
    BitBtnGruppo5: TSpeedButtonRollOver;
    BitBtnGruppo6: TSpeedButtonRollOver;
    Shape17: TShape;
    Shape18: TShape;
    SBGMTutti: TSpeedButton;
    SBGMNessuno: TSpeedButton;
    Label54: TLabel;
    Label69: TLabel;
    Label70: TLabel;
    Label72: TLabel;
    Label76: TLabel;
    SBGMFilterOpenClose: TSpeedButtonRollOver;
    SpeedButton2: TSpeedButton;
    GMCodiceArticolo: TEdit;
    GMDescGruppo1: TEdit;
    GMDescGruppo2: TEdit;
    GMDescGruppo3: TEdit;
    GMGruppiTitolo: TStaticText;
    GMCodiceMagazzino: TEdit;
    GMDescrizioneMagazzino: TEdit;
    GMCodiceGruppo1: TEdit;
    GMCodiceGruppo2: TEdit;
    GMCodiceGruppo3: TEdit;
    StaticText15: TStaticText;
    GMMarca: TEdit;
    GMDescGruppo4: TEdit;
    GMDescGruppo5: TEdit;
    GMDescGruppo6: TEdit;
    GMCodiceGruppo4: TEdit;
    GMCodiceGruppo5: TEdit;
    GMCodiceGruppo6: TEdit;
    StaticText48: TStaticText;
    GMSoloStato: TcxComboBox;
    CLBSegnoOpMagazzino: TCheckListBox;
    CLBSegnoOpCantiere: TCheckListBox;
    RBTipoMovMagazzino: TRadioButton;
    RBTipoMovCantiere: TRadioButton;
    StaticText6: TStaticText;
    GMCausale: TcxComboBox;
    StaticText77: TStaticText;
    GMDescrizione: TEdit;
    GMLabelTipo1: TStaticText;
    GMTipo1: TcxComboBox;
    GMLabelTipo2: TStaticText;
    GMTipo2: TcxComboBox;
    GMLabelTipo3: TStaticText;
    GMTipo3: TcxComboBox;
    GMLabelTipo4: TStaticText;
    GMTipo4: TcxComboBox;
    GMLabelTipo5: TStaticText;
    GMTipo5: TcxComboBox;
    GMLabelTipo6: TStaticText;
    GMTipo6: TcxComboBox;
    GMLabelSottocantiere1: TStaticText;
    GMSottocantiere1: TcxComboBox;
    GMLabelSottocantiere2: TStaticText;
    GMSottocantiere2: TcxComboBox;
    GMLabelSottocantiere3: TStaticText;
    GMSottocantiere3: TcxComboBox;
    StaticText53: TStaticText;
    LabelGMAgente: TStaticText;
    GMAgente: TcxComboBox;
    LabelGMAgente2: TStaticText;
    GMAgente2: TcxComboBox;
    LabelGMAgente3: TStaticText;
    GMAgente3: TcxComboBox;
    LabelGMAgente4: TStaticText;
    GMAgente4: TcxComboBox;
    PanelFilterGMCategorieCantieri: TPanel;
    GMLabelCategCant1: TStaticText;
    GMCategCant1: TcxComboBox;
    GMLabelCategCant2: TStaticText;
    GMCategCant2: TcxComboBox;
    GMLabelCategCant3: TStaticText;
    GMCategCant3: TcxComboBox;
    GMLabelCategCant4: TStaticText;
    GMCategCant4: TcxComboBox;
    GMLabelCategCant5: TStaticText;
    GMCategCant5: TcxComboBox;
    GMLabelCategCant6: TStaticText;
    GMCategCant6: TcxComboBox;
    FilterGMTipoDataLabel: TStaticText;
    FilterGMTipoData: TcxComboBox;
    Panel13: TPanel;
    SpeedButton7: TSpeedButton;
    SpeedButton8: TSpeedButton;
    TabCondVend: TTabSheet;
    PanelCV: TPanel;
    GridCV: TcxGrid;
    tvCV: TcxGridDBTableView;
    tvCVTIPO: TcxGridDBColumn;
    tvCVRIFERIMENTO: TcxGridDBColumn;
    tvCVDAQTA1: TcxGridDBColumn;
    tvCVSCONTO1: TcxGridDBColumn;
    tvCVIMPORTO1: TcxGridDBColumn;
    tvCVDAQTA2: TcxGridDBColumn;
    tvCVSCONTO2: TcxGridDBColumn;
    tvCVIMPORTO2: TcxGridDBColumn;
    tvCVDAQTA3: TcxGridDBColumn;
    tvCVSCONTO3: TcxGridDBColumn;
    tvCVIMPORTO3: TcxGridDBColumn;
    tvCVRAGIONESOCIALE: TcxGridDBColumn;
    tvCVCODICESOGGETTO: TcxGridDBColumn;
    tvCVCODICEARTICOLO: TcxGridDBColumn;
    tvCVCODICEGRUPPO1: TcxGridDBColumn;
    tvCVCODICEGRUPPO2: TcxGridDBColumn;
    tvCVCODICEGRUPPO3: TcxGridDBColumn;
    lvCV: TcxGridLevel;
    PanelCVFiltri: TPanel;
    SubPanelCVFiltri: TPanel;
    Label29: TLabel;
    Label28: TLabel;
    Label27: TLabel;
    BitBtnCVGruppo1: TSpeedButtonRollOver;
    BitBtnCVGruppo2: TSpeedButtonRollOver;
    BitBtnCVGruppo3: TSpeedButtonRollOver;
    Label32: TLabel;
    BitBtnCVArticolo: TSpeedButtonRollOver;
    Shape6: TShape;
    Label5: TLabel;
    StaticText1: TStaticText;
    StaticText25: TStaticText;
    CVCodiceArticolo: TEdit;
    CVDescGruppo1: TEdit;
    CVDescGruppo2: TEdit;
    CVDescGruppo3: TEdit;
    CVCodiceGruppo1: TEdit;
    CVCodiceGruppo2: TEdit;
    CVCodiceGruppo3: TEdit;
    CVDescrizioneArticolo: TEdit;
    StaticText24: TStaticText;
    TipoCondizione: TCheckListBox;
    Panel14: TPanel;
    SpeedButton9: TSpeedButton;
    SpeedButton10: TSpeedButton;
    TabPratiche: TTabSheet;
    PageControlPratiche: TcxPageControl;
    TabPraticheElenco: TcxTabSheet;
    PanelPratiche: TPanel;
    GridPrat: TcxGrid;
    tvPrat: TcxGridDBTableView;
    tvPratEXIST_PRESCRIZIONI: TcxGridDBColumn;
    tvPratEXIST_CHIAMATE: TcxGridDBColumn;
    tvPratEXIST_URGENTI: TcxGridDBColumn;
    tvPratEXIST_CORRISPNOPAG: TcxGridDBColumn;
    tvPratCODICE: TcxGridDBColumn;
    tvPratDESCRIZIONE: TcxGridDBColumn;
    tvPratDATAAPERTURA: TcxGridDBColumn;
    tvPratDATACHIUSURA: TcxGridDBColumn;
    tvPratSTATODESCRIZIONE: TcxGridDBColumn;
    tvPratRAGIONESOCIALE: TcxGridDBColumn;
    tvPratSTATOFOREGROUND: TcxGridDBColumn;
    tvPratSTATOBACKGROUND: TcxGridDBColumn;
    tvPratCATEGCANT1: TcxGridDBColumn;
    tvPratCATEGCANT2: TcxGridDBColumn;
    tvPratCATEGCANT3: TcxGridDBColumn;
    tvPratCATEGCANT4: TcxGridDBColumn;
    tvPratCATEGCANT5: TcxGridDBColumn;
    tvPratCATEGCANT6: TcxGridDBColumn;
    tvPratAGENTE: TcxGridDBColumn;
    tvPratAGENTE2: TcxGridDBColumn;
    tvPratAGENTE3: TcxGridDBColumn;
    tvPratAGENTE4: TcxGridDBColumn;
    tvPratIMMOBLOCALITA: TcxGridDBColumn;
    tvPratIMMOBINDIRIZZO: TcxGridDBColumn;
    tvPratIMMOBCAP: TcxGridDBColumn;
    tvPratIMMOBPROVINCIA: TcxGridDBColumn;
    lvPrat: TcxGridLevel;
    PanelPratFiltri: TPanel;
    SubPanelPratFiltri: TPanel;
    Label34: TLabel;
    Label33: TLabel;
    PratOtt: TSpeedButton;
    PratNov: TSpeedButton;
    PratDic: TSpeedButton;
    PratAgo: TSpeedButton;
    PratLug: TSpeedButton;
    PratGiu: TSpeedButton;
    PratMag: TSpeedButton;
    PratGen: TSpeedButton;
    PratFeb: TSpeedButton;
    PratMar: TSpeedButton;
    PratApr: TSpeedButton;
    PratMesiTutti: TSpeedButton;
    PratMesiNessuno: TSpeedButton;
    PratSet: TSpeedButton;
    SBPratFilterOpenClose: TSpeedButtonRollOver;
    SpeedButton21: TSpeedButton;
    StaticText40: TStaticText;
    PratCodice: TEdit;
    StaticText43: TStaticText;
    CantieriApertiChiusi: TCheckListBox;
    StaticText55: TStaticText;
    PratStato: TcxComboBox;
    StaticText2: TStaticText;
    PratDescrizione: TEdit;
    PanelFilterCategorieCantieri: TPanel;
    PratLabelCategCant1: TStaticText;
    PratCategCant1: TcxComboBox;
    PratLabelCategCant2: TStaticText;
    PratCategCant2: TcxComboBox;
    PratLabelCategCant3: TStaticText;
    PratCategCant3: TcxComboBox;
    PratLabelCategCant4: TStaticText;
    PratCategCant4: TcxComboBox;
    PratLabelCategCant5: TStaticText;
    PratCategCant5: TcxComboBox;
    PratLabelCategCant6: TStaticText;
    PratCategCant6: TcxComboBox;
    LabelPratAgente: TStaticText;
    PratAgente: TcxComboBox;
    LabelPratAgente2: TStaticText;
    PratAgente2: TcxComboBox;
    LabelPratAgente3: TStaticText;
    PratAgente3: TcxComboBox;
    LabelPratAgente4: TStaticText;
    PratAgente4: TcxComboBox;
    Panel2: TPanel;
    SBCollapsePratiche: TSpeedButton;
    SBExpandPratiche: TSpeedButton;
    SBFilterRowPratiche: TSpeedButton;
    TabPraticheMappa: TcxTabSheet;
    TabScadenze: TTabSheet;
    PanelScadenze: TPanel;
    PanelScadFiltri: TPanel;
    SubPanelScadFiltri: TPanel;
    Label53: TLabel;
    Label36: TLabel;
    Label35: TLabel;
    ScadSet: TSpeedButton;
    ScadOtt: TSpeedButton;
    ScadNov: TSpeedButton;
    ScadDic: TSpeedButton;
    ScadAgo: TSpeedButton;
    ScadLug: TSpeedButton;
    ScadGiu: TSpeedButton;
    ScadMag: TSpeedButton;
    ScadGen: TSpeedButton;
    ScadFeb: TSpeedButton;
    ScadMar: TSpeedButton;
    ScadApr: TSpeedButton;
    ScadMesiTutti: TSpeedButton;
    ScadMesiNessuno: TSpeedButton;
    SBScadFilterOpenClose: TSpeedButtonRollOver;
    SpeedButton22: TSpeedButton;
    StaticText4: TStaticText;
    StaticText45: TStaticText;
    ScadCodice: TEdit;
    TipoScadenze: TCheckListBox;
    StaticText12: TStaticText;
    TipoScadenze2: TCheckListBox;
    StaticText14: TStaticText;
    TipoScadenze3: TCheckListBox;
    StaticText44: TStaticText;
    ScadTipoDoc: TcxComboBox;
    StaticText46: TStaticText;
    ScadNumDoc: TEdit;
    ScadRegistro: TEdit;
    StaticText3: TStaticText;
    TipoImporto: TCheckListBox;
    StaticText7: TStaticText;
    ScadDescrizione: TEdit;
    StaticText58: TStaticText;
    ScadStato: TcxComboBox;
    StaticText67: TStaticText;
    ScadSoloRegistro: TcxComboBox;
    StaticText89: TStaticText;
    ScadTranneRegistro: TcxComboBox;
    StaticText90: TStaticText;
    ScadTipoData: TcxComboBox;
    LabelFilterScadAgente: TStaticText;
    ScadAgente: TcxComboBox;
    LabelFilterScadAgente2: TStaticText;
    ScadAgente2: TcxComboBox;
    LabelFilterScadAgente3: TStaticText;
    ScadAgente3: TcxComboBox;
    LabelFilterScadAgente4: TStaticText;
    ScadAgente4: TcxComboBox;
    Panel3: TPanel;
    SBPagamentoRiscossione: TSpeedButtonRollOver;
    TabPrimanota: TTabSheet;
    PanelPrimanota: TPanel;
    GridPrimanota: TcxGrid;
    tvPrimanota: TcxGridDBTableView;
    tvPrimanotaData: TcxGridDBColumn;
    tvPrimanotaDescrizione: TcxGridDBColumn;
    tvPrimanotaCassaEntrate: TcxGridDBColumn;
    tvPrimanotaCassaUscite: TcxGridDBColumn;
    tvPrimanotaDescFuori: TcxGridDBColumn;
    tvPrimanotaFuoriEntrate: TcxGridDBColumn;
    tvPrimanotaFuoriUscite: TcxGridDBColumn;
    tvPrimanotaAbbuoniPassivi: TcxGridDBColumn;
    tvPrimanotaAbbuoniAttivi: TcxGridDBColumn;
    tvPrimanotaNote: TcxGridDBColumn;
    tvPrimanotaRAGSOCCLI: TcxGridDBColumn;
    tvPrimanotaRIFPRATICA: TcxGridDBColumn;
    tvPrimanotaCLIENTE: TcxGridDBColumn;
    tvPrimanotaCodice: TcxGridDBColumn;
    tvPrimanotaSTATODESCRIZIONE: TcxGridDBColumn;
    tvPrimanotaSTATOFOREGROUND: TcxGridDBColumn;
    tvPrimanotaSTATOBACKGROUND: TcxGridDBColumn;
    tvPrimanotaAGENTE: TcxGridDBColumn;
    tvPrimanotaAGENTE2: TcxGridDBColumn;
    tvPrimanotaAGENTE3: TcxGridDBColumn;
    tvPrimanotaAGENTE4: TcxGridDBColumn;
    lvPrimanota: TcxGridLevel;
    Panel12: TPanel;
    Shape30: TShape;
    Label106: TLabel;
    Shape31: TShape;
    Label107: TLabel;
    Label108: TLabel;
    Label109: TLabel;
    Label110: TLabel;
    Label111: TLabel;
    Label112: TLabel;
    DBText1: TDBText;
    DBText2: TDBText;
    DBText3: TDBText;
    DBText4: TDBText;
    DBText5: TDBText;
    DBText6: TDBText;
    Panel24: TPanel;
    Shape32: TShape;
    Shape33: TShape;
    Shape34: TShape;
    Shape35: TShape;
    Label113: TLabel;
    Label114: TLabel;
    Label115: TLabel;
    Label116: TLabel;
    Label117: TLabel;
    Label118: TLabel;
    Label119: TLabel;
    DBText7: TDBText;
    DBText8: TDBText;
    DBText9: TDBText;
    DBText10: TDBText;
    DBText11: TDBText;
    DBText12: TDBText;
    Shape36: TShape;
    DBText14: TDBText;
    DBText15: TDBText;
    DBText16: TDBText;
    DBText17: TDBText;
    DBText18: TDBText;
    DBText19: TDBText;
    Label120: TLabel;
    Panel33: TPanel;
    PrmCollapse: TSpeedButton;
    PrmExpand: TSpeedButton;
    PanelPrimanotFiltri: TPanel;
    SubPanelPrimanotFiltri: TPanel;
    Label121: TLabel;
    Label122: TLabel;
    PrmSet: TSpeedButton;
    PrmOtt: TSpeedButton;
    PrmNov: TSpeedButton;
    PrmDic: TSpeedButton;
    PrmAgo: TSpeedButton;
    PrmLug: TSpeedButton;
    PrmGiu: TSpeedButton;
    PrmMag: TSpeedButton;
    PrmGen: TSpeedButton;
    PrmFeb: TSpeedButton;
    PrmMar: TSpeedButton;
    PrmApr: TSpeedButton;
    PrmMesiTutti: TSpeedButton;
    PrmMesiNessuno: TSpeedButton;
    SBPrimanotFilterOpenClose: TSpeedButtonRollOver;
    SvPrimanotaSaveDateFilter: TSpeedButton;
    StaticText76: TStaticText;
    StaticText41: TStaticText;
    PrmSearchKey: TEdit;
    StaticText83: TStaticText;
    PrmStato: TcxComboBox;
    LabelPrmAgente: TStaticText;
    PrmAgente: TcxComboBox;
    LabelPrmAgente2: TStaticText;
    PrmAgente2: TcxComboBox;
    LabelPrmAgente3: TStaticText;
    PrmAgente3: TcxComboBox;
    LabelPrmAgente4: TStaticText;
    PrmAgente4: TcxComboBox;
    TabArticoli: TTabSheet;
    PanelArticoli: TPanel;
    GridArt: TcxGrid;
    tvArt: TcxGridDBTableView;
    tvArtCODICEARTICOLO: TcxGridDBColumn;
    tvArtDESCRIZIONE: TcxGridDBColumn;
    tvArtMARCA: TcxGridDBColumn;
    tvArtUNITADIMISURA: TcxGridDBColumn;
    tvArtPREZZODILISTINO: TcxGridDBColumn;
    tvArtSCONTODIACQUISTO: TcxGridDBColumn;
    tvArtULTIMOPRZACQUISTO: TcxGridDBColumn;
    tvArtDATAULTMOD_COSTO: TcxGridDBColumn;
    tvArtDATAULTMOD_LISTINO: TcxGridDBColumn;
    tvArtDATAULTMOD_GENERALE: TcxGridDBColumn;
    tvArtDATAULTMOD_VENDITA: TcxGridDBColumn;
    tvArtDATAULTMOD_CREAZIONE: TcxGridDBColumn;
    tvArtGIACENZA: TcxGridDBColumn;
    tvArtIMPEGNATO: TcxGridDBColumn;
    tvArtORDINATO: TcxGridDBColumn;
    tvArtDISPONIBILE: TcxGridDBColumn;
    tvArtPREZZODIVENDITA: TcxGridDBColumn;
    tvArtPREZZODIVENDITA2: TcxGridDBColumn;
    tvArtPREZZODIVENDITA3: TcxGridDBColumn;
    tvArtPREZZODIVENDITA4: TcxGridDBColumn;
    tvArtPRZVENDIVACOMP1: TcxGridDBColumn;
    tvArtPRZVENDIVACOMP2: TcxGridDBColumn;
    tvArtPRZVENDIVACOMP3: TcxGridDBColumn;
    tvArtPRZVENDIVACOMP4: TcxGridDBColumn;
    tvArtPUNTORIORDINO: TcxGridDBColumn;
    tvArtSCORTAMINIMA: TcxGridDBColumn;
    tvArtABILITAMOVMAG: TcxGridDBColumn;
    tvArtUBICAZIONE: TcxGridDBColumn;
    tvArtGRUPPO1: TcxGridDBColumn;
    tvArtGRUPPO2: TcxGridDBColumn;
    tvArtGRUPPO3: TcxGridDBColumn;
    tvArtGRUPPO4: TcxGridDBColumn;
    tvArtGRUPPO5: TcxGridDBColumn;
    tvArtGRUPPO6: TcxGridDBColumn;
    tvArtULTIMOCOSTOREALE: TcxGridDBColumn;
    tvArtIMPORTOULTIMOCOSTOREALE: TcxGridDBColumn;
    tvArtARTICOLOCOMPOSTO: TcxGridDBColumn;
    tvArtQUANTITAAUTOMATICA: TcxGridDBColumn;
    tvArtCODICIAGGIUNTIVI: TcxGridDBColumn;
    tvArtSCONTODIACQUISTO2: TcxGridDBColumn;
    tvArtSCONTODIACQUISTO3: TcxGridDBColumn;
    tvArtCODICEFORNITORE: TcxGridDBColumn;
    tvLF: TcxGridDBTableView;
    tvLFPREFERITO: TcxGridDBColumn;
    tvLFCODICEARTICOLO: TcxGridDBColumn;
    tvLFCODICEFORNITORE: TcxGridDBColumn;
    tvLFRAGIONESOCIALE: TcxGridDBColumn;
    tvLFPREZZODILISTINO: TcxGridDBColumn;
    tvLFSCONTODIACQUISTO1: TcxGridDBColumn;
    tvLFSCONTODIACQUISTO2: TcxGridDBColumn;
    tvLFSCONTODIACQUISTO3: TcxGridDBColumn;
    tvLFPREZZODIACQUISTO: TcxGridDBColumn;
    tvLFCODICEARTICOLOFORNITORE: TcxGridDBColumn;
    tvLFDESCRIZIONEFORNITORE: TcxGridDBColumn;
    tvArtMag: TcxGridDBTableView;
    tvArtMagCODMAG: TcxGridDBColumn;
    tvArtMagDESCMAG: TcxGridDBColumn;
    tvArtMagGIACENZA: TcxGridDBColumn;
    tvArtMagIMPEGNATO: TcxGridDBColumn;
    tvArtMagORDINATO: TcxGridDBColumn;
    tvArtMagDISPONIBILE: TcxGridDBColumn;
    tvArtMagCODICEARTICOLO: TcxGridDBColumn;
    lvArt: TcxGridLevel;
    lvLF: TcxGridLevel;
    lvArtMag: TcxGridLevel;
    PanelFiltri: TPanel;
    SubPanelFiltri: TPanel;
    Label37: TLabel;
    Label38: TLabel;
    Label39: TLabel;
    BitBtnArtGruppo1: TSpeedButtonRollOver;
    BitBtnArtGruppo2: TSpeedButtonRollOver;
    BitBtnArtGruppo3: TSpeedButtonRollOver;
    Label40: TLabel;
    BitBtnArtCodiceMagazzino: TSpeedButtonRollOver;
    Label56: TLabel;
    Label57: TLabel;
    Label58: TLabel;
    BitBtnArtGruppo4: TSpeedButtonRollOver;
    BitBtnArtGruppo5: TSpeedButtonRollOver;
    BitBtnArtGruppo6: TSpeedButtonRollOver;
    Label101: TLabel;
    SBArtFilterOpenClose: TSpeedButtonRollOver;
    EditArtSoloArticoliMovimentati: TcxCheckBox;
    StaticText5: TStaticText;
    GruppiTitolo: TStaticText;
    StaticText19: TStaticText;
    EditArtCodice: TEdit;
    StaticText18: TStaticText;
    EditArtDescrizione: TEdit;
    StaticText21: TStaticText;
    EditArtMarca: TEdit;
    StaticText22: TStaticText;
    EditBarCode: TEdit;
    DescGruppo1: TEdit;
    DescGruppo2: TEdit;
    DescGruppo3: TEdit;
    CodiceGruppo1: TEdit;
    CodiceGruppo2: TEdit;
    CodiceGruppo3: TEdit;
    StaticText38: TStaticText;
    CodiceMagazzino: TEdit;
    DescrizioneMagazzino: TEdit;
    SoloGiacAttiva: TCheckListBox;
    StaticText10: TStaticText;
    EditArtUbicazione: TEdit;
    StaticText13: TStaticText;
    Composti: TCheckListBox;
    DescGruppo4: TEdit;
    DescGruppo5: TEdit;
    DescGruppo6: TEdit;
    CodiceGruppo4: TEdit;
    CodiceGruppo5: TEdit;
    CodiceGruppo6: TEdit;
    StaticText49: TStaticText;
    FilterArtTrova: TEdit;
    EditArtSoloArticoliMovimentatiTipo: TcxComboBox;
    EditArtSoloArticoliMovimentatiDal: TcxDateEdit;
    EditArtSoloArticoliMovimentatiAl: TcxDateEdit;
    Panel17: TPanel;
    SpeedButton15: TSpeedButton;
    SpeedButton16: TSpeedButton;
    TabAssistenze: TTabSheet;
    PanelImpianti: TPanel;
    TabImpegni: TTabSheet;
    PageControlImpegni: TcxPageControl;
    TabImpegniElenco: TcxTabSheet;
    PanelImpegni: TPanel;
    GridImpegni: TcxGrid;
    tvImpegni: TcxGridDBTableView;
    tvImpegniEXISTS_PRESCRIZIONI: TcxGridDBColumn;
    tvImpegniEXISTS_CHIAMATE: TcxGridDBColumn;
    tvImpegniEXISTS_URGENTI: TcxGridDBColumn;
    tvImpegniEXISTS_CORRISPNOPAG: TcxGridDBColumn;
    tvImpegniTIPOIMPEGNO: TcxGridDBColumn;
    tvImpegniID: TcxGridDBColumn;
    tvImpegniREGISTRO: TcxGridDBColumn;
    tvImpegniRAGIONESOCIALE: TcxGridDBColumn;
    tvImpegniRIFPRATICA: TcxGridDBColumn;
    tvImpegniEVENTMESSAGE: TcxGridDBColumn;
    tvImpegniSTART: TcxGridDBColumn;
    tvImpegniLOCATION: TcxGridDBColumn;
    tvImpegniTIPOINTERVENTO: TcxGridDBColumn;
    tvImpegniTECNICO: TcxGridDBColumn;
    tvImpegniCHIAMATA: TcxGridDBColumn;
    tvImpegniDATAORAINTERVENTO: TcxGridDBColumn;
    tvImpegniAGENTE: TcxGridDBColumn;
    tvImpegniAGENTE2: TcxGridDBColumn;
    tvImpegniAGENTE3: TcxGridDBColumn;
    tvImpegniAGENTE4: TcxGridDBColumn;
    tvImpegniCODICEARTICOLO: TcxGridDBColumn;
    tvImpegniDESCRIZIONEARTICOLO: TcxGridDBColumn;
    lvImpegni: TcxGridLevel;
    PanelImpFiltri: TPanel;
    SubPanelImpFiltri: TPanel;
    Label50: TLabel;
    Label51: TLabel;
    ImpOtt: TSpeedButton;
    ImpNov: TSpeedButton;
    ImpDic: TSpeedButton;
    ImpAgo: TSpeedButton;
    ImpLug: TSpeedButton;
    ImpGiu: TSpeedButton;
    ImpMag: TSpeedButton;
    ImpGen: TSpeedButton;
    ImpFeb: TSpeedButton;
    ImpMar: TSpeedButton;
    ImpApr: TSpeedButton;
    ImpMesiTutti: TSpeedButton;
    ImpMesiNessuno: TSpeedButton;
    ImpSet: TSpeedButton;
    LabelFilterCodiceTecnico: TLabel;
    BtnTecnico: TSpeedButtonRollOver;
    Label55: TLabel;
    SBImpFilterOpenClose: TSpeedButtonRollOver;
    ImpSaveFilterDate: TSpeedButton;
    BordoImpTipoIMpegno: TStaticText;
    ImpTipoIMpegno: TCheckListBox;
    BordoImpTipoIntervento: TStaticText;
    ImpTipoIntervento: TCheckListBox;
    FilterCodiceTecnico: TEdit;
    FilterTecnico: TEdit;
    StaticText78: TStaticText;
    FilterImpTrova: TEdit;
    BordoImpConCantiere: TStaticText;
    ImpConCantiere: TCheckListBox;
    LabelImpFilterAgente: TStaticText;
    ImpAgente: TcxComboBox;
    LabelImpFilterAgente2: TStaticText;
    ImpAgente2: TcxComboBox;
    LabelImpFilterAgente3: TStaticText;
    ImpAgente3: TcxComboBox;
    LabelImpFilterAgente4: TStaticText;
    ImpAgente4: TcxComboBox;
    Panel7: TPanel;
    SBCOllapseImpegni: TSpeedButton;
    SBExpandImpegni: TSpeedButton;
    SBFilterRowImpegni: TSpeedButton;
    TabImpegniMappa: TcxTabSheet;
    TabAgenda: TTabSheet;
    PanelAgenda: TPanel;
    Agenda_NormalSelectionMode: TcxScheduler;
    TabGC: TTabSheet;
    PanelGC: TPanel;
    TabPartitario: TTabSheet;
    PanelPartitario: TPanel;
    TabGOS: TTabSheet;
    cxPageControlGOS: TcxPageControl;
    TabManodopera: TcxTabSheet;
    PanelGOS: TPanel;
    PanelGosFiltri: TPanel;
    SubPanelGosFiltri: TPanel;
    Label93: TLabel;
    Label94: TLabel;
    GOSSet: TSpeedButton;
    GOSOtt: TSpeedButton;
    GOSNov: TSpeedButton;
    GOSDic: TSpeedButton;
    GOSAgo: TSpeedButton;
    GOSLug: TSpeedButton;
    GOSGiu: TSpeedButton;
    GOSMag: TSpeedButton;
    GOSGen: TSpeedButton;
    GOSFeb: TSpeedButton;
    GOSMar: TSpeedButton;
    GOSApr: TSpeedButton;
    GOSMesiTutti: TSpeedButton;
    GOSMesiNessuno: TSpeedButton;
    Label92: TLabel;
    BtnFilterGosDipendente: TSpeedButtonRollOver;
    Label96: TLabel;
    SBGosFilterOpenClose: TSpeedButtonRollOver;
    GosSaveDateFilter: TSpeedButton;
    FilterGosCodiceDipendente: TEdit;
    FilterGosDescrizDipendente: TEdit;
    StaticText60: TStaticText;
    FilterGosTipoOre1: TcxComboBox;
    StaticText61: TStaticText;
    FilterGosTipoOre2: TcxComboBox;
    StaticText62: TStaticText;
    FilterGosTipoOre3: TcxComboBox;
    StaticText70: TStaticText;
    FilterGosNote: TEdit;
    StaticText8: TStaticText;
    FilterGosTipoManodopera: TcxComboBox;
    LabelGosSottocantiere1: TStaticText;
    FilterGosSottocantiere1: TcxComboBox;
    LabelGosSottocantiere2: TStaticText;
    FilterGosSottocantiere2: TcxComboBox;
    LabelGosSottocantiere3: TStaticText;
    FilterGosSottocantiere3: TcxComboBox;
    StaticText68: TStaticText;
    FilterGosSoloRegistro: TcxComboBox;
    StaticText72: TStaticText;
    FilterGosTranneRegistro: TcxComboBox;
    StaticText73: TStaticText;
    FilterGosNumDoc: TEdit;
    StaticText74: TStaticText;
    FilterGosStato: TcxComboBox;
    cxPageControlGOSOre: TcxPageControl;
    TabGOSOreElenco: TcxTabSheet;
    GridOre: TcxGrid;
    tvOre: TcxGridDBTableView;
    tvOreTIPODOC: TcxGridDBColumn;
    tvOreNUMDOC: TcxGridDBColumn;
    tvOreREGISTRO: TcxGridDBColumn;
    tvOreDATADOC: TcxGridDBColumn;
    tvOreDIPENDENTE: TcxGridDBColumn;
    tvOreCANTIERE: TcxGridDBColumn;
    tvOreSOGGETTO: TcxGridDBColumn;
    tvOreCOSTOORARIO: TcxGridDBColumn;
    tvOreQTA: TcxGridDBColumn;
    tvOreIMPORTOCOSTOORARIO: TcxGridDBColumn;
    tvOreNOTE: TcxGridDBColumn;
    tvOreSOTTOCANTIERE1: TcxGridDBColumn;
    tvOreSOTTOCANTIERE2: TcxGridDBColumn;
    tvOreSOTTOCANTIERE3: TcxGridDBColumn;
    tvOreTIPOORE1: TcxGridDBColumn;
    tvOreTIPOORE2: TcxGridDBColumn;
    tvOreTIPOORE3: TcxGridDBColumn;
    tvOreDOCUMENTO: TcxGridDBColumn;
    tvOreNUMRIGO: TcxGridDBColumn;
    tvOrePRZVEND: TcxGridDBColumn;
    tvOreIMPORTOVEND: TcxGridDBColumn;
    tvOreCOSTOSTRAORDINARIO: TcxGridDBColumn;
    tvOreQTASTRAORDINARIO: TcxGridDBColumn;
    tvOreIMPORTOSTRAORDINARIO: TcxGridDBColumn;
    tvOreCOSTOPERMESSI: TcxGridDBColumn;
    tvOreQTAPERMESSI: TcxGridDBColumn;
    tvOreIMPORTOPERMESSI: TcxGridDBColumn;
    tvOreCOSTOFERIE: TcxGridDBColumn;
    tvOreQTAFERIE: TcxGridDBColumn;
    tvOreIMPORTOFERIE: TcxGridDBColumn;
    tvOreCOSTOTRASFERTE: TcxGridDBColumn;
    tvOreQTATRASFERTE: TcxGridDBColumn;
    tvOreIMPORTOTRASFERTE: TcxGridDBColumn;
    tvOreOREBASE: TcxGridDBColumn;
    tvOreOPERAINDEX: TcxGridDBColumn;
    tvOreNUMRIGO2: TcxGridDBColumn;
    tvOreSTATODESCRIZIONE: TcxGridDBColumn;
    tvOreSTATOFOREGROUND: TcxGridDBColumn;
    tvOreSTATOBACKGROUND: TcxGridDBColumn;
    lvOre: TcxGridLevel;
    TabGosOreAda: TcxTabSheet;
    GosOrePivot: TcxDBPivotGrid;
    cxDBPivotGrid1NUMDOC: TcxDBPivotGridField;
    cxDBPivotGrid1DATADOC: TcxDBPivotGridField;
    cxDBPivotGrid1REGISTRO: TcxDBPivotGridField;
    cxDBPivotGrid1QTA: TcxDBPivotGridField;
    cxDBPivotGrid1COSTOORARIO: TcxDBPivotGridField;
    cxDBPivotGrid1IMPORTOCOSTOORARIO: TcxDBPivotGridField;
    cxDBPivotGrid1NOTE: TcxDBPivotGridField;
    cxDBPivotGrid1TIPOORE1: TcxDBPivotGridField;
    cxDBPivotGrid1TIPOORE2: TcxDBPivotGridField;
    cxDBPivotGrid1TIPOORE3: TcxDBPivotGridField;
    cxDBPivotGrid1DOCUMENTO: TcxDBPivotGridField;
    cxDBPivotGrid1DIPENDENTE: TcxDBPivotGridField;
    cxDBPivotGrid1CANTIERE: TcxDBPivotGridField;
    cxDBPivotGrid1SOGGETTO: TcxDBPivotGridField;
    cxDBPivotGrid1NUMRIGO: TcxDBPivotGridField;
    cxDBPivotGrid1PRZVEND: TcxDBPivotGridField;
    cxDBPivotGrid1IMPORTOVEND: TcxDBPivotGridField;
    cxDBPivotGrid1COSTOSTRAORDINARIO: TcxDBPivotGridField;
    cxDBPivotGrid1QTASTRAORDINARIO: TcxDBPivotGridField;
    cxDBPivotGrid1IMPORTOSTRAORDINARIO: TcxDBPivotGridField;
    cxDBPivotGrid1COSTOPERMESSI: TcxDBPivotGridField;
    cxDBPivotGrid1QTAPERMESSI: TcxDBPivotGridField;
    cxDBPivotGrid1IMPORTOPERMESSI: TcxDBPivotGridField;
    cxDBPivotGrid1COSTOFERIE: TcxDBPivotGridField;
    cxDBPivotGrid1QTAFERIE: TcxDBPivotGridField;
    cxDBPivotGrid1IMPORTOFERIE: TcxDBPivotGridField;
    cxDBPivotGrid1COSTOTRASFERTE: TcxDBPivotGridField;
    cxDBPivotGrid1QTATRASFERTE: TcxDBPivotGridField;
    cxDBPivotGrid1IMPORTOTRASFERTE: TcxDBPivotGridField;
    cxDBPivotGrid1OREBASE: TcxDBPivotGridField;
    GosOrePivotOPERAINDEX: TcxDBPivotGridField;
    TabGosGrafDipendenti: TcxTabSheet;
    GridChartOre: TcxGrid;
    ChvOre: TcxGridChartView;
    lvChartOre: TcxGridLevel;
    Panel26: TPanel;
    Shape21: TShape;
    Shape22: TShape;
    GOSTipoDatoOre: TcxRadioGroup;
    GOSSuddivisioneOre: TcxRadioGroup;
    GOSTipoDatoSoggetti: TcxRadioGroup;
    TabSpese: TcxTabSheet;
    PanelGosSpese: TPanel;
    PanelSpeseFiltri: TPanel;
    SubPanelSpeseFiltri: TPanel;
    Label7: TLabel;
    Label89: TLabel;
    GOSSpeseSet: TSpeedButton;
    GOSSpeseOtt: TSpeedButton;
    GOSSpeseNov: TSpeedButton;
    GOSSpeseDic: TSpeedButton;
    GOSSpeseAgo: TSpeedButton;
    GOSSpeseLug: TSpeedButton;
    GOSSpeseGiu: TSpeedButton;
    GOSSpeseMag: TSpeedButton;
    GOSSpeseGen: TSpeedButton;
    GOSSpeseFeb: TSpeedButton;
    GOSSpeseMar: TSpeedButton;
    GOSSpeseApr: TSpeedButton;
    GOSSpeseMesiTutti: TSpeedButton;
    GOSSpeseMesiNessuno: TSpeedButton;
    Label97: TLabel;
    SpeedButtonRollOver16: TSpeedButtonRollOver;
    Label98: TLabel;
    Label99: TLabel;
    SpeedButtonRollOver17: TSpeedButtonRollOver;
    Label100: TLabel;
    SBGosSpeseFilterOpenClose: TSpeedButtonRollOver;
    FilterGosSpeseCodiceDipendente: TEdit;
    FilterGosSpeseDescrizDipendente: TEdit;
    StaticText64: TStaticText;
    FilterGosTipoCosto1: TcxComboBox;
    StaticText65: TStaticText;
    FilterGosTipoCosto2: TcxComboBox;
    StaticText66: TStaticText;
    FilterGosTipoCosto3: TcxComboBox;
    FilterGosSpeseCodiceAutomezzo: TEdit;
    FilterGosSpeseDescrizAutomezzo: TEdit;
    LabelGosSpeseSottocantiere1: TStaticText;
    FilterGosSpeseSottocantiere1: TcxComboBox;
    LabelGosSpeseSottocantiere2: TStaticText;
    FilterGosSpeseSottocantiere2: TcxComboBox;
    LabelGosSpeseSottocantiere3: TStaticText;
    FilterGosSpeseSottocantiere3: TcxComboBox;
    StaticText79: TStaticText;
    FilterGosSpeseSoloRegistro: TcxComboBox;
    StaticText80: TStaticText;
    FilterGosSpeseTranneRegistro: TcxComboBox;
    StaticText85: TStaticText;
    FilterGosSpeseNumDoc: TEdit;
    StaticText86: TStaticText;
    FilterGosSpeseStato: TcxComboBox;
    StaticText88: TStaticText;
    FilterGosSpeseNote: TEdit;
    cxPageControlGOSSpese: TcxPageControl;
    TabGOSSpeseElenco: TcxTabSheet;
    GridSpese: TcxGrid;
    tvSpese: TcxGridDBTableView;
    tvSpeseTIPODOC: TcxGridDBColumn;
    tvSpeseNUMDOC: TcxGridDBColumn;
    tvSpeseREGISTRO: TcxGridDBColumn;
    tvSpeseDATADOC: TcxGridDBColumn;
    tvSpeseAUTOMEZZO: TcxGridDBColumn;
    tvSpeseKM: TcxGridDBColumn;
    tvSpeseDIPENDENTE: TcxGridDBColumn;
    tvSpeseCANTIERE: TcxGridDBColumn;
    tvSpeseSOGGETTO: TcxGridDBColumn;
    tvSpeseIMPORTO: TcxGridDBColumn;
    tvSpeseNOTE: TcxGridDBColumn;
    tvSpeseSOTTOCANTIERE1: TcxGridDBColumn;
    tvSpeseSOTTOCANTIERE2: TcxGridDBColumn;
    tvSpeseSOTTOCANTIERE3: TcxGridDBColumn;
    tvSpeseTIPOCOSTO1: TcxGridDBColumn;
    tvSpeseTIPOCOSTO2: TcxGridDBColumn;
    tvSpeseTIPOCOSTO3: TcxGridDBColumn;
    tvSpeseDOCUMENTO: TcxGridDBColumn;
    tvSpeseNUMRIGO: TcxGridDBColumn;
    tvSpeseSTATODESCRIZIONE: TcxGridDBColumn;
    tvSpeseSTATOFOREGROUND: TcxGridDBColumn;
    tvSpeseSTATOBACKGROUND: TcxGridDBColumn;
    lvSpese: TcxGridLevel;
    TabGosSpeseAda: TcxTabSheet;
    GosSpesePivot: TcxDBPivotGrid;
    cxDBPivotGrid1NUMDOC1: TcxDBPivotGridField;
    cxDBPivotGrid1DATADOC1: TcxDBPivotGridField;
    cxDBPivotGrid1REGISTRO1: TcxDBPivotGridField;
    cxDBPivotGrid1IMPORTO: TcxDBPivotGridField;
    cxDBPivotGrid1NOTE1: TcxDBPivotGridField;
    cxDBPivotGrid1TIPOCOSTO1: TcxDBPivotGridField;
    cxDBPivotGrid1TIPOCOSTO2: TcxDBPivotGridField;
    cxDBPivotGrid1TIPOCOSTO3: TcxDBPivotGridField;
    cxDBPivotGrid1KM: TcxDBPivotGridField;
    cxDBPivotGrid1DOCUMENTO1: TcxDBPivotGridField;
    cxDBPivotGrid1DIPENDENTE1: TcxDBPivotGridField;
    cxDBPivotGrid1CANTIERE1: TcxDBPivotGridField;
    cxDBPivotGrid1SOGGETTO1: TcxDBPivotGridField;
    cxDBPivotGrid1AUTOMEZZO: TcxDBPivotGridField;
    cxDBPivotGrid1NUMRIGO1: TcxDBPivotGridField;
    TabGosGrafSpese: TcxTabSheet;
    GridChartSpese: TcxGrid;
    ChvSpese: TcxGridChartView;
    lvChartSpese: TcxGridLevel;
    Panel32: TPanel;
    Shape24: TShape;
    Shape26: TShape;
    GOSTipoDatoSpese: TcxRadioGroup;
    GOSSuddivisioneSpese: TcxRadioGroup;
    GOSSpeseTipoDatoSoggetti: TcxRadioGroup;
    TabResOrd: TTabSheet;
    PanelResOrd: TPanel;
    TabComunicazioni: TTabSheet;
    PanelComunicazioni: TPanel;
    StaticText11: TStaticText;
    FilterOp1: TcxComboBox;
    StaticText20: TStaticText;
    FilterOp2: TcxComboBox;
    StaticText23: TStaticText;
    FilterOp3: TcxComboBox;
    StaticText27: TStaticText;
    ImpOp1: TcxComboBox;
    StaticText28: TStaticText;
    ImpOp2: TcxComboBox;
    StaticText29: TStaticText;
    ImpOp3: TcxComboBox;
    QryScadTIPOLOGIA: TStringField;
    QrySoggettiEXISTS_SCADSOFF: TStringField;
    tvRubricaEXISTS_SCADSOFF: TcxGridDBColumn;
    QrySoggCantEXIST_SCADSOFF: TStringField;
    tvSoggCantEXIST_SCADSOFF: TcxGridDBColumn;
    QryPraticheEXIST_SCADSOFF: TStringField;
    tvPratEXIST_SCADSOFF: TcxGridDBColumn;
    QryImpEXISTS_STAMPATO: TStringField;
    tvImpegniRESOURCEID: TcxGridDBColumn;
    tvImpegniEXISTS_STAMPATO: TcxGridDBColumn;
    QryArticoliLOTTORIORDINO: TIBOFloatField;
    tvArtLOTTORIORDINO: TcxGridDBColumn;
    QryGOSOreTIPO1: TStringField;
    QryGOSOreTIPO2: TStringField;
    QryGOSOreTIPO3: TStringField;
    QryGOSOreTIPO4: TStringField;
    QryGOSOreTIPO5: TStringField;
    QryGOSOreTIPO6: TStringField;
    QryGOSOreAGENTE: TStringField;
    QryGOSOreAGENTE2: TStringField;
    QryGOSOreAGENTE3: TStringField;
    QryGOSOreAGENTE4: TStringField;
    QryGOSOreCATEGCANT1: TStringField;
    QryGOSOreCATEGCANT2: TStringField;
    QryGOSOreCATEGCANT3: TStringField;
    QryGOSOreCATEGCANT4: TStringField;
    QryGOSOreCATEGCANT5: TStringField;
    QryGOSOreCATEGCANT6: TStringField;
    tvOreTIPO1: TcxGridDBColumn;
    tvOreTIPO2: TcxGridDBColumn;
    tvOreTIPO3: TcxGridDBColumn;
    tvOreTIPO4: TcxGridDBColumn;
    tvOreTIPO5: TcxGridDBColumn;
    tvOreTIPO6: TcxGridDBColumn;
    tvOreAGENTE: TcxGridDBColumn;
    tvOreAGENTE2: TcxGridDBColumn;
    tvOreAGENTE3: TcxGridDBColumn;
    tvOreAGENTE4: TcxGridDBColumn;
    tvOreCATEGCANT1: TcxGridDBColumn;
    tvOreCATEGCANT2: TcxGridDBColumn;
    tvOreCATEGCANT3: TcxGridDBColumn;
    tvOreCATEGCANT4: TcxGridDBColumn;
    tvOreCATEGCANT5: TcxGridDBColumn;
    tvOreCATEGCANT6: TcxGridDBColumn;
    GosOreLabelAgente: TStaticText;
    GosOreAgente: TcxComboBox;
    GosOreLabelAgente2: TStaticText;
    GosOreAgente2: TcxComboBox;
    GosOreLabelAgente3: TStaticText;
    GosOreAgente3: TcxComboBox;
    GosOreLabelAgente4: TStaticText;
    GosOreAgente4: TcxComboBox;
    GosOreLabelTipo1: TStaticText;
    GosOreTipo1: TcxComboBox;
    GosOreLabelTipo2: TStaticText;
    GosOreTipo2: TcxComboBox;
    GosOreLabelTipo3: TStaticText;
    GosOreTipo3: TcxComboBox;
    GosOreLabelTipo4: TStaticText;
    GosOreTipo4: TcxComboBox;
    GosOreLabelTipo5: TStaticText;
    GosOreTipo5: TcxComboBox;
    GosOreLabelTipo6: TStaticText;
    GosOreTipo6: TcxComboBox;
    PanelFilterGosOreCategorieCantieri: TPanel;
    GosOreLabelCategCant1: TStaticText;
    GosOreCategCant1: TcxComboBox;
    GosOreLabelCategCant2: TStaticText;
    GosOreCategCant2: TcxComboBox;
    GosOreLabelCategCant3: TStaticText;
    GosOreCategCant3: TcxComboBox;
    GosOreLabelCategCant4: TStaticText;
    GosOreCategCant4: TcxComboBox;
    GosOreLabelCategCant5: TStaticText;
    GosOreCategCant5: TcxComboBox;
    GosOreLabelCategCant6: TStaticText;
    GosOreCategCant6: TcxComboBox;
    QryGOSSpeseTIPO1: TStringField;
    QryGOSSpeseTIPO2: TStringField;
    QryGOSSpeseTIPO3: TStringField;
    QryGOSSpeseTIPO4: TStringField;
    QryGOSSpeseTIPO5: TStringField;
    QryGOSSpeseTIPO6: TStringField;
    QryGOSSpeseAGENTE: TStringField;
    QryGOSSpeseAGENTE2: TStringField;
    QryGOSSpeseAGENTE3: TStringField;
    QryGOSSpeseAGENTE4: TStringField;
    QryGOSSpeseCATEGCANT1: TStringField;
    QryGOSSpeseCATEGCANT2: TStringField;
    QryGOSSpeseCATEGCANT3: TStringField;
    QryGOSSpeseCATEGCANT4: TStringField;
    QryGOSSpeseCATEGCANT5: TStringField;
    QryGOSSpeseCATEGCANT6: TStringField;
    tvSpeseTIPO1: TcxGridDBColumn;
    tvSpeseTIPO2: TcxGridDBColumn;
    tvSpeseTIPO3: TcxGridDBColumn;
    tvSpeseTIPO4: TcxGridDBColumn;
    tvSpeseTIPO5: TcxGridDBColumn;
    tvSpeseTIPO6: TcxGridDBColumn;
    tvSpeseAGENTE: TcxGridDBColumn;
    tvSpeseAGENTE2: TcxGridDBColumn;
    tvSpeseAGENTE3: TcxGridDBColumn;
    tvSpeseAGENTE4: TcxGridDBColumn;
    tvSpeseCATEGCANT1: TcxGridDBColumn;
    tvSpeseCATEGCANT2: TcxGridDBColumn;
    tvSpeseCATEGCANT3: TcxGridDBColumn;
    tvSpeseCATEGCANT4: TcxGridDBColumn;
    tvSpeseCATEGCANT5: TcxGridDBColumn;
    tvSpeseCATEGCANT6: TcxGridDBColumn;
    GosSpeseLabelAgente: TStaticText;
    GosSpeseAgente: TcxComboBox;
    GosSpeseLabelAgente2: TStaticText;
    GosSpeseAgente2: TcxComboBox;
    GosSpeseLabelAgente3: TStaticText;
    GosSpeseAgente3: TcxComboBox;
    GosSpeseLabelAgente4: TStaticText;
    GosSpeseAgente4: TcxComboBox;
    GosSpeseLabelTipo1: TStaticText;
    GosSpeseTipo1: TcxComboBox;
    GosSpeseLabelTipo2: TStaticText;
    GosSpeseTipo2: TcxComboBox;
    GosSpeseLabelTipo3: TStaticText;
    GosSpeseTipo3: TcxComboBox;
    GosSpeseLabelTipo4: TStaticText;
    GosSpeseTipo4: TcxComboBox;
    GosSpeseLabelTipo5: TStaticText;
    GosSpeseTipo5: TcxComboBox;
    GosSpeseLabelTipo6: TStaticText;
    GosSpeseTipo6: TcxComboBox;
    PanelFilterGosSpeseCategorieCantieri: TPanel;
    GosSpeseLabelCategCant1: TStaticText;
    GosSpeseCategCant1: TcxComboBox;
    GosSpeseLabelCategCant2: TStaticText;
    GosSpeseCategCant2: TcxComboBox;
    GosSpeseLabelCategCant3: TStaticText;
    GosSpeseCategCant3: TcxComboBox;
    GosSpeseLabelCategCant4: TStaticText;
    GosSpeseCategCant4: TcxComboBox;
    GosSpeseLabelCategCant5: TStaticText;
    GosSpeseCategCant5: TcxComboBox;
    GosSpeseLabelCategCant6: TStaticText;
    GosSpeseCategCant6: TcxComboBox;
    DateEditDa: TcxDateEdit;
    DateEditA: TcxDateEdit;
    GMDal: TcxDateEdit;
    GMAl: TcxDateEdit;
    PratDal: TcxDateEdit;
    PratAl: TcxDateEdit;
    ScadDal: TcxDateEdit;
    ScadAl: TcxDateEdit;
    PrmDal: TcxDateEdit;
    PrmAl: TcxDateEdit;
    EditArtDataMagazzino: TcxDateEdit;
    ImpDal: TcxDateEdit;
    ImpAl: TcxDateEdit;
    GOSDal: TcxDateEdit;
    GOSAl: TcxDateEdit;
    GOSSpeseDal: TcxDateEdit;
    GOSSpeseAl: TcxDateEdit;
    TipoSoggetto: TcxComboBox;
    GMTipoSoggetto: TcxComboBox;
    ScadDataDoc: TcxDateEdit;
    PrmBanca: TcxComboBox;
    SourceTotScad: TDataSource;
    QryTotScad: TIBOQuery;
    QryTotScadTOTIMPORTOPAGATO: TIBOFloatField;
    QryTotScadTOTRITACC: TIBOFloatField;
    QryTotScadDARE: TIBOFloatField;
    QryTotScadAVERE: TIBOFloatField;
    tvPratNOTE: TcxGridDBColumn;
    QryPraticheNOTE: TStringField;
    RxSpeedButtonUscita: TSpeedButton;
    RxSpeedButtonHelp: TSpeedButton;
    RxSpeedModifica: TSpeedButton;
    RxSpeedButtonNuovo: TSpeedButton;
    RxSpeedButtonElimina: TSpeedButton;
    RxSpeedButtonTrova: TSpeedButton;
    RxSpeedButtonResetQuery: TSpeedButton;
    RxSpeedButtonStampa: TSpeedButton;
    RxSpeedButtonFax: TSpeedButton;
    RxSpeedButtonMail: TSpeedButton;
    RxSpeedButtonVisualizza: TSpeedButton;
    SpeedButton11: TSpeedButton;
    SpeedButton12: TSpeedButton;
    PanelFilterDocSubSogg: TPanel;
    DocLabelSubSogg1: TStaticText;
    DocSubSogg1: TcxComboBox;
    DocLabelSubSogg2: TStaticText;
    DocSubSogg2: TcxComboBox;
    DocLabelSubSogg3: TStaticText;
    DocSubSogg3: TcxComboBox;
    PanelFilterClientiSubSogg: TPanel;
    LabelFilterSubSogg1: TStaticText;
    EditClientiSubSogg1: TcxComboBox;
    LabelFilterSubSogg2: TStaticText;
    EditClientiSubSogg2: TcxComboBox;
    LabelFilterSubSogg3: TStaticText;
    EditClientiSubSogg3: TcxComboBox;
    LabelFilterSubSogg4: TStaticText;
    LabelFilterSubSogg4Dal: TStaticText;
    EditClientiSubSogg4Dal: TcxDateEdit;
    EditClientiSubSogg4Al: TcxDateEdit;
    DocLabelSubSogg4: TStaticText;
    DocLabelSubSogg4Dal: TStaticText;
    DocSubSogg4Dal: TcxDateEdit;
    DocSubSogg4Al: TcxDateEdit;
    QryDocSUBSOGGCAMPO1: TStringField;
    QryDocSUBSOGGCAMPO2: TStringField;
    QryDocSUBSOGGCAMPO3: TStringField;
    QryDocSUBSOGGCAMPO4: TDateTimeField;
    QryDocOPERATOREULTMOD_ULTMOD: TStringField;
    QryDocDATAORAULTMOD_CREAZIONE: TDateTimeField;
    QryDocDATAORAULTMOD_ULTMOD: TDateTimeField;
    Apriildocumentorelativoallascadenza1: TMenuItem;
    QryScadPRESENTATABANCA: TStringField;
    StaticText32: TStaticText;
    ScadPresentataBanca: TcxComboBox;
    Annullapresentazioneallincassodellescadenzaselezionate1: TMenuItem;
    QrySoggettiABI: TStringField;
    QrySoggettiCAB: TStringField;
    QrySoggettiBANCA: TStringField;
    tvRubricaABI: TcxGridDBColumn;
    tvRubricaCAB: TcxGridDBColumn;
    tvRubricaBANCA: TcxGridDBColumn;
    Duplicacantiere1: TMenuItem;
    N1volta1: TMenuItem;
    N2volte1: TMenuItem;
    N3volte1: TMenuItem;
    N4volte1: TMenuItem;
    N5volte1: TMenuItem;
    N6volte1: TMenuItem;
    N7volte1: TMenuItem;
    N8volte1: TMenuItem;
    N9volte1: TMenuItem;
    N10volte1: TMenuItem;
    N11volte1: TMenuItem;
    QryPraticheJOLLY1: TStringField;
    QryPraticheJOLLY2: TStringField;
    QryPraticheJOLLY3: TStringField;
    QryPraticheJOLLY4: TStringField;
    QryPraticheJOLLY5: TStringField;
    QryPraticheJOLLY6: TStringField;
    QryPraticheJOLLY7: TStringField;
    QryPraticheJOLLY8: TStringField;
    QryPraticheJOLLY9: TStringField;
    QryPraticheJOLLY10: TStringField;
    QryPraticheJOLLY11: TDateTimeField;
    QryPraticheJOLLY12: TDateTimeField;
    QryPraticheJOLLY13: TDateTimeField;
    tvPratJOLLY1: TcxGridDBColumn;
    tvPratJOLLY2: TcxGridDBColumn;
    tvPratJOLLY3: TcxGridDBColumn;
    tvPratJOLLY4: TcxGridDBColumn;
    tvPratJOLLY5: TcxGridDBColumn;
    tvPratJOLLY6: TcxGridDBColumn;
    tvPratJOLLY7: TcxGridDBColumn;
    tvPratJOLLY8: TcxGridDBColumn;
    tvPratJOLLY9: TcxGridDBColumn;
    tvPratJOLLY10: TcxGridDBColumn;
    tvPratJOLLY11: TcxGridDBColumn;
    tvPratJOLLY12: TcxGridDBColumn;
    tvPratJOLLY13: TcxGridDBColumn;
    QryDocPROTOCOLLO_DATA: TDateTimeField;
    QryArticoliCATEGORIA1: TStringField;
    QryArticoliCATEGORIA2: TStringField;
    QryArticoliCATEGORIA3: TStringField;
    tvArtCATEGORIA1: TcxGridDBColumn;
    tvArtCATEGORIA2: TcxGridDBColumn;
    tvArtCATEGORIA3: TcxGridDBColumn;
    PanelCategorieArticoli: TPanel;
    LabelArtCategoria1: TStaticText;
    editArtCategoria1: TcxComboBox;
    LabelArtCategoria2: TStaticText;
    editArtCategoria2: TcxComboBox;
    LabelArtCategoria3: TStaticText;
    editArtCategoria3: TcxComboBox;
    QryDocRIFDOC_TIPO: TStringField;
    QryDocRIFDOC_NUM: TIntegerField;
    QryDocRIFDOC_REG: TStringField;
    QryDocRIFDOC_DATA: TDateTimeField;
    QryDocPARTITAIVA: TStringField;
    QryDocCODICEFISCALE: TStringField;
    tvPrimanotaEXPORTED: TcxGridDBColumn;
    QueryPrimanotaEXPORTED: TStringField;
    PageControlGM: TcxPageControl;
    TabGMGrid: TcxTabSheet;
    TabGMADA: TcxTabSheet;
    PivotGridGM: TcxDBPivotGrid;
    PanelTotaliGM: TPanel;
    Label8: TLabel;
    QtaTot: TLabel;
    Label10: TLabel;
    Shape11: TShape;
    GMTotPrezzoMedio: TDBText;
    GMTotQta: TDBText;
    GMTotImporti: TDBText;
    Label46: TLabel;
    GMTotImportiIVACompresa: TDBText;
    GridGM: TcxGrid;
    tvGM: TcxGridDBTableView;
    tvGMCODICEMAGAZZINO: TcxGridDBColumn;
    tvGMCODICEMAGAZZINO2: TcxGridDBColumn;
    tvGMMOVMAG: TcxGridDBColumn;
    tvGMSEGNOOPERAZIONE: TcxGridDBColumn;
    tvGMSEGNOOPERAZIONECANTIERE: TcxGridDBColumn;
    tvGMCODICEARTICOLO: TcxGridDBColumn;
    tvGMCODICEARTICOLOSTM: TcxGridDBColumn;
    tvGMDESCRIZIONE: TcxGridDBColumn;
    tvGMPREZZOUNITARIO: TcxGridDBColumn;
    tvGMUNITADIMISURA: TcxGridDBColumn;
    tvGMQTA: TcxGridDBColumn;
    tvGMSCONTORIGO: TcxGridDBColumn;
    tvGMSCONTORIGO2: TcxGridDBColumn;
    tvGMSCONTORIGO3: TcxGridDBColumn;
    tvGMIMPORTORIGO: TcxGridDBColumn;
    tvGMDOCUMENTO: TcxGridDBColumn;
    tvGMSOGGETTO: TcxGridDBColumn;
    tvGMSOTTOCANTIERE1: TcxGridDBColumn;
    tvGMSOTTOCANTIERE2: TcxGridDBColumn;
    tvGMSOTTOCANTIERE3: TcxGridDBColumn;
    tvGMGRUPPO1: TcxGridDBColumn;
    tvGMGRUPPO2: TcxGridDBColumn;
    tvGMGRUPPO3: TcxGridDBColumn;
    tvGMGRUPPO4: TcxGridDBColumn;
    tvGMGRUPPO5: TcxGridDBColumn;
    tvGMGRUPPO6: TcxGridDBColumn;
    tvGMTIPODOCUMENTO: TcxGridDBColumn;
    tvGMNUMORDPREV: TcxGridDBColumn;
    tvGMREGISTRO: TcxGridDBColumn;
    tvGMDATADOCUMENTO: TcxGridDBColumn;
    tvGMPRATICA: TcxGridDBColumn;
    tvGMPROGRIGO: TcxGridDBColumn;
    tvGMPREZZOUNITARIOIVACOMPRESA: TcxGridDBColumn;
    tvGMDBIMPORTORIGOIVACOMPRESA: TcxGridDBColumn;
    tvGMSTATODESCRIZIONE: TcxGridDBColumn;
    tvGMPREZZOUNITARIONETTO: TcxGridDBColumn;
    tvGMTIPO1: TcxGridDBColumn;
    tvGMTIPO2: TcxGridDBColumn;
    tvGMTIPO3: TcxGridDBColumn;
    tvGMTIPO4: TcxGridDBColumn;
    tvGMTIPO5: TcxGridDBColumn;
    tvGMTIPO6: TcxGridDBColumn;
    tvGMAGENTE: TcxGridDBColumn;
    tvGMAGENTE2: TcxGridDBColumn;
    tvGMAGENTE3: TcxGridDBColumn;
    tvGMAGENTE4: TcxGridDBColumn;
    tvGMTIPOSOGGETTO: TcxGridDBColumn;
    tvGMDESCPAGAM: TcxGridDBColumn;
    tvGMCATEGCANT1: TcxGridDBColumn;
    tvGMCATEGCANT2: TcxGridDBColumn;
    tvGMCATEGCANT3: TcxGridDBColumn;
    tvGMCATEGCANT4: TcxGridDBColumn;
    tvGMCATEGCANT5: TcxGridDBColumn;
    tvGMCATEGCANT6: TcxGridDBColumn;
    tvGMRIFMAGA1: TcxGridDBColumn;
    tvGMRIFMAGA2: TcxGridDBColumn;
    tvGMDATAPRATICA1: TcxGridDBColumn;
    tvGMCAUSALE: TcxGridDBColumn;
    lvGM: TcxGridLevel;
    PivotGridGMCODICEMAGAZZINO: TcxDBPivotGridField;
    PivotGridGMCODICEMAGAZZINO2: TcxDBPivotGridField;
    PivotGridGMRIFMAGA1: TcxDBPivotGridField;
    PivotGridGMRIFMAGA2: TcxDBPivotGridField;
    PivotGridGMCODICEARTICOLO: TcxDBPivotGridField;
    PivotGridGMCODICEARTICOLOSTM: TcxDBPivotGridField;
    PivotGridGMDESCRIZIONE: TcxDBPivotGridField;
    PivotGridGMPREZZOUNITARIO: TcxDBPivotGridField;
    PivotGridGMUNITADIMISURA: TcxDBPivotGridField;
    PivotGridGMQTA: TcxDBPivotGridField;
    PivotGridGMSCONTORIGO: TcxDBPivotGridField;
    PivotGridGMSCONTORIGO2: TcxDBPivotGridField;
    PivotGridGMSCONTORIGO3: TcxDBPivotGridField;
    PivotGridGMIMPORTORIGO: TcxDBPivotGridField;
    PivotGridGMSTATODESCRIZIONE: TcxDBPivotGridField;
    PivotGridGMDOCUMENTO: TcxDBPivotGridField;
    PivotGridGMSOGGETTO: TcxDBPivotGridField;
    PivotGridGMGRUPPO1: TcxDBPivotGridField;
    PivotGridGMGRUPPO2: TcxDBPivotGridField;
    PivotGridGMGRUPPO3: TcxDBPivotGridField;
    PivotGridGMGRUPPO4: TcxDBPivotGridField;
    PivotGridGMGRUPPO5: TcxDBPivotGridField;
    PivotGridGMGRUPPO6: TcxDBPivotGridField;
    PivotGridGMTIPODOCUMENTO: TcxDBPivotGridField;
    PivotGridGMNUMORDPREV: TcxDBPivotGridField;
    PivotGridGMREGISTRO: TcxDBPivotGridField;
    PivotGridGMDATADOCUMENTO: TcxDBPivotGridField;
    PivotGridGMRAGSOCCLI: TcxDBPivotGridField;
    PivotGridGMPROGRIGO: TcxDBPivotGridField;
    PivotGridGMPREZZOUNITARIOIVACOMPRESA: TcxDBPivotGridField;
    PivotGridGMIMPORTORIGOIVACOMPRESA: TcxDBPivotGridField;
    PivotGridGMPRATICA: TcxDBPivotGridField;
    PivotGridGMDATAPRATICA1: TcxDBPivotGridField;
    PivotGridGMPREZZOUNITARIONETTO: TcxDBPivotGridField;
    PivotGridGMSEGNOOPERAZIONE: TcxDBPivotGridField;
    PivotGridGMTIPO1: TcxDBPivotGridField;
    PivotGridGMTIPO2: TcxDBPivotGridField;
    PivotGridGMTIPO3: TcxDBPivotGridField;
    PivotGridGMTIPO4: TcxDBPivotGridField;
    PivotGridGMTIPO5: TcxDBPivotGridField;
    PivotGridGMTIPO6: TcxDBPivotGridField;
    PivotGridGMAGENTE: TcxDBPivotGridField;
    PivotGridGMSEGNOOPERAZIONECANTIERE: TcxDBPivotGridField;
    PivotGridGMSOTTOCANTIERE1: TcxDBPivotGridField;
    PivotGridGMSOTTOCANTIERE2: TcxDBPivotGridField;
    PivotGridGMSOTTOCANTIERE3: TcxDBPivotGridField;
    PivotGridGMTIPOSOGGETTO: TcxDBPivotGridField;
    PivotGridGMDESCPAGAM: TcxDBPivotGridField;
    PivotGridGMAGENTE2: TcxDBPivotGridField;
    PivotGridGMAGENTE3: TcxDBPivotGridField;
    PivotGridGMAGENTE4: TcxDBPivotGridField;
    PivotGridGMCATEGCANT1: TcxDBPivotGridField;
    PivotGridGMCATEGCANT2: TcxDBPivotGridField;
    PivotGridGMCATEGCANT3: TcxDBPivotGridField;
    PivotGridGMCATEGCANT4: TcxDBPivotGridField;
    PivotGridGMCATEGCANT5: TcxDBPivotGridField;
    PivotGridGMCATEGCANT6: TcxDBPivotGridField;
    PivotGridGMCAUSALE: TcxDBPivotGridField;
    Panel1: TPanel;
    SpeedButton17: TSpeedButton;
    SpeedButton18: TSpeedButton;
    SpeedButton19: TSpeedButton;
    PanelGMADATop: TPanel;
    Panel6: TPanel;
    SpeedButton20: TSpeedButton;
    SpeedButton23: TSpeedButton;
    PivotGMLink: TcxPivotGridReportLink;
    N20: TMenuItem;
    StampaADAgiornaledimagazzino1: TMenuItem;
    PageControlDoc: TcxPageControl;
    TabSheetDocGrid: TcxTabSheet;
    PanelExpandCollapseDoc: TPanel;
    SpeedButton24: TSpeedButton;
    SpeedButton25: TSpeedButton;
    SpeedButtonFilters: TSpeedButton;
    TabSheetDocADA: TcxTabSheet;
    PivotGridDoc: TcxDBPivotGrid;
    Panel11: TPanel;
    Panel15: TPanel;
    SpeedButton27: TSpeedButton;
    SpeedButton28: TSpeedButton;
    GridDoc: TcxGrid;
    tvDoc: TcxGridDBTableView;
    tvDocSELEZIONATO: TcxGridDBColumn;
    tvDocRIFDOC_CORRISPNOPAG: TcxGridDBColumn;
    tvDocTIPODOC: TcxGridDBColumn;
    tvDocCODICEDOC: TcxGridDBColumn;
    tvDocREGISTRO: TcxGridDBColumn;
    tvDocDATADOC: TcxGridDBColumn;
    tvDocORADOC: TcxGridDBColumn;
    tvDocOGGETTO: TcxGridDBColumn;
    tvDocCLIENTEFORNITORE: TcxGridDBColumn;
    tvDocRIFPRATICA: TcxGridDBColumn;
    tvDocSTATODESCRIZIONE: TcxGridDBColumn;
    tvDocIMPONIBILE: TcxGridDBColumn;
    tvDocIMPORTOIVA: TcxGridDBColumn;
    tvDocSTATOFOREGROUND: TcxGridDBColumn;
    tvDocIMPORTO: TcxGridDBColumn;
    tvDocSTATOBACKGROUND: TcxGridDBColumn;
    tvDocDAFATTURARE: TcxGridDBColumn;
    tvDocCONSEGNADATA: TcxGridDBColumn;
    tvDocCONSEGNATO: TcxGridDBColumn;
    tvDocVALIDITADATA: TcxGridDBColumn;
    tvDocAZIONEMAGAZZINO: TcxGridDBColumn;
    tvDocAZIONECANTIERE: TcxGridDBColumn;
    tvDocCAUSALE: TcxGridDBColumn;
    tvDocCAUSALECANTIERE: TcxGridDBColumn;
    tvDocTIPOSOGGETTO: TcxGridDBColumn;
    tvDocRITACC: TcxGridDBColumn;
    tvDocIMPORTONETTORITACC: TcxGridDBColumn;
    tvDocOPERATORE: TcxGridDBColumn;
    tvDocAGENTE: TcxGridDBColumn;
    tvDocAGENTE2: TcxGridDBColumn;
    tvDocAGENTE3: TcxGridDBColumn;
    tvDocAGENTE4: TcxGridDBColumn;
    tvDocNOTE: TcxGridDBColumn;
    tvDocEXPORTED: TcxGridDBColumn;
    tvDocPROTOCOLLO: TcxGridDBColumn;
    tvDocPROTOCOLLO_DATA: TcxGridDBColumn;
    tvDocCATEGCANT1: TcxGridDBColumn;
    tvDocCATEGCANT2: TcxGridDBColumn;
    tvDocCATEGCANT3: TcxGridDBColumn;
    tvDocCATEGCANT4: TcxGridDBColumn;
    tvDocCATEGCANT5: TcxGridDBColumn;
    tvDocCATEGCANT6: TcxGridDBColumn;
    tvDocSUBSOGGCAMPO1: TcxGridDBColumn;
    tvDocSUBSOGGCAMPO2: TcxGridDBColumn;
    tvDocSUBSOGGCAMPO3: TcxGridDBColumn;
    tvDocSUBSOGGCAMPO4: TcxGridDBColumn;
    tvDocOPERATOREULTMOD_ULTMOD: TcxGridDBColumn;
    tvDocDATAORAULTMOD_ULTMOD: TcxGridDBColumn;
    tvDocDATAORAULTMOD_CREAZIONE: TcxGridDBColumn;
    tvDocRIFDOC_TIPO: TcxGridDBColumn;
    tvDocRIFDOC_NUM: TcxGridDBColumn;
    tvDocRIFDOC_REG: TcxGridDBColumn;
    tvDocRIFDOC_DATA: TcxGridDBColumn;
    tvDocPARTITAIVA: TcxGridDBColumn;
    tvDocCODICEFISCALE: TcxGridDBColumn;
    tvAltriDoc: TcxGridDBTableView;
    tvAltriDocTIPODOC: TcxGridDBColumn;
    tvAltriDocCODICEDOC: TcxGridDBColumn;
    tvAltriDocREGISTRO: TcxGridDBColumn;
    tvAltriDocDATADOC: TcxGridDBColumn;
    tvAltriDocORADOC: TcxGridDBColumn;
    tvAltriDocOGGETTO: TcxGridDBColumn;
    tvAltriDocSTATODESCRIZIONE: TcxGridDBColumn;
    tvAltriDocCLIENTEFORNITORE: TcxGridDBColumn;
    tvAltriDocRIFPRATICA: TcxGridDBColumn;
    tvAltriDocSTATOFOREGROUND: TcxGridDBColumn;
    tvAltriDocSTATOBACKGROUND: TcxGridDBColumn;
    tvAltriDocTIPOSOGGETTO: TcxGridDBColumn;
    lvDoc: TcxGridLevel;
    lvAltriDoc: TcxGridLevel;
    PivotGridDocTIPODOC: TcxDBPivotGridField;
    PivotGridDocREGISTRO: TcxDBPivotGridField;
    PivotGridDocCODICEDOC: TcxDBPivotGridField;
    PivotGridDocDATADOC: TcxDBPivotGridField;
    PivotGridDocOGGETTOJOLLY1: TcxDBPivotGridField;
    PivotGridDocOGGETTOJOLLY2: TcxDBPivotGridField;
    PivotGridDocOGGETTOJOLLY3: TcxDBPivotGridField;
    PivotGridDocIMPORTO: TcxDBPivotGridField;
    PivotGridDocNOTEJOLLY1: TcxDBPivotGridField;
    PivotGridDocNOTEJOLLY2: TcxDBPivotGridField;
    PivotGridDocCLIENTEFORNITORE: TcxDBPivotGridField;
    PivotGridDocOGGETTO: TcxDBPivotGridField;
    PivotGridDocNOTE: TcxDBPivotGridField;
    PivotGridDocSTATODESCRIZIONE: TcxDBPivotGridField;
    PivotGridDocSTATOFOREGROUND: TcxDBPivotGridField;
    PivotGridDocSTATOBACKGROUND: TcxDBPivotGridField;
    PivotGridDocSELEZIONATO: TcxDBPivotGridField;
    PivotGridDocPROVENIENZA: TcxDBPivotGridField;
    PivotGridDocIMPONIBILE: TcxDBPivotGridField;
    PivotGridDocIMPORTOIVA: TcxDBPivotGridField;
    PivotGridDocCODICESOGGETTO: TcxDBPivotGridField;
    PivotGridDocORADOC: TcxDBPivotGridField;
    PivotGridDocDAFATTURARE: TcxDBPivotGridField;
    PivotGridDocRIFPRATICA: TcxDBPivotGridField;
    PivotGridDocVALIDITADATA: TcxDBPivotGridField;
    PivotGridDocCONSEGNADATA: TcxDBPivotGridField;
    PivotGridDocCONSEGNATO: TcxDBPivotGridField;
    PivotGridDocCAUSALE: TcxDBPivotGridField;
    PivotGridDocCAUSALECANTIERE: TcxDBPivotGridField;
    PivotGridDocRITENUTAACCONTO: TcxDBPivotGridField;
    PivotGridDocTIPOSOGGETTO: TcxDBPivotGridField;
    PivotGridDocOPERATORE: TcxDBPivotGridField;
    PivotGridDocIMPORTONETTORITACC: TcxDBPivotGridField;
    PivotGridDocAGENTE: TcxDBPivotGridField;
    PivotGridDocAZIONECANTIERE: TcxDBPivotGridField;
    PivotGridDocAZIONEMAGAZZINO: TcxDBPivotGridField;
    PivotGridDocEXPORTED: TcxDBPivotGridField;
    PivotGridDocPROTOCOLLO: TcxDBPivotGridField;
    PivotGridDocPROTOCOLLO_DATA: TcxDBPivotGridField;
    PivotGridDocAGENTE2: TcxDBPivotGridField;
    PivotGridDocAGENTE3: TcxDBPivotGridField;
    PivotGridDocAGENTE4: TcxDBPivotGridField;
    PivotGridDocCATEGCANT1: TcxDBPivotGridField;
    PivotGridDocCATEGCANT2: TcxDBPivotGridField;
    PivotGridDocCATEGCANT3: TcxDBPivotGridField;
    PivotGridDocCATEGCANT4: TcxDBPivotGridField;
    PivotGridDocCATEGCANT5: TcxDBPivotGridField;
    PivotGridDocCATEGCANT6: TcxDBPivotGridField;
    PivotGridDocEXISTS_CORRISPNOPAG: TcxDBPivotGridField;
    PivotGridDocSUBSOGGCAMPO1: TcxDBPivotGridField;
    PivotGridDocSUBSOGGCAMPO2: TcxDBPivotGridField;
    PivotGridDocSUBSOGGCAMPO3: TcxDBPivotGridField;
    PivotGridDocSUBSOGGCAMPO4: TcxDBPivotGridField;
    PivotGridDocOPERATOREULTMOD_ULTMOD: TcxDBPivotGridField;
    PivotGridDocDATAORAULTMOD_CREAZIONE: TcxDBPivotGridField;
    PivotGridDocDATAORAULTMOD_ULTMOD: TcxDBPivotGridField;
    PivotGridDocRIFDOC_TIPO: TcxDBPivotGridField;
    PivotGridDocRIFDOC_NUM: TcxDBPivotGridField;
    PivotGridDocRIFDOC_REG: TcxDBPivotGridField;
    PivotGridDocRIFDOC_DATA: TcxDBPivotGridField;
    PivotGridDocPARTITAIVA: TcxDBPivotGridField;
    PivotGridDocCODICEFISCALE: TcxDBPivotGridField;
    PivotDocLink: TcxPivotGridReportLink;
    StampaADADocumenti: TMenuItem;
    Stampagraficocantiere1: TMenuItem;
    N21: TMenuItem;
    QryScadPAGATO: TStringField;
    PageControlScad: TcxPageControl;
    TabScadElenco: TcxTabSheet;
    TabGCAda: TcxTabSheet;
    PivotGridGC: TcxDBPivotGrid;
    cxDBPivotGrid1CODICEARTICOLO: TcxDBPivotGridField;
    cxDBPivotGrid1DESCRIZIONE: TcxDBPivotGridField;
    cxDBPivotGrid1UNITADIMISURA: TcxDBPivotGridField;
    cxDBPivotGrid1SOTTOCANTIERE1: TcxDBPivotGridField;
    cxDBPivotGrid1SOTTOCANTIERE2: TcxDBPivotGridField;
    cxDBPivotGrid1SOTTOCANTIERE3: TcxDBPivotGridField;
    cxDBPivotGrid1SOTTOCANTIERE4: TcxDBPivotGridField;
    cxDBPivotGrid1SOTTOCANTIERE5: TcxDBPivotGridField;
    cxDBPivotGrid1SOTTOCANTIERE6: TcxDBPivotGridField;
    cxDBPivotGrid1QTA1: TcxDBPivotGridField;
    cxDBPivotGrid1SEGNOOPERAZIONECANTIERE: TcxDBPivotGridField;
    cxDBPivotGrid1IMPORTORIGO: TcxDBPivotGridField;
    cxDBPivotGrid1IMPORTORIGOIVACOMPRESA: TcxDBPivotGridField;
    cxDBPivotGrid1QTADISPONIBILE: TcxDBPivotGridField;
    TabScadCharts: TcxTabSheet;
    GridScad: TcxGrid;
    tvScad: TcxGridDBTableView;
    tvScadCODICE: TcxGridDBColumn;
    tvScadDATASCADENZA: TcxGridDBColumn;
    tvScadDARE: TcxGridDBColumn;
    tvScadAVERE: TcxGridDBColumn;
    tvScadRICEVUTABANCARIA: TcxGridDBColumn;
    tvScadPRESENTATA: TcxGridDBColumn;
    tvScadINSOLUTO: TcxGridDBColumn;
    tvScadDOCUMENTO: TcxGridDBColumn;
    tvScadSOGGETTO: TcxGridDBColumn;
    tvScadRIFPRATICA: TcxGridDBColumn;
    tvScadTIPO: TcxGridDBColumn;
    tvScadBANCA: TcxGridDBColumn;
    tvScadABI: TcxGridDBColumn;
    tvScadCAB: TcxGridDBColumn;
    tvScadRAGIONESOCIALE: TcxGridDBColumn;
    tvScadINDIRIZZO: TcxGridDBColumn;
    tvScadCAP: TcxGridDBColumn;
    tvScadCITTA: TcxGridDBColumn;
    tvScadPROVINCIA: TcxGridDBColumn;
    tvScadPARTITAIVA: TcxGridDBColumn;
    tvScadRESIDUO: TcxGridDBColumn;
    tvScadIMPORTO: TcxGridDBColumn;
    tvScadIMPORTOPAGATO: TcxGridDBColumn;
    tvScadCLIENTE: TcxGridDBColumn;
    tvScadPRATICA: TcxGridDBColumn;
    tvScadDATAPRATICA1: TcxGridDBColumn;
    tvScadTIPODOC: TcxGridDBColumn;
    tvScadNUMDOC: TcxGridDBColumn;
    tvScadREGISTRO: TcxGridDBColumn;
    tvScadDATADOC: TcxGridDBColumn;
    tvScadNOTE: TcxGridDBColumn;
    tvScadAGENTE: TcxGridDBColumn;
    tvScadAGENTE2: TcxGridDBColumn;
    tvScadAGENTE3: TcxGridDBColumn;
    tvScadAGENTE4: TcxGridDBColumn;
    tvScadSTATODESCRIZIONE: TcxGridDBColumn;
    tvScadDATAPAGAMENTO: TcxGridDBColumn;
    tvScadRITACC: TcxGridDBColumn;
    tvScadRITACCPERC: TcxGridDBColumn;
    tvScadTOTALEIMPONIBILE: TcxGridDBColumn;
    tvScadTIPOLOGIA: TcxGridDBColumn;
    tvScadPRESENTATABANCA: TcxGridDBColumn;
    tvScadPAGATO: TcxGridDBColumn;
    lvScad: TcxGridLevel;
    Panel4: TPanel;
    Label41: TLabel;
    Label42: TLabel;
    Label43: TLabel;
    Label44: TLabel;
    Shape13: TShape;
    Label81: TLabel;
    TotNumScad: TLabel;
    LabelTotPagato: TLabel;
    LabelScadTotRitAcc: TLabel;
    Saldo: TcxCurrencyEdit;
    DbeTotPagato: TcxCurrencyEdit;
    dbeScadTotRitAcc: TcxCurrencyEdit;
    cxDBCurrencyEdit5: TcxDBCurrencyEdit;
    cxDBCurrencyEdit6: TcxDBCurrencyEdit;
    QryScadCHART_DESCRIZIONE: TStringField;
    tvScadCHART_DESCRIZIONE: TcxGridDBColumn;
    Stampagraficoscadenze1: TMenuItem;
    QryDocTRIMESTRE: TStringField;
    QryDocSEMESTRE: TStringField;
    QryDocANNO: TWordField;
    tvDocTRIMESTRE: TcxGridDBColumn;
    tvDocSEMESTRE: TcxGridDBColumn;
    tvDocANNO: TcxGridDBColumn;
    PivotGridDocTRIMESTRE: TcxDBPivotGridField;
    PivotGridDocSEMESTRE: TcxDBPivotGridField;
    PivotGridDocANNO: TcxDBPivotGridField;
    QryGMTRIMESTRE: TStringField;
    QryGMSEMESTRE: TStringField;
    QryGMANNO: TWordField;
    tvGMTRIMESTRE: TcxGridDBColumn;
    tvGMSEMESTRE: TcxGridDBColumn;
    tvGMANNO: TcxGridDBColumn;
    PivotGridGMTRIMESTRE: TcxDBPivotGridField;
    PivotGridGMSEMESTRE: TcxDBPivotGridField;
    PivotGridGMANNO: TcxDBPivotGridField;
    QryGOSOreTRIMESTRE: TStringField;
    QryGOSOreSEMESTRE: TStringField;
    QryGOSOreANNO: TWordField;
    QryGOSSpeseTRIMESTRE: TStringField;
    QryGOSSpeseSEMESTRE: TStringField;
    QryGOSSpeseANNO: TWordField;
    tvOreTRIMESTRE: TcxGridDBColumn;
    tvOreSEMESTRE: TcxGridDBColumn;
    tvOreANNO: TcxGridDBColumn;
    tvSpeseTRIMESTRE: TcxGridDBColumn;
    tvSpeseSEMESTRE: TcxGridDBColumn;
    tvSpeseANNO: TcxGridDBColumn;
    GosOrePivotTRIMESTRE: TcxDBPivotGridField;
    GosOrePivotSEMESTRE: TcxDBPivotGridField;
    GosOrePivotANNO: TcxDBPivotGridField;
    GosSpesePivotTRIMESTRE: TcxDBPivotGridField;
    GosSpesePivotSEMESTRE: TcxDBPivotGridField;
    GosSpesePivotANNO: TcxDBPivotGridField;
    TabSheetDocCharts: TcxTabSheet;
    QryDocCHART_DESCRIZIONE: TStringField;
    tvDocCHART_DESCRIZIONE: TcxGridDBColumn;
    TabGMGrafici: TcxTabSheet;
    SpeedButton5: TSpeedButton;
    Panel9: TPanel;
    SpeedButton6: TSpeedButton;
    SpeedButton26: TSpeedButton;
    SpeedButton29: TSpeedButton;
    QryScadANNO: TWordField;
    QryScadSEMESTRE: TStringField;
    QryScadTRIMESTRE: TStringField;
    tvScadANNO: TcxGridDBColumn;
    tvScadSEMESTRE: TcxGridDBColumn;
    tvScadTRIMESTRE: TcxGridDBColumn;
    TabScadADA: TcxTabSheet;
    PivotGridScad: TcxDBPivotGrid;
    PivotGridScadCODICE: TcxDBPivotGridField;
    PivotGridScadDATASCADENZA: TcxDBPivotGridField;
    PivotGridScadRICEVUTABANCARIA: TcxDBPivotGridField;
    PivotGridScadPRESENTATA: TcxDBPivotGridField;
    PivotGridScadDARE: TcxDBPivotGridField;
    PivotGridScadAVERE: TcxDBPivotGridField;
    PivotGridScadDOCUMENTO: TcxDBPivotGridField;
    PivotGridScadSOGGETTO: TcxDBPivotGridField;
    PivotGridScadTIPO: TcxDBPivotGridField;
    PivotGridScadBANCA: TcxDBPivotGridField;
    PivotGridScadABI: TcxDBPivotGridField;
    PivotGridScadCAB: TcxDBPivotGridField;
    PivotGridScadRAGIONESOCIALE: TcxDBPivotGridField;
    PivotGridScadINDIRIZZO: TcxDBPivotGridField;
    PivotGridScadCAP: TcxDBPivotGridField;
    PivotGridScadCITTA: TcxDBPivotGridField;
    PivotGridScadPROVINCIA: TcxDBPivotGridField;
    PivotGridScadPARTITAIVA: TcxDBPivotGridField;
    PivotGridScadRESIDUO: TcxDBPivotGridField;
    PivotGridScadIMPORTO: TcxDBPivotGridField;
    PivotGridScadCLIENTE: TcxDBPivotGridField;
    PivotGridScadPRATICA: TcxDBPivotGridField;
    PivotGridScadDATAPRATICA1: TcxDBPivotGridField;
    PivotGridScadTIPODOC: TcxDBPivotGridField;
    PivotGridScadNUMDOC: TcxDBPivotGridField;
    PivotGridScadREGISTRO: TcxDBPivotGridField;
    PivotGridScadDATADOC: TcxDBPivotGridField;
    PivotGridScadNOTE: TcxDBPivotGridField;
    PivotGridScadINSOLUTO: TcxDBPivotGridField;
    PivotGridScadRIFPRATICA: TcxDBPivotGridField;
    PivotGridScadAGENTE: TcxDBPivotGridField;
    PivotGridScadDATAPAGAMENTO: TcxDBPivotGridField;
    PivotGridScadSTATODESCRIZIONE: TcxDBPivotGridField;
    PivotGridScadRITACC: TcxDBPivotGridField;
    PivotGridScadTOTALEIMPONIBILE: TcxDBPivotGridField;
    PivotGridScadRITACCPERC: TcxDBPivotGridField;
    PivotGridScadIMPORTOPAGATO: TcxDBPivotGridField;
    PivotGridScadAGENTE2: TcxDBPivotGridField;
    PivotGridScadAGENTE3: TcxDBPivotGridField;
    PivotGridScadAGENTE4: TcxDBPivotGridField;
    PivotGridScadTIPOLOGIA: TcxDBPivotGridField;
    PivotGridScadPRESENTATABANCA: TcxDBPivotGridField;
    PivotGridScadPAGATO: TcxDBPivotGridField;
    PivotGridScadCHART_DESCRIZIONE: TcxDBPivotGridField;
    PivotGridScadANNO: TcxDBPivotGridField;
    PivotGridScadSEMESTRE: TcxDBPivotGridField;
    PivotGridScadTRIMESTRE: TcxDBPivotGridField;
    Stampagraficodocumenti1: TMenuItem;
    StampaADAscadenze1: TMenuItem;
    ScadPivotLink: TcxPivotGridReportLink;
    Stampagraficogiornaledimagazzino1: TMenuItem;
    Panel10: TPanel;
    Panel16: TPanel;
    SpeedButton13: TSpeedButton;
    SpeedButton14: TSpeedButton;
    SpeedButton30: TSpeedButton;
    SpeedButton31: TSpeedButton;
    SpeedButtonDataRowHeight: TSpeedButton;
    QryDocDESTINAZIONEMERCI: TStringField;
    tvDocMESSAGGI: TcxGridDBColumn;
    tvDocDESTINAZIONEMERCI: TcxGridDBColumn;
    QryDocMESSAGGI: TStringField;
    QryDocPAGAMENTO: TStringField;
    tvDocPAGAMENTO: TcxGridDBColumn;
    QryImpFATTO: TStringField;
    tvImpegniFATTO: TcxGridDBColumn;
    QryDocRIFDOC_CORRISPNOPAG: TStringField;
    QryDocFE_STATUS: TStringField;
    QryDocFE_LASTNOTIFICATION: TDateTimeField;
    QryDocFE_CHECKFORNOTIFICATIONS: TStringField;
    QryDocFE_NOTIFICATIONWAITDAYS: TIntegerField;
    tvDocFE_STATUS: TcxGridDBColumn;
    tvDocFE_LASTNOTIFICATION: TcxGridDBColumn;
    tvDocFE_CHECKFORNOTIFICATIONS: TcxGridDBColumn;
    tvDocFE_NOTIFICATIONWAITDAYS: TcxGridDBColumn;
    NotifichefatturaelettronicaDEMO1: TMenuItem;
    Notificadiaccettazione1: TMenuItem;
    Notificadiscarto1: TMenuItem;
    Accettatadalprovider1: TMenuItem;
    Rifiutatadalprovider1: TMenuItem;
    Notificadimancataconsegna1: TMenuItem;
    Attestazionediavvenutatrasmissioneconimpossibilitdirecapito1: TMenuItem;
    Notificadidecorrenzatermini1: TMenuItem;
    N22: TMenuItem;
    N23: TMenuItem;
    N24: TMenuItem;
    QryDocFE_DAYSFROMNOTIFICATION: TIntegerField;
    QryDocFE_TIMINGINDEX: TIntegerField;
    tvDocFE_TIMINGINDEX: TcxGridDBColumn;
    tvDocFE_DAYSFROMNOTIFICATION: TcxGridDBColumn;
    QryDocFE_DAYSLEFT: TIntegerField;
    tvDocFE_DAYSLEFT: TcxGridDBColumn;
    N25: TMenuItem;
    Notifica1giorno1: TMenuItem;
    Notifica2giorni1: TMenuItem;
    Notifica3giorni1: TMenuItem;
    Notifica4giorni1: TMenuItem;
    Notifica5giorni1: TMenuItem;
    Notifica6giorni1: TMenuItem;
    Notifica7giorni1: TMenuItem;
    Notifica8giorni1: TMenuItem;
    Notifica9giorni1: TMenuItem;
    QryDocFE_STATUS_EXT: TStringField;
    tvDocFE_STATUS_EXT: TcxGridDBColumn;
    QryDocFE_ID: TStringField;
    QryDocTIPOPERSONA: TStringField;
    NotificaesitofatturaaccettataSDI1: TMenuItem;
    NotificaesitofatturarifiutataSDI1: TMenuItem;
    QryDocJOLLY_NUM_1: TIBOFloatField;
    tvDocJOLLY_NUM_1: TcxGridDBColumn;
    QryAgenda: TIBOQuery;
    QryTecnici: TIBOQuery;
    QryTotDocTOT_JOLLY_NUM_1: TCurrencyField;
    QrySoggettiPA_CODICEDESTINATARIO: TStringField;
    QrySoggettiPEC: TStringField;
    QrySoggettiNAZIONESIGLA: TStringField;
    tvRubricaPA_CODICEDESTINATARIO: TcxGridDBColumn;
    tvRubricaPEC: TcxGridDBColumn;
    tvRubricaNAZIONESIGLA: TcxGridDBColumn;
    N26: TMenuItem;
    Importafatturaelettronicapassivaacquisto1: TMenuItem;
    QryDocRESOURCENAME: TStringField;
    tvDocRESOURCENAME: TcxGridDBColumn;
    QryPraticheNOME: TStringField;
    tvPratNOME: TcxGridDBColumn;
    QryDocID: TIntegerField;
    tvDocID: TcxGridDBColumn;
    QryDocIS_LDE: TStringField;
    tvDocIS_LDE: TcxGridDBColumn;
    cxCheckComboBox1: TcxCheckComboBox;
    QryGMRIFDOC_TIPO: TStringField;
    QryGMRIFDOC_NUM: TIntegerField;
    QryGMRIFDOC_REG: TStringField;
    QryGMRIFDOC_DATA: TDateTimeField;
    QryGMRIFDOC: TStringField;
    tvGMRIFDOC_TIPO: TcxGridDBColumn;
    tvGMRIFDOC_NUM: TcxGridDBColumn;
    tvGMRIFDOC_REG: TcxGridDBColumn;
    tvGMRIFDOC_DATA: TcxGridDBColumn;
    tvGMRIFDOC: TcxGridDBColumn;
    DocVendite: TcxCheckListBox;
    DocAcquisti: TcxCheckListBox;
    DocAltri: TcxCheckListBox;
    GMVendite: TcxCheckListBox;
    GMAcquisti: TcxCheckListBox;
    QryDocAPPARECCHI: TStringField;
    tvDocAPPARECCHI: TcxGridDBColumn;
    QryScadID: TIntegerField;
    tvScadID: TcxGridDBColumn;
    QryArticoliULTIMOCOSTODOC: TStringField;
    tvArtULTIMOCOSTODOC: TcxGridDBColumn;
    QryImpRICHIEDENTE: TStringField;
    tvImpegniRICHIEDENTE: TcxGridDBColumn;
    QryDocTIPODOCESTESO: TStringField;
    tvDocTIPODOCESTESO: TcxGridDBColumn;
    QryDocRDA: TStringField;
    tvDocRDA: TcxGridDBColumn;
    QryGMRDA: TStringField;
    tvGMRDA: TcxGridDBColumn;
    StaticText36: TStaticText;
    FilterRDA: TEdit;
    GMRDA: TEdit;
    StaticText39: TStaticText;
    QryArticoliDESCRIZIONEFORNITORE: TStringField;
    tvArtDESCRIZIONEFORNITORE: TcxGridDBColumn;
    QryArticoliFORNITORE: TStringField;
    tvArtFORNITORE: TcxGridDBColumn;
    StaticText42: TStaticText;
    EditArtFornitore: TcxComboBox;
    QryDocABBUONO: TIBOFloatField;
    QryDocTOTALEDAPAGARE: TIBOFloatField;
    tvDocABBUONO: TcxGridDBColumn;
    tvDocTOTALEDAPAGARE: TcxGridDBColumn;
    QryTotDocTOTABBUONO: TFloatField;
    QryTotDocTOTDAPAGARE: TFloatField;
    QryDocTOTALESPLITPAYMENT: TIBOFloatField;
    QryTotDocTOTSPLIPAYMENT: TFloatField;
    tvDocTOTALESPLITPAYMENT: TcxGridDBColumn;
    GridDocLink: TdxGridReportLink;
    Panel18: TPanel;
    SBCollapseGOSore: TSpeedButton;
    SBExpandGOSore: TSpeedButton;
    SBFilterRowGOSore: TSpeedButton;
    Panel19: TPanel;
    SBCollapseGOSspese: TSpeedButton;
    SBExpandGOSspese: TSpeedButton;
    SBFilterRowGOSspese: TSpeedButton;
    QryDocDATIVETTORE: TStringField;
    tvDocDATIVETTORE: TcxGridDBColumn;
    Fatturachiamateappuntamentiinterventiselezionati2: TMenuItem;
    procedure RxSpeedButtonUscitaClick(Sender: TObject);
    procedure RxSpeedButtonEliminaClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure RxSpeedButtonTrovaClick(Sender: TObject);
    procedure RxSpeedButtonVisualizzaClick(Sender: TObject);
    procedure EseguiQueryClienti; // Personale
    procedure EseguiQueryPreventiviOrdini(QryDoc: TIBOQuery); // Personale
    // procedure EseguiQueryPreventiviOrdini;     // Personale
    procedure EseguiQueryScadenze; // Personale
    procedure EseguiQueryTesti(QryDoc: TIBOQuery); // Personale
    procedure EseguiQueryContatti; // Personale
    procedure EseguiQueryExtFile(QryDoc: TIBOQuery); // Personale
    procedure EseguiQueryPratiche; // Personale
    procedure EseguiQueryConformita(QryDoc: TIBOQuery); // Personale
    procedure RxSpeedButtonResetQueryClick(Sender: TObject);
    procedure RxSpeedButtonNuovoClick(Sender: TObject);
    procedure RxSpeedButtonStampaClick(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure SB1Click(Sender: TObject);
    procedure FormKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure MenuStampePopup(Sender: TObject);
    procedure SBGenClick(Sender: TObject);
    procedure SBDocTuttiClick(Sender: TObject);
    procedure SBDocNessunoClick(Sender: TObject);
    procedure SBMesiTuttiClick(Sender: TObject);
    procedure SBMesiNessunoClick(Sender: TObject);
    procedure PageControl2Change(Sender: TObject);
    procedure SBEsportaDocFiscClick(Sender: TObject);
    procedure ControllaAbilitazioneDocumenti;
    procedure RxSpeedButtonStampaMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure Salvaimpostazionicolonne1Click(Sender: TObject);
    procedure CaricaFormLayout;
    procedure EseguiQueryTracciati;
    procedure Elencoclienti1Click(Sender: TObject);
    procedure Elencodocumenti1Click(Sender: TObject);
    procedure AggiornaSoggettiPratica;
    procedure EditClientiCodiceKeyPress(Sender: TObject; var Key: Char);
    procedure RxSpeedButtonHelpClick(Sender: TObject);
    procedure GMMesiTuttiClick(Sender: TObject);
    procedure GMMesiNessunoClick(Sender: TObject);
    procedure GenClick(Sender: TObject);
    procedure EseguiQueryGM;
    procedure GMCodiceGruppo1Change(Sender: TObject);
    procedure GMCodiceGruppo2Change(Sender: TObject);
    procedure GiornaleDiMagazzino1Click(Sender: TObject);
    procedure CVCodiceGruppo1Change(Sender: TObject);
    procedure CVCodiceGruppo2Change(Sender: TObject);
    procedure EseguiQueryCV;
    procedure EliminaCliente(CodToDel: Longint);
    procedure CloseAnim(I: TImage);
    procedure OpenAnim(I: TImage);
    procedure EseguiQueryArticoli;
    procedure CodiceGruppo1Change(Sender: TObject);
    procedure CodiceGruppo2Change(Sender: TObject);
    procedure PratMesiTuttiClick(Sender: TObject);
    procedure PratMesiNessunoClick(Sender: TObject);
    procedure PratGenClick(Sender: TObject);
    procedure ScadMesiTuttiClick(Sender: TObject);
    procedure ScadMesiNessunoClick(Sender: TObject);
    procedure ScadGenClick(Sender: TObject);
    procedure AbilitaDocumento(IndiceDoc: Integer; Enabled: Boolean; DescrizioneDoc: String);
    function DocIsChecked(IndiceDoc: Integer): Boolean;
    procedure SBDocNessunoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure SBDocTuttiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure SBGenMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure SBMesiTuttiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure SBMesiNessunoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure DocVenditeOldExit(Sender: TObject);
    function NessunDocumentoSelezionato: Boolean;
    procedure ResetTabRubrica;
    procedure BitBtnGruppo1Click(Sender: TObject);
    procedure BitBtnGruppo2Click(Sender: TObject);
    procedure BitBtnGruppo3Click(Sender: TObject);
    procedure BitBtnCodiceMagazzinoClick(Sender: TObject);
    procedure BitBtnCVGruppo1Click(Sender: TObject);
    procedure BitBtnCVGruppo2Click(Sender: TObject);
    procedure BitBtnCVGruppo3Click(Sender: TObject);
    procedure BitBtnCVArticoloClick(Sender: TObject);
    procedure CVControllaTipoCondizione;
    procedure TipoCondizioneMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure ScadGenMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure ScadMesiTuttiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure ScadMesiNessunoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure GenMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure GMMesiTuttiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure GMMesiNessunoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure SBPagamentoRiscossioneClick(Sender: TObject);
    procedure BitBtnArtGruppo1Click(Sender: TObject);
    procedure BitBtnArtGruppo2Click(Sender: TObject);
    procedure BitBtnArtGruppo3Click(Sender: TObject);
    procedure BitBtnArtCodiceMagazzinoClick(Sender: TObject);
    procedure PageControl2Changing(Sender: TObject; var AllowChange: Boolean);
    procedure RxSpeedButtonEliminaDragOver(Sender, Source: TObject; X, Y: Integer; State: TDragState; var Accept: Boolean);
    procedure RxSpeedButtonVisualizzaDragOver(Sender, Source: TObject; X, Y: Integer; State: TDragState; var Accept: Boolean);
    procedure tvGMCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
    procedure tvRubricaDblClick(Sender: TObject);
    procedure tvRubricaEndDrag(Sender, Target: TObject; X, Y: Integer);
    procedure tvDocEndDrag(Sender, Target: TObject; X, Y: Integer);
    procedure tvScadCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
    procedure tvGMSCONTORIGOGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
    procedure tvArtCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
    procedure tvGMEndDrag(Sender, Target: TObject; X, Y: Integer);
    procedure tvPratCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
    procedure CaricaMagazzinoDefaultArticoli;
    procedure tvGMDataControllerGroupingChanged(Sender: TObject);
    procedure tvCVDataControllerGroupingChanged(Sender: TObject);
    procedure tvArtDataControllerGroupingChanged(Sender: TObject);
    procedure tvRubricaDataControllerSortingChanged(Sender: TObject);
    procedure tvDocDataControllerSortingChanged(Sender: TObject);
    procedure tvGMDataControllerSortingChanged(Sender: TObject);
    procedure tvPratDataControllerSortingChanged(Sender: TObject);
    procedure tvScadDataControllerSortingChanged(Sender: TObject);
    procedure tvArtDataControllerSortingChanged(Sender: TObject);
    procedure tvRubricaCustomDrawGroupCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableCellViewInfo; var ADone: Boolean);
    procedure SpeedButtonRollOver3Click(Sender: TObject);
    procedure SoloGiacAttivaMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure dxPrinterCustomDrawPageFooter(Sender: TObject; AReportLink: TBasedxReportLink; ACanvas: TCanvas; APageIndex: Integer; var ARect: TRect;
      ANom, ADenom: Integer; var ADefaultDrawText, ADefaultDrawBackground: Boolean);
    procedure dxPrinterCustomDrawPageHeader(Sender: TObject; AReportLink: TBasedxReportLink; ACanvas: TCanvas; APageIndex: Integer; var ARect: TRect;
      ANom, ADenom: Integer; var ADefaultDrawText, ADefaultDrawBackground: Boolean);
    procedure dxPrinterStartGenerateReport(Sender: TObject; AReportLink: TBasedxReportLink);
    procedure dxPrinterEndGenerateReport(Sender: TObject; AReportLink: TBasedxReportLink);
    procedure Stampaelencoscadenze1Click(Sender: TObject);
    procedure TipoScadenze2MouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure StampadistintadipresentazioneRIBAperlabanca1Click(Sender: TObject);
    procedure MarcaScadenzeComePresentate;
    procedure ElencoArticoli1Click(Sender: TObject);
    procedure QryArticoliCalcFields(DataSet: TDataSet);
    procedure InventarioUltimoCosto1Click(Sender: TObject);
    procedure MIArticoloClick(Sender: TObject);
    procedure MIArticoloCompostoClick(Sender: TObject);
    procedure MISoggettoClick(Sender: TObject);
    procedure MIPraticaClick(Sender: TObject);
    procedure MIBuonoConsegnaClick(Sender: TObject);
    procedure MIDDTClick(Sender: TObject);
    procedure MIFatturaClick(Sender: TObject);
    procedure MIFatturaRicevutaFiscaleClick(Sender: TObject);
    procedure MINotaCreditoClick(Sender: TObject);
    procedure MIOrdineClick(Sender: TObject);
    procedure MIPreventivoClick(Sender: TObject);
    procedure MIRicevutaFiscaleClick(Sender: TObject);
    procedure MISALClick(Sender: TObject);
    procedure MIBollaEntrataClick(Sender: TObject);
    procedure MIFatturaAcquistoClick(Sender: TObject);
    procedure MIOrdineFornitoreClick(Sender: TObject);
    procedure MIContattoDaFareClick(Sender: TObject);
    procedure MIContattoFattoClick(Sender: TObject);
    procedure MIConformitaClick(Sender: TObject);
    procedure MIFileEsternoClick(Sender: TObject);
    procedure MILetteraClick(Sender: TObject);
    procedure MIScadenzaAttivaClick(Sender: TObject);
    procedure MIScadenzaPassivaClick(Sender: TObject);
    procedure MICondVendGruppoClick(Sender: TObject);
    procedure MICondVendArticoloClick(Sender: TObject);
    procedure MICondAcqGruppoClick(Sender: TObject);
    procedure MICondAcqArticoloClick(Sender: TObject);
    procedure MenuDocumentiPopup(Sender: TObject);
    procedure MenuScadenzarioPopup(Sender: TObject);
    procedure MenuCondVendPopup(Sender: TObject);
    procedure MenuSoggettiPopup(Sender: TObject);
    procedure MenuArticoliPopup(Sender: TObject);
    procedure MenuPratichePopup(Sender: TObject);
    procedure PopupMenuPopupGestoreDefault(Sender: TObject);
    procedure VaiAlTabDopoSelezioneOggetto;
    procedure VaiAlTabDopoSelezionePratica;
    procedure VaiAlTabDopoSelezioneImpianto;
    procedure TipoCondizioneClickCheck(Sender: TObject);
    procedure Stampaetichetteclienti1Click(Sender: TObject);
    procedure Stampaetichettearticoli1Click(Sender: TObject);
    procedure Notadicreditofornitore1Click(Sender: TObject);
    procedure CompostiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure tvArtGIACENZACustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
    procedure Sostituzionesottoarticolonegliarticoliselezionati1Click(Sender: TObject);
    procedure Sostituzionesottoarticolointuttigliarticoli1Click(Sender: TObject);
    procedure MenuElencoClientiPopup(Sender: TObject);
    procedure tvDocSELEZIONATOCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
    procedure MarcaImportExport(TipoDoc, Registro: String; NumDoc: Longint; DataDoc: TDate; V, PrecValue: String);
    procedure tvDocDragDrop(Sender, Source: TObject; X, Y: Integer);
    procedure tvDocDragOver(Sender, Source: TObject; X, Y: Integer; State: TDragState; var Accept: Boolean);
    procedure PratMesiTuttiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure PratMesiNessunoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure PratGenMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure MenuAssistenzePopup(Sender: TObject);
    procedure ImpMesiTuttiClick(Sender: TObject);
    procedure ImpMesiTuttiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure ImpMesiNessunoClick(Sender: TObject);
    procedure ImpMesiNessunoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure ImpGenClick(Sender: TObject);
    procedure ImpGenMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure EseguiQueryImpegni;
    procedure MenuImpegniPopup(Sender: TObject);
    procedure FilterAbbonatiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure Stampaelencoimpianti1Click(Sender: TObject);
    procedure Stampaelencochiamateappuntamentiinterventi1Click(Sender: TObject);
    procedure SoloRegistroPropertiesInitPopup(Sender: TObject);
    procedure TranneRegistroPropertiesChange(Sender: TObject);
    procedure QryArticoliBeforeDelete(DataSet: TDataSet);
    procedure QryArticoliAfterDelete(DataSet: TDataSet);
    procedure QryArticoliDeleteError(DataSet: TDataSet; E: EDatabaseError; var Action: TDataAction);
    procedure tvDocKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Stampaelencocantieri1Click(Sender: TObject);
    procedure ScadTipoDocDragDrop(Sender, Source: TObject; X, Y: Integer);
    procedure ScadTipoDocDragOver(Sender, Source: TObject; X, Y: Integer; State: TDragState; var Accept: Boolean);
    procedure ArtVisteKeyPress(Sender: TObject; var Key: Char);
    procedure Selezionavista1Click(Sender: TObject);
    procedure Ripristinacolonneeliminate1Click(Sender: TObject);
    procedure tvRubricaCustomDrawPartBackground(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxCustomGridCellViewInfo; var ADone: Boolean);
    procedure EseguiQueryAgenda;
    procedure Impegno1Click(Sender: TObject);
    procedure MenuAgendaPopup(Sender: TObject);
    procedure AgendaImportaChiamata;
    procedure Agenda_NormalSelectionModeDragDrop(Sender, Source: TObject; X, Y: Integer);
    procedure BtnTecnicoClick(Sender: TObject);
    procedure BitBtnArtGruppo4Click(Sender: TObject);
    procedure BitBtnArtGruppo5Click(Sender: TObject);
    procedure BitBtnArtGruppo6Click(Sender: TObject);
    procedure CodiceGruppo3Change(Sender: TObject);
    procedure CodiceGruppo4Change(Sender: TObject);
    procedure CodiceGruppo5Change(Sender: TObject);
    procedure BitBtnGruppo4Click(Sender: TObject);
    procedure BitBtnGruppo5Click(Sender: TObject);
    procedure BitBtnGruppo6Click(Sender: TObject);
    procedure GMCodiceGruppo3Change(Sender: TObject);
    procedure GMCodiceGruppo4Change(Sender: TObject);
    procedure GMCodiceGruppo5Change(Sender: TObject);
    procedure Stampa2Click(Sender: TObject);
    procedure EsportainformatoPDF2Click(Sender: TObject);
    procedure PagamentoRiscossionecumulativoRIBAselezionate1Click(Sender: TObject);
    procedure Appuntamentonormale1Click(Sender: TObject);
    procedure SpeedButtonRollOver14Click(Sender: TObject);
    procedure SoloStatoPropertiesInitPopup(Sender: TObject);
    procedure Cambiastatodocumentiselezionati1Click(Sender: TObject);
    procedure SetStatoDocumentiSelezionati(NuovoStato: String);
    procedure SetStatoDocumentiSelezionatiGM(NuovoStato: String);
    procedure SetRegistroDocumentiSelezionati(NuovoRegistro: String);
    procedure tvDocCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
    procedure Cambiaregistroaidocumentiselezionati1Click(Sender: TObject);
    procedure Eliminaappuntamentoecreadocumento1Click(Sender: TObject);
    procedure Eliminaappuntamentoecreadocumento2Click(Sender: TObject);
    procedure ChiamataAppuntamentodiassistenza1Click(Sender: TObject);
    procedure Appuntamentonormale2Click(Sender: TObject);
    procedure tvImpegniDataControllerSortingChanged(Sender: TObject);
    procedure SetConsegnatoDocSel;
    procedure MarcacomeConsegnatiidocumentiselezionati1Click(Sender: TObject);
    procedure SoloRegistroPropertiesChange(Sender: TObject);
    procedure CausalePropertiesInitPopup(Sender: TObject);
    procedure Stampacumulativadeidocumentiselezionati1Click(Sender: TObject);
    procedure TipoImportoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure tvRubricaCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
    procedure cxComboBox1PropertiesInitPopup(Sender: TObject);
    procedure SoggStatoPropertiesInitPopup(Sender: TObject);
    procedure QryArticoliAfterOpen(DataSet: TDataSet);
    procedure tvArtDataControllerDetailExpanded(ADataController: TcxCustomDataController; ARecordIndex: Integer);
    procedure tvArtDataControllerDetailExpanding(ADataController: TcxCustomDataController; ARecordIndex: Integer; var AAllow: Boolean);
    procedure tvGMCustomDrawGroupCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableCellViewInfo; var ADone: Boolean);
    procedure SpeedButton4Click(Sender: TObject);
    procedure SpeedButton3Click(Sender: TObject);
    procedure SpeedButton7Click(Sender: TObject);
    procedure SpeedButton8Click(Sender: TObject);
    procedure SpeedButton9Click(Sender: TObject);
    procedure SpeedButton10Click(Sender: TObject);
    procedure SpeedButton15Click(Sender: TObject);
    procedure SpeedButton16Click(Sender: TObject);
    procedure SoloSoggettoPropertiesInitPopup(Sender: TObject);
    procedure RxSpeedButtonMailClick(Sender: TObject);
    procedure SBGMTuttiClick(Sender: TObject);
    procedure SBGMTuttiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure SBGMNessunoClick(Sender: TObject);
    procedure SBGMNessunoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure RBTipoMovMagazzinoClick(Sender: TObject);
    procedure CLBSegnoOpMagazzinoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure Stampaagenda1Click(Sender: TObject);
    procedure Stampapartitario1Click(Sender: TObject);
    procedure QryDocCalcFields(DataSet: TDataSet);
    procedure tvDocColumnPosChanged(Sender: TcxGridTableView; AColumn: TcxGridColumn);
    procedure CreafilepresentazioneRIBAallincasso1Click(Sender: TObject);
    procedure Rapportogiornaliero1Click(Sender: TObject);
    procedure GOSTipoDatoOrePropertiesChange(Sender: TObject);
    procedure GOSSuddivisioneOrePropertiesChange(Sender: TObject);
    procedure cxPageControlGOSChange(Sender: TObject);
    procedure BtnFilterGosDipendenteClick(Sender: TObject);
    procedure FilterGosTipoOre1PropertiesInitPopup(Sender: TObject);
    procedure FilterGosTipoOre2PropertiesInitPopup(Sender: TObject);
    procedure FilterGosTipoOre3PropertiesInitPopup(Sender: TObject);
    procedure GOSMesiNessunoClick(Sender: TObject);
    procedure GOSMesiTuttiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure GOSMesiTuttiClick(Sender: TObject);
    procedure GOSMesiNessunoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure GOSGenMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure SpeedButtonRollOver16Click(Sender: TObject);
    procedure FilterGosTipoCosto1PropertiesInitPopup(Sender: TObject);
    procedure FilterGosTipoCosto2PropertiesInitPopup(Sender: TObject);
    procedure FilterGosTipoCosto3PropertiesInitPopup(Sender: TObject);
    procedure GOSSpeseMesiTuttiClick(Sender: TObject);
    procedure GOSSpeseMesiNessunoClick(Sender: TObject);
    procedure GOSSpeseMesiTuttiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure GOSSpeseMesiNessunoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure GOSSpeseGenClick(Sender: TObject);
    procedure GOSSpeseGenMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure GOSGenClick(Sender: TObject);
    procedure SpeedButtonRollOver17Click(Sender: TObject);
    procedure Stamparapportooredipendenti1Click(Sender: TObject);
    procedure tvOreDataControllerGroupingChanged(Sender: TObject);
    procedure tvSpeseDataControllerGroupingChanged(Sender: TObject);
    procedure GosOrePivotCustomization(Sender: TObject);
    procedure GosOrePivotDblClick(Sender: TObject);
    procedure StampaADAdipendenti1Click(Sender: TObject);
    procedure Stamparapportospesevarie1Click(Sender: TObject);
    procedure StampaADAspesevarie1Click(Sender: TObject);
    procedure GosSpesePivotDblClick(Sender: TObject);
    procedure Stampagraficooredipendenti1Click(Sender: TObject);
    procedure Stampagraficospesevarie1Click(Sender: TObject);
    procedure Stamperiepilogativecantieri1Click(Sender: TObject);
    procedure tvArtDragOver(Sender, Source: TObject; X, Y: Integer; State: TDragState; var Accept: Boolean);
    procedure tvArtDragDrop(Sender, Source: TObject; X, Y: Integer);
    procedure tvAltriDocDataControllerGroupingChanged(Sender: TObject);
    procedure tvAltriDocDataControllerSortingChanged(Sender: TObject);
    procedure tvAltriDocCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
    procedure QryGMCalcFields(DataSet: TDataSet);
    procedure Impostaeventoricorsivo1Click(Sender: TObject);
    procedure Copiaidocumentiselezionatisullabacheca1Click(Sender: TObject);
    procedure QryAssCalcFields(DataSet: TDataSet);
    procedure PrmMesiTuttiClick(Sender: TObject);
    procedure PrmMesiNessunoClick(Sender: TObject);
    procedure PrmMesiTuttiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure PrmMesiNessunoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure PrmGenClick(Sender: TObject);
    procedure PrmGenMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure PrmExpandClick(Sender: TObject);
    procedure PrmCollapseClick(Sender: TObject);
    procedure tvPrimanotaDataControllerGroupingChanged(Sender: TObject);
    procedure tvPrimanotaDataControllerSortingChanged(Sender: TObject);
    procedure Stampamovimentiprimanota1Click(Sender: TObject);
    procedure MenuPrimanotaPopup(Sender: TObject);
    procedure Movimentoprimanota1Click(Sender: TObject);
    procedure Caricocantiere1Click(Sender: TObject);
    procedure Commessa1Click(Sender: TObject);
    procedure Estrattoconto1Click(Sender: TObject);
    procedure Scaricocantiere1Click(Sender: TObject);
    procedure OpenFilterPanel(P: TPanel; B: TSpeedButtonRollOver; Animation: Boolean = False);
    procedure CloseFilterPanel(P: TPanel; B: TSpeedButtonRollOver; Animation: Boolean = False);
    procedure SBDocFilterOpenCloseClick(Sender: TObject);
    procedure SBRubricaFilterOpenCloseClick(Sender: TObject);
    procedure GridSoggResize(Sender: TObject);
    procedure SBGMFilterOpenCloseClick(Sender: TObject);
    procedure SBPratFilterOpenCloseClick(Sender: TObject);
    procedure SBScadFilterOpenCloseClick(Sender: TObject);
    procedure SBPrimanotFilterOpenCloseClick(Sender: TObject);
    procedure SBArtFilterOpenCloseClick(Sender: TObject);
    procedure SBImpFilterOpenCloseClick(Sender: TObject);
    procedure SBGosFilterOpenCloseClick(Sender: TObject);
    procedure Intervento1Click(Sender: TObject);
    procedure tvImpegniEndDrag(Sender, Target: TObject; X, Y: Integer);
    procedure EsportainformatoExcel1Click(Sender: TObject);
    procedure ProcessBarcode(Barcode: String);
    procedure DocConCantiereMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure ImpConCantiereMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure EsportinventarioultimocostoinformatoEXCEL1Click(Sender: TObject);
    procedure StampacumulativadelKITperiltecnicodegliappuntamentiselezionati1Click(Sender: TObject);
    procedure StampacumulativadelFoglidiLavorodegliappuntamentiselezionati1Click(Sender: TObject);
    procedure StampacumulativadelKITperiltecnicodegliappuntamentiselezionati2Click(Sender: TObject);
    procedure StampacumulativadelFogliodiLavorodegliappuntamentiselezionati1Click(Sender: TObject);
    procedure PanelFiltriSoggResize(Sender: TObject);
    procedure Panel3Resize(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
    procedure Stampainventarioultimocostosustampanteadaghi1Click(Sender: TObject);
    procedure tvPrimanotaCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
    procedure PrmStatoPropertiesInitPopup(Sender: TObject);
    procedure OperatorePropertiesInitPopup(Sender: TObject);
    procedure Button5Click(Sender: TObject);
    procedure Button6Click(Sender: TObject);
    procedure GMTipo1PropertiesInitPopup(Sender: TObject);
    procedure EditArtSoloArticoliMovimentatiPropertiesEditValueChanged(Sender: TObject);
    procedure Stampacumulativaappuntamentiselezionati1Click(Sender: TObject);
    procedure tvDocAZIONEMAGAZZINOGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
    procedure tvDocAZIONECANTIEREGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
    procedure tvGMSEGNOOPERAZIONEGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
    procedure tvGMSEGNOOPERAZIONECANTIEREGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
    procedure FilterGosTipoManodoperaPropertiesInitPopup(Sender: TObject);
    procedure tvOreOPERAINDEXGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
    procedure RxSpeedModificaClick(Sender: TObject);
    procedure Stampaindicepercategorie1Click(Sender: TObject);
    procedure Stampaindicealfabetico1Click(Sender: TObject);
    procedure Stampaindiceperfornitore1Click(Sender: TObject);
    procedure Stampacatalogofiguratosenzacodiciabarre1Click(Sender: TObject);
    procedure Button3Click(Sender: TObject);
    procedure Button7Click(Sender: TObject);
    procedure FilterGosSottocantiere1PropertiesInitPopup(Sender: TObject);
    procedure tvArtSCONTODIACQUISTOGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
    procedure tvArtGRUPPO1GetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
    procedure CalcolaLeftFiltriSubPanel(PanelFiltriMain: TPanel);
    procedure Esportainformatotxt1Click(Sender: TObject);
    procedure Variazionecostoorariomanodoperadeirighiselezionati1Click(Sender: TObject);
    procedure Stamparesiduoordini1Click(Sender: TObject);
    procedure MarcaidocumentiselezionaticomeNONesportati1Click(Sender: TObject);
    procedure tvScadRITACCGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
    procedure ScadStatoPropertiesInitPopup(Sender: TObject);
    procedure SetStatoScadenzeSelezionate(NuovoStato: String);
    procedure SetStatoPrimenoteSelezionate(NuovoStato: String);
    procedure Cambiastatoallescadenzeselezionate1Click(Sender: TObject);
    procedure Cambiastatoalleregistrazionidiprimanotaselezionate1Click(Sender: TObject);
    procedure tvScadRITACCPERCGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
    procedure tvOreDataControllerSortingChanged(Sender: TObject);
    procedure tvCVDataControllerSortingChanged(Sender: TObject);
    procedure tvSpeseDataControllerSortingChanged(Sender: TObject);
    procedure FilterGosSoloRegistroPropertiesChange(Sender: TObject);
    procedure FilterGosTranneRegistroPropertiesChange(Sender: TObject);
    procedure FilterGosSpeseSoloRegistroPropertiesChange(Sender: TObject);
    procedure FilterGosSpeseTranneRegistroPropertiesChange(Sender: TObject);
    procedure tvOreCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
    procedure tvSpeseCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
    procedure SBGosSpeseFilterOpenCloseClick(Sender: TObject);
    procedure PratCategCant1PropertiesInitPopup(Sender: TObject);
    procedure SpeedButton1Click(Sender: TObject);
    procedure SpeedButton2Click(Sender: TObject);
    procedure SpeedButton21Click(Sender: TObject);
    procedure SpeedButton22Click(Sender: TObject);
    procedure SvPrimanotaSaveDateFilterClick(Sender: TObject);
    procedure ImpSaveFilterDateClick(Sender: TObject);
    procedure GosSaveDateFilterClick(Sender: TObject);
    procedure ScadSoloRegistroPropertiesChange(Sender: TObject);
    procedure ScadTranneRegistroPropertiesChange(Sender: TObject);
    procedure Forzagiacenzaarticoliselezionati1Click(Sender: TObject);
    procedure Esportadocumentoinformatotesto1Click(Sender: TObject);
    procedure EsportadocumentoinformatoExcel1Click(Sender: TObject);
    procedure QryArtMagCalcFields(DataSet: TDataSet);
    procedure tvArtMagGIACENZACustomDrawFooterCell(Sender: TcxGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridColumnHeaderViewInfo; var ADone: Boolean);
    procedure tvArtMagIMPEGNATOCustomDrawFooterCell(Sender: TcxGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridColumnHeaderViewInfo; var ADone: Boolean);
    procedure tvArtMagORDINATOCustomDrawFooterCell(Sender: TcxGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridColumnHeaderViewInfo; var ADone: Boolean);
    procedure tvArtMagDISPONIBILECustomDrawFooterCell(Sender: TcxGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridColumnHeaderViewInfo; var ADone: Boolean);
    procedure tvArtMagCustomDrawFooterCell(Sender: TcxGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridColumnHeaderViewInfo; var ADone: Boolean);
    procedure Stampaetichettedeiclientiselezionati1Click(Sender: TObject);
    procedure Altreesportazioniarticolilistini1Click(Sender: TObject);
    procedure tvLFEndDrag(Sender, Target: TObject; X, Y: Integer);
    procedure Creanuovocantiereconglistessisottocantieri1Click(Sender: TObject);
    procedure Centraletermica1Click(Sender: TObject);
    procedure Riscaldamento1Click(Sender: TObject);
    procedure Climatizzazione1Click(Sender: TObject);
    procedure Refrigerazione1Click(Sender: TObject);
    procedure Generico1Click(Sender: TObject);
    procedure Stampaetichettedegliarticoliselezionati1Click(Sender: TObject);
    procedure tvPrimanotaCassaEntrateGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
    procedure tvDocIMPONIBILEGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
    procedure PageControlImpegniChange(Sender: TObject);
    procedure PageControlClientiChange(Sender: TObject);
    procedure PageControlPraticheChange(Sender: TObject);
    procedure EditClientiAgentePropertiesEditValueChanged(Sender: TObject);
    procedure EditClientiAgente2PropertiesEditValueChanged(Sender: TObject);
    procedure EditClientiAgente3PropertiesEditValueChanged(Sender: TObject);
    procedure EditClientiAgentePropertiesInitPopup(Sender: TObject);
    procedure EditClientiAgente2PropertiesInitPopup(Sender: TObject);
    procedure EditClientiAgente3PropertiesInitPopup(Sender: TObject);
    procedure EditClientiAgente4PropertiesInitPopup(Sender: TObject);
    procedure PratAgentePropertiesEditValueChanged(Sender: TObject);
    procedure PratAgente2PropertiesEditValueChanged(Sender: TObject);
    procedure PratAgente3PropertiesEditValueChanged(Sender: TObject);
    procedure PratAgentePropertiesInitPopup(Sender: TObject);
    procedure PratAgente2PropertiesInitPopup(Sender: TObject);
    procedure PratAgente3PropertiesInitPopup(Sender: TObject);
    procedure PratAgente4PropertiesInitPopup(Sender: TObject);
    procedure DocAgentePropertiesEditValueChanged(Sender: TObject);
    procedure DocAgente2PropertiesEditValueChanged(Sender: TObject);
    procedure DocAgente3PropertiesEditValueChanged(Sender: TObject);
    procedure DocAgentePropertiesInitPopup(Sender: TObject);
    procedure DocAgente2PropertiesInitPopup(Sender: TObject);
    procedure DocAgente3PropertiesInitPopup(Sender: TObject);
    procedure DocAgente4PropertiesInitPopup(Sender: TObject);
    procedure ScadAgentePropertiesEditValueChanged(Sender: TObject);
    procedure ScadAgente2PropertiesEditValueChanged(Sender: TObject);
    procedure ScadAgente3PropertiesEditValueChanged(Sender: TObject);
    procedure ScadAgentePropertiesInitPopup(Sender: TObject);
    procedure ScadAgente2PropertiesInitPopup(Sender: TObject);
    procedure ScadAgente3PropertiesInitPopup(Sender: TObject);
    procedure ScadAgente4PropertiesInitPopup(Sender: TObject);
    procedure PrmAgentePropertiesEditValueChanged(Sender: TObject);
    procedure PrmAgente2PropertiesEditValueChanged(Sender: TObject);
    procedure PrmAgente3PropertiesEditValueChanged(Sender: TObject);
    procedure PrmAgentePropertiesInitPopup(Sender: TObject);
    procedure PrmAgente2PropertiesInitPopup(Sender: TObject);
    procedure PrmAgente3PropertiesInitPopup(Sender: TObject);
    procedure PrmAgente4PropertiesInitPopup(Sender: TObject);
    procedure ImpAgentePropertiesEditValueChanged(Sender: TObject);
    procedure ImpAgente2PropertiesEditValueChanged(Sender: TObject);
    procedure ImpAgente3PropertiesEditValueChanged(Sender: TObject);
    procedure ImpAgentePropertiesInitPopup(Sender: TObject);
    procedure ImpAgente2PropertiesInitPopup(Sender: TObject);
    procedure ImpAgente3PropertiesInitPopup(Sender: TObject);
    procedure ImpAgente4PropertiesInitPopup(Sender: TObject);
    procedure GMAgentePropertiesEditValueChanged(Sender: TObject);
    procedure GMAgente2PropertiesEditValueChanged(Sender: TObject);
    procedure GMAgente3PropertiesEditValueChanged(Sender: TObject);
    procedure GMAgentePropertiesInitPopup(Sender: TObject);
    procedure GMAgente2PropertiesInitPopup(Sender: TObject);
    procedure GMAgente3PropertiesInitPopup(Sender: TObject);
    procedure GMAgente4PropertiesInitPopup(Sender: TObject);
    procedure Stampagiornaledicantiere1Click(Sender: TObject);
    procedure SBCOllapseImpegniClick(Sender: TObject);
    procedure SBExpandImpegniClick(Sender: TObject);
    procedure SBFilterRowImpegniClick(Sender: TObject);
    procedure tvImpegniCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
    procedure SBCollapseSoggettiClick(Sender: TObject);
    procedure SBExpandSoggettiClick(Sender: TObject);
    procedure SBFilterRowSoggettiClick(Sender: TObject);
    procedure SBCollapsePraticheClick(Sender: TObject);
    procedure SBExpandPraticheClick(Sender: TObject);
    procedure SBFilterRowPraticheClick(Sender: TObject);
    procedure Agenda_NormalSelectionModeInitEventImages(Sender: TcxCustomScheduler; AEvent: TcxSchedulerControlEvent; AImages: TcxSchedulerEventImages);
    procedure Stampaelencocomunicazioni1Click(Sender: TObject);
    procedure SalvaPaginaCorrente(New_Sogg_ID, Old_Sogg_ID, New_Prat_ID, Old_Prat_ID: Integer);
    procedure RipristinaPaginaCorrente(New_Sogg_ID, Old_Sogg_ID, New_Prat_ID, Old_Prat_ID: Integer);
    procedure tvCVFocusedRecordChanged(Sender: TcxCustomGridTableView; APrevFocusedRecord, AFocusedRecord: TcxCustomGridRecord;
      ANewItemRecordFocusingChanged: Boolean);
    procedure tvRubricaDataControllerDetailExpanding(ADataController: TcxCustomDataController; ARecordIndex: Integer; var AAllow: Boolean);
    procedure GoToNuovoDocFisc(TipoDoc: String; ShowWaitForm: Boolean = True);
    procedure GoToNuovoAppuntamento(TipoImpegno: String);
    procedure CreaNuovoImpianto(TipoImpianto: String);
    procedure Agenda_NormalSelectionModeDblClick(Sender: TObject);
    procedure RxSpeedButtonEliminaDragDrop(Sender, Source: TObject; X, Y: Integer);
    procedure RxSpeedButtonVisualizzaDragDrop(Sender, Source: TObject; X, Y: Integer);
    procedure tvRubricaMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure FilterOp1PropertiesInitPopup(Sender: TObject);
    procedure tvRubricaEXISTS_SCADSOFFGetCellHint(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; ACellViewInfo: TcxGridTableDataCellViewInfo;
      const AMousePos: TPoint; var AHintText: TCaption; var AIsHintMultiLine: Boolean; var AHintTextRect: TRect);
    procedure tvRubricaMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
    procedure tvSoggCantEXIST_SCADSOFFGetCellHint(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; ACellViewInfo: TcxGridTableDataCellViewInfo;
      const AMousePos: TPoint; var AHintText: TCaption; var AIsHintMultiLine: Boolean; var AHintTextRect: TRect);
    procedure tvPratMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
    procedure tvPratEXIST_SCADSOFFGetCellHint(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; ACellViewInfo: TcxGridTableDataCellViewInfo;
      const AMousePos: TPoint; var AHintText: TCaption; var AIsHintMultiLine: Boolean; var AHintTextRect: TRect);
    procedure tvDocRIFDOC_CORRISPNOPAGGetCellHint(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; ACellViewInfo: TcxGridTableDataCellViewInfo;
      const AMousePos: TPoint; var AHintText: TCaption; var AIsHintMultiLine: Boolean; var AHintTextRect: TRect);
    procedure tvDocMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
    procedure tvImpegniMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
    procedure tvImpegniEXISTS_CORRISPNOPAGGetCellHint(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; ACellViewInfo: TcxGridTableDataCellViewInfo;
      const AMousePos: TPoint; var AHintText: TCaption; var AIsHintMultiLine: Boolean; var AHintTextRect: TRect);
    procedure GosOreAgentePropertiesInitPopup(Sender: TObject);
    procedure GosOreAgente2PropertiesInitPopup(Sender: TObject);
    procedure GosOreAgente3PropertiesInitPopup(Sender: TObject);
    procedure GosOreAgente4PropertiesInitPopup(Sender: TObject);
    procedure GosOreAgentePropertiesEditValueChanged(Sender: TObject);
    procedure GosOreAgente2PropertiesEditValueChanged(Sender: TObject);
    procedure GosOreAgente3PropertiesEditValueChanged(Sender: TObject);
    procedure GosSpeseAgentePropertiesInitPopup(Sender: TObject);
    procedure GosSpeseAgente2PropertiesInitPopup(Sender: TObject);
    procedure GosSpeseAgente3PropertiesInitPopup(Sender: TObject);
    procedure GosSpeseAgente4PropertiesInitPopup(Sender: TObject);
    procedure GosSpeseAgentePropertiesEditValueChanged(Sender: TObject);
    procedure GosSpeseAgente2PropertiesEditValueChanged(Sender: TObject);
    procedure GosSpeseAgente3PropertiesEditValueChanged(Sender: TObject);
    procedure TipoSoggettoPropertiesInitPopup(Sender: TObject);
    procedure PrmBancaPropertiesInitPopup(Sender: TObject);
    procedure DocSubSogg1PropertiesInitPopup(Sender: TObject);
    procedure EditClientiSubSogg1PropertiesInitPopup(Sender: TObject);
    procedure Apriildocumentorelativoallascadenza1Click(Sender: TObject);
    procedure ApriDocumento(const DocType: String; const DocNum: Integer; const Registro: String; const DocDate: TDateTime; const DocID: Integer);
    procedure Annullapresentazioneallincassodellescadenzaselezionate1Click(Sender: TObject);
    procedure N1volta1Click(Sender: TObject);
    procedure editArtCategoria1PropertiesInitPopup(Sender: TObject);
    procedure tvLFPREZZODILISTINOGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: string);
    procedure tvLFCODICEARTICOLOFORNITOREGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: string);
    procedure QryAgendaBeforePost(DataSet: TDataSet);
    procedure Agenda_NormalSelectionModeIsWorkTime(Sender: TObject; AResource: TcxSchedulerStorageResourceItem; const ATime: TDateTime; var AIsWork: Boolean);
    procedure SpeedButton17Click(Sender: TObject);
    procedure SpeedButton18Click(Sender: TObject);
    procedure SpeedButton19Click(Sender: TObject);
    procedure SpeedButton23Click(Sender: TObject);
    procedure SpeedButton20Click(Sender: TObject);
    procedure StampaADAgiornaledimagazzino1Click(Sender: TObject);
    procedure SpeedButton25Click(Sender: TObject);
    procedure SpeedButton24Click(Sender: TObject);
    procedure SpeedButtonFiltersClick(Sender: TObject);
    procedure SpeedButton28Click(Sender: TObject);
    procedure SpeedButton27Click(Sender: TObject);
    procedure StampaADADocumentiClick(Sender: TObject);
    procedure PivotGridDocDblClick(Sender: TObject);
    procedure PivotGridGMDblClick(Sender: TObject);
    procedure PageControlDocPageChanging(Sender: TObject; NewPage: TcxTabSheet; var AllowChange: Boolean);
    procedure PageControlGMPageChanging(Sender: TObject; NewPage: TcxTabSheet; var AllowChange: Boolean);
    procedure cxPageControlGOSOrePageChanging(Sender: TObject; NewPage: TcxTabSheet; var AllowChange: Boolean);
    procedure cxPageControlGOSSpesePageChanging(Sender: TObject; NewPage: TcxTabSheet; var AllowChange: Boolean);
    procedure Stampagraficocantiere1Click(Sender: TObject);
    procedure QryScadCalcFields(DataSet: TDataSet);
    procedure PageControlScadPageChanging(Sender: TObject; NewPage: TcxTabSheet; var AllowChange: Boolean);
    procedure Stampagraficoscadenze1Click(Sender: TObject);
    procedure QryGOSOreCalcFields(DataSet: TDataSet);
    procedure QryGOSSpeseCalcFields(DataSet: TDataSet);
    procedure SpeedButton5Click(Sender: TObject);
    procedure SpeedButton6Click(Sender: TObject);
    procedure SpeedButton26Click(Sender: TObject);
    procedure SpeedButton29Click(Sender: TObject);
    procedure Stampagraficodocumenti1Click(Sender: TObject);
    procedure StampaADAscadenze1Click(Sender: TObject);
    procedure Stampagraficogiornaledimagazzino1Click(Sender: TObject);
    procedure SpeedButton13Click(Sender: TObject);
    procedure SpeedButton14Click(Sender: TObject);
    procedure SpeedButton30Click(Sender: TObject);
    procedure SpeedButton31Click(Sender: TObject);
    procedure SpeedButtonDataRowHeightClick(Sender: TObject);
    procedure Notificadiscarto1Click(Sender: TObject);
    procedure Accettatadalprovider1Click(Sender: TObject);
    procedure Rifiutatadalprovider1Click(Sender: TObject);
    procedure Notificadiaccettazione1Click(Sender: TObject);
    procedure Notificadimancataconsegna1Click(Sender: TObject);
    procedure Attestazionediavvenutatrasmissioneconimpossibilitdirecapito1Click(Sender: TObject);
    procedure Notificadidecorrenzatermini1Click(Sender: TObject);
    procedure tvDocFE_STATUSCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
    procedure Notifica1giorno1Click(Sender: TObject);
    procedure NotificaesitofatturaaccettataSDI1Click(Sender: TObject);
    procedure NotificaesitofatturarifiutataSDI1Click(Sender: TObject);
    procedure Importafatturaelettronicapassivaacquisto1Click(Sender: TObject);
    procedure TabDocumentiDragOver(Sender, Source: TObject; X, Y: Integer; State: TDragState; var Accept: Boolean);
    procedure DocVenditeClickCheck(Sender: TObject; AIndex: Integer; APrevState, ANewState: TcxCheckBoxState);
    procedure DocVenditeExit(Sender: TObject);
    procedure DocVenditeMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure GMVenditeMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
    procedure Button8Click(Sender: TObject);
    procedure QrySoggettiBeforeDelete(DataSet: TDataSet);
    procedure QryPraticheBeforeDelete(DataSet: TDataSet);
    procedure EditArtFornitorePropertiesInitPopup(Sender: TObject);
    procedure tvDocTcxGridDBDataControllerTcxDataSummaryFooterSummaryItems0GetText(Sender: TcxDataSummaryItem; const AValue: Variant; AIsFooter: Boolean; var AText: string);
    procedure SBCollapseGOSoreClick(Sender: TObject);
    procedure SBExpandGOSoreClick(Sender: TObject);
    procedure SBFilterRowGOSoreClick(Sender: TObject);
    procedure SBCollapseGOSspeseClick(Sender: TObject);
    procedure SBExpandGOSspeseClick(Sender: TObject);
    procedure SBFilterRowGOSspeseClick(Sender: TObject);
    procedure Fatturachiamateappuntamentiinterventiselezionati2Click(Sender: TObject);
    procedure RxSpeedButtonFaxClick(Sender: TObject);

  private
    // Mantiene il collegamento alla WindowsProcedure originale della
    FOriginalPanelWindowProc_Documenti: TWndMethod;

    fDocFilter_Operatore_Visible: Boolean;
    fDocFilter_Causale_Visible: Boolean;
    fDocFilter_SoloIlRegistro_Visible: Boolean;
    fDocFilter_TipiDocSbTuttiNessuno_Visible: Boolean;
    fDocFilter_Agente_Visible: Boolean;
    fDocFilter_SoloConStato_Visible: Boolean;
    fDocFilter_ConCantiere_Visible: Boolean;
    fDocFilter_TipiDocAltri_Visible: Boolean;
    fDocFilter_TuttiTranneIlRegitro_Visible: Boolean;
    fDocFilter_TipiDocVendita_Visible: Boolean;
    fDocFilter_TipoSoggetto_Visible: Boolean;
    fArtFilter_Magazzino_Visible: Boolean;
    fArtFilter_SoloArticoliComposti_Visible: Boolean;
    fArtFilter_DataMagazzino_Visible: Boolean;
    fArtFilter_Ubicazione_Visible: Boolean;
    fArtFilter_SoloArticoliMovimentati_Visible: Boolean;
    fArtFilter_SoloGiacenzaAttiva_Visible: Boolean;
    fFilter_Visible_CategCant1: Boolean;
    fFilter_Visible_CategCant2: Boolean;
    fFilter_Visible_CategCant3: Boolean;
    fFilter_Visible_CategCant4: Boolean;
    fFilter_Visible_CategCant5: Boolean;
    fFilter_Visible_CategCant6: Boolean;
    fTotaliArtMag_Giacenza: Double;
    fTotaliArtMag_Impegnato: Double;
    fTotaliArtMag_Ordinato: Double;
    fTotaliArtMag_Disponibile: Double;
    fDocFilter_Descrizione_Visible: Boolean;
    fDocFilter_CodiceArticolo_Visible: Boolean;

    // Form mappe
    fMapFormRubrica: TGmapForm;
    fMapFormPratiche: TGmapForm;
    fMapFormImpegni: TGmapForm;
    fMapFormAssistenze: TGmapForm;

    // Riferimento globale al frame dei grafici
    FChartDoc: TChartFrame;
    FChartGM: TChartFrame;
    FChartScad: TChartFrame;

    // =========================================================================
    // PARTE DELL'AGENDA
    // -------------------------------------------------------------------------
    // Puntatore alla form dell'Agenda laterale relativa a questa form stessa
    fAgendaForm: TAgendaSlideForm;
    // =========================================================================
    // PARTE DELLA FORM ALLEGATI
    // -------------------------------------------------------------------------
    // Puntatore alla form degli Allegati relativa a questa form stessa
    fAllegatiForm: TAllegatiForm;
    fFilter_Visible_SubSogg2: Boolean;
    fFilter_Visible_SubSogg3: Boolean;
    fFilter_Visible_SubSogg1: Boolean;
    fFilter_Visible_SubSogg4: Boolean;
    fArtFilter_Categoria2_Caption: String;
    fArtFilter_Categoria3_Caption: String;
    fArtFilter_Categoria1_Caption: String;

    FddtItem: IddtDocTypeItem;

    // =========================================================================
    // PARTE DELLA FORM AGENDA SLIDE
    // -------------------------------------------------------------------------
    procedure Agenda_CreaForm;
    procedure Agenda_VerificaAbilitazione;
    // =========================================================================
    // PARTE DELLA FORM ALLEGATI
    // -------------------------------------------------------------------------
    procedure Allegati_AggiornaDatiFiltri;
    procedure Allegati_CreaForm;
    procedure Allegati_VerificaAbilitazione;
    // =========================================================================

    function SoloRIBANellaSelezione: Boolean;
    procedure CreaNuovoLDEDaBacheca;
    procedure CreaNuovaConformitaDaBacheca_OLD;
    procedure CaricaSubMenuExtDoc;
    function GMDocIsChecked(IndiceDoc: Integer): Boolean;
    function GMNessunDocumentoSelezionato: Boolean;
    procedure ControllaSeVisualizzareTotaliRitenuteAcconto;
    procedure EseguiQueryRappGiorn(QryDoc: TIBOQuery);
    procedure EseguiQueryGOSOre;
    procedure PopolaGraficoOreGOS;
    function ChartSeriesByDisplayText(C: TcxGridChartView; T: String): TcxGridChartSeries;
    procedure ImpostaTitoloGraficoDipendenti;
    procedure EseguiQueryGOSSpese;
    procedure PopolaGraficoSpeseGOS;
    procedure ImpostaTitoloGraficoSpese;
    procedure AggiungiCondizioniWhereGosOre(Q: TIBOQuery);
    procedure AggiungiCondizioniWhereGosSpese(Q: TIBOQuery);
    procedure CheckForUnionAll(QryDoc: TIBOQuery);
    procedure VaiAlTabDopoAvvio;
    procedure AddWhereConditionsForDocSel(Q: TIBOQuery);
    procedure EseguiQueryPrimanota;
    procedure EliminaImpegniSelezionati;
    function GetCurrentGrid: TcxControl;
    procedure RicalcolaDimensioni;
    procedure StampaInventarioUltimoCostoSuStampanteAghi;
    procedure CaricaTitoli;
    procedure TrovaDocumentiSelezionati;
    procedure TrovaDocumentiSelezionati2;
    function InterventiNellaSelezione: Boolean;
    procedure SetFilterPanelForLevanteLight(P: TPanel);
    procedure SetDocFilter_Agente_Visible(const Value: Boolean);
    procedure SetDocFilter_Causale_Visible(const Value: Boolean);
    procedure SetDocFilter_ConCantiere_Visible(const Value: Boolean);
    procedure SetDocFilter_Operatore_Visible(const Value: Boolean);
    procedure SetDocFilter_SoloConStato_Visible(const Value: Boolean);
    procedure SetDocFilter_SoloIlRegistro_Visible(const Value: Boolean);
    procedure SetDocFilter_TipiDocAltri_Visible(const Value: Boolean);
    procedure SetDocFilter_TipiDocSbTuttiNessuno_Visible(const Value: Boolean);
    procedure SetDocFilter_TipiDocVendita_Visible(const Value: Boolean);
    procedure SetDocFilter_TipoSoggetto_Visible(const Value: Boolean);
    procedure SetDocFilter_TuttiTranneIlRegitro_Visible(const Value: Boolean);
    procedure SetArtFilter_DataMagazzino_Visible(const Value: Boolean);
    procedure SetArtFilter_Magazzino_Visible(const Value: Boolean);
    procedure SetArtFilter_SoloArticoliComposti_Visible(const Value: Boolean);
    procedure SetArtFilter_SoloArticoliMovimentati_Visible(const Value: Boolean);
    procedure SetArtFilter_SoloGiacenzaAttiva_Visible(const Value: Boolean);
    procedure SetArtFilter_Ubicazione_Visible(const Value: Boolean);
    procedure CaricaLayoutLevanteLight;
    procedure SetNotExportedDocSel;
    procedure SetNotExportedPrimanotaSel;
    procedure SetFilter_Visible_CategCant1(const Value: Boolean);
    procedure SetFilter_Visible_CategCant2(const Value: Boolean);
    procedure SetFilter_Visible_CategCant3(const Value: Boolean);
    procedure SetFilter_Visible_CategCant4(const Value: Boolean);
    procedure SetFilter_Visible_CategCant5(const Value: Boolean);
    procedure SetFilter_Visible_CategCant6(const Value: Boolean);
    function GetDataFiltroRicerca: TDateTime;
    procedure CaricaSubMenuAltreEsportazioniArticoli;
    procedure SetDocFilter_Descrizione_Visible(const Value: Boolean);
    procedure SetDocFilter_CodiceArticolo_Visible(const Value: Boolean);
    procedure CreaMappaImpegni;
    procedure CreaMappaRubrica;
    procedure CreaMappaPratiche;
    procedure SelezionaPratica(Prat_ID: Integer);
    procedure SelezionaSoggetto(Sogg_ID: Integer);
    procedure SetAgenda_SlideEnabled(const Value: Boolean);
    function GetAgenda: TcxScheduler;
    function GetAgenda_EventiSelezionatiPresenti: Boolean;
    function GetAgenda_TasksSelezionatiPresenti: Boolean;
    procedure SetFocusOnTrova(OpenCloseFilters: Boolean = False);
    procedure SetFilter_Visible_SuubSogg1(const Value: Boolean);
    procedure SetFilter_Visible_SuubSogg2(const Value: Boolean);
    procedure SetFilter_Visible_SuubSogg3(const Value: Boolean);
    procedure SetFilter_Visible_SuubSogg4(const Value: Boolean);
    procedure AnnullaPresentazioneIncassoScadenzeSelezionate;
    procedure DuplicaCantiere(CantTipo: String; CantNum: Integer; CantDataApertura: TDateTime; Copie: Integer);
    procedure SetArtFilter_Categoria1_Caption(const Value: String);
    procedure SetArtFilter_Categoria2_Caption(const Value: String);
    procedure SetArtFilter_Categoria3_Caption(const Value: String);
    procedure CreaNotificaDemoFE(ResponseType, FileName, MsgCode, MsgText, MsgRaw: String; CheckForNotification: Boolean; NotificationWaitDays: Integer);
    procedure RetroDataNotificaDemoFE(Giorni: Integer);
    // Charts
    procedure ShowDocChart;
    procedure ShowGMChart;
    procedure ShowScadenzeChart;

    // PArte per il Drag & Drop delle fatture elettroniche passive dall'esterno
    procedure GridDocWindowProc(var Msg: TMessage);
    procedure GridDocFileDrop(var Msg: TWMDROPFILES);

    { Private declarations }
  public
    { Public declarations }
    ID_ClienteCorrente: Integer;
    ClienteCorrente, RagSocCS, TelefonoCS, CellulareCS, PraticaCorrente: String;
    FidoConcesso: Currency;
    // Contengono tutti i parametri della pratica corrente
    ID_PraticaCorrente: Integer;
    TipoPraticaCorrente, DescPraticaCorrente, DataPraticaCorrente, DataPraticaCorrenteSQL, ComunePraticaCorrente, IndirizzoPraticaCorrente: String;
    PrecPaginaCorrente: Integer;
    // Array che contengono gli indici dei che dei documenti attivi per la visualizzazione dei filtri
    // dell'elenco dei documenti.
    DocumentiAttivi: array [1 .. 3] of array [1 .. 15] of Shortint;
    // Dataset per la visualizzazione del dettaglio delle griglie delle grilie pivot
    GosOrePivotTmpDataset: TcxCustomDataSource;

    // Propriet che punta alla form della mappa
    property MapFormRubrica: TGmapForm read fMapFormRubrica write fMapFormRubrica;
    property MapFormPratiche: TGmapForm read fMapFormPratiche write fMapFormPratiche;
    property MapFormImpegni: TGmapForm read fMapFormImpegni write fMapFormImpegni;
    property MapFormAssistenze: TGmapForm read fMapFormAssistenze write fMapFormAssistenze;

    // =========================================================================
    // Propriet per rendere visibili o meno alcuni filtri
    // -------------------------------------------------------------------------
    // Articoli
    property ArtFilter_Magazzino_Visible: Boolean read fArtFilter_Magazzino_Visible write SetArtFilter_Magazzino_Visible;
    property ArtFilter_Ubicazione_Visible: Boolean read fArtFilter_Ubicazione_Visible write SetArtFilter_Ubicazione_Visible;
    property ArtFilter_SoloGiacenzaAttiva_Visible: Boolean read fArtFilter_SoloGiacenzaAttiva_Visible write SetArtFilter_SoloGiacenzaAttiva_Visible;
    property ArtFilter_SoloArticoliMovimentati_Visible: Boolean read fArtFilter_SoloArticoliMovimentati_Visible
      write SetArtFilter_SoloArticoliMovimentati_Visible;
    property ArtFilter_SoloArticoliComposti_Visible: Boolean read fArtFilter_SoloArticoliComposti_Visible write SetArtFilter_SoloArticoliComposti_Visible;
    property ArtFilter_DataMagazzino_Visible: Boolean read fArtFilter_DataMagazzino_Visible write SetArtFilter_DataMagazzino_Visible;
    property ArtFilter_Categoria1_Caption: String read fArtFilter_Categoria1_Caption write SetArtFilter_Categoria1_Caption;
    property ArtFilter_Categoria2_Caption: String read fArtFilter_Categoria2_Caption write SetArtFilter_Categoria2_Caption;
    property ArtFilter_Categoria3_Caption: String read fArtFilter_Categoria3_Caption write SetArtFilter_Categoria3_Caption;
    // Documenti
    property DocFilter_CodiceArticolo_Visible: Boolean read fDocFilter_CodiceArticolo_Visible write SetDocFilter_CodiceArticolo_Visible;
    property DocFilter_Descrizione_Visible: Boolean read fDocFilter_Descrizione_Visible write SetDocFilter_Descrizione_Visible;
    property DocFilter_TipiDocSbTuttiNessuno_Visible: Boolean read fDocFilter_TipiDocSbTuttiNessuno_Visible write SetDocFilter_TipiDocSbTuttiNessuno_Visible;
    property DocFilter_TipiDocVendita_Visible: Boolean read fDocFilter_TipiDocVendita_Visible write SetDocFilter_TipiDocVendita_Visible;
    property DocFilter_TipiDocAltri_Visible: Boolean read fDocFilter_TipiDocAltri_Visible write SetDocFilter_TipiDocAltri_Visible;
    property DocFilter_Causale_Visible: Boolean read fDocFilter_Causale_Visible write SetDocFilter_Causale_Visible;
    property DocFilter_Operatore_Visible: Boolean read fDocFilter_Operatore_Visible write SetDocFilter_Operatore_Visible;
    property DocFilter_TipoSoggetto_Visible: Boolean read fDocFilter_TipoSoggetto_Visible write SetDocFilter_TipoSoggetto_Visible;
    property DocFilter_SoloIlRegistro_Visible: Boolean read fDocFilter_SoloIlRegistro_Visible write SetDocFilter_SoloIlRegistro_Visible;
    property DocFilter_Agente_Visible: Boolean read fDocFilter_Agente_Visible write SetDocFilter_Agente_Visible;
    property DocFilter_SoloConStato_Visible: Boolean read fDocFilter_SoloConStato_Visible write SetDocFilter_SoloConStato_Visible;
    property DocFilter_TuttiTranneIlRegitro_Visible: Boolean read fDocFilter_TuttiTranneIlRegitro_Visible write SetDocFilter_TuttiTranneIlRegitro_Visible;
    property DocFilter_ConCantiere_Visible: Boolean read fDocFilter_ConCantiere_Visible write SetDocFilter_ConCantiere_Visible;
    // Cantieri/Pratiche
    property Filter_Visible_CategCant1: Boolean read fFilter_Visible_CategCant1 write SetFilter_Visible_CategCant1;
    property Filter_Visible_CategCant2: Boolean read fFilter_Visible_CategCant2 write SetFilter_Visible_CategCant2;
    property Filter_Visible_CategCant3: Boolean read fFilter_Visible_CategCant3 write SetFilter_Visible_CategCant3;
    property Filter_Visible_CategCant4: Boolean read fFilter_Visible_CategCant4 write SetFilter_Visible_CategCant4;
    property Filter_Visible_CategCant5: Boolean read fFilter_Visible_CategCant5 write SetFilter_Visible_CategCant5;
    property Filter_Visible_CategCant6: Boolean read fFilter_Visible_CategCant6 write SetFilter_Visible_CategCant6;
    // SubSogg
    property Filter_Visible_SubSogg1: Boolean read fFilter_Visible_SubSogg1 write SetFilter_Visible_SuubSogg1;
    property Filter_Visible_SubSogg2: Boolean read fFilter_Visible_SubSogg2 write SetFilter_Visible_SuubSogg2;
    property Filter_Visible_SubSogg3: Boolean read fFilter_Visible_SubSogg3 write SetFilter_Visible_SuubSogg3;
    property Filter_Visible_SubSogg4: Boolean read fFilter_Visible_SubSogg4 write SetFilter_Visible_SuubSogg4;
    // =========================================================================

    // =========================================================================
    // INIZIO PARTE AGENDA
    // -------------------------------------------------------------------------
    // Rappresenta la form dell'agenda laterale se presente
    property AgendaForm: TAgendaSlideForm read fAgendaForm;
    // Propriet che ritorna l'oggetto agenda in uso in base alla madalit attuale (FastSelectionMode oppure NormalSelectionMode)
    property Agenda: TcxScheduler read GetAgenda;
    // Propriet che rende visibile/invisibile l'agenda laterale del FastSelectionMode
    property Agenda_SlideEnabled: Boolean write SetAgenda_SlideEnabled;
    // Propriet che ritorna True se ci sono degli eventi selezionati nell'Agenda laterale
    property Agenda_EventiSelezionatiPresenti: Boolean read GetAgenda_EventiSelezionatiPresenti;
    property Agenda_TasksSelezionatiPresenti: Boolean read GetAgenda_TasksSelezionatiPresenti;
    // -------------------------------------------------------------------------
    // FINE PARTE AGENDA
    // =========================================================================

    function ControllaScopertoCliente(DocType: String; DocNum: Integer; DocReg: String; DocDate: TDate; CodCli: String; ImportoDoc: Currency;
      VisualizzaMessaggio: Boolean): Boolean;
    function CalcolaScopertoCliente(DocType: String; DocNum: Integer; DocReg: String; DocDate: TDate; CodCli: String): Currency;
    procedure ImpostaFiltriScadenzePerVisualizzareSoloRibaDaPresentare;
    procedure MarcaScadenzeSelezionateComePresentate(Banca: String = '');
    procedure SelezionaSoggettoPratica(Sogg_ID: Integer = -1; Prat_ID: Integer = 0);
  end;

var
  ClientiForm: TClientiForm;

implementation

uses SchedaPreventiviOrdini,
  main, SchedaTesti, FormScadenziario,
  FormContatti, FormExtFile, FormAnagCli,
  FormConformita,
  FormHelp, SchedaArticoli1, FormAnagMaga,
  FormGruppi, FormAnagArt, FormCondVend,
  FormPrimanota, FormPagamRisc, FormPratica, FormSostArt,
  FormScambioDoc, FormImpegni, FormTecnici, QRListino, FormMultiregistro,
  DateUtils, FormConformWizard, cxGridDBDataDefinitions,
  unExportRiba, FormRappGiorn, FormDipendenti, FormLevanteListAnag,
  FormAutomezzi, FormGosOrePivotDetail, FormGosSpesePivot,
  FormStampeCantieri, cxGridExportLink, cxExportPivotGridLink,
  FormTabPartitario, FormTabGC, FormTabResord, QRIndiceCategorie, QRIndiceAlfabetico,
  QRIndiceFornitori, QRListinoNoBarCode, FormVariazioneOre,
  FormForzaGiacenzeMagazzino, DataModule2, FormTabImpianti,
  FormTabComunicazioni, FormMenuAggiungi,
  DataModuleStyles, FormEtichetteFastReport, System.Character,
  FormDocPivotDetail, FormGMPivotDetail, DForce.Mini.ei.Invoice.Factory,
  DForce.Mini.ei.Invoice.Interfaces, UnitLevanteEInvoice, ShellApi,
  DDT.Factory, FormConfirm, FormFatturaImpegni;

{$R *.DFM}

// =============================================================================
// INIZIO PARTE AGENDA
// -----------------------------------------------------------------------------
// Procedure che crea la form degli allegati se questa non esiste gi e la
// apre, alla fine esegue l'interrogazione per mostrare gli allegati.
procedure TClientiForm.Agenda_CreaForm;
begin
  // Se la form degli allegati non  stata ancora creata la crea.
  if not Assigned(fAgendaForm) then
  begin
    // Crea la form degli allegati
    fAgendaForm := MainForm.Agenda_CreaForm(Self.PanelAgendaRight);
    // Passa lo Splitter alla finestra degli allegati
    fAgendaForm.Splitter := SplitterAgendaRight;
    // Parte con lo splitter chiuso
    fAgendaForm.Splitter.CloseSplitter;
  end;
end;

// Procedure che determina se la form degli allegati debba essere aperta oppure no e inoltre
// determina anche se l'utente ha la possibilit di aprirla manualmente oppure no.
procedure TClientiForm.Agenda_VerificaAbilitazione;
begin
  // Negli elenchi gli allegati sono sempre attivi
  Agenda_CreaForm;
  fAgendaForm.Splitter.Enabled := True;
end;

// Function che ritorna True se ci sono degli eventi selezionati nell'Agenda laterale
function TClientiForm.GetAgenda_EventiSelezionatiPresenti: Boolean;
begin
  Result := False;
  if not Assigned(fAgendaForm) then
    Exit;
  Result := (fAgendaForm.Agenda_FastSelectionMode.SelectedEventCount > 0);
end;

function TClientiForm.GetAgenda_TasksSelezionatiPresenti: Boolean;
begin
  Result := False;
  if not Assigned(fAgendaForm) then
    Exit;
  Result := (fAgendaForm.btvTasks.Controller.SelectedRecordCount > 0);
end;

function TClientiForm.GetAgenda: TcxScheduler;
begin
  if DM1.FastSelectionMode then
    Result := fAgendaForm.Agenda_FastSelectionMode
  else
    Result := Self.Agenda_NormalSelectionMode;
end;

procedure TClientiForm.SetAgenda_SlideEnabled(const Value: Boolean);
begin
  SplitterAgendaRight.Visible := Value;
  PanelAgendaRight.Visible := Value;
end;
// -----------------------------------------------------------------------------
// FINE PARTE AGENDA
// =============================================================================

// =============================================================================
// INIZIO PARTE PER GESTIONE DEGLI ALLEGATI
// -----------------------------------------------------------------------------
// Procedure che crea la form degli allegati se questa non esiste gi e la
// apre, alla fine esegue l'interrogazione per mostrare gli allegati.
procedure TClientiForm.Allegati_CreaForm;
begin
  // Se la form degli allegati non  stata ancora creata la crea.
  if not Assigned(fAllegatiForm) then
  begin
    // Crea la form degli allegati
    fAllegatiForm := MainForm.Allegati_CreaForm(PanelAllegati);
    // Passa lo Splitter alla finestra degli allegati
    fAllegatiForm.Splitter := SplitterAllegati;
    // Parte con lo splitter chiuso
    SplitterAllegati.CloseSplitter;
  end;
  // Imposta i filtri
  Allegati_AggiornaDatiFiltri;
end;

// Procedure che aggiorna i filtri di collegamento della form degli allegati
// con la form attuale
procedure TClientiForm.Allegati_AggiornaDatiFiltri;
begin
  // Ovviamente se la form degli allegati  chiusa esce subito
  if fAllegatiForm = nil then
    Exit;

  // Azzeramento filtri
  fAllegatiForm.AzzeraFiltri;

  // Codice soggetto
  if ClienteCorrente <> '' then
    fAllegatiForm.Filter_CodSogg := StrToInt(ClienteCorrente);

  // Codice Pratica
  if PraticaCorrente <> '' then
    fAllegatiForm.Filter_CodPrat := StrToInt(PraticaCorrente);
  // Data Pratica
  if DataPraticaCorrente <> '' then
    fAllegatiForm.Filter_DataPrat := StrToDate(DataPraticaCorrente);

  // Imposta i filtri
  fAllegatiForm.ImpostaFiltri;

  // Effettua l'interrogazione
  fAllegatiForm.EseguiQuery;
end;

// Procedure che determina se la form degli allegati debba essere aperta oppure no e inoltre
// determina anche se l'utente ha la possibilit di aprirla manualmente oppure no.
procedure TClientiForm.Allegati_VerificaAbilitazione;
begin
  // Negli elenchi gli allegati sono sempre attivi
  Allegati_CreaForm;
  SplitterAllegati.Enabled := True;
end;

// -----------------------------------------------------------------------------
// FINE PARTE PER GESTIONE DEGLI ALLEGATI
// =============================================================================













// =============================================================================
// INIZIO - QUERY PER INTERROGAZIONE PARTITARIO E RELATIVI TOTALI
// -----------------------------------------------------------------------------

function TClientiForm.CalcolaScopertoCliente(DocType: String; DocNum: Integer; DocReg: String; DocDate: TDate; CodCli: String): Currency;
var
  Q: TIB_Cursor;
  TmpTotDare, TmpTotAvere: Currency;
begin
  // Inizializzazione
  TmpTotDare := 0;
  TmpTotAvere := 0;
  Result := 0;
  Q := TIB_Cursor.Create(nil);
  try
    Q.DatabaseName := DM1.ArcDBFile;
    Q.IB_Connection := DM1.DBAzienda;
    // NB: IL filltro per bancha non esiste per i documenti, se l'utente
    // specifica un filtraggio per banca non carica i documenti per niente
    // =========================================================================
    // TOTALE DARE DOCUMENTI
    // -------------------------------------------------------------------------
    Q.SQL.Clear;
    Q.SQL.Add('SELECT SUM(T.TOTALEDAPAGARE)');
    Q.SQL.Add('FROM PRVORDCL T');
    Q.SQL.Add('WHERE (T.TIPODOCUMENTO = ''Fattura''');
    Q.SQL.Add('       OR T.TIPODOCUMENTO = ''Fatt.R.F.''');
    Q.SQL.Add('       OR T.TIPODOCUMENTO = ''N.C.fornit''');
    if DM1.ConsideraDdtNelFido then
      Q.SQL.Add('OR (T.TIPODOCUMENTO = ''D.D.T.''   AND   T.DAFATTURARE = ''F'')');
    Q.SQL.Add('      )');
    Q.SQL.Add(' AND NOT (T.TipoDocumento = ''' + DocType + ''' AND T.NumOrdPrev = ' + IntToStr(DocNum) + ' AND T.Registro = ''' + DocReg +
      ''' AND T.DataDocumento = ''' + FormatDateTime('mm/dd/yyyy', DocDate) + ''')');
    Q.SQL.Add(' AND T.CodiceCliente = ' + CodCli);
    // Apertura
    Q.Open;
    TmpTotDare := Q.Fields[0].AsCurrency;
    Q.Close;
    // =========================================================================

    // =========================================================================
    // TOTALE AVERE DOCUMENTI
    // -------------------------------------------------------------------------
    Q.SQL.Clear;
    Q.SQL.Add('SELECT SUM(T.TOTALEDAPAGARE)');
    Q.SQL.Add('FROM PRVORDCL T');
    Q.SQL.Add('WHERE (T.TIPODOCUMENTO = ''Fatt.acqui''');
    Q.SQL.Add('       OR T.TIPODOCUMENTO = ''Nota_accre''');
    Q.SQL.Add('      )');
    Q.SQL.Add(' AND NOT (T.TipoDocumento = ''' + DocType + ''' AND T.NumOrdPrev = ' + IntToStr(DocNum) + ' AND T.Registro = ''' + DocReg +
      ''' AND T.DataDocumento = ''' + FormatDateTime('mm/dd/yyyy', DocDate) + ''')');
    Q.SQL.Add(' AND T.CodiceCliente = ' + CodCli);
    // Apertura
    Q.Open;
    TmpTotAvere := Q.Fields[0].AsCurrency;
    Q.Close;
    // =========================================================================

    // =========================================================================
    // TOTALE DARE/AVERE PRIMANOTA
    // -------------------------------------------------------------------------
    Q.SQL.Clear;
    Q.SQL.Add(
      'SELECT SUM(P.CASSAENTRATE) AS CASSAENTRATE, SUM(P.CASSAUSCITE) AS CASSAUSCITE, SUM(P.FUORIENTRATE) AS FUORIENTRATE, SUM(P.FUORIUSCITE) AS FUORIUSCITE, SUM(P.ABBUONIATTIVI) AS ABBUONIATTIVI, SUM(P.ABBUONIPASSIVI) AS ABBUONIPASSIVI');
    Q.SQL.Add('FROM PRIMANOT P');
    Q.SQL.Add('WHERE 1=1');
    Q.SQL.Add(' AND P.Cliente = ' + CodCli);
    // Apertura
    Q.Open;
    TmpTotAvere := TmpTotAvere + Q.FieldByName('CASSAENTRATE').AsCurrency + Q.FieldByName('FUORIENTRATE').AsCurrency + Q.FieldByName('ABBUONIPASSIVI')
      .AsCurrency;
    TmpTotDare := TmpTotDare + Q.FieldByName('CASSAUSCITE').AsCurrency + Q.FieldByName('FUORIUSCITE').AsCurrency + Q.FieldByName('ABBUONIATTIVI').AsCurrency;
    Q.Close;
    // =========================================================================

    // Calcola lo scoperto attuale del cliente
    Result := TmpTotDare - TmpTotAvere;

    // Chiusura finale
  finally
    if Q.Active then
      Q.Close;
    Q.Free;
  end;
end;

function TClientiForm.ControllaScopertoCliente(DocType: String; DocNum: Integer; DocReg: String; DocDate: TDate; CodCli: String; ImportoDoc: Currency;
  VisualizzaMessaggio: Boolean): Boolean;
var
  Q: TIB_Cursor;
  TmpTotScoperto, TmpImportoFidoConcesso: Currency;
begin
  // Inizializzazione
  TmpTotScoperto := 0;
  TmpImportoFidoConcesso := 0;
  Result := False;
  // Il controllo ha senso solo se sitmao facendo un documento di vendita
  if (DocType = 'Fattura') or (DocType = 'Fatt.R.F.') or (DocType = 'N.C.fornit') or ((DocType = 'D.D.T.') and (DM1.ConsideraDdtNelFido)) then
  begin
    // Inizializza la query
    Q := TIB_Cursor.Create(nil);
    try
      Q.DatabaseName := DM1.ArcDBFile;
      Q.IB_Connection := DM1.DBAzienda;

      // =========================================================================
      // CARICA L'IMPORTO DI FIDO CONCESSO AL CLIENTE
      // -------------------------------------------------------------------------
      Q.SQL.Add('SELECT IMPORTOFIDO');
      Q.SQL.Add('FROM CLIENTI C');
      Q.SQL.Add('WHERE CODICE = ' + CodCli);
      // Apertura
      Q.Open;
      // Caricamento del fido concesso in una variabile locale per comodit
      if not Q.Eof then
        TmpImportoFidoConcesso := Q.Fields[0].AsCurrency;
      Q.Close;
      // =========================================================================

      // Calcola lo scoperto attuale del cliente
      TmpTotScoperto := CalcolaScopertoCliente(DocType, DocNum, DocReg, DocDate, CodCli) + ImportoDoc;

      // Eseguq il controllo
      if (TmpTotScoperto > TmpImportoFidoConcesso) and (TmpImportoFidoConcesso <> 0) then
      begin
        Result := True;
        if VisualizzaMessaggio then
        begin
          // Se il cliente ha sforato il fido visualizza un messaggio di avvertimento
          if DM1.Messaggi('ATTENZIONE !!! - Controllo fido cliente',
            'FIDO SUPERATO !!!'#13#13'Il debito accumulato dal soggetto ha superato l''importo del fido concesso.'#13#13#13'CONFERMARE UGUALMENTE IL DOCUMENTO?',
            '', [mbYes, mbNo], 0, nil) = mrYes then
            Result := False;
          // Se abilitato, richiede una password per sbloccare il documento e andare avanti anche fuori fido
          if not Result then
          begin
            Result := not DM1.VerificaPassword(DM1.TableProgressiviPSWD_FIDO.AsString);
          end;
        end;
      end;

      // Chiusura finale
    finally
      if Q.Active then
        Q.Close;
      Q.Free;
    end;
  end;
end;


// -----------------------------------------------------------------------------
// FINE - QUERY PER INTERROGAZIONE PARTITARIO E RELATIVI TOTALI
// =============================================================================

// Procedura che elabora il codice a barre ricevuto
procedure TClientiForm.ProcessBarcode(Barcode: String);
var
  TipoCodice, TipoDocumento, DocTipo, DocReg: String;
  TmpInt, DocNum: Integer;
  DocData: TDateTime;
begin
  // NB: HO tolto ShowWait perch altrimenti su Vista quando si leggeva
  // un codice a barre l'applicazione perdeva il focus e mi causava problemi
  // DM1.ShowWait('Levante', 'Elaborazione codice a barre...');
  DM1.Attendere;
  try
    // Ricava il tipo di codice letto
    TipoCodice := LeftStr(Barcode, 1);
    // In base al tipo di codice letto...
    if (TipoCodice = BARCODE_TIPOCODICE_DOCUMENTO) then
    begin
      // =========================================================================
      // DOCUMENTI
      // -------------------------------------------------------------------------
      // Ricava il tipo di documento letto
      TipoDocumento := Barcode[2];
      // Se  stato letto un INTERVENTO/CHIAMATA/APPUNTAMENTO
      if (TipoDocumento = BARCODE_DOC_INTERVENTO) then
      begin

        // Depura il codice a barre letto dai primi due caratteri
        Barcode := MidStr(Barcode, 3, 1000);
        // Apre il documento
        if TryStrToInt(Barcode, TmpInt) then
        begin
          if DM1.ModCtrl(MOD_CONTATTI) > 0 then
          begin
            Application.CreateForm(TImpegnoForm, ImpegnoForm);
            ImpegnoForm.Parent := MainForm;
            ImpegnoForm.CurrentID := TmpInt;
            ImpegnoForm.Tag := 1;
            ImpegnoForm.Show;
          end;
        end;

        // Se invece  un altro tipo di documento...
      end
      else
      begin

        // Carica il alcune variabili locali i dati di identificazione del documento
        DM1.DocBarCodeToDocData(Barcode, DocTipo, DocNum, DocReg, DocData);
        if DocTipo = '' then
          raise Exception.Create('Documento non trovato!');
        // Verifica i permessi e poi apre
        if DM1.ControllaDocumento(DocTipo) > 0 then
          DM1.ApriDocFisc(DocTipo, DocNum, DocReg, DocData, False)
        else
          raise Exception.Create('Accesso non consentito!');

      end;
      // =========================================================================
    end;
  finally
    // DM1.CloseWait;
    DM1.ChiudiAttendere;
  end;
end;

// Procedura che modifica l'apparenza dei filtri per adattarli alla modalit
// LevanteLight e cio abbassa il pannello dei filtri di ricerca per occupare meno spazio
// e sposta verso l'alto tutti i componenti facendo sparire il campo "Trova" e la freccia.
procedure TClientiForm.SetFilterPanelForLevanteLight(P: TPanel);
const
  DIMINUZIONE_PANNELLO = 30;
var
  I: Integer;
begin
  for I := 0 to P.ControlCount - 1 do
  begin
    P.Controls[I].Top := P.Controls[I].Top - DIMINUZIONE_PANNELLO;
  end;
  P.Height := P.Height - DIMINUZIONE_PANNELLO;
end;

// Apre il pannello dei filtri di ricerca
procedure TClientiForm.OpenFilterPanel(P: TPanel; B: TSpeedButtonRollOver; Animation: Boolean = False);
const
  ANIM_STEP = 50;
var
  I, BottomCoord, HeightOpened: Integer;
begin
  // Se siamo in modalit Levante Light disattiva sempre l'animazione
  Animation := Animation and (not MainForm.IsLevanteLight);
  // Ricava la dimensione del pannello aperto
  HeightOpened := 0;
  for I := 0 to P.ControlCount - 1 do
  begin
    BottomCoord := P.Controls[I].Top + P.Controls[I].Height;
    if BottomCoord > HeightOpened then
      HeightOpened := BottomCoord;
  end;
  // Carica la bitmap del pulsante
  B.Glyph.LoadFromFile(DM1.TemaDir + 'FiltersClose.bmp');
  // Eventuale animazione
  if Animation then
  begin
    while P.Height < HeightOpened do
    begin
      P.Height := P.Height + ANIM_STEP;
      P.Update;
    end;
  end;
  // Dimensioni finali del pannello
  P.Height := HeightOpened;
  // Se siamo in Levante Light corregge la visualizzazione del pannello in modo appropriato
  if MainForm.IsLevanteLight then
    SetFilterPanelForLevanteLight(P);
  // Aggiorna lo schermo
  P.Update;
  P.Tag := 1;
end;

// Apre il pannello dei filtri di ricerca
procedure TClientiForm.CloseFilterPanel(P: TPanel; B: TSpeedButtonRollOver; Animation: Boolean = False);
const
  CLOSED_HEIGHT = 34;
  ANIM_STEP = 50;
var
  I: Integer;
begin
  // Carica la bitmap del pulsante
  B.Glyph.LoadFromFile(DM1.TemaDir + 'FiltersOpen.bmp');
  // Eventuale animazione
  if Animation then
  begin
    while P.Height > CLOSED_HEIGHT do
    begin
      P.Height := P.Height - ANIM_STEP;
      P.Update;
    end;
  end;
  // Dimensioni finali del pannello
  P.Height := CLOSED_HEIGHT;
  P.Update;
  P.Tag := -1;
end;

// Questa procedura modifica in solo lo stato della consegna dei documento selezionati
// impostandoli come "Consegnati"
procedure TClientiForm.SetConsegnatoDocSel;
var
  SelRec, I: Longint;
begin
  // Chiede prima conserma
  if DM1.Messaggi('Consegna', 'Marcare i documenti selezionati come "Consegnati"?', '', [mbYes, mbNo], 0, nil) <> mrYes then
    Exit;
  DM1.ShowWait('Consegna', 'Consegna documenti in corso...');
  DM1.DBAzienda.StartTransaction;
  try
    try
      // SelRec contiene il numeero di records selezionati
      SelRec := ClientiForm.tvDoc.Controller.SelectedRecordCount;
      // Ovviamente procede solo se vi sono documenti selezionati
      if SelRec = 0 then
        Exception.Create('Non ci sono documenti selezionati.');
      // Cicla per tutti i documenti selezionati e li esporta
      for I := 0 to SelRec - 1 do
      begin
        // Focus sul record attuale
        ClientiForm.tvDoc.Controller.SelectedRecords[I].Focused := True;
        // Cambiamento stato del documento attuale
        DM1.SetConsegnatoDocumento(tvDoc.Controller.FocusedRow.Values[tvDoc.GetColumnByFieldName('TIPODOC').Index],
          tvDoc.Controller.FocusedRow.Values[tvDoc.GetColumnByFieldName('REGISTRO').Index],
          tvDoc.Controller.FocusedRow.Values[tvDoc.GetColumnByFieldName('CODICEDOC').Index],
          tvDoc.Controller.FocusedRow.Values[tvDoc.GetColumnByFieldName('DATADOC').Index]);
      end;
      DM1.DBAzienda.Commit;
    finally
      DM1.CloseWait;
    end;
  except
    DM1.DBAzienda.Rollback;
  end;
end;

// Questa procedura marca i documenti selezionati come NON esportati.
procedure TClientiForm.SetNotExportedDocSel;
var
  I, SelRec: Longint;
  TipoDoc, RegDoc: String;
  NumDoc: Integer;
  DataDoc: TDateTime;
begin
  // Chiede prima conserma
  if DM1.Messaggi('Levante', 'Marcare i documenti selezionati come "NON ESPORTATI"?', '', [mbYes, mbNo], 0, nil) <> mrYes then
    Exit;
  DM1.ShowWait('Levante', 'Operazione in corso...');
  DM1.DBAzienda.StartTransaction;
  try
    try
      // SelRec contiene il numeero di records selezionati
      SelRec := ClientiForm.tvDoc.Controller.SelectedRecordCount;
      // Ovviamente procede solo se vi sono documenti selezionati
      if SelRec = 0 then
        Exception.Create('Non ci sono documenti selezionati.');
      // Cicla per tutti i documenti selezionati e li esporta
      for I := 0 to SelRec - 1 do
      begin
        // Carica i dati identificativi del documento
        TipoDoc := ClientiForm.tvDoc.Controller.SelectedRecords[I].Values[tvDoc.GetColumnByFieldName('TIPODOC').Index];
        NumDoc := ClientiForm.tvDoc.Controller.SelectedRecords[I].Values[tvDoc.GetColumnByFieldName('CODICEDOC').Index];
        RegDoc := ClientiForm.tvDoc.Controller.SelectedRecords[I].Values[tvDoc.GetColumnByFieldName('REGISTRO').Index];
        DataDoc := ClientiForm.tvDoc.Controller.SelectedRecords[I].Values[tvDoc.GetColumnByFieldName('DATADOC').Index];
        // Solo se  uno dei tipi di documento supportato da questa funzionalit
        if (TipoDoc = 'Preventivo') or (TipoDoc = 'Ordine') or (TipoDoc = 'S.A.L.') or (TipoDoc = 'Buono_cons') or (TipoDoc = 'D.D.T.') or (TipoDoc = 'Fattura')
          or (TipoDoc = 'Ricev.fisc') or (TipoDoc = 'Fatt.R.F.') or (TipoDoc = 'Nota_accre') or (TipoDoc = 'Commessa') or (TipoDoc = 'Carico_cantiere') or
          (TipoDoc = 'Scarico_cantiere') or (TipoDoc = 'Estratto_conto') or (TipoDoc = 'Intervento') or (TipoDoc = 'Ord.fornit') or (TipoDoc = 'Bolla_entr') or
          (TipoDoc = 'Fatt.acqui') or (TipoDoc = 'N.C.fornit') then
        begin
          // Cambiamento stato del documento attuale
          DM1.SetNotExportedDoc(TipoDoc, RegDoc, NumDoc, DataDoc);
        end;
      end;
      DM1.DBAzienda.Commit;
    finally
      DM1.CloseWait;
    end;
  except
    DM1.DBAzienda.Rollback;
  end;
end;

procedure TClientiForm.SetNotExportedPrimanotaSel;
var
  I, SelRec: Longint;
  Codice: Integer;
  Data: TDateTime;
begin
  // Chiede prima conserma
  if DM1.Messaggi('Levante', 'Marcare i movimenti di primanota selezionati come "NON ESPORTATI"?', '', [mbYes, mbNo], 0, nil) <> mrYes then
    Exit;
  DM1.ShowWait('Levante', 'Operazione in corso...');
  DM1.DBAzienda.StartTransaction;
  try
    try
      // SelRec contiene il numeero di records selezionati
      SelRec := ClientiForm.tvPrimanota.Controller.SelectedRecordCount;
      // Ovviamente procede solo se vi sono documenti selezionati
      if SelRec = 0 then
        Exception.Create('Non ci sono movimenti di primanota selezionati.');
      // Cicla per tutti i documenti selezionati e li esporta
      for I := 0 to SelRec - 1 do
      begin
        // Carica i dati identificativi del documento
        Codice := ClientiForm.tvPrimanota.Controller.SelectedRecords[I].Values[tvPrimanota.GetColumnByFieldName('CODICE').Index];
        Data := ClientiForm.tvPrimanota.Controller.SelectedRecords[I].Values[tvPrimanota.GetColumnByFieldName('DATA').Index];
        // Imposta come non esportato il movimento di primanota corrente
        DM1.SetNotExportedPrimanota(Codice, Data);
      end;
      DM1.DBAzienda.Commit;
    finally
      DM1.CloseWait;
    end;
  except
    DM1.DBAzienda.Rollback;
  end;
end;

// Questa procedura modifica in solo colpo il registro di tutti i documenti selezionati
// al momento nell'elenco dei documenti.
procedure TClientiForm.SetRegistroDocumentiSelezionati(NuovoRegistro: String);
var
  SelRec, I, RI: Longint;
  TipoDoc: String;
begin
  DM1.ShowWait('Cambio Registro Documenti', 'Modifica registro documenti in corso...');
  DM1.DBAzienda.StartTransaction;
  try
    try
      // SelRec contiene il numeero di records selezionati
      SelRec := ClientiForm.tvDoc.Controller.SelectedRecordCount;
      // Ovviamente procede solo se vi sono documenti selezionati
      if SelRec = 0 then
        Exception.Create('Non ci sono documenti selezionati.');
      // Cicla per tutti i documenti selezionati e li esporta
      for I := 0 to SelRec - 1 do
      begin
        // Focus sul record attuale
        ClientiForm.tvDoc.Controller.SelectedRecords[I].Focused := True;
        // TipoDoc contiene il tipo documento corrente
        RI := tvDoc.DataController.FocusedRecordIndex;
        TipoDoc := tvDoc.DataController.DisplayTexts[RI, tvDocTIPODOC.Index];
        // Se  un Rapporto giornaliero righiama l'apposita procedura
        if TipoDoc = 'Rapp.giorn.' then
        begin
          // Cambiamento stato del documento attuale
          DM1.SetRegistroRappGiorn(tvDoc.Controller.FocusedRow.Values[tvDoc.GetColumnByFieldName('REGISTRO').Index],
            tvDoc.Controller.FocusedRow.Values[tvDoc.GetColumnByFieldName('CODICEDOC').Index],
            tvDoc.Controller.FocusedRow.Values[tvDoc.GetColumnByFieldName('DATADOC').Index], NuovoRegistro);
          // Altrimenti se  un Documento normale...
        end
        else
        begin
          // Cambiamento stato del documento attuale
          DM1.SetRegistroDocumento(tvDoc.Controller.FocusedRow.Values[tvDoc.GetColumnByFieldName('TIPODOC').Index],
            tvDoc.Controller.FocusedRow.Values[tvDoc.GetColumnByFieldName('REGISTRO').Index],
            tvDoc.Controller.FocusedRow.Values[tvDoc.GetColumnByFieldName('CODICEDOC').Index],
            tvDoc.Controller.FocusedRow.Values[tvDoc.GetColumnByFieldName('DATADOC').Index], NuovoRegistro);
        end;
      end;
      DM1.DBAzienda.Commit;
    finally
      DM1.CloseWait;
    end;
  except
    DM1.DBAzienda.Rollback;
  end;
end;

// Questa procedura modifica in solo colpo lo stato di tutte le scadenza selezionate
procedure TClientiForm.SetStatoPrimenoteSelezionate(NuovoStato: String);
var
  SelRec, I: Longint;
begin
  DM1.DBAzienda.StartTransaction;
  DM1.ShowWait('Stato Documenti', 'Modifica stati primanota in corso...');
  try
    try
      // SelRec contiene il numeero di records selezionati
      SelRec := ClientiForm.tvPrimanota.Controller.SelectedRecordCount;
      // Ovviamente procede solo se vi sono documenti selezionati
      if SelRec = 0 then
        Exception.Create('Non ci sono scadenze selezionate.');
      // Cicla per tutti i documenti selezionati e li esporta
      for I := 0 to SelRec - 1 do
      begin
        // Focus sul record attuale
        ClientiForm.tvPrimanota.Controller.SelectedRecords[I].Focused := True;
        // Cambiamento stato del documento attuale
        DM1.SetStatoPrimanota(tvPrimanota.Controller.FocusedRow.Values[tvPrimanota.GetColumnByFieldName('CODICE').Index],
          tvPrimanota.Controller.FocusedRow.Values[tvPrimanota.GetColumnByFieldName('DATA').Index], NuovoStato);
      end;
      DM1.DBAzienda.Commit;
    finally
      DM1.CloseWait;
    end;
  except
    DM1.DBAzienda.Rollback;
  end;
end;

// Questa procedura modifica in solo colpo lo stato di tutte le scadenza selezionate
procedure TClientiForm.SetStatoScadenzeSelezionate(NuovoStato: String);
var
  SelRec, I: Longint;
begin
  DM1.DBAzienda.StartTransaction;
  try
    try
      DM1.ShowWait('Stato Documenti', 'Modifica stati scadenze in corso...');
      // SelRec contiene il numeero di records selezionati
      SelRec := ClientiForm.tvScad.Controller.SelectedRecordCount;
      // Ovviamente procede solo se vi sono documenti selezionati
      if SelRec = 0 then
        Exception.Create('Non ci sono scadenze selezionate.');
      // Cicla per tutti i documenti selezionati e li esporta
      for I := 0 to SelRec - 1 do
      begin
        // Focus sul record attuale
        ClientiForm.tvScad.Controller.SelectedRecords[I].Focused := True;
        // Cambiamento stato del documento attuale
        DM1.SetStatoScadenza(tvScad.Controller.FocusedRow.Values[tvScad.GetColumnByFieldName('TIPO').Index],
          tvScad.Controller.FocusedRow.Values[tvScad.GetColumnByFieldName('CODICE').Index],
          tvScad.Controller.FocusedRow.Values[tvScad.GetColumnByFieldName('DATASCADENZA').Index], NuovoStato);
      end;
      DM1.DBAzienda.Commit;
    finally
      DM1.CloseWait;
    end;
  except
    DM1.DBAzienda.Rollback;
  end;
end;

procedure TClientiForm.ShowDocChart;
begin
  if Assigned(FChartDoc) then
    FChartDoc.Free;
  FChartDoc := TChartFrame.Create(TabSheetDocCharts, tvDoc, SourceDoc);
  FChartDoc.BeginUpdate;
  try
    FChartDoc.SetReportTitle('Documenti');
    FChartDoc.SetCategories(tvDocCHART_DESCRIZIONE, 'Descrizione');

    FChartDoc.AddSerie(tvDocIMPONIBILE, 'Imponibile');
    FChartDoc.AddSerie(tvDocIMPORTOIVA, 'Importo IVA');
    FChartDoc.AddSerie(tvDocIMPORTO, 'Tot.documento');
    FChartDoc.AddSerie(tvDocRITACC, 'Rit.acc.');
    FChartDoc.AddSerie(tvDocABBUONO, 'Sconti fin.');
    FChartDoc.AddSerie(tvDocTOTALESPLITPAYMENT, 'Split payment');
    FChartDoc.AddSerie(tvDocTOTALEDAPAGARE, 'Tot.da pagare');
  finally
    FChartDoc.EndUpdate;
  end;
end;

procedure TClientiForm.ShowGMChart;
begin
  if Assigned(FChartGM) then
    FChartGM.Free;
  FChartGM := TChartFrame.Create(TabGMGrafici, tvGM, SourcGM);
  FChartGM.BeginUpdate;
  try
    FChartGM.SetReportTitle('Giornale di Magazzino');

    FChartGM.SetCategories(tvGMDOCUMENTO, 'Descrizione');
    FChartGM.AddSerie(tvGMIMPORTORIGO, 'Importo');
    FChartGM.AddSerie(tvGMDBIMPORTORIGOIVACOMPRESA, 'Importo IVA comp.');
  finally
    FChartGM.EndUpdate;
  end;
end;

procedure TClientiForm.ShowScadenzeChart;
begin
  if Assigned(FChartScad) then
    FChartScad.Free;
  FChartScad := TChartFrame.Create(TabScadCharts, tvScad, SourceScad);
  FChartScad.BeginUpdate;
  try
    FChartScad.SetReportTitle('Scadenze');

    FChartScad.SetCategories(tvScadCHART_DESCRIZIONE, 'Descrizione');
    FChartScad.AddSerie(tvScadRESIDUO, 'Importo da pagare');
    FChartScad.AddSerie(tvScadIMPORTO, 'Importo');
    FChartScad.AddSerie(tvScadIMPORTOPAGATO, 'Importo pagato');
    // FChartScad.AddSerieIfVisible(tvScadDARE, 'Dare');
    // FChartScad.AddSerieIfVisible(tvScadAVERE, 'Avere');
  finally
    FChartScad.EndUpdate;
  end;
end;

// Questa procedura modifica in solo colpo lo stato di tutte le scadenza selezionate
procedure TClientiForm.Annullapresentazioneallincassodellescadenzaselezionate1Click(Sender: TObject);
begin
  if DM1.Messaggi('Levante', 'Annullare la presentazione dll''incasso delle scadenze selezionate?', '', [mbYes, mbNo], 0, nil) <> mrYes then
    Exit;

  try
    DM1.ShowWait('Levante', 'Annullamento presentazione all''incasso delle scadenze selezionate.');
    AnnullaPresentazioneIncassoScadenzeSelezionate;
  finally
    DM1.CloseWait;
  end;
end;

procedure TClientiForm.AnnullaPresentazioneIncassoScadenzeSelezionate;
var
  I: Longint;
  Q: TIB_Cursor;
begin
  DM1.DBAzienda.StartTransaction;
  try
    try
      // Crea l'oggetto query
      Q := TIB_Cursor.Create(Self);
      Q.DatabaseName := DM1.ArcDBFile;
      Q.IB_Connection := DM1.DBAzienda;
      // Ovviamente procede solo se vi sono documenti selezionati
      if tvScad.Controller.SelectedRecordCount = 0 then
        Exception.Create('Non ci sono scadenze selezionate.');
      // Cicla per tutti i documenti selezionati e li esporta
      for I := 0 to tvScad.Controller.SelectedRecordCount - 1 do
      begin
        // Imposta ed esegue la query
        Q.SQL.Clear;
        Q.SQL.Add('UPDATE SCADENZ SET');
        Q.SQL.Add('PRESENTATA = ''/'',');
        Q.SQL.Add('PRESENTATABANCA = ''''');
        Q.SQL.Add('WHERE TIPO = ' + QuotedStr(tvScad.Controller.SelectedRecords[I].DisplayTexts[tvScadTIPO.Index]));
        Q.SQL.Add('  AND CODICE = ' + tvScad.Controller.SelectedRecords[I].DisplayTexts[tvScadCODICE.Index]);
        Q.SQL.Add('  AND DATASCADENZA = ' + QuotedStr(FormatDateTime('mm/dd/yyyy', tvScad.Controller.SelectedRecords[I].Values[tvScadDATASCADENZA.Index])));
        Q.ExecSQL;
      end;
      DM1.DBAzienda.Commit;
    finally
      if Assigned(Q) then
        Q.Free;
    end;
  except
    DM1.DBAzienda.Rollback;
    raise;
  end;
end;

// Questa procedura modifica in solo colpo lo stato di tutti i documenti selezionati
// al momento nell'elenco dei documenti.
procedure TClientiForm.SetStatoDocumentiSelezionati(NuovoStato: String);
var
  SelRec, I: Longint;
  LVarID: Variant;
begin
  DM1.DBAzienda.StartTransaction;
  DM1.ShowWait('Stato Documenti', 'Modifica stati documenti in corso...');
  try
    try
      // SelRec contiene il numeero di records selezionati
      SelRec := ClientiForm.tvDoc.Controller.SelectedRecordCount;
      // Ovviamente procede solo se vi sono documenti selezionati
      if SelRec = 0 then
        Exception.Create('Non ci sono documenti selezionati.');
      // Cicla per tutti i documenti selezionati e li esporta
      for I := 0 to SelRec - 1 do
      begin
        // Focus sul record attuale
        ClientiForm.tvDoc.Controller.SelectedRecords[I].Focused := True;
        // Defaultizzazione dell'ID (in caso di documenti che non hanno ID)
        LVarID := tvDoc.Controller.FocusedRow.Values[tvDoc.GetColumnByFieldName('ID').Index];
        if VarIsNull(LVarID) then
          LVarID := 0;
        // Cambiamento stato del documento attuale
        DM1.SetStatoDocumento(tvDoc.Controller.FocusedRow.Values[tvDoc.GetColumnByFieldName('TIPODOC').Index],
          tvDoc.Controller.FocusedRow.Values[tvDoc.GetColumnByFieldName('REGISTRO').Index],
          tvDoc.Controller.FocusedRow.Values[tvDoc.GetColumnByFieldName('CODICEDOC').Index],
          tvDoc.Controller.FocusedRow.Values[tvDoc.GetColumnByFieldName('DATADOC').Index], LVarID,
          (tvDoc.Controller.FocusedRow.Values[tvDoc.GetColumnByFieldName('IS_LDE').Index] = 'T'), NuovoStato);
      end;
      DM1.DBAzienda.Commit;
    finally
      DM1.CloseWait;
    end;
  except
    DM1.DBAzienda.Rollback;
  end;
end;

// Questa procedura modifica in solo colpo lo stato di tutti i documenti selezionati
// al momento nell'elenco dei documenti.
procedure TClientiForm.SetStatoDocumentiSelezionatiGM(NuovoStato: String);
var
  SelRec, I: Longint;
begin
  DM1.ShowWait('Stato Documenti', 'Modifica stati documenti in corso...');
  DM1.DBAzienda.StartTransaction;
  try
    try
      // SelRec contiene il numeero di records selezionati
      SelRec := ClientiForm.tvGM.Controller.SelectedRecordCount;
      // Ovviamente procede solo se vi sono documenti selezionati
      if SelRec = 0 then
        Exception.Create('Non ci sono documenti selezionati.');
      // Cicla per tutti i documenti selezionati e li esporta
      for I := 0 to SelRec - 1 do
      begin
        // Focus sul record attuale
        ClientiForm.tvGM.Controller.SelectedRecords[I].Focused := True;
        // Cambiamento stato del documento attuale
        DM1.SetStatoDocumento(tvGM.Controller.FocusedRow.Values[tvGM.GetColumnByFieldName('TIPODOCUMENTO').Index],
          tvGM.Controller.FocusedRow.Values[tvGM.GetColumnByFieldName('REGISTRO').Index],
          tvGM.Controller.FocusedRow.Values[tvGM.GetColumnByFieldName('NUMORDPREV').Index],
          tvGM.Controller.FocusedRow.Values[tvGM.GetColumnByFieldName('DATADOCUMENTO').Index], 0, False, NuovoStato);
      end;
      DM1.DBAzienda.Commit;
    finally
      DM1.CloseWait;
    end;
  except
    DM1.DBAzienda.Rollback;
  end;
end;

// Verifica che nelle scadenze selezionate ci siano solo RIBA presentate, altirmenti
// ritorna un errore.
function TClientiForm.SoloRIBANellaSelezione: Boolean;
var
  I, SelRec: Longint;
begin
  DM1.Attendere;
  Result := True;
  try
    // SelRec contiene il numeero di records selezionati
    SelRec := tvScad.Controller.SelectedRecordCount;
    // Ovviamente procede solo se vi sono documenti selezionati
    if SelRec > 0 then
    begin
      // Cicla per tutti i documenti selezionati e li esporta
      for I := 0 to SelRec - 1 do
      begin
        // Focus sul record attuale
        tvScad.Controller.SelectedRecords[I].Focused := True;
        // Se la scadenza attuale non  una ricevuta bancaria visualizza un messaggio ed esce
        if tvScad.Controller.FocusedRow.Values[tvScad.GetColumnByFieldName('RICEVUTABANCARIA').Index] <> 'T' then
        begin
          Result := False;
          DM1.Messaggi('Pagamento/Riscossione RI.BA.', 'Le scadenze selezionate devono essere tutte ricevute bancarie.', '', [mbOk], 0, nil);
          Exit;
        end;
        // Se la scadenza attuale  una RIBA ma risulta gi pagata...
        if tvScad.Controller.FocusedRow.Values[tvScad.GetColumnByFieldName('RESIDUO').Index] = 0 then
        begin
          Result := False;
          DM1.Messaggi('Pagamento/Riscossione RI.BA.',
            'Tra le scadenze selezionate non ci devono essere scadenze gi pagate/riscosse o con importo uguale a 0 (zero).', '', [mbOk], 0, nil);
          Exit;
        end;
      end;
      // Se non ci sono documenti selezionati visualizza un messaggio che spiega la situazione
    end
    else
    begin
      DM1.Messaggi('Pagamento/Riscossione RI.BA.', 'Non ci sono scadenze selezionate.', '', [mbOk], 0, nil);
    end;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.MarcaImportExport(TipoDoc, Registro: String; NumDoc: Longint; DataDoc: TDate; V, PrecValue: String);
var
  Qry: TIB_Cursor;
begin
  // Ovviamente se il rigo/documento  gi Imported+Exported non occorre fare nulla ed esce subito
  if PrecValue = FLAG_VALUE_IMPORTED_EXPORTED then
    Exit;
  // Query che restituir l'ultimo numero usato
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    // Aggiorna il valore del Flag
    if V = FLAG_VALUE_IMPORTED then
    begin
      // Se era gi anche Exported lo marca come Imported_Exported altrimenti solo come Imported
      if PrecValue = FLAG_VALUE_EXPORTED then
        PrecValue := FLAG_VALUE_IMPORTED_EXPORTED
      else
        PrecValue := FLAG_VALUE_IMPORTED;
    end
    else if V = FLAG_VALUE_EXPORTED then
    begin
      // Se era gi anche Imported lo marca come Imported_Exported altrimenti solo come Exported
      if PrecValue = FLAG_VALUE_IMPORTED then
        PrecValue := FLAG_VALUE_IMPORTED_EXPORTED
      else
        PrecValue := FLAG_VALUE_EXPORTED;
    end
    else if V = FLAG_VALUE_IMPORTED_EXPORTED then
    begin
      // IMposta il rigo Imported+Exported
      PrecValue := FLAG_VALUE_IMPORTED_EXPORTED;
    end;
    // Imposta la query che aggiorner la tabella PrvOrdCl
    Qry.SQL.Add('UPDATE PRVORDCL SET SELEZIONATO = ''' + PrecValue + '''');
    Qry.SQL.Add('WHERE TIPODOCUMENTO = ''' + TipoDoc + '''');
    Qry.SQL.Add('  AND REGISTRO = ''' + Registro + '''');
    Qry.SQL.Add('  AND NUMORDPREV = ' + IntToStr(NumDoc));
    Qry.SQL.Add('  AND DATADOCUMENTO = ''' + FormatDateTime('mm/dd/yyyy', DataDoc) + '''');
    Qry.ExecSQL;
    // Imposta la query che aggiorner la tabella RighiPrv
    Qry.SQL.Clear;
    Qry.SQL.Add('UPDATE RIGHIPRV SET SELEZIONATO = ''' + PrecValue + '''');
    Qry.SQL.Add('WHERE TIPODOCUMENTO = ''' + TipoDoc + '''');
    Qry.SQL.Add('  AND REGISTRO = ''' + Registro + '''');
    Qry.SQL.Add('  AND NUMORDPREV = ' + IntToStr(NumDoc));
    Qry.SQL.Add('  AND DATADOCUMENTO = ''' + FormatDateTime('mm/dd/yyyy', DataDoc) + '''');
    Qry.ExecSQL;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.CaricaMagazzinoDefaultArticoli;
var
  Qry: TIB_Cursor;
begin
  // Se  impostata la visualizzazione di tutti i magazzini per default...
  if DM1.TableProgressiviQRYARTTUTTIMAG.AsString = 'T' then
  begin
    CodiceMagazzino.Text := '';
    DescrizioneMagazzino.Text := '';
    Exit;
  end;
  // Se vuoto imposta il magazzino di ricerca
  if Trim(CodiceMagazzino.Text) = '' then
  begin
    CodiceMagazzino.Text := ' ' + DM1.MagazzinoDefault;
    // Preleva la descrizione del magazzino di default
    Qry := TIB_Cursor.Create(Self);
    try
      Qry.DatabaseName := DM1.ArcDBFile;
      Qry.IB_Connection := DM1.DBAzienda;
      Qry.SQL.Add('SELECT DESCRIZIONE FROM ANAGMAGA WHERE CODICE = ' + DM1.MagazzinoDefault);
      Qry.Open;
      if not Qry.Eof then
        DescrizioneMagazzino.Text := ' ' + Qry.FieldByName('DESCRIZIONE').AsString;
      Qry.Close;
    finally
      Qry.Free;
    end;
  end;
end;

procedure TClientiForm.ResetTabRubrica;
var
  I: Integer;
  CS: TShape;
  CSB: TSpeedButton;
begin
  // Cicla per tutti i Tab delle lettere della rubrica e li disegna non selezionati
  for I := 1 to 26 do
  begin
    // CS punta allo shape corrente
    CS := FindComponent('Sh' + IntToStr(I)) as TShape;
    // CSB punta allo speedbutton della lettera selezionata
    CSB := FindComponent('SB' + IntToStr(I)) as TSpeedButton;
    // Il bordo st sopra a tutto
    ShapeBordoSogg.BringToFront;
    // IMposta il tab come non selezionato
    CS.Pen.Color := $00828282;
    CS.Brush.Color := $007DBEFF;
    CS.Shape := stRoundRect;
    if CS.Tag = 1 then
    begin
      CS.Width := CS.Width - 2;
      CS.Height := CS.Height - 2;
      CS.Top := CS.Top + 1;
      CS.Left := CS.Left + 4;
      CSB.Left := CSB.Left + 2;
      CSB.Font.Color := $00383838;
      CSB.Font.Style := [];
    end;
    // Marca il tab corrente come non selezionato
    CS.Tag := 0;
  end;
end;

procedure TClientiForm.SB1Click(Sender: TObject);
var
  CS: TShape;
  CSB: TSpeedButton;
begin
  // CS punta allo shape della lettera cliccata
  CS := FindComponent('Sh' + IntToStr((Sender as TSpeedButton).Tag)) as TShape;
  // CSB punta allo speedbutton della lettera selezionata
  CSB := FindComponent('SB' + IntToStr((Sender as TSpeedButton).Tag)) as TSpeedButton;
  // Se la propriet Tag dello shape  = 0 significa che il pulsante non era precedentemente selezionato
  // e quindi provvede a visualizzarlo come selezionato
  if CS.Tag = 0 then
  begin
    // Imposta i filtro
    TabLettera.Text := (Sender as TSpeedButton).Caption + '%';
    // Visualizza disabilitati tutti i Tabs
    ResetTabRubrica;
    // Visualizza abilitato il Tab delle lettera cliccata
    CS.Pen.Color := clBlack;
    CS.Brush.Color := $00F0F0F0;
    CS.Shape := stRectangle;
    CS.Width := CS.Width + 2;
    CS.Height := CS.Height + 2;
    CS.Top := CS.Top - 1;
    CS.Left := CS.Left - 4;
    CSB.Left := CSB.Left - 2;
    CSB.Font.Color := clBlack;
    CSB.Font.Style := [fsBold];
    CS.BringToFront;
    CSB.BringToFront;
    // Lo marca come selezionato
    CS.Tag := 1;
    // Se invece arriva Qu (Tag = 1) significa che prima del click dell'utente la lettera era gi selezionata
    // e quindi la deseleziona
  end
  else
  begin
    // Svuota il filtro
    TabLettera.Text := '';
    // Visualizza disabilitati tutti i Tabs
    ResetTabRubrica;
  end;
  // Esegue subito la ricerca
  RxSpeedButtonTrovaClick(Self);
end;

procedure TClientiForm.EliminaCliente(CodToDel: Longint); // Personale
var
  Qry: TIBOQuery;
begin
  Qry := TIBOQuery.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('DELETE');
    Qry.SQL.Add('FROM Clienti');
    Qry.SQL.Add('WHERE');
    if CodToDel = -9999 then
      Qry.SQL.Add('Codice IS NULL')
    else
      Qry.SQL.Add('(Codice = ' + IntToStr(CodToDel) + ')');
    Qry.ExecSQL;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.EseguiQueryCV;
var
  Condizioni: TStrings;
  I: Integer;
begin
  // Costruisce le condizioni nella variabile 'Condizioni'
  // ----------------------------------------------------
  Condizioni := TStringList.Create;
  Condizioni.Add('WHERE 1=1'); // COndizione finta in modo che serva sempre l'AND nelle condizioni soccessive
  // Se  necessario filtrare per gruppi...
  if Trim(CVCodiceGruppo1.Text) <> '' then
  begin
    Condizioni.Add('AND CV.CodiceGruppo1 = ' + Trim(CVCodiceGruppo1.Text));
    if Trim(CVCodiceGruppo2.Text) <> '' then
      Condizioni.Add('AND CV.CodiceGruppo2 = ' + Trim(CVCodiceGruppo2.Text));
    if Trim(CVCodiceGruppo3.Text) <> '' then
      Condizioni.Add('AND CV.CodiceGruppo3 = ' + Trim(CVCodiceGruppo3.Text));
  end;
  // Se c' un cliente selezionato, filtra per cliente
  if ClienteCorrente <> '' then
    Condizioni.Add('AND CV.CODICESOGGETTO = ' + ClienteCorrente);
  // Se specificato ricerca per COdiceArticolo
  if CVCodiceArticolo.Text <> '' then
    Condizioni.Add('AND CV.CODICEARTICOLO = ''' + Trim(CVCodiceArticolo.Text) + '''');
  // Filtra in base ai tipi di movimentazione selesionata
  Condizioni.Add('AND (');
  if TipoCondizione.Checked[1] then
    Condizioni.Add('CV.TIPO = ''Cond.Vend.'' OR');
  if TipoCondizione.Checked[2] then
    Condizioni.Add('CV.TIPO = ''Cond.Acqui'' OR');
  Condizioni[Condizioni.Count - 1] := DM1.StrLeft(Condizioni[Condizioni.Count - 1], Length(Condizioni[Condizioni.Count - 1]) - 3); // Elimina l'ultimo OR
  Condizioni.Add(')');
  // ----------------------------------------------------

  // Questa procedura imposta ed esegue la query che trover i movimenti di magazzino
  QryCV.Close;
  QryCV.SQL.Clear;

  // CONDIZIONI DI VENDITA PER ARTICOLO
  // ----------------------------------
  QryCV.SQL.Add('SELECT CV.TIPO, CAST((''Art: '' || CV.CODICEARTICOLO || ''-'' || A.DESCRIZIONE) as VARCHAR(200)) as RIFERIMENTO,');
  QryCV.SQL.Add(' CV.DAQTA1, CV.SCONTO1, CV.IMPORTO1, CV.DAQTA2, CV.SCONTO2, CV.IMPORTO2, CV.DAQTA3, CV.SCONTO3, CV.IMPORTO3,');
  QryCV.SQL.Add(' CAST((CV.CODICESOGGETTO || '' - '' || C.RAGIONESOCIALE) as VARCHAR(80)) as RAGIONESOCIALE,');
  QryCV.SQL.Add(' CV.CODICESOGGETTO, CV.CODICEARTICOLO, CV.CODICEGRUPPO1, CV.CODICEGRUPPO2, CV.CODICEGRUPPO3');
  QryCV.SQL.Add('FROM CONDVEND CV');
  QryCV.SQL.Add('LEFT JOIN ARTICOLI A ON (CV.CODICEARTICOLO = A.CODICEARTICOLO)');
  QryCV.SQL.Add('LEFT JOIN CLIENTI C ON (C.CODICE = CV.CODICESOGGETTO)');
  // Aggiunge le condizioni
  for I := 0 to Condizioni.Count - 1 do
    QryCV.SQL.Add(Condizioni[I]);
  // Solo le condizioni che hanno il codice articolo
  QryCV.SQL.Add('AND CV.CODICEARTICOLO <> ''-1''');
  // ----------------------------------

  // CONDIZIONI DI VENDITA PER GRUPPO LIVELLO1
  // ----------------------------------
  // Solo se non si sono specificati il codice gruppo 2 e 3
  if (Trim(CVCodiceGruppo2.Text) = '') and (Trim(CVCodiceGruppo3.Text) = '') then
  begin
    QryCV.SQL.Add('UNION ALL');
    // CONDIZIONI DI VENDITA PER ARTICOLO
    QryCV.SQL.Add('SELECT CV.TIPO, CAST((''Grp: '' || G1.DESCRIZIONE) AS VARCHAR(200)) as RIFERIMENTO,');
    QryCV.SQL.Add(' CV.DAQTA1, CV.SCONTO1, CV.IMPORTO1, CV.DAQTA2, CV.SCONTO2, CV.IMPORTO2, CV.DAQTA3, CV.SCONTO3, CV.IMPORTO3,');
    QryCV.SQL.Add(' CAST((CV.CODICESOGGETTO || '' - '' || C.RAGIONESOCIALE) as VARCHAR(80)) as RAGIONESOCIALE,');
    QryCV.SQL.Add(' CV.CODICESOGGETTO, CV.CODICEARTICOLO, CV.CODICEGRUPPO1, CV.CODICEGRUPPO2, CV.CODICEGRUPPO3');
    QryCV.SQL.Add('FROM CONDVEND CV');
    QryCV.SQL.Add('LEFT JOIN CLIENTI C ON (C.CODICE = CV.CODICESOGGETTO)');
    QryCV.SQL.Add('LEFT JOIN GRUPPI G1 ON (G1.CODICE1 = CV.CODICEGRUPPO1 AND G1.CODICE2 = -1 AND G1.CODICE2 = -1)');
    // Aggiunge le condizioni
    for I := 0 to Condizioni.Count - 1 do
      QryCV.SQL.Add(Condizioni[I]);
    // Solo le condizioni che riguardano i gruppi di 1 livello
    QryCV.SQL.Add('AND CV.CODICEGRUPPO1 > 0 AND CV.CODICEGRUPPO2 = -1 AND CV.CODICEGRUPPO3 = -1');
  end;
  // ----------------------------------

  // CONDIZIONI DI VENDITA PER GRUPPO LIVELLO2
  // ----------------------------------
  // Solo se non si sono specificati il codice gruppo 3
  if (Trim(CVCodiceGruppo3.Text) = '') then
  begin
    QryCV.SQL.Add('UNION ALL');
    // CONDIZIONI DI VENDITA PER ARTICOLO
    QryCV.SQL.Add('SELECT CV.TIPO, CAST((''Grp: '' || G1.DESCRIZIONE || '' + '' || G2.DESCRIZIONE) AS VARCHAR(200)) as RIFERIMENTO,');
    QryCV.SQL.Add(' CV.DAQTA1, CV.SCONTO1, CV.IMPORTO1, CV.DAQTA2, CV.SCONTO2, CV.IMPORTO2, CV.DAQTA3, CV.SCONTO3, CV.IMPORTO3,');
    QryCV.SQL.Add(' CAST((CV.CODICESOGGETTO || '' - '' || C.RAGIONESOCIALE) as VARCHAR(80)) as RAGIONESOCIALE,');
    QryCV.SQL.Add(' CV.CODICESOGGETTO, CV.CODICEARTICOLO, CV.CODICEGRUPPO1, CV.CODICEGRUPPO2, CV.CODICEGRUPPO3');
    QryCV.SQL.Add('FROM CONDVEND CV');
    QryCV.SQL.Add('LEFT JOIN CLIENTI C ON (C.CODICE = CV.CODICESOGGETTO)');
    QryCV.SQL.Add('LEFT JOIN GRUPPI G1 ON (G1.CODICE1 = CV.CODICEGRUPPO1 AND G1.CODICE2 = -1 AND G1.CODICE3 = -1)');
    QryCV.SQL.Add('LEFT JOIN GRUPPI G2 ON (G2.CODICE1 = CV.CODICEGRUPPO1 AND G2.CODICE2 = CV.CODICEGRUPPO2 AND G2.CODICE3 = -1)');
    // Aggiunge le condizioni
    for I := 0 to Condizioni.Count - 1 do
      QryCV.SQL.Add(Condizioni[I]);
    // Solo le condizioni che riguardano i gruppi di 1 livello
    QryCV.SQL.Add('AND CV.CODICEGRUPPO1 > 0 AND CV.CODICEGRUPPO2 > 0 AND CV.CODICEGRUPPO3 = -1');
  end;
  // ----------------------------------

  // CONDIZIONI DI VENDITA PER GRUPPO LIVELLO3
  // ----------------------------------
  QryCV.SQL.Add('UNION ALL');
  // CONDIZIONI DI VENDITA PER ARTICOLO
  QryCV.SQL.Add
    ('SELECT CV.TIPO, CAST((''Grp: '' || G1.DESCRIZIONE || '' + '' || G2.DESCRIZIONE || '' + '' || G3.DESCRIZIONE) AS VARCHAR(200)) as RIFERIMENTO,');
  QryCV.SQL.Add(' CV.DAQTA1, CV.SCONTO1, CV.IMPORTO1, CV.DAQTA2, CV.SCONTO2, CV.IMPORTO2, CV.DAQTA3, CV.SCONTO3, CV.IMPORTO3,');
  QryCV.SQL.Add(' CAST((CV.CODICESOGGETTO || '' - '' || C.RAGIONESOCIALE) as VARCHAR(80)) as RAGIONESOCIALE,');
  QryCV.SQL.Add(' CV.CODICESOGGETTO, CV.CODICEARTICOLO, CV.CODICEGRUPPO1, CV.CODICEGRUPPO2, CV.CODICEGRUPPO3');
  QryCV.SQL.Add('FROM CONDVEND CV');
  QryCV.SQL.Add('LEFT JOIN CLIENTI C ON (C.CODICE = CV.CODICESOGGETTO)');
  QryCV.SQL.Add('LEFT JOIN GRUPPI G1 ON (G1.CODICE1 = CV.CODICEGRUPPO1 AND G1.CODICE2 = -1 AND G1.CODICE3 = -1)');
  QryCV.SQL.Add('LEFT JOIN GRUPPI G2 ON (G2.CODICE1 = CV.CODICEGRUPPO1 AND G2.CODICE2 = CV.CODICEGRUPPO2 AND G2.CODICE3 = -1)');
  QryCV.SQL.Add('LEFT JOIN GRUPPI G3 ON (G3.CODICE1 = CV.CODICEGRUPPO1 AND G3.CODICE2 = CV.CODICEGRUPPO2 AND G3.CODICE3 = CV.CODICEGRUPPO3)');
  // Aggiunge le condizioni
  for I := 0 to Condizioni.Count - 1 do
    QryCV.SQL.Add(Condizioni[I]);
  // Solo le condizioni che riguardano i gruppi di 1 livello
  QryCV.SQL.Add('AND CV.CODICEGRUPPO1 > 0 AND CV.CODICEGRUPPO2 > 0 AND CV.CODICEGRUPPO3 > 0');
  // ----------------------------------
  // Apre la query
  QryCV.Open;
  // Si posizione all'inizio
  tvCV.DataController.GotoFirst;
end;

procedure TClientiForm.EseguiQueryGM;
var
  I: Integer;
  QryAlreadyOpened: Boolean;
begin
  QryAlreadyOpened := QryGM.Active;

  // Questa procedura imposta ed esegue la query che trover i movimenti di magazzino
  QryGM.Close;
  QryGM.SQL.Clear;
  QryGM.SQL.Add
    ('SELECT R.CodiceMagazzino,R.CodiceMagazzino2,T.SegnoOperazione,R.CodiceArticolo,R.CodiceArticoloStm,R.Descrizione,COALESCE(R.PrezzoUnitario,0) AS PREZZOUNITARIO,R.UnitaDiMisura,');
  QryGM.SQL.Add(' CASE R.MOVMAG WHEN ''-'' THEN (COALESCE(R.QTA,0) * -1) ELSE COALESCE(R.QTA,0) END AS QTA,');
  QryGM.SQL.Add
    (' COALESCE(R.ScontoRigo,0) AS SCONTORIGO,COALESCE(R.ScontoRigo2,0) AS SCONTORIGO2,COALESCE(R.ScontoRigo3,0) AS SCONTORIGO3,COALESCE(R.ImportoRigo,0) AS IMPORTORIGO, T.StatoDescrizione,');
  QryGM.SQL.Add
    (' CAST(T.TipoDocumento || '' '' || T.NumOrdPrev || T.Registro || '' del '' || T.DataDocumento || CASE WHEN (TRIM(COALESCE(I.RDA,''''))<>'''') THEN ('' (RDA ''||TRIM(I.RDA)||'')'') ELSE '''' END AS VARCHAR(100)) AS DOCUMENTO,');
  QryGM.SQL.Add(' CAST(T.RagSocCli || ''  ('' || T.CodiceCliente || '')'' AS VARCHAR(100) CHARACTER SET NONE) AS SOGGETTO,');
  QryGM.SQL.Add
    (' CAST((SELECT Descrizione FROM Gruppi WHERE Codice1=A.CodiceGruppo1 AND Codice2=-1 AND Codice3=-1 AND Codice4=-1 AND Codice5=-1 AND Codice6=-1) || ''  ('' || A.CodiceGruppo1 || '')'' AS VARCHAR(150)) AS GRUPPO1,');
  QryGM.SQL.Add
    (' CAST((SELECT Descrizione FROM Gruppi WHERE Codice1=A.CodiceGruppo1 AND Codice2=A.CodiceGruppo2 AND Codice3=-1 AND Codice4=-1 AND Codice5=-1 AND Codice6=-1) || ''  ('' || A.CodiceGruppo2 || '')'' AS VARCHAR(150)) AS GRUPPO2,');
  QryGM.SQL.Add
    (' CAST((SELECT Descrizione FROM Gruppi WHERE Codice1=A.CodiceGruppo1 AND Codice2=A.CodiceGruppo2 AND Codice3=A.CodiceGruppo3 AND Codice4=-1 AND Codice5=-1 AND Codice6=-1) || ''  ('' || A.CodiceGruppo3 || '')'' AS VARCHAR(150)) AS GRUPPO3,');
  QryGM.SQL.Add
    (' CAST((SELECT Descrizione FROM Gruppi WHERE Codice1=A.CodiceGruppo1 AND Codice2=A.CodiceGruppo2 AND Codice3=A.CodiceGruppo3 AND Codice4=A.CodiceGruppo4 AND Codice5=-1 AND Codice6=-1) || ''  ('' || A.CodiceGruppo4 || '')'' AS VARCHAR(150)) AS GRUPPO4,');
  QryGM.SQL.Add
    (' CAST((SELECT Descrizione FROM Gruppi WHERE Codice1=A.CodiceGruppo1 AND Codice2=A.CodiceGruppo2 AND Codice3=A.CodiceGruppo3 AND Codice4=A.CodiceGruppo4 AND Codice5=A.CodiceGruppo5 AND Codice6=-1) || ''  ('' || A.CodiceGruppo5 || '')''');
  QryGM.SQL.Add('     AS VARCHAR(150)) AS GRUPPO5,');
  QryGM.SQL.Add
    (' CAST((SELECT Descrizione FROM Gruppi WHERE Codice1=A.CodiceGruppo1 AND Codice2=A.CodiceGruppo2 AND Codice3=A.CodiceGruppo3 AND Codice4=A.CodiceGruppo4 AND Codice5=A.CodiceGruppo5 AND Codice6=A.CodiceGruppo6) || ''  ('' || A.CodiceGruppo6 || '')''');
  QryGM.SQL.Add('     AS VARCHAR(150)) AS GRUPPO6,');
  QryGM.SQL.Add
    (' T.TipoDocumento,T.NumOrdPrev,T.Registro,T.DataDocumento,T.RagSocCli, R.ProgRigo, COALESCE(R.PREZZOUNITARIOIVACOMPRESA,0) AS PREZZOUNITARIOIVACOMPRESA, COALESCE(R.IMPORTORIGOIVACOMPRESA,0) AS IMPORTORIGOIVACOMPRESA,');

  QryGM.SQL.Add(' CAST(PRAT.DESCRIZIONE || ''  ('' || T.PRATICA || '', '' || T.DATAPRATICA1 || '')'' AS VARCHAR(120)) AS PRATICA,');

  QryGM.SQL.Add(' T.DATAPRATICA1, R.TIPO1, R.TIPO2, R.TIPO3, R.TIPO4, R.TIPO5, R.TIPO6, T.AGENTE, T.AGENTE2, T.AGENTE3, T.AGENTE4, T.SegnoOperazioneCantiere,');
  QryGM.SQL.Add(' R.Sottocantiere1, R.Sottocantiere2, R.Sottocantiere3,');
  QryGM.SQL.Add(' CLI.CLIENTEFORNITORE AS TIPOSOGGETTO,');
  QryGM.SQL.Add(' CAST((SELECT PAG.DESCRIZIONE FROM PAGAM PAG WHERE PAG.CODICE=T.PAGAMENTO) AS VARCHAR(40)) AS DESCPAGAM,');
  QryGM.SQL.Add(' PRAT.CATEGCANT1, PRAT.CATEGCANT2, PRAT.CATEGCANT3, PRAT.CATEGCANT4, PRAT.CATEGCANT5, PRAT.CATEGCANT6, T.CAUSALE,');

  QryGM.SQL.Add(' CAST(R.CODICEMAGAZZINO || ''-'' || (SELECT AM.DESCRIZIONE FROM ANAGMAGA AM WHERE AM.CODICE=R.CODICEMAGAZZINO) AS VARCHAR(30)) AS RIFMAGA1,');
  QryGM.SQL.Add
    (' CAST(R.CODICEMAGAZZINO2 || ''-'' || (SELECT AM.DESCRIZIONE FROM ANAGMAGA AM WHERE AM.CODICE=R.CODICEMAGAZZINO2) AS VARCHAR(30)) AS RIFMAGA2,');

  QryGM.SQL.Add(' T.RIFDOC_TIPO, T.RIFDOC_NUM, T.RIFDOC_REG, T.RIFDOC_DATA,');
  QryGM.SQL.Add(' CAST(T.RIFDOC_TIPO || '' '' || T.RIFDOC_NUM || COALESCE(T.RIFDOC_REG,'''') || '' del '' || T.RIFDOC_DATA AS VARCHAR(100)) AS RIFDOC,');
  QryGM.SQL.Add(' I.RDA');

  {
    QryGM.SQL.Add('FROM PRVORDCL T');
    QryGM.SQL.Add('LEFT JOIN RIGHIPRV R ON (R.TipoDocumento = T.TipoDOcumento AND R.Registro = T.Registro AND R.NumOrdPrev = T.NumOrdPrev AND R.DataDocumento = T.DataDocumento)');
  }
  QryGM.SQL.Add('FROM RIGHIPRV R');
  QryGM.SQL.Add
    ('LEFT JOIN PRVORDCL T ON (T.TipoDocumento = R.TipoDOcumento AND T.Registro = R.Registro AND T.NumOrdPrev = R.NumOrdPrev AND T.DataDocumento = R.DataDocumento)');
  QryGM.SQL.Add('LEFT JOIN ARTICOLI A ON (A.CodiceArticolo = R.CodiceArticolo)');
  QryGM.SQL.Add('LEFT JOIN CLIENTI CLI ON (CLI.CODICE = T.CODICECLIENTE)');
  QryGM.SQL.Add('LEFT JOIN PRATICHE PRAT ON (PRAT.CODICE=T.PRATICA AND PRAT.DATAAPERTURA=T.DATAPRATICA1)');
  QryGM.SQL.Add('LEFT JOIN IMPEGNI I ON (R.TIPODOCUMENTO=''Intervento'' AND I.ID=R.NUMORDPREV)');
  // Aggiunge una clausola WHERE finta in modo che non dia errore se non viene specificata nessuna condizione
  QryGM.SQL.Add('WHERE');
  QryGM.SQL.Add('R.CodiceArticolo = R.CodiceArticolo');
  // // NB: Riga eliminata perch la Jenny di Severi Carlo voleva che desse anche le righe senza codice
  // QryGM.SQL.Add('AND R.CodiceArticolo IS NOT NULL AND R.CodiceArticolo <> ''''');
  QryGM.SQL.Add('AND R.CodiceIVA <> -9');
  // Se filtra per tipo soggetto
  if GMTipoSoggetto.Text <> '' then
    DM1.AddSQL(QryGM, 'AND', 'CLI.CLIENTEFORNITORE = ''' + GMTipoSoggetto.Text + '''');
  // Se  necessario filtrare per gruppi...
  if GMCodiceGruppo1.Text <> '' then
  begin
    DM1.AddSQL(QryGM, 'AND', 'A.CodiceGruppo1 = ' + Trim(GMCodiceGruppo1.Text));
    if GMCodiceGruppo2.Text <> '' then
      DM1.AddSQL(QryGM, 'AND', 'A.CodiceGruppo2 = ' + Trim(GMCodiceGruppo2.Text));
    if GMCodiceGruppo3.Text <> '' then
      DM1.AddSQL(QryGM, 'AND', 'A.CodiceGruppo3 = ' + Trim(GMCodiceGruppo3.Text));
    if GMCodiceGruppo4.Text <> '' then
      DM1.AddSQL(QryGM, 'AND', 'A.CodiceGruppo4 = ' + Trim(GMCodiceGruppo4.Text));
    if GMCodiceGruppo5.Text <> '' then
      DM1.AddSQL(QryGM, 'AND', 'A.CodiceGruppo5 = ' + Trim(GMCodiceGruppo5.Text));
    if GMCodiceGruppo6.Text <> '' then
      DM1.AddSQL(QryGM, 'AND', 'A.CodiceGruppo6 = ' + Trim(GMCodiceGruppo6.Text));
  end;
  // Se c' una pratiica selezionata visualizza solo righi relativi ai documenti della pratica
  if PraticaCorrente <> '' then
  begin
    DM1.AddSQL(QryGM, 'AND', '(((T.Pratica=' + PraticaCorrente + ')AND(T.DataPratica1=''' + DataPraticaCorrenteSQL + ''')) OR ((T.Pratica2=' + PraticaCorrente +
      ')AND(T.DataPratica2=''' + DataPraticaCorrenteSQL + ''')) OR ((T.Pratica3=' + PraticaCorrente + ')AND(T.DataPratica3=''' + DataPraticaCorrenteSQL
      + ''')))');
    // Se invece non c' una pratica selezionata filtra tutto per l'eventuale cliente selezionato
  end
  else
  begin
    if ClienteCorrente <> '' then
      DM1.AddSQL(QryGM, 'AND', 'T.CodiceCliente = ' + ClienteCorrente);
  end;
  // Se specificato ricerca per COdiceArticolo
  if GMCodiceArticolo.Text <> '' then
    DM1.AddSQL(QryGM, 'AND', '(R.CodiceArticolo LIKE ' + QuotedStr(Trim(GMCodiceArticolo.Text)) + ' OR R.CodiceArticoloStm LIKE ' +
      QuotedStr(Trim(GMCodiceArticolo.Text)) + ')');
  // Se  specificato la ricerca per testo (Descrizione, note ecc)
  if GMDescrizione.Text <> '' then
  begin
    DM1.AddSQL(QryGM, 'AND', '(');
    DM1.AggiungiRicercaCampo(QryGM.SQL, 'R.Descrizione', GMDescrizione.Text, False);
    QryGM.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryGM.SQL, 'R.NoteRigo', GMDescrizione.Text, False);
    QryGM.SQL.Add(')');
  end;

  // Se specificato ricerca per marca
  if GMMarca.Text <> '' then
    DM1.AddSQL(QryGM, 'AND', 'UPPER(A.Marca) = UPPER(''' + Trim(GMMarca.Text) + ''')');

  // Se specificato ricerca per RDA
  if GMRDA.Text <> '' then
    DM1.AddSQL(QryGM, 'AND', 'UPPER(I.RDA) = UPPER(''' + Trim(GMRDA.Text) + ''')');

  // Se specificato ricerca per Agente
  if GMAgente.Text <> '' then
    DM1.AddSQL(QryGM, 'AND', 'T.Agente  = ''' + Trim(GMAgente.Text) + '''');
  if GMAgente2.Text <> '' then
    DM1.AddSQL(QryGM, 'AND', 'T.Agente2 = ''' + Trim(GMAgente2.Text) + '''');
  if GMAgente3.Text <> '' then
    DM1.AddSQL(QryGM, 'AND', 'T.Agente3 = ''' + Trim(GMAgente3.Text) + '''');
  if GMAgente4.Text <> '' then
    DM1.AddSQL(QryGM, 'AND', 'T.Agente4 = ''' + Trim(GMAgente4.Text) + '''');
  // Categorie cantieri
  if GMCategCant1.Text <> '' then
    DM1.AddSQL(QryGM, 'AND', 'PRAT.CATEGCANT1 = ''' + GMCategCant1.Text + '''');
  if GMCategCant2.Text <> '' then
    DM1.AddSQL(QryGM, 'AND', 'PRAT.CATEGCANT2 = ''' + GMCategCant2.Text + '''');
  if GMCategCant3.Text <> '' then
    DM1.AddSQL(QryGM, 'AND', 'PRAT.CATEGCANT3 = ''' + GMCategCant3.Text + '''');
  if GMCategCant4.Text <> '' then
    DM1.AddSQL(QryGM, 'AND', 'PRAT.CATEGCANT4 = ''' + GMCategCant4.Text + '''');
  if GMCategCant5.Text <> '' then
    DM1.AddSQL(QryGM, 'AND', 'PRAT.CATEGCANT5 = ''' + GMCategCant5.Text + '''');
  if GMCategCant6.Text <> '' then
    DM1.AddSQL(QryGM, 'AND', 'PRAT.CATEGCANT6 = ''' + GMCategCant6.Text + '''');
  // Se specificato ricerca per causale
  if GMCausale.Text <> '' then
    DM1.AddSQL(QryGM, 'AND', 'T.Causale = ''' + Trim(GMCausale.Text) + '''');
  // Se specificato lo sttato del documento
  if GMSoloStato.Text <> '' then
    DM1.AddSQL(QryGM, 'AND', 'T.StatoDescrizione = ''' + Trim(GMSoloStato.Text) + '''');

  // Se specificato ricerca per codice magazzino
  if GMCodiceMagazzino.Text <> '' then
    DM1.AddSQL(QryGM, 'AND', '(R.CodiceMagazzino = ' + Trim(GMCodiceMagazzino.Text) + ' OR R.CodiceMagazzino2 = ' + Trim(GMCodiceMagazzino.Text) + ')');

  // ==========================================================================
  // FILTRAGGIO PER DATE
  // --------------------------------------------------------------------------
  if FilterGMTipoData.Text = 'Data documento' then
  begin
    if DM1.ControllaDataStr(GMDal.EditText) then
      DM1.AddSQL(QryGM, 'AND', 'T.DataDocumento >= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(Trim(GMDal.EditText))) + '''');
    if DM1.ControllaDataStr(GMAl.EditText) then
      DM1.AddSQL(QryGM, 'AND', 'T.DataDocumento <= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(Trim(GMAl.EditText))) + '''');
  end
  else if FilterGMTipoData.Text = 'Data apertura prat/cant' then
  begin
    if DM1.ControllaDataStr(GMDal.EditText) then
      DM1.AddSQL(QryGM, 'AND', 'T.DATAPRATICA1 >= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(Trim(GMDal.EditText))) + '''');
    if DM1.ControllaDataStr(GMAl.EditText) then
      DM1.AddSQL(QryGM, 'AND', 'T.DATAPRATICA1 <= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(Trim(GMAl.EditText))) + '''');
  end;
  // ==========================================================================

  // Filtra in base ai tipi di movimentazione selesionata
  if CLBSegnoOpMagazzino.Enabled then
  begin
    DM1.AddSQL(QryGM, 'AND', '(');
    if CLBSegnoOpMagazzino.Checked[0] then
      DM1.AddSQL(QryGM, '', 'T.SegnoOperazione = ''+'' OR');
    if CLBSegnoOpMagazzino.Checked[1] then
      DM1.AddSQL(QryGM, '', 'T.SegnoOperazione = ''-'' OR');
    if CLBSegnoOpMagazzino.Checked[2] then
      DM1.AddSQL(QryGM, '', 'T.SegnoOperazione = ''O'' OR');
    if CLBSegnoOpMagazzino.Checked[3] then
      DM1.AddSQL(QryGM, '', 'T.SegnoOperazione = ''I'' OR');
    if CLBSegnoOpMagazzino.Checked[4] then
      DM1.AddSQL(QryGM, '', 'T.SegnoOperazione = ''='' OR T.SegnoOperazione IS NULL OR T.SegnoOperazione = '''' OR');
    QryGM.SQL[QryGM.SQL.Count - 1] := DM1.StrLeft(QryGM.SQL[QryGM.SQL.Count - 1], Length(QryGM.SQL[QryGM.SQL.Count - 1]) - 3); // Elimina l'ultimo OR
    QryGM.SQL.Add(')');
  end;
  if CLBSegnoOpCantiere.Enabled then
  begin
    DM1.AddSQL(QryGM, 'AND', '(');
    if CLBSegnoOpCantiere.Checked[0] then
      DM1.AddSQL(QryGM, '', 'T.SEGNOOPERAZIONECANTIERE = ''+'' OR');
    if CLBSegnoOpCantiere.Checked[1] then
      DM1.AddSQL(QryGM, '', 'T.SEGNOOPERAZIONECANTIERE = ''-'' OR');
    if CLBSegnoOpCantiere.Checked[2] then
      DM1.AddSQL(QryGM, '', 'T.SEGNOOPERAZIONECANTIERE = ''M'' OR');
    if CLBSegnoOpCantiere.Checked[3] then
      DM1.AddSQL(QryGM, '', 'T.SEGNOOPERAZIONECANTIERE = ''C'' OR');
    if CLBSegnoOpCantiere.Checked[4] then
      DM1.AddSQL(QryGM, '', 'T.SEGNOOPERAZIONECANTIERE = ''='' OR T.SEGNOOPERAZIONECANTIERE IS NULL OR T.SEGNOOPERAZIONECANTIERE = '''' OR');
    QryGM.SQL[QryGM.SQL.Count - 1] := DM1.StrLeft(QryGM.SQL[QryGM.SQL.Count - 1], Length(QryGM.SQL[QryGM.SQL.Count - 1]) - 3); // Elimina l'ultimo OR
    QryGM.SQL.Add(')');
  end;
  // Sottocantieri
  if Trim(GMSottocantiere1.Text) <> '' then
    DM1.AddSQL(QryGM, 'AND', 'R.Sottocantiere1 = ''' + Trim(GMSottocantiere1.Text) + '''');
  if Trim(GMSottocantiere2.Text) <> '' then
    DM1.AddSQL(QryGM, 'AND', 'R.Sottocantiere2 = ''' + Trim(GMSottocantiere2.Text) + '''');
  if Trim(GMSottocantiere3.Text) <> '' then
    DM1.AddSQL(QryGM, 'AND', 'R.Sottocantiere3 = ''' + Trim(GMSottocantiere3.Text) + '''');
  // Tipi di righi
  if Trim(GMTipo1.Text) <> '' then
    DM1.AddSQL(QryGM, 'AND', 'R.Tipo1 = ''' + Trim(GMTipo1.Text) + '''');
  if Trim(GMTipo2.Text) <> '' then
    DM1.AddSQL(QryGM, 'AND', 'R.Tipo2 = ''' + Trim(GMTipo2.Text) + '''');
  if Trim(GMTipo3.Text) <> '' then
    DM1.AddSQL(QryGM, 'AND', 'R.Tipo3 = ''' + Trim(GMTipo3.Text) + '''');
  if Trim(GMTipo4.Text) <> '' then
    DM1.AddSQL(QryGM, 'AND', 'R.Tipo4 = ''' + Trim(GMTipo4.Text) + '''');
  if Trim(GMTipo5.Text) <> '' then
    DM1.AddSQL(QryGM, 'AND', 'R.Tipo5 = ''' + Trim(GMTipo5.Text) + '''');
  if Trim(GMTipo6.Text) <> '' then
    DM1.AddSQL(QryGM, 'AND', 'R.Tipo6 = ''' + Trim(GMTipo6.Text) + '''');

  // --------------------
  // Aggiunge le condizioni di filtraggio relative alla seleziona o meno dei documenti
  // NB: Per lo fa al rovescio rispetto a prima, praticamente mette landizione di
  // non prelevare un certo tipo di documento se questo non  selezionato.Self
  if not GMDocIsChecked(IDX_VEND_PREVENTIVI) then
    QryGM.SQL.Add('AND T.TipoDocumento <> ''Preventivo''');
  if not GMDocIsChecked(IDX_VEND_ORDINI) then
    QryGM.SQL.Add('AND T.TipoDocumento <> ''Ordine''');
  if not GMDocIsChecked(IDX_VEND_SAL) then
    QryGM.SQL.Add('AND T.TipoDocumento <> ''S.A.L.''');
  if not GMDocIsChecked(IDX_VEND_BUONICONSEGNA) then
    QryGM.SQL.Add('AND T.TipoDocumento <> ''Buono_cons''');
  if not GMDocIsChecked(IDX_VEND_DDT) then
    QryGM.SQL.Add('AND T.TipoDocumento <> ''D.D.T.''');
  if not GMDocIsChecked(IDX_VEND_FATTURE) then
    QryGM.SQL.Add('AND T.TipoDocumento <> ''Fattura''');
  if not GMDocIsChecked(IDX_VEND_RICEVUTEFISCALI) then
    QryGM.SQL.Add('AND T.TipoDocumento <> ''Ricev.fisc''');
  if not GMDocIsChecked(IDX_VEND_FATTURERICEVUTEFISCALI) then
    QryGM.SQL.Add('AND T.TipoDocumento <> ''Fatt.R.F.''');
  if not GMDocIsChecked(IDX_VEND_NOTEDICREDITO) then
    QryGM.SQL.Add('AND T.TipoDocumento <> ''Nota_accre''');
  if not GMDocIsChecked(IDX_VEND_COMMESSA) then
    QryGM.SQL.Add('AND T.TipoDocumento <> ''Commessa''');
  if not GMDocIsChecked(IDX_VEND_CARICOCANTIERE) then
    QryGM.SQL.Add('AND T.TipoDocumento <> ''Carico_cantiere''');
  if not GMDocIsChecked(IDX_VEND_SCARICOCANTIERE) then
    QryGM.SQL.Add('AND T.TipoDocumento <> ''Scarico_cantiere''');
  if not GMDocIsChecked(IDX_VEND_CONTO) then
    QryGM.SQL.Add('AND T.TipoDocumento <> ''Estratto_conto''');
  if not GMDocIsChecked(IDX_VEND_INTERVENTO) then
    QryGM.SQL.Add('AND T.TipoDocumento <> ''Intervento''');

  if not GMDocIsChecked(IDX_ACQ_ORDINIFORNITORI) then
    QryGM.SQL.Add('AND T.TipoDocumento <> ''Ord.fornit''');
  if not GMDocIsChecked(IDX_ACQ_BOLLEENTRATA) then
    QryGM.SQL.Add('AND T.TipoDocumento <> ''Bolla_entr''');
  if not GMDocIsChecked(IDX_ACQ_FATTUREACQUISTO) then
    QryGM.SQL.Add('AND T.TipoDocumento <> ''Fatt.acqui''');
  if not GMDocIsChecked(IDX_ACQ_NOTEDICREDITO_FORNITORI) then
    QryGM.SQL.Add('AND T.TipoDocumento <> ''N.C.fornit''');
  // --------------------

  // Aggiunge alla query l'ORDER BY
  // NB: Se non  in GridMode (e non lo  mai) non esegue l'Order By perch lo rallenta.
  // CHiusyra
  // QryGM.SQL.SaveToFile('c:\sql.sql');
  QryGM.Open;

  // Imposta la query dei totali GM copiando le condizioni della clausa WHERE dalla QryGM
  // e anche le JOIN altrimenti d errori
  QryTotGM.Close;
  QryTotGM.SQL.Clear;
  // QryTotGM.SQL.Add('SELECT AVG(R.IMPORTORIGO/QTA) AS PREZZOMEDIO, SUM(R.QTA) AS TOTQTA, SUM(R.IMPORTORIGO) AS TOTIMPORTORIGO, SUM(R.IMPORTORIGOIVACOMPRESA) AS TOTIMPORTORIGOIVACOMPRESA,');
  QryTotGM.SQL.Add
    ('SELECT AVG(R.IMPORTORIGO/QTA) AS PREZZOMEDIO, SUM(R.IMPORTORIGO) AS TOTIMPORTORIGO, SUM(R.IMPORTORIGOIVACOMPRESA) AS TOTIMPORTORIGOIVACOMPRESA,');
  QryTotGM.SQL.Add(' SUM(   CASE R.MOVMAG WHEN ''-'' THEN (COALESCE(R.QTA,0) * -1) ELSE COALESCE(R.QTA,0) END   ) AS TOTQTA');
  for I := 25 to QryGM.SQL.Count - 1 do
    QryTotGM.SQL.Add(QryGM.SQL[I]); // NB: Copia anche i JOIN
  QryTotGM.SQL.Add('AND (QTA <> 0) AND (NOT QTA IS NULL)');
  // QryTotGM.SQL.SaveToFile('c:\sql.txt');
  QryTotGM.Open;
  // RInfresca la tabella Pivot
  PivotGridGM.Refresh;
  // SUccedeva che la PivotGrid visualizzava sempre tutto espanso e a me non piaceva
  if not QryAlreadyOpened then
    DM1.CollapseAllPivotGridFields(PivotGridGM);
  // Si posizione all'inizio
  tvGM.DataController.GotoFirst;
end;

procedure TClientiForm.AggiungiCondizioniWhereGosOre(Q: TIBOQuery);
begin
  // Se c' una pratiica selezionata visualizza solo righi relativi ai documenti della pratica
  if PraticaCorrente <> '' then
  begin
    Q.SQL.Add('AND ((CODCANTIERE=' + PraticaCorrente + ') AND (DATACANTIERE=''' + DataPraticaCorrenteSQL + '''))');
    // Se invece non c' una pratica selezionata filtra tutto per l'eventuale cliente selezionato
  end
  else
  begin
    if ClienteCorrente <> '' then
      Q.SQL.Add('AND CODSOGGETTO = ' + ClienteCorrente);
  end;
  // Dipendente
  if FilterGosCodiceDipendente.Text <> '' then
    Q.SQL.Add('AND CODDIPENDENTE = ''' + FilterGosCodiceDipendente.Text + '''');
  // Note
  if FilterGosNote.Text <> '' then
    DM1.AggiungiRicercaCampo(Q.SQL, 'NOTE', FilterGosNote.Text, True);
  // Tipo ore dipendenti
  if FilterGosTipoOre1.Text <> '' then
    Q.SQL.Add('AND TIPOORE1 LIKE ''%' + FilterGosTipoOre1.Text + '%''');
  if FilterGosTipoOre2.Text <> '' then
    Q.SQL.Add('AND TIPOORE2 LIKE ''%' + FilterGosTipoOre2.Text + '%''');
  if FilterGosTipoOre3.Text <> '' then
    Q.SQL.Add('AND TIPOORE3 LIKE ''%' + FilterGosTipoOre3.Text + '%''');
  // Sottocantieri
  if FilterGosSottocantiere1.Text <> '' then
    Q.SQL.Add('AND SOTTOCANTIERE1 LIKE ''%' + FilterGosSottocantiere1.Text + '%''');
  if FilterGosSottocantiere2.Text <> '' then
    Q.SQL.Add('AND SOTTOCANTIERE2 LIKE ''%' + FilterGosSottocantiere2.Text + '%''');
  if FilterGosSottocantiere3.Text <> '' then
    Q.SQL.Add('AND SOTTOCANTIERE3 LIKE ''%' + FilterGosSottocantiere3.Text + '%''');
  // Tipo di manodopera
  if FilterGosTipoManodopera.Text <> '' then
    Q.SQL.Add('AND OPERAINDEX = ' + LeftStr(FilterGosTipoManodopera.Text, 1));
  // Se specificate ricerca per intervallo di date
  if DM1.ControllaDataStr(GOSDal.EditText) then
    Q.SQL.Add('AND DATADOC >= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(Trim(GOSDal.EditText))) + '''');
  if DM1.ControllaDataStr(GOSAl.EditText) then
    Q.SQL.Add('AND DATADOC <= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(Trim(GOSAl.EditText))) + '''');
  // Se specificato ricerca per Agente
  if GosOreAgente.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'AGENTE  = ''' + Trim(GosOreAgente.Text) + '''');
  if GosOreAgente2.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'AGENTE2 = ''' + Trim(GosOreAgente2.Text) + '''');
  if GosOreAgente3.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'AGENTE3 = ''' + Trim(GosOreAgente3.Text) + '''');
  if GosOreAgente4.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'AGENTE4 = ''' + Trim(GosOreAgente4.Text) + '''');
  // Categorie cantieri
  if GosOreCategCant1.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'CATEGCANT1 = ''' + GosOreCategCant1.Text + '''');
  if GosOreCategCant2.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'CATEGCANT2 = ''' + GosOreCategCant2.Text + '''');
  if GosOreCategCant3.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'CATEGCANT3 = ''' + GosOreCategCant3.Text + '''');
  if GosOreCategCant4.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'CATEGCANT4 = ''' + GosOreCategCant4.Text + '''');
  if GosOreCategCant5.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'CATEGCANT5 = ''' + GosOreCategCant5.Text + '''');
  if GosOreCategCant6.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'CATEGCANT6 = ''' + GosOreCategCant6.Text + '''');
  // Tipi di righi
  if Trim(GosOreTipo1.Text) <> '' then
    DM1.AddSQL(Q, 'AND', 'TIPO1 = ''' + Trim(GosOreTipo1.Text) + '''');
  if Trim(GosOreTipo2.Text) <> '' then
    DM1.AddSQL(Q, 'AND', 'TIPO2 = ''' + Trim(GosOreTipo2.Text) + '''');
  if Trim(GosOreTipo3.Text) <> '' then
    DM1.AddSQL(Q, 'AND', 'TIPO3 = ''' + Trim(GosOreTipo3.Text) + '''');
  if Trim(GosOreTipo4.Text) <> '' then
    DM1.AddSQL(Q, 'AND', 'TIPO4 = ''' + Trim(GosOreTipo4.Text) + '''');
  if Trim(GosOreTipo5.Text) <> '' then
    DM1.AddSQL(Q, 'AND', 'TIPO5 = ''' + Trim(GosOreTipo5.Text) + '''');
  if Trim(GosOreTipo6.Text) <> '' then
    DM1.AddSQL(Q, 'AND', 'TIPO6 = ''' + Trim(GosOreTipo6.Text) + '''');
  // Altri filtri
  if FilterGosNumDoc.Text <> '' then
    Q.SQL.Add('AND NumDoc = ' + FilterGosNumDoc.Text);
  if FilterGosSoloRegistro.Text <> '' then
    Q.SQL.Add('AND Registro = ''' + FilterGosSoloRegistro.Text + '''');
  if FilterGosTranneRegistro.Text <> '' then
    Q.SQL.Add('AND Registro <> ''' + FilterGosTranneRegistro.Text + '''');
  if FilterGosStato.Text <> '' then
    Q.SQL.Add('AND StatoDescrizione = ''' + FilterGosStato.Text + '''');
end;

procedure TClientiForm.AggiungiCondizioniWhereGosSpese(Q: TIBOQuery);
begin
  // Se c' una pratiica selezionata visualizza solo righi relativi ai documenti della pratica
  if PraticaCorrente <> '' then
  begin
    Q.SQL.Add('AND ((RO.CODCANTIERE=' + PraticaCorrente + ') AND (RO.DATACANTIERE=''' + DataPraticaCorrenteSQL + '''))');
    // Se invece non c' una pratica selezionata filtra tutto per l'eventuale cliente selezionato
  end
  else
  begin
    if ClienteCorrente <> '' then
      Q.SQL.Add('AND RO.CODSOGGETTO = ' + ClienteCorrente);
  end;
  // Dipendente
  if FilterGosSpeseCodiceDipendente.Text <> '' then
    Q.SQL.Add('AND RO.CODDIPENDENTE = ''' + FilterGosSpeseCodiceDipendente.Text + '''');
  // Automezzo
  if FilterGosSpeseCodiceAutomezzo.Text <> '' then
    Q.SQL.Add('AND RO.CODAUTOMEZZO = ''' + FilterGosSpeseCodiceAutomezzo.Text + '''');
  // Note
  if FilterGosSpeseNote.Text <> '' then
    DM1.AggiungiRicercaCampo(Q.SQL, 'RO.NOTE', FilterGosSpeseNote.Text, True);
  // Tipo ore dipendenti
  if FilterGosTipoCosto1.Text <> '' then
    Q.SQL.Add('AND RO.TIPOCOSTO1 LIKE ''%' + FilterGosTipoCosto1.Text + '%''');
  if FilterGosTipoCosto2.Text <> '' then
    Q.SQL.Add('AND RO.TIPOCOSTO2 LIKE ''%' + FilterGosTipoCosto2.Text + '%''');
  if FilterGosTipoCosto3.Text <> '' then
    Q.SQL.Add('AND RO.TIPOCOSTO3 LIKE ''%' + FilterGosTipoCosto3.Text + '%''');
  // Sottocantieri
  if FilterGosSpeseSottocantiere1.Text <> '' then
    Q.SQL.Add('AND RO.SOTTOCANTIERE1 LIKE ''%' + FilterGosSpeseSottocantiere1.Text + '%''');
  if FilterGosSpeseSottocantiere2.Text <> '' then
    Q.SQL.Add('AND RO.SOTTOCANTIERE2 LIKE ''%' + FilterGosSpeseSottocantiere2.Text + '%''');
  if FilterGosSpeseSottocantiere3.Text <> '' then
    Q.SQL.Add('AND RO.SOTTOCANTIERE3 LIKE ''%' + FilterGosSpeseSottocantiere3.Text + '%''');
  // Se specificate ricerca per intervallo di date
  if DM1.ControllaDataStr(GOSSpeseDal.EditText) then
    Q.SQL.Add('AND RO.DATADOC >= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(Trim(GOSSpeseDal.EditText))) + '''');
  if DM1.ControllaDataStr(GOSSpeseAl.EditText) then
    Q.SQL.Add('AND RO.DATADOC <= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(Trim(GOSSpeseAl.EditText))) + '''');
  // Se specificato ricerca per Agente
  if GosSpeseAgente.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'AGENTE  = ''' + Trim(GosSpeseAgente.Text) + '''');
  if GosSpeseAgente2.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'AGENTE2 = ''' + Trim(GosSpeseAgente2.Text) + '''');
  if GosSpeseAgente3.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'AGENTE3 = ''' + Trim(GosSpeseAgente3.Text) + '''');
  if GosSpeseAgente4.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'AGENTE4 = ''' + Trim(GosSpeseAgente4.Text) + '''');
  // Categorie cantieri
  if GosSpeseCategCant1.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'CATEGCANT1 = ''' + GosSpeseCategCant1.Text + '''');
  if GosSpeseCategCant2.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'CATEGCANT2 = ''' + GosSpeseCategCant2.Text + '''');
  if GosSpeseCategCant3.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'CATEGCANT3 = ''' + GosSpeseCategCant3.Text + '''');
  if GosSpeseCategCant4.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'CATEGCANT4 = ''' + GosSpeseCategCant4.Text + '''');
  if GosSpeseCategCant5.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'CATEGCANT5 = ''' + GosSpeseCategCant5.Text + '''');
  if GosSpeseCategCant6.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'CATEGCANT6 = ''' + GosSpeseCategCant6.Text + '''');
  // Tipi di righi
  if Trim(GosSpeseTipo1.Text) <> '' then
    DM1.AddSQL(Q, 'AND', 'TIPO1 = ''' + Trim(GosSpeseTipo1.Text) + '''');
  if Trim(GosSpeseTipo2.Text) <> '' then
    DM1.AddSQL(Q, 'AND', 'TIPO2 = ''' + Trim(GosSpeseTipo2.Text) + '''');
  if Trim(GosSpeseTipo3.Text) <> '' then
    DM1.AddSQL(Q, 'AND', 'TIPO3 = ''' + Trim(GosSpeseTipo3.Text) + '''');
  if Trim(GosSpeseTipo4.Text) <> '' then
    DM1.AddSQL(Q, 'AND', 'TIPO4 = ''' + Trim(GosSpeseTipo4.Text) + '''');
  if Trim(GosSpeseTipo5.Text) <> '' then
    DM1.AddSQL(Q, 'AND', 'TIPO5 = ''' + Trim(GosSpeseTipo5.Text) + '''');
  if Trim(GosSpeseTipo6.Text) <> '' then
    DM1.AddSQL(Q, 'AND', 'TIPO6 = ''' + Trim(GosSpeseTipo6.Text) + '''');
  // Altri filtri
  if FilterGosSpeseNumDoc.Text <> '' then
    Q.SQL.Add('AND RO.NumDoc = ' + FilterGosSpeseNumDoc.Text);
  if FilterGosSpeseSoloRegistro.Text <> '' then
    Q.SQL.Add('AND RO.Registro = ''' + FilterGosSpeseSoloRegistro.Text + '''');
  if FilterGosSpeseTranneRegistro.Text <> '' then
    Q.SQL.Add('AND RO.Registro <> ''' + FilterGosSpeseTranneRegistro.Text + '''');
  if FilterGosSpeseStato.Text <> '' then
    Q.SQL.Add('AND T.StatoDescrizione = ''' + FilterGosSpeseStato.Text + '''');
end;

procedure TClientiForm.EseguiQueryGOSOre;
var
  QryAlreadyOpened: Boolean;
begin
  QryAlreadyOpened := QryGOSOre.Active;
  // Questa procedura imposta ed esegue la query che trover i movimenti di magazzino
  QryGOSOre.Close;
  QryGOSOre.SQL.Clear;
  QryGOSOre.SQL.Add('SELECT * FROM GOS_ORE');
  // Aggiunge una clausola WHERE finta in modo che non dia errore se non viene specificata nessuna condizione
  QryGOSOre.SQL.Add('WHERE 1=1');
  // Aggiunge le condizioni where in base ai filtri
  AggiungiCondizioniWhereGosOre(QryGOSOre);
  // CHiusyra
  QryGOSOre.Open;
  // RInfresca la tabella Pivot
  GosOrePivot.Refresh;
  // SUccedeva che la PivotGrid visualizzava sempre tutto espanso e a me non piaceva
  if not QryAlreadyOpened then
    DM1.CollapseAllPivotGridFields(GosOrePivot);
  // Si posizione all'inizio
  tvOre.DataController.GotoFirst;
end;

procedure TClientiForm.EseguiQueryGOSSpese;
var
  QryAlreadyOpened: Boolean;
begin
  QryAlreadyOpened := QryGOSSpese.Active;
  // Questa procedura imposta ed esegue la query che trover i movimenti di magazzino
  QryGOSSpese.Close;
  QryGOSSpese.SQL.Clear;
  QryGOSSpese.SQL.Add('SELECT RO.NUMDOC, RO.DATADOC, RO.REGISTRO, RO.NUMRIGO, RO.IMPORTO, RO.NOTE,  RO.TIPOCOSTO1, RO.TIPOCOSTO2, RO.TIPOCOSTO3, RO.KM,');
  QryGOSSpese.SQL.Add('RO.TIPO1, RO.TIPO2, RO.TIPO3, RO.TIPO4, RO.TIPO5, RO.TIPO6,');
  QryGOSSpese.SQL.Add('T.AGENTE, T.AGENTE2, T.AGENTE3, T.AGENTE4,');
  QryGOSSpese.SQL.Add('PRAT.CATEGCANT1, PRAT.CATEGCANT2, PRAT.CATEGCANT3, PRAT.CATEGCANT4, PRAT.CATEGCANT5, PRAT.CATEGCANT6,');
  QryGOSSpese.SQL.Add(' CAST(RO.TIPODOC || '' '' || RO.NUMDOC || RO.REGISTRO || '' del '' || RO.DATADOC AS VARCHAR(80)) AS DOCUMENTO,');
  QryGOSSpese.SQL.Add(' CAST(RO.DESCRIZDIPENDENTE || ''  ('' || RO.CODDIPENDENTE || '')'' AS VARCHAR(100)) AS DIPENDENTE,');
  QryGOSSpese.SQL.Add(' CAST(RO.DESCRIZCANTIERE || ''  ('' || RO.CODCANTIERE || '' del '' || RO.DATACANTIERE || '')'' AS VARCHAR(100)) AS CANTIERE,');
  QryGOSSpese.SQL.Add(' CAST(RO.DESCRIZSOGGETTO || ''  ('' || RO.CODSOGGETTO || '')'' AS VARCHAR(100)) AS SOGGETTO,');
  QryGOSSpese.SQL.Add(' CAST(RO.DESCRIZAUTOMEZZO || ''  ('' || RO.CODAUTOMEZZO || '')'' AS VARCHAR(110)) AS AUTOMEZZO,');
  QryGOSSpese.SQL.Add(' RO.SOTTOCANTIERE1, RO.SOTTOCANTIERE2, RO.SOTTOCANTIERE3, RO.TIPODOC,');
  QryGOSSpese.SQL.Add(' T.STATODESCRIZIONE, T.STATOFOREGROUND, T.STATOBACKGROUND');
  QryGOSSpese.SQL.Add('FROM RAPGIORNRIGHISPESE RO');
  QryGOSSpese.SQL.Add('LEFT JOIN RAPGIORN T ON (T.NUMDOC=RO.NUMDOC AND T.REGISTRO=RO.REGISTRO AND T.DATADOC=RO.DATADOC)');
  QryGOSSpese.SQL.Add('LEFT JOIN PRATICHE PRAT ON (PRAT.CODICE=RO.CODCANTIERE AND PRAT.DATAAPERTURA=RO.DATACANTIERE)');
  // Aggiunge una clausola WHERE finta in modo che non dia errore se non viene specificata nessuna condizione
  QryGOSSpese.SQL.Add('WHERE 1=1');
  // Aggiunge le clausole where in base ai filtri
  AggiungiCondizioniWhereGosSpese(QryGOSSpese);
  // CHiusyra
  QryGOSSpese.Open;
  // RInfresca la tabella Pivot
  GosSpesePivot.Refresh;
  // SUccedeva che la PivotGrid visualizzava sempre tutto espanso e a me non piaceva
  if not QryAlreadyOpened then
    DM1.CollapseAllPivotGridFields(GosSpesePivot);
  // Si posizione all'inizio
  tvSpese.DataController.GotoFirst;
end;

procedure TClientiForm.ImpostaTitoloGraficoDipendenti;
begin
  with ChvOre.Title do
  begin
    Text := 'Grafico ' + GOSTipoDatoOre.EditValue + ' ' + GOSTipoDatoSoggetti.EditingValue;
    if GOSSuddivisioneOre.EditValue = 'Totale' then
      Text := Text + ' totale.'
    else
      Text := Text + ' suddiviso per ' + GOSSuddivisioneOre.EditValue + '.';
  end;
end;

procedure TClientiForm.ImpostaTitoloGraficoSpese;
begin
  with ChvSpese.Title do
  begin
    Text := 'Grafico spese';
    if GOSSuddivisioneSpese.EditValue = 'Totale' then
      Text := Text + ' totale.'
    else
      Text := Text + ' suddiviso per ' + GOSSuddivisioneSpese.EditValue + '.';
  end;
end;

procedure TClientiForm.PopolaGraficoOreGOS;
var
  QryCat, QrySer: TIB_Cursor;
  QryVal: TIBOQuery;
  I: Integer;
  ASeries: TcxGridChartSeries;
  TmpValoriDato, TmpSeries, TmpSeriesForGroupBy: String;
begin
  // IMposta il titolo del grafico
  ImpostaTitoloGraficoDipendenti;
  // Crea l'oggetto query
  QryCat := TIB_Cursor.Create(Self);
  QrySer := TIB_Cursor.Create(Self);
  QryVal := TIBOQuery.Create(Self);
  try
    QryCat.DatabaseName := DM1.ArcDBFile;
    QryCat.IB_Connection := DM1.DBAzienda;
    QrySer.DatabaseName := DM1.ArcDBFile;
    QrySer.IB_Connection := DM1.DBAzienda;
    QryVal.DatabaseName := DM1.ArcDBFile;
    QryVal.IB_Connection := DM1.DBAzienda;

    // ========================================================================
    // Impostazione CATEGORY (Elenco dipendenti)
    // ------------------------------------------------------------------------
    QryCat.SQL.Add('SELECT DISTINCT CODDIPENDENTE, DESCRIZDIPENDENTE FROM RAPGIORNRIGHI ORDER BY DESCRIZDIPENDENTE');
    QryCat.Open;
    ChvOre.Categories.ValueCount := 0; // Svuota tutto
    ChvOre.Categories.DataBinding.ValueType := 'String'; // Imposta il tipo di valore
    ChvOre.Categories.ValueCount := QryCat.RecordCount; // Imposta il numero delle categorie
    // ========================================================================

    // ========================================================================
    // Impostazione SERIES (Elenco dei tipi di valori)
    // ------------------------------------------------------------------------
    // Impostazione del campo per prelevare il tipo di suddivisione voluto
    if GOSSuddivisioneOre.EditValue = 'Totale' then
    begin
      TmpSeries := 'Totale';
      TmpSeriesForGroupBy := 'Totale';
    end
    else if GOSSuddivisioneOre.EditValue = 'Tipo ore 1' then
    begin
      TmpSeries := 'OREDIP1';
      TmpSeriesForGroupBy := 'TIPOORE1';
    end
    else if GOSSuddivisioneOre.EditValue = 'Tipo ore 2' then
    begin
      TmpSeries := 'OREDIP2';
      TmpSeriesForGroupBy := 'TIPOORE2';
    end
    else if GOSSuddivisioneOre.EditValue = 'Tipo ore 3' then
    begin
      TmpSeries := 'OREDIP3';
      TmpSeriesForGroupBy := 'TIPOORE3';
    end;
    // Se si sono chiesti i totali imposta 'Totali' come unica serie
    if TmpSeries = 'Totale' then
    begin
      ChvOre.ClearSeries;
      ASeries := ChvOre.CreateSeries;
      ASeries.Name := 'TotaliOre';
      ASeries.DisplayText := 'Totali';
      ASeries.DataBinding.ValueType := 'Float';
      // Se invece si  scelto un tipo di suddivisione imposta la query per prelevare le series
    end
    else
    begin
      // e le carica.
      // Impostazione testo query
      QrySer.SQL.Add('SELECT DESCRIZIONE FROM TIPIOREDIPENDENTI WHERE TIPO = ''' + TmpSeries + '''');
      QrySer.Open;
      ChvOre.ClearSeries;
      // Caricamento series
      ASeries := ChvOre.CreateSeries;
      ASeries.DisplayText := 'Indefinito';
      ASeries.DataBinding.ValueType := 'Float';
      while not QrySer.Eof do
      begin
        ASeries := ChvOre.CreateSeries;
        ASeries.DisplayText := QrySer.Fields[0].AsString;
        ASeries.DataBinding.ValueType := 'Float';
        QrySer.Next;
      end;
    end;
    // ========================================================================

    // ========================================================================
    // IMpostazione query VALORI
    // ------------------------------------------------------------------------
    // Impostazione del campo per prelevare il tipo di dato desiderato
    if GOSTipoDatoOre.EditValue = 'Ore' then
      TmpValoriDato := 'QTA'
    else if GOSTipoDatoOre.EditValue = 'Costo' then
      TmpValoriDato := 'IMPORTOCOSTOORARIO'
    else if GOSTipoDatoOre.EditValue = 'Vendita' then
      TmpValoriDato := 'IMPORTOVEND';
    // Impostazione testo query
    if TmpSeries = 'Totale' then
    begin
      QryVal.SQL.Add('SELECT ''Totali'' AS SERIE, SUM(RO.' + TmpValoriDato + ') AS VALORE FROM RAPGIORNRIGHI RO');
      QryVal.SQL.Add('WHERE RO.CODDIPENDENTE = :P_ID_CAT');
      // Aggiunge le condizioni where in base ai filtri
      AggiungiCondizioniWhereGosOre(QryVal);
    end
    else
    begin
      QryVal.SQL.Add('SELECT RO.' + TmpSeriesForGroupBy + ' AS SERIE, SUM(RO.' + TmpValoriDato + ') AS VALORE FROM RAPGIORNRIGHI RO');
      QryVal.SQL.Add('WHERE RO.CODDIPENDENTE = :P_ID_CAT');
      // Aggiunge le condizioni where in base ai filtri
      AggiungiCondizioniWhereGosOre(QryVal);
      // Aggiunge il group by dopo la clausola where
      QryVal.SQL.Add('GROUP BY RO.' + TmpSeriesForGroupBy);
    end;
    // Cicla per tutte le categorie...
    I := 0;
    while not QryCat.Eof do
    begin
      // IMposta il valore della categoria corrente
      ChvOre.Categories.Values[I] := QryCat.Fields[1].AsString;
      // Carica i valori dalla categoria corrente
      QryVal.Close;
      QryVal.ParamByName('P_ID_CAT').Value := QryCat.Fields[0].AsInteger;
      QryVal.Open;
      // Cicla per tutti i valori trovati per caricarli
      while not QryVal.Eof do
      begin
        // Individua la serie
        if QryVal.FieldByName('SERIE').IsNull then
          ASeries := ChartSeriesByDisplayText(ChvOre, 'Indefinito')
        else
          ASeries := ChartSeriesByDisplayText(ChvOre, QryVal.FieldByName('SERIE').AsString);
        // Carica il valore
        if ASeries <> nil then
          ASeries.Values[I] := QryVal.FieldByName('VALORE').AsFloat;
        QryVal.Next;
      end;
      Inc(I);
      QryCat.Next;
    end;
    // ========================================================================
  finally
    QryCat.Free;
    QrySer.Free;
    QryVal.Free;
  end;
end;

procedure TClientiForm.PopolaGraficoSpeseGOS;
var
  QryCat, QrySer: TIB_Cursor;
  QryVal: TIBOQuery;
  I: Integer;
  ASeries: TcxGridChartSeries;
  TmpValoriDato, TmpSeries, TmpSeriesForGroupBy: String;
begin
  // IMposta il titolo del grafico
  ImpostaTitoloGraficoSpese;
  // Crea l'oggetto query
  QryCat := TIB_Cursor.Create(Self);
  QrySer := TIB_Cursor.Create(Self);
  QryVal := TIBOQuery.Create(Self);
  try
    QryCat.DatabaseName := DM1.ArcDBFile;
    QryCat.IB_Connection := DM1.DBAzienda;
    QrySer.DatabaseName := DM1.ArcDBFile;
    QrySer.IB_Connection := DM1.DBAzienda;
    QryVal.DatabaseName := DM1.ArcDBFile;
    QryVal.IB_Connection := DM1.DBAzienda;

    // ========================================================================
    // Impostazione CATEGORY (Elenco dipendenti)
    // ------------------------------------------------------------------------
    QryCat.SQL.Add('SELECT DISTINCT CODDIPENDENTE, DESCRIZDIPENDENTE FROM RAPGIORNRIGHISPESE ORDER BY DESCRIZDIPENDENTE');
    QryCat.Open;
    ChvSpese.Categories.ValueCount := 0; // Svuota tutto
    ChvSpese.Categories.DataBinding.ValueType := 'String'; // Imposta il tipo di valore
    ChvSpese.Categories.ValueCount := QryCat.RecordCount; // Imposta il numero delle categorie
    // ========================================================================

    // ========================================================================
    // Impostazione SERIES (Elenco dei tipi di valori)
    // ------------------------------------------------------------------------
    // Impostazione del campo per prelevare il tipo di suddivisione voluto
    if GOSSuddivisioneSpese.EditValue = 'Totale' then
    begin
      TmpSeries := 'Totale';
      TmpSeriesForGroupBy := 'Totale';
    end
    else if GOSSuddivisioneSpese.EditValue = 'Tipo costo 1' then
    begin
      TmpSeries := 'TIPOSPESA1';
      TmpSeriesForGroupBy := 'TIPOCOSTO1';
    end
    else if GOSSuddivisioneSpese.EditValue = 'Tipo costo 2' then
    begin
      TmpSeries := 'TIPOSPESA2';
      TmpSeriesForGroupBy := 'TIPOCOSTO2';
    end
    else if GOSSuddivisioneSpese.EditValue = 'Tipo costo 3' then
    begin
      TmpSeries := 'TIPOSPESA3';
      TmpSeriesForGroupBy := 'TIPOCOSTO3';
    end;
    // Se si sono chiesti i totali imposta 'Totali' come unica serie
    if TmpSeries = 'Totale' then
    begin
      ChvSpese.ClearSeries;
      ASeries := ChvSpese.CreateSeries;
      ASeries.Name := 'TotaliSpese';
      ASeries.DisplayText := 'Totali';
      ASeries.DataBinding.ValueType := 'Float';
      // Se invece si  scelto un tipo di suddivisione imposta la query per prelevare le series
    end
    else
    begin
      // e le carica.
      // Impostazione testo query
      QrySer.SQL.Add('SELECT DESCRIZIONE FROM TIPIOREDIPENDENTI WHERE TIPO = ''' + TmpSeries + '''');
      QrySer.Open;
      ChvSpese.ClearSeries;
      // Caricamento series
      ASeries := ChvSpese.CreateSeries;
      ASeries.DisplayText := 'Indefinito';
      ASeries.DataBinding.ValueType := 'Float';
      while not QrySer.Eof do
      begin
        ASeries := ChvSpese.CreateSeries;
        ASeries.DisplayText := QrySer.Fields[0].AsString;
        ASeries.DataBinding.ValueType := 'Float';
        QrySer.Next;
      end;
    end;
    // ========================================================================

    // ========================================================================
    // IMpostazione query VALORI
    // ------------------------------------------------------------------------
    // Impostazione del campo per prelevare il tipo di dato desiderato
    if GOSTipoDatoSpese.EditValue = 'Ore' then
      TmpValoriDato := 'QTA'
    else if GOSTipoDatoSpese.EditValue = 'Costo' then
      TmpValoriDato := 'IMPORTO'
    else if GOSTipoDatoSpese.EditValue = 'Vendita' then
      TmpValoriDato := 'IMPORTOVEND';
    // Impostazione testo query
    if TmpSeries = 'Totale' then
    begin
      QryVal.SQL.Add('SELECT ''Totali'' AS SERIE, SUM(RO.' + TmpValoriDato + ') AS VALORE FROM RAPGIORNRIGHISPESE RO WHERE RO.CODDIPENDENTE = :P_ID_CAT');
      // Aggiunge le condizioni where in base ai filtri
      AggiungiCondizioniWhereGosSpese(QryVal);
    end
    else
    begin
      QryVal.SQL.Add('SELECT RO.' + TmpSeriesForGroupBy + ' AS SERIE, SUM(RO.' + TmpValoriDato +
        ') AS VALORE FROM RAPGIORNRIGHISPESE RO WHERE RO.CODDIPENDENTE = :P_ID_CAT');
      // Aggiunge le condizioni where in base ai filtri
      AggiungiCondizioniWhereGosSpese(QryVal);
      // Aggiunge il group by dopo la clausola where
      QryVal.SQL.Add('GROUP BY RO.' + TmpSeriesForGroupBy);
    end;
    // Cicla per tutte le categorie...
    I := 0;
    while not QryCat.Eof do
    begin
      // IMposta il valore della categoria corrente
      ChvSpese.Categories.Values[I] := QryCat.Fields[1].AsString;
      // Carica i valori dalla categoria corrente
      QryVal.Close;
      QryVal.ParamByName('P_ID_CAT').Value := QryCat.Fields[0].AsInteger;
      QryVal.Open;
      // Cicla per tutti i valori trovati per caricarli
      while not QryVal.Eof do
      begin
        // Individua la serie
        if QryVal.FieldByName('SERIE').IsNull then
          ASeries := ChartSeriesByDisplayText(ChvSpese, 'Indefinito')
        else
          ASeries := ChartSeriesByDisplayText(ChvSpese, QryVal.FieldByName('SERIE').AsString);
        // Carica il valore
        if ASeries <> nil then
          ASeries.Values[I] := QryVal.FieldByName('VALORE').AsFloat;
        QryVal.Next;
      end;
      Inc(I);
      QryCat.Next;
    end;
    // ========================================================================
  finally
    QryCat.Free;
    QrySer.Free;
    QryVal.Free;
  end;
end;

function TClientiForm.ChartSeriesByDisplayText(C: TcxGridChartView; T: String): TcxGridChartSeries;
var
  I: Integer;
begin
  Result := nil;
  for I := 0 to C.SeriesCount - 1 do
  begin
    if C.Series[I].DisplayText = T then
    begin
      Result := C.Series[I];
      Break;
    end;
  end;
end;

procedure TClientiForm.AggiornaSoggettiPratica;
var
  New: String;
  CodSog: Longint;
  Qry: TIB_Cursor;
begin
  // Inizializzazione
  New := '+'; // F in modo che ci sia sempre almeno un carattere nel campo altrimenti non funziona l'aggiornamento
  // del campo 'AltriSoggetti' nella procedura 'AggiungiSoggettoAllaPratica' che viene chiamata alla comferma
  // di un documento; non s perch non funziona, probabilmente perch con SQL e il campo nullo non v proprio.
  // Crea l'oggetto query
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    // Ovviamente solo se la QueryDocSel  attiva
    if DM1.QueryDocSel.Active then
    begin
      // Si posiziona all'inizio dell'elenco dei documenti selezionati e poi li scorre uno ad uno
      // e controlla se, i relativi soggetti, sono gi registrati nel campo 'AltriSoggetti', se non lo
      // sono li registra altrimenti passa al documento successivo.
      DM1.QueryDocSel.First;
      while not DM1.QueryDocSel.Eof do
      begin
        // NB: I codici Soggetto vengono inseriti nell'elenco dei soggetti preceduti da uno spazio di separazione e poi
        // viene sempre ricercato il codice preceduto da un '<' e seguito da un '>' in modo da evitare che venga trovato
        // un codice solo parzialmente.
        CodSog := DM1.QueryDocSel.FieldByName('CodiceSoggetto').Value;
        // Solo quelli che non sono gi inseriti e che non sono l'intestatario della pratica
        if (Pos('<' + IntToStr(CodSog) + '>', New) = 0) and (CodSog <> StrToInt(ClienteCorrente)) then
        begin
          New := New + '<' + DM1.QueryDocSel.FieldByName('CodiceSoggetto').AsString + '>';
        end;
        DM1.QueryDocSel.Next;
      end;
      // Alla fine aggiorna il campo 'AltriSoggetti' della pratica con l'elenco ottenuto.
      Qry.SQL.Add('UPDATE PRATICHE SET ALTRISOGGETTI = ''' + New + '''');
      Qry.SQL.Add('WHERE CODICE = ' + PraticaCorrente);
      Qry.SQL.Add('  AND DATAAPERTURA = ''' + DataPraticaCorrenteSQL + '''');
      Qry.ExecSQL;
      // Si riposiziona al primo elemento
      DM1.QueryDocSel.First;
    end;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.CaricaFormLayout;
var
  LO: TMemIniFile;
  Sez, TmpStr, FieldName: String;
  I: Integer;
  CurrCol: TcxGridDBColumn;
begin
  // Rende invisibile il Tab se non abilitato dalla chiave
  TabMagazzino.TabVisible := (DM1.ModCtrl(MOD_GIORNALE_MAGAZZINO) > 0);
  // Rende invisibile il Tab se non abilitato dalla chiave
  TabCondVend.TabVisible := (DM1.ModCtrl(MOD_CONDIZIONI_VENDITA) > 0);
  // Carica la Bitmap del pulsante di pagamento/riscossione
  SBPagamentoRiscossione.Glyph.LoadFromFile(DM1.TemaDir + 'btn_pagamento.bmp');
  // Caricamento di titoli e captions
  CaricaTitoli;
  // Apertura file layouts.ini
  LO := TMemIniFile.Create(DM1.Repository_Layouts.FullLocalFileName);
  try
    // ========================================================================
    // Settaggio FILTRI AGENTI
    // ------------------------------------------------------------------------
    // Rubrica
    LabelFilterClientiAgente.Visible := (DM1.GridsColumnAgenteCaption <> '');
    LabelFilterClientiAgente2.Visible := (DM1.GridsColumnAgente2Caption <> '');
    LabelFilterClientiAgente3.Visible := (DM1.GridsColumnAgente3Caption <> '');
    LabelFilterClientiAgente4.Visible := (DM1.GridsColumnAgente4Caption <> '');
    EditClientiAgente.Visible := LabelFilterClientiAgente.Visible;
    EditClientiAgente2.Visible := LabelFilterClientiAgente2.Visible;
    EditClientiAgente3.Visible := LabelFilterClientiAgente3.Visible;
    EditClientiAgente4.Visible := LabelFilterClientiAgente4.Visible;
    // Documenti
    LabelFilterDocAgente.Visible := (DM1.GridsColumnAgenteCaption <> '');
    LabelFilterDocAgente2.Visible := (DM1.GridsColumnAgente2Caption <> '');
    LabelFilterDocAgente3.Visible := (DM1.GridsColumnAgente3Caption <> '');
    LabelFilterDocAgente4.Visible := (DM1.GridsColumnAgente4Caption <> '');
    DocAgente.Visible := LabelFilterDocAgente.Visible;
    DocAgente2.Visible := LabelFilterDocAgente2.Visible;
    DocAgente3.Visible := LabelFilterDocAgente3.Visible;
    DocAgente4.Visible := LabelFilterDocAgente4.Visible;
    // GM
    LabelGMAgente.Visible := (DM1.GridsColumnAgenteCaption <> '');
    LabelGMAgente2.Visible := (DM1.GridsColumnAgente2Caption <> '');
    LabelGMAgente3.Visible := (DM1.GridsColumnAgente3Caption <> '');
    LabelGMAgente4.Visible := (DM1.GridsColumnAgente4Caption <> '');
    GMAgente.Visible := LabelGMAgente.Visible;
    GMAgente2.Visible := LabelGMAgente2.Visible;
    GMAgente3.Visible := LabelGMAgente3.Visible;
    GMAgente4.Visible := LabelGMAgente4.Visible;
    // GOS
    GosOreLabelAgente.Visible := (DM1.GridsColumnAgenteCaption <> '');
    GosOreLabelAgente2.Visible := (DM1.GridsColumnAgente2Caption <> '');
    GosOreLabelAgente3.Visible := (DM1.GridsColumnAgente3Caption <> '');
    GosOreLabelAgente4.Visible := (DM1.GridsColumnAgente4Caption <> '');
    GosOreAgente.Visible := GosOreLabelAgente.Visible;
    GosOreAgente2.Visible := GosOreLabelAgente2.Visible;
    GosOreAgente3.Visible := GosOreLabelAgente3.Visible;
    GosOreAgente4.Visible := GosOreLabelAgente4.Visible;
    GosSpeseLabelAgente.Visible := (DM1.GridsColumnAgenteCaption <> '');
    GosSpeseLabelAgente2.Visible := (DM1.GridsColumnAgente2Caption <> '');
    GosSpeseLabelAgente3.Visible := (DM1.GridsColumnAgente3Caption <> '');
    GosSpeseLabelAgente4.Visible := (DM1.GridsColumnAgente4Caption <> '');
    GosSpeseAgente.Visible := GosSpeseLabelAgente.Visible;
    GosSpeseAgente2.Visible := GosSpeseLabelAgente2.Visible;
    GosSpeseAgente3.Visible := GosSpeseLabelAgente3.Visible;
    GosSpeseAgente4.Visible := GosSpeseLabelAgente4.Visible;
    // Pratiche
    LabelPratAgente.Visible := (DM1.GridsColumnAgenteCaption <> '');
    LabelPratAgente2.Visible := (DM1.GridsColumnAgente2Caption <> '');
    LabelPratAgente3.Visible := (DM1.GridsColumnAgente3Caption <> '');
    LabelPratAgente4.Visible := (DM1.GridsColumnAgente4Caption <> '');
    PratAgente.Visible := LabelPratAgente.Visible;
    PratAgente2.Visible := LabelPratAgente2.Visible;
    PratAgente3.Visible := LabelPratAgente3.Visible;
    PratAgente4.Visible := LabelPratAgente4.Visible;
    // Scadenze
    LabelFilterScadAgente.Visible := (DM1.GridsColumnAgenteCaption <> '');
    LabelFilterScadAgente2.Visible := (DM1.GridsColumnAgente2Caption <> '');
    LabelFilterScadAgente3.Visible := (DM1.GridsColumnAgente3Caption <> '');
    LabelFilterScadAgente4.Visible := (DM1.GridsColumnAgente4Caption <> '');
    ScadAgente.Visible := (DM1.GridsColumnAgenteCaption <> '');
    ScadAgente2.Visible := (DM1.GridsColumnAgente2Caption <> '');
    ScadAgente3.Visible := (DM1.GridsColumnAgente3Caption <> '');
    ScadAgente4.Visible := (DM1.GridsColumnAgente4Caption <> '');
    // Primanota
    LabelPrmAgente.Visible := (DM1.GridsColumnAgenteCaption <> '');
    LabelPrmAgente2.Visible := (DM1.GridsColumnAgente2Caption <> '');
    LabelPrmAgente3.Visible := (DM1.GridsColumnAgente3Caption <> '');
    LabelPrmAgente4.Visible := (DM1.GridsColumnAgente4Caption <> '');
    PrmAgente.Visible := (DM1.GridsColumnAgenteCaption <> '');
    PrmAgente2.Visible := (DM1.GridsColumnAgente2Caption <> '');
    PrmAgente3.Visible := (DM1.GridsColumnAgente3Caption <> '');
    PrmAgente4.Visible := (DM1.GridsColumnAgente4Caption <> '');
    // Impegni
    LabelImpFilterAgente.Visible := (DM1.GridsColumnAgenteCaption <> '');
    LabelImpFilterAgente2.Visible := (DM1.GridsColumnAgente2Caption <> '');
    LabelImpFilterAgente3.Visible := (DM1.GridsColumnAgente3Caption <> '');
    LabelImpFilterAgente4.Visible := (DM1.GridsColumnAgente4Caption <> '');
    ImpAgente.Visible := (DM1.GridsColumnAgenteCaption <> '');
    ImpAgente2.Visible := (DM1.GridsColumnAgente2Caption <> '');
    ImpAgente3.Visible := (DM1.GridsColumnAgente3Caption <> '');
    ImpAgente4.Visible := (DM1.GridsColumnAgente4Caption <> '');
    // ========================================================================

    // ========================================================================
    // Settaggio GRID MODE per le griglie
    // ------------------------------------------------------------------------
    Sez := 'GridMode';
    tvRubrica.DataController.DataModeController.GridMode := LO.ReadBool(Sez, 'tvRubrica', False);
    tvDoc.DataController.DataModeController.GridMode := LO.ReadBool(Sez, 'tvDoc', False);
    tvGM.DataController.DataModeController.GridMode := LO.ReadBool(Sez, 'tvGM', False);
    tvCV.DataController.DataModeController.GridMode := LO.ReadBool(Sez, 'tvCV', False);
    tvPrat.DataController.DataModeController.GridMode := LO.ReadBool(Sez, 'tvPrat', False);
    tvScad.DataController.DataModeController.GridMode := LO.ReadBool(Sez, 'tvScad', False);
    tvPrimanota.DataController.DataModeController.GridMode := LO.ReadBool(Sez, 'tvPrimanota', False);
    tvImpegni.DataController.DataModeController.GridMode := LO.ReadBool(Sez, 'tvImpegni', False);
    tvOre.DataController.DataModeController.GridMode := LO.ReadBool(Sez, 'tvOre', False);
    tvSpese.DataController.DataModeController.GridMode := LO.ReadBool(Sez, 'tvSpese', False);

    tvArt.DataController.DataModeController.GridMode := LO.ReadBool(Sez, 'tvArt', True);
    tvLF.DataController.DataModeController.GridMode := tvArt.DataController.DataModeController.GridMode;
    tvArtMag.DataController.DataModeController.GridMode := tvArt.DataController.DataModeController.GridMode;
    // ========================================================================

    // ========================================================================
    // Settaggio CELL AUTO HEIGHT per le griglie
    // ------------------------------------------------------------------------
    Sez := 'CellAutoHeight';
    tvRubrica.OptionsView.CellAutoHeight := LO.ReadBool(Sez, 'tvRubrica', True);
    tvDoc.OptionsView.CellAutoHeight := LO.ReadBool(Sez, 'tvDoc', True);
    tvGM.OptionsView.CellAutoHeight := LO.ReadBool(Sez, 'tvGM', False);
    tvCV.OptionsView.CellAutoHeight := LO.ReadBool(Sez, 'tvCV', False);
    tvPrat.OptionsView.CellAutoHeight := LO.ReadBool(Sez, 'tvPrat', True);
    tvScad.OptionsView.CellAutoHeight := LO.ReadBool(Sez, 'tvScad', True);
    tvPrimanota.OptionsView.CellAutoHeight := LO.ReadBool(Sez, 'tvPrimanota', True);
    tvImpegni.OptionsView.CellAutoHeight := LO.ReadBool(Sez, 'tvImpegni', True);
    tvOre.OptionsView.CellAutoHeight := LO.ReadBool(Sez, 'tvOre', True);
    tvSpese.OptionsView.CellAutoHeight := LO.ReadBool(Sez, 'tvSpese', True);
    tvArt.OptionsView.CellAutoHeight := LO.ReadBool(Sez, 'tvArt', True);
    // ========================================================================

    // ========================================================================
    // ELENCO PRATICHE/CANTIERI
    // ------------------------------------------------------------------------
    Sez := 'FormPratiche';
    // Colonne JOLLY
    // Cicla per tuttii campi jolly
    for I := 1 to 13 do
    begin
      // Costruisce il nome del campo
      FieldName := 'Jolly' + IntToStr(I);
      // Legge l'impostazione del campo jolly attuale
      TmpStr := LO.ReadString(Sez, FieldName, '0');
      // Se non  abilitato esce
      if TmpStr = '0' then
        Continue;
      // Depura il titolo da eventuali altri titoli
      while DM1.RitornaTestoPrimaDi('_', TmpStr, True) <> '' do;
      // Imposta il titolo della colonna
      CurrCol := tvPrat.GetColumnByFieldName(FieldName);
      CurrCol.Caption := TmpStr;
      CurrCol.VisibleForCustomization := True;
    end;
    // Filtri
    Self.Filter_Visible_CategCant1 := (DM1.CategCantCaption1 <> '0');
    Self.Filter_Visible_CategCant2 := (DM1.CategCantCaption2 <> '0');
    Self.Filter_Visible_CategCant3 := (DM1.CategCantCaption3 <> '0');
    Self.Filter_Visible_CategCant4 := (DM1.CategCantCaption4 <> '0');
    Self.Filter_Visible_CategCant5 := (DM1.CategCantCaption5 <> '0');
    Self.Filter_Visible_CategCant6 := (DM1.CategCantCaption6 <> '0');
    // In base ai filtri abilitati o disabilitati relativi alle categorie cantieri
    // cerca di limitarne l'occupazione se non visibili
    PanelFilterCategorieCantieri.Height := 0;
    PanelFilterCategorieCantieri.Visible := False;
    if (Self.Filter_Visible_CategCant1 or Self.Filter_Visible_CategCant2 or Self.Filter_Visible_CategCant3) then
    begin
      PanelFilterCategorieCantieri.Visible := True;
      PanelFilterCategorieCantieri.Height := 19;
    end;
    if (Self.Filter_Visible_CategCant4 or Self.Filter_Visible_CategCant5 or Self.Filter_Visible_CategCant6) then
    begin
      PanelFilterCategorieCantieri.Visible := True;
      PanelFilterCategorieCantieri.Height := 38;
    end;
    // Dimesiona il SubPanel che contiene i filtri in modo che riadatti
    SubPanelPratFiltri.Height := PanelFilterCategorieCantieri.Top + PanelFilterCategorieCantieri.Height;
    // Rende visualizzabili o meno le colonne delle categorie cantieri (customize)
    tvPratCATEGCANT1.VisibleForCustomization := Self.Filter_Visible_CategCant1;
    tvPratCATEGCANT2.VisibleForCustomization := Self.Filter_Visible_CategCant2;
    tvPratCATEGCANT3.VisibleForCustomization := Self.Filter_Visible_CategCant3;
    tvPratCATEGCANT4.VisibleForCustomization := Self.Filter_Visible_CategCant4;
    tvPratCATEGCANT5.VisibleForCustomization := Self.Filter_Visible_CategCant5;
    tvPratCATEGCANT6.VisibleForCustomization := Self.Filter_Visible_CategCant6;
    // ========================================================================

    // ========================================================================
    // GIORNALE DI MAGAZZINO
    // ------------------------------------------------------------------------
    Sez := 'GiornaleMagazzino';
    // Filtri
    Self.GMTipo1.Visible := LO.ReadBool(Sez, 'Filter_TipoRigo1', False);
    Self.GMTipo2.Visible := LO.ReadBool(Sez, 'Filter_TipoRigo2', False);
    Self.GMTipo3.Visible := LO.ReadBool(Sez, 'Filter_TipoRigo3', False);
    Self.GMTipo4.Visible := LO.ReadBool(Sez, 'Filter_TipoRigo4', False);
    Self.GMTipo5.Visible := LO.ReadBool(Sez, 'Filter_TipoRigo5', False);
    Self.GMTipo6.Visible := LO.ReadBool(Sez, 'Filter_TipoRigo6', False);
    Self.GMLabelTipo1.Visible := Self.GMTipo1.Visible;
    Self.GMLabelTipo2.Visible := Self.GMTipo2.Visible;
    Self.GMLabelTipo3.Visible := Self.GMTipo3.Visible;
    Self.GMLabelTipo4.Visible := Self.GMTipo4.Visible;
    Self.GMLabelTipo5.Visible := Self.GMTipo5.Visible;
    Self.GMLabelTipo6.Visible := Self.GMTipo6.Visible;
    // Colonne
    Self.tvGMTIPO1.Visible := LO.ReadBool(Sez, 'GM_Column_Tipo1', False);
    Self.tvGMTIPO2.Visible := LO.ReadBool(Sez, 'GM_Column_Tipo2', False);
    Self.tvGMTIPO3.Visible := LO.ReadBool(Sez, 'GM_Column_Tipo3', False);
    Self.tvGMTIPO4.Visible := LO.ReadBool(Sez, 'GM_Column_Tipo4', False);
    Self.tvGMTIPO5.Visible := LO.ReadBool(Sez, 'GM_Column_Tipo5', False);
    Self.tvGMTIPO6.Visible := LO.ReadBool(Sez, 'GM_Column_Tipo6', False);
    // In base ai filtri abilitati o disabilitati relativi alle categorie cantieri
    // cerca di limitarne l'occupazione se non visibili
    PanelFilterGMCategorieCantieri.Height := 0;
    PanelFilterGMCategorieCantieri.Visible := False;
    if (Self.Filter_Visible_CategCant1 or Self.Filter_Visible_CategCant2 or Self.Filter_Visible_CategCant3) then
    begin
      PanelFilterGMCategorieCantieri.Visible := True;
      PanelFilterGMCategorieCantieri.Height := 17;
    end;
    if (Self.Filter_Visible_CategCant4 or Self.Filter_Visible_CategCant5 or Self.Filter_Visible_CategCant6) then
    begin
      PanelFilterGMCategorieCantieri.Visible := True;
      PanelFilterGMCategorieCantieri.Height := 35;
    end;
    // Dimesiona il SubPanel che contiene i filtri in modo che riadatti
    SubPanelGMFiltri.Height := PanelFilterGMCategorieCantieri.Top + PanelFilterGMCategorieCantieri.Height;
    // Rende visualizzabili o meno le colonne delle categorie cantieri (customize)
    tvGMCATEGCANT1.VisibleForCustomization := Self.Filter_Visible_CategCant1;
    tvGMCATEGCANT2.VisibleForCustomization := Self.Filter_Visible_CategCant2;
    tvGMCATEGCANT3.VisibleForCustomization := Self.Filter_Visible_CategCant3;
    tvGMCATEGCANT4.VisibleForCustomization := Self.Filter_Visible_CategCant4;
    tvGMCATEGCANT5.VisibleForCustomization := Self.Filter_Visible_CategCant5;
    tvGMCATEGCANT6.VisibleForCustomization := Self.Filter_Visible_CategCant6;
    // ========================================================================

    // ========================================================================
    // GIORNALE OPERA SPESE
    // ------------------------------------------------------------------------
    Sez := 'GiornaleOperaSpese';
    // Filtri
    Self.GosOreTipo1.Visible := LO.ReadBool(Sez, 'Filter_TipoRigo1', False);
    Self.GosOreTipo2.Visible := LO.ReadBool(Sez, 'Filter_TipoRigo2', False);
    Self.GosOreTipo3.Visible := LO.ReadBool(Sez, 'Filter_TipoRigo3', False);
    Self.GosOreTipo4.Visible := LO.ReadBool(Sez, 'Filter_TipoRigo4', False);
    Self.GosOreTipo5.Visible := LO.ReadBool(Sez, 'Filter_TipoRigo5', False);
    Self.GosOreTipo6.Visible := LO.ReadBool(Sez, 'Filter_TipoRigo6', False);
    Self.GosOreLabelTipo1.Visible := Self.GosOreTipo1.Visible;
    Self.GosOreLabelTipo2.Visible := Self.GosOreTipo2.Visible;
    Self.GosOreLabelTipo3.Visible := Self.GosOreTipo3.Visible;
    Self.GosOreLabelTipo4.Visible := Self.GosOreTipo4.Visible;
    Self.GosOreLabelTipo5.Visible := Self.GosOreTipo5.Visible;
    Self.GosOreLabelTipo6.Visible := Self.GosOreTipo6.Visible;

    Self.GosSpeseTipo1.Visible := LO.ReadBool(Sez, 'Filter_TipoRigo1', False);
    Self.GosSpeseTipo2.Visible := LO.ReadBool(Sez, 'Filter_TipoRigo2', False);
    Self.GosSpeseTipo3.Visible := LO.ReadBool(Sez, 'Filter_TipoRigo3', False);
    Self.GosSpeseTipo4.Visible := LO.ReadBool(Sez, 'Filter_TipoRigo4', False);
    Self.GosSpeseTipo5.Visible := LO.ReadBool(Sez, 'Filter_TipoRigo5', False);
    Self.GosSpeseTipo6.Visible := LO.ReadBool(Sez, 'Filter_TipoRigo6', False);
    Self.GosSpeseLabelTipo1.Visible := Self.GosSpeseTipo1.Visible;
    Self.GosSpeseLabelTipo2.Visible := Self.GosSpeseTipo2.Visible;
    Self.GosSpeseLabelTipo3.Visible := Self.GosSpeseTipo3.Visible;
    Self.GosSpeseLabelTipo4.Visible := Self.GosSpeseTipo4.Visible;
    Self.GosSpeseLabelTipo5.Visible := Self.GosSpeseTipo5.Visible;
    Self.GosSpeseLabelTipo6.Visible := Self.GosSpeseTipo6.Visible;

    // Colonne
    Self.tvOreTIPO1.Visible := LO.ReadBool(Sez, 'GOS_Column_Tipo1', False);
    Self.tvOreTIPO2.Visible := LO.ReadBool(Sez, 'GOS_Column_Tipo2', False);
    Self.tvOreTIPO3.Visible := LO.ReadBool(Sez, 'GOS_Column_Tipo3', False);
    Self.tvOreTIPO4.Visible := LO.ReadBool(Sez, 'GOS_Column_Tipo4', False);
    Self.tvOreTIPO5.Visible := LO.ReadBool(Sez, 'GOS_Column_Tipo5', False);
    Self.tvOreTIPO6.Visible := LO.ReadBool(Sez, 'GOS_Column_Tipo6', False);

    Self.tvSpeseTIPO1.Visible := LO.ReadBool(Sez, 'GOS_Column_Tipo1', False);
    Self.tvSpeseTIPO2.Visible := LO.ReadBool(Sez, 'GOS_Column_Tipo2', False);
    Self.tvSpeseTIPO3.Visible := LO.ReadBool(Sez, 'GOS_Column_Tipo3', False);
    Self.tvSpeseTIPO4.Visible := LO.ReadBool(Sez, 'GOS_Column_Tipo4', False);
    Self.tvSpeseTIPO5.Visible := LO.ReadBool(Sez, 'GOS_Column_Tipo5', False);
    Self.tvSpeseTIPO6.Visible := LO.ReadBool(Sez, 'GOS_Column_Tipo6', False);

    // In base ai filtri abilitati o disabilitati relativi alle categorie cantieri
    // cerca di limitarne l'occupazione se non visibili
    PanelFilterGosOreCategorieCantieri.Height := 0;
    PanelFilterGosOreCategorieCantieri.Visible := False;
    PanelFilterGosSpeseCategorieCantieri.Height := 0;
    PanelFilterGosSpeseCategorieCantieri.Visible := False;
    if (Self.Filter_Visible_CategCant1 or Self.Filter_Visible_CategCant2 or Self.Filter_Visible_CategCant3) then
    begin
      PanelFilterGosOreCategorieCantieri.Visible := True;
      PanelFilterGosOreCategorieCantieri.Height := 17;
      PanelFilterGosSpeseCategorieCantieri.Visible := True;
      PanelFilterGosSpeseCategorieCantieri.Height := 17;
    end;
    if (Self.Filter_Visible_CategCant4 or Self.Filter_Visible_CategCant5 or Self.Filter_Visible_CategCant6) then
    begin
      PanelFilterGosOreCategorieCantieri.Visible := True;
      PanelFilterGosOreCategorieCantieri.Height := 35;
      PanelFilterGosSpeseCategorieCantieri.Visible := True;
      PanelFilterGosSpeseCategorieCantieri.Height := 35;
    end;
    // Dimesiona il SubPanel che contiene i filtri in modo che riadatti
    SubPanelGMFiltri.Height := PanelFilterGMCategorieCantieri.Top + PanelFilterGMCategorieCantieri.Height;
    // Rende visualizzabili o meno le colonne delle categorie cantieri (customize)
    tvOreCATEGCANT1.VisibleForCustomization := Self.Filter_Visible_CategCant1;
    tvOreCATEGCANT2.VisibleForCustomization := Self.Filter_Visible_CategCant2;
    tvOreCATEGCANT3.VisibleForCustomization := Self.Filter_Visible_CategCant3;
    tvOreCATEGCANT4.VisibleForCustomization := Self.Filter_Visible_CategCant4;
    tvOreCATEGCANT5.VisibleForCustomization := Self.Filter_Visible_CategCant5;
    tvOreCATEGCANT6.VisibleForCustomization := Self.Filter_Visible_CategCant6;
    tvSpeseCATEGCANT1.VisibleForCustomization := Self.Filter_Visible_CategCant1;
    tvSpeseCATEGCANT2.VisibleForCustomization := Self.Filter_Visible_CategCant2;
    tvSpeseCATEGCANT3.VisibleForCustomization := Self.Filter_Visible_CategCant3;
    tvSpeseCATEGCANT4.VisibleForCustomization := Self.Filter_Visible_CategCant4;
    tvSpeseCATEGCANT5.VisibleForCustomization := Self.Filter_Visible_CategCant5;
    tvSpeseCATEGCANT6.VisibleForCustomization := Self.Filter_Visible_CategCant6;
    // ========================================================================

    // ========================================================================
    // RUBRICA
    // ------------------------------------------------------------------------
    // Filtri
    Self.Filter_Visible_SubSogg1 := (DM1.RefCaptionLabelSubSogg1 <> '');
    Self.Filter_Visible_SubSogg2 := (DM1.RefCaptionLabelSubSogg2 <> '');
    Self.Filter_Visible_SubSogg3 := (DM1.RefCaptionLabelSubSogg3 <> '');
    Self.Filter_Visible_SubSogg4 := (DM1.RefCaptionLabelSubSogg4 <> '');
    // In base ai filtri abilitati o disabilitati relativi ai SUBSOGG
    // cerca di limitarne l'occupazione se non visibili
    PanelFilterClientiSubSogg.Height := 0;
    PanelFilterClientiSubSogg.Visible := False;
    if (Self.Filter_Visible_SubSogg1 or Self.Filter_Visible_SubSogg2 or Self.Filter_Visible_SubSogg3) then
    begin
      PanelFilterClientiSubSogg.Visible := True;
      PanelFilterClientiSubSogg.Height := 17;
    end;
    if (Self.Filter_Visible_SubSogg4) then
    begin
      PanelFilterClientiSubSogg.Visible := True;
      PanelFilterClientiSubSogg.Height := 35;
    end;
    // Dimesiona il SubPanel che contiene i filtri in modo che riadatti
    SubPanelFiltriSogg.Height := PanelFilterClientiSubSogg.Top + PanelFilterClientiSubSogg.Height + 5;
    // ========================================================================

    // ========================================================================
    // ELENCO ARTICOLI
    // ------------------------------------------------------------------------
    // Filtri
    Self.ArtFilter_Categoria1_Caption := DM1.CategCaption6;
    Self.ArtFilter_Categoria2_Caption := DM1.CategCaption7;
    Self.ArtFilter_Categoria3_Caption := DM1.CategCaption8;
    // Colonne
    Self.tvArtCATEGORIA1.VisibleForCustomization := editArtCategoria1.Visible;
    Self.tvArtCATEGORIA2.VisibleForCustomization := editArtCategoria2.Visible;
    Self.tvArtCATEGORIA3.VisibleForCustomization := editArtCategoria3.Visible;
    Self.tvArtCATEGORIA1.Caption := DM1.CategCaption6;
    Self.tvArtCATEGORIA2.Caption := DM1.CategCaption7;
    Self.tvArtCATEGORIA3.Caption := DM1.CategCaption8;
    // Microprezzi
    (tvArtPREZZODILISTINO.GetProperties as TcxCurrencyEditProperties).DisplayFormat := DM1.DisplayFormat;
    (tvArtULTIMOPRZACQUISTO.GetProperties as TcxCurrencyEditProperties).DisplayFormat := DM1.DisplayFormat;
    (tvArtULTIMOCOSTOREALE.GetProperties as TcxCurrencyEditProperties).DisplayFormat := DM1.DisplayFormat;
    (tvArtIMPORTOULTIMOCOSTOREALE.GetProperties as TcxCurrencyEditProperties).DisplayFormat := DM1.DisplayFormat;
    (tvArtPREZZODIVENDITA.GetProperties as TcxCurrencyEditProperties).DisplayFormat := DM1.DisplayFormat;
    (tvArtPREZZODIVENDITA2.GetProperties as TcxCurrencyEditProperties).DisplayFormat := DM1.DisplayFormat;
    (tvArtPREZZODIVENDITA3.GetProperties as TcxCurrencyEditProperties).DisplayFormat := DM1.DisplayFormat;
    (tvArtPREZZODIVENDITA4.GetProperties as TcxCurrencyEditProperties).DisplayFormat := DM1.DisplayFormat;
    (tvArtPRZVENDIVACOMP1.GetProperties as TcxCurrencyEditProperties).DisplayFormat := DM1.DisplayFormat;
    (tvArtPRZVENDIVACOMP2.GetProperties as TcxCurrencyEditProperties).DisplayFormat := DM1.DisplayFormat;
    (tvArtPRZVENDIVACOMP3.GetProperties as TcxCurrencyEditProperties).DisplayFormat := DM1.DisplayFormat;
    (tvArtPRZVENDIVACOMP4.GetProperties as TcxCurrencyEditProperties).DisplayFormat := DM1.DisplayFormat;
    (tvLFPREZZODILISTINO.GetProperties as TcxCurrencyEditProperties).DisplayFormat := DM1.DisplayFormat;
    (tvLFPREZZODIACQUISTO.GetProperties as TcxCurrencyEditProperties).DisplayFormat := DM1.DisplayFormat;

    (tvArtPREZZODILISTINO.GetProperties as TcxCurrencyEditProperties).DecimalPlaces := DM1.DecMicroPrz;
    (tvArtULTIMOPRZACQUISTO.GetProperties as TcxCurrencyEditProperties).DecimalPlaces := DM1.DecMicroPrz;
    (tvArtULTIMOCOSTOREALE.GetProperties as TcxCurrencyEditProperties).DecimalPlaces := DM1.DecMicroPrz;
    (tvArtIMPORTOULTIMOCOSTOREALE.GetProperties as TcxCurrencyEditProperties).DecimalPlaces := DM1.DecMicroPrz;
    (tvArtPREZZODIVENDITA.GetProperties as TcxCurrencyEditProperties).DecimalPlaces := DM1.DecMicroPrz;
    (tvArtPREZZODIVENDITA2.GetProperties as TcxCurrencyEditProperties).DecimalPlaces := DM1.DecMicroPrz;
    (tvArtPREZZODIVENDITA3.GetProperties as TcxCurrencyEditProperties).DecimalPlaces := DM1.DecMicroPrz;
    (tvArtPREZZODIVENDITA4.GetProperties as TcxCurrencyEditProperties).DecimalPlaces := DM1.DecMicroPrz;
    (tvArtPRZVENDIVACOMP1.GetProperties as TcxCurrencyEditProperties).DecimalPlaces := DM1.DecMicroPrz;
    (tvArtPRZVENDIVACOMP2.GetProperties as TcxCurrencyEditProperties).DecimalPlaces := DM1.DecMicroPrz;
    (tvArtPRZVENDIVACOMP3.GetProperties as TcxCurrencyEditProperties).DecimalPlaces := DM1.DecMicroPrz;
    (tvArtPRZVENDIVACOMP4.GetProperties as TcxCurrencyEditProperties).DecimalPlaces := DM1.DecMicroPrz;
    (tvLFPREZZODILISTINO.GetProperties as TcxCurrencyEditProperties).DecimalPlaces := DM1.DecMicroPrz;
    (tvLFPREZZODIACQUISTO.GetProperties as TcxCurrencyEditProperties).DecimalPlaces := DM1.DecMicroPrz;
    // ========================================================================

    // ========================================================================
    // ELENCO DOCUMENTI
    // ------------------------------------------------------------------------
    // Sezione elenco documenti

    // Flag che indica se, nell'elenco documenti, il bottone di espansione delle note/messaggi  premuto o meno
    // come default
    SpeedButtonDataRowHeight.Down := DM1.ElencoDoc_DataRowExpanded;
    // In base ai filtri abilitati o disabilitati relativi alle categorie cantieri
    // cerca di limitarne l'occupazione se non visibili
    PanelFilterDocCategorieCantieri.Height := 0;
    PanelFilterDocCategorieCantieri.Visible := False;
    if (Self.Filter_Visible_CategCant1 or Self.Filter_Visible_CategCant2 or Self.Filter_Visible_CategCant3) then
    begin
      PanelFilterDocCategorieCantieri.Visible := True;
      PanelFilterDocCategorieCantieri.Height := 17;
    end;
    if (Self.Filter_Visible_CategCant4 or Self.Filter_Visible_CategCant5 or Self.Filter_Visible_CategCant6) then
    begin
      PanelFilterDocCategorieCantieri.Visible := True;
      PanelFilterDocCategorieCantieri.Height := 35;
    end;
    // Rende visualizzabili o meno le colonne delle categorie cantieri (customize)
    tvDocCATEGCANT1.VisibleForCustomization := Self.Filter_Visible_CategCant1;
    tvDocCATEGCANT2.VisibleForCustomization := Self.Filter_Visible_CategCant2;
    tvDocCATEGCANT3.VisibleForCustomization := Self.Filter_Visible_CategCant3;
    tvDocCATEGCANT4.VisibleForCustomization := Self.Filter_Visible_CategCant4;
    tvDocCATEGCANT5.VisibleForCustomization := Self.Filter_Visible_CategCant5;
    tvDocCATEGCANT6.VisibleForCustomization := Self.Filter_Visible_CategCant6;
    // ----------
    // In base ai filtri abilitati o disabilitati relativi ai SUBSOGG
    // cerca di limitarne l'occupazione se non visibili
    PanelFilterDocSubSogg.Top := PanelFilterDocCategorieCantieri.Top + PanelFilterDocCategorieCantieri.Height + 2;
    PanelFilterDocSubSogg.Height := 0;
    PanelFilterDocSubSogg.Visible := False;
    if (Self.Filter_Visible_SubSogg1 or Self.Filter_Visible_SubSogg2 or Self.Filter_Visible_SubSogg3) then
    begin
      PanelFilterDocSubSogg.Visible := True;
      PanelFilterDocSubSogg.Height := 17;
    end;
    if (Self.Filter_Visible_SubSogg4) then
    begin
      PanelFilterDocSubSogg.Visible := True;
      PanelFilterDocSubSogg.Height := 35;
    end;
    // Rende visualizzabili o meno le colonne deIi SUBSOGG (customize)
    tvDocSUBSOGGCAMPO1.VisibleForCustomization := Self.Filter_Visible_SubSogg1;
    tvDocSUBSOGGCAMPO2.VisibleForCustomization := Self.Filter_Visible_SubSogg2;
    tvDocSUBSOGGCAMPO3.VisibleForCustomization := Self.Filter_Visible_SubSogg3;
    tvDocSUBSOGGCAMPO4.VisibleForCustomization := Self.Filter_Visible_SubSogg4;
    // ----------
    // Dimesiona il SubPanel che contiene i filtri in modo che riadatti
    SubPanelDocFiltri.Height := PanelFilterDocSubSogg.Top + PanelFilterDocSubSogg.Height + 5;
    // ========================================================================

    // Procedura che modifica l'apparenza delle varie schermate per adattarle alla modalit
    // Levante Light
    if MainForm.IsLevanteLight then
      CaricaLayoutLevanteLight;
  finally
    LO.Free;
  end;
end;

// Procedura che modifica l'apparenza delle varie schermate per adattarle alla modalit
// Levante Light
procedure TClientiForm.CaricaLayoutLevanteLight;
var
  I: Integer;
begin
  // ===========================================================================
  // ARTICOLI
  // ---------------------------------------------------------------------------
  // Disabilita alcuni Filtri
  ArtFilter_Magazzino_Visible := False;
  ArtFilter_Ubicazione_Visible := False;
  ArtFilter_SoloGiacenzaAttiva_Visible := False;
  ArtFilter_SoloArticoliMovimentati_Visible := False;
  ArtFilter_SoloArticoliComposti_Visible := False;
  ArtFilter_DataMagazzino_Visible := False;
  ArtFilter_Categoria1_Caption := '0';
  ArtFilter_Categoria2_Caption := '0';
  ArtFilter_Categoria3_Caption := '0';
  // Abbassa il pannello dei filtri perch  troppo alto
  // NB: Lo fa alto quanto il filtro per gruppi
  PanelFiltri.Height := 108;
  // Rende invisibile i prezzi dei vari fornitori per articolo
  lvLF.Visible := False;
  // Prima rende invisibili tutte le colonne
  for I := 0 to tvArt.ColumnCount - 1 do
  begin
    tvArt.Columns[I].Visible := False;
    tvArt.Columns[I].VisibleForCustomization := False;
  end;
  // Poi rende visibili solo quelle che abbiamo deciso noi in modo fisso da programma
  // cos non abbiamo problemi tra le varie versioni con i files ImpGrids
  tvArtCODICEARTICOLO.Visible := True;
  tvArtDESCRIZIONE.Visible := True;
  tvArtMARCA.Visible := True;
  tvArtUNITADIMISURA.Visible := True;
  tvArtPREZZODILISTINO.Visible := True;
  tvArtSCONTODIACQUISTO.Visible := True;
  tvArtULTIMOPRZACQUISTO.Visible := True;
  tvArtDATAULTMOD_LISTINO.Visible := True;
  // tvArtGRUPPO1.Visible            := True;
  // tvArtGRUPPO2.Visible            := True;
  // tvArtGRUPPO3.Visible            := True;
  tvArtCODICEFORNITORE.Visible := True;
  // Poi imposta la larghezza automatica delle colonne
  tvArt.OptionsView.ColumnAutoWidth := True;
  // Disabilita il popup men della griglia
  // GridArt.PopupMenu := nil;
  // Disabilita il Drag & Drop in modo che non sia possibile esportare nulla in bacheca
  tvArt.DragMode := dmManual;
  // Imposta l'ordinamento predefinito
  tvArtDESCRIZIONE.SortIndex := 0;
  tvArtDESCRIZIONE.SortOrder := soAscending;
  // Disabilita la personalizzazione della griglia
  tvArt.OptionsCustomize.ColumnHiding := False;
  tvArt.OptionsCustomize.ColumnMoving := False;
  tvArt.OptionsCustomize.ColumnGrouping := False;
  tvArt.OptionsCustomize.ColumnHorzSizing := False;
  // ===========================================================================

  // ===========================================================================
  // DOCUMENTI
  // ---------------------------------------------------------------------------
  // Disabilita alcuni Filtri
  DocFilter_CodiceArticolo_Visible := True;
  DocFilter_Descrizione_Visible := True;
  DocFilter_TipiDocSbTuttiNessuno_Visible := False;
  DocFilter_TipiDocVendita_Visible := False;
  DocFilter_TipiDocAltri_Visible := False;
  DocFilter_Causale_Visible := False;
  DocFilter_Operatore_Visible := False;
  DocFilter_TipoSoggetto_Visible := False;
  DocFilter_SoloIlRegistro_Visible := False;
  DocFilter_Agente_Visible := False;
  DocFilter_SoloConStato_Visible := False;
  DocFilter_TuttiTranneIlRegitro_Visible := False;
  DocFilter_ConCantiere_Visible := False;
  // Sposta il filtro per numero documento in alto
  StaticText37.Top := LabelTipiDocVendite.Top;
  FilterNumDoc.Top := LabelTipiDocVendite.Top + 1;
  // Sposta il filtro per codice articolo subito sotto
  // a quello per numero documento
  LabelFilterCodiceArticolo.Top := StaticText37.Top + 22;
  FilterCodiceArticolo.Top := LabelFilterCodiceArticolo.Top + 1;
  LabelFilterCodiceArticolo.Left := 0;
  FilterCodiceArticolo.Left := LabelFilterCodiceArticolo.Left + 84;
  // Sposta il filtro per descrizione articolo subito sotto
  // a quello per numero documento
  LabelFilterDescrizione.Top := LabelFilterCodiceArticolo.Top + 22;
  FilterDescrizione.Top := LabelFilterDescrizione.Top + 1;
  LabelFilterDescrizione.Left := 0;
  FilterDescrizione.Left := LabelFilterDescrizione.Left + 84;
  // Abbassa il pannello dei filtri perch  troppo alto
  // NB: Lo fa alto quanto il filtro per data
  PanelDocFiltri.Height := 108;
  // Prima rende invisibili tutte le colonne
  for I := 0 to tvDoc.ColumnCount - 1 do
  begin
    tvDoc.Columns[I].Visible := False;
    tvDoc.Columns[I].VisibleForCustomization := False;
  end;
  // Poi rende visibili solo quelle che abbiamo deciso noi in modo fisso da programma
  // cos non abbiamo problemi tra le varie versioni con i files ImpGrids
  tvDocTIPODOC.Visible := True;
  tvDocCODICEDOC.Visible := True;
  tvDocREGISTRO.Visible := True;
  tvDocDATADOC.Visible := True;
  tvDocIMPORTO.Visible := True;
  tvDocCLIENTEFORNITORE.Visible := True;
  // Poi imposta la larghezza automatica delle colonne e BestFit
  tvDoc.OptionsView.ColumnAutoWidth := True;
  // Forza la larghezza di alcune colonne per una migliore visualizzazione
  tvDocCLIENTEFORNITORE.Width := Trunc(GridDoc.Width / 2);
  // Disabilita il popup men della griglia
  GridDoc.PopupMenu := nil;
  // Disabilita il Drag & Drop in modo che non sia possibile esportare nulla in bacheca
  tvDoc.DragMode := dmManual;
  // Imposta l'ordinamento predefinito
  tvDocDATADOC.SortIndex := 0;
  tvDocDATADOC.SortOrder := soDescending;
  // Disabilita la personalizzazione della griglia
  tvDoc.OptionsCustomize.ColumnHiding := False;
  tvDoc.OptionsCustomize.ColumnMoving := False;
  tvDoc.OptionsCustomize.ColumnGrouping := False;
  tvDoc.OptionsCustomize.ColumnHorzSizing := False;
  // ===========================================================================
end;

procedure TClientiForm.CaricaTitoli;
var
  M: TMemIniFile;
  Sez: String;
begin
  M := TMemIniFile.Create(DM1.Repository_Menu.FullLocalFileName);
  try
    // Caricamento titoli
    tvDocJOLLY_NUM_1.Caption := DM1.DatiDocumento_LabelJollyNum1;
    // CAricamento titoli colonne pratiche e sottopratiche
    tvDocRIFPRATICA.Caption := DM1.GridsColumnPraticaCaption;
    tvGMPRATICA.Caption := DM1.GridsColumnPraticaCaption;
    tvScadRIFPRATICA.Caption := DM1.GridsColumnPraticaCaption;
    tvImpegniRIFPRATICA.Caption := DM1.GridsColumnPraticaCaption;
    tvPrimanotaRIFPRATICA.Caption := DM1.GridsColumnPraticaCaption;
    tvOreCANTIERE.Caption := DM1.GridsColumnPraticaCaption;
    tvSpeseCANTIERE.Caption := DM1.GridsColumnPraticaCaption;

    // Impostazione caption colonne griglie e campi relative ai tecnici
    tvImpegniTECNICO.Caption := DM1.GridsColumnTecnicoCaption;
    LabelFilterCodiceTecnico.Caption := DM1.GridsColumnTecnicoCaption;

    // Impostazione caption colonne griglie e filtri relative agli agenti
    tvRubricaAGENTE.Caption := DM1.GridsColumnAgenteCaption;
    tvRubricaAGENTE2.Caption := DM1.GridsColumnAgente2Caption;
    tvRubricaAGENTE3.Caption := DM1.GridsColumnAgente3Caption;
    tvRubricaAGENTE4.Caption := DM1.GridsColumnAgente4Caption;

    tvPratAGENTE.Caption := DM1.GridsColumnAgenteCaption;
    tvPratAGENTE2.Caption := DM1.GridsColumnAgente2Caption;
    tvPratAGENTE3.Caption := DM1.GridsColumnAgente3Caption;
    tvPratAGENTE4.Caption := DM1.GridsColumnAgente4Caption;

    tvDocAGENTE.Caption := DM1.GridsColumnAgenteCaption;
    tvDocAGENTE2.Caption := DM1.GridsColumnAgente2Caption;
    tvDocAGENTE3.Caption := DM1.GridsColumnAgente3Caption;
    tvDocAGENTE4.Caption := DM1.GridsColumnAgente4Caption;

    tvGMAGENTE.Caption := DM1.GridsColumnAgenteCaption;
    tvGMAGENTE2.Caption := DM1.GridsColumnAgente2Caption;
    tvGMAGENTE3.Caption := DM1.GridsColumnAgente3Caption;
    tvGMAGENTE4.Caption := DM1.GridsColumnAgente4Caption;

    tvScadAGENTE.Caption := DM1.GridsColumnAgenteCaption;
    tvScadAGENTE2.Caption := DM1.GridsColumnAgente2Caption;
    tvScadAGENTE3.Caption := DM1.GridsColumnAgente3Caption;
    tvScadAGENTE4.Caption := DM1.GridsColumnAgente4Caption;

    tvPrimanotaAGENTE.Caption := DM1.GridsColumnAgenteCaption;
    tvPrimanotaAGENTE2.Caption := DM1.GridsColumnAgente2Caption;
    tvPrimanotaAGENTE3.Caption := DM1.GridsColumnAgente3Caption;
    tvPrimanotaAGENTE4.Caption := DM1.GridsColumnAgente4Caption;

    tvImpegniAGENTE.Caption := DM1.GridsColumnAgenteCaption;
    tvImpegniAGENTE2.Caption := DM1.GridsColumnAgente2Caption;
    tvImpegniAGENTE3.Caption := DM1.GridsColumnAgente3Caption;
    tvImpegniAGENTE4.Caption := DM1.GridsColumnAgente4Caption;

    tvOreAGENTE.Caption := DM1.GridsColumnAgenteCaption;
    tvOreAGENTE2.Caption := DM1.GridsColumnAgente2Caption;
    tvOreAGENTE3.Caption := DM1.GridsColumnAgente3Caption;
    tvOreAGENTE4.Caption := DM1.GridsColumnAgente4Caption;
    tvSpeseAGENTE.Caption := DM1.GridsColumnAgenteCaption;
    tvSpeseAGENTE2.Caption := DM1.GridsColumnAgente2Caption;
    tvSpeseAGENTE3.Caption := DM1.GridsColumnAgente3Caption;
    tvSpeseAGENTE4.Caption := DM1.GridsColumnAgente4Caption;

    // Impostazione etichette filtri agenti
    LabelFilterClientiAgente.Caption := ' ' + DM1.GridsColumnAgenteCaption;
    LabelFilterClientiAgente2.Caption := ' ' + DM1.GridsColumnAgente2Caption;
    LabelFilterClientiAgente3.Caption := ' ' + DM1.GridsColumnAgente3Caption;
    LabelFilterClientiAgente4.Caption := ' ' + DM1.GridsColumnAgente4Caption;

    LabelPratAgente.Caption := ' ' + DM1.GridsColumnAgenteCaption;
    LabelPratAgente2.Caption := ' ' + DM1.GridsColumnAgente2Caption;
    LabelPratAgente3.Caption := ' ' + DM1.GridsColumnAgente3Caption;
    LabelPratAgente4.Caption := ' ' + DM1.GridsColumnAgente4Caption;

    LabelFilterDocAgente.Caption := ' ' + DM1.GridsColumnAgenteCaption;
    LabelFilterDocAgente2.Caption := ' ' + DM1.GridsColumnAgente2Caption;
    LabelFilterDocAgente3.Caption := ' ' + DM1.GridsColumnAgente3Caption;
    LabelFilterDocAgente4.Caption := ' ' + DM1.GridsColumnAgente4Caption;

    LabelGMAgente.Caption := ' ' + DM1.GridsColumnAgenteCaption;
    LabelGMAgente2.Caption := ' ' + DM1.GridsColumnAgente2Caption;
    LabelGMAgente3.Caption := ' ' + DM1.GridsColumnAgente3Caption;
    LabelGMAgente4.Caption := ' ' + DM1.GridsColumnAgente4Caption;

    LabelFilterScadAgente.Caption := ' ' + DM1.GridsColumnAgenteCaption;
    LabelFilterScadAgente2.Caption := ' ' + DM1.GridsColumnAgente2Caption;
    LabelFilterScadAgente3.Caption := ' ' + DM1.GridsColumnAgente3Caption;
    LabelFilterScadAgente4.Caption := ' ' + DM1.GridsColumnAgente4Caption;

    LabelPrmAgente.Caption := ' ' + DM1.GridsColumnAgenteCaption;
    LabelPrmAgente2.Caption := ' ' + DM1.GridsColumnAgente2Caption;
    LabelPrmAgente3.Caption := ' ' + DM1.GridsColumnAgente3Caption;
    LabelPrmAgente4.Caption := ' ' + DM1.GridsColumnAgente4Caption;

    LabelImpFilterAgente.Caption := ' ' + DM1.GridsColumnAgenteCaption;
    LabelImpFilterAgente2.Caption := ' ' + DM1.GridsColumnAgente2Caption;
    LabelImpFilterAgente3.Caption := ' ' + DM1.GridsColumnAgente3Caption;
    LabelImpFilterAgente4.Caption := ' ' + DM1.GridsColumnAgente4Caption;

    GosOreLabelAgente.Caption := ' ' + DM1.GridsColumnAgenteCaption;
    GosOreLabelAgente2.Caption := ' ' + DM1.GridsColumnAgente2Caption;
    GosOreLabelAgente3.Caption := ' ' + DM1.GridsColumnAgente3Caption;
    GosOreLabelAgente4.Caption := ' ' + DM1.GridsColumnAgente4Caption;
    GosSpeseLabelAgente.Caption := ' ' + DM1.GridsColumnAgenteCaption;
    GosSpeseLabelAgente2.Caption := ' ' + DM1.GridsColumnAgente2Caption;
    GosSpeseLabelAgente3.Caption := ' ' + DM1.GridsColumnAgente3Caption;
    GosSpeseLabelAgente4.Caption := ' ' + DM1.GridsColumnAgente4Caption;

    // ----- IMPEGNI ----
    tvImpegniLOCATION.Caption := DM1.GridsImpegniColumnLuogoAppuntamentoCaption;

    // ----- PRATICHE -----
    Sez := 'TitoliPratiche';
    // Filtri
    CantieriApertiChiusi.Items[0] := M.ReadString(Sez, 'FilterCantieriAperti', 'Cantieri aperti');
    CantieriApertiChiusi.Items[1] := M.ReadString(Sez, 'FilterCantieriChiusi', 'Cantieri chiusi');
    PratLabelCategCant1.Caption := DM1.CategCantCaption1;
    PratLabelCategCant2.Caption := DM1.CategCantCaption2;
    PratLabelCategCant3.Caption := DM1.CategCantCaption3;
    PratLabelCategCant4.Caption := DM1.CategCantCaption4;
    PratLabelCategCant5.Caption := DM1.CategCantCaption5;
    PratLabelCategCant6.Caption := DM1.CategCantCaption6;
    // Colonne
    tvPratCATEGCANT1.Caption := DM1.CategCantCaption1;
    tvPratCATEGCANT2.Caption := DM1.CategCantCaption2;
    tvPratCATEGCANT3.Caption := DM1.CategCantCaption3;
    tvPratCATEGCANT4.Caption := DM1.CategCantCaption4;
    tvPratCATEGCANT5.Caption := DM1.CategCantCaption5;
    tvPratCATEGCANT6.Caption := DM1.CategCantCaption6;

    // ----- GIORNALE MAGAZZINO -----
    Sez := 'GiornaleMagazzino';
    // Filtri
    GMLabelSottocantiere1.Caption := DM1.GridsColumnSottopratica1Caption;
    GMLabelSottocantiere2.Caption := DM1.GridsColumnSottopratica2Caption;
    GMLabelSottocantiere3.Caption := DM1.GridsColumnSottopratica3Caption;
    GMLabelTipo1.Caption := M.ReadString(Sez, 'Filter_TipoRigo1', 'Tipo rigo 1');
    GMLabelTipo2.Caption := M.ReadString(Sez, 'Filter_TipoRigo2', 'Tipo rigo 2');
    GMLabelTipo3.Caption := M.ReadString(Sez, 'Filter_TipoRigo3', 'Tipo rigo 3');
    GMLabelTipo4.Caption := M.ReadString(Sez, 'Filter_TipoRigo4', 'Tipo rigo 4');
    GMLabelTipo5.Caption := M.ReadString(Sez, 'Filter_TipoRigo5', 'Tipo rigo 5');
    GMLabelTipo6.Caption := M.ReadString(Sez, 'Filter_TipoRigo6', 'Tipo rigo 6');
    GMLabelCategCant1.Caption := DM1.CategCantCaption1;
    GMLabelCategCant2.Caption := DM1.CategCantCaption2;
    GMLabelCategCant3.Caption := DM1.CategCantCaption3;
    GMLabelCategCant4.Caption := DM1.CategCantCaption4;
    GMLabelCategCant5.Caption := DM1.CategCantCaption5;
    GMLabelCategCant6.Caption := DM1.CategCantCaption6;
    // Colonne
    tvGMSOTTOCANTIERE1.Caption := DM1.GridsColumnSottopratica1Caption;
    tvGMSOTTOCANTIERE2.Caption := DM1.GridsColumnSottopratica2Caption;
    tvGMSOTTOCANTIERE3.Caption := DM1.GridsColumnSottopratica3Caption;
    tvGMTIPO1.Caption := M.ReadString(Sez, 'GM_Column_Tipo1', 'Tipo 1');
    tvGMTIPO2.Caption := M.ReadString(Sez, 'GM_Column_Tipo2', 'Tipo 2');
    tvGMTIPO3.Caption := M.ReadString(Sez, 'GM_Column_Tipo3', 'Tipo 3');
    tvGMTIPO4.Caption := M.ReadString(Sez, 'GM_Column_Tipo4', 'Tipo 4');
    tvGMTIPO5.Caption := M.ReadString(Sez, 'GM_Column_Tipo5', 'Tipo 5');
    tvGMTIPO6.Caption := M.ReadString(Sez, 'GM_Column_Tipo6', 'Tipo 6');
    tvGMCATEGCANT1.Caption := DM1.CategCantCaption1;
    tvGMCATEGCANT2.Caption := DM1.CategCantCaption2;
    tvGMCATEGCANT3.Caption := DM1.CategCantCaption3;
    tvGMCATEGCANT4.Caption := DM1.CategCantCaption4;
    tvGMCATEGCANT5.Caption := DM1.CategCantCaption5;
    tvGMCATEGCANT6.Caption := DM1.CategCantCaption6;

    // ----- GIORNALE MANODOPERA/SPESE -----
    Sez := 'GiornaleOperaSpese';
    // Filtri
    LabelGosSottocantiere1.Caption := DM1.GridsColumnSottopratica1Caption;
    LabelGosSottocantiere2.Caption := DM1.GridsColumnSottopratica2Caption;
    LabelGosSottocantiere3.Caption := DM1.GridsColumnSottopratica3Caption;
    GosOreLabelTipo1.Caption := M.ReadString(Sez, 'Filter_TipoRigo1', 'Tipo rigo 1');
    GosOreLabelTipo2.Caption := M.ReadString(Sez, 'Filter_TipoRigo2', 'Tipo rigo 2');
    GosOreLabelTipo3.Caption := M.ReadString(Sez, 'Filter_TipoRigo3', 'Tipo rigo 3');
    GosOreLabelTipo4.Caption := M.ReadString(Sez, 'Filter_TipoRigo4', 'Tipo rigo 4');
    GosOreLabelTipo5.Caption := M.ReadString(Sez, 'Filter_TipoRigo5', 'Tipo rigo 5');
    GosOreLabelTipo6.Caption := M.ReadString(Sez, 'Filter_TipoRigo6', 'Tipo rigo 6');
    GosOreLabelCategCant1.Caption := DM1.CategCantCaption1;
    GosOreLabelCategCant2.Caption := DM1.CategCantCaption2;
    GosOreLabelCategCant3.Caption := DM1.CategCantCaption3;
    GosOreLabelCategCant4.Caption := DM1.CategCantCaption4;
    GosOreLabelCategCant5.Caption := DM1.CategCantCaption5;
    GosOreLabelCategCant6.Caption := DM1.CategCantCaption6;

    LabelGosSpeseSottocantiere1.Caption := DM1.GridsColumnSottopratica1Caption;
    LabelGosSpeseSottocantiere2.Caption := DM1.GridsColumnSottopratica2Caption;
    LabelGosSpeseSottocantiere3.Caption := DM1.GridsColumnSottopratica3Caption;
    GosSpeseLabelTipo1.Caption := M.ReadString(Sez, 'Filter_TipoRigo1', 'Tipo rigo 1');
    GosSpeseLabelTipo2.Caption := M.ReadString(Sez, 'Filter_TipoRigo2', 'Tipo rigo 2');
    GosSpeseLabelTipo3.Caption := M.ReadString(Sez, 'Filter_TipoRigo3', 'Tipo rigo 3');
    GosSpeseLabelTipo4.Caption := M.ReadString(Sez, 'Filter_TipoRigo4', 'Tipo rigo 4');
    GosSpeseLabelTipo5.Caption := M.ReadString(Sez, 'Filter_TipoRigo5', 'Tipo rigo 5');
    GosSpeseLabelTipo6.Caption := M.ReadString(Sez, 'Filter_TipoRigo6', 'Tipo rigo 6');
    GosSpeseLabelCategCant1.Caption := DM1.CategCantCaption1;
    GosSpeseLabelCategCant2.Caption := DM1.CategCantCaption2;
    GosSpeseLabelCategCant3.Caption := DM1.CategCantCaption3;
    GosSpeseLabelCategCant4.Caption := DM1.CategCantCaption4;
    GosSpeseLabelCategCant5.Caption := DM1.CategCantCaption5;
    GosSpeseLabelCategCant6.Caption := DM1.CategCantCaption6;

    // Colonne
    tvOreSOTTOCANTIERE1.Caption := DM1.GridsColumnSottopratica1Caption;
    tvOreSOTTOCANTIERE2.Caption := DM1.GridsColumnSottopratica2Caption;
    tvOreSOTTOCANTIERE3.Caption := DM1.GridsColumnSottopratica3Caption;
    tvOreTIPO1.Caption := M.ReadString(Sez, 'GOS_Column_Tipo1', 'Tipo 1');
    tvOreTIPO2.Caption := M.ReadString(Sez, 'GOS_Column_Tipo2', 'Tipo 2');
    tvOreTIPO3.Caption := M.ReadString(Sez, 'GOS_Column_Tipo3', 'Tipo 3');
    tvOreTIPO4.Caption := M.ReadString(Sez, 'GOS_Column_Tipo4', 'Tipo 4');
    tvOreTIPO5.Caption := M.ReadString(Sez, 'GOS_Column_Tipo5', 'Tipo 5');
    tvOreTIPO6.Caption := M.ReadString(Sez, 'GOS_Column_Tipo6', 'Tipo 6');
    tvOreCATEGCANT1.Caption := DM1.CategCantCaption1;
    tvOreCATEGCANT2.Caption := DM1.CategCantCaption2;
    tvOreCATEGCANT3.Caption := DM1.CategCantCaption3;
    tvOreCATEGCANT4.Caption := DM1.CategCantCaption4;
    tvOreCATEGCANT5.Caption := DM1.CategCantCaption5;
    tvOreCATEGCANT6.Caption := DM1.CategCantCaption6;

    tvSpeseSOTTOCANTIERE1.Caption := DM1.GridsColumnSottopratica1Caption;
    tvSpeseSOTTOCANTIERE2.Caption := DM1.GridsColumnSottopratica1Caption;
    tvSpeseSOTTOCANTIERE3.Caption := DM1.GridsColumnSottopratica1Caption;
    tvSpeseTIPO1.Caption := M.ReadString(Sez, 'GOS_Column_Tipo1', 'Tipo 1');
    tvSpeseTIPO2.Caption := M.ReadString(Sez, 'GOS_Column_Tipo2', 'Tipo 2');
    tvSpeseTIPO3.Caption := M.ReadString(Sez, 'GOS_Column_Tipo3', 'Tipo 3');
    tvSpeseTIPO4.Caption := M.ReadString(Sez, 'GOS_Column_Tipo4', 'Tipo 4');
    tvSpeseTIPO5.Caption := M.ReadString(Sez, 'GOS_Column_Tipo5', 'Tipo 5');
    tvSpeseTIPO6.Caption := M.ReadString(Sez, 'GOS_Column_Tipo6', 'Tipo 6');
    tvSpeseCATEGCANT1.Caption := DM1.CategCantCaption1;
    tvSpeseCATEGCANT2.Caption := DM1.CategCantCaption2;
    tvSpeseCATEGCANT3.Caption := DM1.CategCantCaption3;
    tvSpeseCATEGCANT4.Caption := DM1.CategCantCaption4;
    tvSpeseCATEGCANT5.Caption := DM1.CategCantCaption5;
    tvSpeseCATEGCANT6.Caption := DM1.CategCantCaption6;

    // ----- RUBRICA -----
    // Filtri
    LabelFilterSubSogg1.Caption := DM1.RefCaptionLabelSubSogg1;
    LabelFilterSubSogg2.Caption := DM1.RefCaptionLabelSubSogg2;
    LabelFilterSubSogg3.Caption := DM1.RefCaptionLabelSubSogg3;
    LabelFilterSubSogg4.Caption := DM1.RefCaptionLabelSubSogg4;

    // ----- ELENCO DOCUMENTO -----
    // Filtri
    DocLabelCategCant1.Caption := DM1.CategCantCaption1;
    DocLabelCategCant2.Caption := DM1.CategCantCaption2;
    DocLabelCategCant3.Caption := DM1.CategCantCaption3;
    DocLabelCategCant4.Caption := DM1.CategCantCaption4;
    DocLabelCategCant5.Caption := DM1.CategCantCaption5;
    DocLabelCategCant6.Caption := DM1.CategCantCaption6;
    DocLabelSubSogg1.Caption := DM1.RefCaptionLabelSubSogg1;
    DocLabelSubSogg2.Caption := DM1.RefCaptionLabelSubSogg2;
    DocLabelSubSogg3.Caption := DM1.RefCaptionLabelSubSogg3;
    DocLabelSubSogg4.Caption := DM1.RefCaptionLabelSubSogg4;
    // Colonne
    tvDocCATEGCANT1.Caption := DM1.CategCantCaption1;
    tvDocCATEGCANT2.Caption := DM1.CategCantCaption2;
    tvDocCATEGCANT3.Caption := DM1.CategCantCaption3;
    tvDocCATEGCANT4.Caption := DM1.CategCantCaption4;
    tvDocCATEGCANT5.Caption := DM1.CategCantCaption5;
    tvDocCATEGCANT6.Caption := DM1.CategCantCaption6;
    tvDocSUBSOGGCAMPO1.Caption := DM1.RefCaptionLabelSubSogg1;
    tvDocSUBSOGGCAMPO2.Caption := DM1.RefCaptionLabelSubSogg2;
    tvDocSUBSOGGCAMPO3.Caption := DM1.RefCaptionLabelSubSogg3;
    tvDocSUBSOGGCAMPO4.Caption := DM1.RefCaptionLabelSubSogg4;

  finally
    M.Free;
  end;
end;

procedure TClientiForm.AbilitaDocumento(IndiceDoc: Integer; Enabled: Boolean; DescrizioneDoc: String);
var
  StrIndex: String;
  DocType, DocIndex: Byte;
begin
  try
    // Prima di tutto converte il parametro IndiceDoc nei due indici DocType e DocIndex
    // per accedere correttamente all'array bidimensionale che contiene gli indici per accedere
    // ai checklistbox che visualizzano i documenti nei filtri
    StrIndex := IntToStr(IndiceDoc); // Converte l'indice ricevuto in stringa
    DocType := StrToInt(DM1.StrLeft(StrIndex, 1)); // Il primo carattere indica il tipo di documento (1=Vendita, 2=Acquisto, 3=Altri)
    DocIndex := StrToInt(DM1.StrRight(StrIndex, Length(StrIndex) - 1)); // I Caratteri succesivi indicano l'indice del documento al'interno della sua tipologia
    // Se si deve abilitare un documento...
    if Enabled then
    begin
      // In base al tipo di documento viene inserito nel CheckListGroup giusto
      case DocType of
        // Documento di vendita
        1:
          begin
            DocVendite.AddItem(DescrizioneDoc); // Aggiunge il documento al CheckListBox
            DocumentiAttivi[DocType, DocIndex] := DocVendite.Items.Count - 1; // Registra l'indice del documento appena inserito
          end;
        // Documento di acquisto
        2:
          begin
            DocAcquisti.AddItem(DescrizioneDoc); // Aggiunge il documento al CheckListBox
            DocumentiAttivi[DocType, DocIndex] := DocAcquisti.Items.Count - 1; // Registra l'indice del documento appena inserito
          end;
        // Altri documenti
        3:
          begin
            DocAltri.AddItem(DescrizioneDoc); // Aggiunge il documento al CheckListBox
            DocumentiAttivi[DocType, DocIndex] := DocAltri.Items.Count - 1; // Registra l'indice del documento appena inserito
          end;
      end;
      // Se invece il documento deve essere disabilitato...
    end
    else
    begin
      // Disabilita il documento mettendo nella sua posizione sull'array il valore 0 che indica appunto
      // che il documento  disabilitato.
      DocumentiAttivi[DocType, DocIndex] := -1;
    end;
  finally
    // Copia tutto anche nel filtro di selezione del tipo documento che ho messo
    // anche nel Giorname di Magazzino
    GMVendite.Items.Assign(DocVendite.Items);
    GMAcquisti.Items.Assign(DocAcquisti.Items);
  end;
end;

function TClientiForm.GMDocIsChecked(IndiceDoc: Integer): Boolean;
var
  StrIndex: String;
  DocType, DocIndex: Byte;
begin
  // Default
  Result := False;
  // Prima di tutto converte il parametro IndiceDoc nei due indici DocType e DocIndex
  // per accedere correttamente all'array bidimensionale che contiene gli indici per accedere
  // ai checklistbox che visualizzano i documenti nei filtri
  StrIndex := IntToStr(IndiceDoc); // Converte l'indice ricevuto in stringa
  DocType := StrToInt(DM1.StrLeft(StrIndex, 1)); // Il primo carattere indica il tipo di documento (1=Vendita, 2=Acquisto, 3=Altri)
  DocIndex := StrToInt(DM1.StrRight(StrIndex, Length(StrIndex) - 1)); // I Caratteri succesivi indicano l'indice del documento al'interno della sua tipologia
  // Prima di tutto controlla se il documento  abilitato...
  if DocumentiAttivi[DocType, DocIndex] <> -1 then
  begin
    // In base al tipo di documento viene controllato nel CheckListGroup giusto
    case DocType of
      // Documento di vendita
      1:
        begin
          // Controlla se il docuemnto  checkato
          if GMVendite.Items.Count > 0 then
            Result := GMVendite.Items[DocumentiAttivi[DocType, DocIndex]].Checked;
        end;
      // Documento di acquisto
      2:
        begin
          // Controlla se il docuemnto  checkato
          if GMAcquisti.Items.Count > 0 then
            Result := GMAcquisti.Items[DocumentiAttivi[DocType, DocIndex]].Checked;
        end;
    end;
  end;
end;

function TClientiForm.DocIsChecked(IndiceDoc: Integer): Boolean;
var
  StrIndex: String;
  DocType, DocIndex: Byte;
begin
  // Default
  Result := False;
  // Prima di tutto converte il parametro IndiceDoc nei due indici DocType e DocIndex
  // per accedere correttamente all'array bidimensionale che contiene gli indici per accedere
  // ai checklistbox che visualizzano i documenti nei filtri
  StrIndex := IntToStr(IndiceDoc); // Converte l'indice ricevuto in stringa
  DocType := StrToInt(DM1.StrLeft(StrIndex, 1)); // Il primo carattere indica il tipo di documento (1=Vendita, 2=Acquisto, 3=Altri)
  DocIndex := StrToInt(DM1.StrRight(StrIndex, Length(StrIndex) - 1)); // I Caratteri succesivi indicano l'indice del documento al'interno della sua tipologia
  // Prima di tutto controlla se il documento  abilitato...
  if DocumentiAttivi[DocType, DocIndex] <> -1 then
  begin
    // In base al tipo di documento viene controllato nel CheckListGroup giusto
    case DocType of
      // Documento di vendita
      1:
        begin
          // Controlla se il docuemnto  checkato
          if DocVendite.Items.Count > 0 then
            Result := DocVendite.Items[DocumentiAttivi[DocType, DocIndex]].Checked;
        end;
      // Documento di acquisto
      2:
        begin
          // Controlla se il docuemnto  checkato
          if DocAcquisti.Items.Count > 0 then
            Result := DocAcquisti.Items[DocumentiAttivi[DocType, DocIndex]].Checked;
        end;
      // Altri documenti
      3:
        begin
          // Controlla se il docuemnto  checkato
          if DocAltri.Items.Count > 0 then
            Result := DocAltri.Items[DocumentiAttivi[DocType, DocIndex]].Checked;
        end;
    end;
  end;
end;

procedure TClientiForm.DocSubSogg1PropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
  Combo: TcxComboBox;
  StcIndex: String;
begin
  // Inizializzazione
  Combo := (Sender as TcxComboBox);
  StcIndex := RightStr(Combo.Name, 1);
  Combo.Properties.Items.Clear;
  Combo.Properties.Items.Add('');
  // Altrimenti provvede a caricare i dati
  Qry := TIB_Cursor.Create(nil);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    // Imposta query
    Qry.SQL.Add('SELECT DISTINCT SUBSOGGCAMPO' + StcIndex + ' FROM PRVORDCL');
    Qry.Open;
    // Caricamento dati
    while not Qry.Eof do
    begin
      Combo.Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
    Qry.Close;
  finally
    Qry.Free;
  end;
end;

function TClientiForm.GMNessunDocumentoSelezionato: Boolean;
var
  I: Byte;
begin
  // Questa funzione ritorna True se non c' nessun documento selezionato
  // --------------------------------------------------------------------
  Result := True;

  // Cerca nei documenti di vendita
  if GMVendite.Items.Count > 0 then
  begin
    for I := 0 to GMVendite.Items.Count - 1 do
    begin
      // Se il documento corrente  selezionato, aggiorna il valore di ritorno ed esce
      if GMVendite.Items[I].Checked then
      begin
        Result := False;
        Break;
      end;
    end;
  end;

  // Cerca nei documenti di acquisto
  if GMAcquisti.Items.Count > 0 then
  begin
    if Result then
    begin
      for I := 0 to GMAcquisti.Items.Count - 1 do
      begin
        // Se il documento corrente  selezionato, aggiorna il valore di ritorno ed esce
        if GMAcquisti.Items[I].Checked then
        begin
          Result := False;
          Break;
        end;
      end;
    end;
  end;
end;

procedure TClientiForm.N1volta1Click(Sender: TObject);
var
  DC: TcxCustomDataController;
  RI: Integer;
begin
  // RIchiede conferma
  if DM1.Messaggi('Levante', 'Duplicare la voce selezionata?', '', [mbYes, mbNo], 0, nil) <> mrYes then
    Exit;
  // Inizializzazione
  DC := tvPrat.DataController;
  if DC.FocusedRecordIndex < 0 then
    raise Exception.Create('Nessuna voce selezionata!');
  RI := DC.FocusedRecordIndex;
  // Duplicazione
  DM1.ShowWait('Levante', 'Duplicazione in corso');
  try
    DuplicaCantiere('P', DC.Values[RI, tvPratCODICE.Index], DC.Values[RI, tvPratDATAAPERTURA.Index], (Sender as TComponent).Tag // Copie
      );
  finally
    DM1.CloseWait;
  end;
end;

procedure TClientiForm.StampaADADocumentiClick(Sender: TObject);
var
  ShowDlgForm: Boolean;
begin
  ShowDlgForm := (StampeCantieriForm = nil);
  // Anteprima
  if MenuStampe.Tag = 0 then
  begin
    dxPrinter.Preview(True, PivotDocLink);
    // Stampa
  end
  else if MenuStampe.Tag = 1 then
  begin
    dxPrinter.Print(ShowDlgForm, nil, PivotDocLink);
  end;
end;

function TClientiForm.NessunDocumentoSelezionato: Boolean;
var
  I: Byte;
begin
  // Questa funzione ritorna True se non c' nessun documento selezionato
  // --------------------------------------------------------------------
  Result := True;

  // Cerca nei documenti di vendita
  if DocVendite.Items.Count > 0 then
  begin
    for I := 0 to DocVendite.Items.Count - 1 do
    begin
      // Se il documento corrente  selezionato, aggiorna il valore di ritorno ed esce
      if DocVendite.Items[I].Checked then
      begin
        Result := False;
        Break;
      end;
    end;
  end;

  // Cerca nei documenti di acquisto
  if DocAcquisti.Items.Count > 0 then
  begin
    if Result then
    begin
      for I := 0 to DocAcquisti.Items.Count - 1 do
      begin
        // Se il documento corrente  selezionato, aggiorna il valore di ritorno ed esce
        if DocAcquisti.Items[I].Checked then
        begin
          Result := False;
          Break;
        end;
      end;
    end;
  end;

  // Cerca negli altri documenti
  if DocAltri.Items.Count > 0 then
  begin
    if Result then
    begin
      for I := 0 to DocAltri.Items.Count - 1 do
      begin
        // Se il documento corrente  selezionato, aggiorna il valore di ritorno ed esce
        if DocAltri.Items[I].Checked then
        begin
          Result := False;
          Break;
        end;
      end;
    end;
  end;
end;

procedure TClientiForm.ControllaAbilitazioneDocumenti;
begin
  // --------------------------------------------------------------------------------------------
  // DOCUMENTI DI VENDITA
  // --------------------------------------------------------------------------------------------
  DocVendite.Items.Clear;
  // Controlla tutti documenti e carica nel controllo solo quelli attivati dalla chiave
  AbilitaDocumento(IDX_VEND_BUONICONSEGNA, (DM1.ModCtrl(MOD_BUONO_CONSEGNA) > 0), 'Buoni di cons.');
  AbilitaDocumento(IDX_VEND_CARICOCANTIERE, (DM1.ModCtrl(MOD_PRATICHE) > 0), 'Carico cantiere');
  AbilitaDocumento(IDX_VEND_COMMESSA, (DM1.ModCtrl(MOD_PRATICHE) > 0), 'Commessa');
  AbilitaDocumento(IDX_VEND_DDT, (DM1.ModCtrl(MOD_DDT) > 0), 'D.D.T.');
  AbilitaDocumento(IDX_VEND_CONTO, (DM1.ModCtrl(MOD_PRATICHE) > 0), 'Estratti conto');
  AbilitaDocumento(IDX_VEND_FATTURE, (DM1.ModCtrl(MOD_FATTURE) > 0), 'Fatture');
  AbilitaDocumento(IDX_VEND_FATTURERICEVUTEFISCALI, (DM1.ModCtrl(MOD_FATTURE_RF) > 0), 'Fatt. (Ric.fisc.)');
  AbilitaDocumento(IDX_VEND_INTERVENTO, (DM1.ModCtrl(MOD_CONTATTI) > 0), 'Interventi');
  AbilitaDocumento(IDX_VEND_NOTEDICREDITO, (DM1.ModCtrl(MOD_NOTE_ACCREDITO) > 0), 'Note di credito');
  AbilitaDocumento(IDX_VEND_ORDINI, (DM1.ModCtrl(MOD_ORDINI) > 0), 'Ordini clien.');
  AbilitaDocumento(IDX_VEND_PREVENTIVI, (DM1.ModCtrl(MOD_PREVENTIVI) > 0), 'Preventivi');
  AbilitaDocumento(IDX_VEND_RICEVUTEFISCALI, (DM1.ModCtrl(MOD_RICEVUTE_FISCALI) > 0), 'Ricevute fiscali');
  AbilitaDocumento(IDX_VEND_SAL, (DM1.ModCtrl(MOD_SAL) > 0), 'S.A.L.');
  AbilitaDocumento(IDX_VEND_SCARICOCANTIERE, (DM1.ModCtrl(MOD_PRATICHE) > 0), 'Scarico cantiere');
  // --------------------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------------------
  // DOCUMENTI DI ACQUISTO
  // --------------------------------------------------------------------------------------------
  DocAcquisti.Items.Clear;
  // Controlla tutti documenti e carica nel controllo solo quelli attivati dalla chiave
  AbilitaDocumento(IDX_ACQ_BOLLEENTRATA, (DM1.ModCtrl(MOD_BOLLE_ENTRATA) > 0), 'Bolle di entrata');
  AbilitaDocumento(IDX_ACQ_FATTUREACQUISTO, (DM1.ModCtrl(MOD_FATTURE_ACQUISTO) > 0), 'Fatt. di acquis.');
  AbilitaDocumento(IDX_ACQ_NOTEDICREDITO_FORNITORI, (DM1.ModCtrl(MOD_NOTE_ACCREDITO) > 0), 'Note cred. forn.');
  AbilitaDocumento(IDX_ACQ_ORDINIFORNITORI, (DM1.ModCtrl(MOD_ORDINI_FORNITORI) > 0), 'Ordini a fornit.');
  // --------------------------------------------------------------------------------------------

  // --------------------------------------------------------------------------------------------
  // ALTRI DOCUMENTI                                                                IDX_RAPP_GIORN
  // --------------------------------------------------------------------------------------------
  DocAltri.Items.Clear;
  // Controlla tutti documenti e carica nel controllo solo quelli attivati dalla chiave
  // AbilitaDocumento(IDX_ALTRI_CONFORMITA, (DM1.ModCtrl(MOD_CONFORMITA) > 0), 'Dich. conform.');
  AbilitaDocumento(IDX_RAPP_GIORN, (DM1.ModCtrl(MOD_GIORNALE_CANTIERE) > 0), 'Rapp.giorn.');
  AbilitaDocumento(IDX_ALTRI_FAXRICEVUTI, (DM1.ModCtrl(MOD_FAX) > 0), 'Fax ricevuti');
  AbilitaDocumento(IDX_ALTRI_FAXINVIATI, (DM1.ModCtrl(MOD_FAX) > 0), 'Fax inviati');
  AbilitaDocumento(IDX_ALTRI_FILESESTERNI, (DM1.ModCtrl(MOD_EXT_FILE) > 0), 'Doc. esterni');
  AbilitaDocumento(IDX_ALTRI_TESTI, (DM1.ModCtrl(MOD_TESTI) > 0), 'Lettere');
  // AbilitaDocumento(IDX_ALTRI_CONTATTI,                 (DM1.ModCtrl(MOD_CONTATTI) > 0),        'Contatti');
  // if (DM1.ModCtrl(MOD_CEFALOMETRIE) > 0)       then DocAltri.Items.Add('Tracciati cefal.');
  // if (DM1.ModCtrl(MOD_SEGRETERIA) > 0)         then DocAltri.Items.Add('Segreteria telef.');
  // --------------------------------------------------------------------------------------------
end;

procedure TClientiForm.CloseAnim(I: TImage);
const
  Passaggi = 7;
  Delay = 10;
var
  R: TRect;
  VRatio, HRatio: Integer;
  Counter: Integer;
begin
  // IMposta alcune variabili utili per dopo
  R := Rect(0, 0, I.Width, I.Height);
  HRatio := Trunc(R.Right / Passaggi / 2);
  VRatio := Trunc(R.Bottom / Passaggi / 2);
  // Visualizza l'animazione di chiusura del riquadro del soggetto selezionato
  I.Canvas.Brush.Color := clRed;
  I.Canvas.FillRect(R);
  I.Update;
  // Cicla per i numero dei passaggi
  for Counter := 1 to Passaggi do
  begin
    // Aggiorna la posizione e le dimansioni del rettangolo dell'animazione
    Inc(R.Left, HRatio);
    Inc(R.Top, VRatio);
    Dec(R.Right, HRatio);
    Dec(R.Bottom, VRatio);
    // Traccia il rettangolo
    I.Canvas.Brush.Color := clBlack;
    I.Canvas.FrameRect(R);
    I.Update;
    // Attende;
    Sleep(Delay);
    // F sparire il rettangolo
    I.Canvas.Brush.Color := clRed;
    I.Canvas.FrameRect(R);
    I.Update;
  end;
end;

procedure TClientiForm.OpenAnim(I: TImage);
const
  Passaggi = 6;
  Delay = 15;
var
  R: TRect;
  VRatio, HRatio: Integer;
  Counter: Integer;
begin
  // IMposta alcune variabili utili per dopo
  R := Rect(Trunc(I.Width / 2), Trunc(I.Height / 2), Trunc(I.Width / 2), Trunc(I.Height / 2));
  HRatio := Trunc(I.Width / Passaggi / 2);
  VRatio := Trunc(I.Height / Passaggi / 2);
  // Visualizza l'animazione di chiusura del riquadro del soggetto selezionato
  I.Canvas.Brush.Color := clRed;
  I.Canvas.FillRect(Rect(0, 0, I.Width, I.Height));
  I.Update;
  // Cicla per i numero dei passaggi
  for Counter := 1 to Passaggi do
  begin
    // Aggiorna la posizione e le dimansioni del rettangolo dell'animazione
    Dec(R.Left, HRatio);
    Dec(R.Top, VRatio);
    Inc(R.Right, HRatio);
    Inc(R.Bottom, VRatio);
    // Traccia il rettangolo
    I.Canvas.Brush.Color := clBlack;
    I.Canvas.FrameRect(R);
    I.Update;
    // Attende;
    Sleep(Delay);
    // F sparire il rettangolo
    I.Canvas.Brush.Color := clRed;
    I.Canvas.FrameRect(R);
    I.Update;
  end;
end;

// =============================================================================
// INIZIO: SELEZIONE SOGGETTO/PRATICA/IMPIANTO CORRENTE
// -----------------------------------------------------------------------------
// Procedura unica per la selezione di Soggetto e Pratica/Impianto/Cantiere
procedure TClientiForm.SelezionaSoggettoPratica(Sogg_ID: Integer = -1; Prat_ID: Integer = 0);
var
  PrecSoggID, PrecPratID: Integer;
begin
  // Salva alcuni dati prima di variarli
  PrecSoggID := ID_ClienteCorrente;
  PrecPratID := ID_PraticaCorrente;
  // Salva la pagina corrente per poi ripristinarla quando si chiudono
  // la pratica corrente
  // NB: Se stiamo selezionando
  SalvaPaginaCorrente(Sogg_ID, PrecSoggID, Prat_ID, PrecPratID);
  // Ora se  specificato un soggetto da selezionare lo seleziona
  SelezionaSoggetto(Sogg_ID);
  // Se  specificata una pratica da selezionare la seleziona
  SelezionaPratica(Prat_ID);
  // Aggiorna il main menu
  MainForm.RefreshMainMenu;
  // Ripristina la pagina corrente prima della selezione di soggetto/pratica/impianto
  // la pratica corrente
  // NB: Se stiamo DEselezionando
  RipristinaPaginaCorrente(Sogg_ID, PrecSoggID, Prat_ID, PrecPratID);
  // Azzera tutti i filtri di tutte i Tabs e chiude tutte le query
  RxSpeedButtonResetQuery.Tag := 2;
  RxSpeedButtonResetQueryClick(Self);
  // Aggiorna gli allegati
  Allegati_VerificaAbilitazione;
end;

// Funzione che si occupa di selezionare il soggetto corrente
procedure TClientiForm.SelezionaSoggetto(Sogg_ID: Integer);
var
  Qry: TIB_Cursor;
begin
  // Se l'ID del soggetto ricevuto <> -1 seleziona il soggetto stesso
  // altrimenti se = -1 deseleziona l'eventuale soggetto corrente
  if Sogg_ID <> -1 then
  begin

    // ---------- INIZIO SELEZIONE SOGGETTO ----------
    // Verifica i permessi, se non ha i permessi esce subito.
    if (DM1.ModCtrl(MOD_CLIENTI) = 0) then
      Exit;
    // Query per alcuni dati
    Qry := TIB_Cursor.Create(Self);
    try
      Qry.DatabaseName := DM1.ArcDBFile;
      Qry.IB_Connection := DM1.DBAzienda;
      Qry.SQL.Add('SELECT RAGIONESOCIALE, NOME, COGNOME, TIPOPERSONA, TELEFONO, CELLULARE, IMPORTOFIDO FROM CLIENTI WHERE CODICE = ' + IntToStr(Sogg_ID));
      Qry.Open;
      // Se non trova nulla esce
      if Qry.Eof then
      begin
        DM1.Messaggi('Levante', 'Soggetto non trovato.', '', [mbOk], 0, nil);
        Exit;
      end;
      // Memorizza alcuni dati in alcune variabili usate in giro per il programma
      ID_ClienteCorrente := Sogg_ID;
      ClienteCorrente := IntToStr(Sogg_ID);
      TelefonoCS := Qry.FieldByName('TELEFONO').AsString;
      CellulareCS := Qry.FieldByName('CELLULARE').AsString;
      FidoConcesso := Qry.FieldByName('IMPORTOFIDO').AsCurrency;
      if Qry.FieldByName('TIPOPERSONA').AsString = 'F' then
        RagSocCS := Trim(Qry.FieldByName('COGNOME').AsString + ' ' + Qry.FieldByName('NOME').AsString)
      else
        RagSocCS := Qry.FieldByName('RAGIONESOCIALE').AsString;
      Qry.Close;
    finally
      Qry.Free;
    end;
    // Se non siamo in FastSelectionMode fa sparire la rubrica
    if not DM1.FastSelectionMode then
    begin
      MainForm.MMItemSetVisible(MainForm.SBRubrica, False);
    end;
    // Rende visibile il Soggetto Selezionato
    MainForm.MMItemSetVisible(MainForm.SBSoggetto, True);
    MainForm.MMItemSetEnabled(MainForm.SBSoggetto, True);
    MainForm.SBSoggetto.Refresh;
    // Rende visibili i pulsanti del soggetto selezionato
    // NB: Prima di renderlo visibile lo sposta fuori dello schermoper avitare flickering
    MainForm.SSChiudi.Top := 10000;
    MainForm.SSChiudi.Visible := True;
    MainForm.SSChiudi.Enabled := True;
    // Controlla se il soggetto  fuori fido ed eventualmente avvisa l'utente
    // NB: Solo se non siamo in FastSelectionMode altrimenti era una palla
    if ((FidoConcesso > 0) and (CalcolaScopertoCliente('NESSUNO', -9999, 'RRRRR', StrToDate('01/01/1901'), ClienteCorrente) > FidoConcesso)) then
      DM1.Messaggi('ATTENZIONE !!! - Controllo fido cliente',
        'FIDO SUPERATO !!!'#13#13'Il debito accumulato dal soggetto ha superato l''importo del fido concesso.', '', [mbOk], 0, nil);
    // Controllo ed eventuale notifica di presenza di scadenze scadute e non pagate
    // NB: Solo se non siamo nella stampa riepilogativa cantieri, altrimenti  una palla
    // NB: Solo se non siamo in FastSelectionMode altrimenti era una palla
    if (StampeCantieriForm = nil) and (DM1.TableProgressivi2VISUALIZZAMSGPERSCAD.AsString = 'T') and DM1.ScadenzeInSofferenza(Sogg_ID) then
      DM1.Messaggi('Controllo scadenze', 'Il soggetto ha alcune scadenze in sofferenza.', '', [mbOk], 0, nil);
    // ---------- FINE SELEZIONE SOGGETTO ----------

  end
  else
  begin

    // ---------- INIZIO DESELEZIONE SOGGETTO ----------
    // Chiude la form dell'anagrafica clienti se  aperta
    if AnagCliForm <> nil then
      AnagCliForm.Close;
    // Rende invisibile IL soggetto selezionato e riabilita la rubrica nel MainMenu
    MainForm.SSChiudi.Visible := False;
    MainForm.MMItemSetVisible(MainForm.SBSoggetto, False);
    // Se non siamo in FastSelectionMode fa riapparire la rubrica
    if not DM1.FastSelectionMode then
    begin
      MainForm.MMItemSetVisible(MainForm.SBRubrica, True);
      MainForm.MMItemSetEnabled(MainForm.SBRubrica, True);
    end;
    // Azzera la variabili globali con alcuni dati del soggetto selezionato
    ID_ClienteCorrente := -1;
    ClienteCorrente := '';
    RagSocCS := '';
    TelefonoCS := '';
    CellulareCS := '';
    FidoConcesso := 0;
    // ---------- FINE DESELEZIONE SOGGETTO ----------

  end;
end;

// Funzione che si occupa di selezionare la pratica corrente
procedure TClientiForm.SelezionaPratica(Prat_ID: Integer);
var
  Qry: TIB_Cursor;
begin
  // Se l'ID della pratica ricevuto <> 0 seleziona la pratica stessa
  // altrimenti se = 0 deseleziona l'eventuale pratica corrente
  if Prat_ID <> 0 then
  begin

    // ---------- INIZIO SELEZIONE PRATICA ----------
    // Verifica i permessi, se non ha i permessi esce subito.
    if (DM1.ModCtrl(MOD_PRATICHE) = 0) and (DM1.ModCtrl(MOD_CONTATTI) = 0) then
      Exit;
    // Salva la pagina corrente per poi ripristinarla quando si chiudono
    // la pratica corrente
    // SalvaPaginaCorrente;
    // Query per alcuni dati della pratica
    Qry := TIB_Cursor.Create(Self);
    try
      Qry.DatabaseName := DM1.ArcDBFile;
      Qry.IB_Connection := DM1.DBAzienda;
      Qry.SQL.Add
        ('SELECT P.TIPO, P.CODICE, P.DATAAPERTURA, P.DESCRIZIONE, P.COMUNEIMM, P.PROVINCIAIMM, P.INDIRIZZOIMM, P.NUMCIVICOIMM, P.IMMOBLOCALITA, P.IMMOBPROVINCIA, P.IMMOBINDIRIZZO, P.IMMOBNUMCIVICO');
      Qry.SQL.Add('FROM PRATICHE P WHERE P.ID = ' + IntToStr(Prat_ID));
      Qry.Open;
      // Se non trova nulla esce
      if Qry.Eof then
      begin
        DM1.Messaggi('Levante', 'Pratica non trovata.', '', [mbOk], 0, nil);
        Exit;
      end;
      // Memorizza alcuni dati in alcune variabili usate in giro per il programma
      ID_PraticaCorrente := Prat_ID;
      TipoPraticaCorrente := Qry.FieldByName('TIPO').AsString;
      PraticaCorrente := Qry.FieldByName('CODICE').AsString;
      DataPraticaCorrente := Qry.FieldByName('DATAAPERTURA').AsString;
      DataPraticaCorrenteSQL := FormatDateTime('mm/dd/yyyy', Qry.FieldByName('DATAAPERTURA').AsDate);
      DescPraticaCorrente := Qry.FieldByName('DESCRIZIONE').AsString;
      // Costruisce l'indirizzo per la pratica o per l'impianto
      if TipoPraticaCorrente = 'P' then
      begin
        ComunePraticaCorrente := Qry.FieldByName('IMMOBLOCALITA').AsString + '  (' + Qry.FieldByName('IMMOBPROVINCIA').AsString + ')';
        IndirizzoPraticaCorrente := Qry.FieldByName('IMMOBINDIRIZZO').AsString + ' ' + Qry.FieldByName('IMMOBNUMCIVICO').AsString;
      end
      else if TipoPraticaCorrente = 'A' then
      begin
        ComunePraticaCorrente := Qry.FieldByName('COMUNEIMM').AsString + '  (' + Qry.FieldByName('PROVINCIAIMM').AsString + ')';
        IndirizzoPraticaCorrente := Qry.FieldByName('INDIRIZZOIMM').AsString + ' ' + Qry.FieldByName('NUMCIVICOIMM').AsString;
      end
      else
      begin
        ComunePraticaCorrente := '';
        IndirizzoPraticaCorrente := '';
      end;
      // Chiude la query
      Qry.Close;
    finally
      Qry.Free;
    end;
    // Abilita la pratica corrente e disabilita le pratiche, posiziona anche i pulsanti di
    // chiusura della pratica selezionata
    if TipoPraticaCorrente = 'P' then
    begin
      // Se non siamo in FastSelectionMode fa sparire l'elenco
      // delle pratiche, impianti, GC ecc.
      if not DM1.FastSelectionMode then
      begin
        MainForm.MMItemSetVisible(MainForm.SBPratiche, False);
        MainForm.MMItemSetVisible(MainForm.SBAssistenze, False);
        MainForm.MMItemSetVisible(MainForm.SBGC, True);
      end;
      MainForm.MMItemSetVisible(MainForm.SBPratica, True);
      MainForm.MMItemSetEnabled(MainForm.SBPratica, True);
      MainForm.SBPratica.Refresh;
      MainForm.MMItemSetVisible(MainForm.SBAssistenza, False);
      if DM1.ModCtrl(MOD_GIORNALE_CANTIERE) > 0 then
        MainForm.MMItemSetVisible(MainForm.SBGC, True);
    end
    else if TipoPraticaCorrente = 'A' then
    begin
      // Se non siamo in FastSelectionMode fa sparire l'elenco
      // delle pratiche, impianti, GC ecc.
      if not DM1.FastSelectionMode then
      begin
        MainForm.MMItemSetVisible(MainForm.SBPratiche, False);
        MainForm.MMItemSetVisible(MainForm.SBGC, False);
        MainForm.MMItemSetVisible(MainForm.SBAssistenze, False);
      end;
      MainForm.MMItemSetVisible(MainForm.SBAssistenza, True);
      MainForm.MMItemSetEnabled(MainForm.SBAssistenza, True);
      MainForm.SBAssistenza.Refresh;
      MainForm.MMItemSetVisible(MainForm.SBPratica, False);
      if DM1.ModCtrl(MOD_GIORNALE_CANTIERE) > 0 then
        MainForm.MMItemSetVisible(MainForm.SBGC, True);
    end;
    // Rende visibili i pulsanti del soggetto selezionato
    // NB: Prima di renderlo visibile lo sposta fuori dello schermoper avitare flickering
    MainForm.SSChiudi.Top := 10000;
    MainForm.PSChiudi.Visible := True;
    MainForm.PSChiudi.Enabled := True;
    // Aggiorna l'elenco dei soggetti intestatari dei documenti contenuti nella pratica
    // AggiornaSoggettiPratica;
    // ---------- FINE SELEZIONE PRATICA ----------

    // Se l'ID della pratica ricevuto <> 0 seleziona la pratica stessa
    // altrimenti se = 0 deseleziona l'eventuale pratica corrente
  end
  else
  begin

    // ---------- INIZIO DESELEZIONE PRATICA ----------
    // Aggiorna l'elenco dei soggetti intestatari dei documenti contenuti nella pratica
    // AggiornaSoggettiPratica;
    // Chiude la form dell'anagrafica pratica se  aperta
    if PraticaForm <> nil then
      PraticaForm.Close;
    // Rende invisibile IL soggetto selezionato e riabilita la rubrica nel MainMenu
    MainForm.PSChiudi.Visible := False;
    // Se non siamo in FastSelectionMode rende di nuovo visibili l'elenco delle pratiche
    // e degli impianti e il GC
    if not DM1.FastSelectionMode then
    begin
      MainForm.MMItemSetVisible(MainForm.SBPratiche, True);
      MainForm.MMItemSetEnabled(MainForm.SBPratiche, True);
      if (DM1.ModCtrl(MOD_CONTATTI) > 0) then
      begin
        MainForm.MMItemSetVisible(MainForm.SBImpegni, True);
        if DM1.MainMenuVisualizzaImpianti then
        begin
          MainForm.MMItemSetVisible(MainForm.SBAssistenze, True);
          MainForm.MMItemSetEnabled(MainForm.SBAssistenze, True);
        end;
      end;
      if (DM1.ModCtrl(MOD_GIORNALE_CANTIERE) > 0) then
        MainForm.MMItemSetVisible(MainForm.SBGC, True);
    end;
    // In ogni caso devono sparire la pratica selezionata o l'impianto selezionato
    MainForm.MMItemSetVisible(MainForm.SBPratica, False);
    MainForm.MMItemSetVisible(MainForm.SBAssistenza, False);
    // Deseleziona la pratica corrente
    TipoPraticaCorrente := '';
    ID_PraticaCorrente := 0;
    PraticaCorrente := '';
    DataPraticaCorrente := '';
    DataPraticaCorrenteSQL := '';
    DescPraticaCorrente := '';
    ComunePraticaCorrente := '';
    IndirizzoPraticaCorrente := '';
    // ---------- FINE DESELEZIONE PRATICA ----------

  end;
end;

// Procedure che salva la pagina corrente al momento della selezione
procedure TClientiForm.SalvaPaginaCorrente(New_Sogg_ID, Old_Sogg_ID, New_Prat_ID, Old_Prat_ID: Integer);
begin
  // Se si sta selezionando una pratica/cantiere/impianto
  if ((New_Sogg_ID <> -1) and (New_Sogg_ID <> Old_Sogg_ID)) or ((New_Prat_ID <> 0) and (New_Prat_ID <> Old_Prat_ID)) then
  begin
    // Salva la pagina corrente al momento della selezione
    if PageControl2.ActivePage = TabClienti then
      PrecPaginaCorrente := IDX_AUTOQUERY_RUBRICA
    else if PageControl2.ActivePage = TabPratiche then
      PrecPaginaCorrente := IDX_AUTOQUERY_PRATICHE
    else if PageControl2.ActivePage = TabAssistenze then
      PrecPaginaCorrente := IDX_AUTOQUERY_ASSISTENZE
    else
      PrecPaginaCorrente := -1;
  end;
end;

// Procedure che ripristina la pagina corrente prima della selezione di soggetto/pratica/cantiere
procedure TClientiForm.RipristinaPaginaCorrente(New_Sogg_ID, Old_Sogg_ID, New_Prat_ID, Old_Prat_ID: Integer);
begin
  // Se si sta deselezionando la pratica/cantiere/impianto
  if ((New_Sogg_ID = -1) and (New_Sogg_ID <> Old_Sogg_ID)) or ((New_Prat_ID = 0) and (New_Prat_ID <> Old_Prat_ID)) then
  begin
    // Si riporta sulla pagina che era selezionata al
    // momento della selezione del cantiere.
    if PrecPaginaCorrente = IDX_AUTOQUERY_RUBRICA then
      MainForm.SBRubricaClick(MainForm.SBRubrica)
    else if PrecPaginaCorrente = IDX_AUTOQUERY_PRATICHE then
      MainForm.SBRubricaClick(MainForm.SBPratiche)
    else if PrecPaginaCorrente = IDX_AUTOQUERY_ASSISTENZE then
      MainForm.SBRubricaClick(MainForm.SBAssistenze);
  end;
end;
// -----------------------------------------------------------------------------
// FINE: SELEZIONE SOGGETTO/PRATICA/IMPIANTO CORRENTE
// =============================================================================

procedure TClientiForm.TrovaDocumentiSelezionati;
var
  QryAltriDoc: TIBOQuery;
begin
  // Pulisce le query
  if QryDoc.Active then
    QryDoc.Close;
  QryDoc.SQL.Clear;
  if QryDocAltri.Active then
    QryDocAltri.Close;
  QryDocAltri.SQL.Clear;

  // Esegue le query per trovare i docuemnti selezionati
  if DocIsChecked(IDX_VEND_PREVENTIVI) or DocIsChecked(IDX_VEND_ORDINI) or DocIsChecked(IDX_VEND_SAL) or DocIsChecked(IDX_VEND_BUONICONSEGNA) or
    DocIsChecked(IDX_VEND_DDT) or DocIsChecked(IDX_VEND_FATTURE) or DocIsChecked(IDX_VEND_RICEVUTEFISCALI) or DocIsChecked(IDX_VEND_FATTURERICEVUTEFISCALI) or
    DocIsChecked(IDX_VEND_NOTEDICREDITO) or DocIsChecked(IDX_VEND_COMMESSA) or DocIsChecked(IDX_VEND_CARICOCANTIERE) or DocIsChecked(IDX_VEND_SCARICOCANTIERE)
    or DocIsChecked(IDX_VEND_CONTO) or DocIsChecked(IDX_VEND_INTERVENTO) or DocIsChecked(IDX_ACQ_ORDINIFORNITORI) or DocIsChecked(IDX_ACQ_BOLLEENTRATA) or
    DocIsChecked(IDX_ACQ_FATTUREACQUISTO) or DocIsChecked(IDX_ACQ_NOTEDICREDITO_FORNITORI) then
    EseguiQueryPreventiviOrdini(QryDoc);

  // In Base all'apposito parametro decide a quale query aggiungere l'elenco degli
  // "altri documenti", cio sempre a quella dei documenti principali oppure ad
  // una query separata per poi avere anche una visualizzazione separata e pi performante.
  if (DM1.TableProgressiviALTRIDOCINELENCOSEPARATO.AsString = 'T') then
    QryAltriDoc := ClientiForm.QryDocAltri
  else
    QryAltriDoc := ClientiForm.QryDoc;
  // Per i documenti successivi non deve cercarli per i filtri elencati nelle condizioni
  // di questo IF perch i documenti all'interno di questo blocco non posseggono questi campi
  // e quindi nel caso l'utente specifichi uno di questi filtri non deve visualizzare nessuno
  // di questi documento.
  // NB: Aggiunge le query degli altri documento solo se l'apposito parametro non specifica che gli "altri
  // documenti" devono essere visualizzati in un elenco a parte
  if (Trim(Causale.Text) = '') then
  begin
    if DocIsChecked(IDX_ALTRI_FILESESTERNI) then
      EseguiQueryExtFile(QryAltriDoc);
    if (Trim(SoloRegistro.Text) = '') and (Trim(TranneRegistro.Text) = '') and (Trim(SoloStato.Text) = '') then
    begin
      if DocIsChecked(IDX_ALTRI_TESTI) then
        EseguiQueryTesti(QryAltriDoc);
      if DocIsChecked(IDX_ALTRI_CONFORMITA) then
        EseguiQueryConformita(QryAltriDoc);
      if DocIsChecked(IDX_RAPP_GIORN) then
        EseguiQueryRappGiorn(QryAltriDoc);
      // if DocIsChecked(IDX_ALTRI_FAXRICEVUTI) or DocIsChecked(IDX_ALTRI_FAXINVIATI)then EseguiQueryFax;
      // if DocIsChecked(IDX_ALTRI_CONTATTI) then EseguiQueryContatti;
      // if SBTracciati.Down then EseguiQueryTracciati;
    end;
  end;

  // Apre la query per la visualizzazione dei documento selezionati
  if QryDoc.SQL.Count > 0 then
  begin
    // if SoloTipoSoggetto.Text <> '' then QryDoc.SQL.Add(' AND C.CLIENTEFORNITORE = ''' + SoloTipoSoggetto.Text + '''');
    QryDoc.SQL.Add(DM1.GeneraOrderBy(tvDoc)); // Aggiunge l'ORDER BY
    QryDoc.Open;
  end;
  if QryDocAltri.SQL.Count > 0 then
  begin
    QryDocAltri.SQL.Add(DM1.GeneraOrderBy(tvAltriDoc)); // Aggiunge l'ORDER BY
    QryDocAltri.Open;
  end;
end;

procedure TClientiForm.TrovaDocumentiSelezionati2;
var
  QryAltriDoc: TIBOQuery;
  TmpStr: String;
  LTmpInt: Integer;
begin
  try
    // Pulisce le query
    if QryDoc.Active then
      QryDoc.Close;
    QryDoc.SQL.Clear;

    // Reimposta la query
    QryDoc.SQL.Add('SELECT * FROM DOC_LIST_VIEW');
    QryDoc.SQL.Add('WHERE');

    // ==========================================================================
    // PARTE DI INCLUSIONE/ESCLUSIONE DEI VARI TIPI DI DOCUMENTI
    // --------------------------------------------------------------------------
    QryDoc.SQL.Add('(TipoDoc = ''Dummy''');
    // Aggiunge le condizioni di filtraggio relative alla seleziona o meno dei documenti
    // NB: Per lo fa al rovescio rispetto a prima, praticamente mette landizione di
    // non prelevare un certo tipo di documento se questo non  selezionato.Self
    if DocIsChecked(IDX_VEND_PREVENTIVI) then
      QryDoc.SQL.Add('OR TipoDoc = ''Preventivo''');
    if DocIsChecked(IDX_VEND_ORDINI) then
      QryDoc.SQL.Add('OR TipoDoc = ''Ordine''');
    if DocIsChecked(IDX_VEND_SAL) then
      QryDoc.SQL.Add('OR TipoDoc = ''S.A.L.''');
    if DocIsChecked(IDX_VEND_BUONICONSEGNA) then
      QryDoc.SQL.Add('OR TipoDoc = ''Buono_cons''');
    if DocIsChecked(IDX_VEND_DDT) then
      QryDoc.SQL.Add('OR TipoDoc = ''D.D.T.''');
    if DocIsChecked(IDX_VEND_FATTURE) then
      QryDoc.SQL.Add('OR TipoDoc = ''Fattura''');
    if DocIsChecked(IDX_VEND_RICEVUTEFISCALI) then
      QryDoc.SQL.Add('OR TipoDoc = ''Ricev.fisc''');
    if DocIsChecked(IDX_VEND_FATTURERICEVUTEFISCALI) then
      QryDoc.SQL.Add('OR TipoDoc = ''Fatt.R.F.''');
    if DocIsChecked(IDX_VEND_NOTEDICREDITO) then
      QryDoc.SQL.Add('OR TipoDoc = ''Nota_accre''');
    if DocIsChecked(IDX_VEND_COMMESSA) then
      QryDoc.SQL.Add('OR TipoDoc = ''Commessa''');
    if DocIsChecked(IDX_VEND_CARICOCANTIERE) then
      QryDoc.SQL.Add('OR TipoDoc = ''Carico_cantiere''');
    if DocIsChecked(IDX_VEND_SCARICOCANTIERE) then
      QryDoc.SQL.Add('OR TipoDoc = ''Scarico_cantiere''');
    if DocIsChecked(IDX_VEND_CONTO) then
      QryDoc.SQL.Add('OR TipoDoc = ''Estratto_conto''');
    if DocIsChecked(IDX_VEND_INTERVENTO) then
      QryDoc.SQL.Add('OR TipoDoc = ''Intervento''');
    if DocIsChecked(IDX_ACQ_ORDINIFORNITORI) then
      QryDoc.SQL.Add('OR TipoDoc = ''Ord.fornit''');
    if DocIsChecked(IDX_ACQ_BOLLEENTRATA) then
      QryDoc.SQL.Add('OR TipoDoc = ''Bolla_entr''');
    if DocIsChecked(IDX_ACQ_FATTUREACQUISTO) then
      QryDoc.SQL.Add('OR TipoDoc = ''Fatt.acqui''');
    if DocIsChecked(IDX_ACQ_NOTEDICREDITO_FORNITORI) then
      QryDoc.SQL.Add('OR TipoDoc = ''N.C.fornit''');
    // Parte delle condizioni di filtraggio per tipo documenti basato tul DynamicDocType
    // NB: L'abilitazione dei documenti gestiti con  il DynamicDocType l'ho messa
    // sotto le ex conformit (gestione dei permessi di Levante)
    // NB: Siccome non riesco a leggere i permessi per il tipo documenti nell'LDE
    // faccio in modo che i documenti LDE siano visibili solamente se si hanno
    // sia i diritti di letture che di scrittura, altrimenti sono disabilitati
    if (DM1.ModCtrl(MOD_CONFORMITA) > 1) then
      TddtFactory.LDEDocTypes.FillWhereConditions(QryDoc.SQL);

    // Per i documenti successivi non deve cercarli per i filtri elencati nelle condizioni
    // di questo IF perch i documenti all'interno di questo blocco non posseggono questi campi
    // e quindi nel caso l'utente specifichi uno di questi filtri non deve visualizzare nessuno
    // di questi documento.
    if DocIsChecked(IDX_ALTRI_FILESESTERNI) then
      QryDoc.SQL.Add('OR TipoDoc = ''Doc.esterno''');

    if DocIsChecked(IDX_ALTRI_TESTI) then
      QryDoc.SQL.Add('OR TipoDoc = ''Lettera''');

    // if (not DocIsChecked(IDX_ALTRI_CONFORMITA)) or (Trim(Causale.Text) <> '') or (Trim(SoloRegistro.Text) <> '') or (Trim(TranneRegistro.Text) <> '') then
    // QryDoc.SQL.Add('AND TipoDoc <> ''Conformita''');

    if DocIsChecked(IDX_RAPP_GIORN) then
      QryDoc.SQL.Add('OR TipoDoc = ''Rapp.giorn.''');

    QryDoc.SQL.Add(')');
    // ==========================================================================

    // ==========================================================================
    // FILTRAGGIO PER SOGGETTO / PRATICA
    // --------------------------------------------------------------------------
    if PraticaCorrente <> '' then
    begin

      TmpStr := '';
      if DM1.TableProgressiviRICDOC_PRATICA1.AsString <> 'F' then
      begin
        if TmpStr <> '' then
          TmpStr := TmpStr + ' OR ';
        TmpStr := TmpStr + '(Pratica = ' + PraticaCorrente + ' AND DataPratica1 = ''' + DataPraticaCorrenteSQL + ''')';
      end;
      if DM1.TableProgressiviRICDOC_PRATICA2.AsString <> 'F' then
      begin
        if TmpStr <> '' then
          TmpStr := TmpStr + ' OR ';
        TmpStr := TmpStr + '(Pratica2 = ' + PraticaCorrente + ' AND DataPratica2 = ''' + DataPraticaCorrenteSQL + ''')';
      end;
      if DM1.TableProgressiviRICDOC_PRATICA3.AsString <> 'F' then
      begin
        if TmpStr <> '' then
          TmpStr := TmpStr + ' OR ';
        TmpStr := TmpStr + '(Pratica3 = ' + PraticaCorrente + ' AND DataPratica3 = ''' + DataPraticaCorrenteSQL + ''')';
      end;
      if TmpStr <> '' then
        QryDoc.SQL.Add('AND (' + TmpStr + ')');

      // Se  impostata la ricerca anche sugli "Altri Soggetti" dei documenti...
    end
    else if DM1.TableProgressiviFILTRADOCPERALTRISOGGETTI.AsString = 'T' then
    begin

      if ClienteCorrente <> '' then
      begin
        QryDoc.SQL.Add('AND (');
        QryDoc.SQL.Add('      CodiceCliente = ' + ClienteCorrente);
        QryDoc.SQL.Add('      OR RIFSOGG1_CODICE = ' + ClienteCorrente);
        QryDoc.SQL.Add('      OR RIFSOGG2_CODICE = ' + ClienteCorrente);
        QryDoc.SQL.Add('      OR RIFSOGG3_CODICE = ' + ClienteCorrente);
        QryDoc.SQL.Add('      OR RIFSOGG4_CODICE = ' + ClienteCorrente);
        QryDoc.SQL.Add('      OR RIFSOGG5_CODICE = ' + ClienteCorrente);
        QryDoc.SQL.Add('      OR RIFSOGG6_CODICE = ' + ClienteCorrente);
        QryDoc.SQL.Add('      OR RIFSOGG7_CODICE = ' + ClienteCorrente);
        QryDoc.SQL.Add('      OR RIFSOGG8_CODICE = ' + ClienteCorrente);
        QryDoc.SQL.Add('      OR RIFSOGG9_CODICE = ' + ClienteCorrente);
        QryDoc.SQL.Add('      OR RIFSOGG10_CODICE = ' + ClienteCorrente);
        QryDoc.SQL.Add('    )');
      end;

      // Se invece non  impostata la ricerca anche sugli "altri soggetti dei documenti" ricerca
      // solo sull'intestatario del documento
    end
    else
    begin
      if ClienteCorrente <> '' then
        QryDoc.SQL.Add('AND CodiceCliente = ' + ClienteCorrente);
    end;
    // ==========================================================================

    // ==========================================================================
    // FILTRAGGIO PER DATE
    // --------------------------------------------------------------------------
    if FilterDocTipoData.Text = 'Data documento' then
    begin
      if DM1.ControllaDataStr(DateEditDa.EditText) then
        QryDoc.SQL.Add('AND DataDoc >= ' + QuotedStr(FormatDateTime('mm/dd/yyyy', DateEditDa.Date)));
      if DM1.ControllaDataStr(DateEditA.EditText) then
        QryDoc.SQL.Add('AND DataDoc < ' + QuotedStr(FormatDateTime('mm/dd/yyyy', DateEditA.Date + 1)));
    end
    else if FilterDocTipoData.Text = 'Consegna' then
    begin
      if DM1.ControllaDataStr(DateEditDa.EditText) then
        QryDoc.SQL.Add('AND ConsegnaData >= ' + QuotedStr(FormatDateTime('mm/dd/yyyy', DateEditDa.Date)));
      if DM1.ControllaDataStr(DateEditA.EditText) then
        QryDoc.SQL.Add('AND ConsegnaData < ' + QuotedStr(FormatDateTime('mm/dd/yyyy', DateEditA.Date + 1)));
    end
    else if FilterDocTipoData.Text = 'Scadenza validit' then
    begin
      if DM1.ControllaDataStr(DateEditDa.EditText) then
        QryDoc.SQL.Add('AND ValiditaData >= ' + QuotedStr(FormatDateTime('mm/dd/yyyy', DateEditDa.Date)));
      if DM1.ControllaDataStr(DateEditA.EditText) then
        QryDoc.SQL.Add('AND ValiditaData < ' + QuotedStr(FormatDateTime('mm/dd/yyyy', DateEditA.Date + 1)));
    end
    else if FilterDocTipoData.Text = 'Data protocollo' then
    begin
      if DM1.ControllaDataStr(DateEditDa.EditText) then
        QryDoc.SQL.Add('AND PROTOCOLLO_DATA >= ' + QuotedStr(FormatDateTime('mm/dd/yyyy', DateEditDa.Date)));
      if DM1.ControllaDataStr(DateEditA.EditText) then
        QryDoc.SQL.Add('AND PROTOCOLLO_DATA < ' + QuotedStr(FormatDateTime('mm/dd/yyyy', DateEditA.Date + 1)));
    end
    else if FilterDocTipoData.Text = 'Creazione' then
    begin
      if DM1.ControllaDataStr(DateEditDa.EditText) then
        QryDoc.SQL.Add('AND DATAORAULTMOD_CREAZIONE >= ' + QuotedStr(FormatDateTime('mm/dd/yyyy', DateEditDa.Date)));
      if DM1.ControllaDataStr(DateEditA.EditText) then
        QryDoc.SQL.Add('AND DATAORAULTMOD_CREAZIONE < ' + QuotedStr(FormatDateTime('mm/dd/yyyy', DateEditA.Date + 1)));
    end
    else if FilterDocTipoData.Text = 'Ultima modifica' then
    begin
      if DM1.ControllaDataStr(DateEditDa.EditText) then
        QryDoc.SQL.Add('AND DATAORAULTMOD_ULTMOD >= ' + QuotedStr(FormatDateTime('mm/dd/yyyy', DateEditDa.Date)));
      if DM1.ControllaDataStr(DateEditA.EditText) then
        QryDoc.SQL.Add('AND DATAORAULTMOD_ULTMOD < ' + QuotedStr(FormatDateTime('mm/dd/yyyy', DateEditA.Date + 1)));
    end;
    // ==========================================================================

    // ==========================================================================
    // FILTRAGGIO PER SUBSOGG
    // --------------------------------------------------------------------------
    if (DocSubSogg1.Text <> '') or (DocSubSogg2.Text <> '') or (DocSubSogg3.Text <> '') or (DocSubSogg4Dal.Text <> '') or (DocSubSogg4Al.Text <> '') then
    begin
      if (DocSubSogg1.Text <> '') then
        QryDoc.SQL.Add('AND UPPER(SUBSOGGCAMPO1) = ' + QuotedStr(Uppercase(DocSubSogg1.Text)));
      if (DocSubSogg2.Text <> '') then
        QryDoc.SQL.Add('AND UPPER(SUBSOGGCAMPO2) = ' + QuotedStr(Uppercase(DocSubSogg2.Text)));
      if (DocSubSogg3.Text <> '') then
        QryDoc.SQL.Add('AND UPPER(SUBSOGGCAMPO3) = ' + QuotedStr(Uppercase(DocSubSogg3.Text)));
      if (DocSubSogg4Dal.Text <> '') then
        QryDoc.SQL.Add('AND SUBSOGGCAMPO4 >= ' + QuotedStr(FormatDateTime('mm/dd/yyyy', DocSubSogg4Dal.Date)));
      if (DocSubSogg4Al.Text <> '') then
        QryDoc.SQL.Add('AND SUBSOGGCAMPO4 <= ' + QuotedStr(FormatDateTime('mm/dd/yyyy', DocSubSogg4Al.Date)));
    end;
    // ==========================================================================

    // ==========================================================================
    // FILTRAGGIO PER TESTO DA CERCARE GENERALE
    // --------------------------------------------------------------------------
    if Trim(FilterTesto.Text) <> '' then
    begin
      QryDoc.SQL.Add('AND (');
      DM1.AggiungiRicercaCampo(QryDoc.SQL, 'RagSocCli', FilterTesto.Text, False);
      QryDoc.SQL.Add('OR');
      DM1.AggiungiRicercaCampo(QryDoc.SQL, 'RagSocDestMerci', FilterTesto.Text, False);
      QryDoc.SQL.Add('OR');
      DM1.AggiungiRicercaCampo(QryDoc.SQL, 'RIFSOGG1_RAGIONESOCIALE', FilterTesto.Text, False);
      QryDoc.SQL.Add('OR');
      DM1.AggiungiRicercaCampo(QryDoc.SQL, 'RIFSOGG2_RAGIONESOCIALE', FilterTesto.Text, False);
      QryDoc.SQL.Add('OR');
      DM1.AggiungiRicercaCampo(QryDoc.SQL, 'RIFSOGG3_RAGIONESOCIALE', FilterTesto.Text, False);
      QryDoc.SQL.Add('OR');
      DM1.AggiungiRicercaCampo(QryDoc.SQL, 'RIFSOGG4_RAGIONESOCIALE', FilterTesto.Text, False);
      QryDoc.SQL.Add('OR');
      DM1.AggiungiRicercaCampo(QryDoc.SQL, 'RIFSOGG5_RAGIONESOCIALE', FilterTesto.Text, False);
      QryDoc.SQL.Add('OR');
      DM1.AggiungiRicercaCampo(QryDoc.SQL, 'RIFSOGG6_RAGIONESOCIALE', FilterTesto.Text, False);
      QryDoc.SQL.Add('OR');
      DM1.AggiungiRicercaCampo(QryDoc.SQL, 'RIFSOGG7_RAGIONESOCIALE', FilterTesto.Text, False);
      QryDoc.SQL.Add('OR');
      DM1.AggiungiRicercaCampo(QryDoc.SQL, 'RIFSOGG8_RAGIONESOCIALE', FilterTesto.Text, False);
      QryDoc.SQL.Add('OR');
      DM1.AggiungiRicercaCampo(QryDoc.SQL, 'RIFSOGG9_RAGIONESOCIALE', FilterTesto.Text, False);
      QryDoc.SQL.Add('OR');
      DM1.AggiungiRicercaCampo(QryDoc.SQL, 'RIFSOGG10_RAGIONESOCIALE', FilterTesto.Text, False);
      QryDoc.SQL.Add('OR');
      DM1.AggiungiRicercaCampo(QryDoc.SQL, 'OGGETTO', FilterTesto.Text, False);
      QryDoc.SQL.Add('OR');
      DM1.AggiungiRicercaCampo(QryDoc.SQL, 'NOTE', FilterTesto.Text, False);
      QryDoc.SQL.Add('OR');
      DM1.AggiungiRicercaCampo(QryDoc.SQL, 'Operatore', FilterTesto.Text, False);
      QryDoc.SQL.Add('OR');
      DM1.AggiungiRicercaCampo(QryDoc.SQL, 'OPERATOREULTMOD_ULTMOD', FilterTesto.Text, False);
      QryDoc.SQL.Add(')');
    end;
    // ==========================================================================

    // ==========================================================================
    // ALTRI FILTRI
    // --------------------------------------------------------------------------
    if FilterCodiceArticolo.Text <> '' then
    begin
      QryDoc.SQL.Add
        ('AND EXISTS(SELECT RIGHIPRV.CODICEARTICOLO FROM RIGHIPRV WHERE RIGHIPRV.TIPODOCUMENTO=DOC_LIST_VIEW.TIPODOC AND RIGHIPRV.NUMORDPREV=DOC_LIST_VIEW.CODICEDOC');
      QryDoc.SQL.Add
        ('           AND RIGHIPRV.REGISTRO=DOC_LIST_VIEW.REGISTRO AND RIGHIPRV.DATADOCUMENTO=DOC_LIST_VIEW.DATADOC AND RIGHIPRV.CODICEARTICOLO LIKE ''' +
        Trim(FilterCodiceArticolo.Text) + ''')');
    end;
    if FilterDescrizione.Text <> '' then
    begin
      QryDoc.SQL.Add
        ('AND EXISTS(SELECT RIGHIPRV.CODICEARTICOLO FROM RIGHIPRV WHERE RIGHIPRV.TIPODOCUMENTO=DOC_LIST_VIEW.TIPODOC AND RIGHIPRV.NUMORDPREV=DOC_LIST_VIEW.CODICEDOC');
      QryDoc.SQL.Add('           AND RIGHIPRV.REGISTRO=DOC_LIST_VIEW.REGISTRO AND RIGHIPRV.DATADOCUMENTO=DOC_LIST_VIEW.DATADOC');
      DM1.AggiungiRicercaCampo(QryDoc.SQL, 'RIGHIPRV.DESCRIZIONE', FilterDescrizione.Text, True);
      QryDoc.SQL.Add('          )');
    end;

    if FilterNumDoc.Text <> '' then
    begin
      if TryStrToInt(FilterNumDoc.Text, LTmpInt) then
      begin
        LTmpInt := Abs(LTmpInt); // altrimenti se cerco ad esempio per -100 mi da un errore
        QryDoc.SQL.Add('AND (   (CodiceDoc = ' + IntToStr(LTmpInt) + ') OR (CodiceDoc = -' + IntToStr(LTmpInt) + ') OR (RIFDOC_NUM = ' + IntToStr(LTmpInt) + ') OR (RIFDOC_NUM = -' + IntToStr(LTmpInt) + ')   )')
      end
      else
        raise Exception.Create('N documento non valido.');
    end;

    if SoloRegistro.Text <> '' then
    begin
      QryDoc.SQL.Add('AND (   (Registro = ' + QuotedStr(SoloRegistro.Text) + ') OR (RIFDOC_REG = ' + QuotedStr(SoloRegistro.Text) + ')   )');
    end;

    if TranneRegistro.Text <> '' then
      QryDoc.SQL.Add('AND Registro <> ''' + TranneRegistro.Text + '''');

    if FilterProtocollo.Text <> '' then
      QryDoc.SQL.Add('AND Protocollo = ' + FilterProtocollo.Text);
    if SoloStato.Text <> '' then
      QryDoc.SQL.Add('AND StatoDescrizione = ''' + SoloStato.Text + '''');
    if Causale.Text <> '' then
      QryDoc.SQL.Add('AND Causale = ''' + Causale.Text + '''');
    if DocOperatore.Text <> '' then
      QryDoc.SQL.Add('AND (Operatore = ' + QuotedStr(DocOperatore.Text) + ' OR OPERATOREULTMOD_ULTMOD = ' + QuotedStr(DocOperatore.Text) + ')');

    if DocAgente.Text <> '' then
      QryDoc.SQL.Add('AND Agente = ''' + DocAgente.Text + '''');
    if DocAgente2.Text <> '' then
      QryDoc.SQL.Add('AND Agente2 = ''' + DocAgente2.Text + '''');
    if DocAgente3.Text <> '' then
      QryDoc.SQL.Add('AND Agente3 = ''' + DocAgente3.Text + '''');
    if DocAgente4.Text <> '' then
      QryDoc.SQL.Add('AND Agente4 = ''' + DocAgente4.Text + '''');

    if SoloTipoSoggetto.Text <> '' then
      QryDoc.SQL.Add('AND TipoSoggetto = ''' + SoloTipoSoggetto.Text + '''');

    // Categorie cantieri
    if DocCategCant1.Text <> '' then
      DM1.AddSQL(QryDoc, 'AND', 'CATEGCANT1 = ''' + DocCategCant1.Text + '''');
    if DocCategCant2.Text <> '' then
      DM1.AddSQL(QryDoc, 'AND', 'CATEGCANT2 = ''' + DocCategCant2.Text + '''');
    if DocCategCant3.Text <> '' then
      DM1.AddSQL(QryDoc, 'AND', 'CATEGCANT3 = ''' + DocCategCant3.Text + '''');
    if DocCategCant4.Text <> '' then
      DM1.AddSQL(QryDoc, 'AND', 'CATEGCANT4 = ''' + DocCategCant4.Text + '''');
    if DocCategCant5.Text <> '' then
      DM1.AddSQL(QryDoc, 'AND', 'CATEGCANT5 = ''' + DocCategCant5.Text + '''');
    if DocCategCant6.Text <> '' then
      DM1.AddSQL(QryDoc, 'AND', 'CATEGCANT6 = ''' + DocCategCant6.Text + '''');

    // Se specificato ricerca per RDA
    if FilterRDA.Text <> '' then
      DM1.AddSQL(QryDoc, 'AND', 'UPPER(RDA) = UPPER(''' + Trim(FilterRDA.Text) + ''')');
    // ==========================================================================

    // ==========================================================================
    // SOLO INTERVENTO CON LE SEGUENTI O.P. FATTE
    // --------------------------------------------------------------------------
    if FilterOp1.Text <> '' then
      QryDoc.SQL.Add
        ('AND DOC_LIST_VIEW.TIPODOC=''Intervento'' AND EXISTS (SELECT OPI.ID FROM OPIMPEGNO OPI WHERE OPI.IDIMPEGNO=DOC_LIST_VIEW.CODICEDOC AND OPI.DESCRIZIONE = '
        + QuotedStr(RightStr(FilterOp1.Text, Length(FilterOp1.Text) - 4)) + ' AND OPI.EFFETTUATA=''T'')');
    if FilterOp2.Text <> '' then
      QryDoc.SQL.Add
        ('AND DOC_LIST_VIEW.TIPODOC=''Intervento'' AND EXISTS (SELECT OPI.ID FROM OPIMPEGNO OPI WHERE OPI.IDIMPEGNO=DOC_LIST_VIEW.CODICEDOC AND OPI.DESCRIZIONE = '
        + QuotedStr(RightStr(FilterOp2.Text, Length(FilterOp2.Text) - 4)) + ' AND OPI.EFFETTUATA=''T'')');
    if FilterOp3.Text <> '' then
      QryDoc.SQL.Add
        ('AND DOC_LIST_VIEW.TIPODOC=''Intervento'' AND EXISTS (SELECT OPI.ID FROM OPIMPEGNO OPI WHERE OPI.IDIMPEGNO=DOC_LIST_VIEW.CODICEDOC AND OPI.DESCRIZIONE = '
        + QuotedStr(RightStr(FilterOp3.Text, Length(FilterOp3.Text) - 4)) + ' AND OPI.EFFETTUATA=''T'')');
    // ==========================================================================

    // ==========================================================================
    // PER VEDERE SOLO I DOC CHE FANNO PARTE DI UN IMPIANTO
    // --------------------------------------------------------------------------
    // Base alla volont di voler visualizzare solo quelli che fanno parte di un impianto oppure solo
    // quelli che NON fanno parte di un impianto oppure entrambi.
    // NB: Se sono entrambi selezionati non fa nulla perch tanto deve visualizzarli tutti
    if not(DocConCantiere.Checked[0] and DocConCantiere.Checked[1]) then
    begin
      if DocConCantiere.Checked[0] then
      begin
        QryDoc.SQL.Add('AND (SELECT FIRST 1 P.TIPO FROM PRATICHE P WHERE P.CODICE = PRATICA AND P.DATAAPERTURA = DATAPRATICA1) = ''A''');
      end;
      if DocConCantiere.Checked[1] then
      begin
        QryDoc.SQL.Add('AND (');
        QryDoc.SQL.Add('  (PRATICA IS NULL    OR   PRATICA = 0)');
        QryDoc.SQL.Add('  OR (SELECT FIRST 1 P.TIPO FROM PRATICHE P WHERE P.CODICE = PRATICA AND P.DATAAPERTURA = DATAPRATICA1) <> ''A''');
        QryDoc.SQL.Add(')');
      end;
    end;
    // ==========================================================================

    // ==========================================================================
    // IMPOSTAZIONE ORDER BY ED ESECUZIONE DELLA QUERY
    // --------------------------------------------------------------------------
    QryDoc.SQL.Add(DM1.GeneraOrderBy(tvDoc));
//QryDoc.SQL.SaveToFile('c:\sql.sql');
    QryDoc.Open;
    // ==========================================================================

    // Si posizione all'inizio
    tvDoc.DataController.GotoFirst;
  finally
    DM1.CloseWait;
  end;
end;

procedure TClientiForm.EseguiQueryClienti;
var
  I: Byte;
  Order: String;
  PratExistSql: TStrings;
begin
  // ---------------------------------------------
  // In base alle condizioni di filtraggio inserite dall'utente costruisce
  // il testo dell'interrogazione SQL.
  // ---------------------------------------------

  // Creazione e impostazione della SubQuery per la ricerca nelle pratiche/impianti/cantieri
  PratExistSql := TStringList.Create;
  try
    PratExistSql.Add('SELECT P.ID FROM PRATICHE P');
    PratExistSql.Add('WHERE P.CLIENTE = C.CODICE');
    DM1.AggiungiRicercaCampo(PratExistSql, 'P.DESCRIZIONE', FilterRubricaTrova.Text, True);

    // Chiude la query, la azzera e inserisce le prime righe
    QrySoggetti.Close;
    QrySoggetti.SQL.Clear;
    QrySoggetti.SQL.Add('SELECT C.* FROM SOGG_LIST_VIEW C');
    QrySoggetti.SQL.Add('WHERE 1=1');
    // In base al contenuto dei campi di filtraggio in fondo alla form costruisce
    // le condizioni della query.
    if TipoSoggetto.Text <> '' then
      DM1.AddSQL(QrySoggetti, 'AND', 'C.CLIENTEFORNITORE = ''' + TipoSoggetto.Text + '''');
    if EditClientiCodice.Text <> '' then
      DM1.AddSQL(QrySoggetti, 'AND', 'C.Codice = ' + EditClientiCodice.Text);
    if EditClientiRagSoc.Text <> '' then
      DM1.AggiungiRicercaCampo(QrySoggetti.SQL, 'C.RagioneSociale', EditClientiRagSoc.Text, True);
    if EditClientiCitta.Text <> '' then
      DM1.AggiungiRicercaCampo(QrySoggetti.SQL, 'C.Citta', EditClientiCitta.Text, True);
    if EditClientiProvincia.Text <> '' then
      DM1.AggiungiRicercaCampo(QrySoggetti.SQL, 'C.Provincia', EditClientiProvincia.Text, True);
    if EditClientiPIVA.Text <> '' then
      DM1.AggiungiRicercaCampo(QrySoggetti.SQL, 'C.PartitaIVA', EditClientiPIVA.Text, True);
    if EditClientiAgente.Text <> '' then
      DM1.AggiungiRicercaCampo(QrySoggetti.SQL, 'C.AGENTE', EditClientiAgente.Text, True);
    if EditClientiAgente2.Text <> '' then
      DM1.AggiungiRicercaCampo(QrySoggetti.SQL, 'C.AGENTE2', EditClientiAgente2.Text, True);
    if EditClientiAgente3.Text <> '' then
      DM1.AggiungiRicercaCampo(QrySoggetti.SQL, 'C.AGENTE3', EditClientiAgente3.Text, True);
    if EditClientiAgente4.Text <> '' then
      DM1.AggiungiRicercaCampo(QrySoggetti.SQL, 'C.AGENTE4', EditClientiAgente4.Text, True);
    if TabLettera.Text <> '' then
      DM1.AddSQL(QrySoggetti, 'AND', 'UPPER(C.RagioneSociale) LIKE UPPER(''' + DM1.AddJollyChar(TabLettera.Text) + ''')');
    if SoggStato.Text <> '' then
      DM1.AddSQL(QrySoggetti, 'AND', 'C.STATODESCRIZIONE = ''' + SoggStato.Text + '''');
    if EditClientiTelefono.Text <> '' then
    begin
      DM1.AddSQL(QrySoggetti, 'AND', '((C.TELEFONO LIKE ''%' + EditClientiTelefono.Text + '%'') OR (C.CELLULARE LIKE ''%' + EditClientiTelefono.Text +
        '%'') OR (C.FAX LIKE ''%' + EditClientiTelefono.Text + '%''))');
    end;

    // Filtri SubSogg
    if (EditClientiSubSogg1.Text <> '') or (EditClientiSubSogg2.Text <> '') or (EditClientiSubSogg3.Text <> '') or (EditClientiSubSogg4Dal.Text <> '') or
      (EditClientiSubSogg4Al.Text <> '') then
    begin
      QrySoggetti.SQL.Add('AND EXISTS(');
      QrySoggetti.SQL.Add('  SELECT SS.CODICE FROM SUBSOGG SS WHERE SS.CODICESOGGETTO=C.CODICE');
      if (EditClientiSubSogg1.Text <> '') then
        QrySoggetti.SQL.Add('  AND UPPER(SS.CAMPO1) = ' + QuotedStr(Uppercase(EditClientiSubSogg1.Text)));
      if (EditClientiSubSogg2.Text <> '') then
        QrySoggetti.SQL.Add('  AND UPPER(SS.CAMPO2) = ' + QuotedStr(Uppercase(EditClientiSubSogg2.Text)));
      if (EditClientiSubSogg3.Text <> '') then
        QrySoggetti.SQL.Add('  AND UPPER(SS.CAMPO3) = ' + QuotedStr(Uppercase(EditClientiSubSogg3.Text)));
      if (EditClientiSubSogg4Dal.Text <> '') then
        QrySoggetti.SQL.Add('  AND SS.CAMPO4 >= ' + QuotedStr(FormatDateTime('mm/dd/yyyy', EditClientiSubSogg4Dal.Date)));
      if (EditClientiSubSogg4Al.Text <> '') then
        QrySoggetti.SQL.Add('  AND SS.CAMPO4 <= ' + QuotedStr(FormatDateTime('mm/dd/yyyy', EditClientiSubSogg4Al.Date)));
      QrySoggetti.SQL.Add(')');
    end;

    // Aggiunge la ricerca con campo TROVA
    if Trim(FilterRubricaTrova.Text) <> '' then
    begin
      DM1.AddSQL(QrySoggetti, 'AND', '(');
      DM1.AggiungiRicercaCampo(QrySoggetti.SQL, 'C.RagioneSociale', FilterRubricaTrova.Text, False);
      QrySoggetti.SQL.Add('OR');
      DM1.AggiungiRicercaCampo(QrySoggetti.SQL, 'C.Indirizzo', FilterRubricaTrova.Text, False);
      QrySoggetti.SQL.Add('OR');
      DM1.AggiungiRicercaCampo(QrySoggetti.SQL, 'C.Citta', FilterRubricaTrova.Text, False);
      QrySoggetti.SQL.Add('OR');
      DM1.AggiungiRicercaCampo(QrySoggetti.SQL, 'C.Note', FilterRubricaTrova.Text, False);

      // Aggiunge anche la ricerca per pratiche
      QrySoggetti.SQL.Add('OR EXISTS (');
      QrySoggetti.SQL.AddStrings(PratExistSql);
      QrySoggetti.SQL.Add(')');

      // Chiusura del Trova
      QrySoggetti.SQL.Add(')');
    end;
    // *** Scollega l'event handler ***
    // NB: Per evitare quel problema del soggetto che si selezionava da solo (molto fastidioso)
    // alla fine ho scoperto che se durante l'interrogazione scollego questo event handler
    // non da pi questo problema.
    tvRubrica.DataController.OnDetailExpanding := nil;
    // Attiva la Query
    // QrySoggetti.SQL.SaveToFile('c:\sql.sql');
    QrySoggetti.Open;
    // Apre anche la query che fornisce il detail dei cantieri/impianti
    if QrySoggCant.Active then
      QrySoggCant.Close;
    QrySoggCant.Open;
    // QrySoggCant.SQL.SaveToFile('c:\sql.sql');
    // Si posizione all'inizio
    tvRubrica.DataController.GotoFirst;
  finally
    PratExistSql.Free;
    // *** Ripristina l'event handler ***
    // NB: Per evitare quel problema del soggetto che si selezionava da solo (molto fastidioso)
    // alla fine ho scoperto che se durante l'interrogazione scollego questo event handler
    // non da pi questo problema.
    tvRubrica.DataController.OnDetailExpanding := tvRubricaDataControllerDetailExpanding;
  end;
end;

// {
procedure TClientiForm.EseguiQueryPreventiviOrdini(QryDoc: TIBOQuery);
begin
  // Prima di tutto se la query non  vuota significa che c' una SELECT precedente
  // e quindi aggiunge l'UNION ALL
  CheckForUnionAll(QryDoc);
  // Costruisce la query SELECT per il reperimento dei dati
  // NB: LA QUERY SELECT DEVE RICOSTRUIRE IL TRACCIATO DELLA TABELLA 'DOCSEL' PERCHE'
  // DA QUANDO HO ELIMINATO L'USO DELLA TABELLA 'DOCSEL' PRATICAMENTE QUESTA PROCEDURA COSTRUISCE
  // UNA STRINGLIST CONTENENTE LA QUERY CHE POI VERRA' UNITA ALLE ALTRE QUERY PER COSTRUIRE IL
  // RISULTATO DELL'INTERROGAZIONE SU DIVERSI TIPI DI DOCUMENTO, QUINDI SE NON PASSO PIU' PER LA TABELLA
  // 'DOCSEL' MI DEVO ASSICURARE CHE TUTTE LE QUERY CHE VENGONO UNITE CON LA UNION RESTITUISCANO LO STESSO
  // IDENTICO TRACCIATO.
  // QUINDI E' IMPORTANTE MANTENERE IL TRACCIATO DELLA TABELLA 'DOCSEL' AGGIORNATO ANCHE SE NON VIENE PIU'
  // USATO IN MODO CHE FACCIA DA TRACCIA.
  QryDoc.SQL.Add('SELECT');
  QryDoc.SQL.Add('CAST(' + DM1.CodiceUtente + ' AS INTEGER) AS STATION_ID');
  QryDoc.SQL.Add(',CAST(Doc.TipoDocumento AS VARCHAR(20)) AS TIPODOC');
  QryDoc.SQL.Add(',CAST(Doc.Registro AS VARCHAR(5)) AS REGISTRO');
  QryDoc.SQL.Add(',CAST(Doc.NumOrdPrev AS INTEGER) AS CODICEDOC');
  QryDoc.SQL.Add(',CAST(Doc.DataDocumento AS TIMESTAMP) AS DATADOC');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS OGGETTOJOLLY1');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS OGGETTOJOLLY2');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS OGGETTOJOLLY3');
  QryDoc.SQL.Add(',CAST(Doc.TotaleDocumento AS DECIMAL(15,4)) AS IMPORTO');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS NOTEJOLLY1');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS NOTEJOLLY2');
  QryDoc.SQL.Add(',CAST(Cli.RagioneSociale || ''  ('' || Doc.CodiceCliente || '')'' AS VARCHAR(80)) AS CLIENTEFORNITORE');
  // ------------------
  // NB: Per gli interventi mette nel campo oggetto la <Relazione dell'Intervento
  QryDoc.SQL.Add(',CAST(');
  QryDoc.SQL.Add('  CASE');
  QryDoc.SQL.Add('    WHEN (DOC.TIPODOCUMENTO = ''Intervento'') THEN (SELECT FIRST 1 I.RELAZIONEINTERVENTO FROM IMPEGNI I WHERE I.ID=DOC.NUMORDPREV)');
  QryDoc.SQL.Add('    ELSE (DOC.NOTE || ''   '' || DOC.MESSAGGI)');
  QryDoc.SQL.Add('  END');
  QryDoc.SQL.Add(' AS VARCHAR(5000)) AS OGGETTO');
  // ------------------
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(200)) AS NOTE');
  QryDoc.SQL.Add(',CAST(Doc.StatoDescrizione AS VARCHAR(10)) AS STATODESCRIZIONE');
  QryDoc.SQL.Add(',CAST(Doc.StatoForeground AS VARCHAR(10)) AS STATOFOREGROUND');
  QryDoc.SQL.Add(',CAST(Doc.StatoBackground AS VARCHAR(10)) AS STATOBACKGROUND');
  QryDoc.SQL.Add(',CAST(Doc.Selezionato AS VARCHAR(1)) AS SELEZIONATO');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(200)) AS PROVENIENZA');
  QryDoc.SQL.Add(',CAST(Doc.Argomento AS VARCHAR(200)) AS ARGOMENTO');
  QryDoc.SQL.Add(',CAST(Doc.TotaleImponibile1+Doc.TotaleImponibile2+Doc.TotaleImponibile3+Doc.TotaleImponibile4 AS DECIMAL(15,4)) AS IMPONIBILE');
  QryDoc.SQL.Add(',CAST(Doc.ImportoIVA1+Doc.ImportoIVA2+Doc.ImportoIVA3+Doc.ImportoIVA4 AS DECIMAL(15,4)) AS IMPORTOIVA');
  QryDoc.SQL.Add(',CAST(Doc.CodiceCliente AS INTEGER) AS CODICESOGGETTO');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(8)) AS ORADOC');
  QryDoc.SQL.Add(',CAST(Doc.DaFatturare AS VARCHAR(1)) AS DAFATTURARE');
  QryDoc.SQL.Add
    (',CAST((SELECT (CASE P.TIPO WHEN ''A'' THEN P.COSTRUTTORE||'' ''||P.MODELLO ELSE P.DESCRIZIONE END) FROM Pratiche P WHERE P.Codice=Doc.Pratica AND P.DataApertura=Doc.DataPratica1)||''  (''||DOC.PRATICA|| '', ''||DOC.DATAPRATICA1||'')'' AS VARCHAR(120)) AS RIFPRATICA');
  QryDoc.SQL.Add(',CAST(Doc.ValiditaData AS TIMESTAMP) AS VALIDITADATA');
  QryDoc.SQL.Add(',CAST(Doc.ConsegnaData AS TIMESTAMP) AS CONSEGNADATA');
  QryDoc.SQL.Add(',CAST(Doc.Consegnato AS CHAR(1)) AS CONSEGNATO');
  QryDoc.SQL.Add(',CAST(Doc.Causale AS VARCHAR(15)) AS CAUSALE');
  QryDoc.SQL.Add(',CAST(Doc.CausaleCantiere AS VARCHAR(15)) AS CAUSALECANTIERE');
  QryDoc.SQL.Add(',CAST(Doc.RitAcc AS DECIMAL(15,4)) AS RITENUTAACCONTO');
  QryDoc.SQL.Add(',CAST(Cli.ClienteFornitore AS VARCHAR(10)) AS TIPOSOGGETTO');
  QryDoc.SQL.Add(',CAST(Doc.Operatore AS VARCHAR(10)) AS OPERATORE');
  QryDoc.SQL.Add('FROM PrvOrdCl Doc');
  QryDoc.SQL.Add('LEFT JOIN CLIENTI CLI ON (CLI.CODICE = DOC.CODICECLIENTE)');
  // Aggiunge una clausola WHERE finta in modo che non dia errore se non viene specificata nessuna condizione
  QryDoc.SQL.Add('WHERE 1=1');
  // Aggiunge le altre condizioni
  AddWhereConditionsForDocSel(QryDoc);
end;
// }

// Questa procedura imposta in una TStringList le condizioni WHERE da utilizzare sia
// nella query che ritorna l'elenco dei documenti tipo fiscale che nei
// relativi totali.
// NB: La query a cui aggiunger le condizioni dovr avere gi inserita la clausola
// WHERE 1=1
procedure TClientiForm.Accettatadalprovider1Click(Sender: TObject);
begin
  CreaNotificaDemoFE('rtAcceptedByProvider', '', '', 'Accettata dal provider', '', True, 0);
end;

procedure TClientiForm.AddWhereConditionsForDocSel(Q: TIBOQuery);
var
  Operatore, Linea: String;
begin
  // Aggiunge le altre condizioni
  if PraticaCorrente <> '' then
  begin
    DM1.AddSQL(Q, 'AND', '((Doc.Pratica = ' + PraticaCorrente + ' AND Doc.DataPratica1 = ''' + DataPraticaCorrenteSQL + ''') OR (Doc.Pratica2 = ' +
      PraticaCorrente + ' AND Doc.DataPratica2 = ''' + DataPraticaCorrenteSQL + ''') OR (Doc.Pratica3 = ' + PraticaCorrente + ' AND Doc.DataPratica3 = ''' +
      DataPraticaCorrenteSQL + '''))');
  end
  else
  begin
    if ClienteCorrente <> '' then
      DM1.AddSQL(Q, 'AND', 'Doc.CodiceCliente = ' + ClienteCorrente);
  end;
  if FilterNumDoc.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'Doc.NumOrdPrev = ' + FilterNumDoc.Text);
  if SoloRegistro.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'Doc.Registro = ''' + SoloRegistro.Text + '''');
  if TranneRegistro.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'Doc.Registro <> ''' + TranneRegistro.Text + '''');
  if SoloStato.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'Doc.StatoDescrizione = ''' + SoloStato.Text + '''');
  if Causale.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'Doc.Causale = ''' + Causale.Text + '''');
  if DocOperatore.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'Doc.Operatore = ''' + DocOperatore.Text + '''');
  // In base al tipo di data selezionata filtra...
  if FilterDocTipoData.Text = 'Data documento' then
  begin
    if DM1.ControllaDataStr(DateEditDa.EditText) then
      DM1.AddSQL(Q, 'AND', 'Doc.DataDocumento >= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(Trim(DateEditDa.EditText))) + '''');
    if DM1.ControllaDataStr(DateEditA.EditText) then
      DM1.AddSQL(Q, 'AND', 'Doc.DataDocumento <= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(Trim(DateEditA.EditText))) + '''');
  end
  else if FilterDocTipoData.Text = 'Consegna' then
  begin
    if DM1.ControllaDataStr(DateEditDa.EditText) then
      DM1.AddSQL(Q, 'AND', 'Doc.ConsegnaData >= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(Trim(DateEditDa.EditText))) + '''');
    if DM1.ControllaDataStr(DateEditA.EditText) then
      DM1.AddSQL(Q, 'AND', 'Doc.ConsegnaData <= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(Trim(DateEditA.EditText))) + '''');
  end
  else if FilterDocTipoData.Text = 'Scadenza validit' then
  begin
    if DM1.ControllaDataStr(DateEditDa.EditText) then
      DM1.AddSQL(Q, 'AND', 'Doc.ValiditaData >= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(Trim(DateEditDa.EditText))) + '''');
    if DM1.ControllaDataStr(DateEditA.EditText) then
      DM1.AddSQL(Q, 'AND', 'Doc.ValiditaData <= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(Trim(DateEditA.EditText))) + '''');
  end;
  if FilterTesto.Text <> '' then
  begin
    DM1.AddSQL(Q, 'AND', '(');
    DM1.AggiungiRicercaCampo(Q.SQL, 'Doc.RagSocCli', FilterTesto.Text, False);
    Q.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(Q.SQL, 'Doc.RagSocDestMerci', FilterTesto.Text, False);
    Q.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(Q.SQL, 'Doc.RIFSOGG1_RAGIONESOCIALE', FilterTesto.Text, False);
    Q.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(Q.SQL, 'Doc.RIFSOGG2_RAGIONESOCIALE', FilterTesto.Text, False);
    Q.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(Q.SQL, 'Doc.RIFSOGG3_RAGIONESOCIALE', FilterTesto.Text, False);
    Q.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(Q.SQL, 'Doc.RIFSOGG4_RAGIONESOCIALE', FilterTesto.Text, False);
    Q.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(Q.SQL, 'Doc.RIFSOGG5_RAGIONESOCIALE', FilterTesto.Text, False);
    Q.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(Q.SQL, 'Doc.RIFSOGG6_RAGIONESOCIALE', FilterTesto.Text, False);
    Q.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(Q.SQL, 'Doc.Note', FilterTesto.Text, False);
    Q.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(Q.SQL, 'Doc.Messaggi', FilterTesto.Text, False);
    Q.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(Q.SQL, 'Doc.Argomento', FilterTesto.Text, False);
    Q.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(Q.SQL, 'Doc.Operatore', FilterTesto.Text, False);
    Q.SQL.Add(')');
  end;
  // Base alla volont di voler visualizzare solo quelli che fanno parte di un impianto oppure solo
  // quelli che NON fanno parte di un impianto oppure entrambi.
  // NB: Se sono entrambi selezionati non fa nulla perch tanto deve visualizzarli tutti
  if not(DocConCantiere.Checked[0] and DocConCantiere.Checked[1]) then
  begin
    if DocConCantiere.Checked[0] then
    begin
      Q.SQL.Add('AND (SELECT FIRST 1 P.TIPO FROM PRATICHE P WHERE P.CODICE = DOC.PRATICA AND P.DATAAPERTURA = DOC.DATAPRATICA1) = ''A''');
    end;
    if DocConCantiere.Checked[1] then
    begin
      Q.SQL.Add('AND (');
      Q.SQL.Add('  (DOC.PRATICA IS NULL    OR   DOC.PRATICA = 0)');
      Q.SQL.Add('  OR (SELECT FIRST 1 P.TIPO FROM PRATICHE P WHERE P.CODICE = DOC.PRATICA AND P.DATAAPERTURA = DOC.DATAPRATICA1) <> ''A''');
      Q.SQL.Add(')');
    end;
  end;
  // --------------------
  Operatore := '';
  Linea := '';
  if DocIsChecked(IDX_VEND_PREVENTIVI) then
  begin
    Linea := Linea + Operatore + 'Doc.TipoDocumento = ''Preventivo''';
    Operatore := ' OR ';
  end;
  if DocIsChecked(IDX_VEND_ORDINI) then
  begin
    Linea := Linea + Operatore + 'Doc.TipoDocumento = ''Ordine''';
    Operatore := ' OR ';
  end;
  if DocIsChecked(IDX_VEND_SAL) then
  begin
    Linea := Linea + Operatore + 'Doc.TipoDocumento = ''S.A.L.''';
    Operatore := ' OR ';
  end;
  if DocIsChecked(IDX_VEND_BUONICONSEGNA) then
  begin
    Linea := Linea + Operatore + 'Doc.TipoDocumento = ''Buono_cons''';
    Operatore := ' OR ';
  end;
  if DocIsChecked(IDX_VEND_DDT) then
  begin
    Linea := Linea + Operatore + 'Doc.TipoDocumento = ''D.D.T.''';
    Operatore := ' OR ';
  end;
  if DocIsChecked(IDX_VEND_FATTURE) then
  begin
    Linea := Linea + Operatore + 'Doc.TipoDocumento = ''Fattura''';
    Operatore := ' OR ';
  end;
  if DocIsChecked(IDX_VEND_RICEVUTEFISCALI) then
  begin
    Linea := Linea + Operatore + 'Doc.TipoDocumento = ''Ricev.fisc''';
    Operatore := ' OR ';
  end;
  if DocIsChecked(IDX_VEND_FATTURERICEVUTEFISCALI) then
  begin
    Linea := Linea + Operatore + 'Doc.TipoDocumento = ''Fatt.R.F.''';
    Operatore := ' OR ';
  end;
  if DocIsChecked(IDX_VEND_NOTEDICREDITO) then
  begin
    Linea := Linea + Operatore + 'Doc.TipoDocumento = ''Nota_accre''';
    Operatore := ' OR ';
  end;
  if DocIsChecked(IDX_VEND_COMMESSA) then
  begin
    Linea := Linea + Operatore + 'Doc.TipoDocumento = ''Commessa''';
    Operatore := ' OR ';
  end;
  if DocIsChecked(IDX_VEND_CARICOCANTIERE) then
  begin
    Linea := Linea + Operatore + 'Doc.TipoDocumento = ''Carico_cantiere''';
    Operatore := ' OR ';
  end;
  if DocIsChecked(IDX_VEND_SCARICOCANTIERE) then
  begin
    Linea := Linea + Operatore + 'Doc.TipoDocumento = ''Scarico_cantiere''';
    Operatore := ' OR ';
  end;
  if DocIsChecked(IDX_VEND_CONTO) then
  begin
    Linea := Linea + Operatore + 'Doc.TipoDocumento = ''Estratto_conto''';
    Operatore := ' OR ';
  end;
  if DocIsChecked(IDX_VEND_INTERVENTO) then
  begin
    Linea := Linea + Operatore + 'Doc.TipoDocumento = ''Intervento''';
    Operatore := ' OR ';
  end;
  if DocIsChecked(IDX_ACQ_ORDINIFORNITORI) then
  begin
    Linea := Linea + Operatore + 'Doc.TipoDocumento = ''Ord.fornit''';
    Operatore := ' OR ';
  end;
  if DocIsChecked(IDX_ACQ_BOLLEENTRATA) then
  begin
    Linea := Linea + Operatore + 'Doc.TipoDocumento = ''Bolla_entr''';
    Operatore := ' OR ';
  end;
  if DocIsChecked(IDX_ACQ_FATTUREACQUISTO) then
  begin
    Linea := Linea + Operatore + 'Doc.TipoDocumento = ''Fatt.acqui''';
    Operatore := ' OR ';
  end;
  if DocIsChecked(IDX_ACQ_NOTEDICREDITO_FORNITORI) then
  begin
    Linea := Linea + Operatore + 'Doc.TipoDocumento = ''N.C.fornit''';
    Operatore := ' OR ';
  end;
  if Length(Linea) > 0 then
    DM1.AddSQL(Q, 'AND', '(' + Linea + ')');
  // --------------------
  // Condizione in base al tipo di soggetto
  if SoloTipoSoggetto.Text <> '' then
    Q.SQL.Add(' AND Cli.CLIENTEFORNITORE = ''' + SoloTipoSoggetto.Text + '''');

  // Agente
  if DocAgente.Text <> '' then
    Q.SQL.Add('AND Doc.Agente = ''' + DocAgente.Text + '''');
  if DocAgente2.Text <> '' then
    Q.SQL.Add('AND Doc.Agente2 = ''' + DocAgente2.Text + '''');
  if DocAgente3.Text <> '' then
    Q.SQL.Add('AND Doc.Agente3 = ''' + DocAgente3.Text + '''');
  if DocAgente4.Text <> '' then
    Q.SQL.Add('AND Doc.Agente4 = ''' + DocAgente4.Text + '''');

  // Categorie cantieri
  if DocCategCant1.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'PRAT.CATEGCANT1 = ''' + DocCategCant1.Text + '''');
  if DocCategCant2.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'PRAT.CATEGCANT2 = ''' + DocCategCant2.Text + '''');
  if DocCategCant3.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'PRAT.CATEGCANT3 = ''' + DocCategCant3.Text + '''');
  if DocCategCant4.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'PRAT.CATEGCANT4 = ''' + DocCategCant4.Text + '''');
  if DocCategCant5.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'PRAT.CATEGCANT5 = ''' + DocCategCant5.Text + '''');
  if DocCategCant6.Text <> '' then
    DM1.AddSQL(Q, 'AND', 'PRAT.CATEGCANT6 = ''' + DocCategCant6.Text + '''');
end;

procedure TClientiForm.CheckForUnionAll(QryDoc: TIBOQuery);
begin
  if QryDoc.SQL.Count > 0 then
  begin
    QryDoc.SQL.Add(' ');
    QryDoc.SQL.Add(' ');
    QryDoc.SQL.Add(' ');
    QryDoc.SQL.Add('UNION ALL');
    QryDoc.SQL.Add(' ');
    QryDoc.SQL.Add(' ');
    QryDoc.SQL.Add(' ');
  end;
end;

procedure TClientiForm.EseguiQueryTesti(QryDoc: TIBOQuery);
begin
  // Prima di tutto se la query non  vuota significa che c' una SELECT precedente
  // e quindi aggiunge l'UNION ALL
  CheckForUnionAll(QryDoc);
  // Costruisce la query SELECT per il reperimento dei dati
  // NB: LA QUERY SELECT DEVE RICOSTRUIRE IL TRACCIATO DELLA TABELLA 'DOCSEL' PERCHE'
  // DA QUANDO HO ELIMINATO L'USO DELLA TABELLA 'DOCSEL' PRATICAMENTE QUESTA PROCEDURA COSTRUISCE
  // UNA STRINGLIST CONTENENTE LA QUERY CHE POI VERRA' UNITA ALLE ALTRE QUERY PER COSTRUIRE IL
  // RISULTATO DELL'INTERROGAZIONE SU DIVERSI TIPI DI DOCUMENTO, QUINDI SE NON PASSO PIU' PER LA TABELLA
  // 'DOCSEL' MI DEVO ASSICURARE CHE TUTTE LE QUERY CHE VENGONO UNITE CON LA UNION RESTITUISCANO LO STESSO
  // IDENTICO TRACCIATO.
  // QUINDI E' IMPORTANTE MANTENERE IL TRACCIATO DELLA TABELLA 'DOCSEL' AGGIORNATO ANCHE SE NON VIENE PIU'
  // USATO IN MODO CHE FACCIA DA TRACCIA.
  QryDoc.SQL.Add('SELECT');
  QryDoc.SQL.Add('CAST(' + DM1.CodiceUtente + ' AS INTEGER) AS STATION_ID');
  QryDoc.SQL.Add(',CAST(''Lettera'' AS VARCHAR(20)) AS TIPODOC');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(5)) AS REGISTRO');
  QryDoc.SQL.Add(',CAST(Doc.Codice AS INTEGER) AS CODICEDOC');
  QryDoc.SQL.Add(',CAST(Doc.Data AS TIMESTAMP) AS DATADOC');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS OGGETTOJOLLY1');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS OGGETTOJOLLY2');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS OGGETTOJOLLY3');
  QryDoc.SQL.Add(',CAST(NULL AS DECIMAL(15,4)) AS IMPORTO');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS NOTEJOLLY1');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS NOTEJOLLY2');
  QryDoc.SQL.Add(',CAST(Cli.RagioneSociale || ''  ('' || Doc.Cliente || '')'' AS VARCHAR(80)) AS CLIENTEFORNITORE');
  QryDoc.SQL.Add(',CAST(Doc.Oggetto AS VARCHAR(200)) AS OGGETTO');
  QryDoc.SQL.Add(',CAST(Doc.Note AS VARCHAR(200)) AS NOTE');
  QryDoc.SQL.Add(',CAST(Doc.StatoDescrizione AS VARCHAR(10)) AS STATODESCRIZIONE');
  QryDoc.SQL.Add(',CAST(Doc.StatoForeground AS VARCHAR(10)) AS STATOFOREGROUND');
  QryDoc.SQL.Add(',CAST(Doc.StatoBackground AS VARCHAR(10)) AS STATOBACKGROUND');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(1)) AS SELEZIONATO');
  QryDoc.SQL.Add(',CAST(Doc.Provenienza AS VARCHAR(200)) AS PROVENIENZA');
  QryDoc.SQL.Add(',CAST(Doc.Argomento AS VARCHAR(200)) AS ARGOMENTO');
  QryDoc.SQL.Add(',CAST(NULL AS DECIMAL(15,4)) AS IMPONIBILE');
  QryDoc.SQL.Add(',CAST(NULL AS DECIMAL(15,4)) AS IMPORTOIVA');
  QryDoc.SQL.Add(',CAST(Doc.Cliente AS INTEGER) AS CODICESOGGETTO');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(8)) AS ORADOC');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(1)) AS DAFATTURARE');
  QryDoc.SQL.Add
    (',CAST((SELECT Prat.Descrizione FROM Pratiche Prat WHERE Prat.Codice=Doc.Pratica AND Prat.DataApertura=Doc.DataPratica1) || ''  ('' || DOC.PRATICA || '', '' || DOC.DATAPRATICA1 || '')'' AS VARCHAR(80)) AS RIFPRATICA');
  QryDoc.SQL.Add(',CAST(NULL AS TIMESTAMP) AS VALIDITADATA');
  QryDoc.SQL.Add(',CAST(NULL AS TIMESTAMP) AS CONSEGNADATA');
  QryDoc.SQL.Add(',CAST(NULL AS CHAR(1)) AS CONSEGNATO');
  QryDoc.SQL.Add(',CAST(NULL AS VARCHAR(15)) AS CAUSALE');
  QryDoc.SQL.Add(',CAST(NULL AS VARCHAR(15)) AS CAUSALECANTIERE');
  QryDoc.SQL.Add(',CAST(NULL AS DECIMAL(15,4)) AS RITENUTAACCONTO');
  QryDoc.SQL.Add(',CAST(Cli.ClienteFornitore AS VARCHAR(10)) AS TIPOSOGGETTO');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(10)) AS OPERATORE');
  QryDoc.SQL.Add('FROM Testi Doc');
  QryDoc.SQL.Add('LEFT JOIN CLIENTI CLI ON (CLI.CODICE = DOC.CLIENTE)');
  // Aggiunge una clausola WHERE finta in modo che non dia errore se non viene specificata nessuna condizione
  QryDoc.SQL.Add('WHERE 1=1');
  if PraticaCorrente <> '' then
  begin
    DM1.AddSQL(QryDoc, 'AND', '((Doc.Pratica = ' + PraticaCorrente + ') OR (Doc.Pratica2 = ' + PraticaCorrente + ') OR (Doc.Pratica3 = ' +
      PraticaCorrente + '))');
  end
  else
  begin
    if ClienteCorrente <> '' then
      DM1.AddSQL(QryDoc, 'AND', 'Doc.Cliente = ' + ClienteCorrente);
  end;
  if DM1.ControllaDataStr(DateEditDa.EditText) then
    DM1.AddSQL(QryDoc, 'AND', 'Doc.Data >= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(DateEditDa.EditText)) + '''');
  if DM1.ControllaDataStr(DateEditA.EditText) then
    DM1.AddSQL(QryDoc, 'AND', 'Doc.Data <= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(DateEditA.EditText)) + '''');
  if FilterTesto.Text <> '' then
  begin
    DM1.AddSQL(QryDoc, 'AND', '(');
    DM1.AggiungiRicercaCampo(QryDoc.SQL, 'Doc.Oggetto', FilterTesto.Text, False);
    QryDoc.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryDoc.SQL, 'Doc.Note', FilterTesto.Text, False);
    QryDoc.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryDoc.SQL, 'Doc.Provenienza', FilterTesto.Text, False);
    QryDoc.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryDoc.SQL, 'Doc.Argomento', FilterTesto.Text, False);
    QryDoc.SQL.Add(')');
  end;
end;

procedure TClientiForm.EseguiQueryTracciati;
var
  Qry: TIB_Cursor;
begin
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('INSERT');
    Qry.SQL.Add
      ('INTO DocSel (STAION_ID, TipoDoc, Registro, CodiceDoc, DataDoc, Oggetto, Argomento, Provenienza, ClienteFornitore, Note, StatoDescrizione, StatoForeground, StatoBackground, CodiceSoggetto)');
    Qry.SQL.Add('SELECT ' + DM1.CodiceUtente +
      ', ''Tracciato'', '''', T.Codice, T.Data, T.Oggetto, T.Argomento, T.Provenienza, Cli.RagioneSociale, T.Note, T.StatoDescrizione, T.StatoForeground, T.StatoBackground, T.Cliente');
    Qry.SQL.Add('FROM Tracc T, Clienti Cli');

    if PraticaCorrente <> '' then
    begin
      DM1.AddSQLToIB_Cursor(Qry, 'AND', '((T.Pratica = ' + PraticaCorrente + ') OR (T.Pratica2 = ' + PraticaCorrente + ') OR (T.Pratica3 = ' +
        PraticaCorrente + '))');
    end
    else
    begin
      if ClienteCorrente <> '' then
        DM1.AddSQLToIB_Cursor(Qry, 'AND', 'T.Cliente = ' + ClienteCorrente);
    end;
    if DM1.ControllaDataStr(DateEditDa.EditText) then
      DM1.AddSQLToIB_Cursor(Qry, 'AND', 'T.Data >= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(DateEditDa.EditText)) + '''');
    if DM1.ControllaDataStr(DateEditA.EditText) then
      DM1.AddSQLToIB_Cursor(Qry, 'AND', 'T.Data <= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(DateEditA.EditText)) + '''');
    DM1.AddSQLToIB_Cursor(Qry, 'AND', 'Cli.Codice = T.Cliente');
    Qry.ExecSQL;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.EseguiQueryContatti;
var
  Operatore, Linea: String;
  Qry: TIB_Cursor;
begin
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('INSERT');
    Qry.SQL.Add
      ('INTO DocSel (STATION_ID, TipoDoc, Registro, CodiceDoc, DataDoc, OraDoc, Oggetto, Argomento, Provenienza, ClienteFornitore, StatoDescrizione, StatoForeground, StatoBackground, CodiceSoggetto)');
    Qry.SQL.Add('SELECT ' + DM1.CodiceUtente +
      ', Cont.Tipo, '''', Cont.Codice, Cont.Data, Cont.Ora, Cont.Oggetto, Cont.Argomento, Cont.Provenienza, Cli.RagioneSociale, Cont.StatoDescrizione, Cont.StatoForeground, Cont.StatoBackground, Cont.Cliente');
    Qry.SQL.Add('FROM Contatti Cont');
    Qry.SQL.Add('LEFT JOIN CLIENTI CLI ON (CLI.CODICE = CONT.CLIENTE)');

    if PraticaCorrente <> '' then
    begin
      DM1.AddSQLToIB_Cursor(Qry, 'AND', '((Cont.Pratica = ' + PraticaCorrente + ') OR (Cont.Pratica2 = ' + PraticaCorrente + ') OR (Cont.Pratica3 = ' +
        PraticaCorrente + '))');
    end
    else
    begin
      if ClienteCorrente <> '' then
        DM1.AddSQLToIB_Cursor(Qry, 'AND', 'Cont.Cliente = ' + ClienteCorrente);
    end;
    if DM1.ControllaDataStr(DateEditDa.EditText) then
      DM1.AddSQLToIB_Cursor(Qry, 'AND', 'Cont.Data >= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(DateEditDa.EditText)) + '''');
    if DM1.ControllaDataStr(DateEditA.EditText) then
      DM1.AddSQLToIB_Cursor(Qry, 'AND', 'Cont.Data <= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(DateEditA.EditText)) + '''');
    // -------------------
    Operatore := '';
    Linea := '';
    // if SBContatti.Down then begin
    // Linea := Linea + Operatore + 'UPPER(Cont.Tipo) = ''CONT.FARE''';
    // Operatore := ' OR ';
    // end;
    // if SBContattiFatti.Down then begin
    // Linea := Linea + Operatore + 'UPPER(Cont.Tipo) = ''CONT.FATTO''';
    // Operatore := ' OR ';
    // end;
    // if Length(Linea) > 0 then DM1.AddSQLToIB_Cursor(Qry, 'AND', '('+Linea+')');
    // -------------------

    Qry.ExecSQL;

  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.EseguiQueryExtFile(QryDoc: TIBOQuery);
begin
  // Prima di tutto se la query non  vuota significa che c' una SELECT precedente
  // e quindi aggiunge l'UNION ALL
  CheckForUnionAll(QryDoc);
  // Costruisce la query SELECT per il reperimento dei dati
  // NB: LA QUERY SELECT DEVE RICOSTRUIRE IL TRACCIATO DELLA TABELLA 'DOCSEL' PERCHE'
  // DA QUANDO HO ELIMINATO L'USO DELLA TABELLA 'DOCSEL' PRATICAMENTE QUESTA PROCEDURA COSTRUISCE
  // UNA STRINGLIST CONTENENTE LA QUERY CHE POI VERRA' UNITA ALLE ALTRE QUERY PER COSTRUIRE IL
  // RISULTATO DELL'INTERROGAZIONE SU DIVERSI TIPI DI DOCUMENTO, QUINDI SE NON PASSO PIU' PER LA TABELLA
  // 'DOCSEL' MI DEVO ASSICURARE CHE TUTTE LE QUERY CHE VENGONO UNITE CON LA UNION RESTITUISCANO LO STESSO
  // IDENTICO TRACCIATO.
  // QUINDI E' IMPORTANTE MANTENERE IL TRACCIATO DELLA TABELLA 'DOCSEL' AGGIORNATO ANCHE SE NON VIENE PIU'
  // USATO IN MODO CHE FACCIA DA TRACCIA.
  QryDoc.SQL.Add('SELECT');
  QryDoc.SQL.Add('CAST(' + DM1.CodiceUtente + ' AS INTEGER) AS STATION_ID');
  QryDoc.SQL.Add(',CAST(''Doc.esterno'' AS VARCHAR(20)) AS TIPODOC');
  QryDoc.SQL.Add(',CAST(Doc.Registro AS VARCHAR(5)) AS REGISTRO');
  QryDoc.SQL.Add(',CAST(Doc.Codice AS INTEGER) AS CODICEDOC');
  QryDoc.SQL.Add(',CAST(Doc.Data AS TIMESTAMP) AS DATADOC');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS OGGETTOJOLLY1');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS OGGETTOJOLLY2');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS OGGETTOJOLLY3');
  QryDoc.SQL.Add(',CAST(NULL AS DECIMAL(15,4)) AS IMPORTO');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS NOTEJOLLY1');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS NOTEJOLLY2');
  QryDoc.SQL.Add(',CAST(Cli.RagioneSociale || ''  ('' || Doc.Cliente || '')'' AS VARCHAR(80)) AS CLIENTEFORNITORE');
  QryDoc.SQL.Add(',CAST(Doc.Oggetto AS VARCHAR(200)) AS OGGETTO');
  QryDoc.SQL.Add(',CAST(Doc.Note AS VARCHAR(200)) AS NOTE');
  QryDoc.SQL.Add(',CAST(Doc.StatoDescrizione AS VARCHAR(10)) AS STATODESCRIZIONE');
  QryDoc.SQL.Add(',CAST(Doc.StatoForeground AS VARCHAR(10)) AS STATOFOREGROUND');
  QryDoc.SQL.Add(',CAST(Doc.StatoBackground AS VARCHAR(10)) AS STATOBACKGROUND');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(1)) AS SELEZIONATO');
  QryDoc.SQL.Add(',CAST(Doc.Provenienza AS VARCHAR(200)) AS PROVENIENZA');
  QryDoc.SQL.Add(',CAST(Doc.Argomento AS VARCHAR(200)) AS ARGOMENTO');
  QryDoc.SQL.Add(',CAST(NULL AS DECIMAL(15,4)) AS IMPONIBILE');
  QryDoc.SQL.Add(',CAST(NULL AS DECIMAL(15,4)) AS IMPORTOIVA');
  QryDoc.SQL.Add(',CAST(Doc.Cliente AS INTEGER) AS CODICESOGGETTO');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(8)) AS ORADOC');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(1)) AS DAFATTURARE');
  QryDoc.SQL.Add
    (',CAST((SELECT Prat.Descrizione FROM Pratiche Prat WHERE Prat.Codice=Doc.Pratica AND Prat.DataApertura=Doc.DataPratica1) || ''  ('' || DOC.PRATICA || '', '' || DOC.DATAPRATICA1 || '')'' AS VARCHAR(80)) AS RIFPRATICA');
  QryDoc.SQL.Add(',CAST(NULL AS TIMESTAMP) AS VALIDITADATA');
  QryDoc.SQL.Add(',CAST(NULL AS TIMESTAMP) AS CONSEGNADATA');
  QryDoc.SQL.Add(',CAST(NULL AS CHAR(1)) AS CONSEGNATO');
  QryDoc.SQL.Add(',CAST(NULL AS VARCHAR(15)) AS CAUSALE');
  QryDoc.SQL.Add(',CAST(NULL AS VARCHAR(15)) AS CAUSALECANTIERE');
  QryDoc.SQL.Add(',CAST(NULL AS DECIMAL(15,4)) AS RITENUTAACCONTO');
  QryDoc.SQL.Add(',CAST(Cli.ClienteFornitore AS VARCHAR(10)) AS TIPOSOGGETTO');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(10)) AS OPERATORE');
  QryDoc.SQL.Add('FROM ExtFile Doc');
  QryDoc.SQL.Add('LEFT JOIN CLIENTI CLI ON (CLI.CODICE = DOC.CLIENTE)');
  // Aggiunge una clausola WHERE finta in modo che non dia errore se non viene specificata nessuna condizione
  QryDoc.SQL.Add('WHERE 1=1');
  if PraticaCorrente <> '' then
  begin
    DM1.AddSQL(QryDoc, 'AND', '((Doc.Pratica = ' + PraticaCorrente + ') OR (Doc.Pratica2 = ' + PraticaCorrente + ') OR (Doc.Pratica3 = ' +
      PraticaCorrente + '))');
  end
  else
  begin
    if ClienteCorrente <> '' then
      DM1.AddSQL(QryDoc, 'AND', 'Doc.Cliente = ' + ClienteCorrente);
  end;
  if DM1.ControllaDataStr(DateEditDa.EditText) then
    DM1.AddSQL(QryDoc, 'AND', 'Doc.Data >= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(DateEditDa.EditText)) + '''');
  if DM1.ControllaDataStr(DateEditA.EditText) then
    DM1.AddSQL(QryDoc, 'AND', 'Doc.Data <= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(DateEditA.EditText)) + '''');

  if FilterNumDoc.Text <> '' then
    DM1.AddSQL(QryDoc, 'AND', 'Doc.Codice = ' + FilterNumDoc.Text);
  if SoloRegistro.Text <> '' then
    DM1.AddSQL(QryDoc, 'AND', 'Doc.Registro = ''' + SoloRegistro.Text + '''');
  if TranneRegistro.Text <> '' then
    DM1.AddSQL(QryDoc, 'AND', 'Doc.Registro <> ''' + TranneRegistro.Text + '''');
  if SoloStato.Text <> '' then
    DM1.AddSQL(QryDoc, 'AND', 'Doc.StatoDescrizione = ''' + SoloStato.Text + '''');

  if FilterTesto.Text <> '' then
  begin
    DM1.AddSQL(QryDoc, 'AND', '(');
    DM1.AggiungiRicercaCampo(QryDoc.SQL, 'Doc.Oggetto', FilterTesto.Text, False);
    QryDoc.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryDoc.SQL, 'Doc.Note', FilterTesto.Text, False);
    QryDoc.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryDoc.SQL, 'Doc.Provenienza', FilterTesto.Text, False);
    QryDoc.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryDoc.SQL, 'Doc.Argomento', FilterTesto.Text, False);
    QryDoc.SQL.Add(')');
  end;
end;

procedure TClientiForm.EseguiQueryPratiche;
begin
  // Se non  checkato ne i cantieri aperti ne chiusi li richecca automaticamente tutti e due
  // altrimenti non troverebbe nulla
  if not(CantieriApertiChiusi.Checked[0] or CantieriApertiChiusi.Checked[1]) then
  begin
    CantieriApertiChiusi.Checked[0] := True;
    CantieriApertiChiusi.Checked[1] := True;
  end;
  // Compone la query
  QryPratiche.Close;
  QryPratiche.SQL.Clear;
  QryPratiche.SQL.Add('SELECT P.* FROM PRAT_LIST_VIEW P');
  // Aggiunge una clausola WHERE finta in modo che non dia errore se non viene specificata nessuna condizione
  QryPratiche.SQL.Add('WHERE');
  QryPratiche.SQL.Add('P.TIPO = ''P''');

  // Tutte le pratiche del cliente come primo intestatario e compunque anche quelle dove compare come
  // altro soggetto.
  // NB: Se siamo in FastSelectionMode non deve essere filtrato per l'eventuale soggetto selezionato corrente
  if (not DM1.FastSelectionMode) and (ClienteCorrente <> '') then
    DM1.AddSQL(QryPratiche, 'AND', '(P.CLIENTE = ' + ClienteCorrente + ' OR P.ALTRISOGGETTI LIKE ''%<' + ClienteCorrente + '>%'')');

  if PratCodice.Text <> '' then
    DM1.AddSQL(QryPratiche, 'AND', 'P.CODICE = ' + PratCodice.Text);
  if PratStato.Text <> '' then
    DM1.AddSQL(QryPratiche, 'AND', 'P.STATODESCRIZIONE = ''' + PratStato.Text + '''');
  if PratDescrizione.Text <> '' then
  begin
    DM1.AddSQL(QryPratiche, 'AND', '(');
    DM1.AggiungiRicercaCampo(QryPratiche.SQL, 'P.DESCRIZIONE', PratDescrizione.Text, False);
    QryPratiche.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryPratiche.SQL, 'P.NOME', PratDescrizione.Text, False);
    QryPratiche.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryPratiche.SQL, 'P.NOTE', PratDescrizione.Text, False);
    QryPratiche.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryPratiche.SQL, 'P.RAGSOC', PratDescrizione.Text, False);
    QryPratiche.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryPratiche.SQL, 'P.COMMITDENOMINAZIONE', PratDescrizione.Text, False);
    QryPratiche.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryPratiche.SQL, 'P.PROPDENOMINAZIONE', PratDescrizione.Text, False);
    QryPratiche.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryPratiche.SQL, 'P.IMMOBLOCALITA', PratDescrizione.Text, False);
    QryPratiche.SQL.Add(')');
  end;
  if not CantieriApertiChiusi.Checked[0] then
    QryPratiche.SQL.Add('AND NOT P.DATACHIUSURA IS NULL');
  if not CantieriApertiChiusi.Checked[1] then
    QryPratiche.SQL.Add('AND P.DATACHIUSURA IS NULL');
  if DM1.ControllaDataStr(PratDal.EditText) then
    DM1.AddSQL(QryPratiche, 'AND', 'P.DATAAPERTURA >= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(PratDal.EditText)) + '''');
  if DM1.ControllaDataStr(PratAl.EditText) then
    DM1.AddSQL(QryPratiche, 'AND', 'P.DATAAPERTURA <= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(PratAl.EditText)) + '''');
  // Categorie cantieri
  if PratCategCant1.Text <> '' then
    DM1.AddSQL(QryPratiche, 'AND', 'P.CATEGCANT1 = ''' + PratCategCant1.Text + '''');
  if PratCategCant2.Text <> '' then
    DM1.AddSQL(QryPratiche, 'AND', 'P.CATEGCANT2 = ''' + PratCategCant2.Text + '''');
  if PratCategCant3.Text <> '' then
    DM1.AddSQL(QryPratiche, 'AND', 'P.CATEGCANT3 = ''' + PratCategCant3.Text + '''');
  if PratCategCant4.Text <> '' then
    DM1.AddSQL(QryPratiche, 'AND', 'P.CATEGCANT4 = ''' + PratCategCant4.Text + '''');
  if PratCategCant5.Text <> '' then
    DM1.AddSQL(QryPratiche, 'AND', 'P.CATEGCANT5 = ''' + PratCategCant5.Text + '''');
  if PratCategCant6.Text <> '' then
    DM1.AddSQL(QryPratiche, 'AND', 'P.CATEGCANT6 = ''' + PratCategCant6.Text + '''');
  // Agenti
  if PratAgente.Text <> '' then
    DM1.AddSQL(QryPratiche, 'AND', 'P.AGENTE  = ''' + PratAgente.Text + '''');
  if PratAgente2.Text <> '' then
    DM1.AddSQL(QryPratiche, 'AND', 'P.AGENTE2 = ''' + PratAgente2.Text + '''');
  if PratAgente3.Text <> '' then
    DM1.AddSQL(QryPratiche, 'AND', 'P.AGENTE3 = ''' + PratAgente3.Text + '''');
  if PratAgente4.Text <> '' then
    DM1.AddSQL(QryPratiche, 'AND', 'P.AGENTE4 = ''' + PratAgente4.Text + '''');
  // Aggiunge alla query l'ORDER BY
  // QryPratiche.SQL.Add(DM1.GeneraOrderBy(tvPrat));
  QryPratiche.Open;
  // Si posizione all'inizio
  tvPrat.DataController.GotoFirst;
end;

procedure TClientiForm.EseguiQueryImpegni;
var
  CodeToOpen: Integer;
begin
  // Se i check di alcuni gruppi di filtri sono tutti NON CHECCKATI li checcka automaticamente tutti
  // perch altrimenti non visualizzerebbe nulla
  if not(ImpTipoIMpegno.Checked[0] or ImpTipoIMpegno.Checked[1] or ImpTipoIMpegno.Checked[2]) then
  begin
    ImpTipoIMpegno.Checked[0] := True;
    ImpTipoIMpegno.Checked[1] := True;
    ImpTipoIMpegno.Checked[2] := True;
  end;
  if not(ImpTipoIntervento.Checked[0] or ImpTipoIntervento.Checked[1] or ImpTipoIntervento.Checked[2] or ImpTipoIntervento.Checked[3]) then
  begin
    ImpTipoIntervento.Checked[0] := False;
    ImpTipoIntervento.Checked[1] := False;
    ImpTipoIntervento.Checked[2] := False;
    ImpTipoIntervento.Checked[3] := False;
  end;
  // Creazione query di ricerca
  QryImp.Close;
  QryImp.SQL.Clear;
  QryImp.SQL.Add('SELECT I.* FROM IMPEGNI_LIST_VIEW I');

  // Aggiunge una clausola WHERE finta in modo che non dia errore se non viene specificata nessuna condizione
  QryImp.SQL.Add('WHERE');
  QryImp.SQL.Add('1 = 1');

  // Se c' una pratica selezionata...
  if PraticaCorrente <> '' then
  begin
    QryImp.SQL.Add('AND I.Pratica = ' + PraticaCorrente + ' AND I.DataPratica1 = ' + QuotedStr(DataPraticaCorrenteSQL));
    // Oppure se c' un soggetto selezionato....
  end
  else
  begin
    if ClienteCorrente <> '' then
      QryImp.SQL.Add('AND I.CLIENTE = ' + ClienteCorrente);
  end;

  // Base alla volont di voler visualizzare solo quelli che fanno parte di un impianto oppure solo
  // quelli che NON fanno parte di un impianto oppure entrambi.
  // NB: Se sono entrambi selezionati non fa nulla perch tanto deve visualizzarli tutti
  if not(ImpConCantiere.Checked[0] and ImpConCantiere.Checked[1]) then
  begin
    if ImpConCantiere.Checked[0] then
    begin
      QryImp.SQL.Add('AND (SELECT FIRST 1 P.TIPO FROM PRATICHE P WHERE P.CODICE = I.PRATICA AND P.DATAAPERTURA = I.DATAPRATICA1) = ''A''');
    end;
    if ImpConCantiere.Checked[1] then
    begin
      QryImp.SQL.Add('AND (');
      QryImp.SQL.Add('  (I.PRATICA IS NULL    OR   I.PRATICA = 0)');
      QryImp.SQL.Add('  OR (SELECT FIRST 1 P.TIPO FROM PRATICHE P WHERE P.CODICE = I.PRATICA AND P.DATAAPERTURA = I.DATAPRATICA1) <> ''A''');
      QryImp.SQL.Add(')');
    end;
  end;
  // In base ai tipi di impegno selezionati
  if ImpTipoIMpegno.Visible then
  begin
    if not ImpTipoIMpegno.Checked[0] then
      QryImp.SQL.Add('AND I.TIPOIMPEGNO <> ''Chiamata''');
    if not ImpTipoIMpegno.Checked[1] then
      QryImp.SQL.Add('AND I.TIPOIMPEGNO <> ''Appuntamento''');
    if not ImpTipoIMpegno.Checked[2] then
      QryImp.SQL.Add('AND I.TIPOIMPEGNO <> ''Intervento''');
  end;
  // In base ai tipi di intervento selezionati
  if ImpTipoIntervento.Checked[0] or ImpTipoIntervento.Checked[1] or ImpTipoIntervento.Checked[2] or ImpTipoIntervento.Checked[3] then
  begin
    QryImp.SQL.Add('AND (');
    QryImp.SQL.Add('I.TIPOINTERVENTO = ''XXXYYYZZZ'''); // Ricerca finta per non dover discriminare quando nelle righe successive ci vuole l'OR oppure no
    if ImpTipoIntervento.Checked[0] then
      QryImp.SQL.Add('OR I.TIPOINTERVENTO LIKE ''%Guasto%''');
    if ImpTipoIntervento.Checked[1] then
      QryImp.SQL.Add('OR I.TIPOINTERVENTO LIKE ''%Prima accensione%'' OR I.TIPOINTERVENTO LIKE ''%Collaudo%''');
    if ImpTipoIntervento.Checked[2] then
      QryImp.SQL.Add('OR I.TIPOINTERVENTO LIKE ''%Manutenzione%''');
    if ImpTipoIntervento.Checked[3] then
      QryImp.SQL.Add('OR I.TIPOINTERVENTO LIKE ''%Prova combustione%''');
    QryImp.SQL.Add(')');
  end;
  // Tecnico
  if FilterCodiceTecnico.Text <> '' then
    QryImp.SQL.Add('AND I.RESOURCEID = ''' + FilterCodiceTecnico.Text + '''');
  // Agente
  if ImpAgente.Text <> '' then
    QryImp.SQL.Add('AND I.AGENTE  = ''' + ImpAgente.Text + '''');
  if ImpAgente2.Text <> '' then
    QryImp.SQL.Add('AND I.AGENTE2 = ''' + ImpAgente2.Text + '''');
  if ImpAgente3.Text <> '' then
    QryImp.SQL.Add('AND I.AGENTE3 = ''' + ImpAgente3.Text + '''');
  if ImpAgente4.Text <> '' then
    QryImp.SQL.Add('AND I.AGENTE4 = ''' + ImpAgente4.Text + '''');

  // ==========================================================================
  // SOLO INTERVENTO CON LE SEGUENTI O.P. FATTE
  // --------------------------------------------------------------------------
  if ImpOp1.Text <> '' then
    QryImp.SQL.Add('AND I.TIPOIMPEGNO=''Intervento'' AND EXISTS (SELECT OPI.ID FROM OPIMPEGNO OPI WHERE OPI.IDIMPEGNO=I.ID AND OPI.DESCRIZIONE = ' +
      QuotedStr(RightStr(ImpOp1.Text, Length(ImpOp1.Text) - 4)) + ' AND OPI.EFFETTUATA=''T'')');
  if ImpOp2.Text <> '' then
    QryImp.SQL.Add('AND I.TIPOIMPEGNO=''Intervento'' AND EXISTS (SELECT OPI.ID FROM OPIMPEGNO OPI WHERE OPI.IDIMPEGNO=I.ID AND OPI.DESCRIZIONE = ' +
      QuotedStr(RightStr(ImpOp2.Text, Length(ImpOp2.Text) - 4)) + ' AND OPI.EFFETTUATA=''T'')');
  if ImpOp3.Text <> '' then
    QryImp.SQL.Add('AND I.TIPOIMPEGNO=''Intervento'' AND EXISTS (SELECT OPI.ID FROM OPIMPEGNO OPI WHERE OPI.IDIMPEGNO=I.ID AND OPI.DESCRIZIONE = ' +
      QuotedStr(RightStr(ImpOp3.Text, Length(ImpOp3.Text) - 4)) + ' AND OPI.EFFETTUATA=''T'')');
  // ==========================================================================

  // Date
  // NB: Nella DataAl ho messo il confronyo < invece che <= e con la data indicata dal filtro +1 perch in questi campi
  // c' anche la parte tempo e se lo lasciavo come era e mettevo ad esempio di visualizzare tutto fino
  // al 31/10 non mi visualizzava quelli del 31/10 perch lui intendeva fino all'inizio del giorno 31/10.
  if DM1.ControllaDataStr(ImpDal.EditText) then
  begin
    QryImp.SQL.Add('AND (');
    QryImp.SQL.Add('     (I.TIPOIMPEGNO = ''Chiamata''     AND I.DATAORACHIAMATA >= ' + QuotedStr(FormatDateTime('mm/dd/yyyy',
      StrToDate(ImpDal.EditText))) + ')');
    QryImp.SQL.Add('  OR (I.TIPOIMPEGNO = ''Appuntamento'' AND I.START_EVENT >= ' + QuotedStr(FormatDateTime('mm/dd/yyyy', StrToDate(ImpDal.EditText))) + ')');
    QryImp.SQL.Add('  OR (I.TIPOIMPEGNO = ''Intervento''   AND I.DATAORAINTERVENTO >= ' + QuotedStr(FormatDateTime('mm/dd/yyyy',
      StrToDate(ImpDal.EditText))) + ')');
    QryImp.SQL.Add(')');
  end;
  if DM1.ControllaDataStr(ImpAl.EditText) then
  begin
    QryImp.SQL.Add('AND (');
    QryImp.SQL.Add('     (I.TIPOIMPEGNO = ''Chiamata''     AND I.DATAORACHIAMATA < ' + QuotedStr(FormatDateTime('mm/dd/yyyy',
      StrToDate(ImpAl.EditText) + 1)) + ')');
    QryImp.SQL.Add('  OR (I.TIPOIMPEGNO = ''Appuntamento'' AND I.START_EVENT < ' + QuotedStr(FormatDateTime('mm/dd/yyyy',
      StrToDate(ImpAl.EditText) + 1)) + ')');
    QryImp.SQL.Add('  OR (I.TIPOIMPEGNO = ''Intervento''   AND I.DATAORAINTERVENTO < ' + QuotedStr(FormatDateTime('mm/dd/yyyy',
      StrToDate(ImpAl.EditText) + 1)) + ')');
    QryImp.SQL.Add(')');
  end;

  // Aggiunge la ricerca con campo TROVA
  if Trim(FilterImpTrova.Text) <> '' then
  begin
    DM1.AddSQL(QryImp, 'AND', '(');
    DM1.AggiungiRicercaCampo(QryImp.SQL, 'I.RAGIONESOCIALE', FilterImpTrova.Text, False);
    QryImp.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryImp.SQL, 'I.EVENTMESSAGE', FilterImpTrova.Text, False);
    QryImp.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryImp.SQL, 'I.LOCATION', FilterImpTrova.Text, False);
    QryImp.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryImp.SQL, 'I.RELAZIONEINTERVENTO', FilterImpTrova.Text, False);
    QryImp.SQL.Add(')');
  end;

  // Aggiunge alla query l'ORDER BY
  // NB: DISABILITATA PERCHE' HO MESSO LA GRIGLIA NON IN GRID-MODE ALTRIMENTI NON FUNZIONAVA CORRETTAMENTE L'ORDINAMENTO
  // PER ALCUNE COLONNE CALCOLATE
  // QryImp.SQL.Add(DM1.GeneraOrderBy(tvImpegni));
  QryImp.Open;
  // Si posizione all'inizio
  tvImpegni.DataController.GotoFirst;
end;

procedure TClientiForm.EseguiQueryConformita(QryDoc: TIBOQuery);
begin
  // Prima di tutto se la query non  vuota significa che c' una SELECT precedente
  // e quindi aggiunge l'UNION ALL
  CheckForUnionAll(QryDoc);
  // Costruisce la query SELECT per il reperimento dei dati
  // NB: LA QUERY SELECT DEVE RICOSTRUIRE IL TRACCIATO DELLA TABELLA 'DOCSEL' PERCHE'
  // DA QUANDO HO ELIMINATO L'USO DELLA TABELLA 'DOCSEL' PRATICAMENTE QUESTA PROCEDURA COSTRUISCE
  // UNA STRINGLIST CONTENENTE LA QUERY CHE POI VERRA' UNITA ALLE ALTRE QUERY PER COSTRUIRE IL
  // RISULTATO DELL'INTERROGAZIONE SU DIVERSI TIPI DI DOCUMENTO, QUINDI SE NON PASSO PIU' PER LA TABELLA
  // 'DOCSEL' MI DEVO ASSICURARE CHE TUTTE LE QUERY CHE VENGONO UNITE CON LA UNION RESTITUISCANO LO STESSO
  // IDENTICO TRACCIATO.
  // QUINDI E' IMPORTANTE MANTENERE IL TRACCIATO DELLA TABELLA 'DOCSEL' AGGIORNATO ANCHE SE NON VIENE PIU'
  // USATO IN MODO CHE FACCIA DA TRACCIA.
  QryDoc.SQL.Add('SELECT');
  QryDoc.SQL.Add('CAST(' + DM1.CodiceUtente + ' AS INTEGER) AS STATION_ID');
  QryDoc.SQL.Add(',CAST(''Conformita'' AS VARCHAR(20)) AS TIPODOC');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(5)) AS REGISTRO');
  QryDoc.SQL.Add(',CAST(Doc.Codice AS INTEGER) AS CODICEDOC');
  QryDoc.SQL.Add(',CAST(Doc.Data AS TIMESTAMP) AS DATADOC');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS OGGETTOJOLLY1');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS OGGETTOJOLLY2');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS OGGETTOJOLLY3');
  QryDoc.SQL.Add(',CAST(NULL AS DECIMAL(15,4)) AS IMPORTO');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS NOTEJOLLY1');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS NOTEJOLLY2');
  QryDoc.SQL.Add(',CAST(Cli.RagioneSociale || ''  ('' || Doc.Cliente || '')'' AS VARCHAR(80)) AS CLIENTEFORNITORE');
  QryDoc.SQL.Add(',CAST(Doc.Note AS VARCHAR(200)) AS OGGETTO');
  QryDoc.SQL.Add(',CAST(Doc.Note AS VARCHAR(200)) AS NOTE');
  QryDoc.SQL.Add(',CAST(Doc.StatoDescrizione AS VARCHAR(10)) AS STATODESCRIZIONE');
  QryDoc.SQL.Add(',CAST(Doc.StatoForeground AS VARCHAR(10)) AS STATOFOREGROUND');
  QryDoc.SQL.Add(',CAST(Doc.StatoBackground AS VARCHAR(10)) AS STATOBACKGROUND');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(1)) AS SELEZIONATO');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(200)) AS PROVENIENZA');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(200)) AS ARGOMENTO');
  QryDoc.SQL.Add(',CAST(NULL AS DECIMAL(15,4)) AS IMPONIBILE');
  QryDoc.SQL.Add(',CAST(NULL AS DECIMAL(15,4)) AS IMPORTOIVA');
  QryDoc.SQL.Add(',CAST(Doc.Cliente AS INTEGER) AS CODICESOGGETTO');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(8)) AS ORADOC');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(1)) AS DAFATTURARE');
  QryDoc.SQL.Add
    (',CAST((SELECT Prat.Descrizione FROM Pratiche Prat WHERE Prat.Codice=Doc.Pratica AND Prat.DataApertura=Doc.DataPratica1) || ''  ('' || DOC.PRATICA || '', '' || DOC.DATAPRATICA1 || '')'' AS VARCHAR(80)) AS RIFPRATICA');
  QryDoc.SQL.Add(',CAST(NULL AS TIMESTAMP) AS VALIDITADATA');
  QryDoc.SQL.Add(',CAST(NULL AS TIMESTAMP) AS CONSEGNADATA');
  QryDoc.SQL.Add(',CAST(NULL AS CHAR(1)) AS CONSEGNATO');
  QryDoc.SQL.Add(',CAST(NULL AS VARCHAR(15)) AS CAUSALE');
  QryDoc.SQL.Add(',CAST(NULL AS VARCHAR(15)) AS CAUSALECANTIERE');
  QryDoc.SQL.Add(',CAST(NULL AS DECIMAL(15,4)) AS RITENUTAACCONTO');
  QryDoc.SQL.Add(',CAST(Cli.ClienteFornitore AS VARCHAR(10)) AS TIPOSOGGETTO');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(10)) AS OPERATORE');
  QryDoc.SQL.Add('FROM Conform Doc');
  QryDoc.SQL.Add('LEFT JOIN CLIENTI CLI ON (CLI.CODICE = DOC.CLIENTE)');
  // Aggiunge una clausola WHERE finta in modo che non dia errore se non viene specificata nessuna condizione
  QryDoc.SQL.Add('WHERE 1=1');
  if PraticaCorrente <> '' then
  begin
    DM1.AddSQL(QryDoc, 'AND', '((Doc.Pratica = ' + PraticaCorrente + ') OR (Doc.Pratica2 = ' + PraticaCorrente + ') OR (Doc.Pratica3 = ' +
      PraticaCorrente + '))');
  end
  else
  begin
    if ClienteCorrente <> '' then
      DM1.AddSQL(QryDoc, 'AND', 'Doc.Cliente = ' + ClienteCorrente);
  end;
  if DM1.ControllaDataStr(DateEditDa.EditText) then
    DM1.AddSQL(QryDoc, 'AND', 'Doc.Data >= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(DateEditDa.EditText)) + '''');
  if DM1.ControllaDataStr(DateEditA.EditText) then
    DM1.AddSQL(QryDoc, 'AND', 'Doc.Data <= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(DateEditA.EditText)) + '''');
  if FilterTesto.Text <> '' then
  begin
    DM1.AddSQL(QryDoc, 'AND', '(');
    DM1.AggiungiRicercaCampo(QryDoc.SQL, 'Doc.Oggetto', FilterTesto.Text, False);
    QryDoc.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryDoc.SQL, 'Doc.Note', FilterTesto.Text, False);
    QryDoc.SQL.Add(')');
  end;
end;

{
  procedure TClientiForm.EseguiQueryRappGiorn;
  var
  Qry: TIB_Cursor;
  begin
  Qry := TIB_Cursor.Create(Self);
  try
  Qry.DatabaseName := DM1.ArcDBFile;
  Qry.IB_Connection := DM1.DBAzienda;
  Qry.SQL.Add('INSERT');
  Qry.SQL.Add('INTO DocSel (STATION_ID, TipoDoc, Registro, CodiceDoc, DataDoc)');
  Qry.SQL.Add('SELECT ' + DM1.CodiceUtente + ', ''Rapp.giorn.'', RG.REGISTRO, RG.NUMDOC, RG.DATADOC');
  Qry.SQL.Add('FROM RAPGIORN RG');

  if PraticaCorrente <> '' then begin
  DM1.AddSQLToIB_Cursor(Qry, 'AND', '(   SELECT COUNT(*) FROM RAPGIORNRIGHI RGR WHERE RGR.NUMDOC=RG.NUMDOC AND RGR.DATADOC=RG.DATADOC AND RGR.REGISTRO=RG.REGISTRO AND RGR.CODCANTIERE=' + PraticaCorrente + ' AND RGR.DATACANTIERE=''' + DataPraticaCorrenteSQL + '''   ) > 1');
  end else begin
  if ClienteCorrente <> '' then DM1.AddSQLToIB_Cursor(Qry, 'AND', '(   SELECT COUNT(*) FROM RAPGIORNRIGHI RGR WHERE RGR.NUMDOC=RG.NUMDOC AND RGR.DATADOC=RG.DATADOC AND RGR.REGISTRO=RG.REGISTRO AND RGR.CODSOGGETTO=' + ClienteCorrente + '   ) > 1');
  end;
  if DM1.ControllaDataStr(DateEditDa.EditText) then DM1.AddSQLToIB_Cursor(Qry, 'AND', 'RG.DATADOC >= ''' + FormatDateTime('mm/dd/yyyy',StrToDate(DateEditDa.EditText)) + '''');
  if DM1.ControllaDataStr(DateEditA.EditText)  then DM1.AddSQLToIB_Cursor(Qry, 'AND', 'RG.DATADOC <= ''' + FormatDateTime('mm/dd/yyyy',StrToDate(DateEditA.EditText)) + '''');
  Qry.ExecSQL;
  finally
  Qry.Free;
  end;
  end;
}
procedure TClientiForm.EseguiQueryRappGiorn(QryDoc: TIBOQuery);
begin
  // Prima di tutto se la query non  vuota significa che c' una SELECT precedente
  // e quindi aggiunge l'UNION ALL
  CheckForUnionAll(QryDoc);
  // Costruisce la query SELECT per il reperimento dei dati
  // NB: LA QUERY SELECT DEVE RICOSTRUIRE IL TRACCIATO DELLA TABELLA 'DOCSEL' PERCHE'
  // DA QUANDO HO ELIMINATO L'USO DELLA TABELLA 'DOCSEL' PRATICAMENTE QUESTA PROCEDURA COSTRUISCE
  // UNA STRINGLIST CONTENENTE LA QUERY CHE POI VERRA' UNITA ALLE ALTRE QUERY PER COSTRUIRE IL
  // RISULTATO DELL'INTERROGAZIONE SU DIVERSI TIPI DI DOCUMENTO, QUINDI SE NON PASSO PIU' PER LA TABELLA
  // 'DOCSEL' MI DEVO ASSICURARE CHE TUTTE LE QUERY CHE VENGONO UNITE CON LA UNION RESTITUISCANO LO STESSO
  // IDENTICO TRACCIATO.
  // QUINDI E' IMPORTANTE MANTENERE IL TRACCIATO DELLA TABELLA 'DOCSEL' AGGIORNATO ANCHE SE NON VIENE PIU'
  // USATO IN MODO CHE FACCIA DA TRACCIA.
  QryDoc.SQL.Add('SELECT');
  QryDoc.SQL.Add('CAST(' + DM1.CodiceUtente + ' AS INTEGER) AS STATION_ID');
  QryDoc.SQL.Add(',CAST(''Rapp.giorn.'' AS VARCHAR(20)) AS TIPODOC');
  QryDoc.SQL.Add(',CAST(Doc.Registro AS VARCHAR(5)) AS REGISTRO');
  QryDoc.SQL.Add(',CAST(Doc.NumDoc AS INTEGER) AS CODICEDOC');
  QryDoc.SQL.Add(',CAST(Doc.DataDoc AS TIMESTAMP) AS DATADOC');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS OGGETTOJOLLY1');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS OGGETTOJOLLY2');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS OGGETTOJOLLY3');
  QryDoc.SQL.Add(',CAST(NULL AS DECIMAL(15,4)) AS IMPORTO');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS NOTEJOLLY1');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(30)) AS NOTEJOLLY2');
  QryDoc.SQL.Add(',CAST(''N.D.'' AS VARCHAR(80)) AS CLIENTEFORNITORE');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(200)) AS OGGETTO');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(200)) AS NOTE');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(10)) AS STATODESCRIZIONE');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(10)) AS STATOFOREGROUND');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(10)) AS STATOBACKGROUND');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(1)) AS SELEZIONATO');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(200)) AS PROVENIENZA');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(200)) AS ARGOMENTO');
  QryDoc.SQL.Add(',CAST(NULL AS DECIMAL(15,4)) AS IMPONIBILE');
  QryDoc.SQL.Add(',CAST(NULL AS DECIMAL(15,4)) AS IMPORTOIVA');
  QryDoc.SQL.Add(',CAST(0 AS INTEGER) AS CODICESOGGETTO');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(8)) AS ORADOC');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(1)) AS DAFATTURARE');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(80)) AS RIFPRATICA');
  QryDoc.SQL.Add(',CAST(NULL AS TIMESTAMP) AS VALIDITADATA');
  QryDoc.SQL.Add(',CAST(NULL AS TIMESTAMP) AS CONSEGNADATA');
  QryDoc.SQL.Add(',CAST(NULL AS CHAR(1)) AS CONSEGNATO');
  QryDoc.SQL.Add(',CAST(NULL AS VARCHAR(15)) AS CAUSALE');
  QryDoc.SQL.Add(',CAST(NULL AS VARCHAR(15)) AS CAUSALECANTIERE');
  QryDoc.SQL.Add(',CAST(NULL AS DECIMAL(15,4)) AS RITENUTAACCONTO');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(10)) AS TIPOSOGGETTO');
  QryDoc.SQL.Add(',CAST('''' AS VARCHAR(10)) AS OPERATORE');
  QryDoc.SQL.Add('FROM RapGiorn Doc');
  // QryDoc.SQL.Add('LEFT JOIN CLIENTI CLI ON (CLI.CODICE = DOC.CLIENTE)');
  // Aggiunge una clausola WHERE finta in modo che non dia errore se non viene specificata nessuna condizione
  QryDoc.SQL.Add('WHERE 1=1');
  if PraticaCorrente <> '' then
  begin
    QryDoc.SQL.Add('AND (');
    QryDoc.SQL.Add
      ('       (   (SELECT COUNT(*) FROM RAPGIORNRIGHI RGR WHERE RGR.NUMDOC=Doc.NUMDOC AND RGR.DATADOC=Doc.DATADOC AND RGR.REGISTRO=Doc.REGISTRO AND RGR.CODCANTIERE='
      + PraticaCorrente + ' AND RGR.DATACANTIERE=''' + DataPraticaCorrenteSQL + '''   ) > 0   )');
    QryDoc.SQL.Add
      ('    OR (   (SELECT COUNT(*) FROM RAPGIORNRIGHISPESE RGRS WHERE RGRS.NUMDOC=Doc.NUMDOC AND RGRS.DATADOC=Doc.DATADOC AND RGRS.REGISTRO=Doc.REGISTRO AND RGRS.CODCANTIERE='
      + PraticaCorrente + ' AND RGRS.DATACANTIERE=''' + DataPraticaCorrenteSQL + '''   ) > 0   )');
    QryDoc.SQL.Add('    )');
  end
  else
  begin
    if ClienteCorrente <> '' then
    begin
      QryDoc.SQL.Add('AND (');
      QryDoc.SQL.Add
        ('       (   (SELECT COUNT(*) FROM RAPGIORNRIGHI RGR WHERE RGR.NUMDOC=Doc.NUMDOC AND RGR.DATADOC=Doc.DATADOC AND RGR.REGISTRO=Doc.REGISTRO AND RGR.CODSOGGETTO='
        + ClienteCorrente + ') > 0   )');
      QryDoc.SQL.Add
        ('    OR (   (SELECT COUNT(*) FROM RAPGIORNRIGHISPESE RGRS WHERE RGRS.NUMDOC=Doc.NUMDOC AND RGRS.DATADOC=Doc.DATADOC AND RGRS.REGISTRO=Doc.REGISTRO AND RGRS.CODSOGGETTO='
        + ClienteCorrente + ') > 0   )');
      QryDoc.SQL.Add('    )');
    end;
  end;
  if DM1.ControllaDataStr(DateEditDa.EditText) then
    DM1.AddSQL(QryDoc, 'AND', 'Doc.DATADOC >= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(DateEditDa.EditText)) + '''');
  if DM1.ControllaDataStr(DateEditA.EditText) then
    DM1.AddSQL(QryDoc, 'AND', 'Doc.DATADOC <= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(DateEditA.EditText)) + '''');
  if FilterTesto.Text <> '' then
  begin
    DM1.AddSQL(QryDoc, 'AND', '(');
    // DM1.AggiungiRicercaCampo(QryDoc.SQL, 'Doc.Oggetto', FilterTesto.Text, False);
    // QryDoc.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryDoc.SQL, 'Doc.Note', FilterTesto.Text, False);
    // QryDoc.SQL.Add('OR');
    // DM1.AggiungiRicercaCampo(QryDoc.SQL, 'Doc.Provenienza', FilterTesto.Text, False);
    // QryDoc.SQL.Add('OR');
    // DM1.AggiungiRicercaCampo(QryDoc.SQL, 'Doc.Argomento', FilterTesto.Text, False);
    QryDoc.SQL.Add(')');
  end;
end;

{
  procedure TClientiForm.EseguiQueryScadenze;
  var
  i:Integer;
  SaldoTmp, SaldoPagato, SaldoRitAcc: Double;
  begin
  if (not TipoScadenze.Checked[0]) and (not TipoScadenze.Checked[1]) and (not TipoScadenze.Checked[2]) then begin
  TipoScadenze.Checked[0] := True;
  TipoScadenze.Checked[1] := True;
  TipoScadenze.Checked[2] := True;
  end;
  if (not TipoScadenze3.Checked[0]) and (not TipoScadenze3.Checked[1]) then begin
  TipoScadenze3.Checked[0] := True;
  TipoScadenze3.Checked[1] := True;
  end;
  Application.ProcessMessages;
  QryScad.Close;
  QryScad.SQL.Clear;
  // --------------------------------------------------------------------------------------------------------------------------------------------
  // Query per le scadenze ATTIVE
  // --------------------------------------------------------------------------------------------------------------------------------------------
  if TipoScadenze3.Checked[0] then begin
  // Inizia la query normale
  QryScad.SQL.Add('SELECT S.CODICE, S.DATASCADENZA');
  if TipoImporto.Checked[0] then begin
  QryScad.SQL.Add(', CAST(COALESCE((S.IMPORTO-S.IMPORTOPAGATO+S.SPESEPROTESTO),0) AS NUMERIC(15,4)) AS DARE');
  end else begin
  QryScad.SQL.Add(', CAST(COALESCE(S.IMPORTO,0) AS NUMERIC(15,4)) AS DARE');
  end;
  QryScad.SQL.Add(', CAST(0 AS NUMERIC(15,4)) AS AVERE');
  QryScad.SQL.Add(', CAST(COALESCE((S.IMPORTO-S.IMPORTOPAGATO+S.SPESEPROTESTO),0) AS NUMERIC(15,4)) AS RESIDUO');
  QryScad.SQL.Add(', COALESCE(S.IMPORTO,0) AS IMPORTO, S.RICEVUTABANCARIA, S.PRESENTATA');
  // Se trova la directory "c:\programmi\firebird" assume che Firebird  installato e avviato e quindi
  //  usa una query un p modificata.
  //          if DirectoryExists('c:\programmi\firebird\firebird_1_5') then begin
  QryScad.SQL.Add(', CAST(COALESCE(S.TIPODOC || '' '','''') || COALESCE(''N. '' || S.NUMDOC || '' '','''') || COALESCE(S.REGISTRO || '' '','''') || COALESCE(''del '' || S.DATADOC || '' '','''') || COALESCE('': '' || S.NOTE,'''') AS VARCHAR(160)) AS DOCUMENTO');
  //          end else begin
  //             QryScad.SQL.Add(', CAST(S.TIPODOC || '' N. '' || S.NUMDOC || S.REGISTRO || '' del '' || S.DATADOC  AS VARCHAR(160)) AS DOCUMENTO');
  //          end;
  QryScad.SQL.Add(', CAST(C.RAGIONESOCIALE || ''  ('' || S.CLIENTE || '')'' AS VARCHAR(80)) AS SOGGETTO');
  QryScad.SQL.Add(', S.TIPO, B.BANCA, S.ABI, S.CAB, C.RAGIONESOCIALE, C.INDIRIZZO, C.CAP, C.CITTA, C.PROVINCIA, C.PartitaIVA');
  QryScad.SQL.Add(', S.CLIENTE, S.PRATICA, S.DATAPRATICA1, S.TIPODOC, S.NUMDOC, S.REGISTRO, S.DATADOC, S.NOTE, S.INSOLUTO');
  QryScad.SQL.Add(', CAST((SELECT DESCRIZIONE FROM Pratiche P WHERE P.Codice=S.Pratica AND P.DataApertura=S.DataPratica1)||''  (''||S.PRATICA|| '', ''||S.DATAPRATICA1||'')'' AS VARCHAR(120)) AS RIFPRATICA');
  QryScad.SQL.Add(', S.AGENTE, S.AGENTE2, S.AGENTE3, S.AGENTE4, S.DATAPAGAMENTO, S.STATODESCRIZIONE, (0-COALESCE(DOC.RITACC,0)) AS RITACC, COALESCE(DOC.RITACCPERC,0) AS RITACCPERC');
  QryScad.SQL.Add(', COALESCE(DOC.TOTALEIMPONIBILE,0) AS TOTALEIMPONIBILE, COALESCE(S.IMPORTOPAGATO,0) AS IMPORTOPAGATO');
  QryScad.SQL.Add('FROM SCADENZ S');
  QryScad.SQL.Add('LEFT JOIN CLIENTI C ON (C.CODICE = S.CLIENTE)');
  QryScad.SQL.Add('LEFT JOIN BANCHE B ON (B.ABI = S.ABI AND B.CAB = S.CAB)');
  QryScad.SQL.Add('LEFT JOIN PRVORDCL DOC ON (DOC.TIPODOCUMENTO=S.TIPODOC AND DOC.NUMORDPREV=S.NUMDOC AND DOC.REGISTRO=S.REGISTRO AND DOC.DATADOCUMENTO=S.DATADOC)');
  // Imposta i filtraggi
  QryScad.SQL.Add('WHERE S.TIPO = ''Scad.attiv''');
  // Se c' una pratica selezionata...
  if PraticaCorrente <> '' then begin
  QryScad.SQl.Add('AND ((S.PRATICA = ' + PraticaCorrente + ') OR (S.PRATICA2 = ' + PraticaCorrente + ') OR (S.PRATICA3 = ' + PraticaCorrente + '))');
  // Oppure se c' un soggetto selezionato....
  end else begin
  if ClienteCorrente <> '' then QryScad.SQl.Add('AND S.CLIENTE = ' + ClienteCorrente);
  end;
  // Altri filtri
  if ScadCodice.Text <> '' then QryScad.SQL.Add('AND S.CODICE = ' + ScadCodice.Text);
  if ScadDescrizione.Text <> '' then DM1.AggiungiRicercaCampo(QryScad.SQL, 'S.NOTE', ScadDescrizione.Text, True);
  // Filtro per tipo (stato) della scadenza
  QryScad.SQL.Add('AND ( (1=2)');
  if TipoScadenze.Checked[0]  then QryScad.SQL.Add('OR (S.IMPORTO-S.IMPORTOPAGATO+S.SPESEPROTESTO) > 0');
  if TipoScadenze.Checked[1]  then QryScad.SQL.Add('OR (S.IMPORTO-S.IMPORTOPAGATO+S.SPESEPROTESTO) <= 0');
  if TipoScadenze.Checked[2]  then QryScad.SQL.Add('OR S.INSOLUTO = ''T''');
  QryScad.SQL.Add('    )');
  // Continua altri filtri
  if ScadStato.Text <> ''               then QryScad.SQL.Add('AND S.STATODESCRIZIONE = ''' + ScadStato.Text + '''');
  if TipoScadenze2.Checked[0] or TipoScadenze2.Checked[1] then QryScad.SQL.Add('AND RICEVUTABANCARIA = ''T''');
  if TipoScadenze2.Checked[1]           then QryScad.SQL.Add('AND PRESENTATA = ''/''');

  // ==========================================================================
  // FILTRAGGIO PER DATE
  // --------------------------------------------------------------------------
  if ScadTipoData.Text = 'Data di scadenza' then begin
  if DM1.ControllaDataStr(ScadDal.EditText) then QryScad.SQL.Add('AND DATASCADENZA >= ''' + FormatDateTime('mm/dd/yyyy',StrToDate(ScadDal.EditText)) + '''');
  if DM1.ControllaDataStr(ScadAl.EditText)  then QryScad.SQL.Add('AND DATASCADENZA <= ''' + FormatDateTime('mm/dd/yyyy',StrToDate(ScadAl.EditText)) + '''');
  end else if ScadTipoData.Text = 'Data pagamento' then begin
  if DM1.ControllaDataStr(ScadDal.EditText) then QryScad.SQL.Add('AND DATAPAGAMENTO >= ''' + FormatDateTime('mm/dd/yyyy',StrToDate(ScadDal.EditText)) + '''');
  if DM1.ControllaDataStr(ScadAl.EditText)  then QryScad.SQL.Add('AND DATAPAGAMENTO <= ''' + FormatDateTime('mm/dd/yyyy',StrToDate(ScadAl.EditText)) + '''');
  end;
  // ==========================================================================

  // Fitro per documento
  if ScadTipoDoc.Text <> ''  then QryScad.SQL.Add('AND S.TIPODOC  = ''' + ScadTipoDoc.Text + '''');
  if ScadNumDoc.Text <> ''   then QryScad.SQL.Add('AND S.NUMDOC   = ' + ScadNumDoc.Text);
  if ScadRegistro.Text <> '' then QryScad.SQL.Add('AND S.REGISTRO = ''' + ScadRegistro.Text + '''');
  if ScadDataDoc.Text <> ''  then QryScad.SQL.Add('AND S.DATADOC  = ''' + FormatDateTime('mm/dd/yyyy',StrToDate(ScadDataDoc.Text)) + '''');
  // Filtro per registro
  if ScadSoloRegistro.Text <> ''     then QryScad.SQL.Add('AND S.Registro = ''' + ScadSoloRegistro.Text + '''');
  if ScadTranneRegistro.Text <> ''   then QryScad.SQL.Add('AND S.Registro <> ''' + ScadSoloRegistro.Text + '''');
  // Agenti
  if ScadAgente.Text   <> '' then DM1.AddSQL(QryScad, 'AND', 'S.AGENTE  = ''' + ScadAgente.Text + '''');
  if ScadAgente2.Text  <> '' then DM1.AddSQL(QryScad, 'AND', 'S.AGENTE2 = ''' + ScadAgente2.Text + '''');
  if ScadAgente3.Text  <> '' then DM1.AddSQL(QryScad, 'AND', 'S.AGENTE3 = ''' + ScadAgente3.Text + '''');
  if ScadAgente4.Text  <> '' then DM1.AddSQL(QryScad, 'AND', 'S.AGENTE4 = ''' + ScadAgente4.Text + '''');

  // -------------------------------------------------------------------
  // Aggiunge alle scadenza attive anche le eventuali Ric.Fisc. relative
  //  agli interventi di assistenza che fanno riferimento appunto
  //  a una ricevuta fiscale e marcata come "COrrispettivo non pagato"
  // -------------------------------------------------------------------

  // -------------------------------------------------------------------

  // Carica le clausole WHERE nella Query che calcola i totali DARE
  QryTotScadDare.Close;
  QryTotScadDare.SQL.Clear;
  if TipoImporto.Checked[0] then begin
  QryTotScadDare.SQL.Add('SELECT SUM(S.IMPORTO-S.IMPORTOPAGATO+S.SPESEPROTESTO) AS DARE, SUM(S.IMPORTOPAGATO) AS TOTIMPORTOPAGATO, SUM(DOC.RITACC) AS TOTRITACC');
  QryTotScadDare.SQL.Add('FROM SCADENZ S');
  QryTotScadDare.SQL.Add('LEFT JOIN PRVORDCL DOC ON (DOC.TIPODOCUMENTO=S.TIPODOC AND DOC.NUMORDPREV=S.NUMDOC AND DOC.REGISTRO=S.REGISTRO AND DOC.DATADOCUMENTO=S.DATADOC)');
  QryTotScadDare.SQL.Add(' WHERE TIPO = ''Scad.attiv''');
  end else begin
  QryTotScadDare.SQL.Add('SELECT SUM(S.IMPORTO) AS DARE, SUM(S.IMPORTOPAGATO) AS TOTIMPORTOPAGATO, SUM(DOC.RITACC) AS TOTRITACC');
  QryTotScadDare.SQL.Add('FROM SCADENZ S');
  QryTotScadDare.SQL.Add('LEFT JOIN PRVORDCL DOC ON (DOC.TIPODOCUMENTO=S.TIPODOC AND DOC.NUMORDPREV=S.NUMDOC AND DOC.REGISTRO=S.REGISTRO AND DOC.DATADOCUMENTO=S.DATADOC)');
  QryTotScadDare.SQL.Add(' WHERE TIPO = ''Scad.attiv''');
  end;
  for i := 17 to QryScad.SQL.Count-1 do QryTotScadDare.SQL.Add(QryScad.SQL[i]);
  // Carica le clausole WHERE nella Query che calcola i totali AVERE
  QryTotScadAvere.Close;
  QryTotScadAvere.SQL.Clear;
  if TipoImporto.Checked[0] then begin
  QryTotScadAvere.SQL.Add('SELECT SUM(S.IMPORTO-S.IMPORTOPAGATO+S.SPESEPROTESTO) AS AVERE, SUM(S.IMPORTOPAGATO) AS TOTIMPORTOPAGATO, SUM(DOC.RITACC) AS TOTRITACC');
  QryTotScadAvere.SQL.Add('FROM SCADENZ S');
  QryTotScadAvere.SQL.Add('LEFT JOIN PRVORDCL DOC ON (DOC.TIPODOCUMENTO=S.TIPODOC AND DOC.NUMORDPREV=S.NUMDOC AND DOC.REGISTRO=S.REGISTRO AND DOC.DATADOCUMENTO=S.DATADOC)');
  QryTotScadAvere.SQL.Add(' WHERE TIPO = ''Scad.passi''');
  end else begin
  QryTotScadAvere.SQL.Add('SELECT SUM(S.IMPORTO) AS AVERE, SUM(S.IMPORTOPAGATO) AS TOTIMPORTOPAGATO, SUM(DOC.RITACC) AS TOTRITACC');
  QryTotScadAvere.SQL.Add('FROM SCADENZ S');
  QryTotScadAvere.SQL.Add('LEFT JOIN PRVORDCL DOC ON (DOC.TIPODOCUMENTO=S.TIPODOC AND DOC.NUMORDPREV=S.NUMDOC AND DOC.REGISTRO=S.REGISTRO AND DOC.DATADOCUMENTO=S.DATADOC)');
  QryTotScadAvere.SQL.Add(' WHERE TIPO = ''Scad.passi''');
  end;
  for i := 17 to QryScad.SQL.Count-1 do QryTotScadAvere.SQL.Add(QryScad.SQL[i]);
  end;
  // --------------------------------------------------------------------------------------------------------------------------------------------

  // Mette lo UNION ALL solo se sono da visualizzare sia le scadenze da riscuotere che quelle da pagare
  if TipoScadenze3.Checked[0] and TipoScadenze3.Checked[1] then QryScad.SQL.Add('UNION ALL');

  // --------------------------------------------------------------------------------------------------------------------------------------------
  // Query per le scadenze PASSIVE
  // --------------------------------------------------------------------------------------------------------------------------------------------
  if TipoScadenze3.Checked[1] then begin
  QryScad.SQL.Add('SELECT S.CODICE, S.DATASCADENZA');
  QryScad.SQL.Add(', CAST(0 AS NUMERIC(15,4)) AS DARE');
  if TipoImporto.Checked[0] then begin
  QryScad.SQL.Add(', CAST(COALESCE((S.IMPORTO-S.IMPORTOPAGATO+S.SPESEPROTESTO),0) AS NUMERIC(15,4)) AS AVERE');
  end else begin
  QryScad.SQL.Add(', CAST(COALESCE(S.IMPORTO,0) AS NUMERIC(15,4)) AS AVERE');
  end;
  QryScad.SQL.Add(', CAST(COALESCE((S.IMPORTO-S.IMPORTOPAGATO+S.SPESEPROTESTO),0) AS NUMERIC(15,4)) AS RESIDUO');
  QryScad.SQL.Add(', COALESCE(S.IMPORTO,0) AS IMPORTO, S.RICEVUTABANCARIA, S.PRESENTATA');
  // Se trova la directory "c:\programmi\firebird" assume che Firebird  installato e avviato e quindi
  //  usa una query un p modificata.
  //          if DirectoryExists('c:\programmi\firebird\firebird_1_5') then begin
  QryScad.SQL.Add(', CAST(COALESCE(S.TIPODOC || '' '','''') || COALESCE(''N. '' || S.NUMDOC || '' '','''') || COALESCE(S.REGISTRO || '' '','''') || COALESCE(''del '' || S.DATADOC || '' '','''') || COALESCE('': '' || S.NOTE,'''') AS VARCHAR(160)) AS DOCUMENTO');
  //          end else begin
  //             QryScad.SQL.Add(', CAST(S.TIPODOC || '' N. '' || S.NUMDOC || S.REGISTRO || '' del '' || S.DATADOC  AS VARCHAR(160)) AS DOCUMENTO');
  //          end;
  QryScad.SQL.Add(', CAST(C.RAGIONESOCIALE || ''  ('' || S.CLIENTE || '')'' AS VARCHAR(80)) AS SOGGETTO');
  QryScad.SQL.Add(', S.TIPO, B.BANCA, S.ABI, S.CAB, C.RAGIONESOCIALE, C.INDIRIZZO, C.CAP, C.CITTA, C.PROVINCIA, C.PartitaIVA');
  QryScad.SQL.Add(', S.CLIENTE, S.PRATICA, S.DATAPRATICA1, S.TIPODOC, S.NUMDOC, S.REGISTRO, S.DATADOC, S.NOTE, S.INSOLUTO');
  QryScad.SQL.Add(', CAST((SELECT P.DESCRIZIONE FROM Pratiche P WHERE P.Codice=S.Pratica AND P.DataApertura=S.DataPratica1)||''  (''||S.PRATICA|| '', ''||S.DATAPRATICA1||'')'' AS VARCHAR(120)) AS RIFPRATICA');
  QryScad.SQL.Add(', S.AGENTE, S.AGENTE2, S.AGENTE3, S.AGENTE4, S.DATAPAGAMENTO, S.STATODESCRIZIONE, COALESCE(DOC.RITACC,0) RITACC, COALESCE(DOC.RITACCPERC,0) RITACCPERC');
  QryScad.SQL.Add(', COALESCE(DOC.TOTALEIMPONIBILE,0) AS TOTALEIMPONIBILE, (0-COALESCE(S.IMPORTOPAGATO,0)) AS IMPORTOPAGATO');
  QryScad.SQL.Add('FROM SCADENZ S');
  QryScad.SQL.Add('LEFT JOIN CLIENTI C ON C.CODICE = S.CLIENTE');
  QryScad.SQL.Add('LEFT JOIN BANCHE B ON B.ABI = S.ABI AND B.CAB = S.CAB');
  QryScad.SQL.Add('LEFT JOIN PRVORDCL DOC ON (DOC.TIPODOCUMENTO=S.TIPODOC AND DOC.NUMORDPREV=S.NUMDOC AND DOC.REGISTRO=S.REGISTRO AND DOC.DATADOCUMENTO=S.DATADOC)');
  // Imposta i filtraggi
  QryScad.SQL.Add('WHERE S.TIPO = ''Scad.passi''');
  // Se c' una pratica selezionata...
  if PraticaCorrente <> '' then begin
  QryScad.SQl.Add('AND ((S.PRATICA = ' + PraticaCorrente + ') OR (S.PRATICA2 = ' + PraticaCorrente + ') OR (S.PRATICA3 = ' + PraticaCorrente + '))');
  // Oppure se c' un soggetto selezionato....
  end else begin
  if ClienteCorrente <> '' then QryScad.SQl.Add('AND S.CLIENTE = ' + ClienteCorrente);
  end;
  // Altri filtri
  if ScadCodice.Text <> '' then QryScad.SQL.Add('AND S.CODICE = ' + ScadCodice.Text);
  if ScadDescrizione.Text <> '' then DM1.AggiungiRicercaCampo(QryScad.SQL, 'S.NOTE', ScadDescrizione.Text, True);
  // Filtro per tipo (stato) della scadenza
  QryScad.SQL.Add('AND ( (1=2)');
  if TipoScadenze.Checked[0]  then QryScad.SQL.Add('OR (S.IMPORTO-S.IMPORTOPAGATO+S.SPESEPROTESTO) > 0');
  if TipoScadenze.Checked[1]  then QryScad.SQL.Add('OR (S.IMPORTO-S.IMPORTOPAGATO+S.SPESEPROTESTO) <= 0');
  if TipoScadenze.Checked[2]  then QryScad.SQL.Add('OR S.INSOLUTO = ''T''');
  QryScad.SQL.Add('    )');
  // Continua altri filtri
  if ScadStato.Text <> ''               then QryScad.SQL.Add('AND S.STATODESCRIZIONE = ''' + ScadStato.Text + '''');
  if TipoScadenze2.Checked[0] or TipoScadenze2.Checked[1] then QryScad.SQL.Add('AND RICEVUTABANCARIA = ''T''');
  if TipoScadenze2.Checked[1]           then QryScad.SQL.Add('AND PRESENTATA = ''/''');

  // ==========================================================================
  // FILTRAGGIO PER DATE
  // --------------------------------------------------------------------------
  if ScadTipoData.Text = 'Data di scadenza' then begin
  if DM1.ControllaDataStr(ScadDal.EditText) then QryScad.SQL.Add('AND DATASCADENZA >= ''' + FormatDateTime('mm/dd/yyyy',StrToDate(ScadDal.EditText)) + '''');
  if DM1.ControllaDataStr(ScadAl.EditText)  then QryScad.SQL.Add('AND DATASCADENZA <= ''' + FormatDateTime('mm/dd/yyyy',StrToDate(ScadAl.EditText)) + '''');
  end else if ScadTipoData.Text = 'Data pagamento' then begin
  if DM1.ControllaDataStr(ScadDal.EditText) then QryScad.SQL.Add('AND DATAPAGAMENTO >= ''' + FormatDateTime('mm/dd/yyyy',StrToDate(ScadDal.EditText)) + '''');
  if DM1.ControllaDataStr(ScadAl.EditText)  then QryScad.SQL.Add('AND DATAPAGAMENTO <= ''' + FormatDateTime('mm/dd/yyyy',StrToDate(ScadAl.EditText)) + '''');
  end;
  // ==========================================================================

  // Fitro per documento
  if ScadTipoDoc.Text <> ''  then QryScad.SQL.Add('AND S.TIPODOC  = ''' + ScadTipoDoc.Text + '''');
  if ScadNumDoc.Text <> ''   then QryScad.SQL.Add('AND S.NUMDOC   = ' + ScadNumDoc.Text);
  if ScadRegistro.Text <> '' then QryScad.SQL.Add('AND S.REGISTRO = ''' + ScadRegistro.Text + '''');
  if ScadDataDoc.Text <> ''  then QryScad.SQL.Add('AND S.DATADOC  = ''' + FormatDateTime('mm/dd/yyyy',StrToDate(ScadDataDoc.Text)) + '''');
  // Filtro per registro
  if ScadSoloRegistro.Text <> ''     then QryScad.SQL.Add('AND S.Registro = ''' + ScadSoloRegistro.Text + '''');
  if ScadTranneRegistro.Text <> ''   then QryScad.SQL.Add('AND S.Registro <> ''' + ScadSoloRegistro.Text + '''');
  // Agenti
  if ScadAgente.Text   <> '' then DM1.AddSQL(QryScad, 'AND', 'S.AGENTE  = ''' + ScadAgente.Text + '''');
  if ScadAgente2.Text  <> '' then DM1.AddSQL(QryScad, 'AND', 'S.AGENTE2 = ''' + ScadAgente2.Text + '''');
  if ScadAgente2.Text  <> '' then DM1.AddSQL(QryScad, 'AND', 'S.AGENTE3 = ''' + ScadAgente3.Text + '''');
  if ScadAgente2.Text  <> '' then DM1.AddSQL(QryScad, 'AND', 'S.AGENTE4 = ''' + ScadAgente4.Text + '''');

  // Carica le clausole WHERE nei totali AVERE nel caso si sia scelto di non visualizzare le scadenze attive
  if not TipoScadenze3.Checked[0] then begin
  // Carica le clausole WHERE nella Query che calcola i totali AVERE
  QryTotScadAvere.Close;
  QryTotScadAvere.SQL.Clear;
  if TipoImporto.Checked[0] then begin
  QryTotScadAvere.SQL.Add('SELECT SUM(S.IMPORTO-S.IMPORTOPAGATO+S.SPESEPROTESTO) AS AVERE, SUM(S.IMPORTOPAGATO) AS TOTIMPORTOPAGATO, SUM(DOC.RITACC) AS TOTRITACC');
  QryTotScadAvere.SQL.Add('FROM SCADENZ S');
  QryTotScadAvere.SQL.Add('LEFT JOIN PRVORDCL DOC ON (DOC.TIPODOCUMENTO=S.TIPODOC AND DOC.NUMORDPREV=S.NUMDOC AND DOC.REGISTRO=S.REGISTRO AND DOC.DATADOCUMENTO=S.DATADOC)');
  QryTotScadAvere.SQL.Add(' WHERE TIPO = ''Scad.passi''');
  end else begin
  QryTotScadAvere.SQL.Add('SELECT SUM(S.IMPORTO) AS AVERE, SUM(S.IMPORTOPAGATO) AS TOTIMPORTOPAGATO, SUM(DOC.RITACC) AS TOTRITACC');
  QryTotScadAvere.SQL.Add('FROM SCADENZ S');
  QryTotScadAvere.SQL.Add('LEFT JOIN PRVORDCL DOC ON (DOC.TIPODOCUMENTO=S.TIPODOC AND DOC.NUMORDPREV=S.NUMDOC AND DOC.REGISTRO=S.REGISTRO AND DOC.DATADOCUMENTO=S.DATADOC)');
  QryTotScadAvere.SQL.Add(' WHERE TIPO = ''Scad.passi''');
  end;
  for i := 17 to QryScad.SQL.Count-1 do QryTotScadAvere.SQL.Add(QryScad.SQL[i]);
  end;
  end;
  // --------------------------------------------------------------------------------------------------------------------------------------------
  if TipoScadenze3.Checked[0] or TipoScadenze3.Checked[1] then begin
  // Aggiunge alla query l'ORDER BY
  //  NB: Rimossa per il momento perch tanto la Griglia ha GridMode := False;
  //          QryScad.SQL.Add(DM1.GeneraOrderBy(tvScad));
  // Apre la query
  //QryScad.SQL.SaveToFile('c:\sql.sql');
  QryScad.Open;
  // Aggiorna il totale numero scadenze presenti
  TotNumScad.Caption := IntToStr(QryScad.RecordCount);
  end;
  // Apre le query dei totali e aggiorna il saldo
  // NB: Aggiorna anche il totale importo pagato
  SaldoTmp     := 0;
  SaldoPagato  := 0;
  SaldoRitAcc  := 0;
  if TipoScadenze3.Checked[0] then begin
  //QryTotScadDare.SQL.SaveToFile('c:\sql.sql');
  QryTotScadDare.Open;
  SaldoTmp := QryTotScadDare.FieldByName('DARE').AsDouble;
  SaldoPagato := QryTotScadDare.FieldByName('TOTIMPORTOPAGATO').AsDouble;
  SaldoRitAcc := QryTotScadDare.FieldByName('TOTRITACC').AsDouble;
  end else SaldoTmp := 0;
  if TipoScadenze3.Checked[1] then begin
  QryTotScadAvere.Open;
  SaldoTmp := SaldoTmp - QryTotScadAvere.FieldByName('AVERE').AsDouble;
  SaldoPagato := SaldoPagato - QryTotScadAvere.FieldByName('TOTIMPORTOPAGATO').AsDouble;
  SaldoRitAcc := SaldoRitAcc - QryTotScadAvere.FieldByName('TOTRITACC').AsDouble;
  end;
  Saldo.Text := FloatToStr(SaldoTmp);
  Saldo.Height := 14;  // Forza l'altezza altrimenti scazza
  DbeTotPagato.Text := FloatToStr(SaldoPagato);
  DbeTotPagato.Height := 14;  // Forza l'altezza altrimenti scazza
  dbeScadTotRitAcc.Text := FloatToStr(SaldoRitAcc * (-1));
  dbeScadTotRitAcc.Height := 14;  // Forza l'altezza altrimenti scazza
  // Si posizione all'inizio
  tvScad.DataController.GotoFirst;
  end;
}
procedure TClientiForm.EseguiQueryScadenze;
var
  I: Integer;
  SaldoTmp, SaldoPagato, SaldoRitAcc: Double;
begin
  if (not TipoScadenze.Checked[0]) and (not TipoScadenze.Checked[1]) and (not TipoScadenze.Checked[2]) then
  begin
    TipoScadenze.Checked[0] := True;
    TipoScadenze.Checked[1] := True;
    TipoScadenze.Checked[2] := True;
  end;
  if (not TipoScadenze3.Checked[0]) and (not TipoScadenze3.Checked[1]) then
  begin
    TipoScadenze3.Checked[0] := True;
    TipoScadenze3.Checked[1] := True;
  end;
  Application.ProcessMessages;

  // ======================================================================
  // IMPOSTAZIONE QUERY SCADENZE
  // ----------------------------------------------------------------------
  QryScad.Close;
  QryScad.SQL.Clear;

  // Imposta la query per l'interrogazione
  QryScad.SQL.Add('SELECT SLV.CODICE, SLV.DATASCADENZA, SLV.RICEVUTABANCARIA, SLV.PRESENTATA, SLV.PRESENTATABANCA, SLV.TIPOLOGIA');
  // Se abbiamo scelto di visualizzare il residuo da pagare
  if TipoImporto.Checked[0] then
  begin
    QryScad.SQL.Add(',SLV.DARE_RESIDUO AS DARE');
    QryScad.SQL.Add(',SLV.AVERE_RESIDUO AS AVERE');
    // Se invece abbiamo scelto di visualizzare l'importo totale originario della scadenza
  end
  else
  begin
    QryScad.SQL.Add(',SLV.DARE_IMPORTO AS DARE');
    QryScad.SQL.Add(',SLV.AVERE_IMPORTO AS AVERE');
  end;
  QryScad.SQL.Add(',(CASE WHEN (SLV.TIPO=''Scad.passi'') THEN SLV.AVERE_RESIDUO ELSE SLV.DARE_RESIDUO END) AS RESIDUO');
  QryScad.SQL.Add(',(CASE WHEN (SLV.TIPO=''Scad.passi'') THEN SLV.AVERE_IMPORTO ELSE SLV.DARE_IMPORTO END) AS IMPORTO');
  QryScad.SQL.Add
    (',SLV.DOCUMENTO, SLV.SOGGETTO, SLV.TIPO, SLV.BANCA, SLV.ABI, SLV.CAB, SLV.RAGIONESOCIALE, SLV.INDIRIZZO, SLV.CAP, SLV.CITTA, SLV.PROVINCIA, SLV.PartitaIVA');
  QryScad.SQL.Add(',SLV.CLIENTE, SLV.PRATICA, SLV.DATAPRATICA1, SLV.TIPODOC, SLV.NUMDOC, SLV.REGISTRO, SLV.DATADOC, SLV.NOTE, SLV.INSOLUTO');
  QryScad.SQL.Add(',SLV.RIFPRATICA, SLV.AGENTE, SLV.AGENTE2, SLV.AGENTE3, SLV.AGENTE4, SLV.DATAPAGAMENTO, SLV.STATODESCRIZIONE, SLV.RITACC, SLV.RITACCPERC');
  QryScad.SQL.Add(',SLV.TOTALEIMPONIBILE, SLV.IMPORTOPAGATO, SLV.ID');

  // From
  QryScad.SQL.Add('FROM SCAD_LIST_VIEW SLV');

  // Where
  QryScad.SQL.Add('WHERE 1=1');
  // Filtro per tipo di scadenza (attiva o passiva)
  if not TipoScadenze3.Checked[0] then
    QryScad.SQL.Add('AND SLV.TIPO <> ' + QuotedStr('Scad.attiv'));
  if not TipoScadenze3.Checked[1] then
    QryScad.SQL.Add('AND SLV.TIPO <> ' + QuotedStr('Scad.passi'));
  // Se c' una pratica selezionata...
  if PraticaCorrente <> '' then
  begin
    QryScad.SQL.Add('AND SLV.PRATICA = ' + PraticaCorrente + ' AND SLV.DATAPRATICA1 = ' + QuotedStr(DataPraticaCorrenteSQL));
    // Oppure se c' un soggetto selezionato....
  end
  else if ClienteCorrente <> '' then
  begin
    QryScad.SQL.Add('AND SLV.CLIENTE = ' + ClienteCorrente);
  end;
  // Filtro per codice
  if ScadCodice.Text <> '' then
    QryScad.SQL.Add('AND SLV.CODICE = ' + ScadCodice.Text);

  // ==========================================================================
  // FILTRAGGIO PER TESTO DA CERCARE GENERALE
  // --------------------------------------------------------------------------
  if Trim(ScadDescrizione.Text) <> '' then
  begin
    QryScad.SQL.Add('AND (');
    DM1.AggiungiRicercaCampo(QryScad.SQL, 'SLV.RAGIONESOCIALE', ScadDescrizione.Text, False);
    QryScad.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryScad.SQL, 'SLV.NOTE', ScadDescrizione.Text, False);
    QryScad.SQL.Add(')');
  end;
  // ==========================================================================

  // Filtro per tipo (stato) della scadenza
  QryScad.SQL.Add('AND ( (1=2)');
  if TipoScadenze.Checked[0] then
    QryScad.SQL.Add('OR SLV.DARE_RESIDUO > 0 OR SLV.AVERE_RESIDUO > 0');
  if TipoScadenze.Checked[1] then
    QryScad.SQL.Add('OR SLV.DARE_RESIDUO > 0 OR SLV.AVERE_RESIDUO <= 0');
  if TipoScadenze.Checked[2] then
    QryScad.SQL.Add('OR SLV.INSOLUTO = ''T''');
  QryScad.SQL.Add('    )');
  // Filtro per stato
  if ScadStato.Text <> '' then
    QryScad.SQL.Add('AND SLV.STATODESCRIZIONE = ' + QuotedStr(ScadStato.Text));
  // Visualizza solo le RIBA ed eventualmente solo quelle non ancora presentate all'incasso
  if TipoScadenze2.Checked[0] or TipoScadenze2.Checked[1] then
    QryScad.SQL.Add('AND SLV.RICEVUTABANCARIA = ''T''');
  if TipoScadenze2.Checked[1] then
    QryScad.SQL.Add('AND SLV.PRESENTATA = ''/''');
  if TipoScadenze2.Checked[2] then
    QryScad.SQL.Add('AND SLV.RICEVUTABANCARIA <> ''T''');
  // Filtraggio per date
  if ScadTipoData.Text = 'Data di scadenza' then
  begin
    if DM1.ControllaDataStr(ScadDal.EditText) then
      QryScad.SQL.Add('AND SLV.DATASCADENZA >= ' + QuotedStr(FormatDateTime('mm/dd/yyyy', StrToDate(ScadDal.EditText))));
    if DM1.ControllaDataStr(ScadAl.EditText) then
      QryScad.SQL.Add('AND SLV.DATASCADENZA <= ' + QuotedStr(FormatDateTime('mm/dd/yyyy', StrToDate(ScadAl.EditText))));
  end
  else if ScadTipoData.Text = 'Data pagamento' then
  begin
    if DM1.ControllaDataStr(ScadDal.EditText) then
      QryScad.SQL.Add('AND SLV.DATAPAGAMENTO >= ' + QuotedStr(FormatDateTime('mm/dd/yyyy', StrToDate(ScadDal.EditText))));
    if DM1.ControllaDataStr(ScadAl.EditText) then
      QryScad.SQL.Add('AND SLV.DATAPAGAMENTO <= ' + QuotedStr(FormatDateTime('mm/dd/yyyy', StrToDate(ScadAl.EditText))));
  end
  else if ScadTipoData.Text = 'Data documento' then
  begin
    if DM1.ControllaDataStr(ScadDal.EditText) then
      QryScad.SQL.Add('AND SLV.DATADOC >= ' + QuotedStr(FormatDateTime('mm/dd/yyyy', StrToDate(ScadDal.EditText))));
    if DM1.ControllaDataStr(ScadAl.EditText) then
      QryScad.SQL.Add('AND SLV.DATADOC <= ' + QuotedStr(FormatDateTime('mm/dd/yyyy', StrToDate(ScadAl.EditText))));
  end;
  // Fitro per documento
  if ScadTipoDoc.Text <> '' then
    QryScad.SQL.Add('AND SLV.TIPODOC  = ' + QuotedStr(ScadTipoDoc.Text));
  if ScadNumDoc.Text <> '' then
    QryScad.SQL.Add('AND SLV.NUMDOC   = ' + ScadNumDoc.Text);
  if ScadRegistro.Text <> '' then
    QryScad.SQL.Add('AND SLV.REGISTRO = ' + QuotedStr(ScadRegistro.Text));
  if ScadDataDoc.Text <> '' then
    QryScad.SQL.Add('AND SLV.DATADOC  = ' + QuotedStr(FormatDateTime('mm/dd/yyyy', StrToDate(ScadDataDoc.Text))));
  // Filtro per registro (solo o tranne)
  if ScadSoloRegistro.Text <> '' then
    QryScad.SQL.Add('AND SLV.Registro = ' + QuotedStr(ScadSoloRegistro.Text));
  if ScadTranneRegistro.Text <> '' then
    QryScad.SQL.Add('AND SLV.Registro <> ' + QuotedStr(ScadSoloRegistro.Text));
  // Filtro per banca di presentazione
  if ScadPresentataBanca.Text <> '' then
    QryScad.SQL.Add('AND SLV.PRESENTATABANCA = ' + QuotedStr(ScadPresentataBanca.Text));
  // Agenti
  if ScadAgente.Text <> '' then
    DM1.AddSQL(QryScad, 'AND', 'SLV.AGENTE  = ' + QuotedStr(ScadAgente.Text));
  if ScadAgente2.Text <> '' then
    DM1.AddSQL(QryScad, 'AND', 'SLV.AGENTE2 = ' + QuotedStr(ScadAgente2.Text));
  if ScadAgente3.Text <> '' then
    DM1.AddSQL(QryScad, 'AND', 'SLV.AGENTE3 = ' + QuotedStr(ScadAgente3.Text));
  if ScadAgente4.Text <> '' then
    DM1.AddSQL(QryScad, 'AND', 'SLV.AGENTE4 = ' + QuotedStr(ScadAgente4.Text));
  // ======================================================================

  // ======================================================================
  // QUERY PER I TOTALI
  // ----------------------------------------------------------------------
  QryTotScad.Close;
  QryTotScad.SQL.Clear;
  QryTotScad.SQL.Add('SELECT');
  QryTotScad.SQL.Add(' SUM(SLV.IMPORTOPAGATO) AS TOTIMPORTOPAGATO');
  QryTotScad.SQL.Add(',SUM(SLV.RITACC) AS TOTRITACC');
  // Abbiamo scelto di visualizzare il residuo da pagare
  if TipoImporto.Checked[0] then
  begin
    QryTotScad.SQL.Add(',SUM(SLV.DARE_RESIDUO) AS DARE');
    QryTotScad.SQL.Add(',SUM(SLV.AVERE_RESIDUO) AS AVERE');
    // De invece abbiamo scelto di visualizzare l'importo totale originario della scadenza
  end
  else
  begin
    QryTotScad.SQL.Add(',SUM(SLV.DARE_IMPORTO) AS DARE');
    QryTotScad.SQL.Add(',SUM(SLV.AVERE_IMPORTO) AS AVERE');
  end;
  QryTotScad.SQL.Add('FROM SCAD_LIST_VIEW SLV');
  // Aggiunge le clausole where prendendole dalla queryScad in modo che siano
  // assolutamente uguali
  for I := 10 to QryScad.SQL.Count - 1 do
    QryTotScad.SQL.Add(QryScad.SQL[I]);
  // ======================================================================

  // ======================================================================
  // APERTURA DELLE QUERY E AGGIORNAMENTO DEI TOTALI
  // ----------------------------------------------------------------------
  // Azzera le variabili temporanee usate per il calcolo dei saldi
  SaldoTmp := 0;
  SaldoPagato := 0;
  SaldoRitAcc := 0;
  // Se non sono selezionate ne le scadenze attive ne le passive non apre alcuna query
  if TipoScadenze3.Checked[0] or TipoScadenze3.Checked[1] then
  begin
    // Apre la query
    // QryScad.SQL.SaveToFile('c:\sql.sql');
    QryScad.Open;
    // Aggiorna il totale numero scadenze presenti
    TotNumScad.Caption := IntToStr(QryScad.RecordCount);
    // Aggiorna i totali delle scadenze
    // QryTotScad.SQL.SaveToFile('c:\sql.sql');
    QryTotScad.Open;
    SaldoTmp := QryTotScad.FieldByName('DARE').AsFloat - QryTotScad.FieldByName('AVERE').AsFloat;
    SaldoPagato := QryTotScad.FieldByName('TOTIMPORTOPAGATO').AsFloat;
    SaldoRitAcc := QryTotScad.FieldByName('TOTRITACC').AsFloat;
  end;
  // Aggiorna i totali a video
  Saldo.Value := SaldoTmp;
  DbeTotPagato.Value := SaldoPagato;
  dbeScadTotRitAcc.Value := SaldoRitAcc;
  // Si posizione all'inizio
  tvScad.DataController.GotoFirst;
  // ======================================================================

  // ======================================================================
  // VISUALIZZAZIONE DIVERSA (RAGGRUPPATA) SE CI SONO CORRISP. NO PAG.
  // ----------------------------------------------------------------------
  // Se ci sono dei corrispettivi non pagati...
  if tvScad.DataController.FindRecordIndexByText(0, tvScadTIPOLOGIA.Index, 'Corrispettiv', True, True, True) <> -1 then
  begin
    tvScadTIPOLOGIA.GroupIndex := 0;
    tvScad.ViewData.Expand(False);
    // Se NON ci sono dei corrispettivi non pagati
  end
  else
  begin
    tvScadTIPOLOGIA.GroupIndex := -1;
  end;
  // ======================================================================

end;

procedure TClientiForm.RxSpeedButtonUscitaClick(Sender: TObject);
begin
  // Se siamo in modelit Levante Light esce subito
  if MainForm.IsLevanteLight then
  begin
    // MainForm.FormFadeOut(MainForm);
    Close;
    Exit;
  end;
  // Se c' un cliente o una pratica selezionata la deseleziona prima di uscire.
  if ID_ClienteCorrente <> -1 then
    MainForm.SSChiudiClick(Self)
  else
  begin
    // Se non  nei soggetti, prima torna nei soggetti
    if PageControl2.ActivePage = TabClienti then
    begin
      Close;
    end
    else
    begin
      MainForm.SBRubricaClick(MainForm.SBRubrica);
    end;
  end;
end;

// Procedura che elimina gli impegni selezionati
procedure TClientiForm.EliminaImpegniSelezionati;
var
  DocType, Registro, LMessage: String;
  DocNum, I: Integer;
  DocDate: TDate;
begin
  // Chiede conferma per l'eliminazione (se non ci sono voci eselezionate esce)
  if tvImpegni.Controller.SelectedRecordCount = 1 then
    LMessage := Format('Elimina %s', [tvImpegni.Controller.SelectedRecords[0].Values[tvImpegni.GetColumnByFieldName('TIPOIMPEGNO').Index]])
  else if tvImpegni.Controller.SelectedRecordCount > 1 then
    LMessage := Format('Elimina %d impegni', [tvImpegni.Controller.SelectedRecordCount])
  else
    Exit;
  // Chiede prima conferma
  if TConfirmForm.ConfirmationRequest(LMessage, Format('Per confermare digita "%s", poi clicca sul bottone "Conferma".', [LMessage]), LMessage, 600, 300) then
  begin
    DM1.DBAzienda.StartTransaction;
    DM1.ShowWait('Levante', 'Operazione in corso...');
    try
      try
        // Cicla per tutti i righi selezionati
        for I := (tvImpegni.Controller.SelectedRecordCount - 1) downto 0 do
        begin
          // Lasciare la rica qui sotto altrimenti da dei problemi
          tvImpegni.Controller.SelectedRecords[I].Focused := True;
          // Assegna il tipo, numero, data e registro del documento a delle variabili locali per comodit successiva
          DocType := tvImpegni.Controller.SelectedRecords[I].Values[tvImpegni.GetColumnByFieldName('TIPOIMPEGNO').Index];
          Registro := tvImpegni.Controller.SelectedRecords[I].Values[tvImpegni.GetColumnByFieldName('REGISTRO').Index];
          DocNum := tvImpegni.Controller.SelectedRecords[I].Values[tvImpegni.GetColumnByFieldName('ID').Index];
          // NB: La data non viene usata per eliminare gli impegni e quindi la imposta ad un valore arbitrario
          DocDate := StrToDate('01/01/1900');
          // Controlla i permessi per l'eliminazione
          // ed elimina l'eventuale documento collegato (INTERVENTI)
          if (DM1.ModCtrl(MOD_CONTATTI) > 1) then
            DM1.EliminaImpegno(QryImp, DocType, Registro, DocNum);
        end;
        DM1.DBAzienda.Commit;
        // Se  visibile l'agenda laterale la aggiorna
        if Assigned(fAgendaForm) and (fAgendaForm.Splitter.State = ssOpened) then
          fAgendaForm.EseguiQueryAgenda;
      except
        DM1.DBAzienda.Rollback;
        raise;
      end;
    finally
      DM1.CloseWait;
    end;
  end;
end;

procedure TClientiForm.RxSpeedButtonEliminaClick(Sender: TObject);
var
  DocType, ExtDocType, Registro, LMessage: String;
  DocNum, SelRec, DocID, LNumScadDoc: Integer;
  DocDate: TDate;
begin
  // In base alla pagina selezionata...
  // Se il database  gi in transazione e quindi significa che c' stato qualche problema
  // a qualche transazione precedente che potrebbe causare una perdita di dati. Quindi
  // avverte l'utente e lo informa che ilprogramma si chideer automaticamente.
  if (DM1.DBAzienda.InTransaction) and ((not Assigned(TabGCForm)) or (Assigned(TabGCForm) and (not RxSpeedModifica.Down))) then
  begin
    // Verifica che non ci siano gi transazioni in atto e se ci sono lanca un allarme
    DM1.CheckForAlreadyInTransaction;
  end;

  // ==========================================================================
  // ELIMINA EVENTI AGENDA LATERALE
  // --------------------------------------------------------------------------
  if Assigned(fAgendaForm) then
  begin
    // Se siamo in modalit FastSelection e nell'agenda laterale ci sono degli eventi
    // selezionati e l'agenda  Focused elimina quegli eventi dall'agenda stessa
    if (fAgendaForm.MainPageControl.ActivePage = fAgendaForm.TabAgenda) and Agenda_EventiSelezionatiPresenti and fAgendaForm.Agenda_FastSelectionMode.Focused
    then
    begin
      fAgendaForm.EliminaEventiSelezionati;
      Exit;
      // Se invece siamo sempre in FastSelectionMode e per siamo nei tasks e ci sono
      // dei tasks selezionati
    end
    else if (fAgendaForm.MainPageControl.ActivePage = fAgendaForm.TabTasks) and Agenda_TasksSelezionatiPresenti and fAgendaForm.GridTasks.IsFocused then
    begin
      // Conferma
      if DM1.Messaggi('Elimina Task', 'Sei sicuro di voler eliminare il Task?', '', [mbYes, mbNo], 0, nil) <> mrYes then
        Exit;
      try
        DM1.ShowWait('Levante', 'Sto comunicando con Google Tasks...');
        fAgendaForm.Task_DeleteFocusedTask;
        Exit;
      finally
        DM1.CloseWait;
      end;
    end;
  end;
  // ==========================================================================

  // --------------- CLIENTI ---------------------
  if PageControl2.ActivePage = TabClienti then
  begin
    QrySoggetti.Delete
  end
  // --------------- DOCUMENTI ---------------------
  else if PageControl2.ActivePage = TabDocumenti then
  begin
    // Solo un documento alla volta
    if tvDoc.Controller.SelectedRecordCount > 1 then
      raise Exception.Create('E'' possibile eliminare un solo documento alla volta!');
    // Assegna il tipo, numero, data e registro del documento a delle variabili locali per comodit successiva
    DocID := QryDocID.AsInteger;
    DocType := QryDocTIPODOC.AsString;
    ExtDocType := QryDocTIPODOCESTESO.AsString;
    DocNum := QryDocCODICEDOC.AsInteger;
    Registro := QryDocREGISTRO.AsString;
    DocDate := QryDocDATADOC.AsDateTime;

    // Se  una fattura elettronica attiva o passiva verifica prima se  possibile la sua eliminazion
    // oppure no
    if not TFatturaPA.CanDelete(DocType, QryDocFE_STATUS_EXT.AsString) and not TConfirmForm.AuthorizationRequest('Documento non eliminabile',
      'Il documento non pu essere eliminato perch inviato all''S.D.I.', 'th3cla') then
      Exit;

    // Chiede conferma per l'eliminazione
    if not TConfirmForm.ConfirmationRequest(Format('Elimina %s %d', [ExtDocType, DocNum]),
      Format('Per confermare digita "elimina %s %d", poi clicca sul bottone "Conferma".', [ExtDocType, DocNum]), Format('elimina %s %d%', [ExtDocType, DocNum]),
      600, 300) then
      Exit;

    // Se ci sono delle scadenze relative al documento che si sta eliminando avvissa l'utente e chiede conferma
    LNumScadDoc := DM1.NumScadenzeDocumento(DocType, Registro, DocNum, DocDate);
    if (LNumScadDoc > 0) and not TConfirmForm.ConfirmationRequest(Format('ATTENZIONE, %d scadenze presenti', [LNumScadDoc]),
      Format('Ci sono %d scadenze collegate al documento che si vuole eliminare (%s %d).'#13#13'Se si prosegue anche tali scadenze saranno definitivamente cancellate.'#13#13'Digitare "elimina %s %d e le sue scadenze", poi clicca sul bottone "Conferma" per continuare.',
      [LNumScadDoc, ExtDocType, DocNum, ExtDocType, DocNum]), Format('elimina %s %d e le sue scadenze', [ExtDocType, DocNum]), 800, 400) then
      Exit;

    // Controlla i permessi per l'eliminazione ed elimina il documento
    if ((DocType = 'Preventivo') or (DocType = 'Ordine') or (DocType = 'S.A.L.') or (DocType = 'D.D.T.') or (DocType = 'Fattura') or (DocType = 'Nota_accre') or
      (DocType = 'Ord.fornit') or (DocType = 'Bolla_entr') or (DocType = 'Fatt.acqui') or (DocType = 'Ricev.fisc') or (DocType = 'Fatt.R.F.') or
      (DocType = 'Buono_cons') or (DocType = 'N.C.fornit') or (DocType = 'Commessa') or (DocType = 'Carico_cantiere') or (DocType = 'Scarico_cantiere') or
      (DocType = 'Estratto_conto') or (DocType = 'Intervento')) and (DM1.ControllaDocumento(DocType) > 1) then
      DM1.EliminaDocFisc(QryDoc, DocType, Registro, DocNum, DocDate)
    else if (DocType = 'Lettera') and (DM1.ModCtrl(MOD_TESTI) > 1) then
      DM1.EliminaTesto(QryDoc, DocNum, DocDate)
// NB: COmmentato perch altrimenti dava fastidio perch non si riusciva ad eliminare
//      un documento LDE "Contratto noleggio" di F.lli Giannetti
//    else if (DM1.StrLeft(DocType, 4) = 'Cont') and (DM1.ModCtrl(MOD_CONTATTI) > 1) then
//      DM1.EliminaContatto(QryDoc, DocNum, DocDate)
    else if (DocType = 'Doc.esterno') and (DM1.ModCtrl(MOD_EXT_FILE) > 1) then
      DM1.EliminaExtFile(QryDoc, DocNum, DocDate)
    else if (DocType = 'Conformita') and (Registro = 'OLD') and (DM1.ModCtrl(MOD_CONFORMITA) > 1) then
      DM1.EliminaConformitaOld(QryDoc, DocNum, DocDate)
    else if (DocType = 'Tracciato') and (DM1.ModCtrl(MOD_CEFALOMETRIE) > 1) then
      DM1.EliminaTracciato(QryDoc, DocNum, DocDate)
    else if (DocType = 'Rapp.giorn.') and (DM1.ModCtrl(MOD_GIORNALE_CANTIERE) > 1) then
      DM1.EliminaRapportoGiornaliero(QryDoc, Registro, DocNum, DocDate)
    else if (DM1.ModCtrl(MOD_CONFORMITA) > 1) then
      DM1.EliminaLDE(QryDoc, DocID);
  end
  // --------------- GIORNALE DI CANTIERE ---------------------
  else if (PageControl2.ActivePage = TabGC) and (Assigned(TabGCForm)) then
  begin
    TabGCForm.EliminaButtonClick(Sender);
    // --------------- CONDIZIONI DI VENDITA ---------------------
  end
  else if PageControl2.ActivePage = TabCondVend then
  begin
    MessageBeep(0);
    tvCV.Controller.DeleteSelection;
    // --------------- ARTICOLI ---------------------
  end
  else if PageControl2.ActivePage = TabArticoli then
  begin
    // Chiede conferma per l'eliminazione (se non ci sono voci eselezionate esce)
    if tvArt.Controller.SelectedRecordCount = 1 then
      LMessage := 'Elimina articolo'
    else if tvArt.Controller.SelectedRecordCount > 1 then
      LMessage := Format('Elimina %d articoli', [tvArt.Controller.SelectedRecordCount])
    else
      Exit;
    if not TConfirmForm.ConfirmationRequest(LMessage, Format('Per confermare digita "%s", poi clicca sul bottone "Conferma".', [LMessage]), LMessage, 600, 300)
    then
      Exit;
    tvArt.Controller.DeleteSelection;
  end
  // --------------- PRATICHE ---------------------
  else if PageControl2.ActivePage = TabPratiche then
  begin
    QryPratiche.Delete
  end
  // --------------- ASSISTENZE ---------------------
  else if PageControl2.ActivePage = TabAssistenze then
  begin
    TabImpiantiForm.EliminaButtonClick(Sender);
    // --------------- COMUNICAZIONI ---------------------
  end
  else if PageControl2.ActivePage = TabComunicazioni then
  begin
    TabComunicazioniForm.EliminaButtonClick(Sender);
    // --------------- IMPEGNI ---------------------
  end
  else if PageControl2.ActivePage = TabImpegni then
  begin
    EliminaImpegniSelezionati;
    // --------------- PRIMANOTA ---------------------
  end
  else if PageControl2.ActivePage = TabPrimanota then
  begin
    // Chiede conferma per l'eliminazione (se non ci sono voci eselezionate esce)
    if tvPrimanota.Controller.SelectedRecordCount = 1 then
      LMessage := 'Elimina primanota'
    else if tvPrimanota.Controller.SelectedRecordCount > 1 then
      LMessage := Format('Elimina %d primanota', [tvPrimanota.Controller.SelectedRecordCount])
    else
      Exit;
    if not TConfirmForm.ConfirmationRequest(LMessage, Format('Per confermare digita "%s", poi clicca sul bottone "Conferma".', [LMessage]), LMessage, 600, 300)
    then
      Exit;
    tvPrimanota.Controller.DeleteSelection;
    // --------------- AGENDA ---------------------
  end
  else if PageControl2.ActivePage = TabAgenda then
  begin
    MessageBeep(0);
    if DM1.Messaggi('Elimina impegni', 'Eliminare gli impegni selezionati?', '', [mbYes, mbNo], 0, nil) = mrYes then
    begin
      if not InterventiNellaSelezione then
      begin
        Agenda.DeleteSelectedEvents;
      end
      else
      begin
        DM1.Messaggi('Elimina impegno agenda', 'Non  possibile eliminare gli Interventi dall''agenda',
          'NB: Per eliminare gli interventi andare nell''elenco dei documenti.', [mbOk], 0, nil);
      end;
    end;
    // --------------- SCADENZE ---------------------
  end
  else if PageControl2.ActivePage = TabScadenze then
  begin
    // Chiede conferma per l'eliminazione (se non ci sono voci eselezionate esce)
    if tvScad.Controller.SelectedRecordCount = 1 then
      LMessage := 'Elimina scadenza'
    else if tvScad.Controller.SelectedRecordCount > 1 then
      LMessage := Format('Elimina %d scadenze', [tvScad.Controller.SelectedRecordCount])
    else
      Exit;
    if not TConfirmForm.ConfirmationRequest(LMessage, Format('Per confermare digita "%s", poi clicca sul bottone "Conferma".', [LMessage]), LMessage, 600, 300)
    then
      Exit;
    tvScad.Controller.DeleteSelection;
  end;
end;

// Funzione che ritorna True se c' almeno un intervento tra gli impegni selezionati
// in modo da impedire l'eliminazione degli interventi dall'agenda per sicurezza.
function TClientiForm.InterventiNellaSelezione: Boolean;
var
  I: Integer;
begin
  Result := False;
  for I := 0 to Agenda.SelectedEventCount - 1 do
  begin
    if DM1.IsIntervento(Agenda.SelectedEvents[I].ID) then
      Result := True;
  end;
end;

procedure TClientiForm.FormCreate(Sender: TObject);
begin
  DM1.ShowWait('', 'Caricamento tema');
  try
    // IMposta i settaggi di visualizzazione della form
    MainForm.CaricaTemaClientForm(Self, ClientTopPanel, RxSpeedButtonUscita, RxSpeedButtonHelp, RxSpeedModifica, RxSpeedButtonNuovo, RxSpeedButtonElimina,
      RxSpeedButtonTrova, RxSpeedButtonResetQuery, RxSpeedButtonStampa, RxSpeedButtonFax, RxSpeedButtonMail, RxSpeedButtonVisualizza, False);
    // IMposta la caption della form in base al nome del programma impostato nella variabile 'NomeApplicazione'
    Caption := MainForm.NomeApplicazione + ' - (Schedario soggetti/documenti)';
    // Imposta le dimensioni del PageControl in modo che spariscano alla vista sia
    // i Tabs che i bordi.
    // Ricalcola anche tutte le dimensioni dei vari pannelli con gli elenchi
    RicalcolaDimensioni;
    // Imposta i colori e poco altri dei vari pannelli
    PanelRubrica.Color := Color;
    PanelDoc.Color := Color;
    PanelArticoli.Color := Color;
    PanelGM.Color := Color;
    PanelCV.Color := Color;
    PanelPratiche.Color := Color;
    PanelScadenze.Color := Color;
    PanelImpegni.Color := Color;
    PanelPrimanota.Color := Color;
    PanelAgenda.Color := Color;
    PanelGOS.Color := Color;
    PanelGOS.Align := alClient;
    PanelGosSpese.Color := Color;
    PanelGosSpese.Align := alClient;

    // Caricamento bitmaps pulsanti apertura/chiusura filtri
    if MainForm.IsLevanteLight then
    begin
      OpenFilterPanel(PanelDocFiltri, SBDocFilterOpenClose);
      OpenFilterPanel(PanelFiltri, SBArtFilterOpenClose);
    end
    else
    begin
      CloseFilterPanel(PanelFiltriSogg, SBRubricaFilterOpenClose, False);
      CloseFilterPanel(PanelDocFiltri, SBDocFilterOpenClose, False);
      CloseFilterPanel(PanelGMFiltri, SBGMFilterOpenClose, False);
      CloseFilterPanel(PanelPratFiltri, SBPratFilterOpenClose, False);
      CloseFilterPanel(PanelScadFiltri, SBScadFilterOpenClose, False);
      CloseFilterPanel(PanelPrimanotFiltri, SBPrimanotFilterOpenClose, False);
      CloseFilterPanel(PanelFiltri, SBArtFilterOpenClose, False);
      CloseFilterPanel(PanelImpFiltri, SBImpFilterOpenClose, False);
      CloseFilterPanel(PanelGosFiltri, SBGosFilterOpenClose, False);
      CloseFilterPanel(PanelSpeseFiltri, SBGosSpeseFilterOpenClose, False);
    end;

    // Per default il pannello con le chiamate nell'agenda  chiuso
    SplitterAgendaRight.CloseSplitter;

    // Inizializza alcune variabili
    ID_ClienteCorrente := -1;
    ID_PraticaCorrente := 0;
    PraticaCorrente := '';
    DataPraticaCorrenteSQL := '';
    ClienteCorrente := '';
    FidoConcesso := 0;

    // Imposta la query dei totali documenti
    // ImpostaQueryTotDoc;
    // Per sicurezza svuota TabLettera
    TabLettera.Text := '';
    // Preseleziona la rubrica
    PageControl2.ActivePage := TabClienti;
    PageControlClienti.ActivePage := TabClientiElenco;
    PageControlPratiche.ActivePage := TabPraticheElenco;
    PageControlImpegni.ActivePage := TabImpegniElenco;
    PageControlGM.ActivePage := TabGMGrid;
    PageControlDoc.ActivePage := TabSheetDocGrid;
    PageControlScad.ActivePage := TabScadElenco;
    // Inizializzazioni
    GosOrePivotTmpDataset := nil;

    // Inizializzazione riguardante il drag and drop di files  dal desktop
    // di windows.
    FOriginalPanelWindowProc_Documenti := GridDoc.WindowProc;
    GridDoc.WindowProc := GridDocWindowProc;
    DragAcceptFiles(GridDoc.Handle, True);

    // Crea il men "Aggiungi"
    Application.CreateForm(TMenuAggiungiForm, MenuAggiungiForm);
  finally
    DM1.CloseWait
  end;
end;

procedure TClientiForm.RicalcolaDimensioni;
begin
  // Posizionamento del FormMainPanel
  FormMainPanel.Left := CLIENT_LEFT_BORDER;
  FormMainPanel.Top := CLIENT_TOP_BORDER;
  FormMainPanel.Height := Self.Height - CLIENT_TOP_BORDER - CLIENT_BOTTOM_BORDER; // + 5;
  FormMainPanel.Width := Self.Width - CLIENT_LEFT_BORDER - CLIENT_RIGHT_BORDER + SplitterAgendaRight.Width;
  if not DM1.FastSelectionMode then
    FormMainPanel.Width := FormMainPanel.Width - SplitterAgendaRight.Width; // Altrimenti il bordo dx  pi a destra di prima
  // Imposta le dimensioni del PageControl in modo che spariscano alla vista sia
  // i Tabs che i bordi.
  PageControl2.Left := -4;
  PageControl2.Top := -25;
  PageControl2.Width := ClientArea.Width + 8;
  PageControl2.Height := ClientArea.Height + 29;
end;

procedure TClientiForm.Rifiutatadalprovider1Click(Sender: TObject);
begin
  CreaNotificaDemoFE('rtRejectedByProvider', '', '', 'Rifiutata dal provider', '', False, 0);
end;

procedure TClientiForm.FormShow(Sender: TObject);
begin
  // Impostazione pulsante di importazione dal terminale barcode
  MainForm.ControllaAbilitazioneImportazionePalmare;
  // Rende visibilie o invisibili i pulsanti del men principale in base
  // ai all'attivazione o meno dei moduli sulla chiave.
  DM1.ShowWait('Levante', 'Controllo men principale');
  MainForm.CheckMainMenu;
  // Abilita il men principale
  DM1.ShowWait('Levante', 'Attivazione men principale');
  MainForm.AbilitaMainMenu;
  // Caricamento delle impostazioni di visualizzazione delle griglie
  if not MainForm.IsLevanteLight then
  begin
    DM1.ShowWait('Levante', 'Caricamento pre-impostazioni griglie.');
    DM1.RipristinaDevExpress(GridSogg, '', False);
    DM1.RipristinaDevExpress(GridDoc, '', False);
    DM1.RipristinaPivotDevExpress(PivotGridDoc, '');
    DM1.RipristinaDevExpress(GridGM, '', False);
    DM1.RipristinaPivotDevExpress(PivotGridGM, '');
    DM1.RipristinaDevExpress(GridCV, '', False);
    DM1.RipristinaDevExpress(GridPrat, '', False);
    DM1.RipristinaDevExpress(GridScad, '', False);
    DM1.RipristinaPivotDevExpress(PivotGridScad, '');
    DM1.RipristinaDevExpress(GridArt, '', False);
    DM1.RipristinaDevExpress(GridImpegni, '', False);
    DM1.RipristinaDevExpress(GridPrimanota, '', False);
    DM1.RipristinaDevExpress(GridOre, '', False);
    DM1.RipristinaDevExpress(GridSpese, '', False);
    DM1.RipristinaPivotDevExpress(GosOrePivot, '');
    DM1.RipristinaPivotDevExpress(GosSpesePivot, '');
  end;
  // Carica il layout della form
  DM1.ShowWait('Levante', 'Caricamento form layout');
  CaricaFormLayout;
  DM1.FocusRefresh;
  // IMposta la visibilit o meno di alcune voci di men o filtri relativi
  // agli impegni
  ImpTipoIMpegno.Visible := DM1.VisualizzaFiltroTipoImpegno;
  BordoImpTipoIMpegno.Visible := DM1.VisualizzaFiltroTipoImpegno;
  ImpTipoIntervento.Visible := DM1.VisualizzaFiltroTipoIntervento;
  BordoImpTipoIntervento.Visible := DM1.VisualizzaFiltroTipoIntervento;
  ImpConCantiere.Visible := DM1.VisualizzaFiltroImpiantoNoImpianto;
  BordoImpConCantiere.Visible := DM1.VisualizzaFiltroImpiantoNoImpianto;
  // IMposta la scritta che compare sulla griglia quando non ci sono dati da
  // visualizzare
  cxSetResourceString(@scxGridNoDataInfoText, 'Nessun dato da visualizzare');

  // Ridimensiona la GridSogg in modo da modificare il bordo nero che ha attorno
  // NB E' stata messa qu perch nell'evento OnCreate non funziona correttamente.
  // NB: DEVE ESSERE ASSOLUTAMENTE DOPO LE RIGHE CHE FORZANO IL TAB ATTIVO A QUELLO DEI SOGGETTI
  GridSogg.Width := PanelGridSogg.Width - 0;
  GridSogg.Height := PanelGridSogg.Height - PanelFiltriSogg.Height - 3;
  // Imposta i filtri di default
  // DM1.ShowWait('Levante', 'Inizializzazione filtri');
  PageControl2Change(Self);
  // Ripristina il magazzino di default
  CaricaMagazzinoDefaultArticoli;
  // IMposta i tabs di default nel giornale ore spese GOS
  cxPageControlGOS.ActivePage := TabManodopera;
  cxPageControlGOSOre.ActivePage := TabGOSOreElenco;
  cxPageControlGOSSpese.ActivePage := TabGOSSpeseElenco;
  // CHiude i messaggi a video
  DM1.CloseWait;

  // Se  abilitato il modulo delle condizioni di vendita, verifica che il flag PrezziNetti sia impostato a True in quanto
  // comunque se fosse False il programma si comporterebbe come se non lo fosse per un coflitto fra i prezzi non netti
  // e la funzione 'AggiornaCondVendArticolo' quindi se cos fosse forzerebbe il flag a True avvertendo l'utente.
  if (DM1.ModCtrl(MOD_CONDIZIONI_VENDITA) > 0) and not DM1.PrezziNetti then
  begin
    DM1.Messaggi('Informazione',
      'Il modulo ''Condizioni di Vendita''  attivato ma il flag ''Prezzi Netti'' non lo .'#13#13#13'Se le Condizioni di Vendita sono attive  INDISPENSABILE che anche i Prezzi Netti lo siano, quindi il programma considerer automaticamente abilitati anche i Prezzi Netti',
      'NB: Si consiglia di chiamare il CENTRO SERVIZI per eliminare il problema.', [mbOk], 0, nil);
    DM1.PrezziNetti := True;
  end;
  // Visualizza o meno i totali relativi alla ritenuta d'acconto in base
  // alla visualizzazione o meno delle relative colonne
  ControllaSeVisualizzareTotaliRitenuteAcconto;

  // Rebde visibile sempre l'elenco dei documneti principale
  GridDoc.FocusedView := tvDoc;
  // Rende visibile la pagina degli "altri documenti" separati se abilitati
  if DM1.TableProgressiviALTRIDOCINELENCOSEPARATO.AsString = 'T' then
  begin
    GridDoc.RootLevelOptions.DetailTabsPosition := dtpTop;
    PanelExpandCollapseDoc.Top := 34;
  end
  else
  begin
    GridDoc.RootLevelOptions.DetailTabsPosition := dtpNone;
    PanelExpandCollapseDoc.Top := 8;
  end;

  // Effettua il controllo dell'abilitazione dei documenti
  ControllaAbilitazioneDocumenti;
  // Rende subito visibile la pagina impostata nel layouts.ini
  VaiAlTabDopoAvvio;

  // Massimizza la schermata
  MainForm.WindowState := wsMaximized;

  // Decide se gli allegati devono essere gi visibili oppure no.
  Allegati_VerificaAbilitazione;
  // Verifica e creazione form AgendaSlide
  Agenda_VerificaAbilitazione;
  GetAgenda.EventOperations.Moving := (DM1.ModCtrl(MOD_AGENDA) > 1);
  GetAgenda.EventOperations.Sizing := (DM1.ModCtrl(MOD_AGENDA) > 1);

  // Verifica scadenze veicoli
  DM2.Automezzi_VerificaScadenze;

  // Crea le vodi del men "Aggiungi" e i relativi filtri per i documenti basati su LDE
  if (DM1.ModCtrl(MOD_CONFORMITA) > 1) then
    TddtFactory.LDEDocTypesInit;
end;

procedure TClientiForm.RxSpeedButtonTrovaClick(Sender: TObject);
begin
  try
    DM1.ShowWait('Levante', 'Attendere...');
    // In base alla pagina selezionata avvia la query appropriata
    if PageControl2.ActivePage = TabClienti then
    begin
      EseguiQueryClienti;
      if (PageControlClienti.ActivePage = TabClientiElenco) and GridSogg.Visible and GridSogg.Enabled then
        GridSogg.SetFocus;
    end
    else if PageControl2.ActivePage = TabDocumenti then
    begin
      // Se non c' nessun tipo di documento selezionato, li seleziona tutti prima di continuare
      if NessunDocumentoSelezionato then
        SBDocTuttiClick(Self);
      // Esegue le query per trovare i documenti selezionati
      TrovaDocumentiSelezionati2;
      if (PageControlDoc.ActivePage = TabSheetDocGrid) and GridDoc.Visible and GridDoc.Enabled then
        GridDoc.SetFocus;
    end
    else if PageControl2.ActivePage = TabMagazzino then
    begin
      // Controlla che sia selezionato almeno un tipo di movimento, altrimenti non f nulla
      // e visualizza un messaggio di errore
      if CLBSegnoOpMagazzino.Checked[0] or CLBSegnoOpMagazzino.Checked[1] or CLBSegnoOpMagazzino.Checked[2] or CLBSegnoOpMagazzino.Checked[3] or
        CLBSegnoOpMagazzino.Checked[4] or CLBSegnoOpCantiere.Checked[0] or CLBSegnoOpCantiere.Checked[1] or CLBSegnoOpCantiere.Checked[2] or
        CLBSegnoOpCantiere.Checked[3] or CLBSegnoOpCantiere.Checked[4] then
      begin
        // Se non c' nessun tipo di documento selezionato, li seleziona tutti prima di continuare
        if GMNessunDocumentoSelezionato then
          SBGMTuttiClick(Self);
        // Eseqgue la query
        EseguiQueryGM;
        if (PageControlGM.ActivePage = TabGMGrid) and GridGM.Visible and GridGM.Enabled then
          GridGM.SetFocus;
      end
      else
      begin
        MessageBeep(0);
        MessageDlg('Deve esserci almeno un TIPO MOVIMENTO selezionato.'#13#13'Non sar effettuata alcuna ricerca.', mtInformation, [mbOk], 0);
      end;
    end
    else if PageControl2.ActivePage = TabGOS then
    begin
      // Se  selezionata la pagine delle ore dei dipendenti...
      if cxPageControlGOS.ActivePage = TabManodopera then
      begin
        EseguiQueryGOSOre;
        // PopolaGraficoOreGOS;
        if (cxPageControlGOSOre.ActivePage = TabGOSOreElenco) and GridOre.Visible and GridOre.Enabled then
          GridOre.SetFocus;
        // Se  selezionata la pagine delle spese varie...
      end
      else if cxPageControlGOS.ActivePage = TabSpese then
      begin
        EseguiQueryGOSSpese;
        // PopolaGraficoSpeseGOS;
        if (cxPageControlGOSSpese.ActivePage = TabGOSSpeseElenco) and GridSpese.Visible and GridSpese.Enabled then
          GridSpese.SetFocus;
      end;
    end
    else if PageControl2.ActivePage = TabGC then
    begin
      TabGCForm.TrovaButtonClick(Sender);
      // NB: Riga disabilitata perch altrimenti dava un errore "Cannot focus an invisible or disabled component"
      // if TabGCForm.GridGC.Visible and TabGCForm.GridGC.Enabled then TabGCForm.GridGC.SetFocus;
    end
    else if PageControl2.ActivePage = TabResOrd then
    begin
      TagResOrdForm.TrovaButtonClick(Sender);
      if TagResOrdForm.GridResOrd.Visible and TagResOrdForm.GridResOrd.Enabled then
        TagResOrdForm.GridResOrd.SetFocus;
    end
    else if PageControl2.ActivePage = TabCondVend then
    begin
      // Controlla che sia selezionato almeno un tipo di movimento, altrimenti non f nulla
      // e visualizza un messaggio di errore
      if TipoCondizione.Checked[1] or TipoCondizione.Checked[2] then
      begin
        EseguiQueryCV;
        if GridCV.Visible and GridCV.Enabled then
          GridCV.SetFocus;
      end
      else
      begin
        MessageBeep(0);
        MessageDlg('Deve esserci almeno un TIPO CONDIZIONE selezionato.'#13#13'Non sar effettuata alcuna ricerca.', mtInformation, [mbOk], 0);
      end;
    end
    else if PageControl2.ActivePage = TabArticoli then
    begin
      EseguiQueryArticoli;
      if GridArt.Visible and GridArt.Enabled then
        GridArt.SetFocus;
    end
    else if PageControl2.ActivePage = TabPratiche then
    begin
      EseguiQueryPratiche;
      if (PageControlPratiche.ActivePage = TabPraticheElenco) and GridPrat.Visible and GridPrat.Enabled then
        GridPrat.SetFocus;

    end
    else if PageControl2.ActivePage = TabAssistenze then
    begin
      TabImpiantiForm.TrovaButtonClick(Sender);

    end
    else if PageControl2.ActivePage = TabComunicazioni then
    begin
      TabComunicazioniForm.TrovaButtonClick(Sender);

    end
    else if PageControl2.ActivePage = TabImpegni then
    begin
      EseguiQueryImpegni;
      if (PageControlImpegni.ActivePage = TabImpegniElenco) and GridImpegni.Visible and GridImpegni.Enabled then
        GridImpegni.SetFocus;
    end
    else if PageControl2.ActivePage = TabPrimanota then
    begin
      EseguiQueryPrimanota;
      if GridPrimanota.Visible and GridPrimanota.Enabled then
        GridPrimanota.SetFocus;
    end
    else if PageControl2.ActivePage = TabScadenze then
    begin
      EseguiQueryScadenze;
      if GridScad.Visible and GridScad.Enabled and (PageControlScad.ActivePage = TabScadElenco) then
        GridScad.SetFocus;
    end
    else if PageControl2.ActivePage = TabAgenda then
    begin
      EseguiQueryAgenda;
      if Agenda.Visible and Agenda.Enabled then
        Agenda.SetFocus;
    end
    else if PageControl2.ActivePage = TabPartitario then
    begin
      TabPartitarioForm.TrovaButtonClick(Sender);
      // NB: Riga disabilitata perch altrimenti dava un errore "Cannot focus an invisible or disabled component"
      // if TabPartitarioForm.GridPart.Visible and TabPartitarioForm.GridPart.Enabled then TabPartitarioForm.GridPart.SetFocus;
    end;
  finally
    DM1.CloseWait;
  end;
end;

procedure TClientiForm.EseguiQueryAgenda;
begin
  DM1.OpenQueryAgenda(QryAgenda, QryTecnici, Agenda_NormalSelectionMode);
end;

function TClientiForm.GetDataFiltroRicerca: TDateTime;
begin
  // Inizializzazione
  Result := StrToDate('01/01/2900');
  // Result contiene il parametro per considerare solo i documendi antecedenti alla data voluta
  // come giacenza di magazzino. Serve per avere  ad esempio l'inventario ad una certa data.
  if DM1.ControllaDataStr(EditArtDataMagazzino.Text) then
  begin
    Result := StrToDate(Trim(EditArtDataMagazzino.Text)); // DataMagazzino contiene la data del filtro
  end;
end;

procedure TClientiForm.EseguiQueryArticoli;
var
  I: Integer;
  TmpStr, Mag_CodMag, Mag_DataRichiesta: String;
  MagVisible: Boolean;
  DataMagazzino: TDateTime;
  RicercaPerCodice: Boolean;
  SubQueryGiacenza, SubQueryImpegnato, SubQueryOrdinato: String;

  function BuildUltimoCostoSubQuery(const ASelectField: String): String;
  begin
    Result := '';
    Result := Result + '(';
    Result := Result + ' SELECT FIRST 1 ' + ASelectField;
    Result := Result + ' FROM RIGHIPRV R1';
    Result := Result +
      ' LEFT OUTER JOIN PRVORDCL P1 ON (P1.TIPODOCUMENTO = R1.TIPODOCUMENTO AND P1.REGISTRO = R1.REGISTRO AND P1.NUMORDPREV = R1.NUMORDPREV AND P1.DATADOCUMENTO = R1.DATADOCUMENTO)';
    Result := Result + ' WHERE R1.CODICEARTICOLO = A.CODICEARTICOLO AND COALESCE(R1.QTA,0) <> 0';
    // Nel caso in cui sia stata specificata una data alla quale vedere la giacenze, deve restituire
    // l'ultimo prezzo di acuisto a quella data.
    if DM1.ControllaDataStr(EditArtDataMagazzino.Text) then
      Result := Result + ' AND R1.DATADOCUMENTO < ''' + FormatDateTime('mm/dd/yyyy', DataMagazzino) + '''';
    Result := Result + ' AND ' + DM1.CreaFiltroTipoDocPerUltimoPrezzoAcquisto;
    Result := Result + ' ORDER BY R1.DATADOCUMENTO DESC, R1.NUMORDPREV DESC';
    Result := Result + ')';
  end;

begin
  // Se  attivata la gestione degli articoli secondari di fornitori secondari
  // abilita il Drag & Drop sulgli articoli secondari, altrimenti no
  if DM1.TableProgressiviDOCGESTARTFORNSECONDARI.AsString = 'T' then
    tvLF.DragMode := dmAutomatic
  else
    tvLF.DragMode := dmManual;
  // IMposta il flag che indica se l'interrogazione attuale  effettuale cercando un
  // codice oppure no, questo perch in caso di ricerca per codice modifica
  // leggermente alcune parti della query per aumentarne la velocit.
  RicercaPerCodice := (Trim(EditArtCodice.Text) <> '') or (Trim(EditBarCode.Text) <> '');
  // IMposta il flag che indica se le colonne relative alle giacenze di magazzino
  // sono visibili oppure no.
  MagVisible := (tvArtGIACENZA.Visible or tvArtIMPEGNATO.Visible or tvArtORDINATO.Visible or tvArtDISPONIBILE.Visible);
  // DataMagazzino contiene il parametro per considerare solo i documendi antecedenti alla data voluta
  // come giacenza di magazzino. Serve per avere  ad esempio l'inventario ad una certa data.
  DataMagazzino := GetDataFiltroRicerca;
  // ---------------------------------------------
  // In base alle condizioni di filtraggio inserite dall'utente costruisce
  // il testo dell'interrogazione SQL.
  // ---------------------------------------------
  // Chiude la query, la azzera e inserisce le prime righe
  QryArticoli.Close;
  QryArticoli.SQL.Clear;
  QryArticoli.SQL.Add('SELECT');
  if RicercaPerCodice then
    QryArticoli.SQL.Add('DISTINCT(A.CODICEARTICOLO),')
  else
    QryArticoli.SQL.Add(' A.CODICEARTICOLO,');
  QryArticoli.SQL.Add(' A.Descrizione, A.UnitaDiMisura, COALESCE(A.UltimoPrzAcquisto,0) AS ULTIMOPRZACQUISTO, A.ArticoloComposto, A.QuantitaAutomatica,');

  // ========================================================================
  // PARTE PER IL CALCOLO DELLE GIACENZE DI MAGAZZINO
  // ------------------------------------------------------------------------
  // Nel caso si sia richiesto di visualizzare le giacenze di un particolare magazzino
  // e non di tutti i magazzini provvede a costruire la clausola where per filtrare solo
  // quel magazzino.
  // NB: IMposta il filtro opportuno anche se viene specificato di vedere le giacenze
  // ad una certa data specificata nel relativo filtro
  if Trim(CodiceMagazzino.Text) <> '' then
    Mag_CodMag := Trim(CodiceMagazzino.Text)
  else
    Mag_CodMag := 'NULL';
  if DM1.ControllaDataStr(EditArtDataMagazzino.Text) then
    Mag_DataRichiesta := QuotedStr(FormatDateTime('mm/dd/yyyy', DataMagazzino))
  else
    Mag_DataRichiesta := 'NULL';
  // Se si sono chieste le giacenze solo per un magazzino specifico...
  if (Mag_CodMag <> 'NULL') then
  begin
    // Costruzione delle Subqueryes relative al magazzino su stringhe per comodit
    SubQueryGiacenza := '(SELECT MAG.OUT_GIACENZA FROM MAG_GET_GIACENZE(A.CODICEARTICOLO,' + Mag_CodMag + ',' + Mag_DataRichiesta + ') MAG)';
    SubQueryImpegnato := '(SELECT MAG.OUT_IMPEGNATO FROM MAG_GET_GIACENZE(A.CODICEARTICOLO,' + Mag_CodMag + ',' + Mag_DataRichiesta + ') MAG)';
    SubQueryOrdinato := '(SELECT MAG.OUT_ORDINATO FROM MAG_GET_GIACENZE(A.CODICEARTICOLO,' + Mag_CodMag + ',' + Mag_DataRichiesta + ') MAG)';
    // Se invece si vuole il totale delle giacenze di tutti i magazzini...
  end
  else
  begin
    SubQueryGiacenza := '(SELECT MAG.OUT_GIACENZA  FROM MAG_GET_GIACENZE_ALL(A.CODICEARTICOLO,' + Mag_DataRichiesta + ') MAG)';
    SubQueryImpegnato := '(SELECT MAG.OUT_IMPEGNATO FROM MAG_GET_GIACENZE_ALL(A.CODICEARTICOLO,' + Mag_DataRichiesta + ') MAG)';
    SubQueryOrdinato := '(SELECT MAG.OUT_ORDINATO  FROM MAG_GET_GIACENZE_ALL(A.CODICEARTICOLO,' + Mag_DataRichiesta + ') MAG)';
  end;
  // Se il magazzino non  visibile ritorna sempre 0
  if MagVisible then
  begin
    // Imposta i campi del magazzino
    QryArticoli.SQL.Add(SubQueryGiacenza + ' AS GIACENZA,');
    QryArticoli.SQL.Add(SubQueryImpegnato + ' AS IMPEGNATO,');
    QryArticoli.SQL.Add(SubQueryOrdinato + ' AS ORDINATO,');
  end
  else
  begin
    QryArticoli.SQL.Add(' 0 AS GIACENZA,');
    QryArticoli.SQL.Add(' 0 AS IMPEGNATO,');
    QryArticoli.SQL.Add(' 0 AS ORDINATO,');
  end;
  // ========================================================================

  QryArticoli.SQL.Add
    (' A.PrezzoDiVendita, A.PrezzoDiVendita2, A.PrezzoDiVendita3, A.PrezzoDiVendita4, A.PrzVendIVAComp1, A.PrzVendIVAComp2, A.PrzVendIVAComp3, A.PrzVendIVAComp4,');
  QryArticoli.SQL.Add(' A.LottoRiordino, A.PuntoRiordino, A.ScortaMinima, A.AbilitaMovMag, A.Ubicazione, A.CodiciAggiuntivi, A.Marca, A.Fornitore,');

  // Gruppi
  if tvArtGRUPPO1.Visible or (tvArtGRUPPO1.GroupIndex > -1) then
  begin
    QryArticoli.SQL.Add
      (' CAST((SELECT Descrizione FROM Gruppi WHERE Codice1=A.CodiceGruppo1 AND Codice2=-1 AND Codice3=-1 AND Codice4=-1 AND Codice5=-1 AND Codice6=-1) || ''  ('' || A.CodiceGruppo1 || '')'' AS VARCHAR(150)) AS GRUPPO1,');
  end
  else
    QryArticoli.SQL.Add(' CAST('''' AS VARCHAR(150)) AS GRUPPO1,');
  if tvArtGRUPPO2.Visible or (tvArtGRUPPO2.GroupIndex > -1) then
  begin
    QryArticoli.SQL.Add
      (' CAST((SELECT Descrizione FROM Gruppi WHERE Codice1=A.CodiceGruppo1 AND Codice2=A.CodiceGruppo2 AND Codice3=-1 AND Codice4=-1 AND Codice5=-1 AND Codice6=-1) || ''  ('' || A.CodiceGruppo2 || '')'' AS VARCHAR(150)) AS GRUPPO2,');
  end
  else
    QryArticoli.SQL.Add(' CAST('''' AS VARCHAR(150)) AS GRUPPO2,');
  if tvArtGRUPPO3.Visible or (tvArtGRUPPO3.GroupIndex > -1) then
  begin
    QryArticoli.SQL.Add
      (' CAST((SELECT Descrizione FROM Gruppi WHERE Codice1=A.CodiceGruppo1 AND Codice2=A.CodiceGruppo2 AND Codice3=A.CodiceGruppo3 AND Codice4=-1 AND Codice5=-1 AND Codice6=-1) || ''  ('' || A.CodiceGruppo3 || '')'' AS VARCHAR(150)) AS GRUPPO3,');
  end
  else
    QryArticoli.SQL.Add(' CAST('''' AS VARCHAR(150)) AS GRUPPO3,');
  if tvArtGRUPPO4.Visible or (tvArtGRUPPO4.GroupIndex > -1) then
  begin
    QryArticoli.SQL.Add
      (' CAST((SELECT Descrizione FROM Gruppi WHERE Codice1=A.CodiceGruppo1 AND Codice2=A.CodiceGruppo2 AND Codice3=A.CodiceGruppo3 AND Codice4=A.CodiceGruppo4 AND Codice5=-1 AND Codice6=-1) || ''  ('' || A.CodiceGruppo4 || '')'' AS VARCHAR(150)) AS GRUPPO4,');
  end
  else
    QryArticoli.SQL.Add(' CAST('''' AS VARCHAR(150)) AS GRUPPO4,');
  if tvArtGRUPPO5.Visible or (tvArtGRUPPO5.GroupIndex > -1) then
  begin
    QryArticoli.SQL.Add
      (' CAST((SELECT Descrizione FROM Gruppi WHERE Codice1=A.CodiceGruppo1 AND Codice2=A.CodiceGruppo2 AND Codice3=A.CodiceGruppo3 AND Codice4=A.CodiceGruppo4 AND Codice5=A.CodiceGruppo5 AND Codice6=-1) || ''  ('' || A.CodiceGruppo5 || '')'' AS VARCHAR(150)) ');
    QryArticoli.SQL.Add('     AS GRUPPO5,');
  end
  else
    QryArticoli.SQL.Add(' CAST('''' AS VARCHAR(150)) AS GRUPPO5,');
  if tvArtGRUPPO6.Visible or (tvArtGRUPPO6.GroupIndex > -1) then
  begin
    QryArticoli.SQL.Add
      (' CAST((SELECT Descrizione FROM Gruppi WHERE Codice1=A.CodiceGruppo1 AND Codice2=A.CodiceGruppo2 AND Codice3=A.CodiceGruppo3 AND Codice4=A.CodiceGruppo4 AND Codice5=A.CodiceGruppo5 AND Codice6=A.CodiceGruppo6) || ''  ('' || A.CodiceGruppo6 || '')'' ');
    QryArticoli.SQL.Add('     AS VARCHAR(150)) AS GRUPPO6,');
  end
  else
    QryArticoli.SQL.Add(' CAST('''' AS VARCHAR(150)) AS GRUPPO6,');

  // ========================================================================
  // PARTE PER IL CALCOLO DELL'ULTIMO PREZZO DI ACQUISTO DINAMICO
  // ------------------------------------------------------------------------
  if (not tvArtULTIMOCOSTOREALE.Visible) and (not tvArtIMPORTOULTIMOCOSTOREALE.Visible) then
  begin
    QryArticoli.SQL.Add(' 0 AS ULTIMOCOSTOREALE,');
    QryArticoli.SQL.Add(' NULL AS ULTIMOCOSTODOC,');
  end
  else if DM1.fInventarioUltimoAcquistoIgnoraDocumenti then
  begin
    QryArticoli.SQL.Add(' COALESCE(A.COSTOREALE, 0) AS ULTIMOCOSTOREALE,');
    QryArticoli.SQL.Add(' NULL AS ULTIMOCOSTODOC,');
  end
  else
  begin
    QryArticoli.SQL.Add(' COALESCE(' + BuildUltimoCostoSubQuery('R1.IMPORTORIGO/R1.QTA') + ', A.COSTOREALE, 0) AS ULTIMOCOSTOREALE,');
    QryArticoli.SQL.Add(BuildUltimoCostoSubQuery
      ('R1.TIPODOCUMENTO || '' '' || R1.NUMORDPREV || R1.REGISTRO || '' del '' || EXTRACT(DAY FROM R1.DATADOCUMENTO)||''/''||EXTRACT(MONTH FROM R1.DATADOCUMENTO)||''/''||EXTRACT(YEAR FROM R1.DATADOCUMENTO) || '' '' || P1.RAGSOCCLI')
      + ' AS ULTIMOCOSTODOC,');
  end;
  // ========================================================================

  QryArticoli.SQL.Add
    (' COALESCE(A.PREZZODILISTINO,0) AS PREZZODILISTINO, COALESCE(A.SCONTODIACQUISTO,0) AS SCONTODIACQUISTO, COALESCE(A.SCONTODIACQUISTO2,0) AS SCONTODIACQUISTO2, COALESCE(A.SCONTODIACQUISTO3,0) AS SCONTODIACQUISTO3, A.CODICEFORNITORE, A.DESCRIZIONEFORNITORE,');
  QryArticoli.SQL.Add(' A.DATAULTMOD_CREAZIONE, A.DATAULTMOD_GENERALE, A.DATAULTMOD_COSTO, A.DATAULTMOD_VENDITA, A.DATAULTMOD_LISTINO,');
  QryArticoli.SQL.Add(' A.CATEGORIA1, A.CATEGORIA2, A.CATEGORIA3');

  QryArticoli.SQL.Add('FROM Articoli A');

  // Gli articoli con COdiceArticolo = '' non devono essere visibili
  DM1.AddSQL(QryArticoli, 'AND', 'A.CODICEARTICOLO <> ''''');

  // In base al contenuto dei campi di filtraggio in fondo alla form costruisce
  // le condizioni della query.
  if EditBarCode.Text <> '' then
    DM1.AddSQL(QryArticoli, 'AND', 'A.BarCode = ''' + EditBarCode.Text + '''');

  // Se  specificato un codice articolo da ricercare, lo cerca in tutti i tipi di codice compresi quelli aggiuntivi
  // NB: Nei codici aggiuntivi i codici sono considerati racchiusi tra '<Codice>' oppure '[Codice]', il tipo
  // con le parentesi quadre serve perch altrimenti non posso  importare nulla nel campo
  // CodiciAggiuntivi perch se uso i caratteri <> si incasina il sistema di importazione.
  if EditArtCodice.Text <> '' then
  begin
    TmpStr := '';
    // Se  abilitata la ricerca per codice principale
    if DM1.TableProgressiviRICART_CODICEPRINC.AsString <> 'F' then
    begin
      if TmpStr <> '' then
        TmpStr := TmpStr + ' OR ';
      TmpStr := TmpStr + 'UPPER(A.CodiceArticolo) LIKE ''' + Uppercase(EditArtCodice.Text) + '''';
    end;
    // Se  abilitata la ricerca per Barcode
    if DM1.TableProgressiviRICART_BARCODE.AsString <> 'F' then
    begin
      if TmpStr <> '' then
        TmpStr := TmpStr + ' OR ';
      TmpStr := TmpStr + 'UPPER(A.BarCode) LIKE ''' + Uppercase(EditArtCodice.Text) + '''';
    end;
    // Se  abilitata la ricerca per Codice articolo fornitore
    if DM1.TableProgressiviRICART_CODICEFORN.AsString <> 'F' then
    begin
      if TmpStr <> '' then
        TmpStr := TmpStr + ' OR ';
      TmpStr := TmpStr + 'UPPER(A.CodiceFornitore) LIKE ''' + Uppercase(EditArtCodice.Text) + '''';
    end;
    // Se  abilitata la ricerca per Codici aggiuntivi
    if DM1.TableProgressiviRICART_CODAGG.AsString <> 'F' then
    begin
      if TmpStr <> '' then
        TmpStr := TmpStr + ' OR ';
      TmpStr := TmpStr + '(UPPER(A.CodiciAggiuntivi) LIKE  ''%<' + Uppercase(EditArtCodice.Text) + '>%'' OR UPPER(A.CodiciAggiuntivi) LIKE  ''%[' +
        Uppercase(EditArtCodice.Text) + ']%'')';
    end;
    // Se  abilitata la ricerca per il sistema di gestione dei listini fornitori
    if DM1.TableProgressiviRICART_LISTFORN.AsString <> 'F' then
    begin
      if TmpStr <> '' then
        TmpStr := TmpStr + ' OR ';
      TmpStr := TmpStr +
        'EXISTS (SELECT LF.CODICEARTICOLO FROM LISTFORN LF WHERE LF.CODICEARTICOLO = A.CODICEARTICOLO AND UPPER(LF.CODICEARTICOLOFORNITORE) LIKE ''' +
        Uppercase(EditArtCodice.Text) + ''')';
    end;
    // Se la TmpStr contiene qualcosa aggiunge la ricerca alla query
    if TmpStr <> '' then
      QryArticoli.SQL.Add('AND (' + TmpStr + ')');
  end;

  if EditArtDescrizione.Text <> '' then
    DM1.AggiungiRicercaCampo(QryArticoli.SQL, 'A.DESCRIZIONE', EditArtDescrizione.Text, True);
  if EditArtMarca.Text <> '' then
    DM1.AggiungiRicercaCampo(QryArticoli.SQL, 'A.MARCA', EditArtMarca.Text, True);
  if EditArtFornitore.Text <> '' then
    DM1.AggiungiRicercaCampo(QryArticoli.SQL, 'A.FORNITORE', EditArtFornitore.Text, True);
  if CodiceGruppo1.Text <> '' then
    DM1.AddSQL(QryArticoli, 'AND', 'A.CODICEGRUPPO1 = ' + CodiceGruppo1.Text);
  if CodiceGruppo2.Text <> '' then
    DM1.AddSQL(QryArticoli, 'AND', 'A.CODICEGRUPPO2 = ' + CodiceGruppo2.Text);
  if CodiceGruppo3.Text <> '' then
    DM1.AddSQL(QryArticoli, 'AND', 'A.CODICEGRUPPO3 = ' + CodiceGruppo3.Text);
  if CodiceGruppo4.Text <> '' then
    DM1.AddSQL(QryArticoli, 'AND', 'A.CODICEGRUPPO4 = ' + CodiceGruppo4.Text);
  if CodiceGruppo5.Text <> '' then
    DM1.AddSQL(QryArticoli, 'AND', 'A.CODICEGRUPPO5 = ' + CodiceGruppo5.Text);
  if CodiceGruppo6.Text <> '' then
    DM1.AddSQL(QryArticoli, 'AND', 'A.CODICEGRUPPO6 = ' + CodiceGruppo6.Text);
  if editArtCategoria1.Text <> '' then
    DM1.AddSQL(QryArticoli, 'AND', 'A.CATEGORIA1 = ' + QuotedStr(editArtCategoria1.Text));
  if editArtCategoria2.Text <> '' then
    DM1.AddSQL(QryArticoli, 'AND', 'A.CATEGORIA2 = ' + QuotedStr(editArtCategoria2.Text));
  if editArtCategoria3.Text <> '' then
    DM1.AddSQL(QryArticoli, 'AND', 'A.CATEGORIA3 = ' + QuotedStr(editArtCategoria3.Text));
  if EditArtUbicazione.Text <> '' then
    DM1.AggiungiRicercaCampo(QryArticoli.SQL, 'A.UBICAZIONE', EditArtUbicazione.Text, True);

  // Se si  scelto di visualizzare solo gli articoli PREFERITI
  if SoloGiacAttiva.Checked[0] then
    DM1.AddSQL(QryArticoli, 'AND', 'A.PREFERITO <> ''F''');
  // Se si  scelto di visualizzare solo gli articoli gi movimentati
  if SoloGiacAttiva.Checked[1] then
    DM1.AddSQL(QryArticoli, 'AND',
      '(SELECT COUNT(*) FROM RIGHIPRV R WHERE R.CODICEARTICOLO=A.CODICEARTICOLO AND (R.COMPUTED_MAG_QTA <> 0 OR R.COMPUTED_MAG_IMP <> 0 OR R.COMPUTED_MAG_ORD <> 0)) > 0');
  // Se si  scelto di visualizzare solo gli articoli con giacenza > 0
  if SoloGiacAttiva.Checked[2] then
    DM1.AddSQL(QryArticoli, 'AND', SubQueryGiacenza + ' > 0');
  // Se si  scelto di visualizzare solo gli articoli sotto il punto di riordino
  if SoloGiacAttiva.Checked[3] then
    DM1.AddSQL(QryArticoli, 'AND', SubQueryGiacenza + ' < A.PuntoRiordino');
  // Se si  scelto di visualizzare solo gli articoli sotto scorta
  if SoloGiacAttiva.Checked[4] then
    DM1.AddSQL(QryArticoli, 'AND', SubQueryGiacenza + ' < A.ScortaMinima');

  // Se si  scelto di visualizzare solo gli articoli composti
  if Composti.Checked[0] then
    DM1.AddSQL(QryArticoli, 'AND', 'A.ARTICOLOCOMPOSTO = ''T''');
  // Se si  scelto di visualizzare solo gli articoli NON composti
  if Composti.Checked[1] then
    DM1.AddSQL(QryArticoli, 'AND', '(A.ARTICOLOCOMPOSTO <> ''T'' OR A.ARTICOLOCOMPOSTO IS NULL)');

  // Aggiunge la ricerca con campo TROVA
  if Trim(FilterArtTrova.Text) <> '' then
  begin
    DM1.AddSQL(QryArticoli, 'AND', '(');
    DM1.AggiungiRicercaCampo(QryArticoli.SQL, 'A.CODICEARTICOLO', FilterArtTrova.Text, False);
    QryArticoli.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryArticoli.SQL, 'A.BARCODE', FilterArtTrova.Text, False);
    QryArticoli.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryArticoli.SQL, 'A.DESCRIZIONE', FilterArtTrova.Text, False);
    QryArticoli.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryArticoli.SQL, 'A.MARCA', FilterArtTrova.Text, False);
    QryArticoli.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryArticoli.SQL, 'A.CODICEFORNITORE', FilterArtTrova.Text, False);
    QryArticoli.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryArticoli.SQL, 'A.CODICIAGGIUNTIVI', FilterArtTrova.Text, False);
    QryArticoli.SQL.Add(')');
  end;

  // Solo gli articoli movimentati...
  if EditArtSoloArticoliMovimentati.Checked then
  begin
    TmpStr := '';
    // Verifica l'inserimento dei dati
    if Trim(EditArtSoloArticoliMovimentatiTipo.Text) = '' then
      raise Exception.Create('E'' necessario selezionare se si vogliono visualizzare solo gli articoli "movimentati" oppure "non movimentati".');
    // Genera la condizione
    if EditArtSoloArticoliMovimentatiTipo.Text = 'movimentati' then
      TmpStr := 'AND EXISTS '
    else if EditArtSoloArticoliMovimentatiTipo.Text = 'non movimentati' then
      TmpStr := 'AND NOT EXISTS ';
    TmpStr := TmpStr + '(SELECT CODICEARTICOLO FROM RIGHIPRV R WHERE R.CODICEARTICOLO=A.CODICEARTICOLO';
    if Trim(EditArtSoloArticoliMovimentatiDal.EditText) <> '' then
      TmpStr := TmpStr + ' AND R.DATADOCUMENTO >= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(EditArtSoloArticoliMovimentatiDal.EditText)) + '''';
    if Trim(EditArtSoloArticoliMovimentatiAl.EditText) <> '' then
      TmpStr := TmpStr + ' AND R.DATADOCUMENTO < ''' + FormatDateTime('mm/dd/yyyy', StrToDate(EditArtSoloArticoliMovimentatiAl.EditText) + 1) + '''';
    TmpStr := TmpStr + ' AND   ((R.COMPUTED_MAG_QTA <> 0 OR R.COMPUTED_MAG_IMP <> 0 OR R.COMPUTED_MAG_ORD <> 0)';
    { Continua dalla riga precedente }
    TmpStr := TmpStr + ' OR (COALESCE(R.GC_COMMESSA_QTA,0) <> 0) OR (COALESCE(R.GC_CARICO_QTA,0) <> 0) OR (COALESCE(R.GC_SCARICO_QTA,0) <> 0)';
    { Continua dalla riga precedente } TmpStr := TmpStr + ' OR (COALESCE(R.GC_MONTATO_QTA,0) <> 0) OR (COALESCE(R.GC_FATTURATO_QTA,0) <> 0)))';
    QryArticoli.SQL.Add(TmpStr);
  end;

  // Se  stata specificata una restrizione nel'accesso alle risorse
  // dell'agenda per utente la applica
  if DM1.LimitazioniArticoliPerUtente <> '' then
  begin
    DM1.AddSQL(QryArticoli, 'AND', '(' + DM1.LimitazioniArticoliPerUtente + ')');
  end;

  // Aggiunge alla query l'ORDER BY
  QryArticoli.SQL.Add(DM1.GeneraOrderBy(tvArt));

  // Attiva la Query
  // QryArticoli.SQL.SaveToFile('c:\QryArticoli.sql');
  QryArticoli.Open;
  // Si posizione all'inizio
  tvArt.DataController.GotoFirst;
end;

procedure TClientiForm.VaiAlTabDopoAvvio;
begin
  // Passa automaticamente alla pagina impostata dopo la selezione del soggetto selezionato
  // NB: Se siamo in modalit Levante Light si posiziona subito dove abbiamo deciso senza
  // dipendere da un parametro inserito in un file esterno
  if MainForm.IsLevanteLight then
  begin
    MainForm.SBRubricaClick(MainForm.SBDocumenti);
  end
  else
  begin
    case DM1.TabAvvio of
      IDX_AUTOQUERY_RUBRICA:
        MainForm.SBRubricaClick(MainForm.SBRubrica);
      IDX_AUTOQUERY_PRATICHE:
        MainForm.SBRubricaClick(MainForm.SBPratiche);
      IDX_AUTOQUERY_DOCUMENTI:
        MainForm.SBRubricaClick(MainForm.SBDocumenti);
      IDX_AUTOQUERY_SCADENZE:
        MainForm.SBRubricaClick(MainForm.SBScadenze);
      IDX_AUTOQUERY_ARTICOLI:
        MainForm.SBRubricaClick(MainForm.SBArticoli);
      IDX_AUTOQUERY_GM:
        MainForm.SBRubricaClick(MainForm.SBGM);
      IDX_AUTOQUERY_CV:
        MainForm.SBRubricaClick(MainForm.SBCV);
      IDX_AUTOQUERY_PRIMANOTA:
        MainForm.SBRubricaClick(MainForm.SBPrimanota);
      IDX_AUTOQUERY_ASSISTENZE:
        MainForm.SBRubricaClick(MainForm.SBAssistenze);
      IDX_AUTOQUERY_IMPEGNI:
        MainForm.SBRubricaClick(MainForm.SBImpegni);
      IDX_AUTOQUERY_GC:
        MainForm.SBRubricaClick(MainForm.SBGC);
      IDX_AUTOQUERY_AGENDA:
        MainForm.SBRubricaClick(MainForm.SBAgenda);
      IDX_AUTOQUERY_PARTITARIO:
        MainForm.SBRubricaClick(MainForm.SBPartitario);
      IDX_AUTOQUERY_GOS:
        MainForm.SBRubricaClick(MainForm.SBGOS);
    end;
  end;
end;

procedure TClientiForm.VaiAlTabDopoSelezioneOggetto;
begin
  // Se siamo in modalit FastSelectionMode esce subito senza fare nulla
  if DM1.FastSelectionMode then
    Exit;
  // Passa automaticamente alla pagina impostata dopo la selezione del soggetto selezionato
  case DM1.TabDopoSelezioneSoggetto of
    IDX_AUTOQUERY_RUBRICA:
      MainForm.SBRubricaClick(MainForm.SBRubrica);
    IDX_AUTOQUERY_PRATICHE:
      MainForm.SBRubricaClick(MainForm.SBPratiche);
    IDX_AUTOQUERY_DOCUMENTI:
      MainForm.SBRubricaClick(MainForm.SBDocumenti);
    IDX_AUTOQUERY_SCADENZE:
      MainForm.SBRubricaClick(MainForm.SBScadenze);
    IDX_AUTOQUERY_ARTICOLI:
      MainForm.SBRubricaClick(MainForm.SBArticoli);
    IDX_AUTOQUERY_GM:
      MainForm.SBRubricaClick(MainForm.SBGM);
    IDX_AUTOQUERY_CV:
      MainForm.SBRubricaClick(MainForm.SBCV);
    IDX_AUTOQUERY_PRIMANOTA:
      MainForm.SBRubricaClick(MainForm.SBPrimanota);
    IDX_AUTOQUERY_ASSISTENZE:
      MainForm.SBRubricaClick(MainForm.SBAssistenze);
    IDX_AUTOQUERY_IMPEGNI:
      MainForm.SBRubricaClick(MainForm.SBImpegni);
    IDX_AUTOQUERY_GC:
      MainForm.SBRubricaClick(MainForm.SBGC);
    IDX_AUTOQUERY_AGENDA:
      MainForm.SBRubricaClick(MainForm.SBAgenda);
    IDX_AUTOQUERY_PARTITARIO:
      MainForm.SBRubricaClick(MainForm.SBPartitario);
    IDX_AUTOQUERY_GOS:
      MainForm.SBRubricaClick(MainForm.SBGOS);
  end;
end;

procedure TClientiForm.VaiAlTabDopoSelezionePratica;
begin
  // Se siamo in modalit FastSelectionMode esce subito senza fare nulla
  if DM1.FastSelectionMode then
    Exit;
  // Passa automaticamente alla pagina impostata dopo la selezione del soggetto selezionato
  case DM1.TabDopoSelezionePratica of
    IDX_AUTOQUERY_RUBRICA:
      MainForm.SBRubricaClick(MainForm.SBRubrica);
    IDX_AUTOQUERY_PRATICHE:
      MainForm.SBRubricaClick(MainForm.SBPratiche);
    IDX_AUTOQUERY_DOCUMENTI:
      MainForm.SBRubricaClick(MainForm.SBDocumenti);
    IDX_AUTOQUERY_SCADENZE:
      MainForm.SBRubricaClick(MainForm.SBScadenze);
    IDX_AUTOQUERY_ARTICOLI:
      MainForm.SBRubricaClick(MainForm.SBArticoli);
    IDX_AUTOQUERY_GM:
      MainForm.SBRubricaClick(MainForm.SBGM);
    IDX_AUTOQUERY_CV:
      MainForm.SBRubricaClick(MainForm.SBCV);
    IDX_AUTOQUERY_PRIMANOTA:
      MainForm.SBRubricaClick(MainForm.SBPrimanota);
    IDX_AUTOQUERY_ASSISTENZE:
      MainForm.SBRubricaClick(MainForm.SBAssistenze);
    IDX_AUTOQUERY_IMPEGNI:
      MainForm.SBRubricaClick(MainForm.SBImpegni);
    IDX_AUTOQUERY_GC:
      MainForm.SBRubricaClick(MainForm.SBGC);
    IDX_AUTOQUERY_AGENDA:
      MainForm.SBRubricaClick(MainForm.SBAgenda);
    IDX_AUTOQUERY_PARTITARIO:
      MainForm.SBRubricaClick(MainForm.SBPartitario);
    IDX_AUTOQUERY_GOS:
      MainForm.SBRubricaClick(MainForm.SBGOS);
  end;
end;

procedure TClientiForm.VaiAlTabDopoSelezioneImpianto;
begin
  // Se siamo in modalit FastSelectionMode esce subito senza fare nulla
  if DM1.FastSelectionMode then
    Exit;
  // Passa automaticamente alla pagina impostata dopo la selezione del soggetto selezionato
  case DM1.TabDopoSelezioneImpianto of
    IDX_AUTOQUERY_RUBRICA:
      MainForm.SBRubricaClick(MainForm.SBRubrica);
    IDX_AUTOQUERY_PRATICHE:
      MainForm.SBRubricaClick(MainForm.SBPratiche);
    IDX_AUTOQUERY_DOCUMENTI:
      MainForm.SBRubricaClick(MainForm.SBDocumenti);
    IDX_AUTOQUERY_SCADENZE:
      MainForm.SBRubricaClick(MainForm.SBScadenze);
    IDX_AUTOQUERY_ARTICOLI:
      MainForm.SBRubricaClick(MainForm.SBArticoli);
    IDX_AUTOQUERY_GM:
      MainForm.SBRubricaClick(MainForm.SBGM);
    IDX_AUTOQUERY_CV:
      MainForm.SBRubricaClick(MainForm.SBCV);
    IDX_AUTOQUERY_PRIMANOTA:
      MainForm.SBRubricaClick(MainForm.SBPrimanota);
    IDX_AUTOQUERY_ASSISTENZE:
      MainForm.SBRubricaClick(MainForm.SBAssistenze);
    IDX_AUTOQUERY_IMPEGNI:
      MainForm.SBRubricaClick(MainForm.SBImpegni);
    IDX_AUTOQUERY_GC:
      MainForm.SBRubricaClick(MainForm.SBGC);
  end;
end;

procedure TClientiForm.RxSpeedButtonVisualizzaClick(Sender: TObject);
var
  DocType, Registro: String;
  DocNum: Longint;
  DocDate: TDate;
  DocID: Integer;

begin
  // DM1.Attendere;

  try

    // ==========================================================================
    // VISUALIZZA EVENTI AGENDA LATERALE
    // --------------------------------------------------------------------------
    if Assigned(fAgendaForm) then
    begin
      // Se siamo in modalit FastSelection e nell'agenda laterale ci sono degli eventi
      // selezionati e l'agenda  Focused elimina quegli eventi dall'agenda stessa
      if (fAgendaForm.MainPageControl.ActivePage = fAgendaForm.TabAgenda) and Agenda_EventiSelezionatiPresenti and fAgendaForm.Agenda_FastSelectionMode.Focused
      then
      begin
        fAgendaForm.VisualizzaEventoSelezionato;
        Exit;
        // Se invece siamo sempre in FastSelectionMode e per siamo nei tasks e ci sono
        // dei tasks selezionati
      end
      else if (fAgendaForm.MainPageControl.ActivePage = fAgendaForm.TabTasks) and Agenda_TasksSelezionatiPresenti and fAgendaForm.GridTasks.IsFocused then
      begin
        try
          DM1.ShowWait('Levante', 'Sto comunicando con Google Tasks...');
          fAgendaForm.Task_OpenFocusedTask;
          Exit;
        finally
          DM1.CloseWait;
        end;
      end;
    end;
    // ==========================================================================

    // ===========================================================================
    // Nel caso sia attiva la pagina del partitario...
    // Provvede a salvare nelle rispettive variabili locali i dati del documento per
    // pri provedere ad aprirlo nella sezione documenti.
    // ---------------------------------------------------------------------------
    if (PageControl2.ActivePage = TabPartitario) then
    begin
      TabPartitarioForm.ApriDocumento(DocType, Registro, DocNum, DocDate);
    end;
    // ===========================================================================

    // TAB CLIENTI
    if (PageControl2.ActivePage = TabClienti) then
    begin
      // Se siamo su una vista dettaglio...
      if GridSogg.FocusedView.IsDetail then
      begin
        with (GridSogg.FocusedView as TcxGridDBTableView) do
        begin
          // Solo se vi  almeno una voce selezionata
          if (Controller.SelectedRecordCount > 0) and (Assigned(Controller.FocusedRecord)) and (Controller.FocusedRecord.IsData) then
          begin
            // Se  una pratica
            if QrySoggCantTIPO.AsString = 'P' then
            begin
              // Seleziona la pratica
              if (DM1.ModCtrl(MOD_PRATICHE) > 0) then
              begin
                SelezionaSoggettoPratica(QrySoggCantCLIENTE.AsInteger, QrySoggCantID.AsInteger);
                // Passa automaticamente alla pagina successiva
                VaiAlTabDopoSelezionePratica;
              end;
              // Se invece  un impianto
            end
            else if QrySoggCantTIPO.AsString = 'A' then
            begin
              // Seleziona l'impianto
              if (DM1.ModCtrl(MOD_CONTATTI) > 0) then
              begin
                SelezionaSoggettoPratica(QrySoggCantCLIENTE.AsInteger, QrySoggCantID.AsInteger);
                // Passa automaticamente alla pagina successiva
                VaiAlTabDopoSelezioneImpianto;
              end;
            end;
          end
          else
            DM1.Messaggi('ATTENZIONE !!!', 'Nessuna voce selezionata.', '', [mbOk], 0, nil);
        end;
        // Altrimenti siamo sulla vista Master e quindi sulla rubrica
      end
      else
      begin
        // Solo se vi  almeno una voce selezionata
        if (tvRubrica.Controller.SelectedRecordCount > 0) and (Assigned(tvRubrica.Controller.FocusedRecord)) and (tvRubrica.Controller.FocusedRecord.IsData)
        then
        begin
          // Seleziona il soggetto
          if (DM1.ModCtrl(MOD_CLIENTI) > 0) then
          begin
            // Seleziona il soggetto corrente
            SelezionaSoggettoPratica(QrySoggettiCODICE.AsInteger);
            // Passa automaticamente alla pagina successiva
            VaiAlTabDopoSelezioneOggetto;
          end;
        end
        else
          DM1.Messaggi('ATTENZIONE !!!', 'Nessuna voce selezionata.', '', [mbOk], 0, nil);
      end;

      // TAB PRATICHE
    end
    else if (PageControl2.ActivePage = TabPratiche) and (Assigned(tvPrat.Controller.FocusedRecord)) and (tvPrat.Controller.FocusedRecord.IsData) then
    begin
      if tvPrat.Controller.SelectedRecordCount > 0 then
      begin
        // Seleziona la pratica
        if (DM1.ModCtrl(MOD_PRATICHE) > 0) then
        begin
          // Seleziona la pratica e il soggetto corrente
          SelezionaSoggettoPratica(QryPraticheCLIENTE.AsInteger, QryPraticheID.AsInteger);
          // Passa automaticamente alla pagina successiva
          VaiAlTabDopoSelezionePratica;
        end;
      end
      else
        DM1.Messaggi('ATTENZIONE !!!', 'Nessun cantiere o pratica presente o selezionato.', '', [mbOk], 0, nil);

      // TAB ASSISTENZE
    end
    else if (PageControl2.ActivePage = TabAssistenze) then
    begin
      TabImpiantiForm.ApriDocumento;

      // TAB COMUNICAZIONI
    end
    else if (PageControl2.ActivePage = TabComunicazioni) then
    begin
      TabComunicazioniForm.VisualizzaButtonClick(nil);

      // TAB GIORNALE DI CANTIERE
    end
    else if (PageControl2.ActivePage = TabGC) then
    begin
      TabGCForm.ApriDocumento(DocType, Registro, DocNum, DocDate);

      // TAB ARTICOLI
    end
    else if (PageControl2.ActivePage = TabArticoli) and (Assigned(tvArt.Controller.FocusedRecord)) and (tvArt.Controller.FocusedRecord.IsData) then
    begin
      if tvArt.Controller.SelectedRecordCount > 0 then
      begin
        if DM1.ModCtrl(MOD_ARTICOLI) > 0 then
        begin
          DM1.ShowWait('Levante', 'Operazione in corso...');
          try
            Application.CreateForm(TAnagArtForm, AnagArtForm);
            // La riga sottostante  stata sostituita con la successiva per risolvere l'errore
            // che dava il programma quando girava su Win95/98/ME (Questo programma ha eseguito una operazione non valida...)
            // Il problema lo dava solo quando assegnavo la propriet Parent della form AnagArtForm.
            // con le altre form andava bene.
            // AnagArtForm.Parent := MainForm;
            MainForm.FormSetParentPlatformDependent(AnagArtForm, MainForm);
            Windows.SetParent(AnagArtForm.Handle, MainForm.Handle);
            AnagArtForm.CodiceArticolo := QryArticoli.FieldByName('CODICEARTICOLO').AsString;
            AnagArtForm.Tag := 1;
            AnagArtForm.Show;
          finally
            DM1.CloseWait;
          end;
        end;
      end
      else
        DM1.Messaggi('ATTENZIONE !!!', 'Nessun articolo presente o selezionato.', '', [mbOk], 0, nil);

      // TAB SCADENZE
    end
    else if (PageControl2.ActivePage = TabScadenze) and (Assigned(tvScad.Controller.FocusedRecord)) and (tvScad.Controller.FocusedRecord.IsData) then
    begin
      if tvScad.Controller.SelectedRecordCount > 0 then
      begin
        if DM1.ModCtrl(MOD_SCADENZARIO) > 0 then
        begin
          DM1.ShowWait('Levante', 'Operazione in corso...');
          try
            Application.CreateForm(TScadenzeForm, ScadenzeForm);
            ScadenzeForm.Parent := MainForm;
            ScadenzeForm.TipoScadenza := QryScad.FieldByName('TIPO').AsString;
            ScadenzeForm.CodiceScadenza := QryScad.FieldByName('CODICE').AsInteger;
            ScadenzeForm.DataScadenza := QryScad.FieldByName('DATASCADENZA').AsDateTime;
            ScadenzeForm.Tag := 1;
            ScadenzeForm.Show;
          finally
            DM1.CloseWait;
          end;
        end;
      end
      else
        DM1.Messaggi('ATTENZIONE !!!', 'Nessuna scadenza presente o selezionata.', '', [mbOk], 0, nil);

      // TAB IMPEGNI
    end
    else if (PageControl2.ActivePage = TabImpegni) and (Assigned(tvImpegni.Controller.FocusedRecord)) and (tvImpegni.Controller.FocusedRecord.IsData) then
    begin
      if tvImpegni.Controller.SelectedRecordCount > 0 then
      begin
        DM1.ShowWait('Levante', 'Operazione in corso...');
        try
          DM1.ApriImpegno(QryImp.FieldByName('ID').AsInteger, False);
        finally
          DM1.CloseWait;
        end;
      end
      else
        DM1.Messaggi('ATTENZIONE !!!', 'Nessun impegno presente o selezionato.', '', [mbOk], 0, nil);

      // TAB PRIMANOTA
    end
    else if (PageControl2.ActivePage = TabPrimanota) and (Assigned(tvPrimanota.Controller.FocusedRecord)) and (tvPrimanota.Controller.FocusedRecord.IsData) then
    begin
      if tvPrimanota.Controller.SelectedRecordCount > 0 then
      begin
        if DM1.ModCtrl(MOD_PRIMANOTA) > 0 then
        begin
          DM1.ShowWait('Levante', 'Operazione in corso...');
          try
            Application.CreateForm(TPrimanotaForm, PrimanotaForm);
            PrimanotaForm.Parent := MainForm;
            PrimanotaForm.CodToOpen := QueryPrimanotaCODICE.AsInteger;
            PrimanotaForm.DataToOpen := QueryPrimanotaDATA.AsDateTime;
            PrimanotaForm.Tag := 1;
            PrimanotaForm.Show;
          finally
            DM1.CloseWait;
          end;
        end;
      end
      else
        DM1.Messaggi('ATTENZIONE !!!', 'Nessun movimento di primanota presente o selezionato.', '', [mbOk], 0, nil);

      // TAB AGENDA
    end
    else if (PageControl2.ActivePage = TabAgenda) then
    begin
      if Agenda.SelectedEventCount > 0 then
      begin
        DM1.ShowWait('Levante', 'Operazione in corso...');
        try
          DM1.ApriImpegno(Agenda.SelectedEvents[0].ID, False);
        finally
          DM1.CloseWait;
        end;
        {
          if DM1.ModCtrl(MOD_CONTATTI) > 0 then begin
          Application.CreateForm(TImpegnoForm, ImpegnoForm);
          ImpegnoForm.Parent           := MainForm;
          ImpegnoForm.CurrentID        := Agenda.SelectedEvents[0].ID;
          ImpegnoForm.Tag := 1;
          ImpegnoForm.Show;
          end;
        }
      end
      else
        DM1.Messaggi('ATTENZIONE !!!', 'Nessun impegno presente o selezionato.', '', [mbOk], 0, nil);

      // TAB CLIENTI DOCUMENTI
    end
    else if ((PageControl2.ActivePage = TabDocumenti) and (Assigned(tvDoc.Controller.FocusedRecord)) and (tvDoc.Controller.FocusedRecord.IsData)) or
      ((PageControl2.ActivePage = TabPartitario) and (DocType <> '') and (DocType <> 'PRIMANOTA')) or (PageControl2.ActivePage = TabGOS) then
    begin
      // Se poi la pagina  veramente la pagina dei documenti, carica i dati del documento
      // da aprire sulle apposite variabili locali altrimenti significa che la pagina
      // attuale  quella del partitario ed usa i valori delle variabili locali impostate all'inizio
      // di questo gestore di evento.
      if (PageControl2.ActivePage = TabDocumenti) and (tvDoc.Controller.SelectedRecordCount > 0) then
      begin
        DocType := QryDocTIPODOC.AsString;
        DocNum := QryDocCODICEDOC.AsInteger;
        DocDate := QryDocDATADOC.AsDateTime;
        Registro := QryDocREGISTRO.AsString;
        DocID := QryDocID.AsInteger;
        // Per la nuova conformit
        if (DocType = 'Conformita') and (Registro <> 'OLD') then
          DocNum := QryDocID.AsInteger;
        // Se invece la pagina  attuale  quella del giornale manodopera spese (elenco ore) e c' qualche record selezionato
      end
      else if (PageControl2.ActivePage = TabGOS) and (cxPageControlGOS.ActivePage = TabManodopera) and (cxPageControlGOSOre.ActivePage = TabGOSOreElenco) then
      begin
        if (not Assigned(tvOre.Controller.FocusedRecord)) or (not tvOre.Controller.FocusedRecord.IsData) then
          Exit;
        DocType := QryGOSOreTIPODOC.AsString;
        DocNum := QryGOSOreNUMDOC.AsInteger;
        DocDate := QryGOSOreDATADOC.AsDateTime;
        Registro := QryGOSOreREGISTRO.AsString;
        DocID := 0;
        // Se invece la pagina  attuale  quella del giornale manodopera spese (elenco altre spese) e c' qualche record selezionato
      end
      else if (PageControl2.ActivePage = TabGOS) and (cxPageControlGOS.ActivePage = TabSpese) and (cxPageControlGOSSpese.ActivePage = TabGOSSpeseElenco) then
      begin
        if (not Assigned(tvSpese.Controller.FocusedRecord)) or (not tvSpese.Controller.FocusedRecord.IsData) then
          Exit;
        DocType := QryGOSSpeseTIPODOC.AsString;
        DocNum := QryGOSSpeseNUMDOC.AsInteger;
        DocDate := QryGOSSpeseDATADOC.AsDateTime;
        Registro := QryGOSSpeseREGISTRO.AsString;
        DocID := 0;
      end;
      // A questo punto se le variabili locali non sono vuote procede con l'apertura
      // del documento altrimenti niente
      ApriDocumento(DocType, DocNum, Registro, DocDate, DocID);

      // TAB GIORNALE DI MAGAZZINO
    end
    else if (PageControl2.ActivePage = TabMagazzino) and (Assigned(tvGM.Controller.FocusedRecord)) and (tvGM.Controller.FocusedRecord.IsData) then
    begin
      if tvGM.Controller.SelectedRecordCount > 0 then
      begin
        // Preleva i dati del documento da visualizzare
        DocType := QryGM.FieldByName('TIPODOCUMENTO').AsString;
        Registro := QryGM.FieldByName('REGISTRO').AsString;
        DocNum := QryGM.FieldByName('NUMORDPREV').AsInteger;
        DocDate := QryGM.FieldByName('DATADOCUMENTO').AsDateTime;
        // Apre il documento
        ApriDocumento(DocType, DocNum, Registro, DocDate, 0);
      end;

      // TAB CONDIZIONI DI VENDITA
    end
    else if (PageControl2.ActivePage = TabCondVend) and (Assigned(tvCV.Controller.FocusedRecord)) and (tvCV.Controller.FocusedRecord.IsData) then
    begin
      if tvCV.Controller.SelectedRecordCount > 0 then
      begin
        // Apre l'anagrafica della condizione di vendita selezionata
        DM1.ShowWait('Levante', 'Operazione in corso...');
        try
          Application.CreateForm(TCondVendForm, CondVendForm);
          CondVendForm.Parent := MainForm;

          CondVendForm.LocTipoCOndizione := QryCV.FieldByName('TIPO').AsString;
          CondVendForm.LocCodiceSoggetto := QryCV.FieldByName('CODICESOGGETTO').AsInteger;
          CondVendForm.LocCodiceArticolo := QryCV.FieldByName('CODICEARTICOLO').AsString;
          CondVendForm.LocCodiceGruppo1 := QryCV.FieldByName('CODICEGRUPPO1').AsInteger;
          CondVendForm.LocCodiceGruppo2 := QryCV.FieldByName('CODICEGRUPPO2').AsInteger;
          CondVendForm.LocCodiceGruppo3 := QryCV.FieldByName('CODICEGRUPPO3').AsInteger;

          CondVendForm.Tag := 1;
          CondVendForm.Show;
        finally
          DM1.CloseWait;
        end;
      end
      else
        DM1.Messaggi('ATTENZIONE !!!', 'Nessuna condizione presente o selezionata.', '', [mbOk], 0, nil);
    end;

  finally
    // DM1.ChiudiAttendere;
  end;
end;

// Procedura che apre il documento specificato dai parametri ricevuti
procedure TClientiForm.ApriDocumento(const DocType: String; const DocNum: Integer; const Registro: String; const DocDate: TDateTime; const DocID: Integer);
begin
  // A questo punto se le variabili locali non sono vuote procede con l'apertura
  // del documento altrimenti niente
  // ----------------------------------------------------------------------
  if DocType <> '' then
  begin

    if (DocType = 'Preventivo') or (DocType = 'Ordine') or (DocType = 'S.A.L.') or (DocType = 'D.D.T.') or (DocType = 'Fattura') or (DocType = 'Nota_accre') or
      (DocType = 'Ord.fornit') or (DocType = 'Bolla_entr') or (DocType = 'Fatt.acqui') or (DocType = 'Ricev.fisc') or (DocType = 'Fatt.R.F.') or
      (DocType = 'Buono_cons') or (DocType = 'N.C.fornit') or (DocType = 'Commessa') or (DocType = 'Carico_cantiere') or (DocType = 'Scarico_cantiere') or
      (DocType = 'Estratto_conto') then
    begin // Documenti
      if DM1.ControllaDocumento(DocType) > 0 then
        DM1.ApriDocFisc(DocType, DocNum, Registro, DocDate, False)
      else
        raise Exception.Create('Accesso non consentito!');

    end
    else if DocType = 'Intervento' then
    begin // Intervento
      if DM1.ModCtrl(MOD_CONTATTI) > 0 then
      begin
        DM1.ShowWait('Levante', 'Operazione in corso...');
        try
          Application.CreateForm(TImpegnoForm, ImpegnoForm);
          ImpegnoForm.Parent := MainForm;
          ImpegnoForm.CurrentID := DocNum;
          ImpegnoForm.Tag := 1;
          ImpegnoForm.Show;
        finally
          DM1.CloseWait;
        end;
      end;

    end
    else if DocType = 'Lettera' then
    begin // Testi
      if DM1.ModCtrl(MOD_TESTI) > 0 then
      begin
        DM1.ShowWait('Levante', 'Operazione in corso...');
        try
          Application.CreateForm(TTestiForm, TestiForm);
          TestiForm.Parent := MainForm;
          TestiForm.CodiceTesto := DocNum;
          TestiForm.DataTesto := DocDate;
          TestiForm.Tag := 1;
          TestiForm.Show;
        finally
          DM1.CloseWait;
        end;
      end;

    end
    else if (DocType = 'Cont.fare') or (DocType = 'Cont.fatto') then
    begin // COntatti
      if DM1.ModCtrl(MOD_CONTATTI) > 0 then
      begin
        DM1.ShowWait('Levante', 'Operazione in corso...');
        try
          Application.CreateForm(TContattiForm, ContattiForm);
          ContattiForm.Parent := MainForm;
          ContattiForm.CodiceContatto := DocNum;
          ContattiForm.DataContatto := DocDate;
          ContattiForm.Tag := 1;
          ContattiForm.Show;
        finally
          DM1.CloseWait;
        end;
      end;

    end
    else if DocType = 'Doc.esterno' then
    begin // Files esterni
      if DM1.ModCtrl(MOD_EXT_FILE) > 0 then
      begin
        DM1.ShowWait('Levante', 'Operazione in corso...');
        try
          Application.CreateForm(TExtFileForm, ExtFileForm);
          ExtFileForm.Parent := MainForm;
          ExtFileForm.CodiceExtFile := DocNum;
          ExtFileForm.RegistroExtFile := Registro;
          ExtFileForm.DataExtFile := DocDate;
          ExtFileForm.Tag := 1;
          ExtFileForm.Show;
        finally
          DM1.CloseWait;
        end;
      end;

    end
    else if (DocType = 'Conformita') and (Registro = 'OLD') then
    begin
      // Visualizza la vecchia dichiarazione di conformit
      if DM1.ModCtrl(MOD_CONFORMITA) > 0 then
      begin
        DM1.ShowWait('Levante', 'Operazione in corso...');
        try
          Application.CreateForm(TConformitaForm, ConformitaForm);
          ConformitaForm.Parent := MainForm;
          ConformitaForm.CodiceConformita := DocNum;
          ConformitaForm.DataConformita := DocDate;
          ConformitaForm.Tag := 1;
          ConformitaForm.Show;
        finally
          DM1.CloseWait;
        end;
      end;
    end
    else if DocType = 'Rapp.giorn.' then
    begin // Rapporto giornaliero
      if DM1.ModCtrl(MOD_GIORNALE_CANTIERE) > 0 then
      begin
        DM1.ShowWait('Levante', 'Operazione in corso...');
        try
          Application.CreateForm(TRappGiornForm, RappGiornForm);
          RappGiornForm.Parent := MainForm;
          RappGiornForm.NumDoc := DocNum;
          RappGiornForm.DataDoc := DocDate;
          RappGiornForm.Registro := Registro;
          RappGiornForm.Tag := 1;
          RappGiornForm.Show;
        finally
          DM1.CloseWait;
        end;
      end;
    end
    // Se non  nessuno dei documenti precedenti allora deve essere un documento LDE
    else
      DM1.LDE_OpenDocument(DocType, DocID);
  end
  else
    DM1.Messaggi('ATTENZIONE !!!', 'Nessun documento presente o selezionato.', '', [mbOk], 0, nil);
end;

procedure TClientiForm.Apriildocumentorelativoallascadenza1Click(Sender: TObject);
var
  DocTipo, DocReg: String;
  DocNum: Integer;
  DocData: TDateTime;
begin
  // Verifica iniziale
  if (tvScad.Controller.FocusedRecord = nil) or (not tvScad.Controller.FocusedRecord.IsData) then
    Exit;
  // Carica i dati del documento da aprire
  with tvScad.Controller.FocusedRecord do
  begin
    DocTipo := DisplayTexts[tvScadTIPODOC.Index];
    if not VarIsNull(Values[tvScadNUMDOC.Index]) then
      DocNum := Values[tvScadNUMDOC.Index];
    DocReg := DisplayTexts[tvScadREGISTRO.Index];
    if not VarIsNull(Values[tvScadDATADOC.Index]) then
      DocData := Values[tvScadDATADOC.Index];
  end;
  // Se doc non valido
  if DocTipo = '' then
    Exit;
  // Apre il documento
  ApriDocumento(DocTipo, DocNum, DocReg, DocData, 0);
end;

procedure TClientiForm.RxSpeedButtonResetQueryClick(Sender: TObject);
begin
  // DM1.Attendere;
  try

    // In base alla pagina selezionata azzera le condizioni di interrogazione appropriate.
    // NB:  Se la propriet Tag del pulsante = 1 azzera tutti i filtri
    // if (PageControl2.ActivePage = TabClienti) then begin
    if ((RxSpeedButtonResetQuery.Tag = 0) and (PageControl2.ActivePage = TabClienti) or ((RxSpeedButtonResetQuery.Tag > 1) and (not DM1.FastSelectionMode)))
    then
    begin
      FilterRubricaTrova.Text := '';
      ResetTabRubrica;
      TipoSoggetto.Properties.Items.Clear;
      TipoSoggetto.Text := '';
      EditClientiCodice.Text := '';
      EditClientiRagSoc.Text := '';
      EditClientiCitta.Text := '';
      EditClientiProvincia.Text := '';
      EditClientiPIVA.Text := '';
      EditClientiTelefono.Text := '';
      EditClientiAgente.Text := '';
      EditClientiAgente2.Text := '';
      EditClientiAgente3.Text := '';
      EditClientiAgente4.Text := '';
      SoggStato.Text := '';
      TabLettera.Text := '';
      EditClientiSubSogg1.Text := '';
      EditClientiSubSogg2.Text := '';
      EditClientiSubSogg3.Text := '';
      EditClientiSubSogg4Dal.Clear;
      EditClientiSubSogg4Al.Clear;
      // Chiude la FilterRow se aperta
      if tvRubrica.FilterRow.Visible then
      begin
        SBFilterRowSoggetti.Down := False;
        SBFilterRowSoggettiClick(SBFilterRowSoggetti);
      end;
    end;

    if (PageControl2.ActivePage = TabArticoli) then
    begin
      FilterArtTrova.Text := '';
      EditBarCode.Text := '';
      EditArtCodice.Text := '';
      EditArtDescrizione.Text := '';
      EditArtMarca.Text := '';
      CodiceGruppo1.Text := '';
      CodiceGruppo2.Text := '';
      CodiceGruppo3.Text := '';
      CodiceGruppo4.Text := '';
      CodiceGruppo5.Text := '';
      CodiceGruppo6.Text := '';
      DescGruppo1.Text := '';
      DescGruppo2.Text := '';
      DescGruppo3.Text := '';
      DescGruppo4.Text := '';
      DescGruppo5.Text := '';
      DescGruppo6.Text := '';
      CodiceMagazzino.Text := '';
      DescrizioneMagazzino.Text := '';
      EditArtUbicazione.Text := '';
      EditArtDataMagazzino.EditText := '';
      SoloGiacAttiva.Checked[0] := DM1.DefaultVisualizzaSoloArticoliPreferiti;
      SoloGiacAttiva.Checked[1] := False;
      SoloGiacAttiva.Checked[2] := False;
      SoloGiacAttiva.Checked[3] := False;
      SoloGiacAttiva.Checked[4] := False;
      Composti.Checked[0] := False;
      Composti.Checked[1] := False;
      editArtCategoria1.Text := '';
      editArtCategoria2.Text := '';
      editArtCategoria3.Text := '';
      EditArtFornitore.Text := '';

      EditArtSoloArticoliMovimentati.Checked := False;

      // Ripristina il magazzino di default
      CaricaMagazzinoDefaultArticoli;
      // Azzera la query
      // NB: Negli articoli non c' alcun bisogno di azzerare/chiudere la query quanto si seleziona/deseleziona un cliente/pratica/impianto
      // if RxSpeedButtonResetQuery.Tag = 1 then QryArticoli.Close;
    end;

    // PARTITARIO
    if (PageControl2.ActivePage = TabPartitario) or (RxSpeedButtonResetQuery.Tag > 0) then
    begin
      if (RxSpeedButtonResetQuery.Tag > 0) then
      begin
        if TabPartitarioForm <> nil then
        begin
          if (PageControl2.ActivePage = TabPartitario) then
            TabPartitarioForm.ResetQueryButtonClick(Sender)
          else
            TabPartitarioForm.Close;
        end;
      end
      else
      begin
        TabPartitarioForm.ResetQueryButtonClick(Sender);
      end;
    end;

    if (PageControl2.ActivePage = TabDocumenti) or (RxSpeedButtonResetQuery.Tag > 0) then
    begin
      FilterTesto.Text := '';
      SoloStato.Text := '';
      SoloRegistro.Text := '';
      TranneRegistro.Text := '';
      Causale.Text := '';
      SoloTipoSoggetto.Text := '';
      DocOperatore.Text := '';
      DocConCantiere.Checked[0] := False;
      DocConCantiere.Checked[1] := False;
      DateEditDa.Text := '';
      DateEditA.Text := '';
      FilterNumDoc.Text := '';
      FilterProtocollo.Text := '';
      FilterCodiceArticolo.Text := '';
      FilterDescrizione.Text := '';
      FilterDocTipoData.Text := 'Data documento';
      FilterOp1.Text := '';
      FilterOp2.Text := '';
      FilterOp3.Text := '';
      DocAgente.Text := '';
      DocAgente2.Text := '';
      DocAgente3.Text := '';
      DocAgente4.Text := '';
      DocCategCant1.Text := '';
      DocCategCant2.Text := '';
      DocCategCant3.Text := '';
      DocCategCant4.Text := '';
      DocCategCant5.Text := '';
      DocCategCant6.Text := '';
      DocSubSogg1.Text := '';
      DocSubSogg2.Text := '';
      DocSubSogg3.Text := '';
      DocSubSogg4Dal.Clear;
      DocSubSogg4Al.Clear;
      SBDocNessunoClick(Self);
      FilterRDA.Text := '';
      // Se il Tag del pulsante MesiTutti = 1 significa che questo gestore di evento  stato
      // richiamato dall'evento OnChange del PageControl e non per un click dell'utente sul
      // pulsante stesso, quindi imposta le date al primo giorno e all'ultimo dell'anno in corso
      // ma non mette in  Down tutti i pulsanti dei mesi perch mi piace di pi.
      SBMesiTutti.Tag := 1;
      SBMesiNessunoClick(Self);
      // Seleziona solo i documenti dell'anno in corso se non si  dentro
      // un cantiere altrimenti li visualizza senza limiti di date
      if PraticaCorrente = '' then
        SBMesiTuttiClick(Self);
      // Azzera la query
      if RxSpeedButtonResetQuery.Tag > 0 then
      begin
        QryDoc.Close;
        QryTotDoc.Close;
      end;
    end;
    if (PageControl2.ActivePage = TabMagazzino) or (RxSpeedButtonResetQuery.Tag > 0) then
    begin
      GMTipoSoggetto.Properties.Items.Clear;
      GMTipoSoggetto.Text := '';
      GMSoloStato.Text := '';
      GMCodiceArticolo.Text := '';
      GMDescrizione.Text := '';
      GMMarca.Text := '';
      GMCodiceGruppo1.Text := '';
      GMCodiceGruppo2.Text := '';
      GMCodiceGruppo3.Text := '';
      GMDescGruppo1.Text := '';
      GMDescGruppo2.Text := '';
      GMDescGruppo3.Text := '';
      GMCausale.Text := '';
      GMAgente.Text := '';
      GMAgente2.Text := '';
      GMAgente3.Text := '';
      GMAgente4.Text := '';
      GMCategCant1.Text := '';
      GMCategCant2.Text := '';
      GMCategCant3.Text := '';
      GMCategCant4.Text := '';
      GMCategCant5.Text := '';
      GMCategCant6.Text := '';
      GMCodiceMagazzino.Text := '';
      GMDescrizioneMagazzino.Text := '';
      FilterGMTipoData.Text := 'Data documento';
      GMDal.EditText := '   /  /20  ';
      GMAl.EditText := '   /  /20  ';
      GMTipo1.Text := '';
      GMTipo2.Text := '';
      GMTipo3.Text := '';
      GMTipo4.Text := '';
      GMTipo5.Text := '';
      GMTipo6.Text := '';
      GMSottocantiere1.EditText := '';
      GMSottocantiere2.EditText := '';
      GMSottocantiere3.EditText := '';
      SBGMNessunoClick(Self);
      // Azzera il tipo operazione
      CLBSegnoOpMagazzino.Checked[0] := True;
      CLBSegnoOpMagazzino.Checked[1] := True;
      CLBSegnoOpMagazzino.Checked[2] := True;
      CLBSegnoOpMagazzino.Checked[3] := True;
      CLBSegnoOpMagazzino.Checked[4] := True;
      CLBSegnoOpCantiere.Checked[0] := True;
      CLBSegnoOpCantiere.Checked[1] := True;
      CLBSegnoOpCantiere.Checked[2] := True;
      CLBSegnoOpCantiere.Checked[3] := True;
      CLBSegnoOpCantiere.Checked[4] := True;
      GMRDA.Text := '';
      // Rimette le date di default
      // Se il Tag del pulsante MesiTutti = 1 significa che questo gestore di evento  stato
      // richiamato dall'evento OnChange del PageControl e non per un click dell'utente sul
      // pulsante stesso, quindi imposta le date al primo giorno e all'ultimo dell'anno in corso
      // ma non mette in  Down tutti i pulsanti dei mesi perch mi piace di pi.
      GMMesiTutti.Tag := 1;
      GMMesiNessunoClick(Self);
      // Seleziona solo i documenti dell'anno in corso se non si  dentro
      // un cantiere altrimenti li visualizza senza limiti di date
      if PraticaCorrente = '' then
        GMMesiTuttiClick(Self);
      // Azzera la query
      if RxSpeedButtonResetQuery.Tag > 0 then
      begin
        QryGM.Close;
        QryTotGM.Close;
      end;
    end;
    if (PageControl2.ActivePage = TabCondVend) or (RxSpeedButtonResetQuery.Tag > 0) then
    begin
      CVCodiceArticolo.Text := '';
      CVDescrizioneArticolo.Text := '';
      CVCodiceGruppo1.Text := '';
      CVCodiceGruppo2.Text := '';
      CVCodiceGruppo3.Text := '';
      CVDescGruppo1.Text := '';
      CVDescGruppo2.Text := '';
      CVDescGruppo3.Text := '';
      // Azzera il tipo condizioni
      TipoCondizione.Checked[0] := True;
      CVControllaTipoCondizione;
      // Azzera la query
      if RxSpeedButtonResetQuery.Tag > 0 then
        QryCV.Close;
    end;
    // NB: Se la "StampeCantieriForm"  esistente significa che siamo all'interno
    // di una stampa riepilogativa di diversi cantieri e quindi evita di chiudere la query
    // perch darebbe un errore.
    // NB: Anche se siamo in fast selection mode evita di chiudere la pratiche
    if (((RxSpeedButtonResetQuery.Tag = 0) and (PageControl2.ActivePage = TabPratiche)) or ((RxSpeedButtonResetQuery.Tag > 1) and (not DM1.FastSelectionMode)))
      and (StampeCantieriForm = nil) then
    begin
      PratCodice.Text := '';
      PratDescrizione.Text := '';
      PratDal.Text := '';
      PratAl.Text := '';
      PratStato.Text := '';
      CantieriApertiChiusi.Checked[0] := True;
      CantieriApertiChiusi.Checked[1] := False;
      PratCategCant1.Text := '';
      PratCategCant2.Text := '';
      PratCategCant3.Text := '';
      PratCategCant4.Text := '';
      PratCategCant5.Text := '';
      PratCategCant6.Text := '';
      PratAgente.Text := '';
      PratAgente2.Text := '';
      PratAgente3.Text := '';
      PratAgente4.Text := '';
      // Chiude la FilterRow se aperta
      if tvPrat.FilterRow.Visible then
      begin
        SBFilterRowPratiche.Down := False;
        SBFilterRowPraticheClick(SBFilterRowPratiche);
      end;
      // Se il Tag del pulsante MesiTutti = 1 significa che questo gestore di evento  stato
      // richiamato dall'evento OnChange del PageControl e non per un click dell'utente sul
      // pulsante stesso, quindi imposta le date al primo giorno e all'ultimo dell'anno in corso
      // ma non mette in  Down tutti i pulsanti dei mesi perch mi piace di pi.
      PratMesiTutti.Tag := 1;
      PratMesiNessunoClick(Self);
      // Azzera la query
      if (RxSpeedButtonResetQuery.Tag > 1) then
      begin
        QryPratiche.Close;
        // Forza la selezione dell'elenco in modo che se si era nella mappa questa venga distrutta
        if PageControlPratiche.ActivePage = TabPraticheMappa then
        begin
          PageControlPratiche.ActivePage := TabPraticheElenco;
          PageControlPraticheChange(PageControlPratiche);
        end;
      end;
    end;

    // NB: Se siamo in fast selection mode evita di chiudere gli impianti
    if ((RxSpeedButtonResetQuery.Tag = 0) and (PageControl2.ActivePage = TabAssistenze) or ((RxSpeedButtonResetQuery.Tag > 1) and (not DM1.FastSelectionMode)))
    then
    begin
      if (RxSpeedButtonResetQuery.Tag > 0) then
      begin
        if TabImpiantiForm <> nil then
        begin
          if (PageControl2.ActivePage = TabAssistenze) then
            TabImpiantiForm.ResetQueryButtonClick(Sender)
          else
            TabImpiantiForm.Close;
        end;
      end
      else
      begin
        TabImpiantiForm.ResetQueryButtonClick(Sender);
      end;
    end;

    if (PageControl2.ActivePage = TabComunicazioni) or (RxSpeedButtonResetQuery.Tag > 1) then
    begin
      if (RxSpeedButtonResetQuery.Tag > 0) then
      begin
        if TabComunicazioniForm <> nil then
        begin
          if (PageControl2.ActivePage = TabComunicazioni) then
            TabComunicazioniForm.ResetQueryButtonClick(Sender)
          else
            TabComunicazioniForm.Close;
        end;
      end
      else
      begin
        TabComunicazioniForm.ResetQueryButtonClick(Sender);
      end;
    end;

    if (PageControl2.ActivePage = TabImpegni) or (RxSpeedButtonResetQuery.Tag > 0) then
    begin
      FilterImpTrova.Text := '';
      ImpTipoIMpegno.Checked[0] := True;
      ImpTipoIMpegno.Checked[1] := True;
      ImpTipoIMpegno.Checked[2] := False;
      ImpConCantiere.Checked[0] := False;
      ImpConCantiere.Checked[1] := False;
      ImpTipoIntervento.Checked[0] := False;
      ImpTipoIntervento.Checked[1] := False;
      ImpTipoIntervento.Checked[2] := False;
      ImpTipoIntervento.Checked[3] := False;
      ImpDal.Text := '';
      ImpAl.Text := '';
      FilterCodiceTecnico.Text := '';
      FilterTecnico.Text := '';
      ImpAgente.Text := '';
      ImpAgente2.Text := '';
      ImpAgente3.Text := '';
      ImpAgente4.Text := '';
      ImpOp1.Text := '';
      ImpOp2.Text := '';
      ImpOp3.Text := '';
      // Chiude la FilterRow se aperta
      if tvImpegni.FilterRow.Visible then
      begin
        SBFilterRowImpegni.Down := False;
        SBFilterRowImpegniClick(SBFilterRowImpegni);
      end;
      // Se il Tag del pulsante MesiTutti = 1 significa che questo gestore di evento  stato
      // richiamato dall'evento OnChange del PageControl e non per un click dell'utente sul
      // pulsante stesso, quindi imposta le date al primo giorno e all'ultimo dell'anno in corso
      // ma non mette in  Down tutti i pulsanti dei mesi perch mi piace di pi.
      ImpMesiTutti.Tag := 1;
      ImpMesiNessunoClick(Self);
      // Seleziona solo i documenti dell'anno in corso se non si  dentro
      // un cantiere altrimenti li visualizza senza limiti di date
      if PraticaCorrente = '' then
        ImpMesiTuttiClick(Self);
      // Azzera la query
      if RxSpeedButtonResetQuery.Tag > 0 then
      begin
        QryImp.Close;
        // Forza la selezione dell'elenco in modo che se si era nella mappa questa venga distrutta
        if PageControlImpegni.ActivePage = TabImpegniMappa then
        begin
          PageControlImpegni.ActivePage := TabImpegniElenco;
          PageControlImpegniChange(PageControlImpegni);
        end;
      end;
    end;
    if (PageControl2.ActivePage = TabPrimanota) or (RxSpeedButtonResetQuery.Tag > 0) then
    begin
      PrmSearchKey.Text := '';
      PrmBanca.Text := '';
      PrmDal.Text := '';
      PrmAl.Text := '';
      PrmAgente.Text := '';
      PrmAgente2.Text := '';
      PrmAgente3.Text := '';
      PrmAgente4.Text := '';
      // Se il Tag del pulsante MesiTutti = 1 significa che questo gestore di evento  stato
      // richiamato dall'evento OnChange del PageControl e non per un click dell'utente sul
      // pulsante stesso, quindi imposta le date al primo giorno e all'ultimo dell'anno in corso
      // ma non mette in  Down tutti i pulsanti dei mesi perch mi piace di pi.
      PrmMesiTutti.Tag := 1;
      PrmMesiNessunoClick(Self);
      // Seleziona solo i documenti dell'anno in corso se non si  dentro
      // un cantiere altrimenti li visualizza senza limiti di date
      if PraticaCorrente = '' then
        PrmMesiTuttiClick(Self);
      // Azzera la query
      if RxSpeedButtonResetQuery.Tag > 0 then
        QueryPrimanota.Close;
    end;

    if (PageControl2.ActivePage = TabGC) or (RxSpeedButtonResetQuery.Tag > 0) then
    begin
      if (RxSpeedButtonResetQuery.Tag > 0) then
      begin
        if TabGCForm <> nil then
        begin
          // if (PageControl2.ActivePage = TabGC)
          // then TabGCForm.ResetQueryButtonClick(Sender)
          // else TabGCForm.Close;
          // NB: Se usavo le righe sopra (che vanno bene per il partitario) non andava bene per il GC
          TabGCForm.Close;
        end;
      end
      else
      begin
        TabGCForm.ResetQueryButtonClick(Sender);
      end;
    end;

    if (PageControl2.ActivePage = TabResOrd) or (RxSpeedButtonResetQuery.Tag > 0) then
    begin
      if (RxSpeedButtonResetQuery.Tag > 0) then
      begin
        if TagResOrdForm <> nil then
        begin
          if (PageControl2.ActivePage = TabResOrd) then
            TagResOrdForm.ResetQueryButtonClick(Sender)
          else
            TagResOrdForm.Close;
        end;
      end
      else
      begin
        TagResOrdForm.ResetQueryButtonClick(Sender);
      end;
    end;

    if (PageControl2.ActivePage = TabGOS) or (RxSpeedButtonResetQuery.Tag > 0) then
    begin
      // if ((PageControl2.ActivePage = TabGOS)and(cxPageControlGOS.ActivePage = TabManodopera))   or   (RxSpeedButtonResetQuery.Tag = 1) then begin
      FilterGosCodiceDipendente.Text := '';
      FilterGosDescrizDipendente.Text := '';
      FilterGosNote.Text := '';
      FilterGosTipoOre1.EditText := '';
      FilterGosTipoOre2.EditText := '';
      FilterGosTipoOre3.EditText := '';
      FilterGosSottocantiere1.EditText := '';
      FilterGosSottocantiere2.EditText := '';
      FilterGosSottocantiere3.EditText := '';
      GosOreAgente.EditText := '';
      GosOreAgente2.EditText := '';
      GosOreAgente3.EditText := '';
      GosOreAgente4.EditText := '';
      GosOreTipo1.EditText := '';
      GosOreTipo2.EditText := '';
      GosOreTipo3.EditText := '';
      GosOreTipo4.EditText := '';
      GosOreTipo5.EditText := '';
      GosOreTipo6.EditText := '';
      GosOreCategCant1.EditText := '';
      GosOreCategCant2.EditText := '';
      GosOreCategCant3.EditText := '';
      GosOreCategCant4.EditText := '';
      GosOreCategCant5.EditText := '';
      GosOreCategCant6.EditText := '';
      FilterGosTipoManodopera.EditText := '';
      FilterGosNumDoc.Text := '';
      FilterGosSoloRegistro.EditText := '';
      FilterGosTranneRegistro.EditText := '';
      FilterGosStato.EditText := '';
      GOSDal.Text := '';
      GOSAl.Text := '';
      // Se il Tag del pulsante MesiTutti = 1 significa che questo gestore di evento  stato
      // richiamato dall'evento OnChange del PageControl e non per un click dell'utente sul
      // pulsante stesso, quindi imposta le date al primo giorno e all'ultimo dell'anno in corso
      // ma non mette in  Down tutti i pulsanti dei mesi perch mi piace di pi.
      GOSMesiTutti.Tag := 1;
      GOSMesiNessunoClick(GOSMesiNessuno);
      // Seleziona solo i documenti dell'anno in corso se non si  dentro
      // un cantiere altrimenti li visualizza senza limiti di date
      if PraticaCorrente = '' then
        GOSMesiTuttiClick(Self);
      // Azzera la query
      if RxSpeedButtonResetQuery.Tag > 0 then
        QryGOSOre.Close;
      // end;
      // if ((PageControl2.ActivePage = TabGOS)and(cxPageControlGOS.ActivePage = TabSpese))   or   (RxSpeedButtonResetQuery.Tag = 1) then begin
      FilterGosSpeseCodiceDipendente.Text := '';
      FilterGosSpeseDescrizDipendente.Text := '';
      FilterGosSpeseDescrizAutomezzo.Text := '';
      FilterGosSpeseNote.Text := '';
      FilterGosTipoCosto1.EditText := '';
      FilterGosTipoCosto2.EditText := '';
      FilterGosTipoCosto3.EditText := '';
      FilterGosSpeseSottocantiere1.EditText := '';
      FilterGosSpeseSottocantiere2.EditText := '';
      FilterGosSpeseSottocantiere3.EditText := '';
      GosSpeseAgente.EditText := '';
      GosSpeseAgente2.EditText := '';
      GosSpeseAgente3.EditText := '';
      GosSpeseAgente4.EditText := '';
      GosSpeseTipo1.EditText := '';
      GosSpeseTipo2.EditText := '';
      GosSpeseTipo3.EditText := '';
      GosSpeseTipo4.EditText := '';
      GosSpeseTipo5.EditText := '';
      GosSpeseTipo6.EditText := '';
      GosSpeseCategCant1.EditText := '';
      GosSpeseCategCant2.EditText := '';
      GosSpeseCategCant3.EditText := '';
      GosSpeseCategCant4.EditText := '';
      GosSpeseCategCant5.EditText := '';
      GosSpeseCategCant6.EditText := '';
      FilterGosSpeseNumDoc.Text := '';
      FilterGosSpeseSoloRegistro.EditText := '';
      FilterGosSpeseTranneRegistro.EditText := '';
      FilterGosSpeseStato.EditText := '';
      GOSSpeseDal.Text := '';
      GOSSpeseAl.Text := '';
      // Se il Tag del pulsante MesiTutti = 1 significa che questo gestore di evento  stato
      // richiamato dall'evento OnChange del PageControl e non per un click dell'utente sul
      // pulsante stesso, quindi imposta le date al primo giorno e all'ultimo dell'anno in corso
      // ma non mette in  Down tutti i pulsanti dei mesi perch mi piace di pi.
      GOSSpeseMesiTutti.Tag := 1;
      GOSSpeseMesiNessunoClick(GOSSpeseMesiNessuno);
      // Seleziona solo i documenti dell'anno in corso se non si  dentro
      // un cantiere altrimenti li visualizza senza limiti di date
      if PraticaCorrente = '' then
        GOSSpeseMesiTuttiClick(Self);
      // Azzera la query
      if RxSpeedButtonResetQuery.Tag > 0 then
        QryGOSSpese.Close;
    end;

    if (PageControl2.ActivePage = TabScadenze) or (RxSpeedButtonResetQuery.Tag > 0) then
    begin
      ScadCodice.Text := '';
      ScadDescrizione.Text := '';
      ScadDal.Text := '';
      ScadAl.Text := '';
      TipoScadenze.Checked[0] := True;
      TipoScadenze.Checked[1] := True;
      TipoScadenze.Checked[2] := True;
      TipoScadenze2.Checked[0] := False;
      TipoScadenze2.Checked[1] := False;
      TipoScadenze3.Checked[0] := True;
      TipoScadenze3.Checked[1] := True;
      TipoImporto.Checked[0] := True;
      TipoImporto.Checked[1] := False;
      ScadTipoDoc.Text := '';
      ScadNumDoc.Text := '';
      ScadRegistro.Text := '';
      ScadDataDoc.Text := '';
      ScadAgente.Text := '';
      ScadAgente2.Text := '';
      ScadAgente3.Text := '';
      ScadAgente4.Text := '';
      ScadStato.Text := '';
      ScadSoloRegistro.Text := '';
      ScadTranneRegistro.Text := '';
      ScadTipoData.Text := 'Data di scadenza';
      ScadPresentataBanca.Text := '';
      // Se il Tag del pulsante MesiTutti = 1 significa che questo gestore di evento  stato
      // richiamato dall'evento OnChange del PageControl e non per un click dell'utente sul
      // pulsante stesso, quindi imposta le date al primo giorno e all'ultimo dell'anno in corso
      // ma non mette in  Down tutti i pulsanti dei mesi perch mi piace di pi.
      ScadMesiTutti.Tag := 1;
      ScadMesiNessunoClick(Self);
      // Seleziona solo i documenti dell'anno in corso se non si  dentro
      // un cantiere altrimenti li visualizza senza limiti di date
      if PraticaCorrente = '' then
        ScadMesiTuttiClick(Self);
      // Azzera la query
      if RxSpeedButtonResetQuery.Tag > 0 then
        QryScad.Close;
    end;
    if (RxSpeedButtonResetQuery.Tag = 1) then
    begin
      // Passa di qu quando si seleziona o deseleziona un cliente o una pratica e
      // per simulare il comportamento degli altri Tab normali, distrugge la Form.
      if PrimanotaForm <> nil then
        PrimanotaForm.Close;
    end;
    // Rimette a posto il Tag
    RxSpeedButtonResetQuery.Tag := 0;

  finally
    // DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.SpeedButton28Click(Sender: TObject);
var
  I: Integer;
begin
  PivotGridDoc.BeginUpdate;
  try
    for I := 0 to PivotGridDoc.FieldCount - 1 do
      PivotGridDoc.Fields[I].ExpandAll;
  finally
    PivotGridDoc.EndUpdate;
  end;
end;

procedure TClientiForm.SpeedButton29Click(Sender: TObject);
begin
  // Attiva/Disattiva la Filter Row
  tvScad.FilterRow.Visible := (Sender as TSpeedButton).Down;
  if tvScad.FilterRow.Visible then
    tvScad.FilterBox.Visible := TcxGridFilterVisible.fvAlways
  else
  begin
    tvScad.DataController.Filter.Clear;
    tvScad.FilterBox.Visible := TcxGridFilterVisible.fvNonEmpty
  end;
end;

procedure TClientiForm.RxSpeedButtonNuovoClick(Sender: TObject);
var
  ClientPoint, ScreenPoint: TPoint;
begin
  // Se il database  gi in transazione e quindi significa che c' stato qualche problema
  // a qualche transazione precedente che potrebbe causare una perdita di dati. Quindi
  // avverte l'utente e lo informa che ilprogramma si chideer automaticamente.
  if (DM1.DBAzienda.InTransaction) and (PageControl2.ActivePage <> TabGC)
  // Perch se siamo nel giornale di cantiere  normale che ci sia la transazione aperta.
  then
  begin
    // Verifica che non ci siano gi transazioni in atto e se ci sono lanca un allarme
    DM1.CheckForAlreadyInTransaction;
  end;

  // Esegue la conversione delle coordinate dove dovr apparire il men
  // da coordinate client della finestra a coordinate assolute dello schermo.
  // (NB: Il men popup apparir in prossimit del tasto NUOVO)
  ClientPoint.X := RxSpeedButtonNuovo.Left + POPUP_X_OFFSET + ClientTopPanel.Left;
  ClientPoint.Y := RxSpeedButtonNuovo.Top + POPUP_Y_OFFSET;
  ScreenPoint := ClientToScreen(ClientPoint);

  // Se siamo in FastSelectionMode
  if DM1.FastSelectionMode then
  begin

    // ==========================================================================
    // MENU AGGIUNGI PER FAST SELECTION MODE
    // --------------------------------------------------------------------------
    MenuAggiungiForm.Left := ScreenPoint.X - 5;
    MenuAggiungiForm.Top := ScreenPoint.Y - 45; // +5
    MenuAggiungiForm.Show;
    // Per maggiore prontezza nell'aggiornamento a video
    MenuAggiungiForm.Update;
    Application.ProcessMessages;
    // ==========================================================================

    // Se invece siamo in modalit normale
  end
  else
  begin

    // ==========================================================================
    // MENU AGGIUNGI PER NORMAL SELECTION MODE
    // --------------------------------------------------------------------------
    // IN base alla pagina attiva richiama il men appropriato
    if PageControl2.ActivePage = TabClienti then
      MenuSoggetti.Popup(ScreenPoint.X, ScreenPoint.Y)
    else if PageControl2.ActivePage = TabDocumenti then
      MenuDocumenti.Popup(ScreenPoint.X, ScreenPoint.Y)
    else if PageControl2.ActivePage = TabGOS then
      MenuDocumenti.Popup(ScreenPoint.X, ScreenPoint.Y)
    else if PageControl2.ActivePage = TabMagazzino then
      MenuDocumenti.Popup(ScreenPoint.X, ScreenPoint.Y)
    else if PageControl2.ActivePage = TabCondVend then
      MenuCondVend.Popup(ScreenPoint.X, ScreenPoint.Y)
    else if PageControl2.ActivePage = TabPratiche then
      MenuPratiche.Popup(ScreenPoint.X, ScreenPoint.Y)
    else if PageControl2.ActivePage = TabAssistenze then
      MenuAssistenze.Popup(ScreenPoint.X, ScreenPoint.Y)
    else if (PageControl2.ActivePage = TabComunicazioni) and (TabComunicazioniForm <> nil) then
    begin
      TabComunicazioniForm.MenuAggiungi.Popup(ScreenPoint.X, ScreenPoint.Y);
    end
    else if PageControl2.ActivePage = TabScadenze then
      MenuScadenzario.Popup(ScreenPoint.X, ScreenPoint.Y)
    else if PageControl2.ActivePage = TabImpegni then
      MenuImpegni.Popup(ScreenPoint.X, ScreenPoint.Y)
    else if PageControl2.ActivePage = TabPrimanota then
      MenuPrimanota.Popup(ScreenPoint.X, ScreenPoint.Y)
    else if PageControl2.ActivePage = TabAgenda then
      MenuAgenda.Popup(ScreenPoint.X, ScreenPoint.Y)
    else if PageControl2.ActivePage = TabGC then
    begin
      // ------------------------
      // Se siamo nel GC e siamo in modofica visualizza il menu per l'inserimento di un nuovo rigo
      // se invece non siamo in modalit di modifica visualizza quello per l'emissione di un nuovo
      // documento.
      if RxSpeedModifica.Down then
        TabGCForm.MenuGCAggiungi.Popup(ScreenPoint.X, ScreenPoint.Y)
      else
        MenuDocumenti.Popup(ScreenPoint.X, ScreenPoint.Y);
      // ------------------------
    end
    else if PageControl2.ActivePage = TabArticoli then
      MenuArticoli.Popup(ScreenPoint.X, ScreenPoint.Y);
    // ==========================================================================

  end;

end;

procedure TClientiForm.RxSpeedButtonStampaClick(Sender: TObject);
var
  ClientPoint, ScreenPoint: TPoint;
begin
  // ==========================================================================
  // STAMPA MAPPE
  // --------------------------------------------------------------------------
  // Mappa Rubrica
  if (PageControl2.ActivePage = TabClienti) and (PageControlClienti.ActivePage = TabClientiMappa) then
  begin
    MapFormRubrica.PrintPreview;
    Exit;
    // Mappa Pratiche
  end
  else if (PageControl2.ActivePage = TabPratiche) and (PageControlPratiche.ActivePage = TabPraticheMappa) then
  begin
    MapFormPratiche.PrintPreview;
    Exit;
    // Mappa Impegni
  end
  else if (PageControl2.ActivePage = TabImpegni) and (PageControlImpegni.ActivePage = TabImpegniMappa) then
  begin
    MapFormImpegni.PrintPreview;
    Exit;
  end;
  // ==========================================================================

  // Esegue la conversione delle coordinate dove dovr apparire il men
  // da coordinate client della finestra a coordinate assolute dello schermo.
  // (NB: Il men popup apparir in prossimit del tasto NUOVO)
  ClientPoint.X := RxSpeedButtonStampa.Left + POPUP_X_OFFSET + ClientTopPanel.Left;
  ClientPoint.Y := RxSpeedButtonStampa.Top + POPUP_Y_OFFSET;
  ScreenPoint := ClientToScreen(ClientPoint);
  // Imposta la propriet TAG del men (0=Anteprima, 1=Stampa, 2=Fax, 3=Email)
  MenuStampe.Tag := 1;
  MenuStampe.Popup(ScreenPoint.X, ScreenPoint.Y);
end;

procedure TClientiForm.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  // Se esiste chiude la form del >Giornale di CAntiere
  if Assigned(TabGCForm) then
    TabGCForm.Close;
  if Assigned(TabComunicazioniForm) then
    TabComunicazioniForm.Close;
  if Assigned(TagResOrdForm) then
    TagResOrdForm.Close;

  // Chiede conferma per l'uscita dall'azieda corrente in modo che l'utente non esca per sbaglio
  // dall'azienda corrente e poi debba rieffettuare il login che  una palla.
  if (not MainForm.IsLevanteLight) and (DM1.Messaggi('Uscita', 'Vuoi veramente uscire dall''azienda "' + DM1.AziendaCorrente + '"?', '', [mbYes, mbNo], 0, nil)
    <> mrYes) then
  begin
    Action := caNone;
    Exit;
  end;

  // Effettua il fade out della form
  // NB: Non pi necessario da quando la MainForm  a tutta grandezza
  MainForm.FormFadeOut(MainForm);

  // Se esiste la Form del teletrasporto significa che l'utente  ancora
  // collegato con esso e quindi lo chiude prima di proseguire
  if ScambioDocForm <> nil then
  begin
    ScambioDocForm.SBChiudiTeletrasportoClick(ScambioDocForm.SBChiudiTeletrasporto);
  end;

  // Distrugge eventuali form che potrebbero essere ancora esistenti
  if PrimanotaForm <> nil then
    PrimanotaForm.Close;
  if TabPartitarioForm <> nil then
    TabPartitarioForm.Close;
  if TabImpiantiForm <> nil then
    TabImpiantiForm.Close;

  Action := caFree;
  DM1.QueryDocSel.Close;

  // Rende il main menu invisibile
  MainForm.MainMenuInvisibile;
  // Avvia il timer alla scadenza del quale avverr la disconnessione
  // dai databases e quando anche questa disconnessione  terminata
  // visualizza di nuovo la schermata di Login.
  // NB: Tutto questo perch altrimenti quando si usciva veniva visualizzata
  // la schermata di Login con nella parte centrale ancora la schermata sotto
  // e questo era piuttosto brutto. Visto che il problema era dovuto
  // all'attesa della disconnessione dai databases ho escogitato questo sistema
  // per risolverlo.
  DM1.ShowWait('Levante', 'Chiusura della sessione...');
  MainForm.TimerStartStop.Tag := 2;
  MainForm.TimerStartStop.Interval := 500;
  MainForm.TimerStartStop.Enabled := True;

  // Resetta il puntatore alla form
  ClientiForm := nil;
end;

procedure TClientiForm.FormKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  case Key of

    // ESC
    27:
      begin
        if (RxSpeedButtonUscita.Enabled) and (PageControl2.ActivePage <> TabClienti) then
        begin
          RxSpeedButtonUscitaClick(Self);
        end
        else
        begin
          MessageBeep(0);
        end;
      end;

    // Shift + F1 = Elenco clienti
    // Se non  premuto il tasto shift prosegue normalmente,
    // altrimenti seleziona la pagina del PageControl relativa.
    112:
      begin
        if (ssShift in Shift) and TabClienti.TabVisible then
        begin
          PageControl2.ActivePage := TabClienti;
          PageControl2Change(Self);
        end;
      end;

    // Shift + F2 = Elenco documenti selezionati
    // Se non  premuto il tasto shift prosegue normalmente,
    // altrimenti seleziona la pagina del PageControl relativa.
    113:
      begin
        if (ssShift in Shift) and TabDocumenti.TabVisible then
        begin
          PageControl2.ActivePage := TabDocumenti;
          PageControl2Change(Self);
        end;
      end;

    // F3 = Nuovo
    114:
      begin
        if RxSpeedButtonNuovo.Enabled then
        begin
          RxSpeedButtonNuovoClick(Self);
        end;
      end;

    // F4 = Elimina
    115:
      begin
        if RxSpeedButtonElimina.Enabled then
        begin
          RxSpeedButtonEliminaClick(Self);
        end;
      end;

    // F5 = Trova
    116:
      begin
        if RxSpeedButtonTrova.Enabled then
        begin
          RxSpeedButtonTrovaClick(Self);
        end;
      end;

    // F5 = Azzera condizioni ricerca
    117:
      begin
        if RxSpeedButtonResetQuery.Enabled then
        begin
          RxSpeedButtonResetQueryClick(Self);
        end;
      end;

    // F7 = Stampa
    118:
      begin
        if RxSpeedButtonStampa.Enabled then
        begin
          RxSpeedButtonStampaClick(Self);
        end;
      end;

    // F10 = Visualizza
    121:
      begin
        if RxSpeedButtonVisualizza.Enabled then
        begin
          RxSpeedButtonVisualizzaClick(Self);
        end;
      end;

    // F11 = Focus sul Trova
    122:
      begin
        // Procedure che sposta il focus sul Trova dell'elenco attualmente visualizzato
        SetFocusOnTrova(ssShift in Shift);
      end;

    // F12 = Apru/Chiudi agenda laterale
    123:
      begin
        // Ovviamente solo se siamo in FastSelectionMode e l'agenda  attivata
        if (DM1.FastSelectionMode) and (not MainForm.IsLevanteLight) and (SplitterAgendaRight.Visible) then
        begin
          if SplitterAgendaRight.State = ssOpened then
            SplitterAgendaRight.CloseSplitter
          else if SplitterAgendaRight.State = ssClosed then
            SplitterAgendaRight.OpenSplitter;
        end;
      end;

  end;

end;

// Procedure che sposta il focus sul Trova dell'elenco attualmente visualizzato
procedure TClientiForm.SetFocusOnTrova(OpenCloseFilters: Boolean = False);
begin
  // Soggetti
  if (PageControl2.ActivePage = TabClienti) and (PageControlClienti.ActivePage = TabClientiElenco) then
  begin
    if OpenCloseFilters then
      SBRubricaFilterOpenCloseClick(SBRubricaFilterOpenClose)
    else if FilterRubricaTrova.Visible and FilterRubricaTrova.Enabled then
      FilterRubricaTrova.SetFocus;

    // Documenti
  end
  else if (PageControl2.ActivePage = TabDocumenti) then
  begin
    if OpenCloseFilters then
      SBDocFilterOpenCloseClick(SBDocFilterOpenClose)
    else if FilterTesto.Visible and FilterTesto.Enabled then
      FilterTesto.SetFocus;

    // GM
  end
  else if (PageControl2.ActivePage = TabMagazzino) then
  begin
    if OpenCloseFilters then
      SBGMFilterOpenCloseClick(SBGMFilterOpenClose)
    else if GMDescrizione.Visible and GMDescrizione.Enabled then
      GMDescrizione.SetFocus;

    // Cantieri/Pratiche
  end
  else if (PageControl2.ActivePage = TabPratiche) and (PageControlPratiche.ActivePage = TabPraticheElenco) then
  begin
    if OpenCloseFilters then
      SBPratFilterOpenCloseClick(SBPratFilterOpenClose)
    else if PratDescrizione.Visible and PratDescrizione.Enabled then
      PratDescrizione.SetFocus;

    // Scadenze
  end
  else if (PageControl2.ActivePage = TabScadenze) then
  begin
    if OpenCloseFilters then
      SBScadFilterOpenCloseClick(SBScadFilterOpenClose)
    else if ScadDescrizione.Visible and ScadDescrizione.Enabled then
      ScadDescrizione.SetFocus;

    // Primanota
  end
  else if (PageControl2.ActivePage = TabPrimanota) then
  begin
    if OpenCloseFilters then
      SBPrimanotFilterOpenCloseClick(SBPrimanotFilterOpenClose)
    else if PrmSearchKey.Visible and PrmSearchKey.Enabled then
      PrmSearchKey.SetFocus;

    // Articoli
  end
  else if (PageControl2.ActivePage = TabArticoli) then
  begin
    if OpenCloseFilters then
      SBArtFilterOpenCloseClick(SBArtFilterOpenClose)
    else if FilterArtTrova.Visible and FilterArtTrova.Enabled then
      FilterArtTrova.SetFocus;

    // Impegni
  end
  else if (PageControl2.ActivePage = TabImpegni) and (PageControlImpegni.ActivePage = TabImpegniElenco) then
  begin
    if OpenCloseFilters then
      SBImpFilterOpenCloseClick(SBImpFilterOpenClose)
    else if FilterImpTrova.Visible and FilterImpTrova.Enabled then
      FilterImpTrova.SetFocus;

    // GOS
  end
  else if (PageControl2.ActivePage = TabGOS) then
  begin
    if cxPageControlGOS.ActivePage = TabManodopera then
    begin
      if OpenCloseFilters then
        SBGosFilterOpenCloseClick(SBGosFilterOpenClose)
      else if FilterGosNote.Visible and FilterGosNote.Enabled then
        FilterGosNote.SetFocus;
    end
    else if cxPageControlGOS.ActivePage = TabSpese then
    begin
      if OpenCloseFilters then
        SBGosSpeseFilterOpenCloseClick(SBGosSpeseFilterOpenClose)
      else if FilterGosSpeseNote.Visible and FilterGosSpeseNote.Enabled then
        FilterGosSpeseNote.SetFocus;
    end;

    // Impianti
  end
  else if (PageControl2.ActivePage = TabAssistenze) and Assigned(TabImpiantiForm) and
    (TabImpiantiForm.PageControlAssistenze.ActivePage = TabImpiantiForm.TabAssElenco) then
  begin
    if OpenCloseFilters then
      TabImpiantiForm.SBAssFilterOpenCloseClick(TabImpiantiForm.SBAssFilterOpenClose)
    else if TabImpiantiForm.FilterAssTrova.Visible and TabImpiantiForm.FilterAssTrova.Enabled then
      TabImpiantiForm.FilterAssTrova.SetFocus;

    // Comunicazioni
  end
  else if (PageControl2.ActivePage = TabComunicazioni) and Assigned(TabComunicazioniForm) and
    (TabComunicazioniForm.PageControl.ActivePage = TabComunicazioniForm.TabElenco) then
  begin
    if OpenCloseFilters then
      TabComunicazioniForm.SBFilterOpenCloseClick(TabComunicazioniForm.SBFilterOpenClose)
    else if TabComunicazioniForm.FilterTrova.Visible and TabComunicazioniForm.FilterTrova.Enabled then
      TabComunicazioniForm.FilterTrova.SetFocus;

    // GC
  end
  else if (PageControl2.ActivePage = TabGC) and Assigned(TabGCForm) then
  begin
    if OpenCloseFilters then
      TabGCForm.SBGCFilterOpenCloseClick(TabGCForm.SBGCFilterOpenClose)
    else if TabGCForm.FilterGCTrova.Visible and TabGCForm.FilterGCTrova.Enabled then
      TabGCForm.FilterGCTrova.SetFocus;

    // ResOrd
  end
  else if (PageControl2.ActivePage = TabResOrd) and Assigned(TagResOrdForm) then
  begin
    if OpenCloseFilters then
      TagResOrdForm.SBFilterOpenCloseClick(TagResOrdForm.SBFilterOpenClose)
    else if TagResOrdForm.FilterTrova.Visible and TagResOrdForm.FilterTrova.Enabled then
      TagResOrdForm.FilterTrova.SetFocus;

    // Partitario
  end
  else if (PageControl2.ActivePage = TabPartitario) and Assigned(TabPartitarioForm) then
  begin
    if TabPartitarioForm.PageControlPartitario.ActivePage = TabPartitarioForm.TabPartSoggetti then
    begin
      if OpenCloseFilters then
        TabPartitarioForm.SBPartFilterOpenCloseClick(TabPartitarioForm.SBPartFilterOpenClose)
      else if TabPartitarioForm.PartFilterDescrizione.Visible and TabPartitarioForm.PartFilterDescrizione.Enabled then
        TabPartitarioForm.PartFilterDescrizione.SetFocus;
    end
    else if TabPartitarioForm.PageControlPartitario.ActivePage = TabPartitarioForm.TabPartIva then
    begin
      if OpenCloseFilters then
        TabPartitarioForm.SBPartIvaFilterOpenCloseClick(TabPartitarioForm.SBPartIvaFilterOpenClose)
      else if TabPartitarioForm.PartIvaFilterDescrizione.Visible and TabPartitarioForm.PartIvaFilterDescrizione.Enabled then
        TabPartitarioForm.PartIvaFilterDescrizione.SetFocus;
    end
    else if TabPartitarioForm.PageControlPartitario.ActivePage = TabPartitarioForm.TabPartAltro then
    begin
      if OpenCloseFilters then
        TabPartitarioForm.SBPartAltroFilterOpenCloseClick(TabPartitarioForm.SBPartAltroFilterOpenClose)
      else if TabPartitarioForm.PartAltroFilterDescrizione.Visible and TabPartitarioForm.PartAltroFilterDescrizione.Enabled then
        TabPartitarioForm.PartAltroFilterDescrizione.SetFocus;
    end;

  end;
end;

procedure TClientiForm.MenuStampePopup(Sender: TObject);
var
  contatore: Integer;
  LO, Menu: TMemIniFile;
  TmpBool: Boolean;
begin
  LO := TMemIniFile.Create(DM1.Repository_Layouts.FullLocalFileName);
  Menu := TMemIniFile.Create(DM1.Repository_Menu.FullLocalFileName);
  try
    // Reset del sistema per la stampa del range di date sul titolo del report.
    DM1.SetReportDateRange('', '');
    // Rende invisibile tutto il men
    for contatore := 0 to (MenuStampe.Items.Count - 1) do
    begin
      MenuStampe.Items[contatore].Visible := False;
    end;
    // In base alla pagina selezionata visualizza le voci del men opportune
    if PageControl2.ActivePage = TabClienti then
    begin
      Elencoclienti1.Visible := True;
      Stampaetichetteclienti1.Visible := True;
      Stampaetichettedeiclientiselezionati1.Visible := True;

    end
    else if PageControl2.ActivePage = TabPratiche then
    begin
      Stampaelencocantieri1.Visible := True;
      Stamperiepilogativecantieri1.Visible := True;

    end
    else if PageControl2.ActivePage = TabAssistenze then
    begin
      Stampaelencoimpianti1.Visible := True;

    end
    else if PageControl2.ActivePage = TabComunicazioni then
    begin
      Stampaelencocomunicazioni1.Visible := True;

    end
    else if PageControl2.ActivePage = TabDocumenti then
    begin
      Stampacumulativadeidocumentiselezionati1.Visible := (PageControlDoc.ActivePage = TabSheetDocGrid) and (not MainForm.IsLevanteLight);
      Elencodocumenti1.Visible := (PageControlDoc.ActivePage = TabSheetDocGrid);
      StampaADADocumenti.Visible := (PageControlDoc.ActivePage = TabSheetDocADA) and (not MainForm.IsLevanteLight);
      Stampagraficodocumenti1.Visible := (PageControlDoc.ActivePage = TabSheetDocCharts) and (not MainForm.IsLevanteLight);

    end
    else if PageControl2.ActivePage = TabScadenze then
    begin
      Stampaelencoscadenze1.Visible := (PageControlScad.ActivePage = TabScadElenco);
      StampaADAscadenze1.Visible := (PageControlScad.ActivePage = TabScadADA);
      Stampagraficoscadenze1.Visible := (PageControlScad.ActivePage = TabScadCharts);
      StampadistintadipresentazioneRIBAperlabanca1.Visible := (PageControlScad.ActivePage = TabScadElenco);

    end
    else if PageControl2.ActivePage = TabImpegni then
    begin
      TmpBool := LO.ReadBool('ElencoAppuntamenti', 'StampaTagAppuntamento', False);
      StampacumulativadelKITperiltecnicodegliappuntamentiselezionati1.Visible := not TmpBool;
      StampacumulativadelFoglidiLavorodegliappuntamentiselezionati1.Visible := not TmpBool;
      Stampacumulativaappuntamentiselezionati1.Visible := TmpBool;
      Stampaelencochiamateappuntamentiinterventi1.Visible := True;

    end
    else if PageControl2.ActivePage = TabPrimanota then
    begin
      Stampamovimentiprimanota1.Visible := True;

    end
    else if PageControl2.ActivePage = TabMagazzino then
    begin
      GiornaleDiMagazzino1.Caption := Menu.ReadString('GiornaleMagazzino', 'Stampe_TitoloStampaElencoGM', 'Stampa giornale di magazzino');
      StampaADAgiornaledimagazzino1.Caption := Menu.ReadString('GiornaleMagazzino', 'Stampe_TitoloStampaADAGM', 'Stampa ADA giornale di magazzino');
      Stampagraficogiornaledimagazzino1.Caption := Menu.ReadString('GiornaleMagazzino', 'Stampe_TitoloStampaGraficoGM', 'Stampa grafico giornale di magazzino');
      GiornaleDiMagazzino1.Visible := (PageControlGM.ActivePage = TabGMGrid);
      StampaADAgiornaledimagazzino1.Visible := (PageControlGM.ActivePage = TabGMADA);
      Stampagraficogiornaledimagazzino1.Visible := (PageControlGM.ActivePage = TabGMGrafici);

    end
    else if PageControl2.ActivePage = TabGC then
    begin
      if TabGCForm.cxPageControlGC.ActivePage = TabGCForm.TabGCElenco then
      begin
        Stampagiornaledicantiere1.Visible := True;
        Stampagiornaledicantiere1.Caption := Menu.ReadString('GiornaleCantiere', 'Stampe_TitoloStampaElencoGC', 'Stampa giornale di cantiere');
      end
      else if TabGCForm.cxPageControlGC.ActivePage = TabGCForm.TabGCCharts then
      begin
        Stampagraficocantiere1.Visible := True;
        Stampagraficocantiere1.Caption := Menu.ReadString('GiornaleCantiere', 'Stampe_TitoloStampaGraficoGC', 'Stampa grafico cantiere');
      end;
    end
    else if PageControl2.ActivePage = TabResOrd then
    begin
      Stamparesiduoordini1.Visible := True;

    end
    else if PageControl2.ActivePage = TabPartitario then
    begin
      Stampapartitario1.Visible := True;

    end
    else if PageControl2.ActivePage = TabArticoli then
    begin
      // Visibilit voci
      ElencoArticoli1.Visible := True;
      InventarioUltimoCosto1.Visible := True;
      Stampainventarioultimocostosustampanteadaghi1.Visible := True;
      Stampaetichettearticoli1.Visible := True;
      Stampaetichettedegliarticoliselezionati1.Visible := True;
      Stampalistinocatalogofigurato1.Visible := True;
      // Attivazione voci
      ElencoArticoli1.Enabled := True;
      InventarioUltimoCosto1.Enabled := (not MainForm.IsLevanteLight);
      Stampainventarioultimocostosustampanteadaghi1.Enabled := (not MainForm.IsLevanteLight);
      Stampaetichettearticoli1.Enabled := (not MainForm.IsLevanteLight);
      Stampaetichettedegliarticoliselezionati1.Enabled := (not MainForm.IsLevanteLight);
      Stampalistinocatalogofigurato1.Enabled := (not MainForm.IsLevanteLight);

    end
    else if ((PageControl2.ActivePage = TabGOS) and (cxPageControlGOS.ActivePage = TabManodopera)) then
    begin
      Stamparapportooredipendenti1.Visible := True;
      StampaADAdipendenti1.Visible := True;
      Stampagraficooredipendenti1.Visible := True;

    end
    else if ((PageControl2.ActivePage = TabGOS) and (cxPageControlGOS.ActivePage = TabSpese)) then
    begin
      Stamparapportospesevarie1.Visible := True;
      StampaADAspesevarie1.Visible := True;
      Stampagraficospesevarie1.Visible := True;

    end;

    // Determina la visualizza o meno delle voci relative all'agenda
    // NB: Separatamente altrimenti in FastSelectionMode non funziona
    if ((not DM1.FastSelectionMode) and (PageControl2.ActivePage = TabAgenda)) or ((DM1.FastSelectionMode) and (AgendaForm.Splitter.State = ssOpened)) then
    begin
      TmpBool := LO.ReadBool('AGENDA', 'StampaTagAppuntamento', False);
      StampacumulativadelKITperiltecnicodegliappuntamentiselezionati2.Visible := not TmpBool;
      StampacumulativadelFogliodiLavorodegliappuntamentiselezionati1.Visible := not TmpBool;
      Stampaagenda1.Visible := True;
    end;

  finally
    LO.Free;
    Menu.Free;
  end;
end;

procedure TClientiForm.SBGenClick(Sender: TObject);
var
  GG, MM, AA: Word;
  Mese: Shortint;
begin
  // Mese contiene l'indice del mese premuto
  Mese := (Sender as TSpeedButton).Tag;
  // AA COntiene l'anno in corso
  DecodeDate(Date, AA, MM, GG);
  // Se il GroupIndex  <> 500 significa che  stato premuto il
  // tasto di selezione di tutti i mesi e quindi si comporta di conseguenza
  if (Sender as TSpeedButton).GroupIndex <> 500 then
  begin
    SBMesiNessunoClick(Self);
    (Sender as TSpeedButton).Down := True;
  end;
  // Se il pulsante  premuto (down)...
  if (Sender as TSpeedButton).Down then
  begin
    // In base all'indice del mese imposta le date nel modo opportuno
    case Mese of
      1:
        begin
          DateEditDa.Text := ' 01/01/' + IntToStr(AA);
          DateEditA.Text := ' 31/01/' + IntToStr(AA);
        end;
      2:
        begin
          DateEditDa.Text := ' 01/02/' + IntToStr(AA);
          DateEditA.Text := ' ' + IntToStr(DaysInAMonth(CurrentYear, 2)) + '/02/' + IntToStr(AA);
        end;
      3:
        begin
          DateEditDa.Text := ' 01/03/' + IntToStr(AA);
          DateEditA.Text := ' 31/03/' + IntToStr(AA);
        end;
      4:
        begin
          DateEditDa.Text := ' 01/04/' + IntToStr(AA);
          DateEditA.Text := ' 30/04/' + IntToStr(AA);
        end;
      5:
        begin
          DateEditDa.Text := ' 01/05/' + IntToStr(AA);
          DateEditA.Text := ' 31/05/' + IntToStr(AA);
        end;
      6:
        begin
          DateEditDa.Text := ' 01/06/' + IntToStr(AA);
          DateEditA.Text := ' 30/06/' + IntToStr(AA);
        end;
      7:
        begin
          DateEditDa.Text := ' 01/07/' + IntToStr(AA);
          DateEditA.Text := ' 31/07/' + IntToStr(AA);
        end;
      8:
        begin
          DateEditDa.Text := ' 01/08/' + IntToStr(AA);
          DateEditA.Text := ' 31/08/' + IntToStr(AA);
        end;
      9:
        begin
          DateEditDa.Text := ' 01/09/' + IntToStr(AA);
          DateEditA.Text := ' 30/09/' + IntToStr(AA);
        end;
      10:
        begin
          DateEditDa.Text := ' 01/10/' + IntToStr(AA);
          DateEditA.Text := ' 31/10/' + IntToStr(AA);
        end;
      11:
        begin
          DateEditDa.Text := ' 01/11/' + IntToStr(AA);
          DateEditA.Text := ' 30/11/' + IntToStr(AA);
        end;
      12:
        begin
          DateEditDa.Text := ' 01/12/' + IntToStr(AA);
          DateEditA.Text := ' 31/12/' + IntToStr(AA);
        end;
    end;
    // Se invece il mese non  premuto...
  end
  else
  begin
    DateEditDa.Text := '';
    DateEditA.Text := '';
  end;
end;

procedure TClientiForm.SBDocTuttiClick(Sender: TObject);
var
  I: Byte;
begin
  // Cicla per tutti i documenti di vendita e li seleziona tutti
  if DocVendite.Items.Count > 0 then
    for I := 0 to DocVendite.Items.Count - 1 do
      DocVendite.Items[I].Checked := True;

  // Cicla per tutti i documenti di acquisto  e li seleziona tutti
  if DocAcquisti.Items.Count > 0 then
    for I := 0 to DocAcquisti.Items.Count - 1 do
      DocAcquisti.Items[I].Checked := True;

  // Cicla per tutti gli altri  documenti e li seleziona tutti
  if DocAltri.Items.Count > 0 then
    for I := 0 to DocAltri.Items.Count - 1 do
      DocAltri.Items[I].Checked := True;
end;

procedure TClientiForm.SBDocNessunoClick(Sender: TObject);
var
  I: Byte;
begin
  // Cicla per tutti i documenti di vendita e li seleziona tutti
  if DocVendite.Items.Count > 0 then
    for I := 0 to DocVendite.Items.Count - 1 do
      DocVendite.Items[I].Checked := False;

  // Cicla per tutti i documenti di acquisto  e li seleziona tutti
  if DocAcquisti.Items.Count > 0 then
    for I := 0 to DocAcquisti.Items.Count - 1 do
      DocAcquisti.Items[I].Checked := False;

  // Cicla per tutti gli altri  documenti e li seleziona tutti
  if DocAltri.Items.Count > 0 then
    for I := 0 to DocAltri.Items.Count - 1 do
      DocAltri.Items[I].Checked := False;
end;

procedure TClientiForm.SBMesiTuttiClick(Sender: TObject);
begin
  DateEditDa.EditText := DM1.FilterDataDalDefault;
  DateEditA.EditText := DM1.FilterDataAlDefault;
  // Se il Tag del pulsante MesiTutti = 1 significa che questo gestore di evento  stato
  // richiamato dall'evento OnChange del PageControl e non per un click dell'utente sul
  // pulsante stesso, quindi imposta le date al primo giorno e all'ultimo dell'anno in corso
  // ma non mette in  Down tutti i pulsanti dei mesi perch mi piace di pi.
  // if SBMesiTutti.Tag = 0 then begin
  // In questo modo posso metterli tutti in DOWN contemporaneamente
  SBGen.GroupIndex := 501;
  SBFeb.GroupIndex := 502;
  SBMar.GroupIndex := 503;
  SBApr.GroupIndex := 504;
  SBMag.GroupIndex := 505;
  SBGiu.GroupIndex := 506;
  SBLug.GroupIndex := 507;
  SBAgo.GroupIndex := 508;
  SBSet.GroupIndex := 509;
  SBOtt.GroupIndex := 510;
  SBNov.GroupIndex := 511;
  SBDic.GroupIndex := 512;
  SBGen.Down := False;
  SBFeb.Down := False;
  SBMar.Down := False;
  SBApr.Down := False;
  SBMag.Down := False;
  SBGiu.Down := False;
  SBLug.Down := False;
  SBAgo.Down := False;
  SBSet.Down := False;
  SBOtt.Down := False;
  SBNov.Down := False;
  SBDic.Down := False;
  // end else begin
  // Rimette il Tag del pulsante = 0
  SBMesiTutti.Tag := 0;
  // end;
end;

procedure TClientiForm.SBMesiNessunoClick(Sender: TObject);
begin
  DateEditDa.Clear;
  DateEditA.Clear;
  // In questo modo posso metterli tutti in DOWN contemporaneamente
  SBGen.GroupIndex := 500;
  SBFeb.GroupIndex := 500;
  SBMar.GroupIndex := 500;
  SBApr.GroupIndex := 500;
  SBMag.GroupIndex := 500;
  SBGiu.GroupIndex := 500;
  SBLug.GroupIndex := 500;
  SBAgo.GroupIndex := 500;
  SBSet.GroupIndex := 500;
  SBOtt.GroupIndex := 500;
  SBNov.GroupIndex := 500;
  SBDic.GroupIndex := 500;
  SBGen.Down := False;
  SBFeb.Down := False;
  SBMar.Down := False;
  SBApr.Down := False;
  SBMag.Down := False;
  SBGiu.Down := False;
  SBLug.Down := False;
  SBAgo.Down := False;
  SBSet.Down := False;
  SBOtt.Down := False;
  SBNov.Down := False;
  SBDic.Down := False;
end;

procedure TClientiForm.PageControl2Change(Sender: TObject);
begin
  // Se la pagina corrente  quella dei Soggetti...
  if PageControl2.ActivePage = TabClienti then
  begin
    // Carica l'icona del tipo documento visualizzato
    MainForm.CaricaIconaDocTipo('TabClienti');
    // Controlla l'abilitazione dei pulsanti in base ai permessi
    RxSpeedButtonNuovo.Enabled := True;
    RxSpeedButtonElimina.Enabled := DM1.ModCtrl(MOD_CLIENTI) > 1;
    RxSpeedButtonVisualizza.Enabled := (not MainForm.IsLevanteLight);
    RxSpeedButtonFax.Enabled := False;
    // Se la query non  attiva, azzera i filtri e e effe-ttua la ricerca automaticamente
    if (not QrySoggetti.Active) then
    begin
      RxSpeedButtonResetQueryClick(Self);
      if DM1.GoAutoquery(IDX_AUTOQUERY_RUBRICA) then
      begin
        RxSpeedButtonTrovaClick(Self);
      end;
    end;

    // Se la pagina corrente  quella dele Pratiche...
  end
  else if PageControl2.ActivePage = TabPratiche then
  begin
    // Carica l'icona del tipo documento visualizzato
    MainForm.CaricaIconaDocTipo('TabPratiche');
    // Controlla l'abilitazione dei pulsanti in base ai permessi
    RxSpeedButtonNuovo.Enabled := DM1.ModCtrl(MOD_PRATICHE) > 1;
    RxSpeedButtonElimina.Enabled := DM1.ModCtrl(MOD_PRATICHE) > 1;
    RxSpeedButtonVisualizza.Enabled := (not MainForm.IsLevanteLight);
    RxSpeedButtonFax.Enabled := False;
    // Se la query non  attiva, azzera i filtri e e effettua la ricerca automaticamente
    if (not QryPratiche.Active) then
    begin
      RxSpeedButtonResetQueryClick(Self);
      if DM1.GoAutoquery(IDX_AUTOQUERY_PRATICHE) then
      begin
        // Se siamo dentro ad una stampa riepilogativa cumulativa di cantiere non
        // esegue la query subito
        if StampeCantieriForm = nil then
          RxSpeedButtonTrovaClick(Self);
      end;
    end;

    // Se la pagina corrente  quella dele Assistenze...
  end
  else if PageControl2.ActivePage = TabAssistenze then
  begin
    // Carica l'icona del tipo documento visualizzato
    MainForm.CaricaIconaDocTipo('TabAssistenze');
    // Controlla l'abilitazione dei pulsanti in base ai permessi
    RxSpeedButtonNuovo.Enabled := True;
    RxSpeedButtonElimina.Enabled := DM1.ModCtrl(MOD_CONTATTI) > 1;
    RxSpeedButtonVisualizza.Enabled := (not MainForm.IsLevanteLight);
    RxSpeedButtonFax.Enabled := False;
    // Se non  gi stata creata, crea la form
    if TabImpiantiForm = nil then
    begin
      Application.CreateForm(TTabImpiantiForm, TabImpiantiForm);
      TabImpiantiForm.Parent := PanelImpianti;
      TabImpiantiForm.Show;
    end;

    // Se la pagina corrente  quella dele Comunicazioni...
  end
  else if PageControl2.ActivePage = TabComunicazioni then
  begin
    // Carica l'icona del tipo documento visualizzato
    MainForm.CaricaIconaDocTipo('TabComunicazioni');
    // Controlla l'abilitazione dei pulsanti in base ai permessi
    RxSpeedButtonNuovo.Enabled := True;
    RxSpeedButtonElimina.Enabled := DM1.ModCtrl(MOD_TESTI) > 1;
    RxSpeedButtonVisualizza.Enabled := (not MainForm.IsLevanteLight);
    RxSpeedButtonFax.Enabled := False;
    // Se non  gi stata creata, crea la form
    if TabComunicazioniForm = nil then
    begin
      Application.CreateForm(TTabComunicazioniForm, TabComunicazioniForm);
      TabComunicazioniForm.Parent := PanelComunicazioni;
      TabComunicazioniForm.Show;
    end;

    // Se la pagina corrente  quella del partitario
    // azzera tutti i criteri di ricerca.
  end
  else if PageControl2.ActivePage = TabPartitario then
  begin
    // Carica l'icona del tipo documento visualizzato
    MainForm.CaricaIconaDocTipo('TabPartitario');
    // Controlla l'abilitazione dei pulsanti in base ai permessi
    RxSpeedButtonNuovo.Enabled := False;
    RxSpeedButtonElimina.Enabled := False;
    RxSpeedButtonVisualizza.Enabled := (not MainForm.IsLevanteLight);
    RxSpeedButtonFax.Enabled := False;
    // Se non  gi stata creata, crea la form
    if TabPartitarioForm = nil then
    begin
      Application.CreateForm(TTabPartitarioForm, TabPartitarioForm);
      TabPartitarioForm.Parent := PanelPartitario;
      TabPartitarioForm.Show;
    end;

    // Se la pagina corrente  quella degli articoli
    // azzera tutti i criteri di ricerca.
  end
  else if PageControl2.ActivePage = TabArticoli then
  begin
    // Carica l'icona del tipo documento visualizzato
    MainForm.CaricaIconaDocTipo('TabArticoli');
    // Controlla l'abilitazione dei pulsanti in base ai permessi
    RxSpeedButtonNuovo.Enabled := (not MainForm.IsLevanteLight);
    RxSpeedButtonElimina.Enabled := (DM1.ModCtrl(MOD_ARTICOLI) > 1) and (not MainForm.IsLevanteLight);
    RxSpeedButtonVisualizza.Enabled := (not MainForm.IsLevanteLight);
    RxSpeedButtonFax.Enabled := False;
    // Se la query non  attiva, azzera i filtri e e effettua la ricerca automaticamente
    if (not QryArticoli.Active) then
    begin
      RxSpeedButtonResetQueryClick(Self);
      if DM1.GoAutoquery(IDX_AUTOQUERY_ARTICOLI) then
        RxSpeedButtonTrovaClick(Self);
    end;

    // Se la pagina corrente  quella dei documenti selezionati
    // azzera tutti i criteri di ricerca.
  end
  else if PageControl2.ActivePage = TabDocumenti then
  begin
    // Carica l'icona del tipo documento visualizzato
    MainForm.CaricaIconaDocTipo('TabDocumenti');
    // Effettua il controllo dell'abilitazione dei documenti
    // ControllaAbilitazioneDocumenti;
    // Controlla l'abilitazione dei pulsanti in base ai permessi
    RxSpeedButtonNuovo.Enabled := True;
    RxSpeedButtonElimina.Enabled := True;
    RxSpeedButtonVisualizza.Enabled := True;
    RxSpeedButtonFax.Enabled := (DM1.ControllaDocumento('Fattura') > 1) and not MainForm.IsLevanteLight;
    // Se la query non  attiva, azzera i filtri e e effettua la ricerca automaticamente
    if (not QryDoc.Active) then
    begin
      RxSpeedButtonResetQueryClick(Self);
      if DM1.GoAutoquery(IDX_AUTOQUERY_DOCUMENTI) then
        RxSpeedButtonTrovaClick(Self);
    end;

    // Se la pagina corrente  quella del giornale di magazzino
    // azzera tutti i criteri di ricerca.
  end
  else if PageControl2.ActivePage = TabMagazzino then
  begin
    // Carica l'icona del tipo documento visualizzato
    MainForm.CaricaIconaDocTipo('TabMagazzino');
    // Effettua il controllo dell'abilitazione dei documenti
    // ControllaAbilitazioneDocumenti;
    // Controlla l'abilitazione dei pulsanti in base ai permessi
    RxSpeedButtonNuovo.Enabled := True;
    RxSpeedButtonElimina.Enabled := False;
    RxSpeedButtonVisualizza.Enabled := (not MainForm.IsLevanteLight);
    RxSpeedButtonFax.Enabled := False;
    // Se la query non  attiva, azzera i filtri e e effettua la ricerca automaticamente
    if (not QryGM.Active) then
    begin
      RxSpeedButtonResetQueryClick(Self);
      if DM1.GoAutoquery(IDX_AUTOQUERY_GM) then
        RxSpeedButtonTrovaClick(Self);
    end;

    // Se la pagina corrente  quella del giornale manodopera + spese
    // azzera tutti i criteri di ricerca.
  end
  else if PageControl2.ActivePage = TabGOS then
  begin
    // Carica l'icona del tipo documento visualizzato
    MainForm.CaricaIconaDocTipo('TabGOS');
    // Controlla l'abilitazione dei pulsanti in base ai permessi
    RxSpeedButtonNuovo.Enabled := True;
    RxSpeedButtonElimina.Enabled := False;
    RxSpeedButtonVisualizza.Enabled := True;
    RxSpeedButtonFax.Enabled := False;
    // Se la query non  attiva, azzera i filtri e e effettua la ricerca automaticamente
    if (not QryGOSOre.Active) then
    begin
      RxSpeedButtonResetQueryClick(Self);
      if DM1.GoAutoquery(IDX_AUTOQUERY_GOS) then
      begin
        // Se siamo dentro ad una stampa riepilogativa cumulativa di cantiere non
        // esegue la query subito
        if StampeCantieriForm = nil then
          RxSpeedButtonTrovaClick(Self);
      end;
    end;

    // Se la pagina corrente  quella del giornale di magazzino
    // azzera tutti i criteri di ricerca.
  end
  else if PageControl2.ActivePage = TabGC then
  begin
    {
      // Carica l'icona del tipo documento visualizzato
      MainForm.CaricaIconaDocTipo('TabGC');
      // Controlla l'abilitazione dei pulsanti in base ai permessi
      RxSpeedButtonNuovo.Enabled   := False;
      RxSpeedButtonElimina.Enabled := False;
      // Se la query non  attiva, azzera i filtri e e effettua la ricerca automaticamente
      if (not QryGC.Active) then begin
      RxSpeedButtonResetQueryClick(Self);
      if DM1.AutoQuery[IDX_AUTOQUERY_GC] then RxSpeedButtonTrovaClick(Self);
      end;
    }
    // Carica l'icona del tipo documento visualizzato
    MainForm.CaricaIconaDocTipo('TabGC');
    // Controlla l'abilitazione dei pulsanti in base ai permessi
    RxSpeedButtonNuovo.Enabled := True;
    RxSpeedModifica.Enabled := False;
    RxSpeedButtonElimina.Enabled := False;
    RxSpeedButtonVisualizza.Enabled := (not MainForm.IsLevanteLight);
    RxSpeedButtonFax.Enabled := False;
    // Se non  gi stata creata, crea la form
    if TabGCForm = nil then
    begin
      Application.CreateForm(TTabGCForm, TabGCForm);
      TabGCForm.Parent := PanelGC;
      TabGCForm.Show;
    end;

    // Se la pagina corrente  quella del giornale di magazzino
    // azzera tutti i criteri di ricerca.
  end
  else if PageControl2.ActivePage = TabResOrd then
  begin
    // Carica l'icona del tipo documento visualizzato
    MainForm.CaricaIconaDocTipo('TabResiduoOrdini');
    // Controlla l'abilitazione dei pulsanti in base ai permessi
    RxSpeedButtonNuovo.Enabled := False;
    RxSpeedModifica.Enabled := False;
    RxSpeedButtonElimina.Enabled := False;
    RxSpeedButtonVisualizza.Enabled := False;
    RxSpeedButtonFax.Enabled := False;
    // Se non  gi stata creata, crea la form
    if TagResOrdForm = nil then
    begin
      Application.CreateForm(TTagResOrdForm, TagResOrdForm);
      TagResOrdForm.Parent := PanelResOrd;
      TagResOrdForm.Show;
      // Se invece  gi esistente richiama il gestore di evento on Show
      // in modo da far controllare se la versione visualizzata  aggiornata
    end
    else
    begin
      TagResOrdForm.FormShow(TagResOrdForm);
    end;

    // Se la pagina corrente  quella delle condizioni di vendita
    // azzera tutti i criteri di ricerca.
  end
  else if PageControl2.ActivePage = TabCondVend then
  begin
    // Carica l'icona del tipo documento visualizzato
    MainForm.CaricaIconaDocTipo('TabCondVend');
    // Controlla l'abilitazione dei pulsanti in base ai permessi
    RxSpeedButtonNuovo.Enabled := True;
    RxSpeedButtonElimina.Enabled := DM1.ModCtrl(MOD_CONDIZIONI_VENDITA) > 1;
    RxSpeedButtonVisualizza.Enabled := (not MainForm.IsLevanteLight);
    RxSpeedButtonFax.Enabled := False;
    // Se la query non  attiva, azzera i filtri e e effettua la ricerca automaticamente
    if (not QryCV.Active) then
    begin
      RxSpeedButtonResetQueryClick(Self);
      if DM1.GoAutoquery(IDX_AUTOQUERY_CV) then
        RxSpeedButtonTrovaClick(Self);
    end;

    // Se la pagina corrente  quella delle scadenza
    // azzera tutti i criteri di ricerca.
  end
  else if PageControl2.ActivePage = TabScadenze then
  begin
    // Carica l'icona del tipo documento visualizzato
    MainForm.CaricaIconaDocTipo('TabScadenze');
    // Controlla l'abilitazione dei pulsanti in base ai permessi
    RxSpeedButtonNuovo.Enabled := True;
    RxSpeedButtonElimina.Enabled := DM1.ModCtrl(MOD_SCADENZARIO) > 1;
    RxSpeedButtonVisualizza.Enabled := (not MainForm.IsLevanteLight);
    RxSpeedButtonFax.Enabled := False;
    // Se la query non  attiva, azzera i filtri e e effettua la ricerca automaticamente
    if (not QryScad.Active) then
    begin
      RxSpeedButtonResetQueryClick(Self);
      if DM1.GoAutoquery(IDX_AUTOQUERY_SCADENZE) then
        RxSpeedButtonTrovaClick(Self);
    end;

    // Se la pagina corrente  quella delle scadenza
    // azzera tutti i criteri di ricerca.
  end
  else if PageControl2.ActivePage = TabImpegni then
  begin
    // Carica l'icona del tipo documento visualizzato
    MainForm.CaricaIconaDocTipo('TabImpegni');
    // Controlla l'abilitazione dei pulsanti in base ai permessi
    RxSpeedButtonNuovo.Enabled := True;
    RxSpeedButtonElimina.Enabled := DM1.ModCtrl(MOD_CONTATTI) > 1;
    RxSpeedButtonVisualizza.Enabled := (not MainForm.IsLevanteLight);
    RxSpeedButtonFax.Enabled := False;
    // Se la query non  attiva, azzera i filtri e e effettua la ricerca automaticamente
    if (not QryImp.Active) then
    begin
      RxSpeedButtonResetQueryClick(Self);
      if DM1.GoAutoquery(IDX_AUTOQUERY_IMPEGNI) then
        RxSpeedButtonTrovaClick(Self);
    end;

    // Se la pagina corrente  quella della primanota
    // azzera tutti i criteri di ricerca.
  end
  else if PageControl2.ActivePage = TabPrimanota then
  begin
    // Carica l'icona del tipo documento visualizzato
    MainForm.CaricaIconaDocTipo('TabPrimanota');
    // Controlla l'abilitazione dei pulsanti in base ai permessi
    RxSpeedButtonNuovo.Enabled := True;
    RxSpeedButtonElimina.Enabled := DM1.ModCtrl(MOD_PRIMANOTA) > 1;
    RxSpeedButtonVisualizza.Enabled := (not MainForm.IsLevanteLight);
    RxSpeedButtonFax.Enabled := False;
    // Se la query non  attiva, azzera i filtri e e effettua la ricerca automaticamente
    if (not QueryPrimanota.Active) then
    begin
      RxSpeedButtonResetQueryClick(Self);
      if DM1.GoAutoquery(IDX_AUTOQUERY_PRIMANOTA) then
        RxSpeedButtonTrovaClick(Self);
    end;

    // Se la pagina corrente  quella della AGENDA
    // azzera tutti i criteri di ricerca.
  end
  else if PageControl2.ActivePage = TabAgenda then
  begin
    // Carica l'icona del tipo documento visualizzato
    MainForm.CaricaIconaDocTipo('TabAgenda');
    // Controlla l'abilitazione dei pulsanti in base ai permessi
    RxSpeedButtonNuovo.Enabled := True;
    RxSpeedButtonElimina.Enabled := DM1.ModCtrl(MOD_AGENDA) > 1;
    RxSpeedButtonVisualizza.Enabled := (not MainForm.IsLevanteLight);
    RxSpeedButtonFax.Enabled := False;
    // Apre il calendario
    MainForm.ApriCalendario;
    // Se la query non  attiva, azzera i filtri e e effettua la ricerca automaticamente
    RxSpeedButtonTrovaClick(Self);
  end;

  // ==========================================================================
  // Se siamo in modalit LevanteLight disabilita alcune cose
  // --------------------------------------------------------------------------
  if MainForm.IsLevanteLight then
  begin
    RxSpeedButtonNuovo.Enabled := False;
  end;
  // ==========================================================================
end;

procedure TClientiForm.SBEsportaDocFiscClick(Sender: TObject);
begin
  try
    DM1.EsportaDocFiscSelezionati;
  finally
    // Aggiorna  i documenti esportati
    MainForm.AggiornaDocumentiEsportati;
  end;
end;

procedure TClientiForm.RxSpeedButtonStampaMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
var
  ClientPoint, ScreenPoint: TPoint;
begin
  // *************************************************************************
  // NB: FACENDO CLICK COL DX RICHIAMA IL MENU' DI STAMPA
  // *************************************************************************
  if Button = mbRight then
  begin
    // ==========================================================================
    // STAMPA MAPPE
    // --------------------------------------------------------------------------
    // Mappa Rubrica
    if (PageControl2.ActivePage = TabClienti) and (PageControlClienti.ActivePage = TabClientiMappa) then
    begin
      MapFormRubrica.PrintPreview;
      Exit;
      // Mappa Pratiche
    end
    else if (PageControl2.ActivePage = TabPratiche) and (PageControlPratiche.ActivePage = TabPraticheMappa) then
    begin
      MapFormPratiche.PrintPreview;
      Exit;
      // Mappa Impegni
    end
    else if (PageControl2.ActivePage = TabImpegni) and (PageControlImpegni.ActivePage = TabImpegniMappa) then
    begin
      MapFormImpegni.PrintPreview;
      Exit;
    end;
    // ==========================================================================

    // Esegue la conversione delle coordinate dove dovr apparire il men
    // da coordinate client della finestra a coordinate assolute dello schermo.
    // (NB: Il men popup apparir in prossimit del tasto NUOVO)
    ClientPoint.X := RxSpeedButtonStampa.Left + POPUP_X_OFFSET + ClientTopPanel.Left;
    ClientPoint.Y := RxSpeedButtonStampa.Top + POPUP_Y_OFFSET;
    ScreenPoint := ClientToScreen(ClientPoint);
    // Imposta la propriet TAG del men (0=Anteprima, 1=Stampa, 2=Fax, 3=Email)
    MenuStampe.Tag := 0;
    MenuStampe.Popup(ScreenPoint.X, ScreenPoint.Y);
  end;
end;

procedure TClientiForm.Salvaimpostazionicolonne1Click(Sender: TObject);
var
  Vista: String;
  CurrGrid: TcxControl;
begin
  // Chiede il nome della vista
  if InputQuery('Salvataggio vista', 'Con quale nome devo salvare la vista?', Vista) then
  begin
    // Controlla che la vista non sia nullo
    if Trim(Vista) = '' then
      raise Exception.Create('Il nome della vista non pu essere vuoto.');
  end
  else
  begin
    // Se l'utente ha cliccato su Cancel annulla l'operazione
    Exit;
  end;
  // In base alla pagina selezionata Elenco Viste punta alla griglia
  // corretta
  CurrGrid := GetCurrentGrid;
  // Carica la vista attuale
  if CurrGrid is TcxGrid then
    DM1.SalvaGriglieDevExpress((CurrGrid as TcxGrid), Vista, False);
  if CurrGrid is TcxDBPivotGrid then
    DM1.SalvaGrigliePivotDevExpress((CurrGrid as TcxDBPivotGrid), Vista);
  if CurrGrid is TcxScheduler then
    DM1.SalvaAgendaDevExpress((CurrGrid as TcxScheduler), Vista);
end;

procedure TClientiForm.Elencoclienti1Click(Sender: TObject);
begin
  // Preview
  if MenuStampe.Tag = 0 then
  begin
    dxPrinter.Preview(True, GridSoggLink);
    // Stampa
  end
  else if MenuStampe.Tag = 1 then
  begin
    dxPrinter.Print(True, nil, GridSoggLink);
    // Mail
  end
  else if MenuStampe.Tag = 3 then
  begin
    DM1.SaveDefaultPrinter;
    try
      DM1.SetPdfPrinterAsDefault;
      dxPrinter.Print(False, nil, GridSoggLink);
    finally
      DM1.RestoreDefaultPrinter;
    end;
  end;
end;

procedure TClientiForm.Elencodocumenti1Click(Sender: TObject);
begin
  // Imposta la stringa su cui viene costruito il range di date della stampa in base ai filtri per data
  DM1.SetReportDateRange(DateEditDa.EditText, DateEditA.EditText);
  // Anteprima
  if MenuStampe.Tag = 0 then
  begin
    dxPrinter.Preview(True, GridDocLink);
    // Stampa
  end
  else if MenuStampe.Tag = 1 then
  begin
    dxPrinter.Print(True, nil, GridDocLink);
  end;
end;

procedure TClientiForm.EditClientiCodiceKeyPress(Sender: TObject; var Key: Char);
begin
  // Se viene premuto il pulsante INVIO preme il pulsante di avvio
  if Key = chr(13) then
    RxSpeedButtonTrovaClick(Self);
end;

procedure TClientiForm.EditClientiSubSogg1PropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
  Combo: TcxComboBox;
  StcIndex: String;
begin
  // Inizializzazione
  Combo := (Sender as TcxComboBox);
  StcIndex := RightStr(Combo.Name, 1);
  Combo.Properties.Items.Clear;
  Combo.Properties.Items.Add('');
  // Altrimenti provvede a caricare i dati
  Qry := TIB_Cursor.Create(nil);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    // Imposta query
    Qry.SQL.Add('SELECT DISTINCT CAMPO' + StcIndex + ' FROM SUBSOGG');
    Qry.Open;
    // Caricamento dati
    while not Qry.Eof do
    begin
      Combo.Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
    Qry.Close;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.RxSpeedButtonHelpClick(Sender: TObject);
begin
  if PageControl2.ActivePage = TabClienti then
  begin
    HelpForm.Aiuto('SOGGETTI');
  end
  else
  begin
    HelpForm.Aiuto('DOCUMENTI');
  end;
end;

procedure TClientiForm.GMMesiTuttiClick(Sender: TObject);
begin
  GMDal.EditText := DM1.FilterDataDalDefault;
  GMAl.EditText := DM1.FilterDataAlDefault;
  // Se il Tag del pulsante MesiTutti = 1 significa che questo gestore di evento  stato
  // richiamato dall'evento OnChange del PageControl e non per un click dell'utente sul
  // pulsante stesso, quindi imposta le date al primo giorno e all'ultimo dell'anno in corso
  // ma non mette in  Down tutti i pulsanti dei mesi perch mi piace di pi.
  // if GMMesiTutti.Tag = 0 then begin
  // In questo modo posso metterli tutti in DOWN contemporaneamente
  Gen.GroupIndex := 601;
  Feb.GroupIndex := 602;
  Mar.GroupIndex := 603;
  Apr.GroupIndex := 604;
  Mag.GroupIndex := 605;
  Giu.GroupIndex := 606;
  Lug.GroupIndex := 607;
  Ago.GroupIndex := 608;
  Sett.GroupIndex := 609;
  Ott.GroupIndex := 610;
  Nov.GroupIndex := 611;
  Dic.GroupIndex := 612;
  Gen.Down := False;
  Feb.Down := False;
  Mar.Down := False;
  Apr.Down := False;
  Mag.Down := False;
  Giu.Down := False;
  Lug.Down := False;
  Ago.Down := False;
  Sett.Down := False;
  Ott.Down := False;
  Nov.Down := False;
  Dic.Down := False;
  // end else begin
  // Rimette il Tag del pulsante = 0
  GMMesiTutti.Tag := 0;
  // end;
end;

procedure TClientiForm.GMMesiNessunoClick(Sender: TObject);
begin
  GMDal.Clear;
  GMAl.Clear;
  // In questo modo posso metterli tutti in DOWN contemporaneamente
  Gen.GroupIndex := 600;
  Feb.GroupIndex := 600;
  Mar.GroupIndex := 600;
  Apr.GroupIndex := 600;
  Mag.GroupIndex := 600;
  Giu.GroupIndex := 600;
  Lug.GroupIndex := 600;
  Ago.GroupIndex := 600;
  Sett.GroupIndex := 600;
  Ott.GroupIndex := 600;
  Nov.GroupIndex := 600;
  Dic.GroupIndex := 600;
  Gen.Down := False;
  Feb.Down := False;
  Mar.Down := False;
  Apr.Down := False;
  Mag.Down := False;
  Giu.Down := False;
  Lug.Down := False;
  Ago.Down := False;
  Sett.Down := False;
  Ott.Down := False;
  Nov.Down := False;
  Dic.Down := False;
end;

procedure TClientiForm.GenClick(Sender: TObject);
var
  GG, MM, AA: Word;
  Mese: Shortint;
begin
  // Mese contiene l'indice del mese premuto
  Mese := (Sender as TSpeedButton).Tag;
  // AA COntiene l'anno in corso
  DecodeDate(Date, AA, MM, GG);
  // Se il GroupIndex  <> 600 significa che  stato premuto il
  // tasto di selezione di tutti i mesi e quindi si comporta di conseguenza
  if (Sender as TSpeedButton).GroupIndex <> 600 then
  begin
    GMMesiNessunoClick(Self);
    (Sender as TSpeedButton).Down := True;
  end;
  // Se il pulsante  premuto (down)...
  if (Sender as TSpeedButton).Down then
  begin
    // In base all'indice del mese imposta le date nel modo opportuno
    case Mese of
      1:
        begin
          GMDal.EditText := ' 01/01/' + IntToStr(AA);
          GMAl.EditText := ' 31/01/' + IntToStr(AA);
        end;
      2:
        begin
          GMDal.EditText := ' 01/02/' + IntToStr(AA);
          GMAl.EditText := ' ' + IntToStr(DaysInAMonth(CurrentYear, 2)) + '/02/' + IntToStr(AA);
        end;
      3:
        begin
          GMDal.EditText := ' 01/03/' + IntToStr(AA);
          GMAl.EditText := ' 31/03/' + IntToStr(AA);
        end;
      4:
        begin
          GMDal.EditText := ' 01/04/' + IntToStr(AA);
          GMAl.EditText := ' 30/04/' + IntToStr(AA);
        end;
      5:
        begin
          GMDal.EditText := ' 01/05/' + IntToStr(AA);
          GMAl.EditText := ' 31/05/' + IntToStr(AA);
        end;
      6:
        begin
          GMDal.EditText := ' 01/06/' + IntToStr(AA);
          GMAl.EditText := ' 30/06/' + IntToStr(AA);
        end;
      7:
        begin
          GMDal.EditText := ' 01/07/' + IntToStr(AA);
          GMAl.EditText := ' 31/07/' + IntToStr(AA);
        end;
      8:
        begin
          GMDal.EditText := ' 01/08/' + IntToStr(AA);
          GMAl.EditText := ' 31/08/' + IntToStr(AA);
        end;
      9:
        begin
          GMDal.EditText := ' 01/09/' + IntToStr(AA);
          GMAl.EditText := ' 30/09/' + IntToStr(AA);
        end;
      10:
        begin
          GMDal.EditText := ' 01/10/' + IntToStr(AA);
          GMAl.EditText := ' 31/10/' + IntToStr(AA);
        end;
      11:
        begin
          GMDal.EditText := ' 01/11/' + IntToStr(AA);
          GMAl.EditText := ' 30/11/' + IntToStr(AA);
        end;
      12:
        begin
          GMDal.EditText := ' 01/12/' + IntToStr(AA);
          GMAl.EditText := ' 31/12/' + IntToStr(AA);
        end;
    end;
    // Se invece il mese non  premuto...
  end
  else
  begin
    GMDal.Text := '';
    GMAl.Text := '';
  end;
end;

procedure TClientiForm.GMCodiceGruppo1Change(Sender: TObject);
begin
  // Se il codice gruppo  nullo disattiva la selezione del gruppo2, altrimenti la attiva
  if Trim(GMCodiceGruppo1.Text) = '' then
  begin
    GMCodiceGruppo2.Text := '';
    GMDescGruppo2.Text := '';
    GMCodiceGruppo2.Color := GMGruppiTitolo.Color;
    GMDescGruppo2.Color := GMGruppiTitolo.Color;
    GMCodiceGruppo2.TabStop := False;
    BitBtnGruppo2.Enabled := False;
  end
  else
  begin
    GMCodiceGruppo2.Color := GMCodiceGruppo1.Color;
    GMDescGruppo2.Color := GMCodiceGruppo1.Color;
    GMCodiceGruppo2.TabStop := True;
    BitBtnGruppo2.Enabled := True;
  end;
end;

procedure TClientiForm.GMCodiceGruppo2Change(Sender: TObject);
begin
  // Se il codice gruppo  nullo disattiva la selezione del gruppo2, altrimenti la attiva
  if Trim(GMCodiceGruppo2.Text) = '' then
  begin
    GMCodiceGruppo3.Text := '';
    GMDescGruppo3.Text := '';
    GMCodiceGruppo3.Color := GMGruppiTitolo.Color;
    GMDescGruppo3.Color := GMGruppiTitolo.Color;
    GMCodiceGruppo3.TabStop := False;
    BitBtnGruppo3.Enabled := False;
  end
  else
  begin
    GMCodiceGruppo3.Color := GMCodiceGruppo1.Color;
    GMDescGruppo3.Color := GMCodiceGruppo1.Color;
    GMCodiceGruppo3.TabStop := True;
    BitBtnGruppo3.Enabled := True;
  end;
end;

procedure TClientiForm.GiornaleDiMagazzino1Click(Sender: TObject);
begin
  // Imposta la stringa su cui viene costruito il range di date della stampa in base ai filtri per data
  DM1.SetReportDateRange(GMDal.EditText, GMAl.EditText);
  // Anteprima
  if MenuStampe.Tag = 0 then
  begin
    dxPrinter.Preview(True, GridGMLink);
    // Stampa
  end
  else if MenuStampe.Tag = 1 then
  begin
    dxPrinter.Print(True, nil, GridGMLink);
  end;
end;

procedure TClientiForm.CVCodiceGruppo1Change(Sender: TObject);
begin
  // Se il codice gruppo  nullo disattiva la selezione del gruppo2, altrimenti la attiva
  if Trim(CVCodiceGruppo1.Text) = '' then
  begin
    CVCodiceGruppo2.Text := '';
    CVDescGruppo2.Text := '';
    CVCodiceGruppo2.Color := $00FAE0DA;
    CVDescGruppo2.Color := $00FAE0DA;
    CVCodiceGruppo2.TabStop := False;
    BitBtnCVGruppo2.Enabled := False;
  end
  else
  begin
    CVCodiceGruppo2.Color := clWhite;
    CVDescGruppo2.Color := $00FCEDE9;
    CVCodiceGruppo2.TabStop := True;
    BitBtnCVGruppo2.Enabled := True;
  end;
end;

procedure TClientiForm.CVCodiceGruppo2Change(Sender: TObject);
begin
  // Se il codice gruppo  nullo disattiva la selezione del gruppo3, altrimenti la attiva
  if Trim(CVCodiceGruppo2.Text) = '' then
  begin
    CVCodiceGruppo3.Text := '';
    CVDescGruppo3.Text := '';
    CVCodiceGruppo3.Color := $00FAE0DA;
    CVDescGruppo3.Color := $00FAE0DA;
    CVCodiceGruppo3.TabStop := False;
    BitBtnCVGruppo3.Enabled := False;
  end
  else
  begin
    CVCodiceGruppo3.Color := clWhite;
    CVDescGruppo3.Color := $00FCEDE9;
    CVCodiceGruppo3.TabStop := True;
    BitBtnCVGruppo3.Enabled := True;
  end;
end;

procedure TClientiForm.CodiceGruppo1Change(Sender: TObject);
begin
  // Se il codice gruppo  nullo disattiva la selezione del gruppo2, altrimenti la attiva
  if Trim(CodiceGruppo1.Text) = '' then
  begin
    CodiceGruppo2.Text := '';
    DescGruppo2.Text := '';
    CodiceGruppo2.Color := GruppiTitolo.Color;
    DescGruppo2.Color := GruppiTitolo.Color;
    CodiceGruppo2.TabStop := False;
    BitBtnArtGruppo2.Enabled := False;
  end
  else
  begin
    CodiceGruppo2.Color := CodiceGruppo1.Color;
    DescGruppo2.Color := CodiceGruppo1.Color;
    CodiceGruppo2.TabStop := True;
    BitBtnArtGruppo2.Enabled := True;
  end;
end;

procedure TClientiForm.CodiceGruppo2Change(Sender: TObject);
begin
  // Se il codice gruppo  nullo disattiva la selezione del gruppo3, altrimenti la attiva
  if Trim(CodiceGruppo2.Text) = '' then
  begin
    CodiceGruppo3.Text := '';
    DescGruppo3.Text := '';
    CodiceGruppo3.Color := GruppiTitolo.Color;
    DescGruppo3.Color := GruppiTitolo.Color;
    CodiceGruppo3.TabStop := False;
    BitBtnArtGruppo3.Enabled := False;
  end
  else
  begin
    CodiceGruppo3.Color := CodiceGruppo1.Color;
    DescGruppo3.Color := CodiceGruppo1.Color;
    CodiceGruppo3.TabStop := True;
    BitBtnArtGruppo3.Enabled := True;
  end;
end;

procedure TClientiForm.PratMesiTuttiClick(Sender: TObject);
begin
  PratDal.EditText := DM1.FilterDataDalDefault;
  PratAl.EditText := DM1.FilterDataAlDefault;
  // Se il Tag del pulsante MesiTutti = 1 significa che questo gestore di evento  stato
  // richiamato dall'evento OnChange del PageControl e non per un click dell'utente sul
  // pulsante stesso, quindi imposta le date al primo giorno e all'ultimo dell'anno in corso
  // ma non mette in  Down tutti i pulsanti dei mesi perch mi piace di pi.
  // if PratMesiTutti.Tag = 0 then begin
  // In questo modo posso metterli tutti in DOWN contemporaneamente
  PratGen.GroupIndex := 701;
  PratFeb.GroupIndex := 702;
  PratMar.GroupIndex := 703;
  PratApr.GroupIndex := 704;
  PratMag.GroupIndex := 705;
  PratGiu.GroupIndex := 706;
  PratLug.GroupIndex := 707;
  PratAgo.GroupIndex := 708;
  PratSet.GroupIndex := 709;
  PratOtt.GroupIndex := 710;
  PratNov.GroupIndex := 711;
  PratDic.GroupIndex := 712;
  PratGen.Down := False;
  PratFeb.Down := False;
  PratMar.Down := False;
  PratApr.Down := False;
  PratMag.Down := False;
  PratGiu.Down := False;
  PratLug.Down := False;
  PratAgo.Down := False;
  PratSet.Down := False;
  PratOtt.Down := False;
  PratNov.Down := False;
  PratDic.Down := False;
  // end else begin
  // Rimette il Tag del pulsante = 0
  PratMesiTutti.Tag := 0;
  // end;
end;

procedure TClientiForm.PratMesiNessunoClick(Sender: TObject);
begin
  PratDal.Clear;
  PratAl.Clear;
  // In questo modo posso metterli tutti in DOWN contemporaneamente
  PratGen.GroupIndex := 700;
  PratFeb.GroupIndex := 700;
  PratMar.GroupIndex := 700;
  PratApr.GroupIndex := 700;
  PratMag.GroupIndex := 700;
  PratGiu.GroupIndex := 700;
  PratLug.GroupIndex := 700;
  PratAgo.GroupIndex := 700;
  PratSet.GroupIndex := 700;
  PratOtt.GroupIndex := 700;
  PratNov.GroupIndex := 700;
  PratDic.GroupIndex := 700;
  PratGen.Down := False;
  PratFeb.Down := False;
  PratMar.Down := False;
  PratApr.Down := False;
  PratMag.Down := False;
  PratGiu.Down := False;
  PratLug.Down := False;
  PratAgo.Down := False;
  PratSet.Down := False;
  PratOtt.Down := False;
  PratNov.Down := False;
  PratDic.Down := False;
end;

procedure TClientiForm.PratGenClick(Sender: TObject);
var
  GG, MM, AA: Word;
  Mese: Shortint;
begin
  // Mese contiene l'indice del mese premuto
  Mese := (Sender as TSpeedButton).Tag;
  // AA COntiene l'anno in corso
  DecodeDate(Date, AA, MM, GG);
  // Se il GroupIndex  <> 600 significa che  stato premuto il
  // tasto di selezione di tutti i mesi e quindi si comporta di conseguenza
  if (Sender as TSpeedButton).GroupIndex <> 600 then
  begin
    PratMesiNessunoClick(Self);
    (Sender as TSpeedButton).Down := True;
  end;
  // Se il pulsante  premuto (down)...
  if (Sender as TSpeedButton).Down then
  begin
    // In base all'indice del mese imposta le date nel modo opportuno
    case Mese of
      1:
        begin
          PratDal.EditText := ' 01/01/' + IntToStr(AA);
          PratAl.EditText := ' 31/01/' + IntToStr(AA);
        end;
      2:
        begin
          PratDal.EditText := ' 01/02/' + IntToStr(AA);
          PratAl.EditText := ' ' + IntToStr(DaysInAMonth(CurrentYear, 2)) + '/02/' + IntToStr(AA);
        end;
      3:
        begin
          PratDal.EditText := ' 01/03/' + IntToStr(AA);
          PratAl.EditText := ' 31/03/' + IntToStr(AA);
        end;
      4:
        begin
          PratDal.EditText := ' 01/04/' + IntToStr(AA);
          PratAl.EditText := ' 30/04/' + IntToStr(AA);
        end;
      5:
        begin
          PratDal.EditText := ' 01/05/' + IntToStr(AA);
          PratAl.EditText := ' 31/05/' + IntToStr(AA);
        end;
      6:
        begin
          PratDal.EditText := ' 01/06/' + IntToStr(AA);
          PratAl.EditText := ' 30/06/' + IntToStr(AA);
        end;
      7:
        begin
          PratDal.EditText := ' 01/07/' + IntToStr(AA);
          PratAl.EditText := ' 31/07/' + IntToStr(AA);
        end;
      8:
        begin
          PratDal.EditText := ' 01/08/' + IntToStr(AA);
          PratAl.EditText := ' 31/08/' + IntToStr(AA);
        end;
      9:
        begin
          PratDal.EditText := ' 01/09/' + IntToStr(AA);
          PratAl.EditText := ' 30/09/' + IntToStr(AA);
        end;
      10:
        begin
          PratDal.EditText := ' 01/10/' + IntToStr(AA);
          PratAl.EditText := ' 31/10/' + IntToStr(AA);
        end;
      11:
        begin
          PratDal.EditText := ' 01/11/' + IntToStr(AA);
          PratAl.EditText := ' 30/11/' + IntToStr(AA);
        end;
      12:
        begin
          PratDal.EditText := ' 01/12/' + IntToStr(AA);
          PratAl.EditText := ' 31/12/' + IntToStr(AA);
        end;
    end;
    // Se invece il mese non  premuto...
  end
  else
  begin
    PratDal.Text := '';
    PratAl.Text := '';
  end;
end;

procedure TClientiForm.ScadMesiTuttiClick(Sender: TObject);
begin
  ScadDal.EditText := DM1.FilterDataDalDefault;
  ScadAl.EditText := DM1.FilterDataAlDefault;
  // Se il Tag del pulsante MesiTutti = 1 significa che questo gestore di evento  stato
  // richiamato dall'evento OnChange del PageControl e non per un click dell'utente sul
  // pulsante stesso, quindi imposta le date al primo giorno e all'ultimo dell'anno in corso
  // ma non mette in  Down tutti i pulsanti dei mesi perch mi piace di pi.
  // if ScadMesiTutti.Tag = 0 then begin
  // In questo modo posso metterli tutti in DOWN contemporaneamente
  ScadGen.GroupIndex := 801;
  ScadFeb.GroupIndex := 802;
  ScadMar.GroupIndex := 803;
  ScadApr.GroupIndex := 804;
  ScadMag.GroupIndex := 805;
  ScadGiu.GroupIndex := 806;
  ScadLug.GroupIndex := 807;
  ScadAgo.GroupIndex := 808;
  ScadSet.GroupIndex := 809;
  ScadOtt.GroupIndex := 810;
  ScadNov.GroupIndex := 811;
  ScadDic.GroupIndex := 812;
  ScadGen.Down := False;
  ScadFeb.Down := False;
  ScadMar.Down := False;
  ScadApr.Down := False;
  ScadMag.Down := False;
  ScadGiu.Down := False;
  ScadLug.Down := False;
  ScadAgo.Down := False;
  ScadSet.Down := False;
  ScadOtt.Down := False;
  ScadNov.Down := False;
  ScadDic.Down := False;
  // end else begin
  // Rimette il Tag del pulsante = 0
  ScadMesiTutti.Tag := 0;
  // end;
end;

procedure TClientiForm.ScadMesiNessunoClick(Sender: TObject);
begin
  ScadDal.Clear;
  ScadAl.Clear;
  // In questo modo posso metterli tutti in DOWN contemporaneamente
  ScadGen.GroupIndex := 800;
  ScadFeb.GroupIndex := 800;
  ScadMar.GroupIndex := 800;
  ScadApr.GroupIndex := 800;
  ScadMag.GroupIndex := 800;
  ScadGiu.GroupIndex := 800;
  ScadLug.GroupIndex := 800;
  ScadAgo.GroupIndex := 800;
  ScadSet.GroupIndex := 800;
  ScadOtt.GroupIndex := 800;
  ScadNov.GroupIndex := 800;
  ScadDic.GroupIndex := 800;
  ScadGen.Down := False;
  ScadFeb.Down := False;
  ScadMar.Down := False;
  ScadApr.Down := False;
  ScadMag.Down := False;
  ScadGiu.Down := False;
  ScadLug.Down := False;
  ScadAgo.Down := False;
  ScadSet.Down := False;
  ScadOtt.Down := False;
  ScadNov.Down := False;
  ScadDic.Down := False;
end;

procedure TClientiForm.ScadGenClick(Sender: TObject);
var
  GG, MM, AA: Word;
  Mese: Shortint;
begin
  // Mese contiene l'indice del mese premuto
  Mese := (Sender as TSpeedButton).Tag;
  // AA COntiene l'anno in corso
  DecodeDate(Date, AA, MM, GG);
  // Se il GroupIndex  <> 600 significa che  stato premuto il
  // tasto di selezione di tutti i mesi e quindi si comporta di conseguenza
  if (Sender as TSpeedButton).GroupIndex <> 600 then
  begin
    ScadMesiNessunoClick(Self);
    (Sender as TSpeedButton).Down := True;
  end;
  // Se il pulsante  premuto (down)...
  if (Sender as TSpeedButton).Down then
  begin
    // In base all'indice del mese imposta le date nel modo opportuno
    case Mese of
      1:
        begin
          ScadDal.EditText := ' 01/01/' + IntToStr(AA);
          ScadAl.EditText := ' 31/01/' + IntToStr(AA);
        end;
      2:
        begin
          ScadDal.EditText := ' 01/02/' + IntToStr(AA);
          ScadAl.EditText := ' ' + IntToStr(DaysInAMonth(CurrentYear, 2)) + '/02/' + IntToStr(AA);
        end;
      3:
        begin
          ScadDal.EditText := ' 01/03/' + IntToStr(AA);
          ScadAl.EditText := ' 31/03/' + IntToStr(AA);
        end;
      4:
        begin
          ScadDal.EditText := ' 01/04/' + IntToStr(AA);
          ScadAl.EditText := ' 30/04/' + IntToStr(AA);
        end;
      5:
        begin
          ScadDal.EditText := ' 01/05/' + IntToStr(AA);
          ScadAl.EditText := ' 31/05/' + IntToStr(AA);
        end;
      6:
        begin
          ScadDal.EditText := ' 01/06/' + IntToStr(AA);
          ScadAl.EditText := ' 30/06/' + IntToStr(AA);
        end;
      7:
        begin
          ScadDal.EditText := ' 01/07/' + IntToStr(AA);
          ScadAl.EditText := ' 31/07/' + IntToStr(AA);
        end;
      8:
        begin
          ScadDal.EditText := ' 01/08/' + IntToStr(AA);
          ScadAl.EditText := ' 31/08/' + IntToStr(AA);
        end;
      9:
        begin
          ScadDal.EditText := ' 01/09/' + IntToStr(AA);
          ScadAl.EditText := ' 30/09/' + IntToStr(AA);
        end;
      10:
        begin
          ScadDal.EditText := ' 01/10/' + IntToStr(AA);
          ScadAl.EditText := ' 31/10/' + IntToStr(AA);
        end;
      11:
        begin
          ScadDal.EditText := ' 01/11/' + IntToStr(AA);
          ScadAl.EditText := ' 30/11/' + IntToStr(AA);
        end;
      12:
        begin
          ScadDal.EditText := ' 01/12/' + IntToStr(AA);
          ScadAl.EditText := ' 31/12/' + IntToStr(AA);
        end;
    end;
    // Se invece il mese non  premuto...
  end
  else
  begin
    ScadDal.Text := '';
    ScadAl.Text := '';
  end;
end;

procedure TClientiForm.CVControllaTipoCondizione;
begin
  // Se la prima item (TUTTI)  checkata disabilita gli altri, altrimenti li abilita)
  if TipoCondizione.Checked[0] then
  begin
    // Checka tutte le altre voci tranne l'ultima
    TipoCondizione.Checked[1] := True;
    TipoCondizione.Checked[2] := True;
    // Disabilita tutte le altre voci tranne il TUTTI
    TipoCondizione.ItemEnabled[1] := False;
    TipoCondizione.ItemEnabled[2] := False;
    // Se invece il TUTTI non  checkato e l'elemento [1]  disabilitato significa che si  cliccato su TUTTI disabilitandolo e che
    // quindi devono essere riabilitati tutti gli altri elementi e metterli non checkati.
  end
  else if (not TipoCondizione.Checked[0]) and (not TipoCondizione.ItemEnabled[1]) then
  begin
    // UnChecka tutte le altre voci
    TipoCondizione.Checked[1] := False;
    TipoCondizione.Checked[2] := False;
    // Riabilita tutte le altre voci
    TipoCondizione.ItemEnabled[1] := True;
    TipoCondizione.ItemEnabled[2] := True;
  end;
  // Forzo cos il repaint del controllo perch altrimenti non funziona bene
  TipoCondizione.Invalidate;
  TipoCondizione.Update;
end;

procedure TClientiForm.SBDocNessunoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    SBDocNessunoClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.SBDocTuttiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    SBDocTuttiClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.SBGenMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    (Sender as TSpeedButton).Down := True;
    SBGenClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.SBMesiTuttiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    SBMesiTuttiClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.SBMesiNessunoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    SBMesiNessunoClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.GMVenditeMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
var
  CheckIndex: Integer;
  CurrCheckListBox: TcxCheckListBox;
begin
  // ----------------------------------------------------------------------------------------------------
  // Questo codice server per fare in modo che anche se l'utente clicca sul titolo della voce, questa
  // venga selezinata o deselezionata come se si fosse cliccato sul riquadrino del segno di check)
  // ----------------------------------------------------------------------------------------------------
  // La variabie CurrCheckListBox Punta alla CheckListBox che ha richiamata l'evento
  CurrCheckListBox := Sender as TcxCheckListBox;
  // Solo se s cliccato con il pulsante SX del mouse
  if Button = mbLeft then
  begin
    // Quale voce si trova sotto il mouse?
    CheckIndex := CurrCheckListBox.ItemAtPos(Point(X, Y), True);
    // Se c'era una voce cambia il suo stato
    if CheckIndex <> -1 then
    begin
      if CurrCheckListBox.Tag = 0 then
        CurrCheckListBox.Items[CheckIndex].Checked := not CurrCheckListBox.Items[CheckIndex].Checked;
      // Rimette la Propriet Tag del componente = 0
      CurrCheckListBox.Tag := 0;
    end;
    // Se invece  stato premuto il pulsante DX
  end
  else if Button = mbRight then
  begin
    // Quale voce si trova sotto il mouse?
    CheckIndex := CurrCheckListBox.ItemAtPos(Point(X, Y), True);
    // Deseleziona tutti i documenti
    SBGMNessunoClick(Self);
    // Chekka il documento
    CurrCheckListBox.Items[CheckIndex].Checked := True;
    // Esegue la ricerca
    RxSpeedButtonTrovaClick(Self);
  end;
  // F in modo che non resti una voce selezionata e quindi evidenziata che non mi piace
  CurrCheckListBox.ItemIndex := -1;
  // ----------------------------------------------------------------------------------------------------
end;

procedure TClientiForm.DocVenditeClickCheck(Sender: TObject; AIndex: Integer; APrevState, ANewState: TcxCheckBoxState);
begin
  // Se passa di qu significa che l'utente ha cliccato esattamente nel riquadrino del check della voce
  // e quindi marca la propriet Tag del componente in modo che poi il gestore dell'evento OnMouseUp che gestisce
  // i click per la selezione o meno della voce (per fare in modo che anche cliccando sulla descrizione della voce
  // si selezioni o deselezioni la voce stessa). In questo modo tale gestore di evento salta la riga che
  // assegna il valore alla propriet checked[i] altrimenti  come se l'utente avesse cliccato due volte.
  (Sender as TcxCheckListBox).Tag := 1;
end;

procedure TClientiForm.DocVenditeExit(Sender: TObject);
begin
  // F in modo che non resti una voce selezionata e quindi evidenziata che non mi piace
  (Sender as TcxCheckListBox).ItemIndex := -1;
end;

procedure TClientiForm.DocVenditeMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
var
  CheckIndex: Integer;
  CurrCheckListBox: TcxCheckListBox;
begin
  // ----------------------------------------------------------------------------------------------------
  // Questo codice server per fare in modo che anche se l'utente clicca sul titolo della voce, questa
  // venga selezinata o deselezionata come se si fosse cliccato sul riquadrino del segno di check)
  // ----------------------------------------------------------------------------------------------------
  // La variabie CurrCheckListBox Punta alla CheckListBox che ha richiamata l'evento
  CurrCheckListBox := Sender as TcxCheckListBox;
  // Solo se s cliccato con il pulsante SX del mouse
  if Button = mbLeft then
  begin
    // Quale voce si trova sotto il mouse?
    CheckIndex := CurrCheckListBox.ItemAtPos(Point(X, Y), True);
    // Se c'era una voce cambia il suo stato
    if CheckIndex <> -1 then
    begin
      if CurrCheckListBox.Tag = 0 then
        CurrCheckListBox.Items[CheckIndex].Checked := not CurrCheckListBox.Items[CheckIndex].Checked;
      // Rimette la Propriet Tag del componente = 0
      CurrCheckListBox.Tag := 0;
    end;
    // Se invece  stato premuto il pulsante DX
  end
  else if Button = mbRight then
  begin
    // Quale voce si trova sotto il mouse?
    CheckIndex := CurrCheckListBox.ItemAtPos(Point(X, Y), True);
    // Deseleziona tutti i documenti
    SBDocNessunoClick(Self);
    // Chekka il documento
    CurrCheckListBox.Items[CheckIndex].Checked := True;
    // Esegue la ricerca
    RxSpeedButtonTrovaClick(Self);
  end;
  // F in modo che non resti una voce selezionata e quindi evidenziata che non mi piace
  CurrCheckListBox.ItemIndex := -1;
  // ----------------------------------------------------------------------------------------------------
end;

procedure TClientiForm.DocVenditeOldExit(Sender: TObject);
begin
  // F in modo che non resti una voce selezionata e quindi evidenziata che non mi piace
  (Sender as TCheckListBox).ItemIndex := -1;
end;

procedure TClientiForm.BitBtnGruppo1Click(Sender: TObject);
begin
  DM1.Attendere;
  try
    // Visualizza la form che permette di selezionare il magazzino da inserire nel documento
    Application.CreateForm(TGruppiForm, GruppiForm);
    GruppiForm.Parent := MainForm;
    GruppiForm.Tag := 999; // Abilita la selezione
    GruppiForm.LivelloAttivo := 1;
    GruppiForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.BitBtnGruppo2Click(Sender: TObject);
begin
  DM1.Attendere;
  try
    // Visualizza la form che permette di selezionare il magazzino da inserire nel documento
    Application.CreateForm(TGruppiForm, GruppiForm);
    GruppiForm.Parent := MainForm;
    GruppiForm.Tag := 999; // Abilita la selezione
    GruppiForm.Selezionato1 := StrToInt(GMCodiceGruppo1.Text);
    GruppiForm.LivelloAttivo := 2;
    GruppiForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.BitBtnGruppo3Click(Sender: TObject);
begin
  DM1.Attendere;
  try
    // Visualizza la form che permette di selezionare il magazzino da inserire nel documento
    Application.CreateForm(TGruppiForm, GruppiForm);
    GruppiForm.Parent := MainForm;
    GruppiForm.Tag := 999; // Abilita la selezione
    GruppiForm.Selezionato1 := StrToInt(GMCodiceGruppo1.Text);
    GruppiForm.Selezionato2 := StrToInt(GMCodiceGruppo2.Text);
    GruppiForm.LivelloAttivo := 3;
    GruppiForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.BitBtnCodiceMagazzinoClick(Sender: TObject);
begin
  DM1.Attendere;
  try
    // Visualizza la form che permette di selezionare il magazzino da inserire nel documento
    Application.CreateForm(TAnagMagaForm, AnagMagaForm);
    AnagMagaForm.Parent := MainForm;
    AnagMagaForm.Tag := 997; // Abilita la seleziona dell'aliquota IVA
    AnagMagaForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.BitBtnCVGruppo1Click(Sender: TObject);
begin
  DM1.Attendere;
  try
    // Visualizza la form che permette di selezionare il magazzino da inserire nel documento
    Application.CreateForm(TGruppiForm, GruppiForm);
    GruppiForm.Parent := MainForm;
    GruppiForm.Tag := 996; // Abilita la selezione
    GruppiForm.LivelloAttivo := 1;
    GruppiForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.BitBtnCVGruppo2Click(Sender: TObject);
begin
  DM1.Attendere;
  try
    // Visualizza la form che permette di selezionare il magazzino da inserire nel documento
    Application.CreateForm(TGruppiForm, GruppiForm);
    GruppiForm.Parent := MainForm;
    GruppiForm.Tag := 996; // Abilita la selezione
    GruppiForm.Selezionato1 := StrToInt(CVCodiceGruppo1.Text);
    GruppiForm.LivelloAttivo := 2;
    GruppiForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.BitBtnCVGruppo3Click(Sender: TObject);
begin
  DM1.Attendere;
  try
    // Visualizza la form che permette di selezionare il magazzino da inserire nel documento
    Application.CreateForm(TGruppiForm, GruppiForm);
    GruppiForm.Parent := MainForm;
    GruppiForm.Tag := 996; // Abilita la selezione
    GruppiForm.Selezionato1 := StrToInt(CVCodiceGruppo1.Text);
    GruppiForm.Selezionato2 := StrToInt(CVCodiceGruppo2.Text);
    GruppiForm.LivelloAttivo := 3;
    GruppiForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.BitBtnCVArticoloClick(Sender: TObject);
begin
  DM1.Attendere;
  try
    // Visualizza la form che permette di selezionare l'articolo da inserire
    // nel documento.
    Application.CreateForm(TArticoliForm, ArticoliForm);
    ArticoliForm.Parent := MainForm;
    ArticoliForm.Tag := 995; // Abilita la selezione dell'articolo
    ArticoliForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.TipoCondizioneMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
var
  CheckIndex: Integer;
begin
  // ----------------------------------------------------------------------------------------------------
  // Questo codice server per fare in modo che anche se l'utente clicca sul titolo della voce, questa
  // venga selezinata o deselezionata come se si fosse cliccato sul riquadrino del segno di check)
  // ----------------------------------------------------------------------------------------------------
  // Solo se s cliccato con il pulsante SX del mouse
  if Button = mbLeft then
  begin
    // Quale voce si trova sotto il mouse?
    CheckIndex := TipoCondizione.ItemAtPos(Point(X, Y), True);
    // Se c'era una voce cambia il suo stato
    if CheckIndex <> -1 then
    begin
      if TipoCondizione.Tag = 0 then
        TipoCondizione.Checked[CheckIndex] := not TipoCondizione.Checked[CheckIndex];
      CVControllaTipoCondizione;
      // Rimette la Propriet Tag del componente = 0
      TipoCondizione.Tag := 0;
    end;
    // Se invece si  cliccato sul pulsante dx del mouse
  end
  else if Button = mbRight then
  begin
    // Prima di tutto tutte le voce sono non selezionate e tutte abilitate
    for CheckIndex := 0 to TipoCondizione.Items.Count - 1 do
    begin
      TipoCondizione.Checked[CheckIndex] := False;
      TipoCondizione.ItemEnabled[CheckIndex] := True;
    end;
    // Quale voce si trova sotto il mouse?
    CheckIndex := TipoCondizione.ItemAtPos(Point(X, Y), True);
    // Se c'era una voce cambia il suo stato
    if CheckIndex <> -1 then
    begin
      // Varia lo stato della voce selezionzta
      TipoCondizione.Checked[CheckIndex] := True;
      CVControllaTipoCondizione;
      // Rimette la Propriet Tag del componente = 0
      TipoCondizione.Tag := 0;
      // Esegue la ricerca
      RxSpeedButtonTrovaClick(Self);
    end;
  end;
  // F in modo che non resti una voce selezionata e quindi evidenziata che non mi piace
  TipoCondizione.ItemIndex := -1;
  // ----------------------------------------------------------------------------------------------------
end;

procedure TClientiForm.ScadGenMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    (Sender as TSpeedButton).Down := True;
    ScadGenClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.ScadMesiTuttiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    ScadMesiTuttiClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.ScadMesiNessunoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    ScadMesiNessunoClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.GenMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    (Sender as TSpeedButton).Down := True;
    GenClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.GMMesiTuttiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    GMMesiTuttiClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.GMMesiNessunoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    GMMesiNessunoClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.SBPagamentoRiscossioneClick(Sender: TObject);
begin
  // Se il database  gi in transazione e quindi significa che c' stato qualche problema
  // a qualche transazione precedente che potrebbe causare una perdita di dati. Quindi
  // avverte l'utente e lo informa che ilprogramma si chideer automaticamente.
  // Verifica che non ci siano gi transazioni in atto e se ci sono lanca un allarme
  DM1.CheckForAlreadyInTransaction;

  // Controlla se c' una selezione
  if (tvScad.DataController.FocusedRecordIndex <> -1) or (tvScad.DataController.DataSource = nil) then
  begin
    // In base ai permessi abilita o disabilita i pulsanti modifica/nuovo/elimina
    if ((QryScad.FieldByName('Tipo').Value = 'Scad.attiv') and (DM1.ModCtrl(MOD_SCADENZARIO) > 1)) or
      ((QryScad.FieldByName('Tipo').Value = 'Scad.passi') and (DM1.ModCtrl(MOD_SCADENZARIO_PASSIVO) > 1)) then
    begin
      // Visualizza la Form per effettuare il pagamento o la riscossione della scadenza
      Application.CreateForm(TPagamRiscForm, PagamRiscForm);
      PagamRiscForm.Parent := MainForm;
      PagamRiscForm.Mode := 0;
      PagamRiscForm.TipoScadenza := QryScad.FieldByName('TIPO').AsString;
      PagamRiscForm.CodiceScadenza := QryScad.FieldByName('CODICE').AsInteger;
      PagamRiscForm.DataScadenza := QryScad.FieldByName('DATASCADENZA').AsDateTime;
      PagamRiscForm.Show;
    end
    else
    begin
      // Visualizza un messaggio che avverte della mancanza di permessi per l'operazione
      MessageBeep(0);
      MessageDlg('Accesso negato per mancanza dei permessi necessari.', mtInformation, [mbOk], 0);
    end;
  end
  else
    DM1.Messaggi('ATTENZIONE !!!', 'Nessuna scadenza presente o selezionata.', '', [mbOk], 0, nil);
end;

procedure TClientiForm.BitBtnArtGruppo1Click(Sender: TObject);
begin
  DM1.Attendere;

  // Visualizza la form che permette di selezionare il magazzino da inserire nel documento
  Application.CreateForm(TGruppiForm, GruppiForm);
  GruppiForm.Parent := MainForm;
  GruppiForm.Tag := 995; // Abilita la selezione
  GruppiForm.LivelloAttivo := 1;
  GruppiForm.Show;

  DM1.ChiudiAttendere;
end;

procedure TClientiForm.BitBtnArtGruppo2Click(Sender: TObject);
begin
  DM1.Attendere;

  // Visualizza la form che permette di selezionare il magazzino da inserire nel documento
  Application.CreateForm(TGruppiForm, GruppiForm);
  GruppiForm.Parent := MainForm;
  GruppiForm.Tag := 995; // Abilita la selezione
  GruppiForm.Selezionato1 := StrToInt(CodiceGruppo1.Text);
  GruppiForm.LivelloAttivo := 2;
  GruppiForm.Show;

  DM1.ChiudiAttendere;
end;

procedure TClientiForm.BitBtnArtGruppo3Click(Sender: TObject);
begin
  DM1.Attendere;

  // Visualizza la form che permette di selezionare il magazzino da inserire nel documento
  Application.CreateForm(TGruppiForm, GruppiForm);
  GruppiForm.Parent := MainForm;
  GruppiForm.Tag := 995; // Abilita la selezione
  GruppiForm.Selezionato1 := StrToInt(CodiceGruppo1.Text);
  GruppiForm.Selezionato2 := StrToInt(CodiceGruppo2.Text);
  GruppiForm.LivelloAttivo := 3;
  GruppiForm.Show;

  DM1.ChiudiAttendere;
end;

procedure TClientiForm.BitBtnArtCodiceMagazzinoClick(Sender: TObject);
begin
  DM1.Attendere;

  // Visualizza la form che permette di selezionare il magazzino da inserire nel documento
  Application.CreateForm(TAnagMagaForm, AnagMagaForm);
  AnagMagaForm.Parent := MainForm;
  AnagMagaForm.Tag := 996; // Abilita la seleziona dell'aliquota IVA
  AnagMagaForm.Show;

  DM1.ChiudiAttendere;
end;

procedure TClientiForm.PageControl2Changing(Sender: TObject; var AllowChange: Boolean);
begin
  // Chiude l'anagrafica del soggetto corrente se attivata
  if AnagCliForm <> nil then
    AnagCliForm.Close;
  if PraticaForm <> nil then
    PraticaForm.Close;
  // Se si st lasciando la pagina dell'agenda, fa sparire il calendario
  if PageControl2.ActivePage = TabAgenda then
    MainForm.ChiudiCalendario;
  // Se si sta lasciando la pagina del giornale di cantiere disabilita il
  // pulsante di modifica
  if PageControl2.ActivePage = TabGC then
  begin
    RxSpeedModifica.Enabled := False;
  end;
  // Se si sta lasciando la pagina delle comunicazioni
  // In ogni caso si rimette sempre sulla pagina delle comunicazioni
  // inviate
  if PageControl2.ActivePage = TabComunicazioni then
  begin
    TabComunicazioniForm.PageControl.ActivePage := TabComunicazioniForm.TabElenco;
  end;
end;

procedure TClientiForm.RxSpeedButtonEliminaDragOver(Sender, Source: TObject; X, Y: Integer; State: TDragState; var Accept: Boolean);
begin
  Accept := False;
  // Cerca di riconoscere il mittente per accettare o meno l'operazione
  // ------------------------------------------------------------------
  // Se invece il mittende proviene da uno Scheduler (Agenda)
  if Source is TcxSchedulerDragObject then
  begin
    // Se proviene dall'agenda laterale accetta
    if (((Source as TcxSchedulerDragObject).Scheduler.Name = 'Agenda_FastSelectionMode') and Assigned(fAgendaForm)) then
      Accept := True;
    // Se il mittente proviene da una TcxGrid o TcxView...
    // Controlla se il mittente  di tipo TcxDragControlObject che  il tipo di oggetto
    // che le griglie DevExpress passano surante il DragAndDrop.
  end
  else if Source is TcxDragControlObject then
  begin
    // Se il mittente  una vista (che  sempre contenuta in un GridSite)...
    if TcxDragControlObject(Source).Control is TcxGridSite then
    begin
      // La vista diventa il controllo predefinito per comodit
      with TcxGridSite(TcxDragControlObject(Source).Control).GridView do
      begin
        // Controlla se la vista  tra quelle da riconoscere
        if (Name = 'tvRubrica') or (Name = 'tvDoc') or (Name = 'tvCV') or (Name = 'tvPrat') or (Name = 'tvScad') or (Name = 'tvArt') or (Name = 'tvAssistenze')
          or (Name = 'tvImpegni') or (Name = 'btvTasks') then
          Accept := True;
      end;
    end;
  end;
end;

procedure TClientiForm.RxSpeedButtonFaxClick(Sender: TObject);
var
  DocType, Registro: String;
  DocNum: Longint;
  DocDate: TDate;
  DocID: Integer;
  I: Integer;
  LController: TcxGridTableController;
begin
  LController := tvDoc.Controller;
  if (DM1.Messaggi('Invio fatture elettroniche', Format('Inviare %d fatture elettroniche?', [LController.SelectedRecordCount]),
    '', [mbYes, mbNo], 0, nil) = mrYes)
  and (DM1.Messaggi('Invio fatture elettroniche', 'Sei veramente sicuro/a di voler continuare?'#13#13'NB: L''operazione sar difficilmente reversibile', '',
    [mbYes, mbNo], 0, nil) = mrYes) then
  begin
    try
      // cicla per tutti gli impegni selezionati e li chiude automaticamente
      for I := 0 to LController.SelectedRecordCount - 1 do
      begin
        DocType := LController.SelectedRecords[I].Values[tvDocTIPODOC.Index];
        DocNum := LController.SelectedRecords[I].Values[tvDocCODICEDOC.Index];
        DocDate := LController.SelectedRecords[I].Values[tvDocDATADOC.Index];
        Registro := LController.SelectedRecords[I].Values[tvDocREGISTRO.Index];
        DocID := 0;
        // Verifica che sia una fattura oppure una nota di credito
        if (DocType <> 'Fattura') and (DocType <> 'Nota_accre') then
          Continue;
        // Apre il documento
        ApriDocumento(DocType, DocNum, Registro, DocDate, DocID);
        // Invia il documento corrente
        PreventiviOrdiniForm.InviaFatturaElettronica;
        PreventiviOrdiniForm.Close;
      end;
      DM1.Messaggi('Levante', 'Operazione terminata!', '', [mbOk], 0, nil);
    except
      on E: Exception do
        DM1.Messaggi('ATTENZIONE !!!', 'ERRORE!!!'#13#13 + E.Message + #13#13'L''operazione  stata interrotta.',
          '', [mbOk], 0, nil);
    end;
  end;
end;

procedure TClientiForm.RxSpeedButtonVisualizzaDragOver(Sender, Source: TObject; X, Y: Integer; State: TDragState; var Accept: Boolean);
begin
  Accept := False;
  // Cerca di riconoscere il mittente per accettare o meno l'operazione
  // ------------------------------------------------------------------
  // Se invece il mittende proviene da uno Scheduler (Agenda)
  if Source is TcxSchedulerDragObject then
  begin
    // Se proviene dall'agenda laterale accetta
    if (((Source as TcxSchedulerDragObject).Scheduler.Name = 'Agenda_FastSelectionMode') and Assigned(fAgendaForm)) then
      Accept := True;
    // Se il mittente proviene da una TcxGrid o TcxView...
    // Controlla se il mittente  di tipo TcxDragControlObject che  il tipo di oggetto
    // che le griglie DevExpress passano surante il DragAndDrop.
  end
  else if Source is TcxDragControlObject then
  begin
    // Se il mittente  una vista (che  sempre contenuta in un GridSite)...
    if TcxDragControlObject(Source).Control is TcxGridSite then
    begin
      // La vista diventa il controllo predefinito per comodit
      with TcxGridSite(TcxDragControlObject(Source).Control).GridView do
      begin
        // Controlla se la vista  tra quelle da riconoscere
        if (Name = 'tvRubrica') or (Name = 'tvDoc') or (Name = 'tvGM') or (Name = 'tvCV') or (Name = 'tvPrat') or (Name = 'tvScad') or (Name = 'tvArt') or
          (Name = 'tvAssistenze') or (Name = 'tvImpegni') or (Name = 'btvTasks') then
          Accept := True;
      end;
    end;
  end;
end;

procedure TClientiForm.tvGMCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
begin
  // Se  il primo rigo di un documento disegna un bordo superiore
  // NB: Si parte dando per sicuro che la colonna del PROGRIGO  l'ultima
  // if AViewInfo.GridRecord.Values[tvGM.GetColumnByFieldName('PROGRIGO').Index] = 1 then begin
  // AViewInfo.Borders := AViewInfo.Borders + [bTop];
  // end;
end;

procedure TClientiForm.tvRubricaDblClick(Sender: TObject);
begin
  // Dunque, se non siamo in FastSelectionMode il DblClick apre il docuemento selezionato
  // e seleziona anche il Soggetto/Pratica/Impianto corrente, se invece siamo in FastSelectionMode
  // apre sempre il documento ma non seleziona il SOggetto/Pratica/IMpianto corrente perch lo fa
  // gi al semplice Click
  if (DM1.FastSelectionMode and ((PageControl2.ActivePage <> TabClienti) or (PageControl2.ActivePage <> TabPratiche) or
    (PageControl2.ActivePage <> TabAssistenze))) or (not DM1.FastSelectionMode) then
  begin
    if not ClientiForm.RxSpeedButtonVisualizza.Enabled then
      Exit;
    ClientiForm.RxSpeedButtonVisualizzaClick(ClientiForm.RxSpeedButtonVisualizza);
  end;
end;

procedure TClientiForm.tvRubricaEndDrag(Sender, Target: TObject; X, Y: Integer);
begin
  // Prima di tutto controlla che il bersaglio non sia nullo
  if Target <> nil then
  begin
    // In base al bersagio attiva la funzione corretta.
    if Target is TSpeedButton then
    begin
      TSpeedButton(Target).OnClick(Self);
      // Se invece il Target  il pannellino del soggetto selezionato, seleziona il soggetto
      // NB: Le labels che indicano i dati del soggetto selezionato hanno il nome che comincia ssmper con 'SS'
      // NB: In FastSelectionMode non lo uso perch  inutile visto che si selezionano immediatamente al MouseDOwn
    end
    else if (Target is TbmpPanel) and (not DM1.FastSelectionMode) then
    begin
      if TbmpPanel(Target).Name = 'MainLeftPanel' then
        RxSpeedButtonVisualizzaClick(Self);
    end
    else if (Target is TPaintBox) and (not DM1.FastSelectionMode) then
    begin
      if DM1.StrLeft(TPaintBox(Target).Name, 2) = 'SB' then
        RxSpeedButtonVisualizzaClick(Self);
    end;
  end;
end;

procedure TClientiForm.tvDocEndDrag(Sender, Target: TObject; X, Y: Integer);
begin
  // Prima di tutto controlla che il bersaglio non sia nullo
  if Target <> nil then
  begin
    // In base al bersaglio attiva la funzione corretta.
    if Target is TSpeedButton then
    begin
      TSpeedButton(Target).OnClick(Self);
      // Se il target  una TListView...
    end
    else if Target is TListView then
    begin
      // Se il target  la TListView che contiene i documenti esportati, esporta i documenti
      // selezionati
      if (Target as TListView).Name = 'ListViewExpDoc' then
      begin
        ClientiForm.SBEsportaDocFiscClick(Self);
        // Se il target  la TListView che contiene i documento inviati al circuito di interscambio dei documento
      end
      else if (Target as TListView).Name = 'SendLV' then
      begin
        // Effettua l'invio del documento sul circuito di interscambio dei documenti
        ScambioDocForm.SBInviaDocumentoClick(ScambioDocForm.SBInviaDocumento);
      end;
    end;
  end;
end;

procedure TClientiForm.tvDocFE_STATUSCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo;
  var ADone: Boolean);
var
  DaysLeft: Integer;
  ToPaint: String;
begin
  // Carica i giorni mancanti entro i quali dover fare il prossimo passo
  if VarIsNull(AViewInfo.GridRecord.Values[tvDocFE_DAYSLEFT.Index]) then
    DaysLeft := 0
  else
    DaysLeft := AViewInfo.GridRecord.Values[tvDocFE_DAYSLEFT.Index];

  // Se il destinatario  una PA  e lo stato attuale  una RC visualizza il punto interrogativo nel pallino giallo
  // if  (not VarIsNull(AViewInfo.GridRecord.Values[tvDocFE_STATUS_EXT.Index]))
  // and (AViewInfo.GridRecord.Values[tvDocFE_STATUS_EXT.Index] = 'rtSDIMessageRC_PA')
  // then
  // ToPaint := '?'
  // else
  // Altrimenti visualizza i giorni mancanti entro i quali bisogna fare qualcosa (consto alla rovescia)
  if (DaysLeft > 0) and (DaysLeft < 10) then
    ToPaint := IntToStr(DaysLeft);

  // Se c' un carattere da visualizzare lo visualizza
  if ToPaint <> '' then
  begin
    AViewInfo.EditViewInfo.Paint(ACanvas); // Paint the default cell's contents
    ACanvas.Font.Size := 8;
    ACanvas.Font.Name := 'Arial';
    if (VarToStr(AViewInfo.GridRecord.Values[tvDocFE_STATUS.Index]) = 'rtSDIMessageNS') or
      (VarToStr(AViewInfo.GridRecord.Values[tvDocFE_STATUS.Index]) = 'rtSDIMessageNERejected') then
      ACanvas.Font.Color := clWhite
    else
      ACanvas.Font.Color := clBlack;
    ACanvas.Font.Style := [fsBold];
    ACanvas.DrawText(ToPaint, AViewInfo.ContentBounds, cxAlignHCenter or cxAlignVCenter);
    ADone := True;
  end;
end;

procedure TClientiForm.tvScadCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
begin
  // Solo se non  selezionata
  if not AViewInfo.Selected then
  begin
    // Se la scadenza  ancora da pagare (almeno in parte)
    if (AViewInfo.GridRecord.Values[tvScad.GetColumnByFieldName('RESIDUO').Index] > 0) then
    begin
      // Se si tratta di un insoluto...
      if AViewInfo.GridRecord.Values[tvScad.GetColumnByFieldName('INSOLUTO').Index] = 'T' then
      begin
        ACanvas.Brush.Color := clRed;
        ACanvas.Font.Color := clWhite;
        // Se la scadenza non  gi scaduta la visualizza normale, altrimenti la visualizza con font rosso
        // NB: Su richiesta della Climatec (Samuela); se per  una RIBA ed  gi presentata rimane nera perch
        // altrimenti diventavano sempre tute rosse inutilmente.
      end
      else if (AViewInfo.GridRecord.Values[tvScad.GetColumnByFieldName('DATASCADENZA').Index] < Date) and
        (AViewInfo.GridRecord.Values[tvScad.GetColumnByFieldName('PRESENTATA').Index] <> 'P') then
      begin
        ACanvas.Font.Color := clRed;
        // Se la scadenza non  gi scaduta ed  stata pagata parzialmente usa il fotn giallo o simili
      end
      else if (AViewInfo.GridRecord.Values[tvScad.GetColumnByFieldName('RESIDUO').Index] > 0) and
        (AViewInfo.GridRecord.Values[tvScad.GetColumnByFieldName('RESIDUO').Index] < AViewInfo.GridRecord.Values[tvScad.GetColumnByFieldName('IMPORTO').Index])
      then
      begin
        ACanvas.Font.Color := $0000DDDD;
      end;
      // Se invece la scadenza  gi pagata...
    end
    else
    begin
      // Visualizza la scadenza in grigio
      ACanvas.Font.Color := clSilver;
    end;
  end;

  // Questa parte si occupa di non visualizzare gli zeri della colonna avere quando
  // la scadenza  attiva e dare quando la scadenza  passiva.
  // Inoltre quando la scadenza risulta pagata o riscossa visualizza rispettivamente
  // 'Pagato' o 'Riscosso' se la scadenza risulta regolarmente pagata.
  // -------------------------------------------------------------------------------------------------
  // Se si st visualizzando la colonna DARE
  if (AViewInfo.Item.Index = tvScad.GetColumnByFieldName('DARE').Index) then
  begin
    // Se l'importo DARE  uguale a zero
    if AViewInfo.GridRecord.Values[tvScad.GetColumnByFieldName('DARE').Index] = 0 then
    begin
      // Disegna manualmente la cella in modo che non venga visualizzato lo zero
      ADone := True;
      ACanvas.FillRect(AViewInfo.Bounds);
      // Se  una scadenza attiva significa che la scadenza  regolarmente pagata e quindi visualizza
      // la parola 'Pagato'
      if (AViewInfo.GridRecord.Values[tvScad.GetColumnByFieldName('TIPO').Index] = 'Scad.attiv') then
      begin
        ACanvas.DrawText('Riscosso', AViewInfo.ContentBounds, cxAlignHCenter or cxAlignVCenter);
      end;
    end;
    // Se si st visualizzando la colonna AVERE
  end
  else if (AViewInfo.Item.Index = tvScad.GetColumnByFieldName('AVERE').Index) then
  begin
    // Se l'importo AVERE  uguale a zero
    if AViewInfo.GridRecord.Values[tvScad.GetColumnByFieldName('AVERE').Index] = 0 then
    begin
      // Disegna manualmente la cella in modo che non venga visualizzato lo zero
      ADone := True;
      ACanvas.FillRect(AViewInfo.Bounds);
      // Se  una scadenza attiva significa che la scadenza  regolarmente pagata e quindi visualizza
      // la parola 'Pagato'
      if AViewInfo.GridRecord.Values[tvScad.GetColumnByFieldName('TIPO').Index] = 'Scad.passi' then
      begin
        ACanvas.DrawText('Pagato', AViewInfo.ContentBounds, cxAlignHCenter or cxAlignVCenter);
      end;
    end;
  end;
end;

procedure TClientiForm.tvGMSCONTORIGOGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
begin
  // Se il campo  = 0 non visualizza nulla
  if AText = '0' then
    AText := '';
end;

procedure TClientiForm.tvArtCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
var
  GR: TcxCustomGridRecord;
  PuntoDiRiordino, ScortaMinima: Double;
  Movimentabile: Boolean;
begin
  // GR punta al record corrente
  GR := AViewInfo.GridRecord;

  // Carica nelle variabili il punti di riordino e scorta minima
  PuntoDiRiordino := 0;
  if not VarIsNull(GR.Values[tvArt.GetColumnByFieldName('PUNTORIORDINO').Index]) then
    PuntoDiRiordino := GR.Values[tvArt.GetColumnByFieldName('PUNTORIORDINO').Index];
  ScortaMinima := 0;
  if not VarIsNull(GR.Values[tvArt.GetColumnByFieldName('SCORTAMINIMA').Index]) then
    PuntoDiRiordino := GR.Values[tvArt.GetColumnByFieldName('SCORTAMINIMA').Index];

  // Carica il flag che indica se l'articolo  movimentabile oppure no
  Movimentabile := True;
  if not VarIsNull(GR.Values[tvArt.GetColumnByFieldName('ABILITAMOVMAG').Index]) then
    Movimentabile := (GR.Values[tvArt.GetColumnByFieldName('ABILITAMOVMAG').Index] = 'T');

  // Solo se non  selezionata e se  movimentabile
  if (not AViewInfo.Selected) and Movimentabile then
  begin
    // In base al fatto che la disponibilit si trovi sotto al punto di riordino oppure sotto la scorta minima
    // visualizza la riga in colori diversi per rendere il fatto pi evidente.
    if GR.Values[tvArt.GetColumnByFieldName('DISPONIBILE').Index] <= ScortaMinima then
    begin
      ACanvas.Font.Color := COLORE_ARTICOLI_SOTTOSCORTA;
    end
    else if GR.Values[tvArt.GetColumnByFieldName('DISPONIBILE').Index] <= PuntoDiRiordino then
    begin
      ACanvas.Font.Color := COLORE_ARTICOLI_SOTTO_PUNTO_RIORDINO;
    end;
  end;

  // ==========================================================================
  // Anche se  selezionata...
  // --------------------------------------------------------------------------
  // Se si st visualizzando un articolo composto lo evidenzia
  if (not VarIsNull(GR.Values[tvArtARTICOLOCOMPOSTO.Index])) and (GR.Values[tvArtARTICOLOCOMPOSTO.Index] = 'T') then
  begin
    ACanvas.Font.Style := ACanvas.Font.Style + [fsBold];
  end;
  // ==========================================================================

  // ==========================================================================
  // Se la riga  espansa la visualizza con il colore di sfondo opportuno
  // --------------------------------------------------------------------------
  if GR.Expanded then
  begin
    ACanvas.Brush.Color := lvArt.Styles.TabsBackground.Color;
    ACanvas.Font.Color := lvArt.Styles.TabsBackground.TextColor;
    // ACanvas.Font.Style := [fsBold];
  end;
  // ==========================================================================
end;

procedure TClientiForm.tvGMEndDrag(Sender, Target: TObject; X, Y: Integer);
begin
  // Prima di tutto controlla che il bersaglio non sia nullo
  if Target <> nil then
  begin
    // In base al bersaglio attiva la funzione corretta.
    if Target is TSpeedButton then
    begin
      TSpeedButton(Target).OnClick(Self);
    end;
  end;
end;

procedure TClientiForm.tvPratCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
begin
  // Se il rigo del filtro (FilterRow) usa il colore specificato appositamente
  // in ogni caso, anche se  il rigo selezionato che mi piace di pi
  if (AViewInfo.GridRecord as TcxCustomGridRow).IsFilterRow then
  begin
    ACanvas.Brush.Color := (Sender as TcxGridDBTableView).Styles.FilterRowInfoText.Color;
    Exit;
  end;

  // Solo se non  selezionata
  if not AViewInfo.Selected then
  begin
    // IMposta il colore del Font in base allo stato del documento
    if (not VarIsNull(AViewInfo.GridRecord.Values[tvPrat.GetColumnByFieldName('STATODESCRIZIONE').Index])) and
      (not VarIsNull(AViewInfo.GridRecord.Values[tvPrat.GetColumnByFieldName('STATOFOREGROUND').Index])) then
    begin
      ACanvas.Font.Color := DM1.StrToColor(AViewInfo.GridRecord.Values[tvPrat.GetColumnByFieldName('STATOFOREGROUND').Index], ACanvas.Font.Color);
    end;
  end;

  // ===========================================================================
  // TRACCIAMENTO CONTENUTO
  // ---------------------------------------------------------------------------
  ADone := True;
  // Disegna il contenuto della cella in modo standard
  AViewInfo.EditViewInfo.Font := ACanvas.Font;
  AViewInfo.EditViewInfo.TextColor := ACanvas.Font.Color;
  AViewInfo.EditViewInfo.BackgroundColor := ACanvas.Brush.Color;
  AViewInfo.EditViewInfo.Paint(ACanvas);
  // Disegna la linea di separazione verticale se  il caso
  if (AViewInfo.Item.Tag = 0) // Se la propriet Tag della colonna = 0
    or (not AViewInfo.Item.IsLast) and (Sender.Items[AViewInfo.Item.Index + 1].Tag = 0) // Se la propriet Tag della colonna successiva = 0
  then
    ACanvas.DrawComplexFrame(AViewInfo.Bounds, $00D3D3D3, $00D3D3D3, [bRight], 1);
  // Se  la prima colonna a sx
  if (AViewInfo.Item.IsFirst) // Se  la prima colonna a sx
  then
    ACanvas.DrawComplexFrame(AViewInfo.Bounds, $00D3D3D3, $00D3D3D3, [bLeft], 1);
  // Se  l'ultimo record diesgna anche il bordo inferiore
  if AViewInfo.GridRecord.IsLast then
    ACanvas.DrawComplexFrame(AViewInfo.Bounds, $00D3D3D3, $00D3D3D3, [bBottom], 1);
  // ===========================================================================
end;

procedure TClientiForm.tvGMDataControllerGroupingChanged(Sender: TObject);
begin
  // Se i dati sono raggruppati in qualche maniera abilita anche i bordi orizzontali
  // altrimenti no
  if tvGM.GroupedColumnCount > 0 then
    tvGM.OptionsView.GridLines := glBoth
  else
    tvGM.OptionsView.GridLines := glVertical;
end;

procedure TClientiForm.tvCVDataControllerGroupingChanged(Sender: TObject);
begin
  // Se i dati sono raggruppati in qualche maniera abilita anche i bordi orizzontali
  // altrimenti no
  if tvCV.GroupedColumnCount > 0 then
    tvCV.OptionsView.GridLines := glBoth
  else
    tvCV.OptionsView.GridLines := glVertical;
end;

procedure TClientiForm.tvArtDataControllerGroupingChanged(Sender: TObject);
begin
  if tvArt.GroupedColumnCount > 0 then
    tvArt.OptionsView.GridLines := glBoth
  else
    tvArt.OptionsView.GridLines := glVertical;
end;

procedure TClientiForm.tvRubricaDataControllerSortingChanged(Sender: TObject);
begin
  // F rifare l'interrogazione con il nuovo ordinamento
  // NB: Solo se non c' alcun raggruppamento
  if tvRubrica.DataController.DataModeController.GridMode and (tvRubrica.GroupedColumnCount = 0) then
    RxSpeedButtonTrovaClick(Self);
  tvRubrica.Controller.GotoFirst(False);
end;

procedure TClientiForm.tvDocDataControllerSortingChanged(Sender: TObject);
begin
  // F rifare l'interrogazione con il nuovo ordinamento
  // NB: Solo se non c' alcun raggruppamento
  if tvDoc.DataController.DataModeController.GridMode and (tvDoc.GroupedColumnCount = 0) then
    RxSpeedButtonTrovaClick(Self);
  tvDoc.Controller.GotoFirst(False);
end;

procedure TClientiForm.tvGMDataControllerSortingChanged(Sender: TObject);
begin
  // F rifare l'interrogazione con il nuovo ordinamento
  // NB: Solo se non c' alcun raggruppamento
  if tvGM.DataController.DataModeController.GridMode and (tvGM.GroupedColumnCount = 0) then
    RxSpeedButtonTrovaClick(Self);
  tvGM.Controller.GotoFirst(False);
end;

procedure TClientiForm.tvPratDataControllerSortingChanged(Sender: TObject);
begin
  // F rifare l'interrogazione con il nuovo ordinamento
  // NB: Solo se non c' alcun raggruppamento
  if tvPrat.DataController.DataModeController.GridMode and (tvPrat.GroupedColumnCount = 0) then
    RxSpeedButtonTrovaClick(Self);
  tvPrat.Controller.GotoFirst(False);
end;

procedure TClientiForm.tvScadDataControllerSortingChanged(Sender: TObject);
begin
  // F rifare l'interrogazione con il nuovo ordinamento
  // NB: Solo se non c' alcun raggruppamento
  if tvScad.DataController.DataModeController.GridMode and (tvScad.GroupedColumnCount = 0) then
    RxSpeedButtonTrovaClick(Self);
  tvScad.Controller.GotoFirst(False);
end;

procedure TClientiForm.tvArtDataControllerSortingChanged(Sender: TObject);
begin
  // F rifare l'interrogazione con il nuovo ordinamento
  // NB: Solo se non c' alcun raggruppamento
  if tvArt.DataController.DataModeController.GridMode and (tvArt.GroupedColumnCount = 0) then
    RxSpeedButtonTrovaClick(Self);
  tvArt.Controller.GotoFirst(False);
end;

procedure TClientiForm.tvRubricaCustomDrawGroupCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableCellViewInfo;
  var ADone: Boolean);
var
  CurrColor: TColor;
begin
  // Inizializzazione
  ADone := True;

  // In base alla situazione determina il colore
  if AViewInfo.Selected then
    CurrColor := Sender.Styles.Selection.Color
  else
    CurrColor := (Sender.Styles as TcxGridTableViewStyles).Group.Color;

  // Disegna il rettangolo di sfondo
  DMStyles.DrawGradient(ACanvas.Canvas, AViewInfo.Bounds, clWhite, CurrColor, 30, True);
  // Cosi il testo  trasparente
  ACanvas.Brush.Style := bsClear;

  // Campo
  ACanvas.Font.Name := 'Arial';
  ACanvas.Font.Size := 8;
  ACanvas.Font.Style := [fsBold];
  ACanvas.DrawText('    ' + AViewInfo.GridRecord.DisplayTexts[tvScadTIPOLOGIA.Index], AViewInfo.TextAreaBounds, cxAlignLeft or cxAlignBottom);

  ACanvas.DrawComplexFrame(AViewInfo.Bounds, (Sender as TcxGridDBTableView).OptionsView.GridLineColor, (Sender as TcxGridDBTableView).OptionsView.GridLineColor,
    [bTop], 1);
end;

procedure TClientiForm.SpeedButtonRollOver3Click(Sender: TObject);
begin
  DM1.Attendere;
  try
    // Visualizza la form che permette di selezionare l'articolo da inserire
    // nel documento.
    Application.CreateForm(TArticoliForm, ArticoliForm);
    ArticoliForm.Parent := MainForm;
    ArticoliForm.Tag := 997; // Abilita la selezione dell'articolo
    ArticoliForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.SoloGiacAttivaMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
var
  CLB: TCheckListBox;
  CheckIndex: Integer;
begin
  // ----------------------------------------------------------------------------------------------------
  // Questo codice server per fare in modo che anche se l'utente clicca sul titolo della voce, questa
  // venga selezinata o deselezionata come se si fosse cliccato sul riquadrino del segno di check)
  // ----------------------------------------------------------------------------------------------------
  // CLB Punta alla CheckListBox
  CLB := Sender as TCheckListBox;
  // Quale voce si trova sotto il mouse?
  CheckIndex := CLB.ItemAtPos(Point(X, Y), True);
  // Se c'era una voce cambia il suo stato
  if CheckIndex <> -1 then
  begin
    if CLB.Tag = 0 then
      CLB.Checked[CheckIndex] := not CLB.Checked[CheckIndex];
    // Rimette la Propriet Tag del componente = 0
    CLB.Tag := 0;
    // Solo se s cliccato con il pulsante SX del mouse
    if Button = mbRight then
    begin
      // Esegue la ricerca
      RxSpeedButtonTrovaClick(Self);
    end;
  end;
  // F in modo che non resti una voce selezionata e quindi evidenziata che non mi piace
  CLB.ItemIndex := -1;
  // ----------------------------------------------------------------------------------------------------
end;

procedure TClientiForm.dxPrinterCustomDrawPageFooter(Sender: TObject; AReportLink: TBasedxReportLink; ACanvas: TCanvas; APageIndex: Integer; var ARect: TRect;
  ANom, ADenom: Integer; var ADefaultDrawText, ADefaultDrawBackground: Boolean);
begin
  // Se sta stampando l'agenda esce subito
  if (AReportLink.Name = 'AgendaLink') or (AReportLink.Name = 'GridGCLink') then
    Exit;

  // Richiama il gestore di feault
  DM1.dxPrinterDefaultDrawPageFooter(AReportLink, ACanvas, APageIndex, ARect, ANom, ADenom);

  // Stampa i totali solo sull'ultima pagina
  if (APageIndex + 1) = AReportLink.PageCount then
  begin
    // Prima di tutto resetta il sistema di stampa dei totali
    DM1.ResetPrintTotals;

    // IN base al ReportLink attuale (alla stampa attuale) stampa i totali corretti.
    if AReportLink.Name = 'GridGMLink' then
    begin
      DM1.AddPrintTotal(ACanvas, ARect, 'Tot.imp.IVA comp.', CurrToStrF(QryTotGMTOTIMPORTORIGOIVACOMPRESA.Value, ffCurrency, 2), False, 110, ANom, ADenom,
        TP_PAGE_FOOTER);
      DM1.AddPrintTotal(ACanvas, ARect, 'Totale importi', CurrToStrF(QryTotGMTOTIMPORTORIGO.Value, ffCurrency, 2), True, 110, ANom, ADenom, TP_PAGE_FOOTER);
      DM1.AddPrintTotal(ACanvas, ARect, 'Totale Qt', QryTotGMTOTQTA.AsString, False, 70, ANom, ADenom, TP_PAGE_FOOTER);
      DM1.AddPrintTotal(ACanvas, ARect, 'Prezzo medio', CurrToStrF(QryTotGMPREZZOMEDIO.Value, ffCurrency, DM1.DecMicroPrz), False, 90, ANom, ADenom,
        TP_PAGE_FOOTER);

    end
    else if AReportLink.Name = 'GridScadLink' then
    begin
      DM1.AddPrintTotal(ACanvas, ARect, 'Saldo', CurrToStrF(QryTotScad.FieldByName('DARE').AsFloat - QryTotScad.FieldByName('AVERE').AsFloat, ffCurrency, 2),
        True, 100, ANom, ADenom, TP_PAGE_FOOTER);
      DM1.AddPrintTotal(ACanvas, ARect, 'Totale da Pagare', CurrToStrF(QryTotScad.FieldByName('AVERE').AsFloat, ffCurrency, 2), False, 100, ANom, ADenom,
        TP_PAGE_FOOTER);
      DM1.AddPrintTotal(ACanvas, ARect, 'Prezzo da Riscuotere', CurrToStrF(QryTotScad.FieldByName('DARE').AsFloat, ffCurrency, 2), False, 100, ANom, ADenom,
        TP_PAGE_FOOTER);
      DM1.AddTotalSeparation(30, ANom, ADenom);
      DM1.AddPrintTotal(ACanvas, ARect, 'N RiBa', TotNumScad.Caption, False, 100, ANom, ADenom, TP_PAGE_FOOTER);

    end
    else if AReportLink.Name = 'GridPrimanotaLink' then
    begin
      // Se sta stampando la primanota
      if AReportLink.Component.Name = 'GridPrimanota' then
      begin
        DM1.AddPrintTotal(ACanvas, ARect, 'Saldo fuori cassa', CurrToStrF(QueryTotali.FieldByName('SALDOFUORI').AsCurrency, ffCurrency, 2), True, 80, ANom,
          ADenom, TP_PAGE_FOOTER);
        DM1.AddPrintTotal(ACanvas, ARect, 'Uscite fuori cassa', CurrToStrF(QueryTotali.FieldByName('TOTFUORIUSCITE').AsCurrency, ffCurrency, 2), False, 80,
          ANom, ADenom, TP_PAGE_FOOTER);
        DM1.AddPrintTotal(ACanvas, ARect, 'Entrate fuori cassa', CurrToStrF(QueryTotali.FieldByName('TOTFUORIENTRATE').AsCurrency, ffCurrency, 2), False, 80,
          ANom, ADenom, TP_PAGE_FOOTER);
        DM1.AddTotalSeparation(10, ANom, ADenom);
        DM1.AddPrintTotal(ACanvas, ARect, 'Saldo cassa', CurrToStrF(QueryTotali.FieldByName('SALDOCASSA').AsCurrency, ffCurrency, 2), True, 80, ANom, ADenom,
          TP_PAGE_FOOTER);
        DM1.AddPrintTotal(ACanvas, ARect, 'Uscite cassa', CurrToStrF(QueryTotali.FieldByName('TOTCASSAUSCITE').AsCurrency, ffCurrency, 2), False, 80, ANom,
          ADenom, TP_PAGE_FOOTER);
        DM1.AddPrintTotal(ACanvas, ARect, 'Entrate cassa', CurrToStrF(QueryTotali.FieldByName('TOTCASSAENTRATE').AsCurrency, ffCurrency, 2), False, 80, ANom,
          ADenom, TP_PAGE_FOOTER);

        DM1.AddTotalSeparation(50, ANom, ADenom);

        DM1.AddPrintTotal(ACanvas, ARect, 'Saldo fuori c. periodo', CurrToStrF(QryTotPeriodo.FieldByName('SALDOFUORI').AsCurrency, ffCurrency, 2), True, 80,
          ANom, ADenom, TP_PAGE_FOOTER);
        DM1.AddPrintTotal(ACanvas, ARect, 'Uscite fuori c. periodo', CurrToStrF(QryTotPeriodo.FieldByName('TOTFUORIUSCITE').AsCurrency, ffCurrency, 2), False,
          80, ANom, ADenom, TP_PAGE_FOOTER);
        DM1.AddPrintTotal(ACanvas, ARect, 'Entrate fuori c. periodo', CurrToStrF(QryTotPeriodo.FieldByName('TOTFUORIENTRATE').AsCurrency, ffCurrency, 2), False,
          80, ANom, ADenom, TP_PAGE_FOOTER);
        DM1.AddTotalSeparation(10, ANom, ADenom);
        DM1.AddPrintTotal(ACanvas, ARect, 'Saldo cassa periodo', CurrToStrF(QryTotPeriodo.FieldByName('SALDOCASSA').AsCurrency, ffCurrency, 2), True, 80, ANom,
          ADenom, TP_PAGE_FOOTER);
        DM1.AddPrintTotal(ACanvas, ARect, 'Uscite cassa periodo', CurrToStrF(QryTotPeriodo.FieldByName('TOTCASSAUSCITE').AsCurrency, ffCurrency, 2), False, 80,
          ANom, ADenom, TP_PAGE_FOOTER);
        DM1.AddPrintTotal(ACanvas, ARect, 'Entrate cassa periodo', CurrToStrF(QryTotPeriodo.FieldByName('TOTCASSAENTRATE').AsCurrency, ffCurrency, 2), False,
          80, ANom, ADenom, TP_PAGE_FOOTER);
        // Se invece si sta stampando il partitario
      end
      else
      begin
        // Verifica l'esistenza della form del partitario
        if TabPartitarioForm = nil then
          raise Exception.Create('Form Tab Partitario non esistenza!');
        // In base alla pagina del partitario aperta carica i totali di conseguenza
        if TabPartitarioForm.PageControlPartitario.ActivePage = TabPartitarioForm.TabPartSoggetti then
        begin
          DM1.AddPrintTotal(ACanvas, ARect, 'SALDO Totale', TabPartitarioForm.TotSaldo.Text + '   ' + TabPartitarioForm.TotSegno.Text, True, 90, ANom, ADenom,
            TP_PAGE_HEADER);
          DM1.AddPrintTotal(ACanvas, ARect, 'Totale AVERE', TabPartitarioForm.TotAvere.Text, False, 90, ANom, ADenom, TP_PAGE_HEADER);
          DM1.AddPrintTotal(ACanvas, ARect, 'Totale DARE', TabPartitarioForm.TotDare.Text, False, 90, ANom, ADenom, TP_PAGE_HEADER);
          DM1.AddTotalSeparation(50, ANom, ADenom);
          DM1.AddPrintTotal(ACanvas, ARect, 'SALDO periodo', TabPartitarioForm.TotPerSaldo.Text + '   ' + TabPartitarioForm.TotPerSegno.Text, True, 90, ANom,
            ADenom, TP_PAGE_HEADER);
          DM1.AddPrintTotal(ACanvas, ARect, 'Tot. AVERE periodo', TabPartitarioForm.TotPerAvere.Text, False, 90, ANom, ADenom, TP_PAGE_HEADER);
          DM1.AddPrintTotal(ACanvas, ARect, 'Tot. DARE periodo', TabPartitarioForm.TotPerDare.Text, False, 90, ANom, ADenom, TP_PAGE_HEADER);
        end
        else if TabPartitarioForm.PageControlPartitario.ActivePage = TabPartitarioForm.TabPartIva then
        begin
          DM1.AddPrintTotal(ACanvas, ARect, 'SALDO Totale', TabPartitarioForm.TotPartIvaSaldo.Text + '   ' + TabPartitarioForm.TotPartIvaSegno.Text, True, 90,
            ANom, ADenom, TP_PAGE_HEADER);
          DM1.AddPrintTotal(ACanvas, ARect, 'Totale AVERE', TabPartitarioForm.TotPartIvaAvere.Text, False, 90, ANom, ADenom, TP_PAGE_HEADER);
          DM1.AddPrintTotal(ACanvas, ARect, 'Totale DARE', TabPartitarioForm.TotPartIvaDare.Text, False, 90, ANom, ADenom, TP_PAGE_HEADER);
          DM1.AddTotalSeparation(50, ANom, ADenom);
          DM1.AddPrintTotal(ACanvas, ARect, 'SALDO periodo', TabPartitarioForm.TotPartIvaPerSaldo.Text + '   ' + TabPartitarioForm.TotPartIvaPerSegno.Text,
            True, 90, ANom, ADenom, TP_PAGE_HEADER);
          DM1.AddPrintTotal(ACanvas, ARect, 'Tot. AVERE periodo', TabPartitarioForm.TotPartIvaPerAvere.Text, False, 90, ANom, ADenom, TP_PAGE_HEADER);
          DM1.AddPrintTotal(ACanvas, ARect, 'Tot. DARE periodo', TabPartitarioForm.TotPartIvaPerDare.Text, False, 90, ANom, ADenom, TP_PAGE_HEADER);
        end
        else if TabPartitarioForm.PageControlPartitario.ActivePage = TabPartitarioForm.TabPartAltro then
        begin
          DM1.AddPrintTotal(ACanvas, ARect, 'SALDO Totale', TabPartitarioForm.TotPartAltroSaldo.Text + '   ' + TabPartitarioForm.TotPartAltroSegno.Text, True,
            90, ANom, ADenom, TP_PAGE_HEADER);
          DM1.AddPrintTotal(ACanvas, ARect, 'Totale AVERE', TabPartitarioForm.TotPartAltroAvere.Text, False, 90, ANom, ADenom, TP_PAGE_HEADER);
          DM1.AddPrintTotal(ACanvas, ARect, 'Totale DARE', TabPartitarioForm.TotPartAltroDare.Text, False, 90, ANom, ADenom, TP_PAGE_HEADER);
          DM1.AddTotalSeparation(50, ANom, ADenom);
          DM1.AddPrintTotal(ACanvas, ARect, 'SALDO periodo', TabPartitarioForm.TotPartAltroPerSaldo.Text + '   ' + TabPartitarioForm.TotPartAltroPerSegno.Text,
            True, 90, ANom, ADenom, TP_PAGE_HEADER);
          DM1.AddPrintTotal(ACanvas, ARect, 'Tot. AVERE periodo', TabPartitarioForm.TotPartAltroPerAvere.Text, False, 90, ANom, ADenom, TP_PAGE_HEADER);
          DM1.AddPrintTotal(ACanvas, ARect, 'Tot. DARE periodo', TabPartitarioForm.TotPartAltroPerDare.Text, False, 90, ANom, ADenom, TP_PAGE_HEADER);
        end;
      end;
    end;
  end;
end;

procedure TClientiForm.dxPrinterCustomDrawPageHeader(Sender: TObject; AReportLink: TBasedxReportLink; ACanvas: TCanvas; APageIndex: Integer; var ARect: TRect;
  ANom, ADenom: Integer; var ADefaultDrawText, ADefaultDrawBackground: Boolean);
begin
  // Se sta stampando l'agenda esce subito
  if (AReportLink.Name = 'AgendaLink') then
    Exit;

  // Richiama il gestore di feault
  DM1.dxPrinterDefaultDrawPageHeader(AReportLink, ACanvas, ARect, ANom, ADenom);

  // Se sta stampando il giornale di cantiere esce qui
  if (AReportLink.Name = 'GridGCLink') then
    Exit;

  // Stampa i totali colo sulla prima pagina
  // if (APageIndex + 1) = AReportLink.PageCount then begin  // Con questa riga al posto della prox stampa sull'ultima pagina
  if (APageIndex + 1) = 1 then
  begin
    // Prima di tutto resetta il sistema di stampa dei totali
    DM1.ResetPrintTotals;

    // IN base al ReportLink attuale (alla stampa attuale) stampa i totali corretti.
    if AReportLink.Name = 'GridPrimanotaLink' then
    begin
      // Se sta stampando la primanota
      if AReportLink.Component.Name = 'GridPrimanota' then
      begin
        DM1.AddPrintTotal(ACanvas, ARect, 'Saldo fuori cassa', CurrToStrF(QueryRiporti.FieldByName('SALDOFUORI').AsCurrency, ffCurrency, 2), True, 80, ANom,
          ADenom, TP_PAGE_HEADER);
        DM1.AddPrintTotal(ACanvas, ARect, 'Uscite fuori cassa', CurrToStrF(QueryRiporti.FieldByName('TOTFUORIUSCITE').AsCurrency, ffCurrency, 2), False, 80,
          ANom, ADenom, TP_PAGE_HEADER);
        DM1.AddPrintTotal(ACanvas, ARect, 'Entrate fuori cassa', CurrToStrF(QueryRiporti.FieldByName('TOTFUORIENTRATE').AsCurrency, ffCurrency, 2), False, 80,
          ANom, ADenom, TP_PAGE_HEADER);
        DM1.AddTotalSeparation(10, ANom, ADenom);
        DM1.AddPrintTotal(ACanvas, ARect, 'Saldo cassa', CurrToStrF(QueryRiporti.FieldByName('SALDOCASSA').AsCurrency, ffCurrency, 2), True, 80, ANom, ADenom,
          TP_PAGE_HEADER);
        DM1.AddPrintTotal(ACanvas, ARect, 'Uscite cassa', CurrToStrF(QueryRiporti.FieldByName('TOTCASSAUSCITE').AsCurrency, ffCurrency, 2), False, 80, ANom,
          ADenom, TP_PAGE_HEADER);
        DM1.AddPrintTotal(ACanvas, ARect, 'Entrate cassa', CurrToStrF(QueryRiporti.FieldByName('TOTCASSAENTRATE').AsCurrency, ffCurrency, 2), False, 80, ANom,
          ADenom, TP_PAGE_HEADER);
        // Se invece si sta stampando il partitario
      end
      else
      begin
        // Verifica l'esistenza della form del partitario
        if TabPartitarioForm = nil then
          raise Exception.Create('Form Tab Partitario non esistenza!');
        // In base alla pagina del partitario aperta carica i totali di conseguenza
        if TabPartitarioForm.PageControlPartitario.ActivePage = TabPartitarioForm.TabPartSoggetti then
        begin
          DM1.AddPrintTotal(ACanvas, ARect, 'SALDO', TabPartitarioForm.RiportoSaldo.Text + '   ' + TabPartitarioForm.RiportoSegno.Text, True, 90, ANom, ADenom,
            TP_PAGE_HEADER);
          DM1.AddPrintTotal(ACanvas, ARect, 'Riporto AVERE', TabPartitarioForm.RiportoAvere.Text, False, 90, ANom, ADenom, TP_PAGE_HEADER);
          DM1.AddPrintTotal(ACanvas, ARect, 'Riporto DARE', TabPartitarioForm.RiportoDare.Text, False, 90, ANom, ADenom, TP_PAGE_HEADER);
        end
        else if TabPartitarioForm.PageControlPartitario.ActivePage = TabPartitarioForm.TabPartIva then
        begin
          DM1.AddPrintTotal(ACanvas, ARect, 'SALDO', TabPartitarioForm.RiportoPartIvaSaldo.Text + '   ' + TabPartitarioForm.RiportoPartIvaSegno.Text, True, 90,
            ANom, ADenom, TP_PAGE_HEADER);
          DM1.AddPrintTotal(ACanvas, ARect, 'Riporto AVERE', TabPartitarioForm.RiportoPartIvaAvere.Text, False, 90, ANom, ADenom, TP_PAGE_HEADER);
          DM1.AddPrintTotal(ACanvas, ARect, 'Riporto DARE', TabPartitarioForm.RiportoPartIvaDare.Text, False, 90, ANom, ADenom, TP_PAGE_HEADER);
        end
        else if TabPartitarioForm.PageControlPartitario.ActivePage = TabPartitarioForm.TabPartAltro then
        begin
          DM1.AddPrintTotal(ACanvas, ARect, 'SALDO', TabPartitarioForm.RiportoPartAltroSaldo.Text + '   ' + TabPartitarioForm.RiportoPartAltroSegno.Text, True,
            90, ANom, ADenom, TP_PAGE_HEADER);
          DM1.AddPrintTotal(ACanvas, ARect, 'Riporto AVERE', TabPartitarioForm.RiportoPartAltroAvere.Text, False, 90, ANom, ADenom, TP_PAGE_HEADER);
          DM1.AddPrintTotal(ACanvas, ARect, 'Riporto DARE', TabPartitarioForm.RiportoPartAltroDare.Text, False, 90, ANom, ADenom, TP_PAGE_HEADER);
        end;
      end;
    end;
  end;
end;

procedure TClientiForm.dxPrinterStartGenerateReport(Sender: TObject; AReportLink: TBasedxReportLink);
begin
  // Se sta stampando l'agenda esce subito
  if (AReportLink.Name = 'AgendaLink') or (AReportLink.Name = 'GridGCLink') then
    Exit;

  // Se il reportlink attuale  uno di questi richiama la stampa con il
  // parametro di stampa multiline = True;
  if (AReportLink.Name = 'GridScadLink') or (AReportLink.Name = 'GridSoggLink') or (AReportLink.Name = 'GridArtLink') or
    (AReportLink.Name = 'GridArtInventarioUltimoCostoLink') or (AReportLink.Name = 'GridImpegniLink') or (AReportLink.Name = 'GridPartLink') then
  begin
    // Richiama il gestorei di defuault dell'evento
    DM1.PrepareGridForReport(AReportLink.Component as TcxGrid, True);
    // Se invece il reportlink attuale  quello del giornale id cantiere
  end
  else if (AReportLink.Name = 'GridGCLink') then
  begin
    // Le linee di separazione delle colonne devono essere blu
    TabGCForm.btvGC.OptionsView.GridLineColor := clBlue;
    // Imposta gli StyleSheet per la stampa
    TabGCForm.btvGC.Styles.StyleSheet := DM1.btvGCMasterStampa;
    TabGCForm.btvGCRighi.Styles.StyleSheet := DM1.tvStampaGCDet;
    // Se invece il reportlink attuale  quello del GOS Ore
  end
  else if (AReportLink.Name = 'GosOreLink') then
  begin
    // Le linee di separazione delle colonne devono essere blu
    tvOre.OptionsView.GridLineColor := clBlue;
    // Imposta gli StyleSheet per la stampa
    tvOre.Styles.StyleSheet := DM1.tvStampaGC;
    // Cltrimenti stampa normalmente
  end
  else
  begin
    // Richiama il gestorei di defuault dell'evento
    if AReportLink.Component.ClassType = TcxGrid then
      DM1.PrepareGridForReport(AReportLink.Component as TcxGrid, False);
  end;
end;

procedure TClientiForm.editArtCategoria1PropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
  Combo: TcxComboBox;
  StcIndex: String;
begin
  // Inizializzazione
  Combo := (Sender as TcxComboBox);
  StcIndex := IntToStr(StrToInt(RightStr(Combo.Name, 1)) + 5); // Le 3 categorie per gli articolo sono la 4, 5 e 6
  Combo.Properties.Items.Clear;
  Combo.Properties.Items.Add('');
  // Altrimenti provvede a caricare i dati
  Qry := TIB_Cursor.Create(nil);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    // Imposta query
    Qry.SQL.Add('SELECT DISTINCT CAMPO1 FROM CATEG' + StcIndex);
    Qry.Open;
    // Caricamento dati
    while not Qry.Eof do
    begin
      Combo.Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
    Qry.Close;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.dxPrinterEndGenerateReport(Sender: TObject; AReportLink: TBasedxReportLink);
begin
  // Se sta stampando l'agenda esce subito
  if (AReportLink.Name = 'AgendaLink') or (AReportLink.Name = 'GridGCLink') then
    Exit;

  // Se il reportlink attuale  uno di questi richiama la stampa con il
  // parametro di stampa multiline = True;
  if (AReportLink.Name = 'GridScadLink') or (AReportLink.Name = 'GridSoggLink') or (AReportLink.Name = 'GridArtLink') or
    (AReportLink.Name = 'GridArtInventarioUltimoCostoLink') or (AReportLink.Name = 'GridImpegniLink') or (AReportLink.Name = 'GridPartLink') then
  begin
    // Richiama il gestorei di defuault dell'evento
    DM1.RestoreGridAfterReport(AReportLink.Component as TcxGrid, True);
    // Se invece il reportlink attuale  quello del giornale id cantiere
  end
  else if (AReportLink.Name = 'GridGCLink') then
  begin
    // Le linee di separazione delle colonne devono essere blu
    TabGCForm.btvGC.OptionsView.GridLineColor := clDefault;
    TabGCForm.btvGCRighi.OptionsView.GridLineColor := clDefault;
    // Imposta gli StyleSheet per la stampa
    TabGCForm.btvGC.Styles.StyleSheet := DM1.btvGCMaster;
    TabGCForm.btvGCRighi.Styles.StyleSheet := DM1.tvGCDetail;
    // Se invece il reportlink attuale  quello del GOS Ore
  end
  else if (AReportLink.Name = 'GosOreLink') then
  begin
    // Le linee di separazione delle colonne devono essere blu
    tvOre.OptionsView.GridLineColor := clDefault;
    // Imposta gli StyleSheet per la stampa
    tvOre.Styles.StyleSheet := DM1.tvGCMaster;
    // Cltrimenti stampa normalmente
  end
  else
  begin
    // Richiama il gestorei di defuault dell'evento
    if AReportLink.Component.ClassType = TcxGrid then
      DM1.RestoreGridAfterReport(AReportLink.Component as TcxGrid, False);
  end;
end;

procedure TClientiForm.Stampaelencoscadenze1Click(Sender: TObject);
var
  PrecFontSize: Integer;
begin
  try
    // Imposta la stringa su cui viene costruito il range di date della stampa in base ai filtri per data
    DM1.SetReportDateRange(ScadDal.EditText, ScadAl.EditText);
    // Prima di procedere rimpicciolisce il Fotn usato per le stampe
    PrecFontSize := DM1.PrintContentEven.Font.Size;
    DM1.PrintGridHeader.Font.Size := 6;
    DM1.PrintContentEven.Font.Size := 6;
    DM1.PrintContentOdd.Font.Size := 6;
    // Preview
    if MenuStampe.Tag = 0 then
    begin
      dxPrinter.Preview(True, GridScadLink);
      // Stampa
    end
    else if MenuStampe.Tag = 1 then
    begin
      dxPrinter.Print(True, nil, GridScadLink);
    end;
  finally
    // Ripristina il fotn precedente
    DM1.PrintGridHeader.Font.Size := PrecFontSize;
    DM1.PrintContentEven.Font.Size := PrecFontSize;
    DM1.PrintContentOdd.Font.Size := PrecFontSize;
  end;
end;

procedure TClientiForm.TipoScadenze2MouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
var
  Voce: Byte;
  CLB: TCheckListBox;
  I: Integer;
begin
  // CLB contiene il riferimento al chiamante
  CLB := (Sender as TCheckListBox);
  // INdividua quale voce si trova sotto la freccia del mouse
  Voce := CLB.ItemAtPos(CLB.ScreenToClient(Mouse.CursorPos), True);
  // Solo se il mouse era su una voce
  if Voce <> -1 then
  begin
    for I := 0 to CLB.Count - 1 do
      if Voce = I then
      begin
        if CLB.Tag <> 1 then
          CLB.Checked[I] := not CLB.Checked[I];
      end
      else
        CLB.Checked[I] := False;
  end;
  // if Voce <> -1 then begin
  // case Voce of
  // 0: begin
  // if CLB.Tag <> 1 then CLB.Checked[0] := not CLB.Checked[0];
  // CLB.Checked[1] := False;
  // end;
  // 1: begin
  // CLB.Checked[0] := False;
  // if CLB.Tag <> 1 then CLB.Checked[1] := not CLB.Checked[1];
  // end;
  // end;
  // end;
  // Se  stato cliccato con il pulsante dx del mouse avvia anche la ricerca
  if Button = mbRight then
    RxSpeedButtonTrovaClick(Self);
  // F in modo che non resti una voce selezionata e quindi evidenziata che non mi piace
  CLB.ItemIndex := -1;
  // Resetta Tag := 0
  CLB.Tag := 0;
end;

procedure TClientiForm.ImpostaFiltriScadenzePerVisualizzareSoloRibaDaPresentare;
begin
  // ==========================================================================
  // INIZIO - IMPOSTAZIONE DIE FILTRI PER LA VISUALIZZAZIONE DELLE SOLE RI.BA. DA PRESENTARE ALL'INCASSO
  // --------------------------------------------------------------------------
  // Prima si assicura che vengano visualizzate solo le RIBA non ancora presentate
  // e solo quelle da riscuotere
  TipoScadenze.Checked[0] := True;
  TipoScadenze.Checked[1] := False;
  TipoScadenze.Checked[2] := False;
  TipoScadenze2.Checked[0] := False;
  TipoScadenze2.Checked[1] := True;
  TipoScadenze3.Checked[0] := True;
  TipoScadenze3.Checked[1] := False;
  RxSpeedButtonTrovaClick(Self);
  // --------------------------------------------------------------------------
  // FINE - IMPOSTAZIONE DIE FILTRI PER LA VISUALIZZAZIONE DELLE SOLE RI.BA. DA PRESENTARE ALL'INCASSO
  // ==========================================================================
end;

procedure TClientiForm.StampadistintadipresentazioneRIBAperlabanca1Click(Sender: TObject);
type
  TColSave = record
    Visible: Boolean;
    VisibleIndex: Byte;
    Tag: Integer;
  end;
var
  ColSave: array of TColSave;
  ColToPrint: set of Byte;
  I: Byte;
  PrecTitle: String;
  Result: TModalResult;
  PrecFontSize: Integer;
begin
  // Prima si assicura che vengano visualizzate solo le RIBA non ancora presentate
  // e solo quelle da riscuotere
  ImpostaFiltriScadenzePerVisualizzareSoloRibaDaPresentare;
  // Prima di procedere rimpicciolisce il Fotn usato per le stampe
  PrecFontSize := DM1.PrintContentEven.Font.Size;
  DM1.PrintGridHeader.Font.Size := 6;
  DM1.PrintContentEven.Font.Size := 6;
  DM1.PrintContentOdd.Font.Size := 6;
  // Salva il titolo precedente e lo modifuca
  PrecTitle := GridScadLink.ReportTitle.Text;
  GridScadLink.ReportTitle.Text := 'Distinta di presentazione RI.BA. per l''incasso   -   ' + DM1.TableDatiAziendaRAGIONESOCIALE.AsString;
  // Inserisce in ColToPrint gli Index delle colonne che dovranno essere stampate e quindi visibili
  ColToPrint := [tvScadDATASCADENZA.Index, tvScadDARE.Index, tvScadDOCUMENTO.Index, tvScadBANCA.Index, tvScadABI.Index, tvScadCAB.Index,
    tvScadRAGIONESOCIALE.Index, tvScadINDIRIZZO.Index, tvScadCAP.Index, tvScadCITTA.Index, tvScadPROVINCIA.Index, tvScadPARTITAIVA.Index];
  // Inizializza la struttura che conterr le impostazioni delle colonne da ripristinare alla fine
  SetLength(ColSave, 0);
  // Ora cicla per tutte le colonne della TableView...
  // In questo ciclo rende invisibili tutte le colonne che non devono essere stampate
  for I := 0 to tvScad.ColumnCount - 1 do
  begin
    // Prima di tutto salva alcune propriet della colonna nell'apposita struttura per poter poi ripristinare il tutto
    SetLength(ColSave, I + 1);
    ColSave[I].Visible := tvScad.Columns[I].Visible;
    ColSave[I].VisibleIndex := tvScad.Columns[I].VisibleIndex;
    ColSave[I].Tag := tvScad.Columns[I].Tag;
    // Metto la propeiet Tag := 0 perch altrimenti alcune colonne che voglio vengano stampate in questa stampa
    // verebbero rese invisibili dalla procedura di preparazione delle View per la stampa in quanto
    // la sua propriet Tag = -1;
    // tvScad.Columns[i].Tag := 0;
    // Poi se la colonna attuale non  tra quelle che devono rimanere visibili le rende invisibili
    // tvScad.Columns[i].Visible := (i in ColToPrint);
    if (I in ColToPrint) then
      tvScad.Columns[I].Tag := 0
    else
      tvScad.Columns[I].Tag := -1;
  end;
  // Ora che sono visibili solo le colonne che mi interessano le metto nell'ordine che voglio
  // tvScadDATASCADENZA.VisibleIndex     := 0;
  // tvScadDARE.VisibleIndex             := 1;
  // tvScadDOCUMENTO.VisibleIndex        := 2;
  // tvScadBANCA.VisibleIndex            := 3;
  // tvScadABI.VisibleIndex              := 4;
  // tvScadCAB.VisibleIndex              := 5;
  // tvScadRAGIONESOCIALE.VisibleIndex   := 6;
  // tvScadINDIRIZZO.VisibleIndex        := 7;
  // tvScadCAP.VisibleIndex              := 8;
  // tvScadCITTA.VisibleIndex            := 9;
  // tvScadPROVINCIA.VisibleIndex        := 10;

  try
    // Anteprima
    if MenuStampe.Tag = 0 then
    begin
      dxPrinter.Preview(True, GridScadLink);
      // Stampa
    end
    else if MenuStampe.Tag = 1 then
    begin
      dxPrinter.Print(True, nil, GridScadLink);
      // Visualizza un messaggio che richiede conferma per marcare le Scadenze appena stampate come Presentate
      Result := DM1.Messaggi('Presentazione RI.BA. per l''incasso',
        'Le scadenze (RIBA) appena stampate verranno marcate come ''gi presentate per l''incasso''.'#13#13#13'Continuare con l''operazione?',
        'NB: Se la stampa non  terminata correttamente cliccare su ''NO'' e ripetere la stampa', [mbYes, mbNo], 0, nil);
      if Result = mrYes then
        MarcaScadenzeComePresentate;
    end;

  finally
    // Ripristina il fotn precedente
    DM1.PrintGridHeader.Font.Size := PrecFontSize;
    DM1.PrintContentEven.Font.Size := PrecFontSize;
    DM1.PrintContentOdd.Font.Size := PrecFontSize;
    // Cicla per tutte le colonne per ripristinare le propriet
    for I := 0 to tvScad.ColumnCount - 1 do
    begin
      tvScad.Columns[I].Visible := ColSave[I].Visible;
      // tvScad.Columns[i].VisibleIndex  := ColSave[i].VisibleIndex;
      tvScad.Columns[I].Tag := ColSave[I].Tag;
    end;
    GridScadLink.ReportTitle.Text := PrecTitle;
  end;
end;

procedure TClientiForm.MarcaScadenzeComePresentate;
var
  Qry: TIB_Cursor;
begin
  Qry := TIB_Cursor.Create(Self);
  DM1.ShowWait('PRESENTAZIONE RI.BA.', 'Marcatura delle RI.BA. presentate');
  // Apre la transazione
  DM1.DBAzienda.StartTransaction;
  try
    try
      Qry.DatabaseName := DM1.ArcDBFile;
      Qry.IB_Connection := DM1.DBAzienda;
      QryScad.First;
      while not QryScad.Eof do
      begin
        // Si assicura che la scadenza corrente sia una RIBA e non sia gi stata presentata
        if (QryScadRICEVUTABANCARIA.AsString = 'T') and (QryScadPRESENTATA.AsString <> 'P') then
        begin
          DM1.ShowWait('PRESENTAZIONE RI.BA.', 'Marcatura ' + QryScadTIPO.AsString + ' N ' + QryScadCODICE.AsString + ' del ' + QryScadDATASCADENZA.AsString);
          Qry.SQL.Clear;
          Qry.SQL.Add('UPDATE SCADENZ SET PRESENTATA = ''P'' WHERE');
          Qry.SQL.Add('TIPO = ''' + QryScadTIPO.AsString + '''');
          Qry.SQL.Add('AND CODICE = ' + QryScadCODICE.AsString);
          Qry.SQL.Add('AND DATASCADENZA = ''' + FormatDateTime('mm/dd/yyyy', QryScadDATASCADENZA.Value) + '''');
          Qry.ExecSQL;
        end;
        QryScad.Next;
      end;
      // COmmit.
      DM1.DBAzienda.Commit;
    finally
      DM1.CloseWait;
      Qry.Free;
    end;
  except
    // Rollback
    DM1.DBAzienda.Rollback;
  end;
end;

procedure TClientiForm.MarcaScadenzeSelezionateComePresentate(Banca: String = '');
var
  Qry: TIB_Cursor;
  SelRec, I: Integer;
begin
  I := 0;
  // SelRec contiene il numero dei records selezionati sulla griglia
  SelRec := tvScad.Controller.SelectedRecordCount;
  // Crea la query
  Qry := TIB_Cursor.Create(Self);
  DM1.ShowWait('PRESENTAZIONE RI.BA.', 'Marcatura delle RI.BA. presentate');
  // Apre la transazione
  DM1.DBAzienda.StartTransaction;
  try
    try
      Qry.DatabaseName := DM1.ArcDBFile;
      Qry.IB_Connection := DM1.DBAzienda;
      // Cicla per tutte le scadenze selezionate
      for I := 0 to SelRec - 1 do
      begin
        // Si posiziona sulla scadenza selezionata attuale
        tvScad.Controller.SelectedRecords[I].Focused := True;
        // Si assicura che la scadenza corrente sia una RIBA e non sia gi stata presentata
        // Si assicura anche che sia una scadenza attiva e che abbia un importo <> 0
        if (QryScadRICEVUTABANCARIA.AsString = 'T') and (QryScadPRESENTATA.AsString <> 'P') and (QryScadTIPO.AsString = 'Scad.attiv') and
          (QryScadDARE.AsFloat > 0) then
        begin
          DM1.ShowWait('PRESENTAZIONE RI.BA.', 'Marcatura ' + QryScadTIPO.AsString + ' N ' + QryScadCODICE.AsString + ' del ' + QryScadDATASCADENZA.AsString);
          Qry.SQL.Clear;
          Qry.SQL.Add('UPDATE SCADENZ SET');
          Qry.SQL.Add(' PRESENTATA = ''P''');
          if Banca <> '' then
            Qry.SQL.Add(',PRESENTATABANCA = ' + QuotedStr(Banca));
          Qry.SQL.Add('WHERE');
          Qry.SQL.Add('TIPO = ''' + QryScadTIPO.AsString + '''');
          Qry.SQL.Add('AND CODICE = ' + QryScadCODICE.AsString);
          Qry.SQL.Add('AND DATASCADENZA = ''' + FormatDateTime('mm/dd/yyyy', QryScadDATASCADENZA.Value) + '''');
          Qry.ExecSQL;
        end;
      end;
      // COmmit.
      DM1.DBAzienda.Commit;
    finally
      DM1.CloseWait;
      Qry.Free;
    end;
  except
    // Rollback
    DM1.DBAzienda.Rollback;
  end;
end;

procedure TClientiForm.ElencoArticoli1Click(Sender: TObject);
var
  PrecFontSize: Integer;
begin
  try
    // Prima di procedere rimpicciolisce il Fotn usato per le stampe
    PrecFontSize := DM1.PrintContentEven.Font.Size;
    DM1.PrintGridHeader.Font.Size := 6;
    DM1.PrintContentEven.Font.Size := 6;
    DM1.PrintContentOdd.Font.Size := 6;
    // Preview
    if MenuStampe.Tag = 0 then
    begin
      dxPrinter.Preview(True, GridArtLink);
      // Stampa
    end
    else if MenuStampe.Tag = 1 then
    begin
      dxPrinter.Print(True, nil, GridArtLink);
    end;
  finally
    // Ripristina il fotn precedente
    DM1.PrintGridHeader.Font.Size := PrecFontSize;
    DM1.PrintContentEven.Font.Size := PrecFontSize;
    DM1.PrintContentOdd.Font.Size := PrecFontSize;
  end;
end;

procedure TClientiForm.QryArticoliCalcFields(DataSet: TDataSet);
begin
  // Calcola l'importo prezzo di acquisto (UltimoPrezzoDiAcquisto * Giacenza) per l'inventazio ultimo costo
  // NB: Faccio un doppio arrotondamento (arrotondo anche il prezzo unitario) perch altrimenti si potevano creare della dicrepanze
  // tra valore unitario e importo a causa degli arrotondamenti (segnalato da COPA).
  QryArticoliIMPORTOULTIMOCOSTOREALE.Value := DM1.Arrotonda(DM1.Arrotonda(QryArticoliULTIMOCOSTOREALE.AsFloat, DM1.DecMicroPrz) * QryArticoliGIACENZA.AsFloat,
    DM1.DecMicroPrz);
  // Calcola la qt disponibile in magazzino
  QryArticoliDISPONIBILE.Value := DM1.CalcolaDisponibile(QryArticoliGIACENZA.AsFloat, QryArticoliIMPEGNATO.AsFloat, QryArticoliORDINATO.AsFloat);
end;

procedure TClientiForm.InventarioUltimoCosto1Click(Sender: TObject);
type
  TColSave = record
    Visible: Boolean;
    VisibleIndex: Byte;
    Tag: Integer;
  end;
var
  ColSave: array of TColSave;
  ColToPrint: set of Byte;
  I: Byte;
begin
  DM1.ShowWait('Stampa inventario', 'Operazione in corso...');
  try
    // Inserisce in ColToPrint gli Index delle colonne che dovranno essere stampate e quindi visibili
    ColToPrint := [tvArtCODICEARTICOLO.Index, tvArtDESCRIZIONE.Index, tvArtULTIMOCOSTOREALE.Index, tvArtUNITADIMISURA.Index, tvArtGIACENZA.Index,
      tvArtIMPORTOULTIMOCOSTOREALE.Index, tvArtULTIMOCOSTODOC.Index];
    // Inizializza la struttura che conterr le impostazioni delle colonne da ripristinare alla fine
    SetLength(ColSave, 0);
    // Ora cicla per tutte le colonne della TableView...
    // In questo ciclo rende invisibili tutte le colonne che non devono essere stampate
    for I := 0 to tvArt.ColumnCount - 1 do
    begin
      // Prima di tutto salva alcune propriet della colonna nell'apposita struttura per poter poi ripristinare il tutto
      SetLength(ColSave, I + 1);
      ColSave[I].Visible := tvArt.Columns[I].Visible;
      ColSave[I].VisibleIndex := tvArt.Columns[I].VisibleIndex;
      ColSave[I].Tag := tvArt.Columns[I].Tag;
      // Metto la propeiet Tag := 0 perch altrimenti alcune colonne che voglio vengano stampate in questa stampa
      // verebbero rese invisibili dalla procedura di preparazione delle View per la stampa in quanto
      // la sua propriet Tag = -1;
      tvArt.Columns[I].Tag := 0;
      // Poi se la colonna attuale non  tra quelle che devono rimanere visibili le rende invisibili
      tvArt.Columns[I].Visible := (I in ColToPrint);
    end;
    // Ora che sono visibili solo le colonne che mi interessano le metto nell'ordine che voglio
    // tvArtCODICEARTICOLO.VisibleIndex           := 0;
    // tvArtDESCRIZIONE.VisibleIndex              := 1;
    // tvArtULTIMOCOSTOREALE.VisibleIndex         := 2;
    // tvArtUNITADIMISURA.VisibleIndex            := 3;
    // tvArtGIACENZA.VisibleIndex                 := 4;
    // tvArtIMPORTOULTIMOCOSTOREALE.VisibleIndex  := 5;
    try

      // Stampa
      // --------------------------------------------------------
      // Anteprima
      if MenuStampe.Tag = 0 then
      begin
        dxPrinter.Preview(True, GridArtInventarioUltimoCostoLink);
        // Stampa
      end
      else if MenuStampe.Tag = 1 then
      begin
        dxPrinter.Print(True, nil, GridArtInventarioUltimoCostoLink);
      end;

    finally
      // Cicla per tutte le colonne per ripristinare le propriet
      for I := 0 to tvArt.ColumnCount - 1 do
      begin
        tvArt.Columns[I].Visible := ColSave[I].Visible;
        // tvArt.Columns[i].VisibleIndex  := ColSave[i].VisibleIndex;
        tvArt.Columns[I].Tag := ColSave[I].Tag;
      end;
    end;
  finally
    DM1.CloseWait;
  end;
end;

procedure TClientiForm.MIArticoloClick(Sender: TObject);
begin
  DM1.Attendere;
  try
    Application.CreateForm(TAnagArtForm, AnagArtForm);
    // La riga sottostante  stata sostituita con la successiva per risolvere l'errore
    // che dava il programma quando girava su Win95/98/ME (Questo programma ha eseguito una operazione non valida...)
    // Il problema lo dava solo quando assegnavo la propriet Parent della form AnagArtForm.
    // con le altre form andava bene.
    // AnagArtForm.Parent := MainForm;
    MainForm.FormSetParentPlatformDependent(AnagArtForm, MainForm);
    AnagArtForm.DistintaBase := False;
    AnagArtForm.Tag := 2;
    AnagArtForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.MIArticoloCompostoClick(Sender: TObject);
begin
  DM1.Attendere;
  try
    Application.CreateForm(TAnagArtForm, AnagArtForm);
    // La riga sottostante  stata sostituita con la successiva per risolvere l'errore
    // che dava il programma quando girava su Win95/98/ME (Questo programma ha eseguito una operazione non valida...)
    // Il problema lo dava solo quando assegnavo la propriet Parent della form AnagArtForm.
    // con le altre form andava bene.
    // AnagArtForm.Parent := MainForm;
    MainForm.FormSetParentPlatformDependent(AnagArtForm, MainForm);
    AnagArtForm.DistintaBase := True;
    AnagArtForm.Tag := 2;
    AnagArtForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.MISoggettoClick(Sender: TObject);
begin
  DM1.Attendere;
  try
    Application.CreateForm(TAnagCliForm, AnagCliForm);
    AnagCliForm.Parent := MainForm;
    AnagCliForm.Tag := 2;
    AnagCliForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.MIPraticaClick(Sender: TObject);
begin
  DM1.Attendere;
  try
    Application.CreateForm(TPraticaForm, PraticaForm);
    PraticaForm.Mode := MODE_PRATICHE;
    PraticaForm.Parent := MainForm;
    PraticaForm.CodiceCliente := '0';
    if ClienteCorrente <> '' then
      PraticaForm.CodiceCliente := ClienteCorrente;
    PraticaForm.Tag := 2;
    PraticaForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.GoToNuovoDocFisc(TipoDoc: String; ShowWaitForm: Boolean = True);
var
  LO: TMemIniFile;
begin
  // DM1.Attendere;
  if ShowWaitForm then
    DM1.ShowWait('Levante', 'Operazione in corso...');
  LO := TMemIniFile.Create(DM1.Repository_Layouts.FullLocalFileName);
  try
    // In caso di pratica selezionata crea il nuovo documento con Soggetto e Pratica
    // gi assegnata (quelli attualmente selezionati per l'appunto)
    // NB: In questo caso per se si st creando un documento di acquisto evita di caricare il soggetto
    // intestatario del cantiere selezionato (che normalmente  un cliente) come mittente del documento
    // di acquisto (che invece normalmente  un fornitore e quindi non centra nulla).
    if (PraticaCorrente <> '') then
    begin
      if (LO.ReadBool(TipoDoc, 'NonAssegnareSoggettoDaPraticaSelezionata', DM1.IsDocumentoDiIngresso(TipoDoc))) then
        DM1.NuovoDocFisc(TipoDoc, '', 0, StrToInt(PraticaCorrente), DataPraticaCorrente, 1, 0, False, False)
      else
        DM1.NuovoDocFisc(TipoDoc, '', StrToInt(ClienteCorrente), StrToInt(PraticaCorrente), DataPraticaCorrente, 1, 0, False, False);
      // Se invece non c' una pratica selezionata verifica come  impostato il flag che indica se
      //  abilitata la creazione di un nuovo documento solo con una pratica selezionata.
    end
    else if LO.ReadBool(TipoDoc, 'NuovoDocSoloConPraticaSelezionata', False) then
    begin
      // Nel caso appunto il flag indichi che  consenito l'emissione di un nuovo documento
      // solo se c' una pratica selezionata visualizza un avvertimenti e non prosegue.
      DM1.Messaggi('Nuovo documento', 'Prima  necessario selezionare una Pratica/Cantiere', '', [mbOk], 0, nil);
      // Se invece l'emissione di un nuovo documento  ammessa anche senza aver preventivamente
      // seleionato una pratica verifica se attualmente  selezionato almeno un soggetto
    end
    else if (ClienteCorrente <> '') then
      DM1.NuovoDocFisc(TipoDoc, '', StrToInt(ClienteCorrente), 0, '', 1, 0, False, False)
      // Se invece non c' nemmeno un soggetto selezionato verifica come  impostato il flag che indica se
      //  abilitata la creazione di un nuovo documento solo con un soggetto selezionato
    else if LO.ReadBool(TipoDoc, 'NuovoDocSoloConClienteSelezionato', False) then
    begin
      // Nel caso appunto il flag indichi che  consenito l'emissione di un nuovo documento
      // solo se c' un soggetto selezionato visualizza un avvertimenti e non prosegue.
      DM1.Messaggi('Nuovo documento', 'Prima  necessario selezionare una Soggetto', '', [mbOk], 0, nil);
      // Nel caso invece non ci sia selezionato ne un soggetto ne una pratica e questo  permesso dai flag
      // sopra citati, prosegue con la creazione del  nuovo documento senza questi dati.
    end
    else
      DM1.NuovoDocFisc(TipoDoc, '', 0, 0, '', 1, 0, False, False);
  finally
    LO.Free;
    // DM1.ChiudiAttendere;
    if ShowWaitForm then
      DM1.CloseWait;
  end;
end;

procedure TClientiForm.MIBuonoConsegnaClick(Sender: TObject);
begin
  GoToNuovoDocFisc('Buono_cons');
end;

procedure TClientiForm.MIDDTClick(Sender: TObject);
begin
  GoToNuovoDocFisc('D.D.T.');
end;

procedure TClientiForm.MIFatturaClick(Sender: TObject);
begin
  GoToNuovoDocFisc('Fattura');
end;

procedure TClientiForm.MIFatturaRicevutaFiscaleClick(Sender: TObject);
begin
  GoToNuovoDocFisc('Fatt.R.F.');
end;

procedure TClientiForm.MINotaCreditoClick(Sender: TObject);
begin
  GoToNuovoDocFisc('Nota_accre');
end;

procedure TClientiForm.MIOrdineClick(Sender: TObject);
begin
  GoToNuovoDocFisc('Ordine');
end;

procedure TClientiForm.MIPreventivoClick(Sender: TObject);
begin
  GoToNuovoDocFisc('Preventivo');
end;

procedure TClientiForm.MIRicevutaFiscaleClick(Sender: TObject);
begin
  GoToNuovoDocFisc('Ricev.fisc');
end;

procedure TClientiForm.MISALClick(Sender: TObject);
begin
  GoToNuovoDocFisc('S.A.L.');
end;

procedure TClientiForm.MIBollaEntrataClick(Sender: TObject);
begin
  GoToNuovoDocFisc('Bolla_entr');
end;

procedure TClientiForm.MIFatturaAcquistoClick(Sender: TObject);
begin
  GoToNuovoDocFisc('Fatt.acqui');
end;

procedure TClientiForm.MIOrdineFornitoreClick(Sender: TObject);
begin
  GoToNuovoDocFisc('Ord.fornit');
end;

procedure TClientiForm.MIContattoDaFareClick(Sender: TObject);
begin
  DM1.Attendere;
  Application.CreateForm(TContattiForm, ContattiForm);
  ContattiForm.Parent := MainForm;
  ContattiForm.CodiceCliente := '0';
  ContattiForm.CodicePratica := PraticaCorrente;
  ContattiForm.DataPratica := DataPraticaCorrente;
  ContattiForm.TipoCont := 'Cont.fare';
  ContattiForm.Tag := 2;
  if ClienteCorrente <> '' then
  begin
    ContattiForm.CodiceCliente := ClienteCorrente;
  end;
  ContattiForm.Show;
  DM1.ChiudiAttendere;
end;

procedure TClientiForm.MIContattoFattoClick(Sender: TObject);
begin
  DM1.Attendere;
  Application.CreateForm(TContattiForm, ContattiForm);
  ContattiForm.Parent := MainForm;
  ContattiForm.CodiceCliente := '0';
  ContattiForm.CodicePratica := PraticaCorrente;
  ContattiForm.DataPratica := DataPraticaCorrente;
  ContattiForm.TipoCont := 'Cont.fatto';
  ContattiForm.Tag := 2;
  if ClienteCorrente <> '' then
  begin
    ContattiForm.CodiceCliente := ClienteCorrente;
  end;
  ContattiForm.Show;
  DM1.ChiudiAttendere;
end;

procedure TClientiForm.MIConformitaClick(Sender: TObject);
begin
  DM1.Attendere;
  if ClienteCorrente <> '' then
  begin
    Application.CreateForm(TConformWizardForm, ConformWizardForm);
    ConformWizardForm.Parent := MainForm;
    ConformWizardForm.Show;
  end
  else
  begin
    MessageBeep(0);
    MessageDlg('Prima  necessario selezionare un cliente o un fornitore !', mtInformation, [mbOk], 0);
  end;
  DM1.ChiudiAttendere;
end;

procedure TClientiForm.MIFileEsternoClick(Sender: TObject);
begin
  DM1.Attendere;
  try
    Application.CreateForm(TExtFileForm, ExtFileForm);
    ExtFileForm.Parent := MainForm;
    ExtFileForm.CodiceCliente := '0';
    ExtFileForm.CodicePratica := PraticaCorrente;
    ExtFileForm.DataPratica := DataPraticaCorrente;
    ExtFileForm.CodiceExtPrg := (Sender as TMenuItem).Tag;
    ExtFileForm.Tag := 2;
    if ClienteCorrente <> '' then
    begin
      ExtFileForm.CodiceCliente := ClienteCorrente;
    end;
    ExtFileForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.MILetteraClick(Sender: TObject);
begin
  DM1.Attendere;
  try
    Application.CreateForm(TTestiForm, TestiForm);
    TestiForm.Parent := MainForm;
    TestiForm.CodiceCliente := '0';
    TestiForm.CodicePratica := PraticaCorrente;
    TestiForm.DataPratica := DataPraticaCorrente;
    TestiForm.Tag := 2;
    if ClienteCorrente <> '' then
    begin
      TestiForm.CodiceCliente := ClienteCorrente;
    end;
    TestiForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.MIScadenzaAttivaClick(Sender: TObject);
begin
  DM1.Attendere;
  try
    Application.CreateForm(TScadenzeForm, ScadenzeForm);
    ScadenzeForm.Parent := MainForm;
    ScadenzeForm.CodiceCliente := '0';
    if ClienteCorrente <> '' then
    begin
      ScadenzeForm.CodiceCliente := ClienteCorrente;
    end;
    ScadenzeForm.CodicePratica := PraticaCorrente;
    ScadenzeForm.DataPratica := DataPraticaCorrente;
    ScadenzeForm.TipoScadenza := 'Scad.attiv';
    ScadenzeForm.Tag := 2;
    ScadenzeForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.MIScadenzaPassivaClick(Sender: TObject);
begin
  DM1.Attendere;
  try
    Application.CreateForm(TScadenzeForm, ScadenzeForm);
    ScadenzeForm.Parent := MainForm;
    ScadenzeForm.CodiceCliente := '0';
    if ClienteCorrente <> '' then
    begin
      ScadenzeForm.CodiceCliente := ClienteCorrente;
    end;
    ScadenzeForm.CodicePratica := PraticaCorrente;
    ScadenzeForm.DataPratica := DataPraticaCorrente;
    ScadenzeForm.TipoScadenza := 'Scad.passi';
    ScadenzeForm.Tag := 2;
    ScadenzeForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.MICondVendGruppoClick(Sender: TObject);
begin
  DM1.Attendere;

  Application.CreateForm(TCondVendForm, CondVendForm);
  CondVendForm.Parent := MainForm;
  // IMposta alcune variabili locali alla form
  CondVendForm.LocTipoCOndizione := 'Cond.Vend.';
  if ClienteCorrente <> '' then
    CondVendForm.LocCodiceSoggetto := StrToInt(ClienteCorrente)
  else
    CondVendForm.LocCodiceSoggetto := 0;
  CondVendForm.LocCodiceArticolo := '-1';
  CondVendForm.LocCodiceGruppo1 := -1;
  CondVendForm.LocCodiceGruppo2 := -1;
  CondVendForm.LocCodiceGruppo3 := -1;
  CondVendForm.Tag := 2; // Nuova condizione per gruppo
  CondVendForm.Show;

  DM1.ChiudiAttendere;
end;

procedure TClientiForm.MICondVendArticoloClick(Sender: TObject);
begin
  DM1.Attendere;

  Application.CreateForm(TCondVendForm, CondVendForm);
  CondVendForm.Parent := MainForm;
  // IMposta alcune variabili locali alla form
  CondVendForm.LocTipoCOndizione := 'Cond.Vend.';
  if ClienteCorrente <> '' then
    CondVendForm.LocCodiceSoggetto := StrToInt(ClienteCorrente)
  else
    CondVendForm.LocCodiceSoggetto := 0;
  CondVendForm.LocCodiceArticolo := '-1';
  CondVendForm.LocCodiceGruppo1 := -1;
  CondVendForm.LocCodiceGruppo2 := -1;
  CondVendForm.LocCodiceGruppo3 := -1;
  CondVendForm.Tag := 3; // Nuova condizione per articolo
  CondVendForm.Show;

  DM1.ChiudiAttendere;
end;

procedure TClientiForm.MICondAcqGruppoClick(Sender: TObject);
begin
  DM1.Attendere;

  Application.CreateForm(TCondVendForm, CondVendForm);
  CondVendForm.Parent := MainForm;
  // IMposta alcune variabili locali alla form
  CondVendForm.LocTipoCOndizione := 'Cond.Acqui';
  if ClienteCorrente <> '' then
    CondVendForm.LocCodiceSoggetto := StrToInt(ClienteCorrente)
  else
    CondVendForm.LocCodiceSoggetto := 0;
  CondVendForm.LocCodiceArticolo := '-1';
  CondVendForm.LocCodiceGruppo1 := -1;
  CondVendForm.LocCodiceGruppo2 := -1;
  CondVendForm.LocCodiceGruppo3 := -1;
  CondVendForm.Tag := 4; // Nuova condizione per gruppo
  CondVendForm.Show;

  DM1.ChiudiAttendere;
end;

procedure TClientiForm.MICondAcqArticoloClick(Sender: TObject);
begin
  DM1.Attendere;

  Application.CreateForm(TCondVendForm, CondVendForm);
  CondVendForm.Parent := MainForm;
  // IMposta alcune variabili locali alla form
  CondVendForm.LocTipoCOndizione := 'Cond.Acqui';
  if ClienteCorrente <> '' then
    CondVendForm.LocCodiceSoggetto := StrToInt(ClienteCorrente)
  else
    CondVendForm.LocCodiceSoggetto := 0;
  CondVendForm.LocCodiceArticolo := '-1';
  CondVendForm.LocCodiceGruppo1 := -1;
  CondVendForm.LocCodiceGruppo2 := -1;
  CondVendForm.LocCodiceGruppo3 := -1;
  CondVendForm.Tag := 5; // Nuova condizione per gruppo
  CondVendForm.Show;

  DM1.ChiudiAttendere;
end;

// Riempie il sottomen dei documenti esterni
procedure TClientiForm.CaricaSubMenuExtDoc;
var
  NewMenuItem: TMenuItem;
  Qry: TIB_Cursor;
begin
  Qry := TIB_Cursor.Create(Self);
  try
    // Imposta la query che ricaver i tipi di documenti esterni tra cui scegliere
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('SELECT CODICE, DESCRIZIONE FROM EXTPRG');
    Qry.Open;
    // Azzera tutto
    MIFileEsterno.Clear;
    // Se c' almeno un collegamento a file esterni inserisce la voce "Documento esterno senza file predefinito (vuoto)" e disabilita il gestore
    // di evento onClick dalla voce di menu principale.
    if Qry.Eof then
    begin
      MIFileEsterno.OnClick := MIFileEsternoClick;
    end
    else
    begin
      // Sgancia la MenuItem dei documenti esterni dal suo gestore di evento OnClick
      MIFileEsterno.OnClick := nil;
      // Crea la voce SubMenu per l'inserimento di un documento esterno vuoto
      NewMenuItem := TMenuItem.Create(Self);
      NewMenuItem.Tag := 0;
      NewMenuItem.Caption := 'VUOTO (Nessun file preimpostato)';
      NewMenuItem.OnClick := MIFileEsternoClick;
      MIFileEsterno.Add(NewMenuItem);
      // Aggiunge una separazione estetica
      NewMenuItem := TMenuItem.Create(Self);
      NewMenuItem.Caption := '-';
      MIFileEsterno.Add(NewMenuItem);
    end;
    // Cicla per tutti i record trovati in modo da
    // aggiungere le relative voci al sottomen
    while not Qry.Eof do
    begin
      // Crea la nuova MenItem
      NewMenuItem := TMenuItem.Create(Self);
      NewMenuItem.Tag := Qry.FieldByName('CODICE').AsInteger;
      NewMenuItem.Caption := Qry.FieldByName('DESCRIZIONE').AsString;
      NewMenuItem.OnClick := MIFileEsternoClick;
      MIFileEsterno.Add(NewMenuItem);
      // Avanti il prossimo
      Qry.Next;
    end;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.CaricaSubMenuAltreEsportazioniArticoli;
var
  NewMenuItem: TMenuItem;
  Qry: TIB_Cursor;
begin
  Qry := TIB_Cursor.Create(Self);
  try
    // Sgancia la MenuItem dei documenti esterni dal suo gestore di evento OnClick
    Altreesportazioniarticolilistini1.OnClick := nil;
    // Imposta la query che ricaver l'elenco dei listini da esportare disponibili
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('SELECT CODICEDISTRIBUTORE, CODICEFILIALE, TIPO, ULTIMAVERSIONESCARICATA FROM LISTINIRICEVUTI');
    Qry.Open;
    // Azzera tutto
    Altreesportazioniarticolilistini1.Clear;
    // Cicla per tutti i record trovati in modo da
    // aggiungere le relative voci al sottomen
    while not Qry.Eof do
    begin
      // Crea la nuova MenItem
      NewMenuItem := TMenuItem.Create(Self);
      NewMenuItem.Caption := 'File ' + Qry.FieldByName('TIPO').AsString + ' di ' + Qry.FieldByName('CODICEDISTRIBUTORE').AsString + ' filiale ' +
        Qry.FieldByName('CODICEFILIALE').AsString + ' del ' + FormatDateTime('dd/mm/yyyy', Qry.FieldByName('ULTIMAVERSIONESCARICATA').AsDateTime) + ' ore ' +
        FormatDateTime('hh:nn', Qry.FieldByName('ULTIMAVERSIONESCARICATA').AsDateTime);
      NewMenuItem.OnClick := Altreesportazioniarticolilistini1Click;
      Altreesportazioniarticolilistini1.Add(NewMenuItem);
      // Avanti il prossimo
      Qry.Next;
    end;
    Qry.Close;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.MenuDocumentiPopup(Sender: TObject);
var
  NewMenuItem: TMenuItem;
  Qry: TIB_Cursor;
begin
  // In base ai permessi rende visibili o meno le varie voci
  MIPreventivo.Visible := (DM1.ModCtrl(MOD_PREVENTIVI) > 1);
  MIOrdine.Visible := (DM1.ModCtrl(MOD_ORDINI) > 1);
  MISAL.Visible := (DM1.ModCtrl(MOD_SAL) > 1);
  MIBuonoConsegna.Visible := (DM1.ModCtrl(MOD_BUONO_CONSEGNA) > 1);
  MIDDT.Visible := (DM1.ModCtrl(MOD_DDT) > 1);
  MIFattura.Visible := (DM1.ModCtrl(MOD_FATTURE) > 1);
  MINotaCredito.Visible := (DM1.ModCtrl(MOD_NOTE_ACCREDITO) > 1);
  MIOrdineFornitore.Visible := (DM1.ModCtrl(MOD_ORDINI_FORNITORI) > 1);
  MIBollaEntrata.Visible := (DM1.ModCtrl(MOD_BOLLE_ENTRATA) > 1);
  MIFatturaAcquisto.Visible := (DM1.ModCtrl(MOD_FATTURE_ACQUISTO) > 1);
  MIRicevutaFiscale.Visible := (DM1.ModCtrl(MOD_RICEVUTE_FISCALI) > 1);
  MIFatturaRicevutaFiscale.Visible := (DM1.ModCtrl(MOD_FATTURE_RF) > 1);
  MILettera.Visible := (DM1.ModCtrl(MOD_TESTI) > 1);
  MIContattoDaFare.Visible := (DM1.ModCtrl(MOD_CONTATTI) > 1) and False; // Cos  sempre disabilitato
  MIContattoFatto.Visible := (DM1.ModCtrl(MOD_CONTATTI) > 1) and False; // Cos  sempre disabilitato
  MIFileEsterno.Visible := (DM1.ModCtrl(MOD_EXT_FILE) > 1);
  MIConformita.Visible := (DM1.ModCtrl(MOD_CONFORMITA) > 1);
  MITracciato.Visible := (DM1.ModCtrl(MOD_CEFALOMETRIE) > 1) and False; // Cos  sempre disabilitato;
  Rapportogiornaliero1.Visible := (DM1.ModCtrl(MOD_GIORNALE_CANTIERE) > 1);
  Commessa1.Visible := (DM1.ModCtrl(MOD_PRATICHE) > 1);
  Caricocantiere1.Visible := (DM1.ModCtrl(MOD_PRATICHE) > 1);
  Scaricocantiere1.Visible := (DM1.ModCtrl(MOD_PRATICHE) > 1);
  Estrattoconto1.Visible := (DM1.ModCtrl(MOD_PRATICHE) > 1);
  Intervento1.Visible := (DM1.ModCtrl(MOD_CONTATTI) > 1) and (DM1.VisualizzaNuovoAppuntamentoAssistenza);
  // Carica il submen dei documenti esterni
  CaricaSubMenuExtDoc;
  // Richiama il gestore di default dell'evento
  PopupMenuPopupGestoreDefault(Sender);
end;

procedure TClientiForm.MenuScadenzarioPopup(Sender: TObject);
begin
  // IN base ai permessi rende visibili o meno le varie voci
  MIScadenzaAttiva.Visible := (DM1.ModCtrl(MOD_SCADENZARIO) > 1);
  MIScadenzaPassiva.Visible := (DM1.ModCtrl(MOD_SCADENZARIO_PASSIVO) > 1);
  // Richiama il gestore di default dell'evento
  PopupMenuPopupGestoreDefault(Sender);
end;

procedure TClientiForm.MenuCondVendPopup(Sender: TObject);
begin
  MICondVendGruppo.Visible := (DM1.ModCtrl(MOD_CONDIZIONI_VENDITA) > 1);
  MICondVendArticolo.Visible := (DM1.ModCtrl(MOD_CONDIZIONI_VENDITA) > 1);
  MICondAcqGruppo.Visible := (DM1.ModCtrl(MOD_CONDIZIONI_VENDITA) > 1);
  MICondAcqArticolo.Visible := (DM1.ModCtrl(MOD_CONDIZIONI_VENDITA) > 1);
  // Richiama il gestore di default dell'evento
  PopupMenuPopupGestoreDefault(Sender);
end;

procedure TClientiForm.MenuSoggettiPopup(Sender: TObject);
begin
  // In base ai permessi rende visibili o meno le voci relative
  MISoggetto.Visible := (DM1.ModCtrl(MOD_CLIENTI) > 1);
  // Richiama il gestore di default dell'evento
  PopupMenuPopupGestoreDefault(Sender);
end;

procedure TClientiForm.MenuArticoliPopup(Sender: TObject);
begin
  // In base ai permessi visualizza o meno le voci
  MIArticolo.Visible := (DM1.ModCtrl(MOD_ARTICOLI) > 1);
  MIArticoloComposto.Visible := (DM1.ModCtrl(MOD_ARTICOLI) > 1);
  // Richiama il gestore di default dell'evento
  PopupMenuPopupGestoreDefault(Sender);
end;

procedure TClientiForm.MenuPratichePopup(Sender: TObject);
begin
  // In base ai permessi rende o meno visibili
  MIPratica.Visible := (DM1.ModCtrl(MOD_PRATICHE) > 1);
  // Richiama il gestore di default dell'evento
  PopupMenuPopupGestoreDefault(Sender);
end;

procedure TClientiForm.PopupMenuPopupGestoreDefault(Sender: TObject);
var
  VisibleItem, I: Byte;
  M: TPopupMenu;
begin
  // M punta al men attuale
  if Assigned(Sender) and (Sender is TPopupMenu) then
    M := Sender as TPopupMenu;
  // Cicla per tutte le voci del men per contare quante di esse sono visibili
  VisibleItem := 0;
  for I := 0 to M.Items.Count - 1 do
    if M.Items[I].Visible then
      Inc(VisibleItem, 1);
  // Se le voci visibili sono 1 sola, richiama automaticamente il gestore di evento OnClick e rende
  // invisibile pure quella in modo che il men non appaia per niente
  if VisibleItem = 1 then
  begin
    // Cicla finch non trova l'unica voce visibile
    VisibleItem := 0;
    while not M.Items[VisibleItem].Visible do
      Inc(VisibleItem, 1); // All'uscita VisibleCount contiene l'indice della prima voce visibile
    M.Items[VisibleItem].Visible := False;
    M.Items[VisibleItem].OnClick(M.Items[VisibleItem]);
  end;
end;

procedure TClientiForm.TabDocumentiDragOver(Sender, Source: TObject; X, Y: Integer; State: TDragState; var Accept: Boolean);
begin
  Accept := True;
end;

procedure TClientiForm.TipoCondizioneClickCheck(Sender: TObject);
begin
  // Se passa di qu significa che l'utente ha cliccato esattamente nel riquadrino del check della voce
  // e quindi marca la propriet Tag del componente in modo che poi il gestore dell'evento OnMouseUp che gestisce
  // i click per la selezione o meno della voce (per fare in modo che anche cliccando sulla descrizione della voce
  // si selezioni o deselezioni la voce stessa). In questo modo tale gestore di evento salta la riga che
  // assegna il valore alla propriet checked[i] altrimenti  come se l'utente avesse cliccato due volte.
  (Sender as TCheckListBox).Tag := 1;
end;

procedure TClientiForm.Stampaetichetteclienti1Click(Sender: TObject);
var
  Qry: TIB_Cursor;
begin
  DM1.Attendere;
  try
    // Svuota la tabella delle etichette
    DM2.SvuotaTabellaEtichette(IDX_ETICHETTA_SOGGETTO);
    // -----------------------------------------------------------------------------------------------------------------------------------
    // Crea la query e cicla per aggiungere a questa tutti gli articoli che servono
    Qry := TIB_Cursor.Create(Self);
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('INSERT INTO LABSOGG (CODICESTAZIONE,PROGRIGO,Codice,RagioneSociale,Indirizzo,NumCivico,Citta,CAP,Provincia)');
    Qry.SQL.Add('SELECT ');
    Qry.SQL.Add(QuotedStr(DM1.CodiceUtente) + ',');
    Qry.SQL.Add('  (SELECT COALESCE(MAX(LS2.PROGRIGO),0)+1 FROM LABSOGG LS2 WHERE LS2.CODICESTAZIONE = ' + QuotedStr(DM1.CodiceUtente) + '),');
    Qry.SQL.Add('  C.Codice, C.RagioneSociale, C.Indirizzo, C.NumCivico, C.Citta, C.CAP, C.Provincia');
    Qry.SQL.Add('FROM CLIENTI C');
    // Inserisce la clausola WHERE prelevandola dalla query della rubrica
    DM1.CopySQLWhereCondition(QrySoggetti.SQL, Qry.SQL);
    // Esegue la query
    Qry.ExecSQL;
    // -----------------------------------------------------------------------------------------------------------------------------------
    // Crea e avvia la form per la stampa delle etichette
    DM2.StampaEtichette(IDX_ETICHETTA_SOGGETTO);
  finally
    DM1.ChiudiAttendere;
    if Assigned(Qry) then
      Qry.Free;
  end;
end;

procedure TClientiForm.Stampaetichettearticoli1Click(Sender: TObject);
begin
  DM1.Attendere;
  try
    // Svuota la tabella delle etichette
    DM2.SvuotaTabellaEtichette(IDX_ETICHETTA_ARTICOLO);
    // Crea la query e cicla per aggiungere a questa tutti gli articoli che servono
    DM2.LoadTabellaEtichetteArticoli('', QryArticoli.SQL);
    // Crea e avvia la form per la stampa delle etichette
    DM2.StampaEtichette(IDX_ETICHETTA_ARTICOLO);
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.Notadicreditofornitore1Click(Sender: TObject);
begin
  GoToNuovoDocFisc('N.C.fornit');
end;

procedure TClientiForm.Notifica1giorno1Click(Sender: TObject);
begin
  RetroDataNotificaDemoFE((Sender as TMenuItem).Tag);
end;

procedure TClientiForm.Notificadiaccettazione1Click(Sender: TObject);
begin
  CreaNotificaDemoFE('rtSDIMessageRC', '', 'RC', 'Ricevuta di consegna (SDI)', '', False, 0);
end;

procedure TClientiForm.Notificadidecorrenzatermini1Click(Sender: TObject);
begin
  CreaNotificaDemoFE('rtSDIMessageDT', '', 'DT', 'Notifica decorrenza termini (SDI)', '', False, 0);
end;

procedure TClientiForm.Notificadimancataconsegna1Click(Sender: TObject);
begin
  CreaNotificaDemoFE('rtSDIMessageMC', '', 'MC', 'Notifica di mancata consegna (SDI)', '', False, 0);
end;

procedure TClientiForm.Notificadiscarto1Click(Sender: TObject);
var
  DocType, DocReg: String;
  DocNum: Integer;
  DocDate: TDate;
begin
  CreaNotificaDemoFE('rtSDIMessageNS', '', 'NS', 'Notifica di scarto (SDI)', '', False, 5);
end;

procedure TClientiForm.NotificaesitofatturaaccettataSDI1Click(Sender: TObject);
begin
  CreaNotificaDemoFE('rtSDIMessageNEAccepted', '', 'NE OK', 'Notifica esito fattura accettata (SDI)', '', False, 0);
end;

procedure TClientiForm.NotificaesitofatturarifiutataSDI1Click(Sender: TObject);
begin
  CreaNotificaDemoFE('rtSDIMessageNERejected', '', 'NE KO', 'Notifica esito fattura rifiutata (SDI)', '', False, 0);
end;

procedure TClientiForm.CompostiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
var
  CLB: TCheckListBox;
  CheckIndex, I: Integer;
begin
  // ----------------------------------------------------------------------------------------------------
  // Questo codice server per fare in modo che anche se l'utente clicca sul titolo della voce, questa
  // venga selezinata o deselezionata come se si fosse cliccato sul riquadrino del segno di check)
  // ----------------------------------------------------------------------------------------------------
  // CLB Punta alla CheckListBox
  CLB := Sender as TCheckListBox;
  // Quale voce si trova sotto il mouse?
  CheckIndex := CLB.ItemAtPos(Point(X, Y), True);
  // Se c'era una voce cambia il suo stato
  if CheckIndex <> -1 then
  begin
    // Azzera tutti i check tranne quello su cui si  cliccato
    // cos non se ne possono selezionare pi di uno alla volta
    // in pratica si comportano come dei RadioButton
    for I := 0 to CLB.Count - 1 do
    begin
      if I <> CheckIndex then
        CLB.Checked[I] := False;
    end;
    // Se la propiet Tag = 0 imposta il componente
    if CLB.Tag = 0 then
      CLB.Checked[CheckIndex] := not CLB.Checked[CheckIndex];
    // Rimette la Propriet Tag del componente = 0
    CLB.Tag := 0;
    // Solo se s cliccato con il pulsante SX del mouse
    if Button = mbRight then
    begin
      // Esegue la ricerca
      RxSpeedButtonTrovaClick(Self);
    end;
  end;
  // F in modo che non resti una voce selezionata e quindi evidenziata che non mi piace
  CLB.ItemIndex := -1;
  // ----------------------------------------------------------------------------------------------------
end;

procedure TClientiForm.tvArtGIACENZACustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo;
  var ADone: Boolean);
var
  GR: TcxCustomGridRecord;
begin
  Exit;
  // GR punta al record corrente
  GR := AViewInfo.GridRecord;

  // Se si tratta di un articolo composto visualizza dei trattini in quanto questo campo non ha senso per gli articoli composti
  if (not VarIsNull(AViewInfo.GridRecord.Values[tvArtARTICOLOCOMPOSTO.Index])) and (AViewInfo.GridRecord.Values[tvArtARTICOLOCOMPOSTO.Index] = 'T') then
  begin
    ADone := True;
    // Sfondo
    ACanvas.FillRect(AViewInfo.Bounds);
    // Visualizza il testo dell'intestazione
    ACanvas.Font.Style := ACanvas.Font.Style + [fsBold];
    ACanvas.DrawText('- - -', AViewInfo.TextAreaBounds, cxAlignHCenter or cxAlignVCenter);
  end;
end;

procedure TClientiForm.Sostituzionesottoarticolonegliarticoliselezionati1Click(Sender: TObject);
begin
  DM1.SostituisciArticolo(MODO_SELEZIONATI);
end;

procedure TClientiForm.Sostituzionesottoarticolointuttigliarticoli1Click(Sender: TObject);
begin
  DM1.SostituisciArticolo(MODO_TUTTI);
end;

procedure TClientiForm.MenuElencoClientiPopup(Sender: TObject);
var
  CurrGrid: TComponent;
  CurrMenuItem: TMenuItem;
  I: Integer;
  ListaViste: TStrings;
begin
//Fatturachiamateappuntamentiinterventiselezionati2


  // Rende visibili le voci per la sostituzione dei sottoarticoli solo se
  // si stanno visualizzando gli articoli
  // In base ai permessi rende visibili o meno le varie voci
  NotifichefatturaelettronicaDEMO1.Visible := (PageControl2.ActivePage = TabDocumenti) and MainForm.ModoDemo;
  Sostituzionesottoarticolonegliarticoliselezionati1.Visible := (DM1.ModCtrl(MOD_ARTICOLI) > 1) and (PageControl2.ActivePage = TabArticoli) and
    (not MainForm.IsLevanteLight);
  Sostituzionesottoarticolointuttigliarticoli1.Visible := (DM1.ModCtrl(MOD_ARTICOLI) > 1) and (PageControl2.ActivePage = TabArticoli) and
    (not MainForm.IsLevanteLight);
  Forzagiacenzaarticoliselezionati1.Visible := (DM1.ModCtrl(MOD_ARTICOLI) > 1) and (PageControl2.ActivePage = TabArticoli) and (not MainForm.IsLevanteLight);
  Apriildocumentorelativoallascadenza1.Visible := (DM1.ModCtrl(MOD_SCADENZARIO) > 1) and (DM1.ModCtrl(MOD_SCADENZARIO_PASSIVO) > 1) and
    (PageControl2.ActivePage = TabScadenze);
  Annullapresentazioneallincassodellescadenzaselezionate1.Visible := (DM1.ModCtrl(MOD_SCADENZARIO) > 1) and (DM1.ModCtrl(MOD_SCADENZARIO_PASSIVO) > 1) and
    (PageControl2.ActivePage = TabScadenze);
  PagamentoRiscossionecumulativoRIBAselezionate1.Visible := (DM1.ModCtrl(MOD_SCADENZARIO) > 1) and (DM1.ModCtrl(MOD_SCADENZARIO_PASSIVO) > 1) and
    (PageControl2.ActivePage = TabScadenze);
  CreafilepresentazioneRIBAallincasso1.Visible := (DM1.ModCtrl(MOD_SCADENZARIO) > 1) and (DM1.ModCtrl(MOD_SCADENZARIO_PASSIVO) > 1) and
    (PageControl2.ActivePage = TabScadenze);
  Cambiastatoallescadenzeselezionate1.Visible := (DM1.ModCtrl(MOD_SCADENZARIO) > 1) and (DM1.ModCtrl(MOD_SCADENZARIO_PASSIVO) > 1) and
    (PageControl2.ActivePage = TabScadenze);
  Cambiastatoalleregistrazionidiprimanotaselezionate1.Visible := (DM1.ModCtrl(MOD_PRIMANOTA) > 1) and (PageControl2.ActivePage = TabPrimanota);
  Cambiastatodocumentiselezionati1.Visible := (PageControl2.ActivePage = TabDocumenti) or (PageControl2.ActivePage = TabMagazzino) and
    (not MainForm.IsLevanteLight);
  MarcaidocumentiselezionaticomeNONesportati1.Visible := ((PageControl2.ActivePage = TabDocumenti) or (PageControl2.ActivePage = TabPrimanota)) and
    (not MainForm.IsLevanteLight);

  Eliminaappuntamentoecreadocumento2.Visible := (PageControl2.ActivePage = TabImpegni) and (not MainForm.IsLevanteLight);
  Fatturachiamateappuntamentiinterventiselezionati2.Visible := (PageControl2.ActivePage = TabImpegni) and (DM1.ModCtrl(MOD_AGENDA) > 1) and (not MainForm.IsLevanteLight);

  MarcacomeConsegnatiidocumentiselezionati1.Visible := (PageControl2.ActivePage = TabDocumenti) and (not MainForm.IsLevanteLight);
  Copiaidocumentiselezionatisullabacheca1.Visible := (PageControl2.ActivePage = TabDocumenti) and (not MainForm.IsLevanteLight);
  EsportinventarioultimocostoinformatoEXCEL1.Visible := (PageControl2.ActivePage = TabArticoli) and (not MainForm.IsLevanteLight);
  Variazionecostoorariomanodoperadeirighiselezionati1.Visible := (PageControl2.ActivePage = TabGOS) and (cxPageControlGOS.ActivePage = TabManodopera) and
    (cxPageControlGOSOre.ActivePage = TabGOSOreElenco) and (DM1.ModCtrl(MOD_GIORNALE_CANTIERE) > 1) and (not MainForm.IsLevanteLight);
  EsportadocumentoinformatoExcel1.Visible := (PageControl2.ActivePage = TabDocumenti);
  Esportadocumentoinformatotesto1.Visible := (PageControl2.ActivePage = TabDocumenti);
  Creanuovocantiereconglistessisottocantieri1.Visible := (PageControl2.ActivePage = TabPratiche) and (DM1.ModCtrl(MOD_PRATICHE) > 1);
  Duplicacantiere1.Visible := (PageControl2.ActivePage = TabPratiche) and (DM1.ModCtrl(MOD_PRATICHE) > 1);

  Cambiaregistroaidocumentiselezionati1.Visible := (PageControl2.ActivePage = TabDocumenti) and (not MainForm.IsLevanteLight);
  Cambiaregistroaidocumentiselezionati1.Enabled := not DM1.ModificaRegistroSoloNuovoDocumento;

  // Se siamo nell'elenco articoli carica i submen delle altre esportazioni
  // e li visualizza.
  Altreesportazioniarticolilistini1.Visible := (DM1.ModCtrl(MOD_ARTICOLI) > 1) and (PageControl2.ActivePage = TabArticoli);
  if Altreesportazioniarticolilistini1.Visible then
    CaricaSubMenuAltreEsportazioniArticoli;

  // ==========================================================================
  // Caricamento delle viste delle griglia attualmente visualizzata
  // --------------------------------------------------------------------------
  // In base alla pagina selezionata Elenco Viste punta alla griglia
  // corretta
  if PageControl2.ActivePage = TabClienti then
    CurrGrid := GridSogg
  else if PageControl2.ActivePage = TabArticoli then
    CurrGrid := GridArt
  else if (PageControl2.ActivePage = TabDocumenti) and (PageControlDoc.ActivePage = TabSheetDocGrid) then
    CurrGrid := GridDoc
  else if (PageControl2.ActivePage = TabDocumenti) and (PageControlDoc.ActivePage = TabSheetDocADA) then
    CurrGrid := PivotGridDoc
  else if (PageControl2.ActivePage = TabMagazzino) and (PageControlGM.ActivePage = TabGMGrid) then
    CurrGrid := GridGM
  else if (PageControl2.ActivePage = TabMagazzino) and (PageControlGM.ActivePage = TabGMADA) then
    CurrGrid := PivotGridGM
  else if PageControl2.ActivePage = TabCondVend then
    CurrGrid := GridCV
  else if PageControl2.ActivePage = TabPratiche then
    CurrGrid := GridPrat
  else if (PageControl2.ActivePage = TabScadenze) and (PageControlScad.ActivePage = TabScadElenco) then
    CurrGrid := GridScad
  else if (PageControl2.ActivePage = TabScadenze) and (PageControlScad.ActivePage = TabScadADA) then
    CurrGrid := PivotGridScad
  else if PageControl2.ActivePage = TabImpegni then
    CurrGrid := GridImpegni
  else if PageControl2.ActivePage = TabPrimanota then
    CurrGrid := GridPrimanota
  else if (PageControl2.ActivePage = TabGOS) and (cxPageControlGOS.ActivePage = TabManodopera) and (cxPageControlGOSOre.ActivePage = TabGOSOreElenco) then
    CurrGrid := GridOre
  else if (PageControl2.ActivePage = TabGOS) and (cxPageControlGOS.ActivePage = TabManodopera) and (cxPageControlGOSOre.ActivePage = TabGosOreAda) then
    CurrGrid := GosOrePivot
  else if (PageControl2.ActivePage = TabGOS) and (cxPageControlGOS.ActivePage = TabSpese) and (cxPageControlGOSSpese.ActivePage = TabGOSSpeseElenco) then
    CurrGrid := GridSpese
  else if (PageControl2.ActivePage = TabGOS) and (cxPageControlGOS.ActivePage = TabSpese) and (cxPageControlGOSSpese.ActivePage = TabGosSpeseAda) then
    CurrGrid := GosSpesePivot
  else if (PageControl2.ActivePage = TabAgenda) then
    CurrGrid := Agenda
  else
  begin
    // Rende invisibili le voci corrispondenti alle viste
    Selezionavista1.Visible := False;
    Salvaimpostazionicolonne1.Visible := False;
    Ripristinacolonneeliminate1.Visible := False;
  end;
  // Rende visibili le voci corrispondenti alle viste
  Selezionavista1.Visible := (not MainForm.IsLevanteLight);
  Salvaimpostazionicolonne1.Visible := (not MainForm.IsLevanteLight);
  Ripristinacolonneeliminate1.Visible := (not MainForm.IsLevanteLight);
  // Carica l'elenco delle viste disponibili per questa griglia
  // in una StringList
  ListaViste := TStringList.Create;
  try
    DM1.ListaVisteGriglia(CurrGrid.Name, ListaViste);
    // Svuota l'elenco delle viste
    Selezionavista1.Clear;
    // Aggiunge la voce di selezione di nessuna vista
    CurrMenuItem := TMenuItem.Create(Self);
    CurrMenuItem.Caption := 'NESSUNA  (Avr effetto al prossimo riavvio di Levante)';
    CurrMenuItem.Name := 'NessunaVista';
    CurrMenuItem.OnClick := Selezionavista1Click;
    Selezionavista1.Add(CurrMenuItem);
    // Aggiunge le altre eventuali viste presenti
    for I := 0 to ListaViste.Count - 1 do
    begin
      CurrMenuItem := TMenuItem.Create(Self);
      CurrMenuItem.Caption := ListaViste.Strings[I];
      CurrMenuItem.OnClick := Selezionavista1Click;
      Selezionavista1.Add(CurrMenuItem);
    end;
  finally
    ListaViste.Free;
  end;
  // ==========================================================================
end;

procedure TClientiForm.tvDocSELEZIONATOCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo;
  var ADone: Boolean);
var
  XX, YY, IconIndex: Integer;
  B: TBitmap;
  T: String;
begin
  ADone := True;
  // Sfondo
  ACanvas.Brush.Color := AViewInfo.Item.Styles.Content.Color;
  ACanvas.FillRect(AViewInfo.Bounds);
  // INizializzazione delle variabili per le coordinate
  XX := AViewInfo.Bounds.Left + DS_LEFT_MARGIN;
  YY := AViewInfo.Bounds.Top + DS_TOP_MARGIN;

  // ==========================================================================
  // VISUALIZZAZIONE ICONA IMPORTATO/ESPORTATO
  // --------------------------------------------------------------------------
  // T contiene il valore del campo SELEZIONATO per poi controllare lo stato di Importazione/Esportazione
  T := AViewInfo.GridRecord.DisplayTexts[tvDocSELEZIONATO.Index];
  if T = '' then
    T := ' ';
  // Ottiene l'indice dell' icona da visualizzare in base allo stato
  IconIndex := 0;
  if (T = FLAG_VALUE_IMPORTED) then
    IconIndex := IDX_DS_IMPORT
  else if (T = FLAG_VALUE_EXPORTED) or (T = '*') then
    IconIndex := IDX_DS_EXPORT // '*' viene mantenuto per compatibilit con le versioni precedenti
  else if (T = FLAG_VALUE_IMPORTED_EXPORTED) then
    IconIndex := IDX_DS_IMPORT_EXPORT;
  // Se l'indice ottenuto  valido visualizza l'icona relativa
  if IconIndex > 0 then
  begin
    B := TBitmap.Create;
    try
      DM1.ImgListStatiDoc.GetBitmap(IconIndex, B);
      ACanvas.Draw(XX, YY, B);
    finally
      B.Free;
    end;
  end;
  // Aggiorna la variabile per il posizionamento orizzontale della prossima icona
  Inc(XX, DS_ICON_WIDTH + DS_ICON_SEPARATION);
  // ==========================================================================

  // ==========================================================================
  // VISUALIZZAZIONE ICONA DA FATTURARE/FATTURATO
  // --------------------------------------------------------------------------
  // T contiene il valore del campo DAFATTURARE per poi controllare lo stato di Importazione/Esportazione
  T := AViewInfo.GridRecord.DisplayTexts[tvDocDAFATTURARE.Index];
  if T = '' then
    T := ' ';
  // Ottiene l'indice dell' icona da visualizzare in base allo stato
  IconIndex := 0;
  if (T = FLAG_VALUE_DA_FATTURARE) then
    IconIndex := IDX_DS_DA_FATTURARE
  else if (T = FLAG_VALUE_FATTURATO) then
    IconIndex := IDX_DS_FATTURATO;
  // Se l'indice ottenuto  valido visualizza l'icona relativa
  if IconIndex > 0 then
  begin
    B := TBitmap.Create;
    try
      DM1.ImgListStatiDoc.GetBitmap(IconIndex, B);
      ACanvas.Draw(XX, YY, B);
    finally
      B.Free;
    end;
  end;
  // Aggiorna la variabile per il posizionamento orizzontale della prossima icona
  Inc(XX, DS_ICON_WIDTH + DS_ICON_SEPARATION);
  // ==========================================================================
end;

procedure TClientiForm.tvDocTcxGridDBDataControllerTcxDataSummaryFooterSummaryItems0GetText(Sender: TcxDataSummaryItem; const AValue: Variant; AIsFooter: Boolean; var AText: string);
begin
  if AValue = 0 then
    AText := '';
end;

procedure TClientiForm.tvDocDragDrop(Sender, Source: TObject; X, Y: Integer);
begin
  // In base al tipo del mittente
  if Source is TListView then
  begin

    // Se il mittente  la ricezione di un documento dal sistema di interscambio dei documenti...
    if (Source as TListView).Name = 'ReceiveLV' then
    begin
      // Provvede all'importazione dei documenti in ricezione
      ScambioDocForm.SBRiceviDocumentoClick(ScambioDocForm.SBRiceviDocumento);
    end

    // Se invece il mittente della ricezione  la bacheca...
    else if ((Source as TListView).Name = 'ListViewExpDoc') then
    begin
      // Se  un LDE (Gli LDE hanno la propriet GroupID della ListItem valorizzata con l'ID del documetno stesso)
      if MainForm.ListViewExpDoc.Selected.GroupID > 0 then
        Self.CreaNuovoLDEDaBacheca
        // Se invece  una conformit (VECCHIA)
      else if (DM1.ExpDocToDocType(MainForm.ListViewExpDoc.Selected.Caption) = 'Conformita') then
        Self.CreaNuovaConformitaDaBacheca_OLD;
    end;

  end;
end;

procedure TClientiForm.RetroDataNotificaDemoFE(Giorni: Integer);
var
  DocType, DocReg: String;
  DocNum: Integer;
  DocDate: TDate;
begin
  if (tvDoc.Controller.SelectedRecordCount > 0) then
  begin
    DocType := QryDocTIPODOC.AsString;
    DocReg := QryDocREGISTRO.AsString;
    DocNum := QryDocCODICEDOC.AsInteger;
    DocDate := QryDocDATADOC.AsDateTime;
    DM2.RetrodataNotificaFE(DocType, DocReg, DocNum, DocDate, Giorni);
  end;
end;

procedure TClientiForm.CreaNotificaDemoFE(ResponseType, FileName, MsgCode, MsgText, MsgRaw: String; CheckForNotification: Boolean;
  NotificationWaitDays: Integer);
var
  DocType, DocReg: String;
  DocNum: Integer;
  DocDate: TDate;
begin
  if (tvDoc.Controller.SelectedRecordCount > 0) then
  begin
    DocType := QryDocTIPODOC.AsString;
    DocReg := QryDocREGISTRO.AsString;
    DocNum := QryDocCODICEDOC.AsInteger;
    DocDate := QryDocDATADOC.AsDateTime;
    DM2.SalvaNotificaFE(DocType, DocReg, DocNum, DocDate, ResponseType, FileName, MsgCode, MsgText, MsgRaw, CheckForNotification, NotificationWaitDays);
  end;
end;

procedure TClientiForm.CreaNuovoLDEDaBacheca;
var
  LCapt, LDocTipo: String;
  LDocID: Integer;
begin
  if MainForm.ListViewExpDoc.SelCount > 0 then
  begin
    LCapt := MainForm.ListViewExpDoc.Selected.Caption;
    LDocTipo := DM1.ExpDocToDocType(LCapt);
    LDocID := MainForm.ListViewExpDoc.Selected.GroupID;
    DM1.LDE_DuplicateDocument(LDocTipo, LDocID, ID_ClienteCorrente, ID_PraticaCorrente);
    // Elimina la voce
    DM1.EliminaExpLDE(LDocID);
    MainForm.ListViewExpDoc.Selected.Delete;
  end;
end;

procedure TClientiForm.CreaNuovaConformitaDaBacheca_OLD;
var
  Capt: String;
begin
  if ClienteCorrente = '' then
  begin
    DM1.Messaggi('Dichiarazione di conformit', 'Prima  necessario selezionare un soggetto.', '', [mbOk], 0, nil);
    Exit;
  end;
  if MainForm.ListViewExpDoc.SelCount > 0 then
  begin
    Capt := MainForm.ListViewExpDoc.Selected.Caption;
    // Se  un documento esportato ne importa i dati
    if MainForm.ListViewExpDoc.Selected.ImageIndex = 0 then
    begin
      // Crea la form della nuova COnformita impostando il cliente e la pratica
      // se attualmente selezionati e  mette nei riferimenti al modello i riferimenti
      // relativi alla dichiarazione importata dalla bacheca in modo che il nuovo
      // documento importi i dati da quest'ultima utilizzandola come un modello ma con qualche piccola differenza.
      Application.CreateForm(TConformitaForm, ConformitaForm);
      ConformitaForm.Parent := MainForm;
      ConformitaForm.CodiceCliente := ClientiForm.ClienteCorrente;
      ConformitaForm.CodicePratica := ClientiForm.PraticaCorrente;
      ConformitaForm.DataPratica := ClientiForm.DataPraticaCorrente;
      ConformitaForm.CodiceConformitaSorgente := DM1.ExpDocToDocNum(Capt);
      ConformitaForm.DataConformitaSorgente := DM1.ExpDocToDocDate(Capt);
      ConformitaForm.Tag := 2;
      ConformitaForm.Show;
      // Elimina la voce
      DM1.EliminaExpConformita(DM1.ExpDocToDocNum(Capt), DM1.ExpDocToDocDate(Capt));
      MainForm.ListViewExpDoc.Selected.Delete;
    end;
  end;
end;

procedure TClientiForm.tvDocDragOver(Sender, Source: TObject; X, Y: Integer; State: TDragState; var Accept: Boolean);
begin
  // Inizializzazione
  Accept := False;
  // Se Source  una TLIstView...
  if Source is TListView then
  begin
    // Se la TListView in questione  quella di ricezione dal sistema
    // di interscambio dei documenti accetta.
    // NB: Controlla anche che si tratti di un documento
    if (((Source as TListView).Name = 'ReceiveLV') and ((ScambioDocForm.ReceiveLV.Selected.ImageIndex = 0) or (ScambioDocForm.ReceiveLV.Selected.ImageIndex = 6)
      )) or ((Source as TListView).Name = 'ListViewExpDoc') then
    begin
      Accept := True;
    end;
  end;
end;

procedure TClientiForm.PratMesiTuttiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    PratMesiTuttiClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.PratMesiNessunoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    PratMesiNessunoClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.PratGenMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    (Sender as TSpeedButton).Down := True;
    PratGenClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.MenuAssistenzePopup(Sender: TObject);
var
  I: Integer;
  CurrMenu, SourceMenu: TPopupMenu;
  NewItem: TMenuItem;
begin
  // In base ai permessi rende o meno visibili
  for I := 0 to MenuAssistenze.Items.Count - 1 do
  begin
    MenuAssistenze.Items[I].Visible := (DM1.ModCtrl(MOD_CONTATTI) > 1);
  end;
  // Richiama il gestore di default dell'evento
  PopupMenuPopupGestoreDefault(Sender);
end;

procedure TClientiForm.ImpMesiTuttiClick(Sender: TObject);
begin
  ImpDal.EditText := DM1.FilterDataDalDefault;
  ImpAl.EditText := DM1.FilterDataAlDefault;
  // Se il Tag del pulsante MesiTutti = 1 significa che questo gestore di evento  stato
  // richiamato dall'evento OnChange del PageControl e non per un click dell'utente sul
  // pulsante stesso, quindi imposta le date al primo giorno e all'ultimo dell'anno in corso
  // ma non mette in  Down tutti i pulsanti dei mesi perch mi piace di pi.
  // if ImpMesiTutti.Tag = 0 then begin
  // In questo modo posso metterli tutti in DOWN contemporaneamente
  ImpGen.GroupIndex := 1001;
  ImpFeb.GroupIndex := 1002;
  ImpMar.GroupIndex := 1003;
  ImpApr.GroupIndex := 1004;
  ImpMag.GroupIndex := 1005;
  ImpGiu.GroupIndex := 1006;
  ImpLug.GroupIndex := 1007;
  ImpAgo.GroupIndex := 1008;
  ImpSet.GroupIndex := 1009;
  ImpOtt.GroupIndex := 1010;
  ImpNov.GroupIndex := 1011;
  ImpDic.GroupIndex := 1012;
  ImpGen.Down := False;
  ImpFeb.Down := False;
  ImpMar.Down := False;
  ImpApr.Down := False;
  ImpMag.Down := False;
  ImpGiu.Down := False;
  ImpLug.Down := False;
  ImpAgo.Down := False;
  ImpSet.Down := False;
  ImpOtt.Down := False;
  ImpNov.Down := False;
  ImpDic.Down := False;
  // end else begin
  // Rimette il Tag del pulsante = 0
  ImpMesiTutti.Tag := 0;
  // end;
end;

procedure TClientiForm.ImpMesiTuttiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    ImpMesiTuttiClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.ImpMesiNessunoClick(Sender: TObject);
begin
  ImpDal.Clear;
  ImpAl.Clear;
  // In questo modo posso metterli tutti in DOWN contemporaneamente
  ImpGen.GroupIndex := 600;
  ImpFeb.GroupIndex := 600;
  ImpMar.GroupIndex := 600;
  ImpApr.GroupIndex := 600;
  ImpMag.GroupIndex := 600;
  ImpGiu.GroupIndex := 600;
  ImpLug.GroupIndex := 600;
  ImpAgo.GroupIndex := 600;
  ImpSet.GroupIndex := 600;
  ImpOtt.GroupIndex := 600;
  ImpNov.GroupIndex := 600;
  ImpDic.GroupIndex := 600;
  ImpGen.Down := False;
  ImpFeb.Down := False;
  ImpMar.Down := False;
  ImpApr.Down := False;
  ImpMag.Down := False;
  ImpGiu.Down := False;
  ImpLug.Down := False;
  ImpAgo.Down := False;
  ImpSet.Down := False;
  ImpOtt.Down := False;
  ImpNov.Down := False;
  ImpDic.Down := False;
end;

procedure TClientiForm.ImpMesiNessunoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    ImpMesiNessunoClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.ImpGenClick(Sender: TObject);
var
  GG, MM, AA: Word;
  Mese: Shortint;
begin
  // Mese contiene l'indice del mese premuto
  Mese := (Sender as TSpeedButton).Tag;
  // AA COntiene l'anno in corso
  DecodeDate(Date, AA, MM, GG);
  // Se il GroupIndex  <> 600 significa che  stato premuto il
  // tasto di selezione di tutti i mesi e quindi si comporta di conseguenza
  if (Sender as TSpeedButton).GroupIndex <> 600 then
  begin
    ImpMesiNessunoClick(Self);
    (Sender as TSpeedButton).Down := True;
  end;
  // Se il pulsante  premuto (down)...
  if (Sender as TSpeedButton).Down then
  begin
    // In base all'indice del mese imposta le date nel modo opportuno
    case Mese of
      1:
        begin
          ImpDal.EditText := ' 01/01/' + IntToStr(AA);
          ImpAl.EditText := ' 31/01/' + IntToStr(AA);
        end;
      2:
        begin
          ImpDal.EditText := ' 01/02/' + IntToStr(AA);
          ImpAl.EditText := ' ' + IntToStr(DaysInAMonth(CurrentYear, 2)) + '/02/' + IntToStr(AA);
        end;
      3:
        begin
          ImpDal.EditText := ' 01/03/' + IntToStr(AA);
          ImpAl.EditText := ' 31/03/' + IntToStr(AA);
        end;
      4:
        begin
          ImpDal.EditText := ' 01/04/' + IntToStr(AA);
          ImpAl.EditText := ' 30/04/' + IntToStr(AA);
        end;
      5:
        begin
          ImpDal.EditText := ' 01/05/' + IntToStr(AA);
          ImpAl.EditText := ' 31/05/' + IntToStr(AA);
        end;
      6:
        begin
          ImpDal.EditText := ' 01/06/' + IntToStr(AA);
          ImpAl.EditText := ' 30/06/' + IntToStr(AA);
        end;
      7:
        begin
          ImpDal.EditText := ' 01/07/' + IntToStr(AA);
          ImpAl.EditText := ' 31/07/' + IntToStr(AA);
        end;
      8:
        begin
          ImpDal.EditText := ' 01/08/' + IntToStr(AA);
          ImpAl.EditText := ' 31/08/' + IntToStr(AA);
        end;
      9:
        begin
          ImpDal.EditText := ' 01/09/' + IntToStr(AA);
          ImpAl.EditText := ' 30/09/' + IntToStr(AA);
        end;
      10:
        begin
          ImpDal.EditText := ' 01/10/' + IntToStr(AA);
          ImpAl.EditText := ' 31/10/' + IntToStr(AA);
        end;
      11:
        begin
          ImpDal.EditText := ' 01/11/' + IntToStr(AA);
          ImpAl.EditText := ' 30/11/' + IntToStr(AA);
        end;
      12:
        begin
          ImpDal.EditText := ' 01/12/' + IntToStr(AA);
          ImpAl.EditText := ' 31/12/' + IntToStr(AA);
        end;
    end;
    // Se invece il mese non  premuto...
  end
  else
  begin
    ImpDal.Text := '';
    ImpAl.Text := '';
  end;
end;

procedure TClientiForm.ImpGenMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    (Sender as TSpeedButton).Down := True;
    ImpGenClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.MenuImpegniPopup(Sender: TObject);
var
  M: TMemIniFile;
begin
  // Apertura file layouts.ini
  M := TMemIniFile.Create(DM1.Repository_Menu.FullLocalFileName);
  try
    // In base ai permessi rende o meno visibili
    Appuntamentonormale2.Visible := (DM1.ModCtrl(MOD_AGENDA) > 1) and (DM1.VisualizzaNuovoAppuntamentoNormale);
    ChiamataAppuntamentodiassistenza1.Visible := (DM1.ModCtrl(MOD_CONTATTI) > 1) and (DM1.VisualizzaNuovoAppuntamentoAssistenza);
    // Imposta i titoli delle voci del men
    Appuntamentonormale2.Caption := M.ReadString('ImpostazioniAgendaImpegno', 'TitoloNuovoAppuntamentoGenerico', 'Appuntamento normale');
    ChiamataAppuntamentodiassistenza1.Caption := M.ReadString('ImpostazioniAgendaImpegno', 'TitoloNuovoAppuntamentoDiAssistenza',
      'Chiamata / Appuntamento di assistenza');
    // Richiama il gestore di default dell'evento
    PopupMenuPopupGestoreDefault(Sender);
  finally
    M.Free;
  end;
end;

procedure TClientiForm.Fatturachiamateappuntamentiinterventiselezionati2Click(Sender: TObject);
var
  LID, I: Integer;
begin
  if (TFatturaImpegniForm.ShowFatturaImpegniForm(DM1.RegistroDefault) = mrYes)
  and (DM1.Messaggi('Chiusura automatica chiamate/appuntamenti', 'Confermi di voler proseguire con l''operazione?',
    'NB: L''operazione potrebbe durare diversi minuti e non  reversibile.'#13#13'NB: E'' consigliabile effettuare prima una copie di sicurezza degli archivi',
    [mbYes, mbNo], 0, nil) = mrYes) then
  begin
    try
      // cicla per tutti gli impegni selezionati e li chiude automaticamente
      for I := 0 to tvImpegni.Controller.SelectedRecordCount - 1 do
      begin
        LID := tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniID.Index];
        DM2.ChiudiImpegnoAuto(LID, True, True, True, True, True, False, Date);
      end;
    finally
      DM1.Messaggi('Levante', 'Operazione terminata!', '', [mbOk], 0, nil);
    end;
  end;
end;

procedure TClientiForm.FilterAbbonatiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
var
  CheckIndex, I: Integer;
  CurrCheckListBox: TCheckListBox;
begin
  // ----------------------------------------------------------------------------------------------------
  // Questo codice server per fare in modo che anche se l'utente clicca sul titolo della voce, questa
  // venga selezinata o deselezionata come se si fosse cliccato sul riquadrino del segno di check)
  // ----------------------------------------------------------------------------------------------------
  // La variabie CurrCheckListBox Punta alla CheckListBox che ha richiamata l'evento
  CurrCheckListBox := Sender as TCheckListBox;
  // Solo se s cliccato con il pulsante SX del mouse
  if Button = mbLeft then
  begin
    // Quale voce si trova sotto il mouse?
    CheckIndex := CurrCheckListBox.ItemAtPos(Point(X, Y), True);
    // Se c'era una voce cambia il suo stato
    if CheckIndex <> -1 then
    begin
      if CurrCheckListBox.Tag = 0 then
        CurrCheckListBox.Checked[CheckIndex] := not CurrCheckListBox.Checked[CheckIndex];
      // Rimette la Propriet Tag del componente = 0
      CurrCheckListBox.Tag := 0;
    end;
    // Se invece  stato premuto il pulsante DX
  end
  else if Button = mbRight then
  begin
    // Quale voce si trova sotto il mouse?
    CheckIndex := CurrCheckListBox.ItemAtPos(Point(X, Y), True);
    // Se c'era una voce cambia il suo stato
    if CheckIndex <> -1 then
    begin
      if CurrCheckListBox.Tag = 0 then
        CurrCheckListBox.Checked[CheckIndex] := not CurrCheckListBox.Checked[CheckIndex];
      // Rimette la Propriet Tag del componente = 0
      CurrCheckListBox.Tag := 0;
    end;
    // Esegue la ricerca
    RxSpeedButtonTrovaClick(Self);
  end;
  // F in modo che non resti una voce selezionata e quindi evidenziata che non mi piace
  CurrCheckListBox.ItemIndex := -1;
  // ----------------------------------------------------------------------------------------------------
  // Se  il caso deseleziona tutto e seleziona automaticamente
  // solo gli interventi.
  with (Sender as TCheckListBox) do
  begin
    if Checked[0] xor Checked[1] then
    begin
      SBDocNessunoClick(SBDocNessuno);
      DocVendite.Items[DocumentiAttivi[1, 14]].Checked := True;
    end;
  end;
end;

procedure TClientiForm.Stampaelencoimpianti1Click(Sender: TObject);
var
  PrecGroupColor: TColor;
begin
  // Imposta la stringa su cui viene costruito il range di date della stampa in base ai filtri per data
  DM1.SetReportDateRange(TabImpiantiForm.AssDal.EditText, TabImpiantiForm.AssAl.EditText);
  // Salva e modifica alcune propriet per adattare il componente alla stampe
  // e poi rimette tutto a posto.
  TabImpiantiForm.GridAssistenze.BeginUpdate;
  TabImpiantiForm.GridAssistenze.RootLevelOptions.DetailFrameColor := clWhite;
  TabImpiantiForm.btvAssistenze.OptionsView.GroupRowStyle := grsStandard;
  TabImpiantiForm.btvAssistenze.OptionsView.GridLineColor := clWhite;
  TabImpiantiForm.btvAssistenze.OptionsView.IndicatorWidth := 0;

  PrecGroupColor := TabImpiantiForm.btvAssistenze.Styles.Group.Color;
  TabImpiantiForm.btvAssistenze.Styles.Group.Color := clWhite;

  try
    // Imposta alcune propriet
    TabImpiantiForm.GridImpiantiLink.OptionsExpanding.ExpandGroupRows := False;
    TabImpiantiForm.GridImpiantiLink.OptionsExpanding.ExpandMasterRows := False;
    // Anteprima
    if MenuStampe.Tag = 0 then
    begin
      TabImpiantiForm.dxPrinter.Preview(True, TabImpiantiForm.GridImpiantiLink);
      // Stampa
    end
    else if MenuStampe.Tag = 1 then
    begin
      TabImpiantiForm.dxPrinter.Print(True, nil, TabImpiantiForm.GridImpiantiLink);
    end;
  finally
    // Ripristina l'aspetto del componente
    TabImpiantiForm.GridAssistenze.RootLevelOptions.DetailFrameColor := clBlack;
    TabImpiantiForm.btvAssistenze.OptionsView.GroupRowStyle := grsOffice11;
    TabImpiantiForm.btvAssistenze.OptionsView.GridLineColor := $00D3D3D3;
    TabImpiantiForm.btvAssistenze.OptionsView.IndicatorWidth := 12;

    TabImpiantiForm.btvAssistenze.Styles.Group.Color := PrecGroupColor;

    TabImpiantiForm.GridAssistenze.EndUpdate;
  end;
end;

procedure TClientiForm.Stampaelencochiamateappuntamentiinterventi1Click(Sender: TObject);
begin
  // Imposta la stringa su cui viene costruito il range di date della stampa in base ai filtri per data
  DM1.SetReportDateRange(ImpDal.EditText, ImpAl.EditText);
  // Preview
  if MenuStampe.Tag = 0 then
  begin
    dxPrinter.Preview(True, GridImpegniLink);
    // Stampa
  end
  else if MenuStampe.Tag = 1 then
  begin
    dxPrinter.Print(True, nil, GridImpegniLink);
  end;
end;

procedure TClientiForm.SoloRegistroPropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
begin
  // Carica l'elenco dei costruttori
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('SELECT REGISTRO FROM PROGREG');
    Qry.Open;
    (Sender as TcxComboBox).Properties.Items.Clear;
    (Sender as TcxComboBox).Properties.Items.Add('');
    while not Qry.Eof do
    begin
      (Sender as TcxComboBox).Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.TranneRegistroPropertiesChange(Sender: TObject);
begin
  if TranneRegistro.Text <> '' then
    SoloRegistro.Text := '';
end;

procedure TClientiForm.QryArticoliBeforeDelete(DataSet: TDataSet);
var
  Qry: TIB_Cursor;
begin
  Qry := TIB_Cursor.Create(nil);
  try
    try
      DM1.ShowWait('Elimina articolo', 'Cancellazione articolo "' + QryArticoliCODICEARTICOLO.AsString + '" i corso...');
      // Avvia la transazione per l'eliminazione dell'articolo corrente in modo che se si tratta di
      // un articolo composto la relativa eliminazione avvenga completamente (anche la distinta
      // base) oppure per niente.
      // NB: Il Commit della transazione avverr nell'evento AfterDelete oppure il Rollback nell'evento
      // OnDeleteError.
      DM1.DBAzienda.StartTransaction;

      Qry.DatabaseName := DM1.ArcDBFile;
      Qry.IB_Connection := DM1.DBAzienda;

      Qry.SQL.Add('DELETE FROM DIBARIGHI WHERE TIPODOCUMENTO = ''' + QryArticoliCODICEARTICOLO.AsString + '''');
      Qry.ExecSQL;

      Qry.SQL.Clear;
      Qry.SQL.Add('DELETE FROM DIBATESTATE WHERE TIPODOCUMENTO = ''' + QryArticoliCODICEARTICOLO.AsString + '''');
      Qry.ExecSQL;

      DM1.EliminaListiniFornitoriArticolo(QryArticoliCODICEARTICOLO.AsString);
    finally
      Qry.Free;
    end;
  except
    DM1.CloseWait;
    // Rollback della transazione aperta nell'evento OnBeforeDelete
    DM1.DBAzienda.Rollback;
  end;
end;

procedure TClientiForm.QryAgendaBeforePost(DataSet: TDataSet);
var
  Qry: TIB_Cursor;
begin
  if not DataSet.FieldByName('ID').IsNull then
    Exit;
  Qry := TIB_Cursor.Create(nil);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('SELECT MAX(ID) AS NEXTID FROM IMPEGNI');
    Qry.Open;
    if Qry.Eof then
      Exit;
    DataSet.FieldByName('ID').Value := Qry.Fields[0].AsInteger + 1;
  finally
    if Qry.Active then
      Qry.Close;
    Qry.Free;
  end;
end;

procedure TClientiForm.QryArticoliAfterDelete(DataSet: TDataSet);
begin
  try
    // Commit della transazione aperta nell'evento OnBeforeDelete
    DM1.DBAzienda.Commit;
  finally
    DM1.CloseWait;
  end;
end;

procedure TClientiForm.QryArticoliDeleteError(DataSet: TDataSet; E: EDatabaseError; var Action: TDataAction);
begin
  try
    // Rollback della transazione aperta nell'evento OnBeforeDelete
    DM1.DBAzienda.Rollback;
  finally
    DM1.CloseWait;
  end;
end;

procedure TClientiForm.tvDocKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  // Se invece  stato premuto il puslante "Canc" con il focus sulla griglia
  // richiama la pressione del pulsante di cancellazione dei documenti, perch
  // l'eliminazione interna della griglia sui documento  stata disabilitata perch
  // dava un errore. Cos gli faccio richiamare la mia funzione di cancellazione dei documenti
  // cos funziona anche il Canc.
  if Key = 46 then
    RxSpeedButtonEliminaClick(RxSpeedButtonElimina);
end;

procedure TClientiForm.Stampaelencocantieri1Click(Sender: TObject);
begin
  try
    // Imposta la stringa su cui viene costruito il range di date della stampa in base ai filtri per data
    DM1.SetReportDateRange(PratDal.EditText, PratAl.EditText);
    // Preview
    if MenuStampe.Tag = 0 then
    begin
      dxPrinter.Preview(True, GridCantieriLink);
      // Stampa
    end
    else if MenuStampe.Tag = 1 then
    begin
      dxPrinter.Print(True, nil, GridCantieriLink);
    end;
  finally
  end;
end;

procedure TClientiForm.ScadTipoDocDragDrop(Sender, Source: TObject; X, Y: Integer);
var
  Capt: String;
begin
  // Se il mittente  la bacheca e il tipo di oggetto  un documento,
  // ricopia i dati del documento stesso nel filtro per documento ed
  // elimina il documento dalla bacheca
  if Source is TListView then
  begin
    if (Source as TListView).Name = 'ListViewExpDoc' then
    begin
      if MainForm.ListViewExpDoc.SelCount > 0 then
      begin
        Capt := MainForm.ListViewExpDoc.Selected.Caption;
        // Se  un documento esportato ne importa i dati
        if MainForm.ListViewExpDoc.Selected.ImageIndex = 0 then
        begin
          // Carica i dati del documento nel filtro
          ScadTipoDoc.Text := DM1.ExpDocToDocType(Capt);
          ScadNumDoc.Text := IntToStr(DM1.ExpDocToDocNum(Capt));
          ScadRegistro.Text := DM1.ExpDocToDocReg(Capt);
          ScadDataDoc.Text := DateToStr(DM1.ExpDocToDocDate(Capt));
          // Elimina la voce
          DM1.EliminaExpDoc(DM1.ExpDocToDocType(Capt), DM1.ExpDocToDocReg(Capt), DM1.ExpDocToDocNum(Capt), DM1.ExpDocToDocDate(Capt));
          MainForm.ListViewExpDoc.Selected.Delete;
        end;
      end;
    end;
  end;
end;

procedure TClientiForm.ScadTipoDocDragOver(Sender, Source: TObject; X, Y: Integer; State: TDragState; var Accept: Boolean);
begin
  Accept := False;
  // Se il mittente  la bacheca e il tipo di oggetto  un documento,
  // ricopia i dati del documento stesso nel filtro per documento ed
  // elimina il documento dalla bacheca
  if Source is TListView then
  begin
    if (Source as TListView).Name = 'ListViewExpDoc' then
    begin
      if MainForm.ListViewExpDoc.SelCount > 0 then
      begin
        Accept := True;
      end;
    end;
  end;
end;

procedure TClientiForm.ArtVisteKeyPress(Sender: TObject; var Key: Char);
begin
  // Annulla la pressione di qualsiasi tasto
  Key := #0;
end;

procedure TClientiForm.Attestazionediavvenutatrasmissioneconimpossibilitdirecapito1Click(Sender: TObject);
begin
  CreaNotificaDemoFE('rtSDIMessageAT', '', 'AT', 'Attestaz. avvenuta trasmissione con impossibilit di recapito (SDI)', '', False, 0);
end;

procedure TClientiForm.Selezionavista1Click(Sender: TObject);
var
  CurrGrid: TcxControl;
  CurrItemCaption: String;
begin
  // Caption della voce selezionata
  CurrItemCaption := (Sender as TMenuItem).Caption;
  // Se la Caption della voce selezionata contiene il carattere & (incasina tutto)
  // lo toglie.
  CurrItemCaption := StringReplace(CurrItemCaption, '&', #0, [rfReplaceAll]);
  // Se la voce attuale  la radice del menu di selezione viste esce subito
  if (Sender as TMenuItem).Name = 'Selezionavista1' then
    Exit;
  // In base alla pagina selezionata Elenco Viste punta alla griglia
  // corretta
  CurrGrid := GetCurrentGrid;
  // Carica la vista attuale
  if CurrGrid is TcxGrid then
    DM1.RipristinaDevExpress((CurrGrid as TcxGrid), CurrItemCaption, False);
  if CurrGrid is TcxDBPivotGrid then
    DM1.RipristinaPivotDevExpress((CurrGrid as TcxDBPivotGrid), CurrItemCaption);
  if CurrGrid is TcxScheduler then
    DM1.RipristinaAgendaDevExpress((CurrGrid as TcxScheduler), CurrItemCaption);
end;

procedure TClientiForm.Ripristinacolonneeliminate1Click(Sender: TObject);
var
  CurrGrid: TcxControl;
begin
  // In base alla pagina selezionata Elenco Viste punta alla griglia
  // corretta
  CurrGrid := GetCurrentGrid;
  // Carica la vista attuale
  if CurrGrid is TcxGrid then
    (CurrGrid as TcxGrid).FocusedView.Controller.Customization := True;
  if CurrGrid is TcxDBPivotGrid then
    (CurrGrid as TcxDBPivotGrid).Customization.Visible := True;
end;

procedure TClientiForm.tvRubricaCustomDrawPartBackground(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxCustomGridCellViewInfo;
  var ADone: Boolean);
begin
  // Richiama la gestione predefinita dell'evento
  DM1.QGridCustomDrawPartBackground((Sender as TcxGridTableView), ACanvas, AViewInfo, ADone);
end;

procedure TClientiForm.Impegno1Click(Sender: TObject);
begin
  // Richiama la gestione dell'evento che gebera il nuovo impegno
  ChiamataAppuntamentodiassistenza1Click(ChiamataAppuntamentodiassistenza1);
  // Imposta alcuni valori di default
  ImpegnoForm.QryImpSTART.Value := Agenda.SelStart;
  ImpegnoForm.QryImpFINISH.Value := Agenda.SelFinish;
  ImpegnoForm.QryImpRESOURCEID.Value := Agenda.SelResource.ResourceID;
end;

procedure TClientiForm.MenuAgendaPopup(Sender: TObject);
var
  M: TMemIniFile;
begin
  // Apertura file layouts.ini
  M := TMemIniFile.Create(DM1.Repository_Menu.FullLocalFileName);
  try
    // In base ai permessi rende o meno visibili
    Appuntamentonormale1.Visible := (DM1.ModCtrl(MOD_AGENDA) > 1) and (DM1.VisualizzaNuovoAppuntamentoNormale);
    Impegno1.Visible := (DM1.ModCtrl(MOD_CONTATTI) > 1) and (DM1.VisualizzaNuovoAppuntamentoAssistenza);
    // Imposta i titoli delle voci del men
    Appuntamentonormale1.Caption := M.ReadString('ImpostazioniAgendaImpegno', 'TitoloNuovoAppuntamentoGenerico', 'Appuntamento normale');
    Impegno1.Caption := M.ReadString('ImpostazioniAgendaImpegno', 'TitoloNuovoAppuntamentoDiAssistenza', 'Chiamata / Appuntamento di assistenza');
    // Richiama il gestore di default dell'evento
    PopupMenuPopupGestoreDefault(Sender);
  finally
    M.Free;
  end;
end;

procedure TClientiForm.AgendaImportaChiamata;
var
  Capt: String;
  IDImpegno: Integer;
  Qry: TIB_Cursor;
  CurrTimeSlot: TDateTime;
begin
  // Inizializzazione
  CurrTimeSlot := 0;
  // Crea la query che preleva i righi del documento da esportare dall'archivio dei righidoc dell'azienda
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    // Cicla per tutti i documenti esportati indicati nella ListView della MainForm
    // e importa quelli selezionati nel documento attuale.
    if MainForm.ListViewExpDoc.SelCount > 0 then
    begin
      // Se  una chiamata
      if MainForm.ListViewExpDoc.Selected.ImageIndex = 2 then
      begin
        // Carica alcuni dati utili su variabili di appoggio
        Capt := MainForm.ListViewExpDoc.Selected.Caption;
        IDImpegno := DM1.ExpImpegnoToID(Capt);
        // Rileva l'orario sul quale  posizionato il cursore
        with Agenda do
        begin
          if (ActiveHitTest is TcxSchedulerDayViewHitTest) and CurrentView.HitTest.HitAtTime then
            CurrTimeSlot := ViewDay.HitTest.Time;
          if (ActiveHitTest is TcxSchedulerDateNavigatorHitTest) and DateNavigator.HitTest.HitAtTime then
            CurrTimeSlot := DateNavigator.HitTest.Time;
        end;
        // Query che modifica l'impegno cambiandogli di stato e impostando
        // l'inizio e la fine dell'appuntamento e il tecnico.
        Qry.SQL.Add('UPDATE IMPEGNI SET');
        Qry.SQL.Add('TIPOIMPEGNO = ''Appuntamento'',');
        Qry.SQL.Add('START_EVENT = ''' + FormatDateTime('mm/dd/yyyy hh:mm:ss', CurrTimeSlot) + ''',');
        Qry.SQL.Add('FINISH_EVENT = ''' + FormatDateTime('mm/dd/yyyy hh:mm:ss', CurrTimeSlot + EncodeTime(1, 30, 0, 0)) + ''',');
        Qry.SQL.Add('RESOURCEID = ' + IntToStr(Agenda.CurrentView.HitTest.Resource.ResourceID));
        Qry.SQL.Add('WHERE ID = ' + IntToStr(IDImpegno));
        Qry.ExecSQL;
        // Elimina la voce dalla bacheca
        DM1.EliminaExpImpegno(IDImpegno);
      end;
    end;
  finally
    Qry.Free;
    MainForm.AggiornaDocumentiEsportati;
    RxSpeedButtonTrovaClick(RxSpeedButtonTrova);
  end;
end;

procedure TClientiForm.Agenda_NormalSelectionModeDragDrop(Sender, Source: TObject; X, Y: Integer);
begin
  // In base al tipo del mittente
  if Source is TListView then
  begin
    // Se il mittente  la Bacheca...
    if (Source as TListView).Name = 'ListViewExpDoc' then
    begin
      // Provvede all'importazione
      AgendaImportaChiamata;
    end;
  end;
end;

procedure TClientiForm.BtnTecnicoClick(Sender: TObject);
begin
  DM1.Attendere;
  try
    // Visualizza la form che permette di selezionare il magazzino da inserire nel documento
    Application.CreateForm(TTecniciForm, TecniciForm);
    TecniciForm.Parent := MainForm;
    TecniciForm.Tag := 999; // Abilita la seleziona del tecnico
    TecniciForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.BitBtnArtGruppo4Click(Sender: TObject);
begin
  DM1.Attendere;

  // Visualizza la form che permette di selezionare il magazzino da inserire nel documento
  Application.CreateForm(TGruppiForm, GruppiForm);
  GruppiForm.Parent := MainForm;
  GruppiForm.Tag := 995; // Abilita la selezione
  GruppiForm.Selezionato1 := StrToInt(CodiceGruppo1.Text);
  GruppiForm.Selezionato2 := StrToInt(CodiceGruppo2.Text);
  GruppiForm.Selezionato3 := StrToInt(CodiceGruppo3.Text);
  GruppiForm.LivelloAttivo := 4;
  GruppiForm.Show;

  DM1.ChiudiAttendere;
end;

procedure TClientiForm.BitBtnArtGruppo5Click(Sender: TObject);
begin
  DM1.Attendere;

  // Visualizza la form che permette di selezionare il magazzino da inserire nel documento
  Application.CreateForm(TGruppiForm, GruppiForm);
  GruppiForm.Parent := MainForm;
  GruppiForm.Tag := 995; // Abilita la selezione
  GruppiForm.Selezionato1 := StrToInt(CodiceGruppo1.Text);
  GruppiForm.Selezionato2 := StrToInt(CodiceGruppo2.Text);
  GruppiForm.Selezionato3 := StrToInt(CodiceGruppo3.Text);
  GruppiForm.Selezionato4 := StrToInt(CodiceGruppo4.Text);
  GruppiForm.LivelloAttivo := 5;
  GruppiForm.Show;

  DM1.ChiudiAttendere;
end;

procedure TClientiForm.BitBtnArtGruppo6Click(Sender: TObject);
begin
  DM1.Attendere;

  // Visualizza la form che permette di selezionare il magazzino da inserire nel documento
  Application.CreateForm(TGruppiForm, GruppiForm);
  GruppiForm.Parent := MainForm;
  GruppiForm.Tag := 995; // Abilita la selezione
  GruppiForm.Selezionato1 := StrToInt(CodiceGruppo1.Text);
  GruppiForm.Selezionato2 := StrToInt(CodiceGruppo2.Text);
  GruppiForm.Selezionato3 := StrToInt(CodiceGruppo3.Text);
  GruppiForm.Selezionato4 := StrToInt(CodiceGruppo4.Text);
  GruppiForm.Selezionato5 := StrToInt(CodiceGruppo5.Text);
  GruppiForm.LivelloAttivo := 6;
  GruppiForm.Show;

  DM1.ChiudiAttendere;
end;

procedure TClientiForm.CodiceGruppo3Change(Sender: TObject);
begin
  // Se il codice gruppo  nullo disattiva la selezione del gruppo2, altrimenti la attiva
  if Trim(CodiceGruppo3.Text) = '' then
  begin
    CodiceGruppo4.Text := '';
    DescGruppo4.Text := '';
    CodiceGruppo4.Color := GruppiTitolo.Color;
    DescGruppo4.Color := GruppiTitolo.Color;
    CodiceGruppo4.TabStop := False;
    BitBtnArtGruppo4.Enabled := False;
  end
  else
  begin
    CodiceGruppo4.Color := CodiceGruppo1.Color;
    DescGruppo4.Color := CodiceGruppo1.Color;
    CodiceGruppo4.TabStop := True;
    BitBtnArtGruppo4.Enabled := True;
  end;
end;

procedure TClientiForm.CodiceGruppo4Change(Sender: TObject);
begin
  // Se il codice gruppo  nullo disattiva la selezione del gruppo2, altrimenti la attiva
  if Trim(CodiceGruppo4.Text) = '' then
  begin
    CodiceGruppo5.Text := '';
    DescGruppo5.Text := '';
    CodiceGruppo5.Color := GruppiTitolo.Color;
    DescGruppo5.Color := GruppiTitolo.Color;
    CodiceGruppo5.TabStop := False;
    BitBtnArtGruppo5.Enabled := False;
  end
  else
  begin
    CodiceGruppo5.Color := CodiceGruppo1.Color;
    DescGruppo5.Color := CodiceGruppo1.Color;
    CodiceGruppo5.TabStop := True;
    BitBtnArtGruppo5.Enabled := True;
  end;
end;

procedure TClientiForm.CodiceGruppo5Change(Sender: TObject);
begin
  // Se il codice gruppo  nullo disattiva la selezione del gruppo2, altrimenti la attiva
  if Trim(CodiceGruppo5.Text) = '' then
  begin
    CodiceGruppo6.Text := '';
    DescGruppo6.Text := '';
    CodiceGruppo6.Color := GruppiTitolo.Color;
    DescGruppo6.Color := GruppiTitolo.Color;
    CodiceGruppo6.TabStop := False;
    BitBtnArtGruppo6.Enabled := False;
  end
  else
  begin
    CodiceGruppo6.Color := CodiceGruppo1.Color;
    DescGruppo6.Color := CodiceGruppo1.Color;
    CodiceGruppo6.TabStop := True;
    BitBtnArtGruppo6.Enabled := True;
  end;
end;

procedure TClientiForm.BitBtnGruppo4Click(Sender: TObject);
begin
  DM1.Attendere;

  // Visualizza la form che permette di selezionare il magazzino da inserire nel documento
  Application.CreateForm(TGruppiForm, GruppiForm);
  GruppiForm.Parent := MainForm;
  GruppiForm.Tag := 999; // Abilita la selezione
  GruppiForm.Selezionato1 := StrToInt(GMCodiceGruppo1.Text);
  GruppiForm.Selezionato2 := StrToInt(GMCodiceGruppo2.Text);
  GruppiForm.Selezionato3 := StrToInt(GMCodiceGruppo3.Text);
  GruppiForm.LivelloAttivo := 4;
  GruppiForm.Show;

  DM1.ChiudiAttendere;
end;

procedure TClientiForm.BitBtnGruppo5Click(Sender: TObject);
begin
  DM1.Attendere;

  // Visualizza la form che permette di selezionare il magazzino da inserire nel documento
  Application.CreateForm(TGruppiForm, GruppiForm);
  GruppiForm.Parent := MainForm;
  GruppiForm.Tag := 999; // Abilita la selezione
  GruppiForm.Selezionato1 := StrToInt(GMCodiceGruppo1.Text);
  GruppiForm.Selezionato2 := StrToInt(GMCodiceGruppo2.Text);
  GruppiForm.Selezionato3 := StrToInt(GMCodiceGruppo3.Text);
  GruppiForm.Selezionato4 := StrToInt(GMCodiceGruppo4.Text);
  GruppiForm.LivelloAttivo := 5;
  GruppiForm.Show;

  DM1.ChiudiAttendere;
end;

procedure TClientiForm.BitBtnGruppo6Click(Sender: TObject);
begin
  DM1.Attendere;

  // Visualizza la form che permette di selezionare il magazzino da inserire nel documento
  Application.CreateForm(TGruppiForm, GruppiForm);
  GruppiForm.Parent := MainForm;
  GruppiForm.Tag := 999; // Abilita la selezione
  GruppiForm.Selezionato1 := StrToInt(GMCodiceGruppo1.Text);
  GruppiForm.Selezionato2 := StrToInt(GMCodiceGruppo2.Text);
  GruppiForm.Selezionato3 := StrToInt(GMCodiceGruppo3.Text);
  GruppiForm.Selezionato4 := StrToInt(GMCodiceGruppo4.Text);
  GruppiForm.Selezionato5 := StrToInt(GMCodiceGruppo5.Text);
  GruppiForm.LivelloAttivo := 6;
  GruppiForm.Show;

  DM1.ChiudiAttendere;
end;

procedure TClientiForm.GMCodiceGruppo3Change(Sender: TObject);
begin
  // Se il codice gruppo  nullo disattiva la selezione del gruppo2, altrimenti la attiva
  if Trim(GMCodiceGruppo3.Text) = '' then
  begin
    GMCodiceGruppo4.Text := '';
    GMDescGruppo4.Text := '';
    GMCodiceGruppo4.Color := GMGruppiTitolo.Color;
    GMDescGruppo4.Color := GMGruppiTitolo.Color;
    GMCodiceGruppo4.TabStop := False;
    BitBtnGruppo4.Enabled := False;
  end
  else
  begin
    GMCodiceGruppo4.Color := GMCodiceGruppo1.Color;
    GMDescGruppo4.Color := GMCodiceGruppo1.Color;
    GMCodiceGruppo4.TabStop := True;
    BitBtnGruppo4.Enabled := True;
  end;
end;

procedure TClientiForm.GMCodiceGruppo4Change(Sender: TObject);
begin
  // Se il codice gruppo  nullo disattiva la selezione del gruppo2, altrimenti la attiva
  if Trim(GMCodiceGruppo4.Text) = '' then
  begin
    GMCodiceGruppo5.Text := '';
    GMDescGruppo5.Text := '';
    GMCodiceGruppo5.Color := GMGruppiTitolo.Color;
    GMDescGruppo5.Color := GMGruppiTitolo.Color;
    GMCodiceGruppo5.TabStop := False;
    BitBtnGruppo5.Enabled := False;
  end
  else
  begin
    GMCodiceGruppo5.Color := GMCodiceGruppo1.Color;
    GMDescGruppo5.Color := GMCodiceGruppo1.Color;
    GMCodiceGruppo5.TabStop := True;
    BitBtnGruppo5.Enabled := True;
  end;
end;

procedure TClientiForm.GMCodiceGruppo5Change(Sender: TObject);
begin
  // Se il codice gruppo  nullo disattiva la selezione del gruppo2, altrimenti la attiva
  if Trim(GMCodiceGruppo5.Text) = '' then
  begin
    GMCodiceGruppo6.Text := '';
    GMDescGruppo6.Text := '';
    GMCodiceGruppo6.Color := GMGruppiTitolo.Color;
    GMDescGruppo6.Color := GMGruppiTitolo.Color;
    GMCodiceGruppo6.TabStop := False;
    BitBtnGruppo6.Enabled := False;
  end
  else
  begin
    GMCodiceGruppo6.Color := GMCodiceGruppo1.Color;
    GMDescGruppo6.Color := GMCodiceGruppo1.Color;
    GMCodiceGruppo6.TabStop := True;
    BitBtnGruppo6.Enabled := True;
  end;
end;

procedure TClientiForm.Stampa2Click(Sender: TObject);
begin
  if DM1.Messaggi('Stampa Listino/Catalogo figurato',
    'ATTENZIONE !!!'#13#13'L''operazione potrebbe richiedere molto tempo durante il quale si consiglia di non utilizzare il computer per altri scopi.'#13#13'Vuoi continuare ?',
    '', [mbYes, mbNo], 0, nil) <> mrYes then
  begin
    Exit;
  end;
  Application.CreateForm(TListinoQR, ListinoQR);
  try
    if MenuStampe.Tag = 0 then
      ListinoQR.Preview
    else
      ListinoQR.Print;
  finally
    ListinoQR.Free;
  end;
end;

procedure TClientiForm.EsportainformatoPDF2Click(Sender: TObject);
begin
  if DM1.Messaggi('Stampa Listino/Catalogo figurato',
    'ATTENZIONE !!!'#13#13'L''operazione potrebbe richiedere molto tempo durante il quale si consiglia di non utilizzare il computer per altri scopi.'#13#13'Vuoi continuare ?',
    '', [mbYes, mbNo], 0, nil) <> mrYes then
  begin
    Exit;
  end;
  Application.CreateForm(TListinoQR, ListinoQR);
  try
    ListinoQR.DoPDFExport;
  finally
    ListinoQR.Free;
  end;
end;

procedure TClientiForm.PagamentoRiscossionecumulativoRIBAselezionate1Click(Sender: TObject);
begin
  // Prima di tutto  verifica che le scadenze selezionate siano tutte delle RI.BA
  // NB: Adesso  valido per tutte le scadenze
  // if not SoloRIBANellaSelezione then Exit;
  // Visualizza la Form per effettuare il pagamento o la riscossione della scadenza
  Application.CreateForm(TPagamRiscForm, PagamRiscForm);
  PagamRiscForm.Parent := MainForm;
  PagamRiscForm.Mode := 1;
  PagamRiscForm.Show;
end;

procedure TClientiForm.Appuntamentonormale1Click(Sender: TObject);
begin
  DM1.Attendere;
  try
    Application.CreateForm(TImpegnoForm, ImpegnoForm);
    ImpegnoForm.Parent := MainForm;
    ImpegnoForm.CodiceCliente := '0';
    if ClienteCorrente <> '' then
    begin
      ImpegnoForm.CodiceCliente := ClienteCorrente;
    end;
    ImpegnoForm.CodicePratica := PraticaCorrente;
    ImpegnoForm.DataPratica := DataPraticaCorrente;
    ImpegnoForm.TipoImpegno := 'Generico';
    ImpegnoForm.Tag := 2;
    ImpegnoForm.Show;
    // Imposta alcuni valori di default
    ImpegnoForm.QryImpSTART.Value := Agenda.SelStart;
    ImpegnoForm.QryImpFINISH.Value := Agenda.SelFinish;
    ImpegnoForm.QryImpRESOURCEID.Value := Agenda.SelResource.ResourceID;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.SpeedButtonRollOver14Click(Sender: TObject);
begin
  DM1.Attendere;
  try
    // Visualizza la form che permette di selezionare l'articolo da inserire
    // nel documento.
    Application.CreateForm(TArticoliForm, ArticoliForm);
    ArticoliForm.Parent := MainForm;
    ArticoliForm.Tag := 992; // Abilita la selezione dell'articolo
    ArticoliForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.SoloStatoPropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
begin
  // Carica l'elenco dei costruttori
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('SELECT DESCRIZIONE FROM STATI');
    Qry.Open;
    (Sender as TcxComboBox).Properties.Items.Clear;
    (Sender as TcxComboBox).Properties.Items.Add('');
    while not Qry.Eof do
    begin
      (Sender as TcxComboBox).Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.Cambiastatodocumentiselezionati1Click(Sender: TObject);
begin
  // Richiama la selezione dello stato del documento
  // Se  attiva la pagina dell'elenco documenti richima il cambiamento
  // di stato relativo all'elenco documenti, se invece  attiva la pagina
  // del giornale di magazzino, richiama il cambiamento relativo al GM e cosi via.
  if PageControl2.ActivePage = TabDocumenti then
    DM1.SelezionaStato('', nil, 999)
  else if PageControl2.ActivePage = TabMagazzino then
    DM1.SelezionaStato('', nil, 998);
end;

procedure TClientiForm.tvDocCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
begin
  // Solo se non  selezionata
  if not AViewInfo.Selected then
  begin
    // IMposta il colore del Font in base allo stato del documento
    if (not VarIsNull(AViewInfo.GridRecord.Values[tvDoc.GetColumnByFieldName('STATODESCRIZIONE').Index])) and
      (not VarIsNull(AViewInfo.GridRecord.Values[tvDoc.GetColumnByFieldName('STATOFOREGROUND').Index])) then
    begin
      ACanvas.Font.Color := DM1.StrToColor(AViewInfo.GridRecord.Values[tvDoc.GetColumnByFieldName('STATOFOREGROUND').Index], ACanvas.Font.Color);
    end;

    // Se il documento  fuori validit oppure se la data per la consegna della merce  superata...
    if (not VarIsNull(AViewInfo.GridRecord.Values[tvDoc.GetColumnByFieldName('VALIDITADATA').Index])) then
    begin
      if AViewInfo.GridRecord.Values[tvDoc.GetColumnByFieldName('VALIDITADATA').Index] < Date then
      begin
        ACanvas.Brush.Color := clSilver;
      end;
    end;

    // Se il documento ha la data di consegna non nulla...
    if (not VarIsNull(AViewInfo.GridRecord.Values[tvDoc.GetColumnByFieldName('CONSEGNADATA').Index])) and
      ((VarIsNull(AViewInfo.GridRecord.Values[tvDoc.GetColumnByFieldName('CONSEGNATO').Index])) or
      (AViewInfo.GridRecord.Values[tvDoc.GetColumnByFieldName('CONSEGNATO').Index] <> 'T')) then
    begin
      // Se la data di consegna  lontana pi di XXX giorni...
      if Date < (AViewInfo.GridRecord.Values[tvDoc.GetColumnByFieldName('CONSEGNADATA').Index] - DM1.EvidenziaDocumentiConsegnaEntro) then
      begin
        ACanvas.Brush.Color := $00C1FFC1; // Verde
        // Se la data di consegna  precedente la data odierna ma cmq entro XXX giorni
      end
      else if (Date >= (AViewInfo.GridRecord.Values[tvDoc.GetColumnByFieldName('CONSEGNADATA').Index] - DM1.EvidenziaDocumentiConsegnaEntro)) and
        (Date <= AViewInfo.GridRecord.Values[tvDoc.GetColumnByFieldName('CONSEGNADATA').Index]) then
      begin // Giallo
        ACanvas.Brush.Color := $00B0FFFF;
        // Se la data di consegna  stata superata...
      end
      else if Date > AViewInfo.GridRecord.Values[tvDoc.GetColumnByFieldName('CONSEGNADATA').Index] then
      begin
        ACanvas.Brush.Color := $00D2D2FF; // Rosso
      end;
    end;
  end;

  // ===========================================================================
  // TRACCIAMENTO CONTENUTO
  // ---------------------------------------------------------------------------
  ADone := True;
  // Disegna il contenuto della cella in modo standard
  AViewInfo.EditViewInfo.Font := ACanvas.Font;
  AViewInfo.EditViewInfo.TextColor := ACanvas.Font.Color;
  AViewInfo.EditViewInfo.BackgroundColor := ACanvas.Brush.Color;
  AViewInfo.EditViewInfo.Paint(ACanvas);
  // Disegna la linea di separazione verticale se  il caso
  if (AViewInfo.Item.Tag = 0) // Se la propriet Tag della colonna = 0
    or (not AViewInfo.Item.IsLast) and (Sender.Items[AViewInfo.Item.Index + 1].Tag = 0) // Se la propriet Tag della colonna successiva = 0
  then
    ACanvas.DrawComplexFrame(AViewInfo.Bounds, $00D3D3D3, $00D3D3D3, [bRight], 1);
  // Se  la prima colonna a sx
  if (AViewInfo.Item.IsFirst) // Se  la prima colonna a sx
  then
    ACanvas.DrawComplexFrame(AViewInfo.Bounds, $00D3D3D3, $00D3D3D3, [bLeft], 1);
  // Se  l'ultimo record diesgna anche il bordo inferiore
  if AViewInfo.GridRecord.IsLast then
    ACanvas.DrawComplexFrame(AViewInfo.Bounds, $00D3D3D3, $00D3D3D3, [bBottom], 1);
  // ===========================================================================
end;

procedure TClientiForm.Cambiaregistroaidocumentiselezionati1Click(Sender: TObject);
begin
  // Apre la selezione del registro
  try
    DM1.Attendere;
    // Visualizza la form che permette di selezionare l'aliquota IVA da inserire come
    // aliqouta IVA forzata del documento
    Application.CreateForm(TMultiregistroForm, MultiregistroForm);
    MultiregistroForm.Parent := MainForm;
    MultiregistroForm.Tag := 999; // Abilita la seleziona del registro
    MultiregistroForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.Eliminaappuntamentoecreadocumento1Click(Sender: TObject);
var
  Q: TIB_Cursor;
  Cliente, Pratica1: Longint;
  DataPratica1: String;
  IDImpegno: String;
begin
  // Chiede conferma
  if DM1.Messaggi('Chiamata/Appuntamento fatto e crea documento', 'Confermi ?', '', [mbYes, mbNo], 0, nil) <> mrYes then
    Exit;

  DM1.Attendere;
  // Inizializzazione
  IDImpegno := IntToStr(Agenda.SelectedEvents[0].ID);
  Q := TIB_Cursor.Create(nil);
  try
    // Impostazione della query che preleva i dati del cliente e della pratica dell'appuntamento
    Q.DatabaseName := DM1.ArcDBFile;
    Q.IB_Connection := DM1.DBAzienda;
    Q.SQL.Add('SELECT CLIENTE, PRATICA, DATAPRATICA1 FROM IMPEGNI WHERE ID = ' + IDImpegno);
    Q.Open;
    if Q.Eof then
      raise Exception.Create('Appuntamento non trovato, operazione annullata!');
    // CArica i dati dell'appuntamento su variabili temporanee
    Cliente := Q.FieldByName('CLIENTE').AsInteger;
    Pratica1 := Q.FieldByName('PRATICA').AsInteger;
    DataPratica1 := Q.FieldByName('DATAPRATICA1').AsString;

    // Marca l'impegno come "Fatto"
    if DM1.ImpegnoToDoc_MarcaImpegnoComeFatto then
    begin
      Q.Close;
      Q.SQL.Clear;
      Q.SQL.Add('UPDATE IMPEGNI SET FATTO = ''T'' WHERE ID = ' + IDImpegno);
      Q.ExecSQL;
    end;

    // Elimina gli appuntamenti selezionati
    if DM1.ImpegnoToDoc_EliminaImpegno then
      Agenda.DeleteSelectedEvents;

    // Crea il nuovo documento
    if Cliente <> 0 then
    begin
      if Pratica1 <> 0 then
      begin
        DM1.NuovoDocFisc(DM1.ImpegnoToDoc_TipoDoc, '', Cliente, Pratica1, DataPratica1, 1, 0, False, False);
      end
      else
      begin
        DM1.NuovoDocFisc(DM1.ImpegnoToDoc_TipoDoc, '', Cliente, 0, '', 1, 0, False, False);
      end;
    end
    else
    begin
      DM1.NuovoDocFisc(DM1.ImpegnoToDoc_TipoDoc, '', 0, 0, '', 1, 0, False, False);
    end;
  finally
    Q.Free;
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.Eliminaappuntamentoecreadocumento2Click(Sender: TObject);
var
  Q: TIB_Cursor;
  Cliente, Pratica1: Longint;
  DataPratica1: String;
  IDImpegno, TipoImpegno: String;
  DataImpegno: TDate;
  RegistroImpegno: String;
begin
  // Chiede conferma
  if DM1.Messaggi('Chiamata/Appuntamento fatto e crea documento', 'Confermi ?', '', [mbYes, mbNo], 0, nil) <> mrYes then
    Exit;

  // Se il database  gi in transazione e quindi significa che c' stato qualche problema
  // a qualche transazione precedente che potrebbe causare una perdita di dati. Quindi
  // avverte l'utente e lo informa che ilprogramma si chideer automaticamente.
  // Verifica che non ci siano gi transazioni in atto e se ci sono lanca un allarme
  DM1.CheckForAlreadyInTransaction;

  DM1.Attendere;
  // Recupera alcuni valori per comodit
  IDImpegno := IntToStr(tvImpegni.DataController.Values[tvImpegni.DataController.FocusedRecordIndex, tvImpegniID.Index]);
  TipoImpegno := VarToStr(tvImpegni.DataController.Values[tvImpegni.DataController.FocusedRecordIndex, tvImpegniTIPOIMPEGNO.Index]);
  RegistroImpegno := VarToStr(tvImpegni.DataController.Values[tvImpegni.DataController.FocusedRecordIndex, tvImpegniREGISTRO.Index]);
  if TipoImpegno = 'Chiamata' then
    DataImpegno := VarToDateTime(tvImpegni.DataController.Values[tvImpegni.DataController.FocusedRecordIndex, tvImpegniCHIAMATA.Index])
  else
    DataImpegno := VarToDateTime(tvImpegni.DataController.Values[tvImpegni.DataController.FocusedRecordIndex, tvImpegniSTART.Index]);
  // Inizializzazione
  Q := TIB_Cursor.Create(nil);
  try
    // Impostazione della query che preleva i dati del cliente e della pratica dell'appuntamento
    Q.DatabaseName := DM1.ArcDBFile;
    Q.IB_Connection := DM1.DBAzienda;
    Q.SQL.Add('SELECT CLIENTE, PRATICA, DATAPRATICA1 FROM IMPEGNI WHERE ID = ' + IDImpegno);
    Q.Open;
    if Q.Eof then
      raise Exception.Create('Chiamata/Appuntamento non trovato, operazione annullata!');
    // CArica i dati dell'appuntamento su variabili temporanee
    Cliente := Q.FieldByName('CLIENTE').AsInteger;
    Pratica1 := Q.FieldByName('PRATICA').AsInteger;
    DataPratica1 := Q.FieldByName('DATAPRATICA1').AsString;

    // Marca l'impegno come "Fatto"
    if DM1.ImpegnoToDoc_MarcaImpegnoComeFatto then
    begin
      Q.Close;
      Q.SQL.Clear;
      Q.SQL.Add('UPDATE IMPEGNI SET FATTO = ''T'' WHERE ID = ' + IDImpegno);
      Q.ExecSQL;
    end;

    // Elimina gli appuntamenti selezionati
    if DM1.ImpegnoToDoc_EliminaImpegno then
      tvImpegni.DataController.DeleteFocused;

    // Crea il nuovo documento
    if Cliente <> 0 then
    begin
      if Pratica1 <> 0 then
      begin
        DM1.NuovoDocFisc(DM1.ImpegnoToDoc_TipoDoc, '', Cliente, Pratica1, DataPratica1, 1, 0, False, False);
      end
      else
      begin
        DM1.NuovoDocFisc(DM1.ImpegnoToDoc_TipoDoc, '', Cliente, 0, '', 1, 0, False, False);
      end;
    end
    else
    begin
      DM1.NuovoDocFisc(DM1.ImpegnoToDoc_TipoDoc, '', 0, 0, '', 1, 0, False, False);
    end;
    // Aggiunge il rigo di riferimento
    PreventiviOrdiniForm.AggiungiRigoRiferimentoSemplice(TipoImpegno, RegistroImpegno, StrToInt(IDImpegno), DataImpegno);
  finally
    Q.Free;
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.GoToNuovoAppuntamento(TipoImpegno: String);
var
  LO: TMemIniFile;
  Sezione: String;
begin
  Sezione := 'Appuntamenti';
  LO := TMemIniFile.Create(DM1.Repository_Layouts.FullLocalFileName);
  try
    // Se non c' una pratica selezionata e invece ci dopvrebbe essere...
    if (PraticaCorrente = '') and LO.ReadBool(Sezione, 'NuovoDocSoloConPraticaSelezionata', False) then
    begin
      // Nel caso appunto il flag indichi che  consenito l'emissione di un nuovo documento
      // solo se c' una pratica selezionata visualizza un avvertimenti e non prosegue.
      DM1.Messaggi('Nuovo appuntamento', 'Prima  necessario selezionare una Pratica/Cantiere.', '', [mbOk], 0, nil);
      Exit;
    end;
    // Se non c' una pratica selezionata e invece ci dopvrebbe essere...
    if (ClienteCorrente = '') and LO.ReadBool(Sezione, 'NuovoDocSoloConClienteSelezionato', False) then
    begin
      // Nel caso appunto il flag indichi che  consenito l'emissione di un nuovo documento
      // solo se c' un soggetto selezionato visualizza un avvertimenti e non prosegue.
      DM1.Messaggi('Nuovo appuntamento', 'Prima  necessario selezionare una Soggetto.', '', [mbOk], 0, nil);
      Exit;
    end;
    // Crea il nuovo appuntamento.
    Application.CreateForm(TImpegnoForm, ImpegnoForm);
    ImpegnoForm.Parent := MainForm;
    ImpegnoForm.CodiceCliente := '0';
    if ClienteCorrente <> '' then
    begin
      ImpegnoForm.CodiceCliente := ClienteCorrente;
    end;
    ImpegnoForm.CodicePratica := PraticaCorrente;
    ImpegnoForm.DataPratica := DataPraticaCorrente;
    ImpegnoForm.TipoImpegno := TipoImpegno;
    ImpegnoForm.Tag := 2;
    ImpegnoForm.Show;
  finally
    LO.Free;
  end;
end;

procedure TClientiForm.ChiamataAppuntamentodiassistenza1Click(Sender: TObject);
begin
  DM1.Attendere;
  try
    GoToNuovoAppuntamento('Chiamata');
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.Appuntamentonormale2Click(Sender: TObject);
begin
  DM1.Attendere;
  try
    GoToNuovoAppuntamento('Generico');
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.tvImpegniDataControllerSortingChanged(Sender: TObject);
begin
  // F rifare l'interrogazione con il nuovo ordinamento
  // NB: Solo se non c' alcun raggruppamento
  if tvImpegni.DataController.DataModeController.GridMode and (tvImpegni.GroupedColumnCount = 0) then
    RxSpeedButtonTrovaClick(Self);
  tvImpegni.Controller.GotoFirst(False);
end;

procedure TClientiForm.MarcacomeConsegnatiidocumentiselezionati1Click(Sender: TObject);
begin
  SetConsegnatoDocSel;
end;

procedure TClientiForm.SoloRegistroPropertiesChange(Sender: TObject);
begin
  if SoloRegistro.Text <> '' then
    TranneRegistro.Text := '';
end;

procedure TClientiForm.CausalePropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
begin
  // Carica l'elenco dei costruttori
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('SELECT DESCRIZIONE FROM CAUSALI');
    Qry.Open;
    (Sender as TcxComboBox).Properties.Items.Clear;
    (Sender as TcxComboBox).Properties.Items.Add('');
    while not Qry.Eof do
    begin
      (Sender as TcxComboBox).Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.Stampacumulativadeidocumentiselezionati1Click(Sender: TObject);
var
  DocType, Registro: String;
  DocNum, I, SelRec: Integer;
  DocDate: TDate;
begin
  // SelRec contiene il numeero di records selezionati
  SelRec := tvDoc.Controller.SelectedRecordCount;
  // Chiede prima conferma

  if (DM1.Messaggi('Stampa cumulativa documenti', 'Stampare tutti i documenti selezionati?',
    'NB: Questa funzione stamper solo i documenti tipo Fatture, DDT, Preventivi ecc.', [mbYes, mbNo], 0, nil) = mrYes) then
  begin
    // Messaggi di attesa solo se non  una preview
    if MenuStampe.Tag <> 0 then
    begin
      DM1.Attendere;
      DM1.ShowWait('Stampa cumulativa documenti', 'Operazione in corso...');
    end;
    try
      // Cicla per tutti i righi selezionati
      for I := SelRec - 1 downto 0 do
      begin
        tvDoc.Controller.SelectedRecords[I].Focused := True;
        // Assegna il tipo, numero, data e registro del documento a delle variabili locali per comodit successiva
        DocType := tvDoc.Controller.FocusedRow.Values[tvDoc.GetColumnByFieldName('TIPODOC').Index];
        DocDate := tvDoc.Controller.FocusedRow.Values[tvDoc.GetColumnByFieldName('DATADOC').Index];
        Registro := tvDoc.Controller.FocusedRow.Values[tvDoc.GetColumnByFieldName('REGISTRO').Index];
        DocNum := tvDoc.Controller.FocusedRow.Values[tvDoc.GetColumnByFieldName('CODICEDOC').Index];
        // Controlla i permessi per l'eliminazione
        if ((DocType = 'Preventivo') or (DocType = 'Ordine') or (DocType = 'S.A.L.') or (DocType = 'D.D.T.') or (DocType = 'Fattura') or
          (DocType = 'Nota_accre') or (DocType = 'Ord.fornit') or (DocType = 'Bolla_entr') or (DocType = 'Fatt.acqui') or (DocType = 'Ricev.fisc') or
          (DocType = 'Fatt.R.F.') or (DocType = 'Buono_cons') or (DocType = 'N.C.fornit')) and (DM1.ControllaDocumento(DocType) > 1) then
        begin
          RxSpeedButtonVisualizzaClick(RxSpeedButtonVisualizza);
          Application.ProcessMessages; // *** NON TOGLIERE ALTRIMENTI NELLA 2, 4, 6 ECC. STAMPA (LE PARI) NON STAMPA I TOTALI DEL DOCUMENTO
          // Anteprima
          if MenuStampe.Tag = 0 then
          begin
            PreventiviOrdiniForm.Anteprimadistampa1Click(PreventiviOrdiniForm.Anteprimadistampa1);
            Application.ProcessMessages; // *** NON TOGLIERE ALTRIMENTI NELLA 2, 4, 6 ECC. STAMPA (LE PARI) NON STAMPA I TOTALI DEL DOCUMENTO
            // Stampa
          end
          else
          begin
            PreventiviOrdiniForm.RxSpeedButtonStampaClick(PreventiviOrdiniForm.RxSpeedButtonStampa);
            Application.ProcessMessages; // *** NON TOGLIERE ALTRIMENTI NELLA 2, 4, 6 ECC. STAMPA (LE PARI) NON STAMPA I TOTALI DEL DOCUMENTO
          end;
          PreventiviOrdiniForm.Close;
          Application.ProcessMessages; // *** NON TOGLIERE ALTRIMENTI NELLA 2, 4, 6 ECC. STAMPA (LE PARI) NON STAMPA I TOTALI DEL DOCUMENTO
          // Se il documento attuale non  tra quelli stampabili cumulativamente avverte l'utente che non verr stampato
        end
        else
        begin
          DM1.Messaggi('Stampa cumulativa documenti', 'Il documento "' + DocType + ' n ' + IntToStr(DocNum) + Registro + ' del ' + DateToStr(DocDate) +
            '" non  compatibile con la stampa cumulativa.'#13#13'Il documento non verr stampato!', '', [mbOk], 0, nil);
        end;
      end;
    finally
      DM1.ChiudiAttendere;
      DM1.CloseWait;
      DM1.Messaggi('Stampa cumulativa documenti', 'Operazione terminata!', '', [mbOk], 0, nil);
    end;
  end;
end;

procedure TClientiForm.TipoImportoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
var
  Voce: Byte;
  CLB: TCheckListBox;
begin
  // CLB contiene il riferimento al chiamante
  CLB := (Sender as TCheckListBox);
  // INdividua quale voce si trova sotto la freccia del mouse
  Voce := CLB.ItemAtPos(CLB.ScreenToClient(Mouse.CursorPos), True);
  // Solo se il mouse era su una voce
  if Voce <> -1 then
  begin
    // La voce sotto la quale si trova il mouse viene checkata, l'altra no
    CLB.Checked[0] := False;
    CLB.Checked[1] := False;
    CLB.Checked[Voce] := True;
  end;
  // Se  stato cliccato con il pulsante dx del mouse avvia anche la ricerca
  if Button = mbRight then
    RxSpeedButtonTrovaClick(Self);
  // F in modo che non resti una voce selezionata e quindi evidenziata che non mi piace
  CLB.ItemIndex := -1;
end;

procedure TClientiForm.tvRubricaCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
var
  GR: TcxCustomGridRecord;
begin
  // GR punta al record corrente
  GR := AViewInfo.GridRecord;

  // Se il rigo del filtro (FilterRow) usa il colore specificato appositamente
  // in ogni caso, anche se  il rigo selezionato che mi piace di pi
  if (AViewInfo.GridRecord as TcxCustomGridRow).IsFilterRow then
  begin
    ACanvas.Brush.Color := (Sender as TcxGridDBTableView).Styles.FilterRowInfoText.Color;
    Exit;
  end;

  // Solo se non  selezionata
  if not AViewInfo.Selected then
  begin
    // IMposta il colore del Font in base allo stato del documento
    if (not VarIsNull(AViewInfo.GridRecord.Values[tvRubrica.GetColumnByFieldName('STATODESCRIZIONE').Index])) and
      (not VarIsNull(AViewInfo.GridRecord.Values[tvRubrica.GetColumnByFieldName('STATOFOREGROUND').Index])) then
    begin
      ACanvas.Font.Color := DM1.StrToColor(AViewInfo.GridRecord.Values[tvRubrica.GetColumnByFieldName('STATOFOREGROUND').Index], ACanvas.Font.Color);
    end;
  end;

  // Se la riga  espansa la visualizza con il colore di sfondo opportuno
  if GR.Expanded then
  begin
    ACanvas.Brush.Color := lvArt.Styles.TabsBackground.Color;
    ACanvas.Font.Color := lvArt.Styles.TabsBackground.TextColor;
    // ACanvas.Font.Style := [fsBold];
  end;

  // ===========================================================================
  // TRACCIAMENTO CONTENUTO
  // ---------------------------------------------------------------------------
  ADone := True;
  // Disegna il contenuto della cella in modo standard
  AViewInfo.EditViewInfo.Font := ACanvas.Font;
  AViewInfo.EditViewInfo.TextColor := ACanvas.Font.Color;
  AViewInfo.EditViewInfo.BackgroundColor := ACanvas.Brush.Color;
  AViewInfo.EditViewInfo.Paint(ACanvas);
  // Disegna la linea di separazione verticale se  il caso
  if (AViewInfo.Item.Tag = 0) // Se la propriet Tag della colonna = 0
    or (not AViewInfo.Item.IsLast) and (Sender.Items[AViewInfo.Item.Index + 1].Tag = 0) // Se la propriet Tag della colonna successiva = 0
  then
    ACanvas.DrawComplexFrame(AViewInfo.Bounds, $00D3D3D3, $00D3D3D3, [bRight], 1);
  // Se  la prima colonna a sx
  if (AViewInfo.Item.IsFirst) // Se  la prima colonna a sx
  then
    ACanvas.DrawComplexFrame(AViewInfo.Bounds, $00D3D3D3, $00D3D3D3, [bLeft], 1);
  // Se  l'ultimo record diesgna anche il bordo inferiore
  if AViewInfo.GridRecord.IsLast then
    ACanvas.DrawComplexFrame(AViewInfo.Bounds, $00D3D3D3, $00D3D3D3, [bBottom], 1);
  // ===========================================================================
end;

procedure TClientiForm.cxComboBox1PropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
begin
  // Carica l'elenco dei costruttori
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('SELECT DESCRIZIONE FROM STATI WHERE TIPODOCUMENTO=''Cantieri/Pratiche''');
    Qry.Open;
    (Sender as TcxComboBox).Properties.Items.Clear;
    while not Qry.Eof do
    begin
      (Sender as TcxComboBox).Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.SoggStatoPropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
begin
  // Carica l'elenco dei costruttori
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('SELECT DESCRIZIONE FROM STATI WHERE TIPODOCUMENTO=''Soggetti''');
    Qry.Open;
    (Sender as TcxComboBox).Properties.Items.Clear;
    (Sender as TcxComboBox).Properties.Items.Add('');
    while not Qry.Eof do
    begin
      (Sender as TcxComboBox).Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.QryArticoliAfterOpen(DataSet: TDataSet);
begin
  if not QryArtListForn.Active then
    QryArtListForn.Open;
end;

procedure TClientiForm.tvLFPREZZODILISTINOGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: string);
begin
  if VarIsNull(ARecord.Values[Sender.Index]) or (ARecord.Values[Sender.Index] = 0) then
    AText := '- - -';
end;

procedure TClientiForm.tvLFCODICEARTICOLOFORNITOREGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: string);
begin
  if VarIsNull(ARecord.Values[Sender.Index]) or (Trim(ARecord.Values[Sender.Index]) = '') then
    AText := '- - -';
end;

procedure TClientiForm.tvArtDataControllerDetailExpanded(ADataController: TcxCustomDataController; ARecordIndex: Integer);
begin
  // Se il campo CODICEARTICOLO della row attuale della griglia  nulla
  // esce subito altrimenti da degli errori
  if VarIsNull(ADataController.Values[ARecordIndex, tvArtCODICEARTICOLO.Index]) then
  begin
    if QryArtMag.Active then
      QryArtMag.Close;
    if QryArtListForn.Active then
      QryArtListForn.Close;
    Exit;
  end;

  GridArt.BeginUpdate;
  try

    // ===========================================================================
    // PARTE CHE APRE LE QUERY DEI LISTINI FORNITORI
    // ---------------------------------------------------------------------------
    // Se non ci sono i records relativi all'articolo li crea
    DM1.ControlloFornitoriArticolo(ADataController.Values[ARecordIndex, tvArtCODICEARTICOLO.Index]);
    // Reimposta la query per visualizzare solo i dettagli dell'articolo attuale.
    if QryArtListForn.Active then
      QryArtListForn.Close;
    if not QryArtListForn.Prepared then
      QryArtListForn.Prepare;
    QryArtListForn.ParamByName('CODICEARTICOLO').AsString := ADataController.Values[ARecordIndex, tvArtCODICEARTICOLO.Index];
    QryArtListForn.Open;
    // ===========================================================================

    // ===========================================================================
    // PARTE CHE APRE LE QUERY DEI DETTAGLI MAGAZZINO
    // ---------------------------------------------------------------------------
    if QryArtMag.Active then
      QryArtMag.Close;
    if not QryArtMag.Prepared then
      QryArtMag.Prepare;
    QryArtMag.Params.ParamByName('P_CODART').AsString := ADataController.Values[ARecordIndex, tvArtCODICEARTICOLO.Index];
    QryArtMag.Params.ParamByName('P_DATARICHIESTA').AsDateTime := GetDataFiltroRicerca;
    QryArtMag.Open;
    // Calcolo dei totali in variabili appoggioglobali
    // NB: HO dovuto fare cos perch altrimenti in GridMode=True i totali non funziano.
    QryArtMag.DisableControls;
    try
      QryArtMag.First;
      fTotaliArtMag_Giacenza := 0;
      fTotaliArtMag_Impegnato := 0;
      fTotaliArtMag_Ordinato := 0;
      fTotaliArtMag_Disponibile := 0;
      while not QryArtMag.Eof do
      begin
        fTotaliArtMag_Giacenza := fTotaliArtMag_Giacenza + QryArtMagGIACENZA.AsFloat;
        fTotaliArtMag_Impegnato := fTotaliArtMag_Impegnato + QryArtMagIMPEGNATO.AsFloat;
        fTotaliArtMag_Ordinato := fTotaliArtMag_Ordinato + QryArtMagORDINATO.AsFloat;
        QryArtMag.Next;
      end;
      fTotaliArtMag_Disponibile := fTotaliArtMag_Giacenza - fTotaliArtMag_Impegnato;
    finally
      QryArtMag.EnableControls;
    end;
    // ===========================================================================

  finally
    GridArt.EndUpdate;
  end;

end;

procedure TClientiForm.tvArtDataControllerDetailExpanding(ADataController: TcxCustomDataController; ARecordIndex: Integer; var AAllow: Boolean);
begin
  tvArt.DataController.CollapseDetails;
end;

procedure TClientiForm.tvGMCustomDrawGroupCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableCellViewInfo; var ADone: Boolean);
var
  CI: Integer;
  DescrizioneAggiuntiva: String;
begin
  // Inizializzazione
  DescrizioneAggiuntiva := '';
  // CI contiene l'Index della colonna che st visualizzanto
  // NB: Ho preso questa forma dal NewGroup e non ho capito bene come funziona
  CI := Sender.GroupedItems[AViewInfo.GridRecord.Level].Index;
  // Se la casella di raggruppaento che si st visualizzando  relativa
  // al CodiceArticolo allora provvede a fornire anche la Descrizione dell'articolo
  // oltre al Codice Articolo.
  if CI = tvGMCODICEARTICOLO.Index then
  begin
    DescrizioneAggiuntiva := ' - ' + LeftStr(tvGM.DataController.DisplayTexts[AViewInfo.GridRecord.RecordIndex, tvGMDESCRIZIONE.Index], 50);
  end;
  // Richiama la gestione predefinita dell'evento
  DM1.QGridCustomDrawGroupCell(Sender, ACanvas, AViewInfo, ADone, DescrizioneAggiuntiva);
end;

procedure TClientiForm.SpeedButton4Click(Sender: TObject);
begin
  tvRubrica.ViewData.Expand(True);
end;

procedure TClientiForm.SpeedButton3Click(Sender: TObject);
begin
  tvRubrica.ViewData.Collapse(True);
end;

procedure TClientiForm.SpeedButton7Click(Sender: TObject);
begin
  tvGM.ViewData.Collapse(True);
end;

procedure TClientiForm.SpeedButton8Click(Sender: TObject);
begin
  tvGM.ViewData.Expand(True);
end;

procedure TClientiForm.SpeedButton9Click(Sender: TObject);
begin
  tvCV.ViewData.Collapse(True);
end;

procedure TClientiForm.SpeedButtonFiltersClick(Sender: TObject);
begin
  // Attiva/Disattiva la Filter Row
  tvDoc.FilterRow.Visible := (Sender as TSpeedButton).Down;
  if tvDoc.FilterRow.Visible then
    tvDoc.FilterBox.Visible := TcxGridFilterVisible.fvAlways
  else
  begin
    tvDoc.DataController.Filter.Clear;
    tvDoc.FilterBox.Visible := TcxGridFilterVisible.fvNonEmpty
  end;
end;

procedure TClientiForm.SpeedButton10Click(Sender: TObject);
begin
  tvCV.ViewData.Expand(True);
end;

procedure TClientiForm.SpeedButton13Click(Sender: TObject);
var
  I: Integer;
begin
  PivotGridScad.BeginUpdate;
  try
    for I := 0 to PivotGridScad.FieldCount - 1 do
      PivotGridScad.Fields[I].CollapseAll;
  finally
    PivotGridScad.EndUpdate;
  end;
end;

procedure TClientiForm.SpeedButton14Click(Sender: TObject);
var
  I: Integer;
begin
  PivotGridScad.BeginUpdate;
  try
    for I := 0 to PivotGridScad.FieldCount - 1 do
      PivotGridScad.Fields[I].ExpandAll;
  finally
    PivotGridScad.EndUpdate;
  end;
end;

procedure TClientiForm.SpeedButton15Click(Sender: TObject);
begin
  tvArt.ViewData.Collapse(True);
end;

procedure TClientiForm.SpeedButton16Click(Sender: TObject);
begin
  tvArt.ViewData.Expand(True);
end;

procedure TClientiForm.SpeedButton17Click(Sender: TObject);
begin
  tvGM.ViewData.Collapse(False);
end;

procedure TClientiForm.SpeedButton18Click(Sender: TObject);
begin
  tvGM.ViewData.Expand(False);
end;

procedure TClientiForm.SpeedButton19Click(Sender: TObject);
begin
  // Attiva/Disattiva la Filter Row
  tvGM.FilterRow.Visible := (Sender as TSpeedButton).Down;
  if tvGM.FilterRow.Visible then
    tvGM.FilterBox.Visible := TcxGridFilterVisible.fvAlways
  else
  begin
    if not tvGM.FilterRow.Visible then
      tvGM.DataController.Filter.Clear;
    tvGM.FilterBox.Visible := TcxGridFilterVisible.fvNonEmpty
  end;
end;

procedure TClientiForm.SoloSoggettoPropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
begin
  // Carica l'elenco dei costruttori
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('SELECT DISTINCT CLIENTEFORNITORE FROM CLIENTI');
    Qry.Open;
    (Sender as TcxComboBox).Properties.Items.Clear;
    (Sender as TcxComboBox).Properties.Items.Add('');
    while not Qry.Eof do
    begin
      (Sender as TcxComboBox).Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.RxSpeedButtonMailClick(Sender: TObject);
var
  ClientPoint, ScreenPoint: TPoint;
begin
  // Esegue la conversione delle coordinate dove dovr apparire il men
  // da coordinate client della finestra a coordinate assolute dello schermo.
  // (NB: Il men popup apparir in prossimit del tasto NUOVO)
  ClientPoint.X := RxSpeedButtonStampa.Left + POPUP_X_OFFSET + ClientTopPanel.Left;
  ClientPoint.Y := RxSpeedButtonStampa.Top + POPUP_Y_OFFSET;
  ScreenPoint := ClientToScreen(ClientPoint);
  // Imposta la propriet TAG del men (0=Anteprima, 1=Stampa, 2=Fax, 3=Email)
  MenuStampe.Tag := 3;
  MenuStampe.Popup(ScreenPoint.X, ScreenPoint.Y);
end;

procedure TClientiForm.SBGMTuttiClick(Sender: TObject);
var
  I: Byte;
begin
  // Cicla per tutti i documenti di vendita e li seleziona tutti
  if GMVendite.Items.Count > 0 then
    for I := 0 to GMVendite.Items.Count - 1 do
      GMVendite.Items[I].Checked := True;

  // Cicla per tutti i documenti di acquisto  e li seleziona tutti
  if GMAcquisti.Items.Count > 0 then
    for I := 0 to GMAcquisti.Items.Count - 1 do
      GMAcquisti.Items[I].Checked := True;
end;

procedure TClientiForm.SBGMTuttiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    SBGMTuttiClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.SBGMNessunoClick(Sender: TObject);
var
  I: Byte;
begin
  // Cicla per tutti i documenti di vendita e li seleziona tutti
  if GMVendite.Items.Count > 0 then
    for I := 0 to GMVendite.Items.Count - 1 do
      GMVendite.Items[I].Checked := False;

  // Cicla per tutti i documenti di acquisto  e li seleziona tutti
  if GMAcquisti.Items.Count > 0 then
    for I := 0 to GMAcquisti.Items.Count - 1 do
      GMAcquisti.Items[I].Checked := False;
end;

procedure TClientiForm.SBGMNessunoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    SBGMNessunoClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.RBTipoMovMagazzinoClick(Sender: TObject);
begin
  CLBSegnoOpMagazzino.Enabled := RBTipoMovMagazzino.Checked;
  CLBSegnoOpCantiere.Enabled := RBTipoMovCantiere.Checked;
end;

procedure TClientiForm.CLBSegnoOpMagazzinoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
var
  CheckIndex: Integer;
  CurrCheckListBox: TCheckListBox;
  I: Integer;
begin
  // ----------------------------------------------------------------------------------------------------
  // Questo codice server per fare in modo che anche se l'utente clicca sul titolo della voce, questa
  // venga selezinata o deselezionata come se si fosse cliccato sul riquadrino del segno di check)
  // ----------------------------------------------------------------------------------------------------
  // La variabie CurrCheckListBox Punta alla CheckListBox che ha richiamata l'evento
  CurrCheckListBox := Sender as TCheckListBox;
  // Solo se s cliccato con il pulsante SX del mouse
  if Button = mbLeft then
  begin
    // Quale voce si trova sotto il mouse?
    CheckIndex := CurrCheckListBox.ItemAtPos(Point(X, Y), True);
    // Se c'era una voce cambia il suo stato
    if CheckIndex <> -1 then
    begin
      if CurrCheckListBox.Tag = 0 then
        CurrCheckListBox.Checked[CheckIndex] := not CurrCheckListBox.Checked[CheckIndex];
      // Rimette la Propriet Tag del componente = 0
      CurrCheckListBox.Tag := 0;
    end;
    // Se invece  stato premuto il pulsante DX
  end
  else if Button = mbRight then
  begin
    // Quale voce si trova sotto il mouse?
    CheckIndex := CurrCheckListBox.ItemAtPos(Point(X, Y), True);
    // Deseleziona tutti i documenti
    for I := 0 to CurrCheckListBox.Items.Count - 1 do
      CurrCheckListBox.Checked[I] := False;
    // Chekka il documento
    CurrCheckListBox.Checked[CheckIndex] := True;
    // Esegue la ricerca
    RxSpeedButtonTrovaClick(Self);
  end;
  // F in modo che non resti una voce selezionata e quindi evidenziata che non mi piace
  CurrCheckListBox.ItemIndex := -1;
  // ----------------------------------------------------------------------------------------------------
end;

procedure TClientiForm.Stampaagenda1Click(Sender: TObject);
begin
  // Se siamo in FastSelectionMode lancia la stampa dell'agenda laterale e poi esce
  if DM1.FastSelectionMode then
  begin
    // Lancia la stampa in base alla modalit scelta (preview, stampa ecc.)
    if MenuStampe.Tag = 0 then
    begin
      AgendaForm.StampaAgenda(apmPreview);
      // Stampa
    end
    else if MenuStampe.Tag = 1 then
    begin
      AgendaForm.StampaAgenda(apmPrint);
      // Mail
    end
    else if MenuStampe.Tag = 3 then
    begin
      AgendaForm.StampaAgenda(apmEmail);
    end;
    // esce
    Exit;
  end;

  // Altrimenti continua cona la stampa dall'agenda vecchia
  if Agenda.ViewDay.Active then
    AgendaLink.PrintStyles.Daily.Active := True
  else if Agenda.ViewTimeGrid.Active then
    AgendaLink.PrintStyles.Daily.Active := True
  else if Agenda.ViewWeek.Active then
    AgendaLink.PrintStyles.Weekly.Active := True
  else if Agenda.ViewWeeks.Active then
    AgendaLink.PrintStyles.Weekly.Active := True
  else if Agenda.ViewYear.Active then
    AgendaLink.PrintStyles.Yearly.Active := True;
  // Preview
  if MenuStampe.Tag = 0 then
  begin
    dxPrinter.Preview(True, AgendaLink);
    // Stampa
  end
  else if MenuStampe.Tag = 1 then
  begin
    dxPrinter.Print(True, nil, AgendaLink);
    // Mail
  end
  else if MenuStampe.Tag = 3 then
  begin
    DM1.SaveDefaultPrinter;
    try
      DM1.SetPdfPrinterAsDefault;
      dxPrinter.Print(False, nil, AgendaLink);
    finally
      DM1.RestoreDefaultPrinter;
    end;
  end;
end;

procedure TClientiForm.Stampapartitario1Click(Sender: TObject);
var
  PrecFontSize: Integer;
begin
  // Se la form relativa al Tab del Partitario non esiste esce subito.
  if TabPartitarioForm = nil then
    raise Exception.Create('Form Tab Partitario non esistente!');
  // Collega la griglia corretta
  Self.GridPrimanotaLink.Component := TabPartitarioForm.GetCurrentGrid;
  // Imposta la stringa su cui viene costruito il range di date della stampa in base ai filtri per data
  if Self.GridPrimanotaLink.Component = TabPartitarioForm.GridPart then
  begin
    Self.GridPrimanotaLink.ReportTitle.Text := 'Partitario';
    DM1.SetReportDateRange(TabPartitarioForm.PartFilterDal.EditText, TabPartitarioForm.PartFilterAl.EditText);
  end
  else if Self.GridPrimanotaLink.Component = TabPartitarioForm.GridPartIva then
  begin
    Self.GridPrimanotaLink.ReportTitle.Text := 'Partitario IVA';
    DM1.SetReportDateRange(TabPartitarioForm.PartIvaFilterDal.EditText, TabPartitarioForm.PartIvaFilterAl.EditText);
  end
  else if Self.GridPrimanotaLink.Component = TabPartitarioForm.GridPartAltro then
  begin
    Self.GridPrimanotaLink.ReportTitle.Text := 'Partitario';
    DM1.SetReportDateRange(TabPartitarioForm.PartAltroFilterDal.EditText, TabPartitarioForm.PartAltroFilterAl.EditText);
  end;
  // Preview
  if MenuStampe.Tag = 0 then
  begin
    ClientiForm.dxPrinter.Preview(True, ClientiForm.GridPrimanotaLink);
    // Stampa
  end
  else if MenuStampe.Tag = 1 then
  begin
    ClientiForm.dxPrinter.Print(True, nil, ClientiForm.GridPrimanotaLink);
  end;
end;

procedure TClientiForm.QryDocCalcFields(DataSet: TDataSet);
var
  LNotificationWaitDays: Integer;
begin
  QryDocIMPORTONETTORITACC.Value := QryDocIMPORTO.AsCurrency + QryDocRITENUTAACCONTO.AsCurrency;

  QryDocANNO.Value := DateUtils.YearOf(QryDocDATADOC.AsDateTime);
  QryDocSEMESTRE.AsString := DM2.DateTimeToSemestre(QryDocDATADOC.AsDateTime);
  QryDocTRIMESTRE.AsString := DM2.DateTimeToTrimestre(QryDocDATADOC.AsDateTime);

  QryDocCHART_DESCRIZIONE.AsString := Format('%s %d%s del ', [QryDocTIPODOC.AsString, QryDocCODICEDOC.AsInteger, QryDocREGISTRO.AsString]);
  QryDocCHART_DESCRIZIONE.AsString := QryDocCHART_DESCRIZIONE.AsString + FormatDateTime('dd/mm/yyyy', QryDocDATADOC.AsDateTime);

  // Se  una fattura, nota di credito
  if (QryDocTIPODOC.AsString = 'Fattura') or (QryDocTIPODOC.AsString = 'Nota_accre') then
  begin
    // Calcola quanti giorni sono trascorsi dall'ultima notifica
    // NB: Se non c' una data di ultima notifica ricevuta significa che ancora non  stato
    // nemmeno creato l'XML per questo documento, quindi assume un NotificationWaytDays
    // di 10 giorni (giorni a disposizione per tentare il primo avvio) e calcola i giorni
    // DaysFromNotification a partire dalla data del documento stesso.
    // NB: Quanto sopra anche in caso lo status sia "rtReadyToSend" (XML preparato ma non ancora inviato all'intermediario)
    if QryDocFE_LASTNOTIFICATION.IsNull or (QryDocFE_STATUS.AsString = 'rtReadyToSend') then
    begin
      QryDocFE_DAYSFROMNOTIFICATION.Value := DaysBetween(Now, QryDocDATADOC.AsDateTime);
      LNotificationWaitDays := 10;
      // Valore di default nel caso di fattura per la quale non  ancora stato fatto l'XML e che quindi non ancora alcuna notifica di nessun tipo
    end
    else
    begin
      QryDocFE_DAYSFROMNOTIFICATION.Value := DaysBetween(Now, QryDocFE_LASTNOTIFICATION.AsDateTime);
      LNotificationWaitDays := QryDocFE_NOTIFICATIONWAITDAYS.AsInteger;
    end;
    // Calcola l'indice per l'icona di warning in base al tempo rimanente per la prox. notifica attesa
    // NB: Per le fatture passive non ci deve essere nessun warning
    if LNotificationWaitDays = 0 then
      QryDocFE_TIMINGINDEX.AsInteger := 0
    else
    begin
      QryDocFE_TIMINGINDEX.AsInteger := Trunc(QryDocFE_DAYSFROMNOTIFICATION.AsInteger / (LNotificationWaitDays / 3));
      // NB: Il 3  perch le possibiliicone sono 3 (4 con quella vuota)
      if QryDocFE_TIMINGINDEX.AsInteger > 3 then
        QryDocFE_TIMINGINDEX.AsInteger := 3;
    end;
    // Calcola quanti giorni rimangono prima della scadenza del tempo previsto per la nuova notifica
    QryDocFE_DAYSLEFT.Value := LNotificationWaitDays - QryDocFE_DAYSFROMNOTIFICATION.AsInteger;
    if QryDocFE_DAYSLEFT.AsInteger < 0 then
      QryDocFE_DAYSLEFT.Value := 0;
  end;
  // Se  una fattura, nota di credito, fattura passiva, nota di credito fornitore
  if (QryDocTIPODOC.AsString = 'Fattura') or (QryDocTIPODOC.AsString = 'Nota_accre') or (QryDocTIPODOC.AsString = 'Fatt.acqui') or
    (QryDocTIPODOC.AsString = 'N.C.fornit') then
  begin
    // Calcola lo Stato Esteso, cio che comprende anche l'indicazione sul fatto che il destinatario della fatture
    // sia una PA oppure no
    if (QryDocTIPOPERSONA.AsString = 'P') and ((QryDocFE_STATUS.AsString = 'rtSDIMessageRC') or (QryDocFE_STATUS.AsString = 'rtSDIMessageMC')) then
      QryDocFE_STATUS_EXT.Value := QryDocFE_STATUS.AsString + '_PA'
    else
      QryDocFE_STATUS_EXT.Value := QryDocFE_STATUS.AsString;
  end;
end;

procedure TClientiForm.ControllaSeVisualizzareTotaliRitenuteAcconto;
begin
  // Scadenze
  LabelScadTotRitAcc.Visible := tvScadRITACC.Visible;
  dbeScadTotRitAcc.Visible := tvScadRITACC.Visible;
end;

procedure TClientiForm.tvDocColumnPosChanged(Sender: TcxGridTableView; AColumn: TcxGridColumn);
begin
  // Visualizza o meno i totali relativi alla ritenuta d'acconto in base
  // alla visualizzazione o meno delle relative colonne
  ControllaSeVisualizzareTotaliRitenuteAcconto;
end;

procedure TClientiForm.CreafilepresentazioneRIBAallincasso1Click(Sender: TObject);
begin
  Application.CreateForm(TFormExportRIBA, FormExportRIBA);
  FormExportRIBA.ShowModal;
end;

procedure TClientiForm.Rapportogiornaliero1Click(Sender: TObject);
begin
  DM1.Attendere;
  try
    Application.CreateForm(TRappGiornForm, RappGiornForm);
    RappGiornForm.Parent := MainForm;
    RappGiornForm.Tag := 2;
    RappGiornForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.GOSTipoDatoOrePropertiesChange(Sender: TObject);
begin
  RxSpeedButtonTrovaClick(RxSpeedButtonTrova);
end;

procedure TClientiForm.GOSSuddivisioneOrePropertiesChange(Sender: TObject);
begin
  RxSpeedButtonTrovaClick(RxSpeedButtonTrova);
end;

procedure TClientiForm.cxPageControlGOSChange(Sender: TObject);
begin
  // NB: Solo se non siamo dentro una stampa riepilogativa e cumulativa di cantiere
  if (StampeCantieriForm = nil) and (DM1.GoAutoquery(IDX_AUTOQUERY_GOS)) then
    RxSpeedButtonTrovaClick(RxSpeedButtonTrova);
end;

procedure TClientiForm.cxPageControlGOSOrePageChanging(Sender: TObject; NewPage: TcxTabSheet; var AllowChange: Boolean);
begin
  // Normalmente la PivotGrid  scollegata perch altrimenti causa rallentamenti
  // pesanti in presenza di molti record
  DM1.ShowWait('Levante', 'Caricamento...');
  try
    if NewPage = TabGosOreAda then
      GosOrePivot.DataSource := SourceGOS
    else
      GosOrePivot.DataSource := nil;
  finally
    DM1.CloseWait;
  end;
end;

procedure TClientiForm.cxPageControlGOSSpesePageChanging(Sender: TObject; NewPage: TcxTabSheet; var AllowChange: Boolean);
begin
  // Normalmente la PivotGrid  scollegata perch altrimenti causa rallentamenti
  // pesanti in presenza di molti record
  DM1.ShowWait('Levante', 'Caricamento...');
  try
    if NewPage = TabGosSpeseAda then
      GosSpesePivot.DataSource := SourceGOSSpese
    else
      GosSpesePivot.DataSource := nil;
  finally
    DM1.CloseWait;
  end;
end;

procedure TClientiForm.BtnFilterGosDipendenteClick(Sender: TObject);
begin
  DM1.Attendere;
  try
    Application.CreateForm(TDipendentiForm, DipendentiForm);
    DipendentiForm.Parent := MainForm;
    DipendentiForm.DblClickMode := DblClickModeSelection;
    DipendentiForm.CallerCode := 5;
    DipendentiForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.FilterGosTipoOre1PropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
begin
  // Carica l'elenco dei costruttori
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('SELECT DESCRIZIONE FROM TIPIOREDIPENDENTI WHERE TIPO = ''OREDIP1''');
    Qry.Open;
    FilterGosTipoOre1.Properties.Items.Clear;
    while not Qry.Eof do
    begin
      FilterGosTipoOre1.Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.FilterGosTipoOre2PropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
begin
  // Carica l'elenco dei costruttori
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('SELECT DESCRIZIONE FROM TIPIOREDIPENDENTI WHERE TIPO = ''OREDIP2''');
    Qry.Open;
    FilterGosTipoOre2.Properties.Items.Clear;
    while not Qry.Eof do
    begin
      FilterGosTipoOre2.Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.FilterGosTipoOre3PropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
begin
  // Carica l'elenco dei costruttori
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('SELECT DESCRIZIONE FROM TIPIOREDIPENDENTI WHERE TIPO = ''OREDIP3''');
    Qry.Open;
    FilterGosTipoOre3.Properties.Items.Clear;
    while not Qry.Eof do
    begin
      FilterGosTipoOre3.Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.GOSMesiNessunoClick(Sender: TObject);
begin
  GOSDal.Clear;
  GOSAl.Clear;
  // In questo modo posso metterli tutti in DOWN contemporaneamente
  GOSGen.GroupIndex := 600;
  GOSFeb.GroupIndex := 600;
  GOSMar.GroupIndex := 600;
  GOSApr.GroupIndex := 600;
  GOSMag.GroupIndex := 600;
  GOSGiu.GroupIndex := 600;
  GOSLug.GroupIndex := 600;
  GOSAgo.GroupIndex := 600;
  GOSSet.GroupIndex := 600;
  GOSOtt.GroupIndex := 600;
  GOSNov.GroupIndex := 600;
  GOSDic.GroupIndex := 600;
  GOSGen.Down := False;
  GOSFeb.Down := False;
  GOSMar.Down := False;
  GOSApr.Down := False;
  GOSMag.Down := False;
  GOSGiu.Down := False;
  GOSLug.Down := False;
  GOSAgo.Down := False;
  GOSSet.Down := False;
  GOSOtt.Down := False;
  GOSNov.Down := False;
  GOSDic.Down := False;
end;

procedure TClientiForm.GOSMesiTuttiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    GOSMesiTuttiClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.GOSMesiTuttiClick(Sender: TObject);
begin
  GOSDal.EditText := DM1.FilterDataDalDefault;
  GOSAl.EditText := DM1.FilterDataAlDefault;
  // Se il Tag del pulsante MesiTutti = 1 significa che questo gestore di evento  stato
  // richiamato dall'evento OnChange del PageControl e non per un click dell'utente sul
  // pulsante stesso, quindi imposta le date al primo giorno e all'ultimo dell'anno in corso
  // ma non mette in  Down tutti i pulsanti dei mesi perch mi piace di pi.
  // if ImpMesiTutti.Tag = 0 then begin
  // In questo modo posso metterli tutti in DOWN contemporaneamente
  GOSGen.GroupIndex := 1301;
  GOSFeb.GroupIndex := 1302;
  GOSMar.GroupIndex := 1303;
  GOSApr.GroupIndex := 1304;
  GOSMag.GroupIndex := 1305;
  GOSGiu.GroupIndex := 1306;
  GOSLug.GroupIndex := 1307;
  GOSAgo.GroupIndex := 1308;
  GOSSet.GroupIndex := 1309;
  GOSOtt.GroupIndex := 1310;
  GOSNov.GroupIndex := 1311;
  GOSDic.GroupIndex := 1312;
  GOSGen.Down := False;
  GOSFeb.Down := False;
  GOSMar.Down := False;
  GOSApr.Down := False;
  GOSMag.Down := False;
  GOSGiu.Down := False;
  GOSLug.Down := False;
  GOSAgo.Down := False;
  GOSSet.Down := False;
  GOSOtt.Down := False;
  GOSNov.Down := False;
  GOSDic.Down := False;
  // end else begin
  // Rimette il Tag del pulsante = 0
  GOSMesiTutti.Tag := 0;
  // end;
end;

procedure TClientiForm.GOSMesiNessunoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    GOSMesiNessunoClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.GOSGenMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    (Sender as TSpeedButton).Down := True;
    GOSGenClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.SpeedButtonRollOver16Click(Sender: TObject);
begin
  DM1.Attendere;
  try
    Application.CreateForm(TDipendentiForm, DipendentiForm);
    DipendentiForm.Parent := MainForm;
    DipendentiForm.DblClickMode := DblClickModeSelection;
    DipendentiForm.CallerCode := 6;
    DipendentiForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.FilterGosTipoCosto1PropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
begin
  // Carica l'elenco dei costruttori
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('SELECT DESCRIZIONE FROM TIPIOREDIPENDENTI WHERE TIPO = ''TIPOSPESA1''');
    Qry.Open;
    FilterGosTipoCosto1.Properties.Items.Clear;
    while not Qry.Eof do
    begin
      FilterGosTipoCosto1.Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.FilterGosTipoCosto2PropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
begin
  // Carica l'elenco dei costruttori
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('SELECT DESCRIZIONE FROM TIPIOREDIPENDENTI WHERE TIPO = ''TIPOSPESA2''');
    Qry.Open;
    FilterGosTipoCosto2.Properties.Items.Clear;
    while not Qry.Eof do
    begin
      FilterGosTipoCosto2.Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.FilterGosTipoCosto3PropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
begin
  // Carica l'elenco dei costruttori
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('SELECT DESCRIZIONE FROM TIPIOREDIPENDENTI WHERE TIPO = ''TIPOSPESA3''');
    Qry.Open;
    FilterGosTipoCosto3.Properties.Items.Clear;
    while not Qry.Eof do
    begin
      FilterGosTipoCosto3.Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.GOSSpeseMesiTuttiClick(Sender: TObject);
begin
  GOSSpeseDal.EditText := DM1.FilterDataDalDefault;
  GOSSpeseAl.EditText := DM1.FilterDataAlDefault;
  // Se il Tag del pulsante MesiTutti = 1 significa che questo gestore di evento  stato
  // richiamato dall'evento OnChange del PageControl e non per un click dell'utente sul
  // pulsante stesso, quindi imposta le date al primo giorno e all'ultimo dell'anno in corso
  // ma non mette in  Down tutti i pulsanti dei mesi perch mi piace di pi.
  // if ImpMesiTutti.Tag = 0 then begin
  // In questo modo posso metterli tutti in DOWN contemporaneamente
  GOSSpeseGen.GroupIndex := 1401;
  GOSSpeseFeb.GroupIndex := 1402;
  GOSSpeseMar.GroupIndex := 1403;
  GOSSpeseApr.GroupIndex := 1404;
  GOSSpeseMag.GroupIndex := 1405;
  GOSSpeseGiu.GroupIndex := 1406;
  GOSSpeseLug.GroupIndex := 1407;
  GOSSpeseAgo.GroupIndex := 1408;
  GOSSpeseSet.GroupIndex := 1409;
  GOSSpeseOtt.GroupIndex := 1410;
  GOSSpeseNov.GroupIndex := 1411;
  GOSSpeseDic.GroupIndex := 1412;
  GOSSpeseGen.Down := False;
  GOSSpeseFeb.Down := False;
  GOSSpeseMar.Down := False;
  GOSSpeseApr.Down := False;
  GOSSpeseMag.Down := False;
  GOSSpeseGiu.Down := False;
  GOSSpeseLug.Down := False;
  GOSSpeseAgo.Down := False;
  GOSSpeseSet.Down := False;
  GOSSpeseOtt.Down := False;
  GOSSpeseNov.Down := False;
  GOSSpeseDic.Down := False;
  // end else begin
  // Rimette il Tag del pulsante = 0
  GOSSpeseMesiTutti.Tag := 0;
  // end;
end;

procedure TClientiForm.GOSSpeseMesiNessunoClick(Sender: TObject);
begin
  GOSSpeseDal.Clear;
  GOSSpeseAl.Clear;
  // In questo modo posso metterli tutti in DOWN contemporaneamente
  GOSSpeseGen.GroupIndex := 600;
  GOSSpeseFeb.GroupIndex := 600;
  GOSSpeseMar.GroupIndex := 600;
  GOSSpeseApr.GroupIndex := 600;
  GOSSpeseMag.GroupIndex := 600;
  GOSSpeseGiu.GroupIndex := 600;
  GOSSpeseLug.GroupIndex := 600;
  GOSSpeseAgo.GroupIndex := 600;
  GOSSpeseSet.GroupIndex := 600;
  GOSSpeseOtt.GroupIndex := 600;
  GOSSpeseNov.GroupIndex := 600;
  GOSSpeseDic.GroupIndex := 600;
  GOSSpeseGen.Down := False;
  GOSSpeseFeb.Down := False;
  GOSSpeseMar.Down := False;
  GOSSpeseApr.Down := False;
  GOSSpeseMag.Down := False;
  GOSSpeseGiu.Down := False;
  GOSSpeseLug.Down := False;
  GOSSpeseAgo.Down := False;
  GOSSpeseSet.Down := False;
  GOSSpeseOtt.Down := False;
  GOSSpeseNov.Down := False;
  GOSSpeseDic.Down := False;
end;

procedure TClientiForm.GOSSpeseMesiTuttiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    GOSSpeseMesiTuttiClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.GOSSpeseMesiNessunoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    GOSSpeseMesiNessunoClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.GOSSpeseGenClick(Sender: TObject);
var
  GG, MM, AA: Word;
  Mese: Shortint;
begin
  // Mese contiene l'indice del mese premuto
  Mese := (Sender as TSpeedButton).Tag;
  // AA COntiene l'anno in corso
  DecodeDate(Date, AA, MM, GG);
  // Se il GroupIndex  <> 600 significa che  stato premuto il
  // tasto di selezione di tutti i mesi e quindi si comporta di conseguenza
  if (Sender as TSpeedButton).GroupIndex <> 600 then
  begin
    GOSSpeseMesiNessunoClick(Self);
    (Sender as TSpeedButton).Down := True;
  end;
  // Se il pulsante  premuto (down)...
  if (Sender as TSpeedButton).Down then
  begin
    // In base all'indice del mese imposta le date nel modo opportuno
    case Mese of
      1:
        begin
          GOSSpeseDal.EditText := ' 01/01/' + IntToStr(AA);
          GOSSpeseAl.EditText := ' 31/01/' + IntToStr(AA);
        end;
      2:
        begin
          GOSSpeseDal.EditText := ' 01/02/' + IntToStr(AA);
          GOSSpeseAl.EditText := ' 28/02/' + IntToStr(AA);
        end;
      3:
        begin
          GOSSpeseDal.EditText := ' 01/03/' + IntToStr(AA);
          GOSSpeseAl.EditText := ' 31/03/' + IntToStr(AA);
        end;
      4:
        begin
          GOSSpeseDal.EditText := ' 01/04/' + IntToStr(AA);
          GOSSpeseAl.EditText := ' 30/04/' + IntToStr(AA);
        end;
      5:
        begin
          GOSSpeseDal.EditText := ' 01/05/' + IntToStr(AA);
          GOSSpeseAl.EditText := ' 31/05/' + IntToStr(AA);
        end;
      6:
        begin
          GOSSpeseDal.EditText := ' 01/06/' + IntToStr(AA);
          GOSSpeseAl.EditText := ' 30/06/' + IntToStr(AA);
        end;
      7:
        begin
          GOSSpeseDal.EditText := ' 01/07/' + IntToStr(AA);
          GOSSpeseAl.EditText := ' 31/07/' + IntToStr(AA);
        end;
      8:
        begin
          GOSSpeseDal.EditText := ' 01/08/' + IntToStr(AA);
          GOSSpeseAl.EditText := ' 31/08/' + IntToStr(AA);
        end;
      9:
        begin
          GOSSpeseDal.EditText := ' 01/09/' + IntToStr(AA);
          GOSSpeseAl.EditText := ' 30/09/' + IntToStr(AA);
        end;
      10:
        begin
          GOSSpeseDal.EditText := ' 01/10/' + IntToStr(AA);
          GOSSpeseAl.EditText := ' 31/10/' + IntToStr(AA);
        end;
      11:
        begin
          GOSSpeseDal.EditText := ' 01/11/' + IntToStr(AA);
          GOSSpeseAl.EditText := ' 30/11/' + IntToStr(AA);
        end;
      12:
        begin
          GOSSpeseDal.EditText := ' 01/12/' + IntToStr(AA);
          GOSSpeseAl.EditText := ' 31/12/' + IntToStr(AA);
        end;
    end;
    // Se invece il mese non  premuto...
  end
  else
  begin
    GOSSpeseDal.Text := '';
    GOSSpeseAl.Text := '';
  end;
end;

procedure TClientiForm.GOSSpeseGenMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    (Sender as TSpeedButton).Down := True;
    GOSSpeseGenClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.GOSGenClick(Sender: TObject);
var
  GG, MM, AA: Word;
  Mese: Shortint;
begin
  // Mese contiene l'indice del mese premuto
  Mese := (Sender as TSpeedButton).Tag;
  // AA COntiene l'anno in corso
  DecodeDate(Date, AA, MM, GG);
  // Se il GroupIndex  <> 600 significa che  stato premuto il
  // tasto di selezione di tutti i mesi e quindi si comporta di conseguenza
  if (Sender as TSpeedButton).GroupIndex <> 600 then
  begin
    GOSMesiNessunoClick(Self);
    (Sender as TSpeedButton).Down := True;
  end;
  // Se il pulsante  premuto (down)...
  if (Sender as TSpeedButton).Down then
  begin
    // In base all'indice del mese imposta le date nel modo opportuno
    case Mese of
      1:
        begin
          GOSDal.EditText := ' 01/01/' + IntToStr(AA);
          GOSAl.EditText := ' 31/01/' + IntToStr(AA);
        end;
      2:
        begin
          GOSDal.EditText := ' 01/02/' + IntToStr(AA);
          GOSAl.EditText := ' ' + IntToStr(DaysInAMonth(CurrentYear, 2)) + '/02/' + IntToStr(AA);
        end;
      3:
        begin
          GOSDal.EditText := ' 01/03/' + IntToStr(AA);
          GOSAl.EditText := ' 31/03/' + IntToStr(AA);
        end;
      4:
        begin
          GOSDal.EditText := ' 01/04/' + IntToStr(AA);
          GOSAl.EditText := ' 30/04/' + IntToStr(AA);
        end;
      5:
        begin
          GOSDal.EditText := ' 01/05/' + IntToStr(AA);
          GOSAl.EditText := ' 31/05/' + IntToStr(AA);
        end;
      6:
        begin
          GOSDal.EditText := ' 01/06/' + IntToStr(AA);
          GOSAl.EditText := ' 30/06/' + IntToStr(AA);
        end;
      7:
        begin
          GOSDal.EditText := ' 01/07/' + IntToStr(AA);
          GOSAl.EditText := ' 31/07/' + IntToStr(AA);
        end;
      8:
        begin
          GOSDal.EditText := ' 01/08/' + IntToStr(AA);
          GOSAl.EditText := ' 31/08/' + IntToStr(AA);
        end;
      9:
        begin
          GOSDal.EditText := ' 01/09/' + IntToStr(AA);
          GOSAl.EditText := ' 30/09/' + IntToStr(AA);
        end;
      10:
        begin
          GOSDal.EditText := ' 01/10/' + IntToStr(AA);
          GOSAl.EditText := ' 31/10/' + IntToStr(AA);
        end;
      11:
        begin
          GOSDal.EditText := ' 01/11/' + IntToStr(AA);
          GOSAl.EditText := ' 30/11/' + IntToStr(AA);
        end;
      12:
        begin
          GOSDal.EditText := ' 01/12/' + IntToStr(AA);
          GOSAl.EditText := ' 31/12/' + IntToStr(AA);
        end;
    end;
    // Se invece il mese non  premuto...
  end
  else
  begin
    GOSDal.Text := '';
    GOSAl.Text := '';
  end;
end;

procedure TClientiForm.SpeedButtonRollOver17Click(Sender: TObject);
begin
  DM1.Attendere;
  try
    Application.CreateForm(TAutomezziForm, AutomezziForm);
    AutomezziForm.Parent := MainForm;
    AutomezziForm.DblClickMode := DblClickModeSelection;
    AutomezziForm.CallerCode := 3;
    AutomezziForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.SpeedButton5Click(Sender: TObject);
begin
  // Attiva/Disattiva la Filter Row
  if (Sender as TSpeedButton).Down then
    PivotGridDoc.OptionsPrefilter.Visible := TcxPivotGridPrefilterVisible.pfvAlways
  else
  begin
    PivotGridDoc.OptionsPrefilter.Visible := TcxPivotGridPrefilterVisible.pfvNever;
    PivotGridDoc.DataController.Filter.Clear;
  end;
end;

procedure TClientiForm.SpeedButton6Click(Sender: TObject);
begin
  tvScad.ViewData.Collapse(True);
end;

procedure TClientiForm.Stamparapportooredipendenti1Click(Sender: TObject);
var
  ShowDlgForm: Boolean;
begin
  ShowDlgForm := (StampeCantieriForm = nil);
  // Imposta la stringa su cui viene costruito il range di date della stampa in base ai filtri per data
  DM1.SetReportDateRange(GOSDal.EditText, GOSAl.EditText);
  // Anteprima
  if MenuStampe.Tag = 0 then
  begin
    dxPrinter.Preview(True, GosOreLink);
    // Stampa
  end
  else if MenuStampe.Tag = 1 then
  begin
    dxPrinter.Print(ShowDlgForm, nil, GosOreLink);
  end;
end;

procedure TClientiForm.tvOreDataControllerGroupingChanged(Sender: TObject);
begin
  // Se i dati sono raggruppati in qualche maniera abilita anche i bordi orizzontali
  // altrimenti no
  if tvOre.GroupedColumnCount > 0 then
    tvOre.OptionsView.GridLines := glBoth
  else
    tvOre.OptionsView.GridLines := glVertical;
end;

procedure TClientiForm.tvSpeseDataControllerGroupingChanged(Sender: TObject);
begin
  // Se i dati sono raggruppati in qualche maniera abilita anche i bordi orizzontali
  // altrimenti no
  if tvSpese.GroupedColumnCount > 0 then
    tvSpese.OptionsView.GridLines := glBoth
  else
    tvSpese.OptionsView.GridLines := glVertical;
end;

procedure TClientiForm.GosOrePivotCustomization(Sender: TObject);
begin
  DM1.OpenPivotGridCustomizationForm((Sender as TcxDBPivotGrid));
end;

procedure TClientiForm.GosOrePivotDblClick(Sender: TObject);
var
  ACrossCell: TcxPivotGridCrossCell;
begin
  // Se l'utente ha fatto doppioclick su una cella visualizza il relativo dettaglio
  with (Sender as TcxDBPivotGrid).HitTest do
  begin
    if HitAtDataCell then
    begin
      DM1.ShowWait('Levante', 'Operazione in corso...');
      try
        // ACrossCel contiene il puntatore alla cella sul quale l'utente ha fatto doppioclick
        ACrossCell := TcxPivotGridDataCellViewInfo(HitObject).CrossCell;
        // Crea e visualizza la form con il teggalio
        if GosOrePivotDetailForm = nil then
        begin
          GosOrePivotDetailForm := TGosOrePivotDetailForm.Create(Self, TabGosOreAda, ACrossCell, tvOre);
          GosOrePivotDetailForm.Show;
        end;
      finally
        DM1.CloseWait;
      end;
    end;
  end;
end;

procedure TClientiForm.StampaADAdipendenti1Click(Sender: TObject);
var
  ShowDlgForm: Boolean;
begin
  ShowDlgForm := (StampeCantieriForm = nil);
  // Anteprima
  if MenuStampe.Tag = 0 then
  begin
    dxPrinter.Preview(True, GosOrePivotLink);
    // Stampa
  end
  else if MenuStampe.Tag = 1 then
  begin
    dxPrinter.Print(ShowDlgForm, nil, GosOrePivotLink);
  end;
end;

procedure TClientiForm.StampaADAgiornaledimagazzino1Click(Sender: TObject);
var
  ShowDlgForm: Boolean;
begin
  ShowDlgForm := (StampeCantieriForm = nil);
  // Anteprima
  if MenuStampe.Tag = 0 then
  begin
    dxPrinter.Preview(True, PivotGMLink);
    // Stampa
  end
  else if MenuStampe.Tag = 1 then
  begin
    dxPrinter.Print(ShowDlgForm, nil, PivotGMLink);
  end;
end;

procedure TClientiForm.Stamparapportospesevarie1Click(Sender: TObject);
var
  ShowDlgForm: Boolean;
begin
  ShowDlgForm := (StampeCantieriForm = nil);
  // Imposta la stringa su cui viene costruito il range di date della stampa in base ai filtri per data
  DM1.SetReportDateRange(GOSSpeseDal.EditText, GOSSpeseAl.EditText);
  // Anteprima
  if MenuStampe.Tag = 0 then
  begin
    dxPrinter.Preview(True, GosSpeseLink);
    // Stampa
  end
  else if MenuStampe.Tag = 1 then
  begin
    dxPrinter.Print(ShowDlgForm, nil, GosSpeseLink);
  end;
end;

procedure TClientiForm.StampaADAscadenze1Click(Sender: TObject);
var
  ShowDlgForm: Boolean;
begin
  ShowDlgForm := (StampeCantieriForm = nil);
  // Anteprima
  if MenuStampe.Tag = 0 then
  begin
    dxPrinter.Preview(True, ScadPivotLink);
    // Stampa
  end
  else if MenuStampe.Tag = 1 then
  begin
    dxPrinter.Print(ShowDlgForm, nil, ScadPivotLink);
  end;
end;

procedure TClientiForm.StampaADAspesevarie1Click(Sender: TObject);
var
  ShowDlgForm: Boolean;
begin
  ShowDlgForm := (StampeCantieriForm = nil);
  // Anteprima
  if MenuStampe.Tag = 0 then
  begin
    dxPrinter.Preview(True, GosSpesePivotLink);
    // Stampa
  end
  else if MenuStampe.Tag = 1 then
  begin
    dxPrinter.Print(ShowDlgForm, nil, GosSpesePivotLink);
  end;
end;

procedure TClientiForm.GosSpesePivotDblClick(Sender: TObject);
var
  ACrossCell: TcxPivotGridCrossCell;
begin
  // Se l'utente ha fatto doppioclick su una cella visualizza il relativo dettaglio
  with (Sender as TcxDBPivotGrid).HitTest do
  begin
    if HitAtDataCell then
    begin
      DM1.ShowWait('Levante', 'Operazione in corso...');
      try
        // ACrossCel contiene il puntatore alla cella sul quale l'utente ha fatto doppioclick
        ACrossCell := TcxPivotGridDataCellViewInfo(HitObject).CrossCell;
        // Crea e visualizza la form con il teggalio
        if GosSpesePivotForm = nil then
        begin
          GosSpesePivotForm := TGosSpesePivotForm.Create(Self, TabGosSpeseAda, ACrossCell, tvSpese);
          GosSpesePivotForm.Show;
        end;
      finally
        DM1.CloseWait;
      end;
    end;
  end;
end;

procedure TClientiForm.Stampagraficocantiere1Click(Sender: TObject);
begin
  // Anteprima
  if MenuStampe.Tag = 0 then
  begin
    TabGCForm.ChartFrame.PrintPreview;
    // Stampa
  end
  else if MenuStampe.Tag = 1 then
  begin
    TabGCForm.ChartFrame.Print;
  end;
end;

procedure TClientiForm.Stampagraficodocumenti1Click(Sender: TObject);
begin
  // Anteprima
  if MenuStampe.Tag = 0 then
  begin
    FChartDoc.PrintPreview;
    // Stampa
  end
  else if MenuStampe.Tag = 1 then
  begin
    FChartDoc.Print;
  end;
end;

procedure TClientiForm.Stampagraficogiornaledimagazzino1Click(Sender: TObject);
begin
  // Anteprima
  if MenuStampe.Tag = 0 then
  begin
    FChartGM.PrintPreview;
    // Stampa
  end
  else if MenuStampe.Tag = 1 then
  begin
    FChartGM.Print;
  end;
end;

procedure TClientiForm.Stampagraficooredipendenti1Click(Sender: TObject);
begin
  // Anteprima
  if MenuStampe.Tag = 0 then
  begin
    dxPrinter.Preview(True, GosOreGraficoLink);
    // Stampa
  end
  else if MenuStampe.Tag = 1 then
  begin
    dxPrinter.Print(True, nil, GosOreGraficoLink);
  end;
end;

procedure TClientiForm.Stampagraficoscadenze1Click(Sender: TObject);
begin
  // Anteprima
  if MenuStampe.Tag = 0 then
  begin
    FChartScad.PrintPreview;
    // Stampa
  end
  else if MenuStampe.Tag = 1 then
  begin
    FChartScad.Print;
  end;
end;

procedure TClientiForm.Stampagraficospesevarie1Click(Sender: TObject);
begin
  // Anteprima
  if MenuStampe.Tag = 0 then
  begin
    dxPrinter.Preview(True, GosSpeseGraficoLink);
    // Stampa
  end
  else if MenuStampe.Tag = 1 then
  begin
    dxPrinter.Print(True, nil, GosSpeseGraficoLink);
  end;
end;

procedure TClientiForm.Stamperiepilogativecantieri1Click(Sender: TObject);
begin
  Application.CreateForm(TStampeCantieriForm, StampeCantieriForm);
  StampeCantieriForm.Parent := MainForm;
  StampeCantieriForm.Show;
end;

procedure TClientiForm.tvArtDragOver(Sender, Source: TObject; X, Y: Integer; State: TDragState; var Accept: Boolean);
begin
  // Inizializzazione
  Accept := False;
  // Se Source  una TLIstView...
  if Source is TListView then
  begin
    // Se la TListView in questione  quella di ricezione dal sistema
    // di interscambio dei documenti accetta.
    // NB: Controlla anche che si tratti di un documento
    if (((Source as TListView).Name = 'ReceiveLV') and (ScambioDocForm.ReceiveLV.Selected.ImageIndex = 1)) or ((Source as TListView).Name = 'ListViewExpDoc')
    then
    begin
      Accept := True;
    end;
  end;
end;

procedure TClientiForm.tvArtDragDrop(Sender, Source: TObject; X, Y: Integer);
begin
  // In base al tipo del mittente
  if Source is TListView then
  begin
    // Se il mittente  la ricezione di un documento dal sistema di interscambio dei documenti...
    if (Source as TListView).Name = 'ReceiveLV' then
    begin
      // Provvede all'importazione dei documenti in ricezione
      ScambioDocForm.SBRiceviDocumentoClick(ScambioDocForm.SBRiceviDocumento);
    end;
  end;
end;

procedure TClientiForm.tvAltriDocDataControllerGroupingChanged(Sender: TObject);
begin
  // Se i dati sono raggruppati in qualche maniera abilita anche i bordi orizzontali
  // altrimenti no
  if tvAltriDoc.GroupedColumnCount > 0 then
    tvAltriDoc.OptionsView.GridLines := glBoth
  else
    tvAltriDoc.OptionsView.GridLines := glVertical;
end;

procedure TClientiForm.tvAltriDocDataControllerSortingChanged(Sender: TObject);
begin
  // F rifare l'interrogazione con il nuovo ordinamento
  // NB: Solo se non c' alcun raggruppamento
  if tvAltriDoc.DataController.DataModeController.GridMode and (tvAltriDoc.GroupedColumnCount = 0) then
    RxSpeedButtonTrovaClick(Self);
  tvAltriDoc.Controller.GotoFirst(False);
end;

procedure TClientiForm.tvAltriDocCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo;
  var ADone: Boolean);
begin
  // Solo se non  selezionata
  if not AViewInfo.Selected then
  begin
    // IMposta il colore del Font in base allo stato del documento
    if (not VarIsNull(AViewInfo.GridRecord.Values[tvAltriDoc.GetColumnByFieldName('STATODESCRIZIONE').Index])) and
      (not VarIsNull(AViewInfo.GridRecord.Values[tvAltriDoc.GetColumnByFieldName('STATOFOREGROUND').Index])) then
    begin
      ACanvas.Font.Color := DM1.StrToColor(AViewInfo.GridRecord.Values[tvAltriDoc.GetColumnByFieldName('STATOFOREGROUND').Index], ACanvas.Font.Color);
    end;
  end;
end;

procedure TClientiForm.QryGMCalcFields(DataSet: TDataSet);
begin
  if (not QryGMQTA.IsNull) and (QryGMQTA.Value <> 0) then
    QryGMPREZZOUNITARIONETTO.Value := DM1.Arrotonda((QryGMIMPORTORIGO.AsFloat / QryGMQTA.AsFloat), DM1.DecMicroPrz);

  QryGMANNO.Value := DateUtils.YearOf(QryGMDATADOCUMENTO.AsDateTime);
  QryGMSEMESTRE.AsString := DM2.DateTimeToSemestre(QryGMDATADOCUMENTO.AsDateTime);
  QryGMTRIMESTRE.AsString := DM2.DateTimeToTrimestre(QryGMDATADOCUMENTO.AsDateTime);
end;

procedure TClientiForm.QryGOSOreCalcFields(DataSet: TDataSet);
begin
  QryGOSOreANNO.Value := DateUtils.YearOf(QryGOSOreDATADOC.AsDateTime);
  QryGOSOreSEMESTRE.AsString := DM2.DateTimeToSemestre(QryGOSOreDATADOC.AsDateTime);
  QryGOSOreTRIMESTRE.AsString := DM2.DateTimeToTrimestre(QryGOSOreDATADOC.AsDateTime);
end;

procedure TClientiForm.QryGOSSpeseCalcFields(DataSet: TDataSet);
begin
  QryGOSSpeseANNO.Value := DateUtils.YearOf(QryGOSSpeseDATADOC.AsDateTime);
  QryGOSSpeseSEMESTRE.AsString := DM2.DateTimeToSemestre(QryGOSSpeseDATADOC.AsDateTime);
  QryGOSSpeseTRIMESTRE.AsString := DM2.DateTimeToTrimestre(QryGOSSpeseDATADOC.AsDateTime);
end;

procedure TClientiForm.QryPraticheBeforeDelete(DataSet: TDataSet);
begin
  if not(DM1.ModCtrl(MOD_PRATICHE) > 1) then
    raise Exception.Create('Operazione non permessa per questo utente!');
  // Chiede conferma per l'eliminazione
  if not TConfirmForm.ConfirmationRequest(Format('Elimina %s', [QryPraticheDESCRIZIONE.AsString]),
    Format('Per confermare digita "elimina %s", poi clicca sul bottone "Conferma".', [QryPraticheDESCRIZIONE.AsString]),
    Format('elimina %s', [QryPraticheDESCRIZIONE.AsString]), 600, 300) then
    Abort;
end;

procedure TClientiForm.QryScadCalcFields(DataSet: TDataSet);
begin
  QryScadCHART_DESCRIZIONE.AsString := Format('%s  (%s)', [QryScadDOCUMENTO.AsString, QryScadSOGGETTO.AsString]);

  if QryScadRESIDUO.AsCurrency = 0 then
    QryScadPAGATO.AsString := 'Pagato'
  else
    QryScadPAGATO.AsString := 'Da pagare';

  QryScadANNO.Value := DateUtils.YearOf(QryScadDATASCADENZA.AsDateTime);
  QryScadSEMESTRE.AsString := DM2.DateTimeToSemestre(QryScadDATASCADENZA.AsDateTime);
  QryScadTRIMESTRE.AsString := DM2.DateTimeToTrimestre(QryScadDATASCADENZA.AsDateTime);
end;

procedure TClientiForm.QrySoggettiBeforeDelete(DataSet: TDataSet);
var
  Qry: TIB_Cursor;
begin
  if not(DM1.ModCtrl(MOD_CLIENTI) > 1) then
    raise Exception.Create('Operazione non permessa per questo utente!');
  // Chiede conferma per l'eliminazione del soggetto
  if not TConfirmForm.ConfirmationRequest(Format('Elimina %s', [QrySoggettiCLIENTEFORNITORE.AsString]),
    Format('Per confermare digita "elimina %s", poi clicca sul bottone "Conferma".', [QrySoggettiRAGIONESOCIALE.AsString]),
    Format('elimina %s', [QrySoggettiRAGIONESOCIALE.AsString]), 600, 300) then
    Abort;
  // Se il soggetto (fornitore in questo caso) ha dei listini secondari allora chiede una ulteriore conferma
  // e se non si conferma si annulla anche l'eliminazione del fornitore stesso (che quindi rimane)
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;

    Qry.SQL.Add('SELECT FIRST 1 CODICEFORNITORE FROM LISTFORN WHERE CODICEFORNITORE = ' + QrySoggettiCODICE.AsString);
    Qry.Open;
    if Qry.Eof then
      Exit;

    if not TConfirmForm.ConfirmationRequest('ATTENZIONE !!!', // Elimina %s', [QrySoggettiCLIENTEFORNITORE.AsString]),
      Format('Il %s "%s" ha dei listini secondari negli articoli.'#13#13'Per confermare la sua eliminazione e anche quella dei suoi listini digita "elimina %s e i suoi listini", poi clicca sul bottone "Conferma".',
      [QrySoggettiCLIENTEFORNITORE.AsString, QrySoggettiRAGIONESOCIALE.AsString, QrySoggettiRAGIONESOCIALE.AsString]),
      Format('elimina %s e i suoi listini', [QrySoggettiRAGIONESOCIALE.AsString]), 800, 350) then
      Abort;
    // NB: IL CODICE PER L'ELIMINAZIONE DEI LISTINI SECONDARI E' SU UN NUOVO TRIGGER                                          ----
    // Qry.SQL.Clear;
    // Qry.SQL.Add('DELETE FROM LISTFORN WHERE CODICEFORNITORE = ' + QrySoggettiCODICE.AsString);
    // Qry.ExecSQL;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.Importafatturaelettronicapassivaacquisto1Click(Sender: TObject);
var
  LInvoice: IeiInvoiceMini;
  LPersister: ILevanteInvoicePersister;
begin
  // DM1.OpenDialog1.InitialDir := 'c:\';  // Cos rimane sull'ultima cartella
  DM1.OpenDialog1.Filter := 'Fattura elettronica (*.XML)|*.XML';
  if DM1.OpenDialog1.Execute then
  begin
    LInvoice := TeiInvoiceMiniFactory.NewInvoiceFromFile(DM1.OpenDialog1.FileName);
    LPersister := TInvoicePersisterFactory.NewLevanteInvoicePersister(LInvoice);
    LPersister.SaveToLevante(True, ExtractFileName(DM1.OpenDialog1.FileName), 'rtLoadedFromFile');
  end;
end;

procedure TClientiForm.Impostaeventoricorsivo1Click(Sender: TObject);
var
  AInfo: TcxSchedulerEventEditInfo;
  AModified: Boolean;
begin
  AInfo := TcxSchedulerEventEditInfo.Create;
  AInfo.Event := Agenda.SelectedEvents[0];
  cxShowEventEditorEx(AInfo, AModified);
// ----- OLD CODE -----
//  cxShowEventEditor(Agenda.SelectedEvents[0], Agenda.LookAndFeel, False, AModified);
// ----- OLD CODE -----
end;

procedure TClientiForm.Copiaidocumentiselezionatisullabacheca1Click(Sender: TObject);
begin
  ClientiForm.SBEsportaDocFiscClick(Self);
end;

procedure TClientiForm.QryAssCalcFields(DataSet: TDataSet);
var
  QuantoMancaAlProssimoIntervento: Integer;
begin
  // IN base allo stato dell'abbonamento dell'impianto setta il colore con
  // cui visualizzare la riga.
  // --------------------------------------------------------------------------
  // Solo se l'impianto  in abbonamento
  if QryAssABBONATO.AsString = 'T' then
  begin
    // Variabile che contiene i giorni mancanti all'ultimo giorno
    if not QryAssPROXVISITAENTRO.IsNull then
    begin
      QuantoMancaAlProssimoIntervento := Trunc((QryAssPROXVISITAENTRO.AsDateTime - Now));
    end
    else
    begin
      QuantoMancaAlProssimoIntervento := 300; // Valore di default se non pu calcolarlo
    end;
    // Se  gi stato preso un appuntamento per la manutenzione programma visualizza la riga in blu
    if not QryAssDATAORAPROSSIMOAPPUNTAMENTO.IsNull then
    begin
      QryAssSTATO.Value := 'App.preso';
      // Se il prossimo intervento previsto cade entro 15 gg da oggi, visualizza tutto rosso
    end
    else if QuantoMancaAlProssimoIntervento <= 15 then
    begin
      QryAssSTATO.Value := 'URGENTE';
      // Se il prossimo intervento previsto cade tra 15 e 30 gg da oggi, visualizza tutto arancione
    end
    else if QuantoMancaAlProssimoIntervento <= 30 then
    begin
      QryAssSTATO.Value := 'IN_SCAD';
      // Se il prossimo intervento previsto cade oltre i 30 gg da oggi, visualizza tutto verde
    end
    else
    begin
      QryAssSTATO.Value := 'Ok';
    end;
    // Se invece l'abbonamento  stato sospeso, lo visualizza in grigio
  end
  else if QryAssABBONATO.AsString = 'S' then
  begin
    QryAssSTATO.Value := 'SOSPESO';
    // Se l'impianto  stato dismesso
  end
  else if QryAssABBONATO.AsString = 'D' then
  begin
    QryAssSTATO.Value := 'DISMESSO';
    // Se invece non  abbonato per niente
  end
  else
  begin
    QryAssSTATO.Value := '';
  end;
end;

procedure TClientiForm.PrmMesiTuttiClick(Sender: TObject);
begin
  PrmDal.EditText := DM1.FilterDataDalDefault;
  PrmAl.EditText := DM1.FilterDataAlDefault;
  // Se il Tag del pulsante MesiTutti = 1 significa che questo gestore di evento  stato
  // richiamato dall'evento OnChange del PageControl e non per un click dell'utente sul
  // pulsante stesso, quindi imposta le date al primo giorno e all'ultimo dell'anno in corso
  // ma non mette in  Down tutti i pulsanti dei mesi perch mi piace di pi.
  // if PrmMesiTutti.Tag = 0 then begin
  // In questo modo posso metterli tutti in DOWN contemporaneamente
  PrmGen.GroupIndex := 1401;
  PrmFeb.GroupIndex := 1402;
  PrmMar.GroupIndex := 1403;
  PrmApr.GroupIndex := 1404;
  PrmMag.GroupIndex := 1405;
  PrmGiu.GroupIndex := 1406;
  PrmLug.GroupIndex := 1407;
  PrmAgo.GroupIndex := 1408;
  PrmSet.GroupIndex := 1409;
  PrmOtt.GroupIndex := 1410;
  PrmNov.GroupIndex := 1411;
  PrmDic.GroupIndex := 1412;
  PrmGen.Down := False;
  PrmFeb.Down := False;
  PrmMar.Down := False;
  PrmApr.Down := False;
  PrmMag.Down := False;
  PrmGiu.Down := False;
  PrmLug.Down := False;
  PrmAgo.Down := False;
  PrmSet.Down := False;
  PrmOtt.Down := False;
  PrmNov.Down := False;
  PrmDic.Down := False;
  // end else begin
  // Rimette il Tag del pulsante = 0
  PrmMesiTutti.Tag := 0;
  // end;
end;

procedure TClientiForm.PrmMesiNessunoClick(Sender: TObject);
begin
  PrmDal.Clear;
  PrmAl.Clear;
  // In questo modo posso metterli tutti in DOWN contemporaneamente
  PrmGen.GroupIndex := 600;
  PrmFeb.GroupIndex := 600;
  PrmMar.GroupIndex := 600;
  PrmApr.GroupIndex := 600;
  PrmMag.GroupIndex := 600;
  PrmGiu.GroupIndex := 600;
  PrmLug.GroupIndex := 600;
  PrmAgo.GroupIndex := 600;
  PrmSet.GroupIndex := 600;
  PrmOtt.GroupIndex := 600;
  PrmNov.GroupIndex := 600;
  PrmDic.GroupIndex := 600;
  PrmGen.Down := False;
  PrmFeb.Down := False;
  PrmMar.Down := False;
  PrmApr.Down := False;
  PrmMag.Down := False;
  PrmGiu.Down := False;
  PrmLug.Down := False;
  PrmAgo.Down := False;
  PrmSet.Down := False;
  PrmOtt.Down := False;
  PrmNov.Down := False;
  PrmDic.Down := False;
end;

procedure TClientiForm.EseguiQueryPrimanota;
begin
  QueryPrimanota.Close;
  QueryPrimanota.SQL.Clear;
  QueryPrimanota.SQL.Add
    ('SELECT P.DATA, P.DESCRIZIONE, COALESCE(P.CASSAENTRATE,0) AS CASSAENTRATE, COALESCE(P.CASSAUSCITE,0) AS CASSAUSCITE, P.DESCFUORI, COALESCE(P.FUORIENTRATE,0) AS FUORIENTRATE, COALESCE(P.FUORIUSCITE,0) AS FUORIUSCITE,');
  QueryPrimanota.SQL.Add
    (' COALESCE(P.ABBUONIATTIVI,0) AS ABBUONIATTIVI, COALESCE(P.ABBUONIPASSIVI,0) AS ABBUONIPASSIVI, P.NOTE, P.AGENTE, P.AGENTE2, P.AGENTE3, P.AGENTE4');
  QueryPrimanota.SQL.Add(',CAST(C.RAGIONESOCIALE || ''  (''  || P.CLIENTE || '')'' AS VARCHAR(80)) AS RAGSOCCLI');
  QueryPrimanota.SQL.Add(',P.CLIENTE, P.CODICE, P.STATODESCRIZIONE, P.STATOFOREGROUND, P.STATOBACKGROUND');
  QueryPrimanota.SQL.Add
    (',CAST((SELECT A.DESCRIZIONE FROM Pratiche A WHERE A.Codice=P.Pratica AND A.DataApertura=P.DataPratica1)||''  (''||P.PRATICA|| '', ''||P.DATAPRATICA1||'')'' AS VARCHAR(120)) AS RIFPRATICA');
  QueryPrimanota.SQL.Add(',P.EXPORTED');
  QueryPrimanota.SQL.Add('FROM PRIMANOT P');
  QueryPrimanota.SQL.Add('LEFT JOIN CLIENTI C ON (C.CODICE = P.CLIENTE)');
  // Aggiunge una clausola WHERE finta in modo che non dia errore se non viene specificata nessuna condizione
  QueryPrimanota.SQL.Add('WHERE');
  QueryPrimanota.SQL.Add('1=1');
  // Filtri
  if ClientiForm.PraticaCorrente <> '' then
  begin
    DM1.AddSQL(QueryPrimanota, 'AND', '((Pratica = ' + ClientiForm.PraticaCorrente + ') OR (Pratica2 = ' + ClientiForm.PraticaCorrente + ') OR (Pratica3 = ' +
      ClientiForm.PraticaCorrente + '))');
  end
  else
  begin
    if ClientiForm.ClienteCorrente <> '' then
      DM1.AddSQL(QueryPrimanota, 'AND', 'Cliente = ' + ClientiForm.ClienteCorrente);
  end;

  if PrmSearchKey.Text <> '' then
  begin
    DM1.AddSQL(QueryPrimanota, 'AND', '(');
    DM1.AggiungiRicercaCampo(QueryPrimanota.SQL, 'P.DESCRIZIONE', PrmSearchKey.Text, False);
    QueryPrimanota.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QueryPrimanota.SQL, 'P.NOTE', PrmSearchKey.Text, False);
    QueryPrimanota.SQL.Add(')');
  end;

  if PrmBanca.Text <> '' then
  begin
    DM1.AddSQL(QueryPrimanota, 'AND', '(DescFuori = ''' + PrmBanca.Text + ''')');
  end;

  // Agenti
  if PrmAgente.Text <> '' then
    DM1.AddSQL(QueryPrimanota, 'AND', 'P.AGENTE  = ''' + PrmAgente.Text + '''');
  if PrmAgente2.Text <> '' then
    DM1.AddSQL(QueryPrimanota, 'AND', 'P.AGENTE2 = ''' + PrmAgente2.Text + '''');
  if PrmAgente3.Text <> '' then
    DM1.AddSQL(QueryPrimanota, 'AND', 'P.AGENTE3 = ''' + PrmAgente3.Text + '''');
  if PrmAgente4.Text <> '' then
    DM1.AddSQL(QueryPrimanota, 'AND', 'P.AGENTE4 = ''' + PrmAgente4.Text + '''');

  if PrmStato.Text <> '' then
    DM1.AddSQL(QueryPrimanota, 'AND', 'P.STATODESCRIZIONE = ''' + PrmStato.Text + '''');

  if DM1.ControllaDataStr(PrmDal.EditText) then
    DM1.AddSQL(QueryPrimanota, 'AND', 'Data >= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(PrmDal.EditText)) + '''');
  if DM1.ControllaDataStr(PrmAl.EditText) then
    DM1.AddSQL(QueryPrimanota, 'AND', 'Data <= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(PrmAl.EditText)) + '''');

  // Aggiunge alla query l'ORDER BY
  QueryPrimanota.SQL.Add(DM1.GeneraOrderBy(tvPrimanota));
  QueryPrimanota.Open;

  // ==========================================================================
  // QUERY TOTALI
  // --------------------------------------------------------------------------
  QueryTotali.Close;
  QueryTotali.SQL.Clear;
  QueryTotali.SQL.Add('SELECT sum(CassaEntrate) as TotCassaEntrate, sum(CassaUscite) as TotCassaUscite, (sum(CassaEntrate)-sum(CassaUscite)) as SaldoCassa,');
  QueryTotali.SQL.Add('       sum(FuoriEntrate) as TotFuoriEntrate, sum(FuoriUscite) as TotFuoriUscite, (sum(FuoriEntrate)-sum(FuoriUscite)) as SaldoFuori');
  QueryTotali.SQL.Add('FROM PRIMANOT');

  if ClientiForm.PraticaCorrente <> '' then
  begin
    DM1.AddSQL(QueryTotali, 'AND', '((Pratica = ' + ClientiForm.PraticaCorrente + ') OR (Pratica2 = ' + ClientiForm.PraticaCorrente + ') OR (Pratica3 = ' +
      ClientiForm.PraticaCorrente + '))');
  end
  else
  begin
    if ClientiForm.ClienteCorrente <> '' then
      DM1.AddSQL(QueryTotali, 'AND', 'Cliente = ' + ClientiForm.ClienteCorrente);
  end;

  if PrmSearchKey.Text <> '' then
  begin
    DM1.AddSQL(QueryTotali, 'AND', '(');
    DM1.AggiungiRicercaCampo(QueryTotali.SQL, 'DESCRIZIONE', PrmSearchKey.Text, False);
    QueryTotali.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QueryTotali.SQL, 'NOTE', PrmSearchKey.Text, False);
    QueryTotali.SQL.Add(')');
  end;

  if PrmBanca.Text <> '' then
  begin
    DM1.AddSQL(QueryTotali, 'AND', '(DescFuori = ''' + PrmBanca.Text + ''')');
  end;

  // Agenti
  if PrmAgente.Text <> '' then
    DM1.AddSQL(QueryTotali, 'AND', 'AGENTE  = ''' + PrmAgente.Text + '''');
  if PrmAgente2.Text <> '' then
    DM1.AddSQL(QueryTotali, 'AND', 'AGENTE2 = ''' + PrmAgente2.Text + '''');
  if PrmAgente3.Text <> '' then
    DM1.AddSQL(QueryTotali, 'AND', 'AGENTE3 = ''' + PrmAgente3.Text + '''');
  if PrmAgente4.Text <> '' then
    DM1.AddSQL(QueryTotali, 'AND', 'AGENTE4 = ''' + PrmAgente4.Text + '''');

  if PrmStato.Text <> '' then
    DM1.AddSQL(QueryTotali, 'AND', 'STATODESCRIZIONE = ''' + PrmStato.Text + '''');

  // if DM1.ControllaDataStr(PrmDal.EditText) then DM1.AddSQL(QueryTotali, 'AND', 'Data >= ''' + FormatDateTime('mm/dd/yyyy',StrToDate(PrmDal.EditText)) + '''');
  if DM1.ControllaDataStr(PrmAl.EditText) then
    DM1.AddSQL(QueryTotali, 'AND', 'Data <= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(PrmAl.EditText)) + '''');

  QueryTotali.Open;
  // ==========================================================================

  // ==========================================================================
  // QUERY RIPORTI
  // --------------------------------------------------------------------------
  // Esegue querta query solo se  stata speficiata una data di inizio per la visualizzazione
  // dei movimenti di primanota
  QueryRiporti.Close;
  if DM1.ControllaDataStr(PrmDal.EditText) then
  begin
    QueryRiporti.SQL.Clear;
    QueryRiporti.SQL.Add
      ('SELECT sum(CassaEntrate) as TotCassaEntrate, sum(CassaUscite) as TotCassaUscite, (sum(CassaEntrate)-sum(CassaUscite)) as SaldoCassa,');
    QueryRiporti.SQL.Add('       sum(FuoriEntrate) as TotFuoriEntrate, sum(FuoriUscite) as TotFuoriUscite, (sum(FuoriEntrate)-sum(FuoriUscite)) as SaldoFuori');
    QueryRiporti.SQL.Add('FROM PRIMANOT');

    if ClientiForm.PraticaCorrente <> '' then
    begin
      DM1.AddSQL(QueryRiporti, 'AND', '((Pratica = ' + ClientiForm.PraticaCorrente + ') OR (Pratica2 = ' + ClientiForm.PraticaCorrente + ') OR (Pratica3 = ' +
        ClientiForm.PraticaCorrente + '))');
    end
    else
    begin
      if ClientiForm.ClienteCorrente <> '' then
        DM1.AddSQL(QueryRiporti, 'AND', 'Cliente = ' + ClientiForm.ClienteCorrente);
    end;

    if PrmSearchKey.Text <> '' then
    begin
      DM1.AddSQL(QueryRiporti, 'AND', '(');
      DM1.AggiungiRicercaCampo(QueryRiporti.SQL, 'DESCRIZIONE', PrmSearchKey.Text, False);
      QueryRiporti.SQL.Add('OR');
      DM1.AggiungiRicercaCampo(QueryRiporti.SQL, 'NOTE', PrmSearchKey.Text, False);
      QueryRiporti.SQL.Add(')');
    end;

    if PrmBanca.Text <> '' then
    begin
      DM1.AddSQL(QueryRiporti, 'AND', '(DescFuori = ''' + PrmBanca.Text + ''')');
    end;

    // Agenti
    if PrmAgente.Text <> '' then
      DM1.AddSQL(QueryRiporti, 'AND', 'AGENTE  = ''' + PrmAgente.Text + '''');
    if PrmAgente2.Text <> '' then
      DM1.AddSQL(QueryRiporti, 'AND', 'AGENTE2 = ''' + PrmAgente2.Text + '''');
    if PrmAgente3.Text <> '' then
      DM1.AddSQL(QueryRiporti, 'AND', 'AGENTE3 = ''' + PrmAgente3.Text + '''');
    if PrmAgente4.Text <> '' then
      DM1.AddSQL(QueryRiporti, 'AND', 'AGENTE4 = ''' + PrmAgente4.Text + '''');

    if PrmStato.Text <> '' then
      DM1.AddSQL(QueryRiporti, 'AND', 'STATODESCRIZIONE = ''' + PrmStato.Text + '''');

    if DM1.ControllaDataStr(PrmDal.EditText) then
      DM1.AddSQL(QueryRiporti, 'AND', 'Data < ''' + FormatDateTime('mm/dd/yyyy', StrToDate(PrmDal.EditText)) + '''');
    // if DM1.ControllaDataStr(PrmAl.EditText)  then DM1.AddSQL(QueryRiporti, 'AND', 'Data <= ''' + FormatDateTime('mm/dd/yyyy',StrToDate(PrmAl.EditText)) + '''');

    QueryRiporti.Open;
  end;
  // ==========================================================================

  // ==========================================================================
  // QUERY TOT. PERIODO
  // --------------------------------------------------------------------------
  QryTotPeriodo.Close;
  QryTotPeriodo.SQL.Clear;
  QryTotPeriodo.SQL.Add('SELECT sum(CassaEntrate) as TotCassaEntrate, sum(CassaUscite) as TotCassaUscite, (sum(CassaEntrate)-sum(CassaUscite)) as SaldoCassa,');
  QryTotPeriodo.SQL.Add('       sum(FuoriEntrate) as TotFuoriEntrate, sum(FuoriUscite) as TotFuoriUscite, (sum(FuoriEntrate)-sum(FuoriUscite)) as SaldoFuori');
  QryTotPeriodo.SQL.Add('FROM PRIMANOT');

  if ClientiForm.PraticaCorrente <> '' then
  begin
    DM1.AddSQL(QryTotPeriodo, 'AND', '((Pratica = ' + ClientiForm.PraticaCorrente + ') OR (Pratica2 = ' + ClientiForm.PraticaCorrente + ') OR (Pratica3 = ' +
      ClientiForm.PraticaCorrente + '))');
  end
  else
  begin
    if ClientiForm.ClienteCorrente <> '' then
      DM1.AddSQL(QryTotPeriodo, 'AND', 'Cliente = ' + ClientiForm.ClienteCorrente);
  end;

  if PrmSearchKey.Text <> '' then
  begin
    DM1.AddSQL(QryTotPeriodo, 'AND', '(');
    DM1.AggiungiRicercaCampo(QryTotPeriodo.SQL, 'DESCRIZIONE', PrmSearchKey.Text, False);
    QryTotPeriodo.SQL.Add('OR');
    DM1.AggiungiRicercaCampo(QryTotPeriodo.SQL, 'NOTE', PrmSearchKey.Text, False);
    QryTotPeriodo.SQL.Add(')');
  end;

  if PrmBanca.Text <> '' then
  begin
    DM1.AddSQL(QryTotPeriodo, 'AND', '(DescFuori = ''' + PrmBanca.Text + ''')');
  end;

  // Agenti
  if PrmAgente.Text <> '' then
    DM1.AddSQL(QryTotPeriodo, 'AND', 'AGENTE  = ''' + PrmAgente.Text + '''');
  if PrmAgente2.Text <> '' then
    DM1.AddSQL(QryTotPeriodo, 'AND', 'AGENTE2 = ''' + PrmAgente2.Text + '''');
  if PrmAgente3.Text <> '' then
    DM1.AddSQL(QryTotPeriodo, 'AND', 'AGENTE3 = ''' + PrmAgente3.Text + '''');
  if PrmAgente4.Text <> '' then
    DM1.AddSQL(QryTotPeriodo, 'AND', 'AGENTE4 = ''' + PrmAgente4.Text + '''');

  if PrmStato.Text <> '' then
    DM1.AddSQL(QryTotPeriodo, 'AND', 'STATODESCRIZIONE = ''' + PrmStato.Text + '''');

  if DM1.ControllaDataStr(PrmDal.EditText) then
    DM1.AddSQL(QryTotPeriodo, 'AND', 'Data >= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(PrmDal.EditText)) + '''');
  if DM1.ControllaDataStr(PrmAl.EditText) then
    DM1.AddSQL(QryTotPeriodo, 'AND', 'Data <= ''' + FormatDateTime('mm/dd/yyyy', StrToDate(PrmAl.EditText)) + '''');

  QryTotPeriodo.Open;
  // ==========================================================================
  // Si posizione all'inizio
  tvPrimanota.DataController.GotoFirst;
end;

procedure TClientiForm.PrmMesiTuttiMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    PrmMesiTuttiClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.PrmMesiNessunoMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    PrmMesiNessunoClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.PrmGenClick(Sender: TObject);
var
  GG, MM, AA: Word;
  Mese: Shortint;
begin
  // Mese contiene l'indice del mese premuto
  Mese := (Sender as TSpeedButton).Tag;
  // AA COntiene l'anno in corso
  DecodeDate(Date, AA, MM, GG);
  // Se il GroupIndex  <> 600 significa che  stato premuto il
  // tasto di selezione di tutti i mesi e quindi si comporta di conseguenza
  if (Sender as TSpeedButton).GroupIndex <> 600 then
  begin
    PrmMesiNessunoClick(Self);
    (Sender as TSpeedButton).Down := True;
  end;
  // Se il pulsante  premuto (down)...
  if (Sender as TSpeedButton).Down then
  begin
    // In base all'indice del mese imposta le date nel modo opportuno
    case Mese of
      1:
        begin
          PrmDal.EditText := ' 01/01/' + IntToStr(AA);
          PrmAl.EditText := ' 31/01/' + IntToStr(AA);
        end;
      2:
        begin
          PrmDal.EditText := ' 01/02/' + IntToStr(AA);
          PrmAl.EditText := ' ' + IntToStr(DaysInAMonth(CurrentYear, 2)) + '/02/' + IntToStr(AA);
        end;
      3:
        begin
          PrmDal.EditText := ' 01/03/' + IntToStr(AA);
          PrmAl.EditText := ' 31/03/' + IntToStr(AA);
        end;
      4:
        begin
          PrmDal.EditText := ' 01/04/' + IntToStr(AA);
          PrmAl.EditText := ' 30/04/' + IntToStr(AA);
        end;
      5:
        begin
          PrmDal.EditText := ' 01/05/' + IntToStr(AA);
          PrmAl.EditText := ' 31/05/' + IntToStr(AA);
        end;
      6:
        begin
          PrmDal.EditText := ' 01/06/' + IntToStr(AA);
          PrmAl.EditText := ' 30/06/' + IntToStr(AA);
        end;
      7:
        begin
          PrmDal.EditText := ' 01/07/' + IntToStr(AA);
          PrmAl.EditText := ' 31/07/' + IntToStr(AA);
        end;
      8:
        begin
          PrmDal.EditText := ' 01/08/' + IntToStr(AA);
          PrmAl.EditText := ' 31/08/' + IntToStr(AA);
        end;
      9:
        begin
          PrmDal.EditText := ' 01/09/' + IntToStr(AA);
          PrmAl.EditText := ' 30/09/' + IntToStr(AA);
        end;
      10:
        begin
          PrmDal.EditText := ' 01/10/' + IntToStr(AA);
          PrmAl.EditText := ' 31/10/' + IntToStr(AA);
        end;
      11:
        begin
          PrmDal.EditText := ' 01/11/' + IntToStr(AA);
          PrmAl.EditText := ' 30/11/' + IntToStr(AA);
        end;
      12:
        begin
          PrmDal.EditText := ' 01/12/' + IntToStr(AA);
          PrmAl.EditText := ' 31/12/' + IntToStr(AA);
        end;
    end;
    // Se invece il mese non  premuto...
  end
  else
  begin
    PrmDal.Text := '';
    PrmAl.Text := '';
  end;
end;

procedure TClientiForm.PrmGenMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  // Facendo click con il pulsante DX deseleziona tutti i tipo di documento tranne
  // quello su cui si  fatto click e poi richiama la ricerca.
  if Button = mbRight then
  begin
    (Sender as TSpeedButton).Down := True;
    PrmGenClick(Sender);
    RxSpeedButtonTrovaClick(Self);
  end;
end;

procedure TClientiForm.PrmExpandClick(Sender: TObject);
begin
  tvPrimanota.ViewData.Expand(True);
end;

procedure TClientiForm.PrmCollapseClick(Sender: TObject);
begin
  tvPrimanota.ViewData.Collapse(True);
end;

procedure TClientiForm.tvPrimanotaDataControllerGroupingChanged(Sender: TObject);
begin
  if tvPrimanota.GroupedColumnCount > 0 then
    tvPrimanota.OptionsView.GridLines := glBoth
  else
    tvPrimanota.OptionsView.GridLines := glVertical;
end;

procedure TClientiForm.tvPrimanotaDataControllerSortingChanged(Sender: TObject);
begin
  // F rifare l'interrogazione con il nuovo ordinamento
  // NB: Solo se non c' alcun raggruppamento
  if tvPrimanota.DataController.DataModeController.GridMode and (tvPrimanota.GroupedColumnCount = 0) then
    RxSpeedButtonTrovaClick(Self);
  tvPrimanota.Controller.GotoFirst(False);
end;

procedure TClientiForm.Stampamovimentiprimanota1Click(Sender: TObject);
var
  PrecFontSize: Integer;
begin
  try
    ClientiForm.GridPrimanotaLink.Component := GridPrimanota;
    ClientiForm.GridPrimanotaLink.ReportTitle.Text := 'Primanota';
    // Imposta la stringa su cui viene costruito il range di date della stampa in base ai filtri per data
    DM1.SetReportDateRange(PrmDal.EditText, PrmAl.EditText);
    // Prima di procedere rimpicciolisce il Fotn usato per le stampe
    PrecFontSize := DM1.PrintContentEven.Font.Size;
    DM1.PrintGridHeader.Font.Size := 6;
    DM1.PrintContentEven.Font.Size := 6;
    DM1.PrintContentOdd.Font.Size := 6;
    // Preview
    if MenuStampe.Tag = 0 then
    begin
      ClientiForm.dxPrinter.Preview(True, ClientiForm.GridPrimanotaLink);
      // Stampa
    end
    else if MenuStampe.Tag = 1 then
    begin
      ClientiForm.dxPrinter.Print(True, nil, ClientiForm.GridPrimanotaLink);
    end;
  finally
    // Ripristina il fotn precedente
    DM1.PrintGridHeader.Font.Size := PrecFontSize;
    DM1.PrintContentEven.Font.Size := PrecFontSize;
    DM1.PrintContentOdd.Font.Size := PrecFontSize;
  end;
end;

procedure TClientiForm.MenuPrimanotaPopup(Sender: TObject);
begin
  // In base ai permessi rende o meno visibili
  Movimentoprimanota1.Visible := (DM1.ModCtrl(MOD_PRIMANOTA) > 1);
  // Richiama il gestore di default dell'evento
  PopupMenuPopupGestoreDefault(Sender);
end;

procedure TClientiForm.Movimentoprimanota1Click(Sender: TObject);
begin
  DM1.Attendere;
  try
    Application.CreateForm(TPrimanotaForm, PrimanotaForm);
    PrimanotaForm.Parent := MainForm;
    PrimanotaForm.Tag := 2;
    PrimanotaForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.Caricocantiere1Click(Sender: TObject);
begin
  GoToNuovoDocFisc('Carico_cantiere');
end;

procedure TClientiForm.Commessa1Click(Sender: TObject);
begin
  GoToNuovoDocFisc('Commessa');
end;

procedure TClientiForm.Estrattoconto1Click(Sender: TObject);
begin
  GoToNuovoDocFisc('Estratto_conto');
end;

procedure TClientiForm.Scaricocantiere1Click(Sender: TObject);
begin
  GoToNuovoDocFisc('Scarico_cantiere');
end;

procedure TClientiForm.SBDocFilterOpenCloseClick(Sender: TObject);
begin
  if PanelDocFiltri.Tag = 1 then
    CloseFilterPanel(PanelDocFiltri, SBDocFilterOpenClose)
  else
    OpenFilterPanel(PanelDocFiltri, SBDocFilterOpenClose);
end;

procedure TClientiForm.SBRubricaFilterOpenCloseClick(Sender: TObject);
begin
  if PanelFiltriSogg.Tag = 1 then
    CloseFilterPanel(PanelFiltriSogg, SBRubricaFilterOpenClose)
  else
    OpenFilterPanel(PanelFiltriSogg, SBRubricaFilterOpenClose);

end;

procedure TClientiForm.GridDocFileDrop(var Msg: TWMDROPFILES);
var
  LNumFiles: Longint;
  LFileNameBuffer: array [0 .. MAX_PATH] of Char;
  LInvoice: IeiInvoiceMini;
  LPersister: ILevanteInvoicePersister;
begin
  LNumFiles := DragQueryFile(Msg.Drop, $FFFFFFFF, nil, 0);
  if LNumFiles > 1 then
  begin
    ShowMessage('E'' possibile trascinare solo 1 file alla volta!');
  end
  else
  begin
    DragQueryFile(Msg.Drop, 0, @LFileNameBuffer, sizeof(LFileNameBuffer));
    try
      LInvoice := TeiInvoiceMiniFactory.NewInvoiceFromFile(LFileNameBuffer);
      LPersister := TInvoicePersisterFactory.NewLevanteInvoicePersister(LInvoice);
      LPersister.SaveToLevante(True, ExtractFileName(DM1.OpenDialog1.FileName), 'rtLoadedFromFile');
    except
      on EInvalidGraphic do
        ShowMessage('Unsupported image file, or not an image!');
    end;
  end;
end;

procedure TClientiForm.GridDocWindowProc(var Msg: TMessage);
begin
  if Msg.Msg = WM_DROPFILES then
    GridDocFileDrop(TWMDROPFILES(Msg))
  else
    FOriginalPanelWindowProc_Documenti(Msg);
end;

procedure TClientiForm.GridSoggResize(Sender: TObject);
begin
  ShapeBordoSogg.Height := GridSogg.Height;
end;

procedure TClientiForm.SBGMFilterOpenCloseClick(Sender: TObject);
begin
  if PanelGMFiltri.Tag = 1 then
    CloseFilterPanel(PanelGMFiltri, SBGMFilterOpenClose)
  else
    OpenFilterPanel(PanelGMFiltri, SBGMFilterOpenClose);
end;

procedure TClientiForm.SBPratFilterOpenCloseClick(Sender: TObject);
begin
  if PanelPratFiltri.Tag = 1 then
    CloseFilterPanel(PanelPratFiltri, SBPratFilterOpenClose)
  else
    OpenFilterPanel(PanelPratFiltri, SBPratFilterOpenClose);
end;

procedure TClientiForm.SBScadFilterOpenCloseClick(Sender: TObject);
begin
  if PanelScadFiltri.Tag = 1 then
    CloseFilterPanel(PanelScadFiltri, SBScadFilterOpenClose)
  else
    OpenFilterPanel(PanelScadFiltri, SBScadFilterOpenClose);
end;

procedure TClientiForm.SBPrimanotFilterOpenCloseClick(Sender: TObject);
begin
  if PanelPrimanotFiltri.Tag = 1 then
    CloseFilterPanel(PanelPrimanotFiltri, SBPrimanotFilterOpenClose)
  else
    OpenFilterPanel(PanelPrimanotFiltri, SBPrimanotFilterOpenClose);
end;

procedure TClientiForm.SBArtFilterOpenCloseClick(Sender: TObject);
begin
  if PanelFiltri.Tag = 1 then
    CloseFilterPanel(PanelFiltri, SBArtFilterOpenClose)
  else
    OpenFilterPanel(PanelFiltri, SBArtFilterOpenClose);
end;

procedure TClientiForm.SBImpFilterOpenCloseClick(Sender: TObject);
begin
  if PanelImpFiltri.Tag = 1 then
    CloseFilterPanel(PanelImpFiltri, SBImpFilterOpenClose)
  else
    OpenFilterPanel(PanelImpFiltri, SBImpFilterOpenClose);
end;

procedure TClientiForm.SBGosFilterOpenCloseClick(Sender: TObject);
begin
  if PanelGosFiltri.Tag = 1 then
    CloseFilterPanel(PanelGosFiltri, SBGosFilterOpenClose)
  else
    OpenFilterPanel(PanelGosFiltri, SBGosFilterOpenClose);
end;

procedure TClientiForm.Intervento1Click(Sender: TObject);
begin
  DM1.Attendere;
  try
    GoToNuovoAppuntamento('Intervento');
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.tvImpegniEndDrag(Sender, Target: TObject; X, Y: Integer);
begin
  // Prima di tutto controlla che il bersaglio non sia nullo
  if Target <> nil then
  begin
    // In base al bersaglio attiva la funzione corretta.
    if Target is TSpeedButton then
    begin
      TSpeedButton(Target).OnClick(Self);
      // Se il target  una TListView...
    end
    else if Target is TListView then
    begin
      // Se il target  la TListView che contiene i documenti esportati, esporta i documenti
      // selezionati
      if (Target as TListView).Name = 'ListViewExpDoc' then
      begin
        DM1.EsportaImpegniSelezionati;
        MainForm.AggiornaDocumentiEsportati;
      end;
    end;
  end;
end;

// Funzione che ritorna la Grid relativa alla pagina attualmente visualizzate
function TClientiForm.GetCurrentGrid: TcxControl;
begin
  // Inizializzazione
  Result := nil;
  // In base alla pagina selezionata Elenco Viste punta alla griglia
  // corretta
  if PageControl2.ActivePage = TabClienti then
    Result := GridSogg
  else if PageControl2.ActivePage = TabArticoli then
    Result := GridArt
  else if (PageControl2.ActivePage = TabDocumenti) and (PageControlDoc.ActivePage = TabSheetDocGrid) then
    Result := GridDoc
  else if (PageControl2.ActivePage = TabDocumenti) and (PageControlDoc.ActivePage = TabSheetDocADA) then
    Result := PivotGridDoc
  else if (PageControl2.ActivePage = TabMagazzino) and (PageControlGM.ActivePage = TabGMGrid) then
    Result := GridGM
  else if (PageControl2.ActivePage = TabMagazzino) and (PageControlGM.ActivePage = TabGMADA) then
    Result := PivotGridGM
  else if PageControl2.ActivePage = TabCondVend then
    Result := GridCV
  else if PageControl2.ActivePage = TabPratiche then
    Result := GridPrat
  else if (PageControl2.ActivePage = TabScadenze) and (PageControlScad.ActivePage = TabScadElenco) then
    Result := GridScad
  else if (PageControl2.ActivePage = TabScadenze) and (PageControlScad.ActivePage = TabScadADA) then
    Result := PivotGridScad
  else if PageControl2.ActivePage = TabImpegni then
    Result := GridImpegni
  else if PageControl2.ActivePage = TabPrimanota then
    Result := GridPrimanota
  else if PageControl2.ActivePage = TabAgenda then
    Result := Agenda
  else if (PageControl2.ActivePage = TabGOS) and (cxPageControlGOS.ActivePage = TabManodopera) and (cxPageControlGOSOre.ActivePage = TabGOSOreElenco) then
    Result := GridOre
  else if (PageControl2.ActivePage = TabGOS) and (cxPageControlGOS.ActivePage = TabManodopera) and (cxPageControlGOSOre.ActivePage = TabGosOreAda) then
    Result := GosOrePivot
  else if (PageControl2.ActivePage = TabGOS) and (cxPageControlGOS.ActivePage = TabSpese) and (cxPageControlGOSSpese.ActivePage = TabGOSSpeseElenco) then
    Result := GridSpese
  else if (PageControl2.ActivePage = TabGOS) and (cxPageControlGOS.ActivePage = TabSpese) and (cxPageControlGOSSpese.ActivePage = TabGosSpeseAda) then
    Result := GosSpesePivot;
end;

procedure TClientiForm.EsportainformatoExcel1Click(Sender: TObject);
var
  CurrGrid: TcxControl;
  FileNameNoExt: String;
begin
  // In base alla pagina selezionata Elenco Viste punta alla griglia
  // corretta
  CurrGrid := GetCurrentGrid;
  // Richiede all'utente il nome del file
  // NB: Prima azzera il nome del file
  DM1.ExcelSaveDialog.FileName := '';
  if DM1.ExcelSaveDialog.Execute then
  begin
    FileNameNoExt := LeftStr(DM1.ExcelSaveDialog.FileName, (Length(DM1.ExcelSaveDialog.FileName) - Length(ExtractFileExt(DM1.ExcelSaveDialog.FileName))));
    // Verifica che il file non esista gi, e se esiste chiede se lo si vuole sovrascrivere
    if FileExists(FileNameNoExt + '.xls') then
    begin
      if DM1.Messaggi('Esportazione', 'File gi esistente !!!'#13#13'Devo proseguire e sovrascrivere il file?',
        'NB: Rispondendo "SI" e quindi sovrascrivendo il file esistente i dati in esso contenuti saranno perduti.', [mbYes, mbNo], 0, nil) <> mrYes then
        Exit;
    end;
    // Informa l'utente
    DM1.ShowWait('Esportazione Excel', 'Operazione in corso...');
    try
      if CurrGrid is TcxGrid then
      begin

        // =========================================================================
        // ESPORTAZIONE DA UNA GXGRID
        // -------------------------------------------------------------------------
        (CurrGrid as TcxGrid).BeginUpdate;
        try;
          ExportGridToExcel(FileNameNoExt, // FileName senza estensione
            (CurrGrid as TcxGrid), // cxGrid
            False, // AExpand
            True, // ASaveAll
            True, // AUseNativeFOrmat
            'xls' // AFileExt
            );
        finally
          (CurrGrid as TcxGrid).EndUpdate;
        end;
        // =========================================================================

      end
      else if CurrGrid is TcxDBPivotGrid then
      begin

        // =========================================================================
        // ESPORTAZIONE DA UNA PIVOTGRID
        // -------------------------------------------------------------------------
        (CurrGrid as TcxDBPivotGrid).BeginUpdate;
        try;
          cxExportPivotGridToExcel(FileNameNoExt, // FileName senza estensione
            (CurrGrid as TcxDBPivotGrid), // cxPivotGrid
            False, // AExpand
            True, // AUseNativeFOrmat
            'xls' // AFileExt
            );
        finally
          (CurrGrid as TcxDBPivotGrid).EndUpdate;
        end;
        // =========================================================================

      end;
    finally
      DM1.CloseWait;
      DM1.Messaggi('Levante - Esportazione dati', 'Operazione terminata.', '', [mbOk], 0, nil);
    end;
  end;
end;

procedure TClientiForm.DocConCantiereMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
var
  CheckIndex, I: Integer;
  CurrCheckListBox: TCheckListBox;
begin
  // ----------------------------------------------------------------------------------------------------
  // Questo codice server per fare in modo che anche se l'utente clicca sul titolo della voce, questa
  // venga selezinata o deselezionata come se si fosse cliccato sul riquadrino del segno di check)
  // ----------------------------------------------------------------------------------------------------
  // La variabie CurrCheckListBox Punta alla CheckListBox che ha richiamata l'evento
  CurrCheckListBox := Sender as TCheckListBox;
  // Solo se s cliccato con il pulsante SX del mouse
  if Button = mbLeft then
  begin
    // Quale voce si trova sotto il mouse?
    CheckIndex := CurrCheckListBox.ItemAtPos(Point(X, Y), True);
    // Se c'era una voce cambia il suo stato
    if CheckIndex <> -1 then
    begin
      if CurrCheckListBox.Tag = 0 then
        CurrCheckListBox.Checked[CheckIndex] := not CurrCheckListBox.Checked[CheckIndex];
      // Rimette la Propriet Tag del componente = 0
      CurrCheckListBox.Tag := 0;
    end;
    // Se  il caso deseleziona tutto e seleziona automaticamente
    // solo gli interventi.
    with (Sender as TCheckListBox) do
    begin
      if Checked[0] xor Checked[1] then
      begin
        SBDocNessunoClick(SBDocNessuno);
        DocVendite.Items[DocumentiAttivi[1, 14]].Checked := True;
      end;
    end;
    // Se invece  stato premuto il pulsante DX
  end
  else if Button = mbRight then
  begin
    // Quale voce si trova sotto il mouse?
    CheckIndex := CurrCheckListBox.ItemAtPos(Point(X, Y), True);
    // Deseleziona tutti i documenti
    for I := 0 to CurrCheckListBox.Count - 1 do
      CurrCheckListBox.Checked[I] := False;
    // Chekka il documento
    CurrCheckListBox.Checked[CheckIndex] := True;
    // Se  il caso deseleziona tutto e seleziona automaticamente
    // solo gli interventi.
    with (Sender as TCheckListBox) do
    begin
      if Checked[0] xor Checked[1] then
      begin
        SBDocNessunoClick(SBDocNessuno);
        DocVendite.Items[DocumentiAttivi[1, 14]].Checked := True;
      end;
    end;
    // Esegue la ricerca
    RxSpeedButtonTrovaClick(Self);
  end;
  // F in modo che non resti una voce selezionata e quindi evidenziata che non mi piace
  CurrCheckListBox.ItemIndex := -1;
  // ----------------------------------------------------------------------------------------------------
end;

procedure TClientiForm.ImpConCantiereMouseUp(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
var
  CheckIndex, I: Integer;
  CurrCheckListBox: TCheckListBox;
begin
  // ----------------------------------------------------------------------------------------------------
  // Questo codice server per fare in modo che anche se l'utente clicca sul titolo della voce, questa
  // venga selezinata o deselezionata come se si fosse cliccato sul riquadrino del segno di check)
  // ----------------------------------------------------------------------------------------------------
  // La variabie CurrCheckListBox Punta alla CheckListBox che ha richiamata l'evento
  CurrCheckListBox := Sender as TCheckListBox;
  // Solo se s cliccato con il pulsante SX del mouse
  if Button = mbLeft then
  begin
    // Quale voce si trova sotto il mouse?
    CheckIndex := CurrCheckListBox.ItemAtPos(Point(X, Y), True);
    // Se c'era una voce cambia il suo stato
    if CheckIndex <> -1 then
    begin
      if CurrCheckListBox.Tag = 0 then
        CurrCheckListBox.Checked[CheckIndex] := not CurrCheckListBox.Checked[CheckIndex];
      // Rimette la Propriet Tag del componente = 0
      CurrCheckListBox.Tag := 0;
    end;
    // Se invece  stato premuto il pulsante DX
  end
  else if Button = mbRight then
  begin
    // Quale voce si trova sotto il mouse?
    CheckIndex := CurrCheckListBox.ItemAtPos(Point(X, Y), True);
    // Deseleziona tutti i documenti
    for I := 0 to CurrCheckListBox.Count - 1 do
      CurrCheckListBox.Checked[I] := False;
    // Chekka il documento
    CurrCheckListBox.Checked[CheckIndex] := True;
    // Esegue la ricerca
    RxSpeedButtonTrovaClick(Self);
  end;
  // F in modo che non resti una voce selezionata e quindi evidenziata che non mi piace
  CurrCheckListBox.ItemIndex := -1;
  // ----------------------------------------------------------------------------------------------------
end;

procedure TClientiForm.EsportinventarioultimocostoinformatoEXCEL1Click(Sender: TObject);
type
  TColSave = record
    Visible: Boolean;
    VisibleIndex: Byte;
    Tag: Integer;
  end;
var
  ColSave: array of TColSave;
  ColToPrint: set of Byte;
  I: Byte;
  FileNameNoExt: String;
begin
  // Richiede all'utente il nome del file
  // NB: Prima azzera il nome del file
  DM1.ExcelSaveDialog.FileName := '';
  if DM1.ExcelSaveDialog.Execute then
  begin
    FileNameNoExt := LeftStr(DM1.ExcelSaveDialog.FileName, (Length(DM1.ExcelSaveDialog.FileName) - Length(ExtractFileExt(DM1.ExcelSaveDialog.FileName))));
    // Verifica che il file non esista gi, e se esiste chiede se lo si vuole sovrascrivere
    if FileExists(FileNameNoExt + '.xls') then
    begin
      if DM1.Messaggi('Esportazione', 'File gi esistente !!!'#13#13'Devo proseguire e sovrascrivere il file?',
        'NB: Rispondendo "SI" e quindi sovrascrivendo il file esistente i dati in esso contenuti saranno perduti.', [mbYes, mbNo], 0, nil) <> mrYes then
        Exit;
    end;
    // Inserisce in ColToPrint gli Index delle colonne che dovranno essere stampate e quindi visibili
    ColToPrint := [tvArtCODICEARTICOLO.Index, tvArtDESCRIZIONE.Index, tvArtULTIMOCOSTOREALE.Index, tvArtUNITADIMISURA.Index, tvArtGIACENZA.Index,
      tvArtIMPORTOULTIMOCOSTOREALE.Index];
    // Inizializza la struttura che conterr le impostazioni delle colonne da ripristinare alla fine
    SetLength(ColSave, 0);
    // Ora cicla per tutte le colonne della TableView...
    // In questo ciclo rende invisibili tutte le colonne che non devono essere stampate
    for I := 0 to tvArt.ColumnCount - 1 do
    begin
      // Prima di tutto salva alcune propriet della colonna nell'apposita struttura per poter poi ripristinare il tutto
      SetLength(ColSave, I + 1);
      ColSave[I].Visible := tvArt.Columns[I].Visible;
      ColSave[I].VisibleIndex := tvArt.Columns[I].VisibleIndex;
      ColSave[I].Tag := tvArt.Columns[I].Tag;
      // Metto la propeiet Tag := 0 perch altrimenti alcune colonne che voglio vengano stampate in questa stampa
      // verebbero rese invisibili dalla procedura di preparazione delle View per la stampa in quanto
      // la sua propriet Tag = -1;
      tvArt.Columns[I].Tag := 0;
      // Poi se la colonna attuale non  tra quelle che devono rimanere visibili le rende invisibili
      tvArt.Columns[I].Visible := (I in ColToPrint);
    end;
    // Ora che sono visibili solo le colonne che mi interessano le metto nell'ordine che voglio
    // tvArtCODICEARTICOLO.VisibleIndex           := 0;
    // tvArtDESCRIZIONE.VisibleIndex              := 1;
    // tvArtULTIMOCOSTOREALE.VisibleIndex         := 2;
    // tvArtUNITADIMISURA.VisibleIndex            := 3;
    // tvArtGIACENZA.VisibleIndex                 := 4;
    // tvArtIMPORTOULTIMOCOSTOREALE.VisibleIndex  := 5;
    DM1.ShowWait('Esportazione Excel', 'Operazione in corso...');
    try
      // =========================================================================
      // ESPORTAZIONE DA UNA GXGRID
      // -------------------------------------------------------------------------
      GridArt.BeginUpdate;
      try;
        ExportGridToExcel(FileNameNoExt, // FileName senza estensione
          GridArt, // cxGrid
          False, // AExpand
          True, // ASaveAll
          True, 'xls' // AFileExt
          );
      finally
        GridArt.EndUpdate;
      end;
      // =========================================================================
    finally
      DM1.CloseWait;
      // Cicla per tutte le colonne per ripristinare le propriet
      for I := 0 to tvArt.ColumnCount - 1 do
      begin
        tvArt.Columns[I].Visible := ColSave[I].Visible;
        // tvArt.Columns[i].VisibleIndex  := ColSave[i].VisibleIndex;
        tvArt.Columns[I].Tag := ColSave[I].Tag;
      end;
    end;
  end;
end;

procedure TClientiForm.StampacumulativadelKITperiltecnicodegliappuntamentiselezionati1Click(Sender: TObject);
var
  DocNum, I: Integer;
begin
  try
    // Cicla per tutti gli impegni selezionati.
    for I := 0 to tvImpegni.Controller.SelectedRecordCount - 1 do
    begin
      Application.ProcessMessages;
      // RIcava il codice del documento
      DocNum := tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniID.Index];
      // Apre l'impegno
      Application.ProcessMessages;
      DM1.ApriImpegno(DocNum, False);
      Application.ProcessMessages;
      try
        // Esegue la stampa
        Application.ProcessMessages;
        ImpegnoForm.MenuStampe.Tag := Self.MenuStampe.Tag;
        Application.ProcessMessages;
        ImpegnoForm.StampaKITperiltecnico1Click(ImpegnoForm.StampaKITperiltecnico1);
        Application.ProcessMessages;
      finally
        Application.ProcessMessages;
        ImpegnoForm.Close;
        Application.ProcessMessages;
      end;
    end;
  finally
    DM1.Messaggi('Stampa cumulativa appuntamenti', 'Operazione terminata!', '', [mbOk], 0, nil);
  end;
end;

procedure TClientiForm.StampacumulativadelFoglidiLavorodegliappuntamentiselezionati1Click(Sender: TObject);
var
  DocNum, I: Integer;
begin
  try
    // Cicla per tutti gli impegni selezionati.
    for I := 0 to tvImpegni.Controller.SelectedRecordCount - 1 do
    begin
      Application.ProcessMessages;
      // RIcava il codice del documento
      DocNum := tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniID.Index];
      // Apre l'impegno
      Application.ProcessMessages;
      DM1.ApriImpegno(DocNum, False);
      Application.ProcessMessages;
      try
        // Esegue la stampa
        Application.ProcessMessages;
        ImpegnoForm.StampaFoglioDiLavoro((Self.MenuStampe.Tag = 0), True, DM1.TableProgressiviFL_COPIE.AsInteger);
        Application.ProcessMessages;
      finally
        Application.ProcessMessages;
        ImpegnoForm.Close;
        Application.ProcessMessages;
      end;
    end;
  finally
    DM1.Messaggi('Stampa cumulativa appuntamenti', 'Operazione terminata!', '', [mbOk], 0, nil);
  end;
end;

procedure TClientiForm.StampacumulativadelKITperiltecnicodegliappuntamentiselezionati2Click(Sender: TObject);
var
  I: Integer;
  IdArray: array of Integer;
begin
  Agenda.BeginUpdate;
  try
    // Prima di tutto cicla per riempire un array con tutti gli ID
    // degli appuntamenti selezionati
    // NB: Faccio cos perch altrimenti ma dava un errore
    SetLength(IdArray, Agenda.SelectedEventCount);
    for I := 0 to Agenda.SelectedEventCount - 1 do
      IdArray[I] := Agenda.SelectedEvents[I].ID;
    // Cicla per tutti gli interventi e li stampa
    for I := 0 to Agenda.SelectedEventCount - 1 do
    begin
      // Apre l'impegno e disabilita il refresh dell'agenda alla chiusura dell'impegno stesso
      Application.ProcessMessages;
      DM1.ApriImpegno(IdArray[I], False);
      ImpegnoForm.AgendaRefreshOnClose := False;
      Application.ProcessMessages;
      try
        // Esegue la stampa
        Application.ProcessMessages;
        ImpegnoForm.MenuStampe.Tag := Self.MenuStampe.Tag;
        Application.ProcessMessages;
        ImpegnoForm.StampaKITperiltecnico1Click(ImpegnoForm.StampaKITperiltecnico1);
        Application.ProcessMessages;
      finally
        Application.ProcessMessages;
        ImpegnoForm.Close;
        Application.ProcessMessages;
      end;
    end;
  finally
    Agenda.EndUpdate;
    DM1.Messaggi('Stampa cumulativa appuntamenti', 'Operazione terminata!', '', [mbOk], 0, nil);
    // Se  visibile l'agenda (laterale o classica) la aggiorna
    if Assigned(ClientiForm.AgendaForm) and (ClientiForm.AgendaForm.Splitter.State = ssOpened) then
      ClientiForm.AgendaForm.EseguiQueryAgenda;
    if (ClientiForm.PageControl2.ActivePage = ClientiForm.TabAgenda) then
      ClientiForm.RxSpeedButtonTrovaClick(MainForm.RxSpeedButtonTrova);
  end;
end;

procedure TClientiForm.StampacumulativadelFogliodiLavorodegliappuntamentiselezionati1Click(Sender: TObject);
var
  I: Integer;
  IdArray: array of Integer;
begin
  Agenda.BeginUpdate;
  try
    // Prima di tutto cicla per riempire un array con tutti gli ID
    // degli appuntamenti selezionati
    // NB: Faccio cos perch altrimenti ma dava un errore
    SetLength(IdArray, Agenda.SelectedEventCount);
    for I := 0 to Agenda.SelectedEventCount - 1 do
      IdArray[I] := Agenda.SelectedEvents[I].ID;
    // Cicla per tutti gli interventi e li stampa
    for I := 0 to Agenda.SelectedEventCount - 1 do
    begin
      // Apre l'impegno e disabilita il refresh dell'agenda alla chiusura dell'impegno stesso
      Application.ProcessMessages;
      DM1.ApriImpegno(IdArray[I], False);
      ImpegnoForm.AgendaRefreshOnClose := False;
      Application.ProcessMessages;
      try
        // Esegue la stampa
        Application.ProcessMessages;
        ImpegnoForm.StampaFoglioDiLavoro((Self.MenuStampe.Tag = 0), True, DM1.TableProgressiviFL_COPIE.AsInteger);
        Application.ProcessMessages;
      finally
        Application.ProcessMessages;
        ImpegnoForm.Close;
        Application.ProcessMessages;
      end;
    end;
  finally
    Agenda.EndUpdate;
    DM1.Messaggi('Stampa cumulativa appuntamenti', 'Operazione terminata!', '', [mbOk], 0, nil);
    // Se  visibile l'agenda (laterale o classica) la aggiorna
    if Assigned(ClientiForm.AgendaForm) and (ClientiForm.AgendaForm.Splitter.State = ssOpened) then
      ClientiForm.AgendaForm.EseguiQueryAgenda;
    if (ClientiForm.PageControl2.ActivePage = ClientiForm.TabAgenda) then
      ClientiForm.RxSpeedButtonTrovaClick(MainForm.RxSpeedButtonTrova);
  end;
end;

procedure TClientiForm.CalcolaLeftFiltriSubPanel(PanelFiltriMain: TPanel);
var
  WidthDiff, NewLeft: Integer;
  FiltriSubPanel: TPanel;
begin
  // Ricava il SubPanel da centrare
  FiltriSubPanel := PanelFiltriMain.Controls[0] as TPanel;
  // Calcolo della posizione del SubPanel
  WidthDiff := PanelFiltriMain.Width - FiltriSubPanel.Width;
  NewLeft := Trunc(WidthDiff / 2);
  if NewLeft < 0 then
    NewLeft := 0;
  // Assegna la nuova posizione
  FiltriSubPanel.Left := NewLeft;
  PanelFiltriMain.Update;
end;

procedure TClientiForm.PanelFiltriSoggResize(Sender: TObject);
begin
  CalcolaLeftFiltriSubPanel(Sender as TPanel);
end;

procedure TClientiForm.PivotGridDocDblClick(Sender: TObject);
var
  ACrossCell: TcxPivotGridCrossCell;
begin
  // Se l'utente ha fatto doppioclick su una cella visualizza il relativo dettaglio
  with (Sender as TcxDBPivotGrid).HitTest do
  begin
    if HitAtDataCell then
    begin
      DM1.ShowWait('Levante', 'Operazione in corso...');
      try
        // ACrossCel contiene il puntatore alla cella sul quale l'utente ha fatto doppioclick
        ACrossCell := TcxPivotGridDataCellViewInfo(HitObject).CrossCell;
        // Crea e visualizza la form con il teggalio
        if DocPivotDetailForm = nil then
        begin
          DocPivotDetailForm := TDocPivotDetailForm.Create(Self, TabSheetDocADA, ACrossCell, tvDoc);
          DocPivotDetailForm.Show;
        end;
      finally
        DM1.CloseWait;
      end;
    end;
  end;
end;

procedure TClientiForm.PivotGridGMDblClick(Sender: TObject);
var
  ACrossCell: TcxPivotGridCrossCell;
begin
  // Se l'utente ha fatto doppioclick su una cella visualizza il relativo dettaglio
  with (Sender as TcxDBPivotGrid).HitTest do
  begin
    if HitAtDataCell then
    begin
      DM1.ShowWait('Levante', 'Operazione in corso...');
      try
        // ACrossCel contiene il puntatore alla cella sul quale l'utente ha fatto doppioclick
        ACrossCell := TcxPivotGridDataCellViewInfo(HitObject).CrossCell;
        // Crea e visualizza la form con il teggalio
        if GMPivotDetailForm = nil then
        begin
          GMPivotDetailForm := TGMPivotDetailForm.Create(Self, TabGMADA, ACrossCell, tvGM);
          GMPivotDetailForm.Show;
        end;
      finally
        DM1.CloseWait;
      end;
    end;
  end;
end;

procedure TClientiForm.Panel3Resize(Sender: TObject);
begin
  with (Sender as TPanel) do
  begin
    SBPagamentoRiscossione.Left := Trunc((Width - SBPagamentoRiscossione.Width) / 2);
  end;
end;

procedure TClientiForm.FormDestroy(Sender: TObject);
begin
  MainForm.Repaint;
  Application.ProcessMessages;
  // Distrugge il men agiungi in modo che se cambia l'utente il men venga rgenerato
  // con i permessi del nuovo utente
  if Assigned(MenuAggiungiForm) then
    MenuAggiungiForm.Free;
end;

// =============================================================================
// INIZIO STAMPA INVENTARIO ULTIMO COSTO SU STAMPANTE AD AGHI
// -----------------------------------------------------------------------------
procedure TClientiForm.StampaInventarioUltimoCostoSuStampanteAghi;
var
  LO: TMemIniFile;
  Inventario: TStrings;
  Riga: String;
  NumRigo, NumRighePagina, NumRigheSaltoPagina, PortaLPT, Pag: Integer;
  TotInventario: Double;

procedure AddRiga(NewRiga: String); forward;

  procedure StampaFineInventario;
  begin
    AddRiga('|------------------------------------------------------------------------------------------------------------------------------------|');
    AddRiga('|                                                                                           TOTALE INVENTARIO:   ' +
      DM1.PadR(FloatToStrF(TotInventario, ffCurrency, 15, 2), ' ', 20) + '|');
    AddRiga('======================================================================================================================================');
  end;

  procedure StampaIntestazione;
  begin
    AddRiga('--------------------------------------------------------------------------------------------------------------------------------------');
    AddRiga('|Inventario ultimo costo della ditta "' + DM1.PadL((DM1.TableDatiAziendaRAGIONESOCIALE.AsString + '"'), ' ', 50) + '                   |Data ' +
      DateToStr(Date) + '|Pag. ' + DM1.PadR(IntToStr(Pag), '0', 4) + '|');
    AddRiga('|------------------------------------------------------------------------------------------------------------------------------------|');
    AddRiga('|     Codice articolo     |                        Descrizione                         |Prezzo unitario|UM| Quantit |    Importo    |');
    AddRiga('|------------------------------------------------------------------------------------------------------------------------------------|');
  end;

  procedure StampaFinePagina;
  begin
    Inventario.Add('--------------------------------------------------------------------------------------------------------------------------------------');
  end;

  procedure AddRiga(NewRiga: String);
  var
    I: Integer;
  begin
    Inventario.Add(NewRiga);
    Inc(NumRigo);
    // Controllo salto pagina
    if NumRigo >= (NumRighePagina) then
    begin
      StampaFinePagina;
      for I := 1 to NumRigheSaltoPagina do
        Inventario.Add(' ');
      Inc(Pag);
      NumRigo := 1;
      StampaIntestazione;
    end;
  end;

begin
  // Caricamento parametri
  LO := TMemIniFile.Create(DM1.Repository_Layouts.FullLocalFileName);
  try
    NumRighePagina := LO.ReadInteger('FormAnagraficaArticoli', 'StampaInventarioAghiRighePagina', 60);
    NumRigheSaltoPagina := LO.ReadInteger('FormAnagraficaArticoli', 'StampaInventarioAghiSaltoPagina', 6);
    PortaLPT := LO.ReadInteger('FormAnagraficaArticoli', 'StampaInventarioAghiLPT', 1);
  finally
    LO.Free;
  end;
  // Inizializzazione
  Pag := 1;
  NumRigo := 1;
  TotInventario := 0;
  QryArticoli.First;
  Inventario := TStringList.Create;
  QryArticoli.DisableControls;
  try
    // Stampa dell'intestazione
    StampaIntestazione;
    // =========================================================================
    // CORPO INVENTARIO
    // -------------------------------------------------------------------------
    // Cicla per tutti gli articoli presenti nell'elenco articoli e li aggiunge
    // all'inventario
    while not QryArticoli.Eof do
    begin
      // Inizializzazione riga
      Riga := '';
      // Codice articolo
      Riga := Riga + '|' + LeftStr(DM1.PadL(QryArticoliCODICEARTICOLO.AsString, ' ', 25), 25);
      // Descrizione
      Riga := Riga + '|' + LeftStr(DM1.PadL(QryArticoliDESCRIZIONE.AsString, ' ', 60), 60);
      // Prezzo unitario
      Riga := Riga + '|' + DM1.PadR(QryArticoliULTIMOCOSTOREALE.Text, ' ', 15);
      // UM
      Riga := Riga + '|' + LeftStr(DM1.PadL(QryArticoliUNITADIMISURA.AsString, ' ', 2), 2);
      // Qta
      Riga := Riga + '|' + DM1.PadR(QryArticoliGIACENZA.Text, ' ', 10);
      // Importo
      Riga := Riga + '|' + DM1.PadR(QryArticoliIMPORTOULTIMOCOSTOREALE.Text, ' ', 15);
      // Finale
      Riga := Riga + '|';
      // Inserisce la nuova riga nell'inventario
      AddRiga(Riga);
      // Aggiorna il totale
      if not QryArticoliIMPORTOULTIMOCOSTOREALE.IsNull then
        TotInventario := TotInventario + QryArticoliIMPORTOULTIMOCOSTOREALE.Value;
      // Avanti il prossimo
      QryArticoli.Next;
    end;
    // =========================================================================
    // Chiusura inventario
    StampaFineInventario;
    // Salva tutto nel file
    Inventario.SaveToFile(DM1.CartellaTmp + 'inventario.txt');
    // Invia il file alla stampante ad aghi
    DM1.CopiaFile(DM1.CartellaTmp + 'inventario.txt', ('LPT' + IntToStr(PortaLPT) + ':'));
  finally
    QryArticoli.EnableControls;
    Inventario.Free;
  end;
end;
// -----------------------------------------------------------------------------
// FINE STAMPA INVENTARIO ULTIMO COSTO SU STAMPANTE AD AGHI
// =============================================================================

procedure TClientiForm.Stampainventarioultimocostosustampanteadaghi1Click(Sender: TObject);
begin
  DM1.ShowWait('Stampa inventario', 'Operazione in corso...');
  try
    StampaInventarioUltimoCostoSuStampanteAghi;
  finally
    DM1.CloseWait;
  end;
end;

procedure TClientiForm.tvPrimanotaCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo;
  var ADone: Boolean);
begin
  // Solo se non  selezionata
  if not AViewInfo.Selected then
  begin
    // IMposta il colore del Font in base allo stato del documento
    if (not VarIsNull(AViewInfo.GridRecord.Values[tvPrimanota.GetColumnByFieldName('STATODESCRIZIONE').Index])) and
      (not VarIsNull(AViewInfo.GridRecord.Values[tvPrimanota.GetColumnByFieldName('STATOFOREGROUND').Index])) then
    begin
      ACanvas.Font.Color := DM1.StrToColor(AViewInfo.GridRecord.Values[tvPrimanota.GetColumnByFieldName('STATOFOREGROUND').Index], ACanvas.Font.Color);
    end;
  end;
end;

procedure TClientiForm.PrmStatoPropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
begin
  // Carica l'elenco dei costruttori
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('SELECT DESCRIZIONE FROM STATI WHERE TIPODOCUMENTO=''Primanota''');
    Qry.Open;
    (Sender as TcxComboBox).Properties.Items.Clear;
    while not Qry.Eof do
    begin
      (Sender as TcxComboBox).Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.OperatorePropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
begin
  // Carica l'elenco dei costruttori
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.GenDBFile;
    Qry.IB_Connection := DM1.DBGenerale;
    Qry.SQL.Add('SELECT DISTINCT NOMEUTENTE FROM SECURITY');
    Qry.Open;
    (Sender as TcxComboBox).Properties.Items.Clear;
    (Sender as TcxComboBox).Properties.Items.Add('');
    while not Qry.Eof do
    begin
      (Sender as TcxComboBox).Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.Button5Click(Sender: TObject);
var
  QryArt: TIB_Cursor;
  QryModArt: TIB_Cursor;
  QryModMag: TIB_Cursor;
  QryModRig: TIB_Cursor;
  QryModRigDiBa: TIB_Cursor;
  OldCodArt, NewCodArt, OldBarcode, CodAgg: String;
  Convertiti, Errori: Integer;
begin
  Convertiti := 0;
  Errori := 0;

  QryArt := TIB_Cursor.Create(Self);
  QryModArt := TIB_Cursor.Create(Self);
  QryModMag := TIB_Cursor.Create(Self);
  QryModRig := TIB_Cursor.Create(Self);
  QryModRigDiBa := TIB_Cursor.Create(Self);

  QryArt.DatabaseName := DM1.ArcDBFile;
  QryArt.IB_Connection := DM1.DBAzienda;
  QryModArt.DatabaseName := DM1.ArcDBFile;
  QryModArt.IB_Connection := DM1.DBAzienda;
  QryModMag.DatabaseName := DM1.ArcDBFile;
  QryModMag.IB_Connection := DM1.DBAzienda;
  QryModRig.DatabaseName := DM1.ArcDBFile;
  QryModRig.IB_Connection := DM1.DBAzienda;
  QryModRigDiBa.DatabaseName := DM1.ArcDBFile;
  QryModRigDiBa.IB_Connection := DM1.DBAzienda;

  try

    QryArt.SQL.Add('SELECT CODICEARTICOLO, BARCODE, CODICIAGGIUNTIVI FROM ARTICOLI WHERE BARCODE LIKE ''ARC.%''');
    QryArt.Open;

    QryModArt.SQL.Add('UPDATE ARTICOLI SET');
    QryModArt.SQL.Add('CODICEARTICOLO = :P_NEWCODART,');
    QryModArt.SQL.Add('BARCODE = '''',');
    QryModArt.SQL.Add('CODICIAGGIUNTIVI = :P_NEWCODAGG');
    QryModArt.SQL.Add('WHERE CODICEARTICOLO = :P_OLDCODART');
    QryModArt.Prepare;

    QryModMag.SQL.Add('UPDATE MAGAZZINI SET CODICEARTICOLO = :P_NEWCODART WHERE CODICEARTICOLO = :P_OLDCODART');
    QryModMag.Prepare;

    QryModRig.SQL.Add('UPDATE RIGHIPRV SET CODICEARTICOLO = :P_NEWCODART WHERE CODICEARTICOLO = :P_OLDCODART');
    QryModRig.Prepare;

    QryModRigDiBa.SQL.Add('UPDATE DIBARIGHI SET CODICEARTICOLO = :P_NEWCODART WHERE CODICEARTICOLO = :P_OLDCODART');
    QryModRigDiBa.Prepare;

    while not QryArt.Eof do
    begin
      // Preleva i dati dll'articolo corrente
      OldCodArt := QryArt.FieldByName('CODICEARTICOLO').AsString;
      NewCodArt := '';
      OldBarcode := QryArt.FieldByName('BARCODE').AsString;
      CodAgg := QryArt.FieldByName('CODICIAGGIUNTIVI').AsString;
      // Solo se nel codice a barre inizia con 'ARC.'
      if LeftStr(OldBarcode, 4) = 'ARC.' then
      begin
        // DM1.DBAzienda.StartTransaction;
        try
          // Elimina il precodice dal codice a barre contenente il codice del gruppo arcobaleno
          // e gli aggiunge gli eventuali zeri iniziali mancanti
          NewCodArt := RightStr(OldBarcode, Length(OldBarcode) - 4);
          NewCodArt := DM1.PadR(NewCodArt, '0', 6);
          // Aggiorna i codici aggiuntivi aggiungendo quello che prima era il codice principale
          CodAgg := CodAgg + '<' + OldCodArt + '>';

          // Aggiorna l'articolo
          QryModArt.Params.ParamByName('P_OLDCODART').AsString := OldCodArt;
          QryModArt.Params.ParamByName('P_NEWCODART').AsString := NewCodArt;
          QryModArt.Params.ParamByName('P_NEWCODAGG').AsString := CodAgg;
          QryModArt.ExecSQL;

          // Aggiorna il magazzino
          QryModMag.Params.ParamByName('P_OLDCODART').AsString := OldCodArt;
          QryModMag.Params.ParamByName('P_NEWCODART').AsString := NewCodArt;
          QryModMag.ExecSQL;

          // Aggiorna i righi dei documenti
          QryModRig.Params.ParamByName('P_OLDCODART').AsString := OldCodArt;
          QryModRig.Params.ParamByName('P_NEWCODART').AsString := NewCodArt;
          QryModRig.ExecSQL;

          // Aggiorna i righi degli articoli composti
          QryModRigDiBa.Params.ParamByName('P_OLDCODART').AsString := OldCodArt;
          QryModRigDiBa.Params.ParamByName('P_NEWCODART').AsString := NewCodArt;
          QryModRigDiBa.ExecSQL;

          // DM1.DBAzienda.Commit;
          Inc(Convertiti);
        except
          // DM1.DBAzienda.Rollback;
          Inc(Errori);
        end;
      end;
      // Avanti il prossimo
      // MainForm.Caption := 'Convertiti = ' + IntToStr(Convertiti) + ';     Errori = ' + IntToStr(Errori) + ';';
      QryArt.Next;
    end;

  finally
    QryArt.Close;
    QryArt.Free;
    QryModArt.Free;
    QryModMag.Free;
    QryModRig.Free;

    ShowMessage('Finito!');
  end;
end;

procedure TClientiForm.Button6Click(Sender: TObject);
var
  QryArt: TIB_Cursor;
  QryModArt: TIB_Cursor;
  Convertiti, Errori, CurrBarcode: Integer;
  CodArt, NewBarcode: String;
begin
  Convertiti := 0;
  Errori := 0;
  CurrBarcode := 1;

  QryArt := TIB_Cursor.Create(Self);
  QryModArt := TIB_Cursor.Create(Self);

  QryArt.DatabaseName := DM1.ArcDBFile;
  QryArt.IB_Connection := DM1.DBAzienda;
  QryModArt.DatabaseName := DM1.ArcDBFile;
  QryModArt.IB_Connection := DM1.DBAzienda;

  try
    QryArt.SQL.Add('SELECT CODICEARTICOLO, BARCODE, CODICIAGGIUNTIVI FROM ARTICOLI');
    QryArt.Open;

    QryModArt.SQL.Add('UPDATE ARTICOLI SET');
    QryModArt.SQL.Add('BARCODE = :P_NEWBARCODE');
    QryModArt.SQL.Add('WHERE CODICEARTICOLO = :P_CODART');
    QryModArt.Prepare;

    while not QryArt.Eof do
    begin
      // Preleva i dati dll'articolo corrente
      CodArt := QryArt.FieldByName('CODICEARTICOLO').AsString;
      NewBarcode := 'NS' + DM1.PadR(IntToStr(CurrBarcode), '0', 6);
      try
        // Aggiorna l'articolo
        QryModArt.Params.ParamByName('P_NEWBARCODE').AsString := NewBarcode;
        QryModArt.Params.ParamByName('P_CODART').AsString := CodArt;
        QryModArt.ExecSQL;

        Inc(Convertiti);
      except
        Inc(Errori);
      end;
      // Avanti il prossimo
      // MainForm.Caption := 'Convertiti = ' + IntToStr(Convertiti) + ';     Errori = ' + IntToStr(Errori) + ';';
      Inc(CurrBarcode);
      QryArt.Next;
    end;

  finally
    QryArt.Close;
    QryArt.Free;
    QryModArt.Free;

    ShowMessage('Finito!');
  end;
end;

procedure TClientiForm.GMTipo1PropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
begin
  // Carica l'elenco dei costruttori
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('SELECT DESCRIZIONE FROM TIPIRIGHI WHERE LIVELLO = ''' + RightStr((Sender as TcxComboBox).Name, 1) + ''' AND ABILITATO <> ''F''');
    Qry.Open;
    (Sender as TcxComboBox).Properties.Items.Clear;
    (Sender as TcxComboBox).Properties.Items.Add('');
    while not Qry.Eof do
    begin
      (Sender as TcxComboBox).Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.EditArtFornitorePropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
begin
  // Carica l'elenco dei costruttori
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('SELECT DISTINCT(FORNITORE) FROM ARTICOLI');
    Qry.Open;
    EditArtFornitore.Properties.Items.Clear;
    while not Qry.Eof do
    begin
      EditArtFornitore.Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.EditArtSoloArticoliMovimentatiPropertiesEditValueChanged(Sender: TObject);
begin
  if EditArtSoloArticoliMovimentati.Checked then
  begin
    EditArtSoloArticoliMovimentatiTipo.Enabled := True;
    EditArtSoloArticoliMovimentatiDal.Enabled := True;
    EditArtSoloArticoliMovimentatiAl.Enabled := True;
    EditArtSoloArticoliMovimentatiTipo.Text := EditArtSoloArticoliMovimentatiTipo.Properties.Items[0];
  end
  else
  begin
    EditArtSoloArticoliMovimentatiTipo.Text := '';
    EditArtSoloArticoliMovimentatiDal.Clear;
    EditArtSoloArticoliMovimentatiAl.Clear;
    EditArtSoloArticoliMovimentatiTipo.Enabled := False;
    EditArtSoloArticoliMovimentatiDal.Enabled := False;
    EditArtSoloArticoliMovimentatiAl.Enabled := False;
  end;
end;

procedure TClientiForm.Stampacumulativaappuntamentiselezionati1Click(Sender: TObject);
var
  Qry: TIB_Cursor;
  I: Integer;
  TmpStr: String;
begin
  DM1.Attendere;
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    // Svuota la tabella delle etichette
    DM2.SvuotaTabellaEtichette(IDX_ETICHETTA_SOGGETTO);
    // -----------------------------------------------------------------------------------------------------------------------------------
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('INSERT INTO LABSOGG (CODICESTAZIONE, PROGRIGO, JOLLY1, JOLLY2, JOLLY3, JOLLY4, JOLLY5, JOLLY6, JOLLY7, JOLLY8)');
    Qry.SQL.Add('VALUES(');
    Qry.SQL.Add(QuotedStr(DM1.CodiceUtente) + ',');
    Qry.SQL.Add(':P_PROGRIGO,');
    Qry.SQL.Add(':P_ID,');
    Qry.SQL.Add(':P_NOMEPAZIENTE,');
    Qry.SQL.Add(':P_PRATICA,');
    Qry.SQL.Add(':P_TERAPIA,');
    Qry.SQL.Add(':P_TERAPISTA,');
    Qry.SQL.Add(':P_STUDIO,');
    Qry.SQL.Add(':P_DATAAPP,');
    Qry.SQL.Add(':P_ORAAPP');
    Qry.SQL.Add(')');
    Qry.Prepare;
    // Pone la griglia in modalit di Update
    tvImpegni.BeginUpdate;
    try
      DM1.DBAzienda.StartTransaction;
      try
        // Cicla per tutti i righi selezionati
        for I := 0 to tvImpegni.Controller.SelectedRecordCount - 1 do
        begin
          // Imposta i parametri della query per l'inserimento del record
          // attuale nela tabella di stampa delle etochette
          Qry.Params.ParamByName('P_PROGRIGO').AsInteger := I;
          // ID
          if not VarIsNull(tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniID.Index]) then
            Qry.Params.ParamByName('P_ID').AsString := '#' + BARCODE_TIPOCODICE_DOCUMENTO + BARCODE_DOC_INTERVENTO +
              IntToStr(tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniID.Index]) + '#'
          else
            Qry.Params.ParamByName('P_ID').AsString := '';
          // Nome paziente
          if not VarIsNull(tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniRAGIONESOCIALE.Index]) then
            Qry.Params.ParamByName('P_NOMEPAZIENTE').AsString := Uppercase(Trim(tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniRAGIONESOCIALE.Index]))
          else
            Qry.Params.ParamByName('P_NOMEPAZIENTE').AsString := '';
          // Pratica
          if not VarIsNull(tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniRIFPRATICA.Index]) then
            Qry.Params.ParamByName('P_PRATICA').AsString := Uppercase(Trim(tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniRIFPRATICA.Index]))
          else
            Qry.Params.ParamByName('P_PRATICA').AsString := '';
          // Articolo (terapia)
          TmpStr := '';
          if (not VarIsNull(tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniCODICEARTICOLO.Index])) or
            (not VarIsNull(tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniDESCRIZIONEARTICOLO.Index])) then
          begin
            if not VarIsNull(tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniCODICEARTICOLO.Index]) then
              TmpStr := TmpStr + Uppercase(Trim(tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniCODICEARTICOLO.Index]));
            if not VarIsNull(tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniDESCRIZIONEARTICOLO.Index]) then
            begin
              if Trim(TmpStr) <> '' then
                TmpStr := TmpStr + ' - ';
              TmpStr := TmpStr + Uppercase(Trim(tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniDESCRIZIONEARTICOLO.Index]));
            end;
          end;
          Qry.Params.ParamByName('P_TERAPIA').AsString := TmpStr;
          // Terapista (Agente)
          if not VarIsNull(tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniAGENTE.Index]) then
            Qry.Params.ParamByName('P_TERAPISTA').AsString := Uppercase(Trim(tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniAGENTE.Index]))
          else
            Qry.Params.ParamByName('P_TERAPISTA').AsString := '';
          // Studio (Tecnico)
          if not VarIsNull(tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniTECNICO.Index]) then
            Qry.Params.ParamByName('P_STUDIO').AsString := Uppercase(Trim(tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniTECNICO.Index]))
          else
            Qry.Params.ParamByName('P_STUDIO').AsString := '';
          // Data appuntamento
          if not VarIsNull(tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniSTART.Index]) then
            Qry.Params.ParamByName('P_DATAAPP').AsString :=
              FormatDateTime('dddd dd/mm/yyyy', tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniSTART.Index])
          else
            Qry.Params.ParamByName('P_DATAAPP').AsString := '';
          // Ora appuntamento
          if not VarIsNull(tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniSTART.Index]) then
            Qry.Params.ParamByName('P_ORAAPP').AsString := FormatDateTime('hh:nn', tvImpegni.Controller.SelectedRecords[I].Values[tvImpegniSTART.Index])
          else
            Qry.Params.ParamByName('P_ORAAPP').AsString := '';
          // Esegue l'inserimento
          Qry.ExecSQL;
        end;
        DM1.DBAzienda.Commit;
      except
        DM1.DBAzienda.Rollback;
        raise;
      end;
      // -----------------------------------------------------------------------------------------------------------------------------------
      // Crea e avvia la form per la stampa delle etichette
      DM2.StampaEtichettaSilent((MenuStampe.Tag = 0), DM1.TableProgressiviDEFAULTLABELFILENAME.AsString, DM1.DefaultLabelPrinterName);
    finally
      tvImpegni.EndUpdate;
    end;
  finally
    DM1.ChiudiAttendere;
    if Assigned(Qry) then
      Qry.Free;
  end;
end;

procedure TClientiForm.tvDocAZIONEMAGAZZINOGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
begin
  if AText = '+' then
    AText := '(+) Carico'
  else if AText = '-' then
    AText := '(-) Scarico'
  else if AText = 'O' then
    AText := '(O) Ordina'
  else if AText = 'I' then
    AText := '(I) Impegna'
  else
    AText := '';
end;

procedure TClientiForm.tvDocAZIONECANTIEREGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
begin
  if AText = '+' then
    AText := '(+) Carico'
  else if AText = '-' then
    AText := '(-) Scarico'
  else if AText = 'M' then
    AText := '(M) Montaggio'
  else if AText = 'C' then
    AText := '(C) Commessa'
  else if AText = 'F' then
    AText := '(F) Fattura'
  else
    AText := '';
end;

procedure TClientiForm.tvGMSEGNOOPERAZIONEGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
begin
  if AText = '+' then
    AText := '(+) Carico'
  else if AText = '-' then
    AText := '(-) Scarico'
  else if AText = 'O' then
    AText := '(O) Ordina'
  else if AText = 'I' then
    AText := '(I) Impegna'
  else
    AText := '';
end;

procedure TClientiForm.tvGMSEGNOOPERAZIONECANTIEREGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
begin
  if AText = '+' then
    AText := '(+) Carico'
  else if AText = '-' then
    AText := '(-) Scarico'
  else if AText = 'M' then
    AText := '(M) Montaggio'
  else if AText = 'C' then
    AText := '(C) Commessa'
  else if AText = 'F' then
    AText := '(F) Fattura'
  else
    AText := '';
end;

procedure TClientiForm.FilterGosTipoManodoperaPropertiesInitPopup(Sender: TObject);
begin
  with Sender as TcxComboBox do
  begin
    Properties.Items.Clear;
    Properties.Items.Add('');
    if Trim(DM1.Manodopera[0].Descrizione) <> '' then
      Properties.Items.Add('0 - ' + DM1.Manodopera[0].Descrizione);
    if Trim(DM1.Manodopera[1].Descrizione) <> '' then
      Properties.Items.Add('1 - ' + DM1.Manodopera[1].Descrizione);
    if Trim(DM1.Manodopera[2].Descrizione) <> '' then
      Properties.Items.Add('2 - ' + DM1.Manodopera[2].Descrizione);
    if Trim(DM1.Manodopera[3].Descrizione) <> '' then
      Properties.Items.Add('3 - ' + DM1.Manodopera[3].Descrizione);
    if Trim(DM1.Manodopera[4].Descrizione) <> '' then
      Properties.Items.Add('4 - ' + DM1.Manodopera[4].Descrizione);
  end;
end;

procedure TClientiForm.tvOreOPERAINDEXGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
begin
  AText := RightStr(AText, 1); // IN questo modo funziona anche quando la colonna  raggruppata
  if AText = '' then
    Exit;
  AText := AText + ' - ' + DM1.Manodopera[StrToInt(AText)].Descrizione;
  // NB: Mette tre spazio all'inizio perch altrimenti non mi visualizza il numero iniziale
  // praticamente  come se si mangiasse il primo carattere solo quando la colonna
  //  raggruppata.
  if tvOreOPERAINDEX.GroupIndex <> -1 then
    AText := '   ' + AText;
end;

procedure TClientiForm.RxSpeedModificaClick(Sender: TObject);
begin
  // TAB GIORNALE DI CANTIERE
  if PageControl2.ActivePage = TabGC then
  begin
    TabGCForm.ModificaButtonClick(Sender);
  end;
end;

procedure TClientiForm.Stampaindicepercategorie1Click(Sender: TObject);
begin
  if DM1.Messaggi('Stampa indice per categorie del Listino/Catalogo figurato',
    'ATTENZIONE !!!'#13#13'L''operazione potrebbe richiedere molto tempo durante il quale si consiglia di non utilizzare il computer per altri scopi.'#13#13'Vuoi continuare ?',
    '', [mbYes, mbNo], 0, nil) <> mrYes then
  begin
    Exit;
  end;
  Application.CreateForm(TIndiceCategorieQR, IndiceCategorieQR);
  try
    if MenuStampe.Tag = 0 then
      IndiceCategorieQR.Preview
    else
      IndiceCategorieQR.Print;
  finally
    IndiceCategorieQR.Free;
  end;
end;

procedure TClientiForm.Stampaindicealfabetico1Click(Sender: TObject);
begin
  if DM1.Messaggi('Stampa indice alfabetico del Listino/Catalogo figurato',
    'ATTENZIONE !!!'#13#13'L''operazione potrebbe richiedere molto tempo durante il quale si consiglia di non utilizzare il computer per altri scopi.'#13#13'Vuoi continuare ?',
    '', [mbYes, mbNo], 0, nil) <> mrYes then
  begin
    Exit;
  end;
  Application.CreateForm(TIndiceAlfabeticoQR, IndiceAlfabeticoQR);
  try
    if MenuStampe.Tag = 0 then
      IndiceAlfabeticoQR.Preview
    else
      IndiceAlfabeticoQR.Print;
  finally
    IndiceAlfabeticoQR.Free;
  end;
end;

procedure TClientiForm.Stampaindiceperfornitore1Click(Sender: TObject);
begin
  if DM1.Messaggi('Stampa indice per fornitore del Listino/Catalogo figurato',
    'ATTENZIONE !!!'#13#13'L''operazione potrebbe richiedere molto tempo durante il quale si consiglia di non utilizzare il computer per altri scopi.'#13#13'Vuoi continuare ?',
    '', [mbYes, mbNo], 0, nil) <> mrYes then
  begin
    Exit;
  end;
  Application.CreateForm(TIndiceFornitoriQR, IndiceFornitoriQR);
  try
    if MenuStampe.Tag = 0 then
      IndiceFornitoriQR.Preview
    else
      IndiceFornitoriQR.Print;
  finally
    IndiceFornitoriQR.Free;
  end;
end;

procedure TClientiForm.Stampacatalogofiguratosenzacodiciabarre1Click(Sender: TObject);
begin
  if DM1.Messaggi('Stampa Listino/Catalogo figurato',
    'ATTENZIONE !!!'#13#13'L''operazione potrebbe richiedere molto tempo durante il quale si consiglia di non utilizzare il computer per altri scopi.'#13#13'Vuoi continuare ?',
    '', [mbYes, mbNo], 0, nil) <> mrYes then
  begin
    Exit;
  end;
  Application.CreateForm(TListinoNoBarCodeQR, ListinoNoBarCodeQR);
  try
    if MenuStampe.Tag = 0 then
      ListinoNoBarCodeQR.Preview
    else
      ListinoNoBarCodeQR.Print;
  finally
    ListinoNoBarCodeQR.Free;
  end;
end;

procedure TClientiForm.Button3Click(Sender: TObject);
begin
  DM1.EliminaViste;
end;

procedure TClientiForm.Button7Click(Sender: TObject);
begin
  DM1.CreaViste;
end;

procedure TClientiForm.Button8Click(Sender: TObject);
begin
  ScaleBy(125, 100);
end;

// Procedure che duplica un cantiere
procedure TClientiForm.DuplicaCantiere(CantTipo: String; CantNum: Integer; CantDataApertura: TDateTime; Copie: Integer);
var
  Src, Dst: TIBOQuery;
  I, Copia: Integer;
begin
  try
    // Inizializzazione
    Src := TIBOQuery.Create(nil);
    Src.IB_Connection := DM1.DBAzienda;
    Dst := TIBOQuery.Create(nil);
    Dst.IB_Connection := DM1.DBAzienda;
    // Query che carica il dato origine
    Src.SQL.Add('SELECT FIRST 1 P.* FROM PRATICHE P');
    Src.SQL.Add('WHERE P.TIPO = ' + QuotedStr(CantTipo));
    Src.SQL.Add('  AND P.CODICE = ' + IntToStr(CantNum));
    Src.SQL.Add('  AND P.DATAAPERTURA = ' + QuotedStr(FormatDateTime('mm/dd/yyyy', CantDataApertura)));
    Src.Open;
    if Src.Eof then
      raise Exception.Create('Pratica non trovata.');
    // CIcla per tutti i campi per costruire la query
    // che far l'insert della nuova pratica duplicata dal modello
    Dst.SQL.Add('INSERT INTO PRATICHE (');
    Dst.SQL.Add(Src.Fields[0].FieldName);
    for I := 1 to Src.Fields.Count - 1 do
    begin
      // Se  un campo calcolato lo salta
      if Uppercase(LeftStr(Src.Fields[I].FieldName, 8)) = 'COMPUTED' then
        Continue;
      // Altrimenti  un campo normale
      Dst.SQL.Add(',' + Src.Fields[I].FieldName);
    end;
    Dst.SQL.Add(') VALUES (');
    Dst.SQL.Add(':P_' + Src.Fields[0].FieldName);
    for I := 1 to Src.Fields.Count - 1 do
    begin
      // Se  un campo calcolato lo salta
      if Uppercase(LeftStr(Src.Fields[I].FieldName, 8)) = 'COMPUTED' then
        Continue;
      // Altrimenti  un campo normale
      Dst.SQL.Add(',:P_' + Src.Fields[I].FieldName);
    end;
    Dst.SQL.Add(')');
    Dst.Prepare;
    // Carica i dati del modello nei parametri
    for I := 0 to Src.Fields.Count - 1 do
    begin
      // Se  un campo calcolato lo salta
      if Uppercase(LeftStr(Src.Fields[I].FieldName, 8)) = 'COMPUTED' then
        Continue;
      // Altrimenti  un campo normale
      Dst.Params.ParamByName('P_' + Src.Fields[I].FieldName).Value := Src.Fields[I].Value;
    end;
    Src.Close;
    // Cicla per il numero di copie da realizzare e le realizza
    // ovviamente ognuna con un codice diverso
    DM1.DBAzienda.StartTransaction;
    try
      for Copia := 1 to Copie do
      begin
        Dst.Params.ParamByName('P_CODICE').Value := DM1.NextCodicePratica(CantTipo);
        Dst.Params.ParamByName('P_ID').Value := IntToStr(DM1.Generators_NextGenID('GEN_ID_PRATICHE'));
        Dst.ExecSQL;
      end;
      DM1.DBAzienda.Commit;
    except
      DM1.DBAzienda.Rollback;
      raise;
    end;
  finally
    if Assigned(Src) then
      Src.Free;
    if Assigned(Dst) then
      Dst.Free;
  end;
end;

procedure TClientiForm.FilterGosSottocantiere1PropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
  Combo: TcxComboBox;
  StcIndex: String;
begin
  // Inizializzazione
  Combo := (Sender as TcxComboBox);
  StcIndex := RightStr(Combo.Name, 1);
  Combo.Properties.Items.Clear;
  Combo.Properties.Items.Add('');
  // Se il documento non appartiene ad una pratica esce subito
  if (ClientiForm.PraticaCorrente = '0') or (ClientiForm.PraticaCorrente = '') then
    Exit;
  // Altrimenti provvede a caricare i dati
  Qry := TIB_Cursor.Create(nil);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    // Imposta query
    Qry.SQL.Add('SELECT ID FROM SOTTOCANTIERI' + StcIndex + ' WHERE');
    Qry.SQL.Add('TIPOCANTIERE = ''P''');
    Qry.SQL.Add('AND CODICECANTIERE = ' + ClientiForm.PraticaCorrente);
    Qry.SQL.Add('AND DATAAPERTURACANTIERE = ''' + ClientiForm.DataPraticaCorrenteSQL + '''');
    Qry.Open;
    // Caricamento dati
    while not Qry.Eof do
    begin
      Combo.Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
    Qry.Close;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.SetDocFilter_Agente_Visible(const Value: Boolean);
begin
  fDocFilter_Agente_Visible := Value;
  LabelFilterDocAgente.Visible := Value;
  DocAgente.Visible := Value;
end;

procedure TClientiForm.SetDocFilter_Causale_Visible(const Value: Boolean);
begin
  fDocFilter_Causale_Visible := Value;
  StaticText34.Visible := Value;
  Causale.Visible := Value;
end;

procedure TClientiForm.SetDocFilter_ConCantiere_Visible(const Value: Boolean);
begin
  fDocFilter_ConCantiere_Visible := Value;
  StaticText81.Visible := Value;
  StaticText82.Visible := Value;
  DocConCantiere.Visible := Value;
end;

procedure TClientiForm.SetDocFilter_Operatore_Visible(const Value: Boolean);
begin
  fDocFilter_Operatore_Visible := Value;
  StaticText84.Visible := Value;
  DocOperatore.Visible := Value;
end;

procedure TClientiForm.SetDocFilter_SoloConStato_Visible(const Value: Boolean);
begin
  fDocFilter_SoloConStato_Visible := Value;
  StaticText47.Visible := Value;
  SoloStato.Visible := Value;
end;

procedure TClientiForm.SetDocFilter_SoloIlRegistro_Visible(const Value: Boolean);
begin
  fDocFilter_SoloIlRegistro_Visible := Value;
  StaticText16.Visible := Value;
  SoloRegistro.Visible := Value;
end;

procedure TClientiForm.SetDocFilter_TipiDocAltri_Visible(const Value: Boolean);
begin
  fDocFilter_TipiDocAltri_Visible := Value;
  Label16.Visible := Value;
  DocAltri.Visible := Value;
end;

procedure TClientiForm.SetDocFilter_TipiDocSbTuttiNessuno_Visible(const Value: Boolean);
begin
  fDocFilter_TipiDocSbTuttiNessuno_Visible := Value;
  Shape1.Visible := Value;
  SBDocTutti.Visible := Value;
  Shape2.Visible := Value;
  SBDocNessuno.Visible := Value;
end;

procedure TClientiForm.SetDocFilter_TipiDocVendita_Visible(const Value: Boolean);
begin
  fDocFilter_TipiDocVendita_Visible := Value;
  LabelTipiDocVendite.Visible := Value;
  DocVendite.Visible := Value;
end;

procedure TClientiForm.SetDocFilter_TipoSoggetto_Visible(const Value: Boolean);
begin
  fDocFilter_TipoSoggetto_Visible := Value;
  StaticText59.Visible := Value;
  SoloTipoSoggetto.Visible := Value;
end;

procedure TClientiForm.SetDocFilter_TuttiTranneIlRegitro_Visible(const Value: Boolean);
begin
  fDocFilter_TuttiTranneIlRegitro_Visible := Value;
  StaticText17.Visible := Value;
  TranneRegistro.Visible := Value;
end;

procedure TClientiForm.SetArtFilter_Categoria1_Caption(const Value: String);
var
  FilterVisible: Boolean;
begin
  fArtFilter_Categoria1_Caption := Value;
  FilterVisible := (Value <> '0') and (Value <> '');
  LabelArtCategoria1.Visible := FilterVisible;
  LabelArtCategoria1.Caption := Value;
  editArtCategoria1.Visible := FilterVisible;
end;

procedure TClientiForm.SetArtFilter_Categoria2_Caption(const Value: String);
var
  FilterVisible: Boolean;
begin
  fArtFilter_Categoria2_Caption := Value;
  FilterVisible := (Value <> '0') and (Value <> '');
  LabelArtCategoria2.Visible := FilterVisible;
  LabelArtCategoria2.Caption := Value;
  editArtCategoria2.Visible := FilterVisible;
end;

procedure TClientiForm.SetArtFilter_Categoria3_Caption(const Value: String);
var
  FilterVisible: Boolean;
begin
  fArtFilter_Categoria3_Caption := Value;
  FilterVisible := (Value <> '0') and (Value <> '');
  LabelArtCategoria3.Visible := FilterVisible;
  LabelArtCategoria3.Caption := Value;
  editArtCategoria3.Visible := FilterVisible;
end;

procedure TClientiForm.SetArtFilter_DataMagazzino_Visible(const Value: Boolean);
begin
  fArtFilter_DataMagazzino_Visible := Value;
  Label101.Visible := Value;
  EditArtDataMagazzino.Visible := Value;
end;

procedure TClientiForm.SetArtFilter_Magazzino_Visible(const Value: Boolean);
begin
  fArtFilter_Magazzino_Visible := Value;
  StaticText38.Visible := Value;
  CodiceMagazzino.Visible := Value;
  BitBtnArtCodiceMagazzino.Visible := Value;
  Label40.Visible := Value;
  DescrizioneMagazzino.Visible := Value;
end;

procedure TClientiForm.SetArtFilter_SoloArticoliComposti_Visible(const Value: Boolean);
begin
  fArtFilter_SoloArticoliComposti_Visible := Value;
  StaticText13.Visible := Value;
  Composti.Visible := Value;
end;

procedure TClientiForm.SetArtFilter_SoloArticoliMovimentati_Visible(const Value: Boolean);
begin
  fArtFilter_SoloArticoliMovimentati_Visible := Value;
  EditArtSoloArticoliMovimentati.Visible := Value;
  EditArtSoloArticoliMovimentatiTipo.Visible := Value;
  EditArtSoloArticoliMovimentatiDal.Visible := Value;
  EditArtSoloArticoliMovimentatiAl.Visible := Value;
end;

procedure TClientiForm.SetArtFilter_SoloGiacenzaAttiva_Visible(const Value: Boolean);
begin
  fArtFilter_SoloGiacenzaAttiva_Visible := Value;
  StaticText5.Visible := Value;
  SoloGiacAttiva.Visible := Value;
end;

procedure TClientiForm.SetArtFilter_Ubicazione_Visible(const Value: Boolean);
begin
  fArtFilter_Ubicazione_Visible := Value;
  StaticText10.Visible := Value;
  EditArtUbicazione.Visible := Value;
end;

procedure TClientiForm.tvArtSCONTODIACQUISTOGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
begin
  // Inizializzazione
  AText := '';
  // Compone il testo da visualizzare
  // Sconto1
  if (not VarIsNull(ARecord.Values[tvArtSCONTODIACQUISTO.Index])) and (ARecord.Values[tvArtSCONTODIACQUISTO.Index] <> 0) then
    AText := FloatToStr(DM1.Arrotonda(ARecord.Values[tvArtSCONTODIACQUISTO.Index], 2)) + '%';
  // Sconto2
  if (not VarIsNull(ARecord.Values[tvArtSCONTODIACQUISTO2.Index])) and (ARecord.Values[tvArtSCONTODIACQUISTO2.Index] <> 0) then
    AText := AText + ' + ' + FloatToStr(DM1.Arrotonda(ARecord.Values[tvArtSCONTODIACQUISTO2.Index], 2)) + '%';
  // Sconto3
  if (not VarIsNull(ARecord.Values[tvArtSCONTODIACQUISTO3.Index])) and (ARecord.Values[tvArtSCONTODIACQUISTO3.Index] <> 0) then
    AText := AText + ' + ' + FloatToStr(DM1.Arrotonda(ARecord.Values[tvArtSCONTODIACQUISTO3.Index], 2)) + '%';
end;

procedure TClientiForm.tvArtGRUPPO1GetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
begin
  AText := DM1.RitornaTestoPrimaDi(' (', AText, False);
end;

procedure TClientiForm.Esportainformatotxt1Click(Sender: TObject);
var
  CurrGrid: TcxControl;
  FileNameNoExt: String;
begin
  // In base alla pagina selezionata Elenco Viste punta alla griglia
  // corretta
  CurrGrid := GetCurrentGrid;
  // Richiede all'utente il nome del file
  // NB: Prima azzera il nome del file
  DM1.TxtSaveDialog.FileName := '';
  if DM1.TxtSaveDialog.Execute then
  begin
    FileNameNoExt := LeftStr(DM1.TxtSaveDialog.FileName, (Length(DM1.TxtSaveDialog.FileName) - Length(ExtractFileExt(DM1.TxtSaveDialog.FileName))));
    // Verifica che il file non esista gi, e se esiste chiede se lo si vuole sovrascrivere
    if FileExists(FileNameNoExt + '.txt') then
    begin
      if DM1.Messaggi('Esportazione', 'File gi esistente !!!'#13#13'Devo proseguire e sovrascrivere il file?',
        'NB: Rispondendo "SI" e quindi sovrascrivendo il file esistente i dati in esso contenuti saranno perduti.', [mbYes, mbNo], 0, nil) <> mrYes then
        Exit;
    end;
    // Informa l'utente
    DM1.ShowWait('Esportazione Testo', 'Operazione in corso...');
    try
      if CurrGrid is TcxGrid then
      begin

        // =========================================================================
        // ESPORTAZIONE DA UNA GXGRID
        // -------------------------------------------------------------------------
        (CurrGrid as TcxGrid).BeginUpdate;
        try;
          ExportGridToText(FileNameNoExt, // FileName senza estensione
            (CurrGrid as TcxGrid), // cxGrid
            False, // AExpand
            True, // ASaveAll
            #9, // Separator
            '', // Start field delimiter
            '' // End field delimiter
            );
        finally
          (CurrGrid as TcxGrid).EndUpdate;
        end;
        // =========================================================================

      end
      else if CurrGrid is TcxDBPivotGrid then
      begin

        // =========================================================================
        // ESPORTAZIONE DA UNA PIVOTGRID
        // -------------------------------------------------------------------------
        (CurrGrid as TcxDBPivotGrid).BeginUpdate;
        try;
          cxExportPivotGridToText(FileNameNoExt, // FileName senza estensione
            (CurrGrid as TcxDBPivotGrid), // cxGrid
            False, // AExpand
            #9, // Separator
            '', // Start field delimiter
            '', // End field delimiter
            'txt' // Default File extension
            );
        finally
          (CurrGrid as TcxDBPivotGrid).EndUpdate;
        end;
        // =========================================================================

      end;
    finally
      DM1.CloseWait;
      DM1.Messaggi('Levante - Esportazione dati', 'Operazione terminata.', '', [mbOk], 0, nil);
    end;
  end;
end;

procedure TClientiForm.Variazionecostoorariomanodoperadeirighiselezionati1Click(Sender: TObject);
begin
  Application.CreateForm(TVariazioneOreForm, VariazioneOreForm);
  try
    VariazioneOreForm.ShowModal;
  finally
    VariazioneOreForm.Close;
    VariazioneOreForm.Free;
  end;
end;

procedure TClientiForm.Stamparesiduoordini1Click(Sender: TObject);
var
  ShowDlgForm: Boolean;
  PrecFooterColor: TColor;
begin
  ShowDlgForm := (StampeCantieriForm = nil);
  // Imposta la stringa su cui viene costruito il range di date della stampa in base ai filtri per data
  DM1.SetReportDateRange('', '');
  // Salva e modifica alcune propriet per adattare il componente alla stampe
  // e poi rimette tutto a posto.
  TagResOrdForm.GridResOrd.BeginUpdate;
  TagResOrdForm.PrecGroupColor := TagResOrdForm.btvResOrd.Styles.Group.Color;
  TagResOrdForm.btvResOrd.Styles.Group.Color := clWhite;
  TagResOrdForm.GridResOrd.RootLevelOptions.DetailFrameColor := clWhite;
  TagResOrdForm.btvResOrd.OptionsView.GroupRowStyle := grsStandard;
  try
    // Anteprima
    if MenuStampe.Tag = 0 then
    begin
      TagResOrdForm.dxPrinter.Preview(True, TagResOrdForm.GridResOrdLink);
      // Stampa
    end
    else if MenuStampe.Tag = 1 then
    begin
      TagResOrdForm.dxPrinter.Print(ShowDlgForm, nil, TagResOrdForm.GridResOrdLink);
    end;
  finally
    // Ripristina l'aspetto del componente
    TagResOrdForm.btvResOrd.Styles.Group.Color := TagResOrdForm.PrecGroupColor;
    TagResOrdForm.GridResOrd.RootLevelOptions.DetailFrameColor := clBlack;
    TagResOrdForm.btvResOrd.OptionsView.GroupRowStyle := grsOffice11;
    TagResOrdForm.GridResOrd.EndUpdate;
  end;
end;

procedure TClientiForm.MarcaidocumentiselezionaticomeNONesportati1Click(Sender: TObject);
begin
  if PageControl2.ActivePage = TabDocumenti then
    SetNotExportedDocSel
  else if PageControl2.ActivePage = TabPrimanota then
    SetNotExportedPrimanotaSel;
end;

procedure TClientiForm.tvScadRITACCGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
begin
  // Se ill campo ha valore nullo o zero non visualizza nulla
  if VarIsNull(ARecord.Values[tvScadRITACC.Index]) or (ARecord.Values[tvScadRITACC.Index] = 0) then
  begin
    AText := '';
  end;
end;

procedure TClientiForm.ScadStatoPropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
begin
  // Carica l'elenco dei costruttori
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    Qry.SQL.Add('SELECT DESCRIZIONE FROM STATI WHERE TIPODOCUMENTO=''Scadenze''');
    Qry.Open;
    (Sender as TcxComboBox).Properties.Items.Clear;
    (Sender as TcxComboBox).Properties.Items.Add('');
    while not Qry.Eof do
    begin
      (Sender as TcxComboBox).Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.Cambiastatoallescadenzeselezionate1Click(Sender: TObject);
begin
  // Richiama la selezione dello stato delle scadenze selezionate
  DM1.SelezionaStato('Scadenze', nil, 997);
end;

procedure TClientiForm.Cambiastatoalleregistrazionidiprimanotaselezionate1Click(Sender: TObject);
begin
  // Richiama la selezione dello stato delle primenote selezionate
  DM1.SelezionaStato('Primanota', nil, 996);
end;

procedure TClientiForm.tvScadRITACCPERCGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
begin
  if Trim(AText) <> '' then
    AText := AText + '%';
end;

procedure TClientiForm.SpeedButton30Click(Sender: TObject);
begin
  // Attiva/Disattiva la Filter Row
  if (Sender as TSpeedButton).Down then
    PivotGridScad.OptionsPrefilter.Visible := TcxPivotGridPrefilterVisible.pfvAlways
  else
  begin
    PivotGridScad.OptionsPrefilter.Visible := TcxPivotGridPrefilterVisible.pfvNever;
    PivotGridScad.DataController.Filter.Clear;
  end;
end;

procedure TClientiForm.SpeedButton31Click(Sender: TObject);
begin
  // Attiva/Disattiva la Filter Row
  if (Sender as TSpeedButton).Down then
    PivotGridGM.OptionsPrefilter.Visible := TcxPivotGridPrefilterVisible.pfvAlways
  else
  begin
    PivotGridGM.OptionsPrefilter.Visible := TcxPivotGridPrefilterVisible.pfvNever;
    PivotGridGM.DataController.Filter.Clear;
  end;
end;

procedure TClientiForm.SpeedButtonDataRowHeightClick(Sender: TObject);
var
  P: TMemIniFile;
begin
  if SpeedButtonDataRowHeight.Tag = 0 then
    SpeedButtonDataRowHeight.Tag := tvDoc.OptionsView.DataRowHeight;
  if (Sender as TSpeedButton).Down then
    tvDoc.OptionsView.DataRowHeight := 0
  else
    tvDoc.OptionsView.DataRowHeight := SpeedButtonDataRowHeight.Tag;
  // Memorizza lo stato del bottone nel file param.ini per utente
  P := TMemIniFile.Create(DM1.Repository_Param_User.FullLocalFileName);
  try
    DM1.ElencoDoc_DataRowExpanded := SpeedButtonDataRowHeight.Down;
    P.WriteBool('ELENCHI_GIORNALI', 'Doc_DataRowExpanded', SpeedButtonDataRowHeight.Down);
  finally
    P.UpdateFile;
    P.Free;
  end;
end;

procedure TClientiForm.tvOreDataControllerSortingChanged(Sender: TObject);
begin
  if tvOre.DataController.DataModeController.GridMode and (tvOre.GroupedColumnCount = 0) then
    RxSpeedButtonTrovaClick(Self);
  tvOre.Controller.GotoFirst(False);
end;

procedure TClientiForm.tvCVDataControllerSortingChanged(Sender: TObject);
begin
  if tvCV.DataController.DataModeController.GridMode and (tvCV.GroupedColumnCount = 0) then
    RxSpeedButtonTrovaClick(Self);
  tvCV.Controller.GotoFirst(False);
end;

procedure TClientiForm.tvSpeseDataControllerSortingChanged(Sender: TObject);
begin
  if tvSpese.DataController.DataModeController.GridMode and (tvSpese.GroupedColumnCount = 0) then
    RxSpeedButtonTrovaClick(Self);
  tvSpese.Controller.GotoFirst(False);
end;

procedure TClientiForm.FilterGosSoloRegistroPropertiesChange(Sender: TObject);
begin
  if FilterGosSoloRegistro.Text <> '' then
    FilterGosTranneRegistro.Text := '';
end;

procedure TClientiForm.FilterGosTranneRegistroPropertiesChange(Sender: TObject);
begin
  if FilterGosTranneRegistro.Text <> '' then
    FilterGosSoloRegistro.Text := '';
end;

procedure TClientiForm.FilterGosSpeseSoloRegistroPropertiesChange(Sender: TObject);
begin
  if FilterGosSpeseSoloRegistro.Text <> '' then
    FilterGosSpeseTranneRegistro.Text := '';
end;

procedure TClientiForm.FilterGosSpeseTranneRegistroPropertiesChange(Sender: TObject);
begin
  if FilterGosSpeseTranneRegistro.Text <> '' then
    FilterGosSpeseSoloRegistro.Text := '';
end;

procedure TClientiForm.tvOreCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
begin
  // Solo se non  selezionata
  if not AViewInfo.Selected then
  begin
    // IMposta il colore del Font in base allo stato del documento
    if (not VarIsNull(AViewInfo.GridRecord.Values[tvOre.GetColumnByFieldName('STATODESCRIZIONE').Index])) and
      (not VarIsNull(AViewInfo.GridRecord.Values[tvOre.GetColumnByFieldName('STATOFOREGROUND').Index])) then
    begin
      ACanvas.Font.Color := DM1.StrToColor(AViewInfo.GridRecord.Values[tvOre.GetColumnByFieldName('STATOFOREGROUND').Index], ACanvas.Font.Color);
    end;
  end;
end;

procedure TClientiForm.tvSpeseCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
begin
  // Solo se non  selezionata
  if not AViewInfo.Selected then
  begin
    // IMposta il colore del Font in base allo stato del documento
    if (not VarIsNull(AViewInfo.GridRecord.Values[tvSpese.GetColumnByFieldName('STATODESCRIZIONE').Index])) and
      (not VarIsNull(AViewInfo.GridRecord.Values[tvSpese.GetColumnByFieldName('STATOFOREGROUND').Index])) then
    begin
      ACanvas.Font.Color := DM1.StrToColor(AViewInfo.GridRecord.Values[tvSpese.GetColumnByFieldName('STATOFOREGROUND').Index], ACanvas.Font.Color);
    end;
  end;
end;

procedure TClientiForm.SBGosSpeseFilterOpenCloseClick(Sender: TObject);
begin
  if PanelSpeseFiltri.Tag = 1 then
    CloseFilterPanel(PanelSpeseFiltri, SBGosSpeseFilterOpenClose)
  else
    OpenFilterPanel(PanelSpeseFiltri, SBGosSpeseFilterOpenClose);
end;

procedure TClientiForm.SetFilter_Visible_CategCant1(const Value: Boolean);
begin
  fFilter_Visible_CategCant1 := Value;
  PratCategCant1.Visible := Value;
  PratLabelCategCant1.Visible := Value;
  DocCategCant1.Visible := Value;
  DocLabelCategCant1.Visible := Value;
  GMCategCant1.Visible := Value;
  GMLabelCategCant1.Visible := Value;
  GosOreCategCant1.Visible := Value;
  GosOreLabelCategCant1.Visible := Value;
  GosSpeseCategCant1.Visible := Value;
  GosSpeseLabelCategCant1.Visible := Value;
end;

procedure TClientiForm.SetFilter_Visible_CategCant2(const Value: Boolean);
begin
  fFilter_Visible_CategCant2 := Value;
  PratCategCant2.Visible := Value;
  PratLabelCategCant2.Visible := Value;
  DocCategCant2.Visible := Value;
  DocLabelCategCant2.Visible := Value;
  GMCategCant2.Visible := Value;
  GMLabelCategCant2.Visible := Value;
  GosOreCategCant2.Visible := Value;
  GosOreLabelCategCant2.Visible := Value;
  GosSpeseCategCant2.Visible := Value;
  GosSpeseLabelCategCant2.Visible := Value;
end;

procedure TClientiForm.SetFilter_Visible_CategCant3(const Value: Boolean);
begin
  fFilter_Visible_CategCant3 := Value;
  PratCategCant3.Visible := Value;
  PratLabelCategCant3.Visible := Value;
  DocCategCant3.Visible := Value;
  DocLabelCategCant3.Visible := Value;
  GMCategCant3.Visible := Value;
  GMLabelCategCant3.Visible := Value;
  GosOreCategCant3.Visible := Value;
  GosOreLabelCategCant3.Visible := Value;
  GosSpeseCategCant3.Visible := Value;
  GosSpeseLabelCategCant3.Visible := Value;
end;

procedure TClientiForm.SetFilter_Visible_CategCant4(const Value: Boolean);
begin
  fFilter_Visible_CategCant4 := Value;
  PratCategCant4.Visible := Value;
  PratLabelCategCant4.Visible := Value;
  DocCategCant4.Visible := Value;
  DocLabelCategCant4.Visible := Value;
  GMCategCant4.Visible := Value;
  GMLabelCategCant4.Visible := Value;
  GosOreCategCant4.Visible := Value;
  GosOreLabelCategCant4.Visible := Value;
  GosSpeseCategCant4.Visible := Value;
  GosSpeseLabelCategCant4.Visible := Value;
end;

procedure TClientiForm.SetFilter_Visible_CategCant5(const Value: Boolean);
begin
  fFilter_Visible_CategCant5 := Value;
  PratCategCant5.Visible := Value;
  PratLabelCategCant5.Visible := Value;
  DocCategCant5.Visible := Value;
  DocLabelCategCant5.Visible := Value;
  GMCategCant5.Visible := Value;
  GMLabelCategCant5.Visible := Value;
  GosOreCategCant5.Visible := Value;
  GosOreLabelCategCant5.Visible := Value;
  GosSpeseCategCant5.Visible := Value;
  GosSpeseLabelCategCant5.Visible := Value;
end;

procedure TClientiForm.SetFilter_Visible_CategCant6(const Value: Boolean);
begin
  fFilter_Visible_CategCant6 := Value;
  PratCategCant6.Visible := Value;
  PratLabelCategCant6.Visible := Value;
  DocCategCant6.Visible := Value;
  DocLabelCategCant6.Visible := Value;
  GMCategCant6.Visible := Value;
  GMLabelCategCant6.Visible := Value;
  GosOreCategCant6.Visible := Value;
  GosOreLabelCategCant6.Visible := Value;
  GosSpeseCategCant6.Visible := Value;
  GosSpeseLabelCategCant6.Visible := Value;
end;

procedure TClientiForm.SetFilter_Visible_SuubSogg1(const Value: Boolean);
begin
  fFilter_Visible_SubSogg1 := Value;
  // Soggetti
  LabelFilterSubSogg1.Visible := Value;
  EditClientiSubSogg1.Visible := Value;
  // Documenti
  DocLabelSubSogg1.Visible := Value;
  DocSubSogg1.Visible := Value;
end;

procedure TClientiForm.SetFilter_Visible_SuubSogg2(const Value: Boolean);
begin
  fFilter_Visible_SubSogg2 := Value;
  // Soggetti
  LabelFilterSubSogg2.Visible := Value;
  EditClientiSubSogg2.Visible := Value;
  // Documenti
  DocLabelSubSogg2.Visible := Value;
  DocSubSogg2.Visible := Value;
end;

procedure TClientiForm.SetFilter_Visible_SuubSogg3(const Value: Boolean);
begin
  fFilter_Visible_SubSogg3 := Value;
  // Soggetti
  LabelFilterSubSogg3.Visible := Value;
  EditClientiSubSogg3.Visible := Value;
  // Documenti
  DocLabelSubSogg3.Visible := Value;
  DocSubSogg3.Visible := Value;
end;

procedure TClientiForm.SetFilter_Visible_SuubSogg4(const Value: Boolean);
begin
  fFilter_Visible_SubSogg4 := Value;
  // Soggetti
  LabelFilterSubSogg4.Visible := Value;
  LabelFilterSubSogg4Dal.Visible := Value;
  EditClientiSubSogg4Dal.Visible := Value;
  EditClientiSubSogg4Al.Visible := Value;
  // Documenti
  DocLabelSubSogg4.Visible := Value;
  DocLabelSubSogg4Dal.Visible := Value;
  DocSubSogg4Dal.Visible := Value;
  DocSubSogg4Al.Visible := Value;
end;

procedure TClientiForm.PratCategCant1PropertiesInitPopup(Sender: TObject);
var
  Qry: TIB_Cursor;
  Combo: TcxComboBox;
  StcIndex: String;
begin
  // Inizializzazione
  Combo := (Sender as TcxComboBox);
  StcIndex := RightStr(Combo.Name, 1);
  Combo.Properties.Items.Clear;
  Combo.Properties.Items.Add('');
  // Altrimenti provvede a caricare i dati
  Qry := TIB_Cursor.Create(nil);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    // Imposta query
    Qry.SQL.Add('SELECT CAMPO1 FROM CATEGCANT' + StcIndex);
    Qry.Open;
    // Caricamento dati
    while not Qry.Eof do
    begin
      Combo.Properties.Items.Add(Qry.Fields[0].AsString);
      Qry.Next;
    end;
    Qry.Close;
  finally
    Qry.Free;
  end;
end;

procedure TClientiForm.SpeedButton1Click(Sender: TObject);
begin
  DM1.SalvaDatePredefinitePerFiltri(DateEditDa.EditText, DateEditA.EditText);
end;

procedure TClientiForm.SpeedButton2Click(Sender: TObject);
begin
  DM1.SalvaDatePredefinitePerFiltri(GMDal.EditText, GMAl.EditText);
end;

procedure TClientiForm.SpeedButton20Click(Sender: TObject);
var
  I: Integer;
begin
  PivotGridGM.BeginUpdate;
  try
    for I := 0 to PivotGridGM.FieldCount - 1 do
      PivotGridGM.Fields[I].CollapseAll;
  finally
    PivotGridGM.EndUpdate;
  end;
end;

procedure TClientiForm.SpeedButton21Click(Sender: TObject);
begin
  DM1.SalvaDatePredefinitePerFiltri(PratDal.EditText, PratAl.EditText);
end;

procedure TClientiForm.SpeedButton22Click(Sender: TObject);
begin
  DM1.SalvaDatePredefinitePerFiltri(ScadDal.EditText, ScadAl.EditText);
end;

procedure TClientiForm.SpeedButton23Click(Sender: TObject);
var
  I: Integer;
begin
  PivotGridGM.BeginUpdate;
  try
    for I := 0 to PivotGridGM.FieldCount - 1 do
      PivotGridGM.Fields[I].ExpandAll;
  finally
    PivotGridGM.EndUpdate;
  end;
end;

procedure TClientiForm.SpeedButton24Click(Sender: TObject);
begin
  if GridDoc.FocusedView = tvDoc then
    tvDoc.ViewData.Collapse(True)
  else
    tvAltriDoc.ViewData.Collapse(True);
end;

procedure TClientiForm.SpeedButton25Click(Sender: TObject);
begin
  if GridDoc.FocusedView = tvDoc then
    tvDoc.ViewData.Expand(True)
  else
    tvAltriDoc.ViewData.Expand(True);
end;

procedure TClientiForm.SpeedButton26Click(Sender: TObject);
begin
  tvScad.ViewData.Expand(True);
end;

procedure TClientiForm.SpeedButton27Click(Sender: TObject);
var
  I: Integer;
begin
  PivotGridDoc.BeginUpdate;
  try
    for I := 0 to PivotGridDoc.FieldCount - 1 do
      PivotGridDoc.Fields[I].CollapseAll;
  finally
    PivotGridDoc.EndUpdate;
  end;
end;

procedure TClientiForm.SvPrimanotaSaveDateFilterClick(Sender: TObject);
begin
  DM1.SalvaDatePredefinitePerFiltri(PrmDal.EditText, PrmAl.EditText);
end;

procedure TClientiForm.ImpSaveFilterDateClick(Sender: TObject);
begin
  DM1.SalvaDatePredefinitePerFiltri(ImpDal.EditText, ImpAl.EditText);
end;

procedure TClientiForm.GosSaveDateFilterClick(Sender: TObject);
begin
  DM1.SalvaDatePredefinitePerFiltri(GOSDal.EditText, GOSAl.EditText);
end;

procedure TClientiForm.ScadSoloRegistroPropertiesChange(Sender: TObject);
begin
  if ScadSoloRegistro.Text <> '' then
    ScadTranneRegistro.Text := '';
end;

procedure TClientiForm.ScadTranneRegistroPropertiesChange(Sender: TObject);
begin
  if ScadTranneRegistro.Text <> '' then
    ScadSoloRegistro.Text := '';
end;

procedure TClientiForm.Forzagiacenzaarticoliselezionati1Click(Sender: TObject);
var
  I: Integer;
  CodiceArticolo, Descrizione: String;
begin
  // Prima verifica che ci siano articoli selezionati
  if tvArt.Controller.SelectedRecordCount = 0 then
  begin
    DM1.Messaggi('Levante', 'Nessun articolo selezionato.', '', [mbOk], 0, nil);
    Exit;
  end;
  // Crea la form apposita
  Application.CreateForm(TForzaGiacenzeMagazzinoForm, ForzaGiacenzeMagazzinoForm);
  try
    // Aggiunge tutti gli articoli selezionati all'elenco degli articoli da elaborare all'interno della form.
    for I := 0 to tvArt.Controller.SelectedRecordCount - 1 do
    begin
      // Ovviamente salta le righe che non sono dati (gruppi ad esempio)
      if tvArt.Controller.SelectedRecords[I].IsData then
      begin
        // Carica i dati dell'articolo corrente
        ForzaGiacenzeMagazzinoForm.AddArticolo(tvArt.Controller.SelectedRecords[I].Values[tvArtCODICEARTICOLO.Index],
          tvArt.Controller.SelectedRecords[I].Values[tvArtDESCRIZIONE.Index]);
      end;
    end;
    // Visualizza la form per l'esecuzione dell'operazione
    ForzaGiacenzeMagazzinoForm.ShowModal;
  finally
    // Si assicura che anche se qualcosa  andato storto la form sia distrutta.
    if ForzaGiacenzeMagazzinoForm <> nil then
      FreeAndNil(ForzaGiacenzeMagazzinoForm);
  end;
end;

procedure TClientiForm.Esportadocumentoinformatotesto1Click(Sender: TObject);
var
  SelRec, I: Longint;
  TipoDoc, RegDoc: String;
  NumDoc: Integer;
  DataDoc: TDateTime;
  Ultimo: Boolean;
begin
  // SelRec contiene il numeero di records selezionati
  SelRec := tvDoc.Controller.SelectedRecordCount;
  // Ovviamente procede solo se vi sono documenti selezionati
  if SelRec = 0 then
    raise Exception.Create('Non ci sono documenti selezionati.');
  // Chiede conferma prima di continuare
  if DM1.Messaggi('Esportazione documenti', 'Confermi di voler continuare con l''esportazione dei documenti selezionati?', '', [mbYes, mbNo], 0, nil) <> mrYes
  then
    Exit;
  // Cicla per tutti i documenti selezionati e li esporta
  for I := 0 to SelRec - 1 do
  begin
    Ultimo := (I = (SelRec - 1));
    // Carica i dati del documento
    TipoDoc := tvDoc.Controller.SelectedRecords[I].Values[tvDocTIPODOC.Index];
    RegDoc := tvDoc.Controller.SelectedRecords[I].Values[tvDocREGISTRO.Index];
    NumDoc := tvDoc.Controller.SelectedRecords[I].Values[tvDocCODICEDOC.Index];
    DataDoc := tvDoc.Controller.SelectedRecords[I].Values[tvDocDATADOC.Index];
    // Effettua l'erportazione
    MainForm.EsportaDocumentoSilent(TipoDoc, NumDoc, RegDoc, DataDoc, 'TEXT', Ultimo);
  end;
end;

procedure TClientiForm.EsportadocumentoinformatoExcel1Click(Sender: TObject);
var
  SelRec, I: Longint;
  TipoDoc, RegDoc: String;
  NumDoc: Integer;
  DataDoc: TDateTime;
  Ultimo: Boolean;
begin
  // SelRec contiene il numeero di records selezionati
  SelRec := tvDoc.Controller.SelectedRecordCount;
  // Ovviamente procede solo se vi sono documenti selezionati
  if SelRec = 0 then
    raise Exception.Create('Non ci sono documenti selezionati.');
  // Chiede conferma prima di continuare
  if DM1.Messaggi('Esportazione documenti', 'Confermi di voler continuare con l''esportazione dei documenti selezionati?', '', [mbYes, mbNo], 0, nil) <> mrYes
  then
    Exit;
  // Cicla per tutti i documenti selezionati e li esporta
  for I := 0 to SelRec - 1 do
  begin
    Ultimo := (I = (SelRec - 1));
    // Carica i dati del documento
    TipoDoc := tvDoc.Controller.SelectedRecords[I].Values[tvDocTIPODOC.Index];
    RegDoc := tvDoc.Controller.SelectedRecords[I].Values[tvDocREGISTRO.Index];
    NumDoc := tvDoc.Controller.SelectedRecords[I].Values[tvDocCODICEDOC.Index];
    DataDoc := tvDoc.Controller.SelectedRecords[I].Values[tvDocDATADOC.Index];
    // Effettua l'erportazione
    MainForm.EsportaDocumentoSilent(TipoDoc, NumDoc, RegDoc, DataDoc, 'EXCEL', Ultimo);
  end;
end;

procedure TClientiForm.QryArtMagCalcFields(DataSet: TDataSet);
begin
  // Clacolo disponibile
  QryArtMagDISPONIBILE.Value := (QryArtMagGIACENZA.AsFloat - QryArtMagIMPEGNATO.AsFloat);
end;

procedure TClientiForm.tvArtMagGIACENZACustomDrawFooterCell(Sender: TcxGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridColumnHeaderViewInfo;
  var ADone: Boolean);
begin
  // IMposta il totale da visualizzare perch altrimenti in modalit
  // GridMode i totali non funzionano.
  AViewInfo.Text := FloatToStr(fTotaliArtMag_Giacenza);
  // Traccia il totale senza per il bordo
  ACanvas.FillRect(AViewInfo.Bounds);
  ACanvas.DrawText(AViewInfo.Text, AViewInfo.TextAreaBounds, cxAlignCenter, True);
  ADone := True;
end;

procedure TClientiForm.tvArtMagIMPEGNATOCustomDrawFooterCell(Sender: TcxGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridColumnHeaderViewInfo;
  var ADone: Boolean);
begin
  // IMposta il totale da visualizzare perch altrimenti in modalit
  // GridMode i totali non funzionano.
  AViewInfo.Text := FloatToStr(fTotaliArtMag_Impegnato);
  // Traccia il totale senza per il bordo
  ACanvas.FillRect(AViewInfo.Bounds);
  ACanvas.DrawText(AViewInfo.Text, AViewInfo.TextAreaBounds, cxAlignCenter, True);
  ADone := True;
end;

procedure TClientiForm.tvArtMagORDINATOCustomDrawFooterCell(Sender: TcxGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridColumnHeaderViewInfo;
  var ADone: Boolean);
begin
  // IMposta il totale da visualizzare perch altrimenti in modalit
  // GridMode i totali non funzionano.
  AViewInfo.Text := FloatToStr(fTotaliArtMag_Ordinato);
  // Traccia il totale senza per il bordo
  ACanvas.FillRect(AViewInfo.Bounds);
  ACanvas.DrawText(AViewInfo.Text, AViewInfo.TextAreaBounds, cxAlignCenter, True);
  ADone := True;
end;

procedure TClientiForm.tvArtMagDISPONIBILECustomDrawFooterCell(Sender: TcxGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridColumnHeaderViewInfo;
  var ADone: Boolean);
begin
  // IMposta il totale da visualizzare perch altrimenti in modalit
  // GridMode i totali non funzionano.
  AViewInfo.Text := FloatToStr(fTotaliArtMag_Disponibile);
  // Traccia il totale senza per il bordo
  ACanvas.FillRect(AViewInfo.Bounds);
  ACanvas.DrawText(AViewInfo.Text, AViewInfo.TextAreaBounds, cxAlignCenter, True);
  ADone := True;
end;

procedure TClientiForm.tvArtMagCustomDrawFooterCell(Sender: TcxGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridColumnHeaderViewInfo; var ADone: Boolean);
begin
  // Traccia il totale senza per il bordo
  ACanvas.FillRect(AViewInfo.Bounds);
  ACanvas.DrawText(AViewInfo.Text, AViewInfo.TextAreaBounds, cxAlignCenter, True);
  ADone := True;
end;

procedure TClientiForm.Stampaetichettedeiclientiselezionati1Click(Sender: TObject);
var
  Qry: TIB_Cursor;
  I: Integer;
begin
  DM1.Attendere;
  Qry := TIB_Cursor.Create(Self);
  try
    Qry.DatabaseName := DM1.ArcDBFile;
    Qry.IB_Connection := DM1.DBAzienda;
    // Svuota la tabella delle etichette
    DM2.SvuotaTabellaEtichette(IDX_ETICHETTA_SOGGETTO);
    // -----------------------------------------------------------------------------------------------------------------------------------
    DM1.DBAzienda.StartTransaction;
    try
      // Cicla per tutti i righi selezionati
      for I := 0 to tvRubrica.Controller.SelectedRecordCount - 1 do
      begin
        // Imposta la query che inserisce il record relativo al cliente attuale
        Qry.SQL.Clear;
        Qry.SQL.Add('INSERT INTO LABSOGG (CODICESTAZIONE,PROGRIGO,Codice,RagioneSociale,Indirizzo,NumCivico,Citta,CAP,Provincia)');
        Qry.SQL.Add('VALUES (');
        Qry.SQL.Add(QuotedStr(DM1.CodiceUtente) + ',');
        Qry.SQL.Add(IntToStr(I) + ',');
        Qry.SQL.Add(QuotedStr(tvRubrica.Controller.SelectedRecords[I].Values[tvRubricaCODICE.Index]) + ',');

        if not VarIsNull(tvRubrica.Controller.SelectedRecords[I].Values[tvRubricaRAGIONESOCIALE.Index]) then
          Qry.SQL.Add(QuotedStr(tvRubrica.Controller.SelectedRecords[I].Values[tvRubricaRAGIONESOCIALE.Index]) + ',')
        else
          Qry.SQL.Add(QuotedStr('') + ',');

        if not VarIsNull(tvRubrica.Controller.SelectedRecords[I].Values[tvRubricaINDIRIZZO.Index]) then
          Qry.SQL.Add(QuotedStr(tvRubrica.Controller.SelectedRecords[I].Values[tvRubricaINDIRIZZO.Index]) + ',')
        else
          Qry.SQL.Add(QuotedStr('') + ',');

        Qry.SQL.Add(QuotedStr('') + ','); // Num civico  sempre vuoto perch come campo singolo non  presente nella griglia

        if not VarIsNull(tvRubrica.Controller.SelectedRecords[I].Values[tvRubricaCITTA.Index]) then
          Qry.SQL.Add(QuotedStr(tvRubrica.Controller.SelectedRecords[I].Values[tvRubricaCITTA.Index]) + ',')
        else
          Qry.SQL.Add(QuotedStr('') + ',');

        if not VarIsNull(tvRubrica.Controller.SelectedRecords[I].Values[tvRubricaCAP.Index]) then
          Qry.SQL.Add(QuotedStr(tvRubrica.Controller.SelectedRecords[I].Values[tvRubricaCAP.Index]) + ',')
        else
          Qry.SQL.Add(QuotedStr('') + ',');

        if not VarIsNull(tvRubrica.Controller.SelectedRecords[I].Values[tvRubricaPROVINCIA.Index]) then
          Qry.SQL.Add(QuotedStr(tvRubrica.Controller.SelectedRecords[I].Values[tvRubricaPROVINCIA.Index]))
        else
          Qry.SQL.Add(QuotedStr(''));

        Qry.SQL.Add(')');
        // esegue la query
        Qry.ExecSQL;
      end;
      DM1.DBAzienda.Commit;
    except
      DM1.DBAzienda.Rollback;
      raise;
    end;
    // -----------------------------------------------------------------------------------------------------------------------------------
    // Crea e avvia la form per la stampa delle etichette
    DM2.StampaEtichette(IDX_ETICHETTA_SOGGETTO);
  finally
    DM1.ChiudiAttendere;
    if Assigned(Qry) then
      Qry.Free;
  end;
end;

procedure TClientiForm.Altreesportazioniarticolilistini1Click(Sender: TObject);
var
  MI: TMenuItem;
  MenuCaption, Distributore, Filiale, Tipo, FullPathFileNameToSave, DestDir: String;
  FullPathCompressedFileName: String;
  Qry: TIBOQuery;
  ElencoFiles: TStrings;
begin
  // Inizializzazione
  FullPathCompressedFileName := DM1.GetTempFileName('zlb', DM1.CartellaTmp);
  // MI punta alla voce di men che ha scatenato l'evento
  MI := Sender as TMenuItem;
  // Carica la caption
  MenuCaption := MI.Caption;

  // ===========================================================================
  // Parte che ricava dalla caption della voce di menu i dati necessari
  // a richiamare con una query il record relativo al listino ricevuto.
  // ---------------------------------------------------------------------------
  // Elimina la parte "File " dalla caption
  DM1.RitornaTestoPrimaDi(' ', MenuCaption, True);
  // Ricava il TIPO
  Tipo := Trim(DM1.RitornaTestoPrimaDi(' ', MenuCaption, True));
  // Elimina la parte successiva ' di '
  DM1.RitornaTestoPrimaDi(' ', MenuCaption, True);
  // Ricava il DISTRIBUTORE
  Distributore := Trim(DM1.RitornaTestoPrimaDi(' ', MenuCaption, True));
  // Elimina la parte successiva ' filiale '
  DM1.RitornaTestoPrimaDi(' ', MenuCaption, True);
  // Ricava la FILIALE
  Filiale := Trim(DM1.RitornaTestoPrimaDi(' ', MenuCaption, True));
  // ===========================================================================

  // Chiede all'utente di soecificare il nome del file
  // NB: Prima azzera il nome file
  DM1.SaveDialog1.FileName := '';
  if not DM1.SaveDialog1.Execute then
    Exit;

  // Carica il nome scelto dall'utente nell'apposita variabile
  FullPathFileNameToSave := DM1.SaveDialog1.FileName;
  // Ricava la directory destinazione.
  DestDir := DM1.SlashFinale(ExtractFileDir(FullPathFileNameToSave));

  // Verifica che il file non esista gi, e se esiste chiede se lo si vuole sovrascrivere
  if FileExists(FullPathFileNameToSave) then
  begin
    if DM1.Messaggi('Esportazione', 'File gi esistente !!!'#13#13'Devo proseguire e sovrascrivere il file?',
      'NB: Rispondendo "SI" e quindi sovrascrivendo il file esistente i dati in esso contenuti saranno perduti.', [mbYes, mbNo], 0, nil) <> mrYes then
      Exit;
  end;

  // Informa l'utente
  DM1.ShowWait('Esportazione.', 'Operazione in corso...');
  Sleep(1000);
  try

    // ===========================================================================
    // PArte che preleva dal database il file compresso da esportare
    // ---------------------------------------------------------------------------
    // IMposta la query che prelever il file dall'apposito archivio
    try
      Qry := TIBOQuery.Create(Self);
      Qry.DatabaseName := DM1.ArcDBFile;
      Qry.IB_Connection := DM1.DBAzienda;
      Qry.SQL.Add('SELECT FIRST 1 ULTIMOFILESCARICATO FROM LISTINIRICEVUTI');
      Qry.SQL.Add('WHERE CODICEDISTRIBUTORE = ' + QuotedStr(Distributore));
      Qry.SQL.Add('  AND CODICEFILIALE = ' + QuotedStr(Filiale));
      Qry.SQL.Add('  AND TIPO = ' + QuotedStr(Tipo));
      // Esegue la query
      Qry.Open;
      // Verifica di aver trovato il record
      if Qry.Eof then
        raise Exception.Create('File da esportare non trovato.');
      // Salva il file compresso nella cartella temporanea
      (Qry.Fields[0] as TBlobField).SaveToFile(FullPathCompressedFileName);
    finally
      Qry.Free;
    end;
    // ===========================================================================

    // ===========================================================================
    // PArte che decomprime il file compresso
    // ---------------------------------------------------------------------------
    // Apre il file compresso
    DM1.ZLB1.OpenArchive(FullPathCompressedFileName);
    ElencoFiles := TStringList.Create;
    try
      // Ricava l'elenco dei file contenuti nell'archivio compresso
      DM1.ZLB1.GetFileList(ElencoFiles);
      // Estrae il primo file contenuto (che dovrebbe essere l'unico)
      DM1.ZLB1.ExtractFileByIndex(DestDir, 0);
      // Rinomina il file appena esportato in modo da dargli il nome voluto
      RenameFile(DestDir + ElencoFiles[0], FullPathFileNameToSave);
    finally
      // Pulizie finali
      ElencoFiles.Free;
      // Chiude il file compresso
      DM1.ZLB1.CloseArchive;
    end;
    // ===========================================================================

  finally
    DM1.CloseWait;
    DM1.Messaggi('Levante - Esportazione dati', 'Operazione terminata.', '', [mbOk], 0, nil);
  end;
end;

procedure TClientiForm.SetDocFilter_Descrizione_Visible(const Value: Boolean);
begin
  fDocFilter_Descrizione_Visible := Value;
  LabelFilterDescrizione.Visible := Value;
  FilterDescrizione.Visible := Value;
end;

procedure TClientiForm.SetDocFilter_CodiceArticolo_Visible(const Value: Boolean);
begin
  fDocFilter_CodiceArticolo_Visible := Value;
  LabelFilterCodiceArticolo.Visible := Value;
  FilterCodiceArticolo.Visible := Value;
end;

procedure TClientiForm.tvLFEndDrag(Sender, Target: TObject; X, Y: Integer);
var
  MDC, DDC: TcxCustomDataController;
  TV: TcxGridDBTableView;
  I, MRI: Integer;
  Qry: TIB_Cursor;
  Value_Qta: Double;
  Value_CodiceArticolo, Value_CodiceArticoloStm, Value_Descrizione, Value_UM: String;
begin
  // Verifica Target
  if Target = nil then
    Exit;
  try
    // Inizializzazione
    MRI := -1;
    // Crea la Qry per l'esportazione degli articoli
    Qry := TIB_Cursor.Create(Self);
    Qry.DatabaseName := DM1.GenDBFile;
    Qry.IB_Connection := DM1.DBGenerale;
    // TV Punta alla TableView interessata
    TV := ((Sender as TcxGridSite).GridView as TcxGridDBTableView);
    // DDC Punta al data controller della vista in Sender
    DDC := TV.DataController;
    // Se DDC  un Detail Data controller significa che l'utente sta
    // trascinando un rigo di un dettaglio cio di un fornitore, nel
    // qual caso allora MDC punter al Master Data controller,
    // altrimenti invece MDC punter anchesso al DataController di Sender.
    if TV.IsDetail then
    begin
      MDC := DDC.GetMasterDataController;
      // MRI contiene l'indice del MasterRecord
      MRI := DDC.GetMasterRecordIndex;
    end
    else
      MDC := DDC;

    // =========================================================================
    // Se il Target  uno SpeedButton esegue l'onClick dello SpeedButton Stesso
    // -------------------------------------------------------------------------
    if Target is TSpeedButton then
    begin
      TSpeedButton(Target).OnClick(Self);

      // =========================================================================
      // Se il bersaglio e la ListView della bacheca e se ci sono righi selezionati...
      // -------------------------------------------------------------------------
    end
    else if (Target is TListView) and (TListView(Target).Name = 'ListViewExpDoc') and (TV.Controller.SelectedRecordCount > 0) then
    begin
      // Cicla per tutti i righi selezionati
      for I := 0 to TV.Controller.SelectedRecordCount - 1 do
      begin

        // Se la vista da cui si stanno trascinando i righi  di dettaglio significa che stiamo trascinando
        // da un listino fornitore specifico e quindi i dati li prende da li alcuni e altri dal MasterRecord
        if TV.IsDetail then
        begin
          // Codice Articolo
          Value_CodiceArticolo := DM1.NoNullStringValue(MDC, MRI, tvArtCODICEARTICOLO.Index);
          // Codice Articolo STM
          if (not VarIsNull(TV.Controller.SelectedRecords[I].Values[tvLFCODICEARTICOLOFORNITORE.Index])) and
            (Trim(TV.Controller.SelectedRecords[I].Values[tvLFCODICEARTICOLOFORNITORE.Index]) <> '') then
            Value_CodiceArticoloStm := TV.Controller.SelectedRecords[I].Values[tvLFCODICEARTICOLOFORNITORE.Index]
          else
            Value_CodiceArticoloStm := Value_CodiceArticolo;
          // Descrizione
          if (not VarIsNull(TV.Controller.SelectedRecords[I].Values[tvLFDESCRIZIONEFORNITORE.Index])) and
            (Trim(TV.Controller.SelectedRecords[I].Values[tvLFDESCRIZIONEFORNITORE.Index]) <> '') then
            Value_Descrizione := TV.Controller.SelectedRecords[I].Values[tvLFDESCRIZIONEFORNITORE.Index]
          else
            Value_Descrizione := DM1.NoNullStringValue(MDC, MRI, tvArtDESCRIZIONE.Index);
          // Unita di misura
          Value_UM := DM1.NoNullStringValue(MDC, MRI, tvArtUNITADIMISURA.Index);
          // Qta contiene la qt autoamtica dell'articolo oppure 1 se non  specificata
          if not VarIsNull(MDC.Values[MRI, tvArtQUANTITAAUTOMATICA.Index]) then
            Value_Qta := MDC.Values[MRI, tvArtQUANTITAAUTOMATICA.Index]
          else
            Value_Qta := 1;
          // Se invece stiamo spostado dei righi principali prende tutto dal Master
        end
        else
        begin
          // Codice Articolo
          Value_CodiceArticolo := TV.Controller.SelectedRecords[I].Values[tvArtCODICEARTICOLO.Index];
          // Codice Articolo STM
          Value_CodiceArticoloStm := Value_CodiceArticolo;
          // Descrizione
          if (not VarIsNull(TV.Controller.SelectedRecords[I].Values[tvArtDESCRIZIONE.Index])) and
            (Trim(TV.Controller.SelectedRecords[I].Values[tvArtDESCRIZIONE.Index]) <> '') then
            Value_Descrizione := TV.Controller.SelectedRecords[I].Values[tvArtDESCRIZIONE.Index]
          else
            Value_Descrizione := '';
          // Unita di misura
          if (not VarIsNull(TV.Controller.SelectedRecords[I].Values[tvArtUNITADIMISURA.Index])) and
            (Trim(TV.Controller.SelectedRecords[I].Values[tvArtUNITADIMISURA.Index]) <> '') then
            Value_UM := TV.Controller.SelectedRecords[I].Values[tvArtUNITADIMISURA.Index]
          else
            Value_UM := '';
          // Qta contiene la qt autoamtica dell'articolo oppure 1 se non  specificata
          if not VarIsNull(TV.Controller.SelectedRecords[I].Values[tvArtQUANTITAAUTOMATICA.Index]) then
            Value_Qta := TV.Controller.SelectedRecords[I].Values[tvArtQUANTITAAUTOMATICA.Index]
          else
            Value_Qta := 1;
        end;

        // Se abilitato richiede la Qt
        // NB: Prima di visualizzare la form che richiede la Qta disabilita il gestore dell'evento
        // 'onKeyUp' della griglia perch altrimenti succede una cosa strana e cio che
        //  come se si premesse di nuovo INVIO anche sulla griglia (dopo la chiusura della richiesta Qt)
        // ed era molto fastidioso.
        if DM1.RichiediQta then
          Value_Qta := DM1.ChiediQtaArticolo(Value_CodiceArticoloStm, Value_Descrizione, Value_UM, Value_Qta);

        // Imposta la query per l'inserimento dell'articolo nella bacheca
        Qry.SQL.Clear;
        Qry.SQL.Add('INSERT INTO TMPRIGHI (STATION_ID, TIPODOCUMENTO, CODICEARTICOLO, CODICEARTICOLOSTM, DESCRIZIONE, QTA)');
        Qry.SQL.Add('VALUES(');
        Qry.SQL.Add(DM1.CodiceUtente + ',');
        Qry.SQL.Add('''ARTICOLO'',');
        Qry.SQL.Add(AnsiQuotedStr(Value_CodiceArticolo, '''') + ',');
        Qry.SQL.Add(AnsiQuotedStr(Value_CodiceArticoloStm, '''') + ',');
        Qry.SQL.Add(AnsiQuotedStr(LeftStr(Value_Descrizione, 20), '''') + ',');
        Qry.SQL.Add(DM1.FloatVarToSQL(Value_Qta));
        Qry.SQL.Add(')');
        Qry.ExecSQL;

        // Aggiorna  i documenti esportati
        MainForm.AggiornaDocumentiEsportati;
      end;
    end
    // =========================================================================

  finally
    // Pulizie finali
    if Assigned(Qry) then
      FreeAndNil(Qry);
  end;
end;

procedure TClientiForm.Creanuovocantiereconglistessisottocantieri1Click(Sender: TObject);
begin
  // Crea il nuovo cantiere e lo visualizza
  MIPraticaClick(MIPratica);
  // Imposta il riferimento alla pratica modello (quella selezionata):
  PraticaForm.DatiModelloPratica.Tipo := 'P';
  PraticaForm.DatiModelloPratica.Codice := QryPraticheCODICE.AsInteger;
  PraticaForm.DatiModelloPratica.DataApertura := QryPraticheDATAAPERTURA.AsDateTime;
end;

procedure TClientiForm.CreaNuovoImpianto(TipoImpianto: String);
begin
  DM1.Attendere;
  try
    Application.CreateForm(TPraticaForm, PraticaForm);
    PraticaForm.Mode := MODE_ASSISTENZE;
    PraticaForm.Parent := MainForm;
    PraticaForm.CodiceCliente := '0';
    if ClienteCorrente <> '' then
      PraticaForm.CodiceCliente := ClienteCorrente;
    PraticaForm.TipoNuovoImpianto := TipoImpianto;
    PraticaForm.Tag := 2;
    PraticaForm.Show;
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.Centraletermica1Click(Sender: TObject);
begin
  CreaNuovoImpianto('Centrale termica');
end;

procedure TClientiForm.Riscaldamento1Click(Sender: TObject);
begin
  CreaNuovoImpianto('Riscaldamento');
end;

procedure TClientiForm.Climatizzazione1Click(Sender: TObject);
begin
  CreaNuovoImpianto('Climatizzazione');
end;

procedure TClientiForm.Refrigerazione1Click(Sender: TObject);
begin
  CreaNuovoImpianto('Refrigerazione');
end;

procedure TClientiForm.Generico1Click(Sender: TObject);
begin
  CreaNuovoImpianto('Generico');
end;

procedure TClientiForm.Stampaetichettedegliarticoliselezionati1Click(Sender: TObject);
var
  I: Integer;
begin
  DM1.Attendere;
  try
    // Svuota la tabella delle etichette
    DM2.SvuotaTabellaEtichette(IDX_ETICHETTA_ARTICOLO);
    // -----------------------------------------------------------------------------------------------------------------------------------
    DM1.DBAzienda.StartTransaction;
    try
      // CIcla per tutti i records selezionati
      for I := 0 to tvArt.Controller.SelectedRecordCount - 1 do
      begin
        // Crea la query e cicla per aggiungere a questa tutti gli articoli che servono
        DM2.LoadTabellaEtichetteArticoli(tvArt.Controller.SelectedRecords[I].DisplayTexts[tvArtCODICEARTICOLO.Index]);
      end;
      DM1.DBAzienda.Commit;
    except
      DM1.DBAzienda.Rollback;
      raise;
    end;
    // -----------------------------------------------------------------------------------------------------------------------------------
    // Crea e avvia la form per la stampa delle etichette
    DM2.StampaEtichette(IDX_ETICHETTA_ARTICOLO);
  finally
    DM1.ChiudiAttendere;
  end;
end;

procedure TClientiForm.tvPrimanotaCassaEntrateGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
begin
  // Lo zero non lo visualizza
  if (not VarIsNull(ARecord.Values[Sender.Index])) and (ARecord.Values[Sender.Index] = 0) then
    AText := '';
end;

procedure TClientiForm.tvDocIMPONIBILEGetDisplayText(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord; var AText: String);
begin
  // Lo zero non lo visualizza
  if (not VarIsNull(ARecord.Values[Sender.Index])) and (ARecord.Values[Sender.Index] = 0) then
    AText := '';
end;

procedure TClientiForm.PageControlImpegniChange(Sender: TObject);
begin
  // Se siamo nella pagina della mappa crea l'apposita form all'interno del Tab
  // NB: Ovviamente se non esiste gi
  if (PageControlImpegni.ActivePage = TabImpegniMappa) then
  begin
    if not Assigned(MapFormImpegni) then
      CreaMappaImpegni;
    // Se ci spostiamo fuori dalla mappa la distrugge
  end
  else
  begin
    if Assigned(MapFormImpegni) then
    begin
      MapFormImpegni.Free;
      MapFormImpegni := nil;
    end;
  end;
end;

procedure TClientiForm.CreaMappaImpegni;
var
  CurrMapForm: TGmapForm;
begin
  // Imposta la MapForm corrente
  CurrMapForm := MapFormImpegni;
  // Se siamo nella pagina della mappa crea l'apposita form all'interno del Tab
  // NB: Ovviamente se non esiste gi
  if (PageControlImpegni.ActivePage = TabImpegniMappa) and not Assigned(CurrMapForm) then
  begin
    // Verifica selezione
    if tvImpegni.Controller.SelectedRecordCount = 0 then
    begin
      DM1.Messaggi('Levante', 'Nessuna voce selezionata!', '', [mbOk], 0, nil);
      Exit;
    end;
    // Crea la form della mappa
    CurrMapForm := GMap_CreateInParent(TabImpegniMappa);
    // Show della form della mappa
    CurrMapForm.Show;
    // Costruisce e visualizza la mappa
    CurrMapForm.CreaMappa(tvImpegni.Controller, tvImpegniLOCATION.Index);
  end;
end;

procedure TClientiForm.CreaMappaRubrica;
var
  CurrMapForm: TGmapForm;
begin
  // Imposta la MapForm corrente
  CurrMapForm := MapFormRubrica;
  // Se siamo nella pagina della mappa crea l'apposita form all'interno del Tab
  // NB: Ovviamente se non esiste gi
  if (PageControlClienti.ActivePage = TabClientiMappa) and not Assigned(CurrMapForm) then
  begin
    // Verifica selezione
    if tvRubrica.Controller.SelectedRecordCount = 0 then
    begin
      DM1.Messaggi('Levante', 'Nessuna voce selezionata!', '', [mbOk], 0, nil);
      Exit;
    end;
    // Crea la form della mappa
    CurrMapForm := GMap_CreateInParent(TabClientiMappa);
    // Show della form della mappa
    CurrMapForm.Show;
    // Costruisce e visualizza la mappa
    CurrMapForm.CreaMappa(tvRubrica.Controller, tvRubricaPROVINCIA.Index, tvRubricaCITTA.Index, tvRubricaCAP.Index, tvRubricaINDIRIZZO.Index, 0);

  end;
end;

procedure TClientiForm.CreaMappaPratiche;
var
  CurrMapForm: TGmapForm;
begin
  // Imposta la MapForm corrente
  CurrMapForm := MapFormPratiche;
  // Se siamo nella pagina della mappa crea l'apposita form all'interno del Tab
  // NB: Ovviamente se non esiste gi
  if (PageControlPratiche.ActivePage = TabPraticheMappa) and not Assigned(CurrMapForm) then
  begin
    // Verifica selezione
    if tvPrat.Controller.SelectedRecordCount = 0 then
    begin
      DM1.Messaggi('Levante', 'Nessuna voce selezionata!', '', [mbOk], 0, nil);
      Exit;
    end;
    // Crea la form della mappa
    CurrMapForm := GMap_CreateInParent(TabPraticheMappa);
    // Show della form della mappa
    CurrMapForm.Show;
    // Costruisce e visualizza la mappa
    CurrMapForm.CreaMappa(tvPrat.Controller, tvPratIMMOBPROVINCIA.Index, tvPratIMMOBLOCALITA.Index, tvPratIMMOBCAP.Index, tvPratIMMOBINDIRIZZO.Index, 0);

  end;
end;

procedure TClientiForm.PageControlClientiChange(Sender: TObject);
begin
  // Se siamo nella pagina della mappa crea l'apposita form all'interno del Tab
  // NB: Ovviamente se non esiste gi
  if (PageControlClienti.ActivePage = TabClientiMappa) then
  begin
    if not Assigned(MapFormRubrica) then
      CreaMappaRubrica;
    // Se ci spostiamo fuori dalla mappa la distrugge
  end
  else
  begin
    if Assigned(MapFormRubrica) then
    begin
      MapFormRubrica.Free;
      MapFormRubrica := nil;
    end;
  end;
end;

procedure TClientiForm.PageControlDocPageChanging(Sender: TObject; NewPage: TcxTabSheet; var AllowChange: Boolean);
var
  LChart: TChartFrame;
begin
  // Normalmente la PivotGrid  scollegata perch altrimenti causa rallentamenti
  // pesanti in presenza di molti record
  DM1.ShowWait('Levante', 'Caricamento...');
  try
    // ADA
    if NewPage = TabSheetDocADA then
      PivotGridDoc.DataSource := SourceDoc
    else
      PivotGridDoc.DataSource := nil;
    // Charts
    if NewPage = TabSheetDocCharts then
      ShowDocChart;
  finally
    DM1.CloseWait;
  end;
end;

procedure TClientiForm.PageControlGMPageChanging(Sender: TObject; NewPage: TcxTabSheet; var AllowChange: Boolean);
var
  LChart: TChartFrame;
begin
  // Normalmente la PivotGrid  scollegata perch altrimenti causa rallentamenti
  // pesanti in presenza di molti record
  DM1.ShowWait('Levante', 'Caricamento...');
  try
    // ADA
    if NewPage = TabGMADA then
      PivotGridGM.DataSource := SourcGM
    else
      PivotGridGM.DataSource := nil;
    // Charts
    if NewPage = TabGMGrafici then
      ShowGMChart;
  finally
    DM1.CloseWait;
  end;
end;

procedure TClientiForm.PageControlPraticheChange(Sender: TObject);
begin
  // Se siamo nella pagina della mappa crea l'apposita form all'interno del Tab
  // NB: Ovviamente se non esiste gi
  if (PageControlPratiche.ActivePage = TabPraticheMappa) then
  begin
    if not Assigned(MapFormPratiche) then
      CreaMappaPratiche;
    // Se ci spostiamo fuori dalla mappa la distrugge
  end
  else
  begin
    if Assigned(MapFormPratiche) then
    begin
      MapFormPratiche.Free;
      MapFormPratiche := nil;
    end;
  end;
end;

procedure TClientiForm.PageControlScadPageChanging(Sender: TObject; NewPage: TcxTabSheet; var AllowChange: Boolean);
var
  LChart: TChartFrame;
begin
  inherited;
  // Normalmente la PivotGrid  scollegata perch altrimenti causa rallentamenti
  // pesanti in presenza di molti record
  DM1.ShowWait('Levante', 'Caricamento...');
  try
    // ADA
    if NewPage = TabScadADA then
      PivotGridScad.DataSource := SourceScad
    else
      PivotGridScad.DataSource := nil;
    // Charts
    if NewPage = TabScadCharts then
      ShowScadenzeChart;
  finally
    DM1.CloseWait;
  end;
end;

procedure TClientiForm.EditClientiAgentePropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(1, EditClientiAgente2);
end;

procedure TClientiForm.EditClientiAgente2PropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(2, EditClientiAgente3);
end;

procedure TClientiForm.EditClientiAgente3PropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(3, EditClientiAgente4);
end;

procedure TClientiForm.EditClientiAgentePropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(EditClientiAgente.Properties.Items, 1, '');
end;

procedure TClientiForm.EditClientiAgente2PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(EditClientiAgente2.Properties.Items, 2, EditClientiAgente.Text);
end;

procedure TClientiForm.EditClientiAgente3PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(EditClientiAgente3.Properties.Items, 3, EditClientiAgente2.Text);
end;

procedure TClientiForm.EditClientiAgente4PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(EditClientiAgente4.Properties.Items, 4, EditClientiAgente3.Text);
end;

procedure TClientiForm.PratAgentePropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(1, PratAgente2);
end;

procedure TClientiForm.PratAgente2PropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(2, PratAgente3);
end;

procedure TClientiForm.PratAgente3PropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(3, PratAgente4);
end;

procedure TClientiForm.PratAgentePropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(PratAgente.Properties.Items, 1, '');
end;

procedure TClientiForm.PratAgente2PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(PratAgente2.Properties.Items, 2, PratAgente.Text);
end;

procedure TClientiForm.PratAgente3PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(PratAgente3.Properties.Items, 3, PratAgente2.Text);
end;

procedure TClientiForm.PratAgente4PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(PratAgente4.Properties.Items, 4, PratAgente3.Text);
end;

procedure TClientiForm.DocAgentePropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(1, DocAgente2);
end;

procedure TClientiForm.DocAgente2PropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(2, DocAgente3);
end;

procedure TClientiForm.DocAgente3PropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(3, DocAgente4);
end;

procedure TClientiForm.DocAgentePropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(DocAgente.Properties.Items, 1, '');
end;

procedure TClientiForm.DocAgente2PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(DocAgente2.Properties.Items, 2, DocAgente.Text);
end;

procedure TClientiForm.DocAgente3PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(DocAgente3.Properties.Items, 3, DocAgente2.Text);
end;

procedure TClientiForm.DocAgente4PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(DocAgente4.Properties.Items, 4, DocAgente3.Text);
end;

procedure TClientiForm.ScadAgentePropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(1, ScadAgente2);
end;

procedure TClientiForm.ScadAgente2PropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(2, ScadAgente3);
end;

procedure TClientiForm.ScadAgente3PropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(3, ScadAgente4);
end;

procedure TClientiForm.ScadAgentePropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(ScadAgente.Properties.Items, 1, '');
end;

procedure TClientiForm.ScadAgente2PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(ScadAgente2.Properties.Items, 2, ScadAgente.Text);
end;

procedure TClientiForm.ScadAgente3PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(ScadAgente3.Properties.Items, 3, ScadAgente2.Text);
end;

procedure TClientiForm.ScadAgente4PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(ScadAgente4.Properties.Items, 4, ScadAgente3.Text);
end;

procedure TClientiForm.PrmAgentePropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(1, PrmAgente2);
end;

procedure TClientiForm.PrmAgente2PropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(2, PrmAgente3);
end;

procedure TClientiForm.PrmAgente3PropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(3, PrmAgente4);
end;

procedure TClientiForm.PrmAgentePropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(PrmAgente.Properties.Items, 1, '');
end;

procedure TClientiForm.PrmAgente2PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(PrmAgente2.Properties.Items, 2, PrmAgente.Text);
end;

procedure TClientiForm.PrmAgente3PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(PrmAgente3.Properties.Items, 3, PrmAgente2.Text);
end;

procedure TClientiForm.PrmAgente4PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(PrmAgente4.Properties.Items, 4, PrmAgente3.Text);
end;

procedure TClientiForm.ImpAgentePropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(1, ImpAgente2);
end;

procedure TClientiForm.ImpAgente2PropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(2, ImpAgente3);
end;

procedure TClientiForm.ImpAgente3PropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(3, ImpAgente4);
end;

procedure TClientiForm.ImpAgentePropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(ImpAgente.Properties.Items, 1, '');
end;

procedure TClientiForm.ImpAgente2PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(ImpAgente2.Properties.Items, 2, ImpAgente.Text);
end;

procedure TClientiForm.ImpAgente3PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(ImpAgente3.Properties.Items, 3, ImpAgente2.Text);
end;

procedure TClientiForm.ImpAgente4PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(ImpAgente4.Properties.Items, 4, ImpAgente3.Text);
end;

procedure TClientiForm.GMAgentePropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(1, GMAgente2);
end;

procedure TClientiForm.GMAgente2PropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(2, GMAgente3);
end;

procedure TClientiForm.GMAgente3PropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(3, GMAgente4);
end;

procedure TClientiForm.GMAgentePropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(GMAgente.Properties.Items, 1, '');
end;

procedure TClientiForm.GMAgente2PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(GMAgente2.Properties.Items, 2, GMAgente.Text);
end;

procedure TClientiForm.GMAgente3PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(GMAgente3.Properties.Items, 3, GMAgente2.Text);
end;

procedure TClientiForm.GMAgente4PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(GMAgente4.Properties.Items, 4, GMAgente3.Text);
end;

procedure TClientiForm.Stampagiornaledicantiere1Click(Sender: TObject);
var
  ShowDlgForm: Boolean;
  PrecFooterColor: TColor;
begin
  ShowDlgForm := (StampeCantieriForm = nil);
  // Imposta la stringa su cui viene costruito il range di date della stampa in base ai filtri per data
  DM1.SetReportDateRange(TabGCForm.GCDal.EditText, TabGCForm.GCAl.EditText);
  // Salva e modifica alcune propriet per adattare il componente alla stampe
  // e poi rimette tutto a posto.
  TabGCForm.GridGC.BeginUpdate;
  TabGCForm.GridGC.RootLevelOptions.DetailFrameColor := clWhite;
  TabGCForm.GridGC.LookAndFeel.Kind := lfUltraFlat;
  TabGCForm.btvGC.OptionsView.GroupRowStyle := grsStandard;
  TabGCForm.btvGCRighi.OptionsView.GroupRowStyle := grsStandard;
  PrecFooterColor := DM1.tvGridFooter.Color;
  DM1.tvGridFooter.Color := clWhite;
  try
    // Imposta alcune propriet
    TabGCForm.GridGCLink.OptionsExpanding.ExpandGroupRows := False;
    TabGCForm.GridGCLink.OptionsExpanding.ExpandMasterRows := False;
    // Anteprima
    if MenuStampe.Tag = 0 then
    begin
      TabGCForm.dxPrinter.Preview(True, TabGCForm.GridGCLink);
      // Stampa
    end
    else if MenuStampe.Tag = 1 then
    begin
      TabGCForm.dxPrinter.Print(ShowDlgForm, nil, TabGCForm.GridGCLink);
    end;
  finally
    // Ripristina l'aspetto del componente
    TabGCForm.GridGC.RootLevelOptions.DetailFrameColor := clBlack;
    TabGCForm.GridGC.LookAndFeel.Kind := lfOffice11;
    TabGCForm.btvGC.OptionsView.GroupRowStyle := grsOffice11;
    TabGCForm.btvGCRighi.OptionsView.GroupRowStyle := grsOffice11;
    DM1.tvGridFooter.Color := PrecFooterColor;
    TabGCForm.GridGC.EndUpdate;
  end;
end;

procedure TClientiForm.SBCollapseGOSoreClick(Sender: TObject);
begin
  tvOre.ViewData.Collapse(True);
end;

procedure TClientiForm.SBCollapseGOSspeseClick(Sender: TObject);
begin
  tvSpese.ViewData.Collapse(True);
end;

procedure TClientiForm.SBCOllapseImpegniClick(Sender: TObject);
begin
  tvImpegni.ViewData.Collapse(False);
end;

procedure TClientiForm.SBExpandGOSoreClick(Sender: TObject);
begin
  tvOre.ViewData.Expand(True);
end;

procedure TClientiForm.SBExpandGOSspeseClick(Sender: TObject);
begin
  tvSpese.ViewData.Expand(True);
end;

procedure TClientiForm.SBExpandImpegniClick(Sender: TObject);
begin
  tvImpegni.ViewData.Expand(False);
end;

procedure TClientiForm.SBFilterRowGOSoreClick(Sender: TObject);
begin
  // Attiva/Disattiva la Filter Row
  tvOre.FilterRow.Visible := (Sender as TSpeedButton).Down;
  if not tvOre.FilterRow.Visible then
    tvOre.DataController.Filter.Clear;
end;

procedure TClientiForm.SBFilterRowGOSspeseClick(Sender: TObject);
begin
  // Attiva/Disattiva la Filter Row
  tvSpese.FilterRow.Visible := (Sender as TSpeedButton).Down;
  if not tvSpese.FilterRow.Visible then
    tvSpese.DataController.Filter.Clear;
end;

procedure TClientiForm.SBFilterRowImpegniClick(Sender: TObject);
begin
  // Attiva/Disattiva la Filter Row
  tvImpegni.FilterRow.Visible := (Sender as TSpeedButton).Down;
  if not tvImpegni.FilterRow.Visible then
    tvImpegni.DataController.Filter.Clear;
end;

procedure TClientiForm.tvImpegniCustomDrawCell(Sender: TcxCustomGridTableView; ACanvas: TcxCanvas; AViewInfo: TcxGridTableDataCellViewInfo; var ADone: Boolean);
begin
  // Se il rigo del filtro (FilterRow) usa il colore specificato appositamente
  // in ogni caso, anche se  il rigo selezionato che mi piace di pi
  if (AViewInfo.GridRecord as TcxCustomGridRow).IsFilterRow then
  begin
    ACanvas.Brush.Color := (Sender as TcxGridDBTableView).Styles.FilterRowInfoText.Color;
  end;

  // ===========================================================================
  // TRACCIAMENTO CONTENUTO
  // ---------------------------------------------------------------------------
  ADone := True;
  // Disegna il contenuto della cella in modo standard
  AViewInfo.EditViewInfo.Font := ACanvas.Font;
  AViewInfo.EditViewInfo.TextColor := ACanvas.Font.Color;
  if VarToStr(AViewInfo.GridRecord.Values[tvImpegniFATTO.Index]) = 'T' then
    AViewInfo.EditViewInfo.TextColor := clSilver
  else
    AViewInfo.EditViewInfo.TextColor := ACanvas.Font.Color;
  AViewInfo.EditViewInfo.BackgroundColor := ACanvas.Brush.Color;
  AViewInfo.EditViewInfo.Paint(ACanvas);
  // Disegna la linea di separazione verticale se  il caso
  if (AViewInfo.Item.Tag = 0) or (not AViewInfo.Item.IsLast) and (Sender.Items[AViewInfo.Item.Index + 1].Tag = 0) then
    ACanvas.DrawComplexFrame(AViewInfo.Bounds, $00D3D3D3, $00D3D3D3, [bRight], 1);
  // Se  la prima colonna a sx
  if (AViewInfo.Item.IsFirst) // Se  la prima colonna a sx
  then
    ACanvas.DrawComplexFrame(AViewInfo.Bounds, $00D3D3D3, $00D3D3D3, [bLeft], 1);
  // Se  l'ultimo record diesgna anche il bordo inferiore
  if AViewInfo.GridRecord.IsLast then
    ACanvas.DrawComplexFrame(AViewInfo.Bounds, $00D3D3D3, $00D3D3D3, [bBottom], 1);
  // ===========================================================================
end;

procedure TClientiForm.SBCollapseSoggettiClick(Sender: TObject);
begin
  tvRubrica.ViewData.Collapse(False);
end;

procedure TClientiForm.SBExpandSoggettiClick(Sender: TObject);
begin
  tvRubrica.ViewData.Expand(False);
end;

procedure TClientiForm.SBFilterRowSoggettiClick(Sender: TObject);
begin
  // Attiva/Disattiva la Filter Row
  tvRubrica.FilterRow.Visible := (Sender as TSpeedButton).Down;
  if not tvRubrica.FilterRow.Visible then
    tvRubrica.DataController.Filter.Clear;
end;

procedure TClientiForm.SBCollapsePraticheClick(Sender: TObject);
begin
  tvPrat.ViewData.Collapse(False);
end;

procedure TClientiForm.SBExpandPraticheClick(Sender: TObject);
begin
  tvPrat.ViewData.Expand(False);
end;

procedure TClientiForm.SBFilterRowPraticheClick(Sender: TObject);
begin
  // Attiva/Disattiva la Filter Row
  tvPrat.FilterRow.Visible := (Sender as TSpeedButton).Down;
  if not tvPrat.FilterRow.Visible then
    tvPrat.DataController.Filter.Clear;
end;

procedure TClientiForm.Agenda_NormalSelectionModeInitEventImages(Sender: TcxCustomScheduler; AEvent: TcxSchedulerControlEvent;
  AImages: TcxSchedulerEventImages);
const
  ICON_URGENTE_INDEX = 0;
  ICON_PRESCRIZ_INDEX = 2;
  ICON_STAMPATO_INDEX = 11;
var
  Urgente, Prescrizioni, Stampato: Variant;
begin
  // Se  urgente aggiunge l'apposita iconcina
  Urgente := AEvent.GetCustomFieldValueByName('EXISTS_URGENTI');
  if VarToStr(Urgente) = 'T' then
    AImages.Add(ICON_URGENTE_INDEX);
  // Se c' una prescrizione aggiunge l'apposita iconcina
  Prescrizioni := AEvent.GetCustomFieldValueByName('EXISTS_PRESCRIZIONI');
  if VarToStr(Prescrizioni) = 'T' then
    AImages.Add(ICON_PRESCRIZ_INDEX);
  // Se  gi stato stampato il foglio di lavoro visualizza l'apposita iconcina
  Stampato := AEvent.GetCustomFieldValueByName('EXISTS_STAMPATO');
  if VarToStr(Stampato) = 'T' then
    AImages.Add(ICON_STAMPATO_INDEX);
end;

procedure TClientiForm.Agenda_NormalSelectionModeIsWorkTime(Sender: TObject; AResource: TcxSchedulerStorageResourceItem; const ATime: TDateTime;
  var AIsWork: Boolean);
var
  LTime: TTime;
begin
  // Determina se si tratta di un orario di apertura o chiusura (cos funziona)
  LTime := TimeOf(ATime);
  AIsWork := (LTime >= Agenda_NormalSelectionMode.OptionsView.WorkStart) and (LTime <= Agenda_NormalSelectionMode.ViewDay.WorkFinish);
end;

procedure TClientiForm.Stampaelencocomunicazioni1Click(Sender: TObject);
var
  PrecGroupColor: TColor;
begin
  // Imposta la stringa su cui viene costruito il range di date della stampa in base ai filtri per data
  DM1.SetReportDateRange(TabComunicazioniForm.AssDal.EditText, TabComunicazioniForm.AssAl.EditText);
  // Salva e modifica alcune propriet per adattare il componente alla stampe
  // e poi rimette tutto a posto.
  TabComunicazioniForm.GridCom.BeginUpdate;
  TabComunicazioniForm.GridCom.RootLevelOptions.DetailFrameColor := clWhite;
  TabComunicazioniForm.btvCom.OptionsView.GroupRowStyle := grsStandard;
  TabComunicazioniForm.btvCom.OptionsView.GridLineColor := clWhite;
  TabComunicazioniForm.btvCom.OptionsView.IndicatorWidth := 0;

  PrecGroupColor := TabComunicazioniForm.btvCom.Styles.Group.Color;
  TabComunicazioniForm.btvCom.Styles.Group.Color := clWhite;

  try
    // Imposta alcune propriet
    TabComunicazioniForm.GridComLink.OptionsExpanding.ExpandGroupRows := False;
    TabComunicazioniForm.GridComLink.OptionsExpanding.ExpandMasterRows := False;
    // Anteprima
    if MenuStampe.Tag = 0 then
    begin
      TabComunicazioniForm.dxPrinter.Preview(True, TabComunicazioniForm.GridComLink);
      // Stampa
    end
    else if MenuStampe.Tag = 1 then
    begin
      TabComunicazioniForm.dxPrinter.Print(True, nil, TabComunicazioniForm.GridComLink);
    end;
  finally
    // Ripristina l'aspetto del componente
    TabComunicazioniForm.GridCom.RootLevelOptions.DetailFrameColor := clBlack;
    TabComunicazioniForm.btvCom.OptionsView.GroupRowStyle := grsOffice11;
    TabComunicazioniForm.btvCom.OptionsView.GridLineColor := $00D3D3D3;
    TabComunicazioniForm.btvCom.OptionsView.IndicatorWidth := 12;

    TabComunicazioniForm.btvCom.Styles.Group.Color := PrecGroupColor;

    TabComunicazioniForm.GridCom.EndUpdate;
  end;
end;

procedure TClientiForm.tvCVFocusedRecordChanged(Sender: TcxCustomGridTableView; APrevFocusedRecord, AFocusedRecord: TcxCustomGridRecord;
  ANewItemRecordFocusingChanged: Boolean);
begin
  // Se siamo in FastSelectionMode seleziona automaticamente il nuovo record sul quale siamo approdati
  if DM1.FastSelectionMode and ClientiForm.RxSpeedButtonVisualizza.Enabled then
  begin
    ClientiForm.RxSpeedButtonVisualizzaClick(ClientiForm.RxSpeedButtonVisualizza);
  end;
end;

procedure TClientiForm.tvRubricaDataControllerDetailExpanding(ADataController: TcxCustomDataController; ARecordIndex: Integer; var AAllow: Boolean);
var
  RowIndex: Integer;
begin
  inherited;
  // Inizializzazione
  RowIndex := ADataController.GetRowIndexByRecordIndex(ARecordIndex, False);
  // Prima chiude gli eventuali altri records expanded perch altrimenti ho
  // paura che l'utente faccia confusione.
  ADataController.CollapseDetails;

  // Focused e selezione sul record che si sta espandendo e deseleziona tutti gli altri
  // NB: Deseleziona gli altri solo se non stiamo tenendo premuti CTRL o SHIFT per fare una selezione
  // multipla altrimenti mi perde quelli gi selezionati
  if (not DM2.isCtrlDown) and (not DM2.isShiftDown) then
    ADataController.ClearSelection;
  ADataController.FocusedRecordIndex := ARecordIndex;
  ADataController.SelectRows(RowIndex, RowIndex);

  // Se siamo in FastSelectionMode seleziona anche il soggetto/pratica/impianto
  // corrente perch altrimenti espandendo un record non lo facesa da solo
  if DM1.FastSelectionMode then
    ClientiForm.RxSpeedButtonVisualizzaClick(ClientiForm.RxSpeedButtonVisualizza);
end;

procedure TClientiForm.Agenda_NormalSelectionModeDblClick(Sender: TObject);
begin
  // Se ci sono eventi selezionati, visualizza l'evento, altrimenti
  // si predispone per l'nserimento di un nuovo evento.
  if Agenda.SelectedEventCount > 0 then
  begin
    // Visualizza il documento
    RxSpeedButtonVisualizzaClick(RxSpeedButtonVisualizza);
  end
  else
  begin
    // RxSpeedButtonNuovoClick(RxSpeedButtonNuovo);
  end;
end;

procedure TClientiForm.RxSpeedButtonEliminaDragDrop(Sender, Source: TObject; X, Y: Integer);
begin

  // Se il mittente  uno scheduler (agenda)
  if Source is TcxSchedulerDragObject then
  begin
    // Se proviene dall'agenda laterale...
    if ((Source as TcxSchedulerDragObject).Scheduler.Name = 'Agenda_FastSelectionMode') and Assigned(fAgendaForm) then
    begin
      // Elimina gli eventi selezionati
      fAgendaForm.EliminaEventiSelezionati;
    end;
    // Se il mittente  una cxGrid
  end
  else if Source is TcxDragControlObject then
  begin
    if ((Source as TcxDragControlObject).Control as TcxGridSite).GridView.Name = 'btvTasks' then
    begin
      RxSpeedButtonEliminaClick(RxSpeedButtonElimina);
    end;
  end;

end;

procedure TClientiForm.RxSpeedButtonVisualizzaDragDrop(Sender, Source: TObject; X, Y: Integer);
begin
  // Se il mittente  uno scheduler (agenda)
  if Source is TcxSchedulerDragObject then
  begin
    // Se proviene dall'agenda laterale...
    if ((Source as TcxSchedulerDragObject).Scheduler.Name = 'Agenda_FastSelectionMode') and Assigned(fAgendaForm) then
    begin
      // Visualizza l'evento selezionato
      fAgendaForm.VisualizzaEventoSelezionato;
    end;
    // Se il mittente  una cxGrid
  end
  else if Source is TcxDragControlObject then
  begin
    if ((Source as TcxDragControlObject).Control as TcxGridSite).GridView.Name = 'btvTasks' then
    begin
      RxSpeedButtonVisualizzaClick(RxSpeedButtonVisualizza);
    end;
  end;
end;

procedure TClientiForm.tvRubricaMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
var
  Site: TcxGridSite;
  HitTest: TcxCustomGridHitTest;
begin
  // Verifica della posizione del mouse...
  Site := Sender as TcxGridSite;
  HitTest := Site.GridView.ViewInfo.GetHitTest(X, Y);
  // Se stiamo facendo click su una casella di dati normali (no group, no filter ecc.)
  // allora procede con la selezione del soggetto/cantiere/impianto altrimenti nulla.
  if (HitTest.HitTestCode = htCell) and (TcxGridRecordCellHitTest(HitTest).GridRecord.IsData) and
    (not(Site.GridView.Controller as TcxGridTableController).IsFilterRowFocused) then
  begin

    // =========================================================================
    // SELEZIONE SOGGETTO/PRATICA/IMPIANTO CORRENTE
    // -------------------------------------------------------------------------
    // Se siamo in FastSelectionMode seleziona automaticamente il nuovo record sul quale siamo approdati
    // NB: SPOSTATO NELL'ONMOUSEDOWN PER FARE IN MODO CHE SE LO STO TRASINANDO NELL'AGENDA PER PRENDERE
    // UN APPUNTAMENTO SIA GI SELEZIONATO (NELL'ONCLICK QUESTO NON ACCADEVA)
    if DM1.FastSelectionMode and ClientiForm.RxSpeedButtonVisualizza.Enabled then
    begin
      ClientiForm.RxSpeedButtonVisualizzaClick(ClientiForm.RxSpeedButtonVisualizza);
    end;
    // =========================================================================

  end;
end;

procedure TClientiForm.FilterOp1PropertiesInitPopup(Sender: TObject);
var
  CB: TcxComboBox;
begin
  // Inizializzazione
  CB := Sender as TcxComboBox;
  // Carica le voci da visualizzare
  CB.Properties.Items.Clear;
  CB.Properties.Items.Add('');
  // Oltre alle voci fisse aggiunge anche le Operazioni Pianificate
  DM2.StringList_AddOpForFilter(CB.Properties.Items);
end;

procedure TClientiForm.tvRubricaEXISTS_SCADSOFFGetCellHint(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord;
  ACellViewInfo: TcxGridTableDataCellViewInfo; const AMousePos: TPoint; var AHintText: TCaption; var AIsHintMultiLine: Boolean; var AHintTextRect: TRect);
begin
  // ===========================================================================
  // HINT
  // ---------------------------------------------------------------------------
  // Se il valore  una stringa nulla oppure 'F' esce subito e non visualizza
  // alcun Hint
  if (ACellViewInfo.DisplayValue = '') or (ACellViewInfo.DisplayValue = 'F') then
    Exit;
  // IN base alla colonna su cui  posizionato il mouse
  // determina il testo dell'hint da visualizzare
  if Sender.Index = tvRubricaEXISTS_SCADSOFF.Index then
    AHintText := HINT_MSG_SCADSOFF
  else if Sender.Index = tvRubricaEXISTS_CORRISPNOPAG.Index then
    AHintText := HINT_MSG_CORRISPNOPAG
  else if Sender.Index = tvRubricaEXISTS_URGENTI.Index then
    AHintText := HINT_MSG_URGENTE
  else if Sender.Index = tvRubricaEXISTS_CHIAMATE.Index then
    AHintText := HINT_MSG_CHIAMATA
  else if Sender.Index = tvRubricaEXISTS_PRESCRIZIONI.Index then
    AHintText := HINT_MSG_PRESCRIZIONE;
  // Altrimenti non va bene
  AIsHintMultiLine := False;
  // ===========================================================================
end;

procedure TClientiForm.tvRubricaMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
var
  Site: TcxGridSite;
  HitTest: TcxCustomGridHitTest;
  Item: TcxCustomGridTableItem;
  MousePosition: TPoint;
begin
  // Inizializzazione
  Site := Sender as TcxGridSite;
  HitTest := Site.GridView.ViewInfo.GetHitTest(X, Y);
  MousePosition := (Sender as TControl).ClientToScreen(Point(X, Y));
  // ===========================================================================
  // COLUMN HEADER HINTS
  // ---------------------------------------------------------------------------
  // Se il mouse  sopra un ColumnHeader provvede a visualizzare il relativo Hint
  // se la colonna relativa lo prevede (generalmente le colonne con le iconcine)
  if HitTest is TcxGridColumnHeaderHitTest then
  begin
    Item := TcxGridColumnHeaderHitTest(HitTest).Column;
    // Scadenze in sofferenza
    if (Item = tvRubricaEXISTS_SCADSOFF) then
    begin
      DM2.ColumnHeaderHint_Show(HINT_MSG_SCADSOFF, MousePosition);
      Exit;
      // Corrispettivo non pagato
    end
    else if (Item = tvRubricaEXISTS_CORRISPNOPAG) then
    begin
      DM2.ColumnHeaderHint_Show(HINT_MSG_CORRISPNOPAG, MousePosition);
      Exit;
      // Urgente
    end
    else if (Item = tvRubricaEXISTS_URGENTI) then
    begin
      DM2.ColumnHeaderHint_Show(HINT_MSG_URGENTE, MousePosition);
      Exit;
      // Chiamata/Appuntamento
    end
    else if (Item = tvRubricaEXISTS_CHIAMATE) then
    begin
      DM2.ColumnHeaderHint_Show(HINT_MSG_CHIAMATA, MousePosition);
      Exit;
      // Prescrizione
    end
    else if (Item = tvRubricaEXISTS_PRESCRIZIONI) then
    begin
      DM2.ColumnHeaderHint_Show(HINT_MSG_PRESCRIZIONE, MousePosition);
      Exit;
    end;
  end;
  // Se arriva qui allora l'eventuale Hint deve essere chiuso
  DM2.ColumnHeaderHint_Close;
  // ===========================================================================
end;

procedure TClientiForm.tvSoggCantEXIST_SCADSOFFGetCellHint(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord;
  ACellViewInfo: TcxGridTableDataCellViewInfo; const AMousePos: TPoint; var AHintText: TCaption; var AIsHintMultiLine: Boolean; var AHintTextRect: TRect);
begin
  // ===========================================================================
  // HINT
  // ---------------------------------------------------------------------------
  // Se il valore  una stringa nulla oppure 'F' esce subito e non visualizza
  // alcun Hint
  if (ACellViewInfo.DisplayValue = '') or (ACellViewInfo.DisplayValue = 'F') then
    Exit;
  // IN base alla colonna su cui  posizionato il mouse
  // determina il testo dell'hint da visualizzare
  if Sender.Index = tvSoggCantEXIST_SCADSOFF.Index then
    AHintText := HINT_MSG_SCADSOFF
  else if Sender.Index = tvSoggCantEXIST_CORRISPNOPAG.Index then
    AHintText := HINT_MSG_CORRISPNOPAG
  else if Sender.Index = tvSoggCantEXIST_URGENTI.Index then
    AHintText := HINT_MSG_URGENTE
  else if Sender.Index = tvSoggCantEXIST_CHIAMATE.Index then
    AHintText := HINT_MSG_CHIAMATA
  else if Sender.Index = tvSoggCantEXIST_PRESCRIZIONI.Index then
    AHintText := HINT_MSG_PRESCRIZIONE;
  // Altrimenti non va bene
  AIsHintMultiLine := False;
  // ===========================================================================
end;

procedure TClientiForm.tvPratMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
var
  Site: TcxGridSite;
  HitTest: TcxCustomGridHitTest;
  Item: TcxCustomGridTableItem;
  MousePosition: TPoint;
begin
  // Inizializzazione
  Site := Sender as TcxGridSite;
  HitTest := Site.GridView.ViewInfo.GetHitTest(X, Y);
  MousePosition := (Sender as TControl).ClientToScreen(Point(X, Y));
  // ===========================================================================
  // COLUMN HEADER HINTS
  // ---------------------------------------------------------------------------
  // Se il mouse  sopra un ColumnHeader provvede a visualizzare il relativo Hint
  // se la colonna relativa lo prevede (generalmente le colonne con le iconcine)
  if HitTest is TcxGridColumnHeaderHitTest then
  begin
    Item := TcxGridColumnHeaderHitTest(HitTest).Column;
    // Scadenze in sofferenza
    if (Item = tvPratEXIST_SCADSOFF) then
    begin
      DM2.ColumnHeaderHint_Show(HINT_MSG_SCADSOFF, MousePosition);
      Exit;
      // Corrispettivo non pagato
    end
    else if (Item = tvPratEXIST_CORRISPNOPAG) then
    begin
      DM2.ColumnHeaderHint_Show(HINT_MSG_CORRISPNOPAG, MousePosition);
      Exit;
      // Urgente
    end
    else if (Item = tvPratEXIST_URGENTI) then
    begin
      DM2.ColumnHeaderHint_Show(HINT_MSG_URGENTE, MousePosition);
      Exit;
      // Chiamata/Appuntamento
    end
    else if (Item = tvPratEXIST_CHIAMATE) then
    begin
      DM2.ColumnHeaderHint_Show(HINT_MSG_CHIAMATA, MousePosition);
      Exit;
      // Prescrizione
    end
    else if (Item = tvPratEXIST_PRESCRIZIONI) then
    begin
      DM2.ColumnHeaderHint_Show(HINT_MSG_PRESCRIZIONE, MousePosition);
      Exit;
    end;
  end;
  // Se arriva qui allora l'eventuale Hint deve essere chiuso
  DM2.ColumnHeaderHint_Close;
  // ===========================================================================
end;

procedure TClientiForm.tvPratEXIST_SCADSOFFGetCellHint(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord;
  ACellViewInfo: TcxGridTableDataCellViewInfo; const AMousePos: TPoint; var AHintText: TCaption; var AIsHintMultiLine: Boolean; var AHintTextRect: TRect);
begin
  // ===========================================================================
  // HINT
  // ---------------------------------------------------------------------------
  // Se il valore  una stringa nulla oppure 'F' esce subito e non visualizza
  // alcun Hint
  if (ACellViewInfo.DisplayValue = '') or (ACellViewInfo.DisplayValue = 'F') then
    Exit;
  // IN base alla colonna su cui  posizionato il mouse
  // determina il testo dell'hint da visualizzare
  if Sender.Index = tvPratEXIST_SCADSOFF.Index then
    AHintText := HINT_MSG_SCADSOFF
  else if Sender.Index = tvPratEXIST_CORRISPNOPAG.Index then
    AHintText := HINT_MSG_CORRISPNOPAG
  else if Sender.Index = tvPratEXIST_URGENTI.Index then
    AHintText := HINT_MSG_URGENTE
  else if Sender.Index = tvPratEXIST_CHIAMATE.Index then
    AHintText := HINT_MSG_CHIAMATA
  else if Sender.Index = tvPratEXIST_PRESCRIZIONI.Index then
    AHintText := HINT_MSG_PRESCRIZIONE;
  // Altrimenti non va bene
  AIsHintMultiLine := False;
  // ===========================================================================
end;

procedure TClientiForm.tvDocRIFDOC_CORRISPNOPAGGetCellHint(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord;
  ACellViewInfo: TcxGridTableDataCellViewInfo; const AMousePos: TPoint; var AHintText: TCaption; var AIsHintMultiLine: Boolean; var AHintTextRect: TRect);
begin
  // ===========================================================================
  // HINT
  // ---------------------------------------------------------------------------
  // Se il valore  una stringa nulla oppure 'F' esce subito e non visualizza
  // alcun Hint
  if (ACellViewInfo.DisplayValue = '') or (ACellViewInfo.DisplayValue = 'F') then
    Exit;
  // IN base alla colonna su cui  posizionato il mouse
  // determina il testo dell'hint da visualizzare
  if Sender.Index = tvDocRIFDOC_CORRISPNOPAG.Index then
    AHintText := HINT_MSG_CORRISPNOPAG;
  // Altrimenti non va bene
  AIsHintMultiLine := False;
  // ===========================================================================
end;

procedure TClientiForm.tvDocMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
var
  Site: TcxGridSite;
  HitTest: TcxCustomGridHitTest;
  Item: TcxCustomGridTableItem;
  MousePosition: TPoint;
begin
  // Inizializzazione
  Site := Sender as TcxGridSite;
  HitTest := Site.GridView.ViewInfo.GetHitTest(X, Y);
  MousePosition := (Sender as TControl).ClientToScreen(Point(X, Y));
  // ===========================================================================
  // COLUMN HEADER HINTS
  // ---------------------------------------------------------------------------
  // Se il mouse  sopra un ColumnHeader provvede a visualizzare il relativo Hint
  // se la colonna relativa lo prevede (generalmente le colonne con le iconcine)
  if HitTest is TcxGridColumnHeaderHitTest then
  begin
    Item := TcxGridColumnHeaderHitTest(HitTest).Column;
    // Corrispettivo non pagato
    if (Item = tvDocRIFDOC_CORRISPNOPAG) then
    begin
      DM2.ColumnHeaderHint_Show(HINT_MSG_CORRISPNOPAG, MousePosition);
      Exit;
    end;
  end;
  // Se arriva qui allora l'eventuale Hint deve essere chiuso
  DM2.ColumnHeaderHint_Close;
  // ===========================================================================
end;

procedure TClientiForm.tvImpegniMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
var
  Site: TcxGridSite;
  HitTest: TcxCustomGridHitTest;
  Item: TcxCustomGridTableItem;
  MousePosition: TPoint;
begin
  // Inizializzazione
  Site := Sender as TcxGridSite;
  HitTest := Site.GridView.ViewInfo.GetHitTest(X, Y);
  MousePosition := (Sender as TControl).ClientToScreen(Point(X, Y));
  // ===========================================================================
  // COLUMN HEADER HINTS
  // ---------------------------------------------------------------------------
  // Se il mouse  sopra un ColumnHeader provvede a visualizzare il relativo Hint
  // se la colonna relativa lo prevede (generalmente le colonne con le iconcine)
  if HitTest is TcxGridColumnHeaderHitTest then
  begin
    Item := TcxGridColumnHeaderHitTest(HitTest).Column;
    // Corrispettivo non pagato
    if (Item = tvImpegniEXISTS_CORRISPNOPAG) then
    begin
      DM2.ColumnHeaderHint_Show(HINT_MSG_CORRISPNOPAG, MousePosition);
      Exit;
      // Urgente
    end
    else if (Item = tvImpegniEXISTS_URGENTI) then
    begin
      DM2.ColumnHeaderHint_Show(HINT_MSG_URGENTE, MousePosition);
      Exit;
      // Chiamata/Appuntamento
    end
    else if (Item = tvImpegniEXISTS_CHIAMATE) then
    begin
      DM2.ColumnHeaderHint_Show(HINT_MSG_CHIAMATA, MousePosition);
      Exit;
      // Prescrizione
    end
    else if (Item = tvImpegniEXISTS_PRESCRIZIONI) then
    begin
      DM2.ColumnHeaderHint_Show(HINT_MSG_PRESCRIZIONE, MousePosition);
      Exit;
      // Stampato
    end
    else if (Item = tvImpegniEXISTS_STAMPATO) then
    begin
      DM2.ColumnHeaderHint_Show(HINT_MSG_STAMPATO, MousePosition);
      Exit;
    end;
  end;
  // Se arriva qui allora l'eventuale Hint deve essere chiuso
  DM2.ColumnHeaderHint_Close;
  // ===========================================================================
end;

procedure TClientiForm.tvImpegniEXISTS_CORRISPNOPAGGetCellHint(Sender: TcxCustomGridTableItem; ARecord: TcxCustomGridRecord;
  ACellViewInfo: TcxGridTableDataCellViewInfo; const AMousePos: TPoint; var AHintText: TCaption; var AIsHintMultiLine: Boolean; var AHintTextRect: TRect);
begin
  // ===========================================================================
  // HINT
  // ---------------------------------------------------------------------------
  // Se il valore  una stringa nulla oppure 'F' esce subito e non visualizza
  // alcun Hint
  if (VarToStr(ACellViewInfo.DisplayValue) = '') or (ACellViewInfo.DisplayValue = 'F') then
    Exit;
  // IN base alla colonna su cui  posizionato il mouse
  // determina il testo dell'hint da visualizzare
  if Sender.Index = tvImpegniEXISTS_CORRISPNOPAG.Index then
    AHintText := HINT_MSG_CORRISPNOPAG
  else if Sender.Index = tvImpegniEXISTS_URGENTI.Index then
    AHintText := HINT_MSG_URGENTE
  else if Sender.Index = tvImpegniEXISTS_CHIAMATE.Index then
    AHintText := HINT_MSG_CHIAMATA
  else if Sender.Index = tvImpegniEXISTS_PRESCRIZIONI.Index then
    AHintText := HINT_MSG_PRESCRIZIONE
  else if Sender.Index = tvImpegniEXISTS_STAMPATO.Index then
    AHintText := HINT_MSG_STAMPATO;
  // Altrimenti non va bene
  AIsHintMultiLine := False;
  // ===========================================================================
end;

procedure TClientiForm.GosOreAgentePropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(GosOreAgente.Properties.Items, 1, '');
end;

procedure TClientiForm.GosOreAgente2PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(GosOreAgente2.Properties.Items, 2, GosOreAgente.Text);

end;

procedure TClientiForm.GosOreAgente3PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(GosOreAgente3.Properties.Items, 3, GosOreAgente2.Text);
end;

procedure TClientiForm.GosOreAgente4PropertiesInitPopup(Sender: TObject);
begin
  // Carica le items
  DM1.CaricaItemsAgenti(GosOreAgente4.Properties.Items, 4, GosOreAgente3.Text);
end;

procedure TClientiForm.GosOreAgentePropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(1, GosOreAgente2);
end;

procedure TClientiForm.GosOreAgente2PropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(2, GosOreAgente3);
end;

procedure TClientiForm.GosOreAgente3PropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(3, GosOreAgente4);
end;

procedure TClientiForm.GosSpeseAgentePropertiesInitPopup(Sender: TObject);
begin
  DM1.CaricaItemsAgenti(GosSpeseAgente.Properties.Items, 1, '');
end;

procedure TClientiForm.GosSpeseAgente2PropertiesInitPopup(Sender: TObject);
begin
  DM1.CaricaItemsAgenti(GosSpeseAgente2.Properties.Items, 2, GosSpeseAgente.Text);
end;

procedure TClientiForm.GosSpeseAgente3PropertiesInitPopup(Sender: TObject);
begin
  DM1.CaricaItemsAgenti(GosSpeseAgente3.Properties.Items, 3, GosSpeseAgente2.Text);
end;

procedure TClientiForm.GosSpeseAgente4PropertiesInitPopup(Sender: TObject);
begin
  DM1.CaricaItemsAgenti(GosSpeseAgente4.Properties.Items, 4, GosSpeseAgente3.Text);
end;

procedure TClientiForm.GosSpeseAgentePropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(1, GosSpeseAgente2);
end;

procedure TClientiForm.GosSpeseAgente2PropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(2, GosSpeseAgente3);
end;

procedure TClientiForm.GosSpeseAgente3PropertiesEditValueChanged(Sender: TObject);
begin
  // Controlla se il livello successivo (quello eventualmente da azzerare perch legato a quello
  // che  stato appena modificato)  linkato al presente ed eventualmente poi azzerarlo.
  DM1.AgenteChanged(3, GosSpeseAgente4);
end;

procedure TClientiForm.TipoSoggettoPropertiesInitPopup(Sender: TObject);
var
  LO: TMemIniFile;
  TmpStr: String;
begin
  LO := TMemIniFile.Create(DM1.Repository_Layouts.FullLocalFileName);
  try
    with Sender as TcxComboBox do
    begin
      Properties.Items.Clear;
      Properties.Items.Add('');
      TmpStr := LO.ReadString('FormAnagraficaClienti', 'TipoSoggetto', 'Soggetto');
      while DM1.RitornaTestoPrimaDi('_', TmpStr, False) <> '' do
      begin
        Properties.Items.Add(DM1.RitornaTestoPrimaDi('_', TmpStr, True));
      end;
    end;
  finally
    LO.Free;
  end;
end;

procedure TClientiForm.PrmBancaPropertiesInitPopup(Sender: TObject);
var
  Qry: TIBOQuery;
  CB: TcxComboBox;
begin
  // Inizializzazione
  CB := Sender as TcxComboBox;
  // Crea l'oggetto query
  Qry := TIBOQuery.Create(Self);
  Qry.DatabaseName := DM1.ArcDBFile;
  Qry.IB_Connection := DM1.DBAzienda;
  // IMposta l'interrogazione e la esegue (elenca le proprie banche appoggio)
  Qry.SQL.Add('SELECT DescBreve');
  Qry.SQL.Add('FROM Banche');
  Qry.SQL.Add('WHERE MiaBanca = ''T''');
  Qry.SQL.Add('ORDER BY DescBreve');
  Qry.Open;
  // Ora carica tutte le nostre proprie banche appoggio nella combo box
  CB.Properties.Items.Clear;
  CB.Properties.Items.Add('');
  while not Qry.Eof do
  begin
    if not Qry.FieldByName('DescBreve').IsNull then
      CB.Properties.Items.Add(Qry.FieldByName('DescBreve').Value);
    Qry.Next;
  end;
  // Distrugge la query
  Qry.Free;
end;

end.
