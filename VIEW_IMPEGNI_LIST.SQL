/* View: IMPEGNI_LIST_VIEW, Owner: 1DR0GAT3 */

CREATE VIEW IMPEGNI_LIST_VIEW (

   ID,
   ParentID,
   TipoImpegno,
   EventMessage,
   START_EVENT,
   Location,
   RESOURCEID,
   TipoIntervento,
   DataOraChiamata,
   RAGIONESOCIALE,
   TECNICO,
   DataOraIntervento,
   Registro,
   CLIENTE,
   PRATICA,
   DATAPRATICA1,
   RIFPRATICA,
   Agente,
   Agente2,
   Agente3,
   Agente4,
   CodiceArticolo,
   DescrizioneArticolo,
   RELAZIONEINTERVENTO,
   EXISTS_URGENTI,
   EXISTS_PRESCRIZIONI,
   EXISTS_CHIAMATE,
   EXISTS_CORRISPNOPAG,
   EXISTS_STAMPATO,
   FATTO,
   SIMPLE_RAGSOCCLI,
   SIMPLE_DESCPRAT,
   RICHIEDENTE

) AS

SELECT
   I.ID,
   I.ParentID,
   I.TipoImpegno,
   I.EventMessage,
   I.START_EVENT,
   I.Location,
   I.RESOURCEID,
   I.TipoIntervento,
   I.DataOraChiamata,
   CAST(C.RAGIONESOCIALE || '  (' || I.CLIENTE || ')' AS VARCHAR(80)) AS RAGIONESOCIALE,
   CAST((SELECT T.RESOURCENAME FROM TECNICI T WHERE T.RESOURCEID = I.RESOURCEID) AS VARCHAR(100)) AS TECNICO,
   I.DataOraIntervento,
   I.Registro,
   I.CLIENTE,
   I.PRATICA,
   I.DATAPRATICA1,
   CAST(P.DESCRIZIONE || '  (' || I.PRATICA || ', ' || I.DATAPRATICA1 || ')' AS VARCHAR(120)) AS RIFPRATICA,
   I.Agente,
   I.Agente2,
   I.Agente3,
   I.Agente4,
   I.CodiceArticolo,
   I.DescrizioneArticolo,
   I.RELAZIONEINTERVENTO,

   CAST(   (CASE WHEN (I.TIPOIMPEGNO<>'Intervento' AND I.URGENTE='T') THEN 'T' ELSE 'F' END)   AS CHAR(1)) AS EXISTS_URGENTI,
   CAST(   (SELECT OUTVAL FROM IMPEGNI_PRESCRIZ_EXISTS(I.ID))    AS CHAR(1)) AS EXISTS_PRESCRIZIONI,
   CAST(   (CASE WHEN (I.TIPOIMPEGNO='Chiamata') THEN 'T' WHEN (I.TIPOIMPEGNO='Appuntamento') THEN 'A' ELSE 'F' END)   AS CHAR(1)) AS EXISTS_CHIAMATE,
   T.RIFDOC_CORRISPNOPAG AS EXISTS_CORRISPNOPAG,
   I.STAMPATO AS EXISTS_STAMPATO,
   I.FATTO,
   
   C.RAGIONESOCIALE AS SIMPLE_RAGSOCCLI,
   P.DESCRIZIONE AS SIMPLE_DESCPRAT,

   I.RICHIEDENTE
    
 
FROM IMPEGNI I
LEFT JOIN CLIENTI C ON (C.CODICE = I.CLIENTE)
LEFT JOIN PRVORDCL T ON (T.TIPODOCUMENTO='Intervento' AND T.REGISTRO=I.REGISTRO AND T.NUMORDPREV=I.ID)
LEFT JOIN PRATICHE P ON (P.CODICE=I.PRATICA AND P.DATAAPERTURA=I.DATAPRATICA1)
;
